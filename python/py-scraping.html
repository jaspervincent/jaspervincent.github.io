<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python:爬虫技术</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Python:爬虫技术</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:e20c17a4-7734-4706-b4db-20f9f2767fc1">概述和HTTP请求与响应处理</a>
<ul>
<li><a href="#h:43f169a4-737b-4d12-9f4e-4116bed3204b">概述</a></li>
<li><a href="#h:8c9c0136-6f27-4fed-ad05-7321982c9c20">爬虫分类</a>
<ul>
<li><a href="#h:0a1b3575-01c7-4bf8-a79e-889106c171da">1.通用爬虫</a></li>
<li><a href="#h:8c29fde1-320f-4b25-998d-301c7c39e794">2. 聚焦爬虫</a></li>
</ul>
</li>
<li><a href="#h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da">Robots协议</a></li>
<li><a href="#h:71806a2a-6d96-46d1-ac19-65115c660df6">HTTP请求和响应处理</a>
<ul>
<li><a href="#h:67f4c161-aec6-49d3-be64-d83915a3c7ef">urllib包</a></li>
<li><a href="#h:9df4c633-a584-416f-8eb6-941240690a6d">urllib.request模块</a></li>
<li><a href="#h:105dbd3f-e6cf-4c86-b867-cd3564e269dc">urllib.parse模块</a></li>
</ul>
</li>
<li><a href="#h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d">提交方法method</a>
<ul>
<li><a href="#h:2fa09768-b387-4f3d-acf8-fbb88dbf447e">GET方法</a></li>
<li><a href="#h:ba7b0e62-fa76-45c2-874e-5affab70c5be">POST方法</a></li>
<li><a href="#h:2382eb7c-e980-4563-a867-dc031a88b933">处理JSON数据</a></li>
</ul>
</li>
<li><a href="#h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b">HTTPS证书忽略</a></li>
<li><a href="#h:a9ad48b9-d19f-4761-9e40-2788c839e14b">urllib3库</a></li>
<li><a href="#h:0b5a6eed-ce46-4946-8a07-3856f717957e">requests库</a></li>
</ul>
</li>
<li><a href="#h:93950bd9-2429-4fa5-8823-10fe7bac3876">HTML解析-Xpath</a>
<ul>
<li><a href="#h:3d601eb4-d05e-409b-817d-37dd4f8368f1">XPath</a>
<ul>
<li><a href="#h:73350c13-31ad-4ee2-96b6-70ad6e516194">节点</a></li>
</ul>
</li>
<li><a href="#h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e">lxml</a></li>
</ul>
</li>
<li><a href="#h:05056423-ee64-468c-bdd6-ad4f63b6d935">BeautifulSoup4和JsonPath</a>
<ul>
<li><a href="#h:3588ac25-80d5-414f-914c-fff2fad17e68">BeautifulSoup4</a>
<ul>
<li><a href="#h:1e6751b5-780e-4f68-8535-4e3974da24a2">遍历文档树</a></li>
<li><a href="#h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641">搜索文档树</a></li>
<li><a href="#h:c31da1db-44a4-45bd-aa8d-551568b8e4a9">CSS选择器</a></li>
</ul>
</li>
<li><a href="#h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0">Json解析</a></li>
</ul>
</li>
<li><a href="#h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f">RabbitMQ</a>
<ul>
<li><a href="#h:f899334f-3118-41be-80e6-e8625d7b0dae">安装</a></li>
<li><a href="#h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc">配置</a>
<ul>
<li><a href="#h:836f844f-b135-4993-837c-10a2d1bff7ff">环境配置</a></li>
<li><a href="#h:63d147a7-aede-4e74-826b-e7cfc32eaaf5">工作特性配置文件</a></li>
<li><a href="#h:96ef7d6b-d211-4d63-81c1-381babafd986">插件管理</a></li>
<li><a href="#h:e531ee22-998b-4f99-aab2-7ac5ad53508e">启动服务</a></li>
<li><a href="#h:7881dc05-67bb-469e-9577-c9ad18bc3b95">用户管理</a></li>
</ul>
</li>
<li><a href="#h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995">Pika库</a></li>
<li><a href="#h:e4d7a939-b004-45e1-bbec-7ba99ca86d67">RabbitMQ工作原理及应用</a>
<ul>
<li><a href="#h:f9cb405c-487c-4a23-938b-7ae7f21eea58">工作模式</a>
<ul>
<li><a href="#h:4900c67f-edda-4470-99d2-ca179d94a7da">1.队列</a></li>
<li><a href="#h:7813c5d5-4fa0-407c-b24b-05261350d2a6">2.工作队列</a></li>
<li><a href="#h:8432203e-692d-4394-ab8a-c4e05c965d68">3.发布、订阅模式(Publish/Subscribe)</a></li>
<li><a href="#h:e14de8c7-6c4e-43f6-9635-88318aa5e521">4.路由模式Routing</a></li>
<li><a href="#h:e653a929-3560-40ef-9b1e-509028546f6e">5.Topic话题</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a2e85b01-fb8c-4897-a4a2-02928d876b55">RPC远程过程调用</a>
<ul>
<li><a href="#h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e">消息队列的作用</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Python</a></li>
</ul>
<section id="outline-container-h:e20c17a4-7734-4706-b4db-20f9f2767fc1" class="outline-2">
<h2 id="h:e20c17a4-7734-4706-b4db-20f9f2767fc1">概述和HTTP请求与响应处理</h2>
<div class="outline-text-2" id="text-h:e20c17a4-7734-4706-b4db-20f9f2767fc1">
</div>
<div id="outline-container-h:43f169a4-737b-4d12-9f4e-4116bed3204b" class="outline-3">
<h3 id="h:43f169a4-737b-4d12-9f4e-4116bed3204b">概述</h3>
<div class="outline-text-3" id="text-h:43f169a4-737b-4d12-9f4e-4116bed3204b">
<ul class="org-ul">
<li>爬虫，应该称为网络爬虫，也叫网页蜘蛛、网络机器人、网络蚂蚁等。</li>
<li>搜索引擎，就是网络爬虫的应用者。</li>
<li>大数据时代的到来，所有企业都希望通过海量数据发现其中的价值。所以需要爬取对特定网站、特顶类别的数据，而搜索引擎不能提供这样的功能，因此需要自己开发爬虫来解决。</li>
</ul>
</div>
</div>
<div id="outline-container-h:8c9c0136-6f27-4fed-ad05-7321982c9c20" class="outline-3">
<h3 id="h:8c9c0136-6f27-4fed-ad05-7321982c9c20">爬虫分类</h3>
<div class="outline-text-3" id="text-h:8c9c0136-6f27-4fed-ad05-7321982c9c20">
</div>
<div id="outline-container-h:0a1b3575-01c7-4bf8-a79e-889106c171da" class="outline-4">
<h4 id="h:0a1b3575-01c7-4bf8-a79e-889106c171da">1.通用爬虫</h4>
<div class="outline-text-4" id="text-h:0a1b3575-01c7-4bf8-a79e-889106c171da">
<p>
常见就是搜索引擎，无差别的搜集数据、存储、提取关键字、构建索引库，给用户提供搜索接口。
</p>

<ul class="org-ul">
<li>爬取一般流程
<ol class="org-ol">
<li>初始化一批URL,将这些URL放到带爬队列</li>
<li>从队列取出这些URL，通过DNS解析IP，对IP对应的站点下载HTML页面，保存到本地服务器中，爬取完的URL放到已爬取队列。</li>
<li>分析这些网页内容，找出网页里面的其他关心的URL链接，继续执行第2步，直到爬取条件结束。</li>
</ol></li>
<li>搜索引擎如何获取一个网站的URL
<ol class="org-ol">
<li>新网站主动提交给搜索引擎</li>
<li>通过其他网站页面中设置的外链接</li>
<li>搜索引擎和DNS服务商合作，获取最新收录的网站</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:8c29fde1-320f-4b25-998d-301c7c39e794" class="outline-4">
<h4 id="h:8c29fde1-320f-4b25-998d-301c7c39e794">2. 聚焦爬虫</h4>
<div class="outline-text-4" id="text-h:8c29fde1-320f-4b25-998d-301c7c39e794">
<ul class="org-ul">
<li>有针对性的编写特定领域数据的爬取程序，针对
某些类别数据采集的爬虫，是面向主题的爬虫</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da" class="outline-3">
<h3 id="h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da">Robots协议</h3>
<div class="outline-text-3" id="text-h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da">
<p>
指定一个robots.txt文件，告诉爬虫引擎什么可以爬取
</p>

<ul class="org-ul">
<li>=/=表示网站根目录，表示网站所有目录。</li>
<li>=Allow=允许爬取的目录</li>
<li>=Disallow=禁止爬取的目录</li>
<li>可以使用通配符</li>
</ul>

<p>
robots是一个君子协定，"爬亦有道"<br>
这个协议为了让搜索引擎更有效率搜索自己内容，提供了Sitemap这样的文件。Sitemap往往是一个XML文件，提供了网站想让大家爬取的内容的更新信息。<br>
这个文件禁止爬取的往往又是可能我们感兴趣的内容，反而泄露了这些地址。
</p>

<ol class="org-ol">
<li><p>
示例：淘宝的robots<a href="http://www.taobao.com/robots.txt">http://www.taobao.com/robots.txt</a>
</p>

<div class="org-src-container">
<pre class="src src-txt">User-agent:  Baiduspider
Allow:  /article
Allow:  /oshtml
Allow:  /ershou
Allow: /$
Disallow:  /product/
Disallow:  /

User-Agent:  Googlebot
Allow:  /article
Allow:  /oshtml
Allow:  /product
Allow:  /spu
Allow:  /dianpu
Allow:  /oversea
Allow:  /list
Allow:  /ershou
Allow: /$
Disallow:  /

User-agent:  Bingbot
Allow:  /article
Allow:  /oshtml
Allow:  /product
Allow:  /spu
Allow:  /dianpu
Allow:  /oversea
Allow:  /list
Allow:  /ershou
Allow: /$
Disallow:  /

User-Agent:  360Spider
Allow:  /article
Allow:  /oshtml
Allow:  /ershou
Disallow:  /

User-Agent:  Yisouspider
Allow:  /article
Allow:  /oshtml
Allow:  /ershou
Disallow:  /

User-Agent:  Sogouspider
Allow:  /article
Allow:  /oshtml
Allow:  /product
Allow:  /ershou
Disallow:  /

User-Agent:  Yahoo!  Slurp
Allow:  /product
Allow:  /spu
Allow:  /dianpu
Allow:  /oversea
Allow:  /list
Allow:  /ershou
Allow: /$
Disallow:  /

User-Agent:  *
Disallow:  /
</pre>
</div></li>

<li><p>
示例马蜂窝tobots<a href="http://www.mafengwo.cn/robots.txt">http://www.mafengwo.cn/robots.txt</a>
</p>

<div class="org-src-container">
<pre class="src src-txt">User-agent: *
Disallow: /
Disallow: /poi/detail.php

Sitemap: http://www.mafengwo.cn/sitemapIndex.xml
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:71806a2a-6d96-46d1-ac19-65115c660df6" class="outline-3">
<h3 id="h:71806a2a-6d96-46d1-ac19-65115c660df6">HTTP请求和响应处理</h3>
<div class="outline-text-3" id="text-h:71806a2a-6d96-46d1-ac19-65115c660df6">
<p>
其实爬取网页就是通过HTTP协议访问网页，不过通过浏览器反问往往是人的行为，把这种行为变成使用程序来访问。
</p>
</div>
<div id="outline-container-h:67f4c161-aec6-49d3-be64-d83915a3c7ef" class="outline-4">
<h4 id="h:67f4c161-aec6-49d3-be64-d83915a3c7ef">urllib包</h4>
<div class="outline-text-4" id="text-h:67f4c161-aec6-49d3-be64-d83915a3c7ef">
<p>
urllib是标准库，它一个工具包模块，包含下面模块来处理url: *
urllib.request 用于打开和读写url * urllib.error
包含了由urllib.request引起的异常 * urllib.parse 用于解析url *
urllib.robotparser 分析robots.txt文件
</p>

<p>
Python2中提供了urllib和urllib2。urllib提供较为底层的接口，urllib2对urllib进行了进一步封装。Python3中将urllib合并到了urllib2中，并更名为标准库urllib包。
</p>
</div>
</div>
<div id="outline-container-h:9df4c633-a584-416f-8eb6-941240690a6d" class="outline-4">
<h4 id="h:9df4c633-a584-416f-8eb6-941240690a6d">urllib.request模块</h4>
<div class="outline-text-4" id="text-h:9df4c633-a584-416f-8eb6-941240690a6d">
<p>
定义了在基本和摘要式身份验证、重定向、cookies等应用中打开Url(主要是HTTP)的函数和类。
</p>

<ul class="org-ul">
<li><p>
<b>urlopen方法</b>
</p>
<ol class="org-ol">
<li><code>urlopen(url,data=None)</code>
<ul class="org-ul">
<li>url是链接地址字符串，或请求类的实例</li>
<li>data提交的数据，如果data为Non发起的*GET*请求，否则发起*POST*请求。见=urllib.request.Request#get_method=返回http.client.HTTPResponse类的相遇对象，这是一个类文件对象。</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> urlopen

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#19968;&#20010;url&#36820;&#22238;&#19968;&#20010;&#30456;&#24212;&#23545;&#35937;&#65292;&#31867;&#25991;&#20214;&#23545;&#35937;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#38754;&#38142;&#25509;&#35775;&#38382;&#21518;&#20250;&#26377;&#36339;&#36716;</span>
<span style="color: #a0522d;">responses</span> = urlopen(<span style="color: #8b2252;">"http://www.bing.com"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;GET&#26041;&#27861;</span>
<span style="color: #483d8b;">print</span>(responses.closed)
<span style="color: #a020f0;">with</span> responses:
    <span style="color: #483d8b;">print</span>(1, <span style="color: #483d8b;">type</span>(responses)) <span style="color: #b22222;"># </span><span style="color: #b22222;">http.client.HTTPResponse&#31867;&#25991;&#20214;&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(2,responses.status,responses.reason) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;</span>
    <span style="color: #483d8b;">print</span>(3,responses.geturl()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#30495;&#27491;&#30340;URL</span>
    <span style="color: #483d8b;">print</span>(4,responses.info()) <span style="color: #b22222;">#</span><span style="color: #b22222;">headers</span>
    <span style="color: #483d8b;">print</span>(5,responses.read()[:50]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35835;&#21462;&#36820;&#22238;&#30340;&#20869;&#23481;</span>

<span style="color: #483d8b;">print</span>(responses.closed)
</pre>
</div>


<figure id="orgdf7f2b3">
<img src="../../../img/python/robots_001.jpg" alt="robots_001.jpg">

<figcaption><span class="figure-number">Figure 1: </span>robots_001</figcaption>
</figure>

<ol class="org-ol">
<li>上例，通过urllib.request.urlopen方法，发起一个HTTP的GET请求，WEB服务器返回了网页内容。响应的数据被封装到类文件对象中，可以通过read方法、readline方法、readlines方法获取数据，status和reason属性表示返回的状态码，info方法返回头信息，等等。</li>
</ol></li>
<li><b>User-Agent问题</b>
<ol class="org-ol">
<li><p>
上例代码非常精简，即可以获得网站的响应数据。但目前urlopen方法通过url字符串和data发起HTTP的请求。如果想修改HTTP头，例如useragent,就的借助其他方式。
</p>
<ul class="org-ul">
<li>原码中构造的useragen如下：</li>
</ul>

<p>
<code>python  # urllib.request.OpenerDirector  class OpenerDirector:      def __init__(self):          client_version = "Python-urllib/%s" % __version__          self.addheaders = [('User-agent', client_version)]</code>
</p>
<ul class="org-ul">
<li>当前显示为Python-urlib/3.7</li>
<li>有些网站是反爬虫的，所以要把爬虫伪装成浏览器。顺便打开一个浏览器，复制李立群的UA值，用来伪装。</li>
</ul></li>
</ol></li>
<li><b>Request类</b>
<code>Request(url,data=None,headers={})</code>
初始化方法，构造一个请求对象。可添加一个header的字典。data参数决定是GET还是POST请求。<br>
=obj.add_header(key,val)=为header增加一个键值对。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen
<span style="color: #a020f0;">import</span> random

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#19968;&#20010;url&#36820;&#22238;&#19968;&#20010;Request&#35831;&#27714;&#23545;&#35937;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">url = "https://movie.douban.com/" #&#27880;&#24847;&#23614;&#37096;&#30340;&#26012;&#26464;&#19968;&#23450;&#35201;&#26377;</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"http://www.bing.com/"</span>

<span style="color: #a0522d;">ua_list</span> = [
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">chrome</span>
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">safafi</span>
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:50.0) Gecko/20100101 Firefox/50.0"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">Firefox</span>
    <span style="color: #8b2252;">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">IE</span>
]

<span style="color: #a0522d;">ua</span> = random.choice(ua_list)
<span style="color: #a0522d;">request</span> = Request(url)
request.add_header(<span style="color: #8b2252;">"User-Agent"</span>,ua)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(request))

<span style="color: #a0522d;">response</span> = urlopen(request,timeout=20) <span style="color: #b22222;">#</span><span style="color: #b22222;">request&#23545;&#35937;&#25110;&#32773;url&#37117;&#21487;&#20197;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response))

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(1,response.status,response.getcode(),response.reason) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;&#65292;getcode&#26412;&#36136;&#19978;&#23601;&#26159;&#36820;&#22238;status</span>
    <span style="color: #483d8b;">print</span>(2,response.geturl()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25968;&#25454;&#30340;url&#12290;&#22914;&#26524;&#37325;&#23450;&#21521;&#65292;&#36825;&#20010;url&#21644;&#21407;&#22987;url&#19981;&#19968;&#26679;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20363;&#22914;&#65306;&#21407;&#22987;url&#26159;http://www.bing.com/,&#36820;&#22238;http://cn.bing.com/</span>
    <span style="color: #483d8b;">print</span>(3,response.info()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#21709;&#24212;&#22836;headers</span>
    <span style="color: #483d8b;">print</span>(4,response.read()[:50]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35835;&#21462;&#36820;&#22238;&#30340;&#20869;&#23481;</span>

<span style="color: #483d8b;">print</span>(5,request.get_header(<span style="color: #8b2252;">"User-agent"</span>))
<span style="color: #483d8b;">print</span>(6,request.headers)
<span style="color: #483d8b;">print</span>(7,<span style="color: #8b2252;">"user-agent"</span>.capitalize())
</pre>
</div>


<figure id="orgd1b8fb8">
<img src="../../../img/python/robots_002.jpg" alt="robots_002.jpg">

<figcaption><span class="figure-number">Figure 2: </span>robots_002</figcaption>
</figure>
</div>
</div>
<div id="outline-container-h:105dbd3f-e6cf-4c86-b867-cd3564e269dc" class="outline-4">
<h4 id="h:105dbd3f-e6cf-4c86-b867-cd3564e269dc">urllib.parse模块</h4>
<div class="outline-text-4" id="text-h:105dbd3f-e6cf-4c86-b867-cd3564e269dc">
<p>
该模块可以完成对url的编解码
</p>

<ol class="org-ol">
<li>parse.urlencode({key:value}) #对查询字符串进行编码</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a0522d;">u</span> = parse.urlencode({
    <span style="color: #8b2252;">"url"</span>:<span style="color: #8b2252;">"http://www.xdd.com/python"</span>,
    <span style="color: #8b2252;">"p_url"</span>:<span style="color: #8b2252;">"http://www.xdd.com/python?id=1&amp;name=&#24352;&#19977;"</span>
})
<span style="color: #483d8b;">print</span>(u)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36816;&#34892;&#32467;&#26524;</span>
<span style="color: #a0522d;">url</span>=http%3A%2F%2Fwww.xdd.com%2Fpython&amp;<span style="color: #a0522d;">p_url</span>=http%3A%2F%2Fwww.xdd.com%2Fpython%3Fid%3D1%26name%3D%E5%BC%A0%E4%B8%89
</pre>
</div>

<p>
从运行结果来看冒号、斜杠、&amp;、等号、问号等符号全部被编码了，%之后实际上是单字节十六进制表示的值。<br>
一般来说url中的地址部分，一般不需要使用中文路径，但是参数部分，不管GET还是POST方法，提交的数据中，
可能有斜杆、等号、问号等符号，这样这些字符表示数据，不表示元字符。如果直接发给服务器端，就会导致接收
方无法判断谁是元字符，谁是数据了。为了安全，一般会将数据部分的字符做url编码，这样就不会有歧义了。
后来可以传送中文，同样会做编码，一般先按照字符集的encoding要求转换成字节序列，每一个字节对应的十六
进制字符串前加上百分号即可。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a0522d;">u</span> = parse.urlencode({<span style="color: #8b2252;">"wd"</span>:<span style="color: #8b2252;">"&#20013;"</span>}) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#30721;&#26597;&#35810;&#23383;&#31526;&#20018;</span>
<span style="color: #a0522d;">url</span>= <span style="color: #8b2252;">"https://www.baidu.com/s?{}"</span>.<span style="color: #483d8b;">format</span>(u)
<span style="color: #483d8b;">print</span>(url)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#20013;"</span>.encode(<span style="color: #8b2252;">"utf-8"</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">b'xe4\xb8\xad'</span>
<span style="color: #483d8b;">print</span>(parse.unquote(u)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#30721;</span>
<span style="color: #483d8b;">print</span>(parse.unquote(url))
</pre>
</div>


<figure id="org058e98c">
<img src="../../../img/python/robots_003.jpg" alt="robots_003.jpg">

<figcaption><span class="figure-number">Figure 3: </span>robots_003</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d" class="outline-3">
<h3 id="h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d">提交方法method</h3>
<div class="outline-text-3" id="text-h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d">
<ul class="org-ul">
<li>常用的HTTP交互数据的方法是GET、POST
<ol class="org-ol">
<li>GET方法，数据是通过URL传递的，也就是说数据是在HTTP报文的header部分。</li>
<li>POST方法，数据是放在HTTP报文的body部分提交的。</li>
<li>数据是键值对形式，多个参数质检使用&amp;符号链接。例如a=1&amp;b=abc</li>
</ol></li>
</ul>
</div>
<div id="outline-container-h:2fa09768-b387-4f3d-acf8-fbb88dbf447e" class="outline-4">
<h4 id="h:2fa09768-b387-4f3d-acf8-fbb88dbf447e">GET方法</h4>
<div class="outline-text-4" id="text-h:2fa09768-b387-4f3d-acf8-fbb88dbf447e">
<ul class="org-ul">
<li>链接=必应=搜索引擎官网，获取一个搜索的URL=<a href="http://cn.bing.com/search?q=%E7%A5%9E%E6%8E%A2%E7%8B%84%E4%BB%81%E6%9D%B0">http://cn.bing.com/search?q=%E7%A5%9E%E6%8E%A2%E7%8B%84%E4%BB%81%E6%9D%B0</a>=</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> urlopen,Request
<span style="color: #a020f0;">from</span> urllib.parse <span style="color: #a020f0;">import</span> urlencode

<span style="color: #a0522d;">data</span> = urlencode({<span style="color: #8b2252;">"q"</span>:<span style="color: #8b2252;">"&#31070;&#25506;&#29380;&#20161;&#26480;"</span>})
<span style="color: #a0522d;">base_url</span> = <span style="color: #8b2252;">"http://cn.bing.com/search"</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}?{}"</span>.<span style="color: #483d8b;">format</span>(base_url,data)
<span style="color: #a0522d;">safafi</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">safafi</span>

<span style="color: #a0522d;">request</span> = Request(url,headers={<span style="color: #8b2252;">"User-agent"</span>:safafi})
<span style="color: #a0522d;">repost</span> = urlopen(request)
<span style="color: #a020f0;">with</span> repost:
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d:/abc.html"</span>,<span style="color: #8b2252;">"wb"</span>) <span style="color: #a020f0;">as</span> f:
        f.write(repost.read())
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"ok"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba7b0e62-fa76-45c2-874e-5affab70c5be" class="outline-4">
<h4 id="h:ba7b0e62-fa76-45c2-874e-5affab70c5be">POST方法</h4>
<div class="outline-text-4" id="text-h:ba7b0e62-fa76-45c2-874e-5affab70c5be">
<ul class="org-ul">
<li><a href="http://httpbin.org/">http://httpbin.org/</a>测试网站</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen
<span style="color: #a020f0;">from</span> urllib.parse <span style="color: #a020f0;">import</span> urlencode
<span style="color: #a020f0;">import</span> simplejson

<span style="color: #a0522d;">request</span> = Request(<span style="color: #8b2252;">"http://httpbin.org/post"</span>)
request.add_header(<span style="color: #8b2252;">"User-agent"</span>,<span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>)
<span style="color: #a0522d;">data</span> = urlencode({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"&#24352;&#19977;,@=/&amp;"</span>,<span style="color: #8b2252;">"age"</span>:<span style="color: #8b2252;">"6"</span>})
<span style="color: #483d8b;">print</span>(data)

<span style="color: #a0522d;">res</span> = urlopen(request,data.encode()) <span style="color: #b22222;">#</span><span style="color: #b22222;">POST&#26041;&#27861;&#65292;Form&#25552;&#20215;&#25968;&#25454;&#65292;&#22914;&#26524;Data&#30340;&#20540;&#19981;&#26159;None&#23601;&#20351;&#29992;Post&#26041;&#27861;&#65292;&#21542;&#21017;Get&#26041;&#27861;</span>
<span style="color: #a020f0;">with</span> res:
    <span style="color: #a0522d;">j</span> = res.read().decode() <span style="color: #b22222;">#</span><span style="color: #b22222;">json</span>
    <span style="color: #483d8b;">print</span>(j)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"==============================="</span>)
    <span style="color: #483d8b;">print</span>(simplejson.loads(j))
</pre>
</div>


<figure id="orgae4f6ef">
<img src="../../../img/python/robots_004.jpg" alt="robots_004.jpg">

<figcaption><span class="figure-number">Figure 4: </span>robots_004</figcaption>
</figure>
</div>
</div>
<div id="outline-container-h:2382eb7c-e980-4563-a867-dc031a88b933" class="outline-4">
<h4 id="h:2382eb7c-e980-4563-a867-dc031a88b933">处理JSON数据</h4>
<div class="outline-text-4" id="text-h:2382eb7c-e980-4563-a867-dc031a88b933">

<figure id="org0d342fc">
<img src="../../../img/python/robots_005.jpg" alt="robots_005.jpg">

<figcaption><span class="figure-number">Figure 5: </span>robots_005</figcaption>
</figure>

<ul class="org-ul">
<li>查看“豆瓣电影”,中的热门电影，通过分析，我们知道这部分内容，是通过AJAX从后台拿到的JSON数据。</li>
<li>访问URL是=<a href="https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=50&amp;page_start=0">https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=50&amp;page_start=0</a>=
<ol class="org-ol">
<li>=%E7%83%AD%E9%97%A8=是utf-8编码的中文”热门”</li>
<li>tag 标签”热门”，表示热门电影</li>
<li>type 数据类型，movie是电影</li>
<li>page_limit表示返回数据的总数</li>
<li>page_start 表示数据偏移</li>
</ol></li>
<li>服务器返回json数据如下：(轮播组件，共50条数据)
<img src="../../../img/python/robots_006.jpg" alt="robots_006.jpg"></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen
<span style="color: #a020f0;">from</span> urllib.parse <span style="color: #a020f0;">import</span> urlencode

<span style="color: #a0522d;">base_url</span> = <span style="color: #8b2252;">"https://movie.douban.com/j/search_subjects"</span>
<span style="color: #a0522d;">data</span> = urlencode({
    <span style="color: #8b2252;">"tag"</span>:<span style="color: #8b2252;">"&#28909;&#38376;"</span>,
    <span style="color: #8b2252;">"type"</span>:<span style="color: #8b2252;">"movie"</span>,
    <span style="color: #8b2252;">"page_limit"</span>:10,
    <span style="color: #8b2252;">"page_start"</span>:10
})
<span style="color: #a0522d;">request</span> = Request(base_url)

<span style="color: #b22222;"># </span><span style="color: #b22222;">POST&#26041;&#27861;</span>
<span style="color: #a0522d;">repost</span> = urlopen(request,data=data.encode())
<span style="color: #a020f0;">with</span> repost:
    <span style="color: #483d8b;">print</span>(repost._method)
    <span style="color: #483d8b;">print</span>(repost.read().decode()[:100])

<span style="color: #b22222;"># </span><span style="color: #b22222;">GET&#26041;&#27861;</span>
<span style="color: #a020f0;">with</span> urlopen(<span style="color: #8b2252;">"{}?{}"</span>.<span style="color: #483d8b;">format</span>(base_url,data)) <span style="color: #a020f0;">as</span> res:
    <span style="color: #483d8b;">print</span>(res._method)
    <span style="color: #483d8b;">print</span>(res.read().decode()[:100])
</pre>
</div>


<figure id="org8fedadb">
<img src="../../../img/python/robots_007.jpg" alt="robots_007.jpg">

<figcaption><span class="figure-number">Figure 6: </span>robots_007</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b" class="outline-3">
<h3 id="h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b">HTTPS证书忽略</h3>
<div class="outline-text-3" id="text-h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b">
<ul class="org-ul">
<li>HTTPS使用SSL安全套层协议，在传输层对网络数据进行加密。HTTPS使用的时候需要证书，而证书需要CA认证。</li>

<li>CA(Certificate
Authority)是数字证书认证中心的简称，是指发放、管理、废除数字证书的机构。</li>

<li>CA是受信任的第三方，有CA签发的证书具有可信任。如果用户由于信任了CA签发的证书导致的损失，可以追究CA的法律责任。</li>

<li>CA是层级结构，下级CA信任上级CA,且有上级CA颁发给下级CA证书并认证。</li>

<li>一些网站，例如淘宝，使用HTTPS加密数据更加安全。</li>

<li>以前旧版本12306网站需要下载证书</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen

<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("http://www.12306.cn/mormhweb/") #&#21487;&#20197;&#35775;&#38382;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("https://www.baidu.com/") #&#21487;&#20197;&#35775;&#38382;</span>

<span style="color: #a0522d;">request</span> = Request(<span style="color: #8b2252;">"https://www.12306.cn/mormhweb/"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#26412;&#25253;SSL&#35748;&#35777;&#24322;&#24120;</span>
request.add_header(
    <span style="color: #8b2252;">"User-agent"</span>,
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">ssl.CertificateError: hostname 'www.12306.cn' doesn't match either of ......</span>
<span style="color: #a020f0;">with</span> urlopen(request) <span style="color: #a020f0;">as</span> res:
    <span style="color: #483d8b;">print</span>(res._method)
    <span style="color: #483d8b;">print</span>(res.read())
</pre>
</div>

<ul class="org-ul">
<li>注意：一下说明都是针对旧版本的12306网站，来讲解，现在实在无法找打第二个自己给自己发证书的。</li>
<li>通过HTTPS访问12306的时候，失败的原因在于12306的证书未通过CA认证，它是自己生产的证书，不可信。而其它网站访问，如=<a href="https://www.baidu.com/=%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%8F%90%E7%A4%BA%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E5%AE%83%E7%9A%84%E8%AF%81%E4%B9%A6%E7%9A%84%E5%8F%91%E8%A1%8C%E8%80%85%E5%8F%97%E4%BF%A1%E4%BB%BB%EF%BC%8C%E4%B8%94%E6%97%A9%E5%B0%B1%E5%AD%98%E5%82%A8%E5%9C%A8%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E4%B8%AD">https://www.baidu.com/=%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%8F%90%E7%A4%BA%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E5%AE%83%E7%9A%84%E8%AF%81%E4%B9%A6%E7%9A%84%E5%8F%91%E8%A1%8C%E8%80%85%E5%8F%97%E4%BF%A1%E4%BB%BB%EF%BC%8C%E4%B8%94%E6%97%A9%E5%B0%B1%E5%AD%98%E5%82%A8%E5%9C%A8%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E4%B8%AD</a>。</li>
<li>遇到这种问题，解决思路：忽略证书不安全信息</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen
<span style="color: #a020f0;">import</span> ssl <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;ssl&#27169;&#22359;</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("http://www.12306.cn/mormhweb/") #&#21487;&#20197;&#35775;&#38382;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("https://www.baidu.com/") #&#21487;&#20197;&#35775;&#38382;</span>

<span style="color: #a0522d;">request</span> = Request(<span style="color: #8b2252;">"https://www.12306.cn/mormhweb/"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#26412;&#25253;SSL&#35748;&#35777;&#24322;&#24120;</span>
request.add_header(
    <span style="color: #8b2252;">"User-agent"</span>,
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24573;&#30053;&#19981;&#20449;&#20219;&#30340;&#35777;&#20070;</span>
<span style="color: #a0522d;">context</span> = ssl._create_unverified_context()
<span style="color: #a0522d;">res</span> = urlopen(request,context=context)

<span style="color: #b22222;"># </span><span style="color: #b22222;">ssl.CertificateError: hostname 'www.12306.cn' doesn't match either of ......</span>
<span style="color: #a020f0;">with</span> res:
    <span style="color: #483d8b;">print</span>(res._method)
    <span style="color: #483d8b;">print</span>(res.geturl())
    <span style="color: #483d8b;">print</span>(res.read().decode())
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a9ad48b9-d19f-4761-9e40-2788c839e14b" class="outline-3">
<h3 id="h:a9ad48b9-d19f-4761-9e40-2788c839e14b">urllib3库</h3>
<div class="outline-text-3" id="text-h:a9ad48b9-d19f-4761-9e40-2788c839e14b">
<p>
<a href="https://urllib3.readthedocs.io/en/latest/">https://urllib3.readthedocs.io/en/latest/</a><br>
标准库urlib缺少了一些关键的功能，非标准库的第三方库urllib3提供了，比如说连接池管理。
</p>

<ul class="org-ul">
<li>安装 <code>pip install urlib3</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> urllib3
<span style="color: #a020f0;">from</span> urllib3.response <span style="color: #a020f0;">import</span> HTTPResponse

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://movie.douban.com"</span>
<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38142;&#25509;&#27744;&#31649;&#29702;</span>
<span style="color: #a020f0;">with</span> urllib3.PoolManager() <span style="color: #a020f0;">as</span> http:
    <span style="color: #a0522d;">response</span>:<span style="color: #228b22;">HTTPResponse</span> = http.request(<span style="color: #8b2252;">"GET"</span>,url,headers={<span style="color: #8b2252;">"User-Agent"</span>:ua})
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response))
    <span style="color: #483d8b;">print</span>(response.status,response.reason)
    <span style="color: #483d8b;">print</span>(response.headers)
    <span style="color: #483d8b;">print</span>(response.data[:50])
</pre>
</div>


<figure id="orge5cd45a">
<img src="../../../img/python/robots_008.jpg" alt="robots_008.jpg">

<figcaption><span class="figure-number">Figure 7: </span>robots_008</figcaption>
</figure>
</div>
</div>
<div id="outline-container-h:0b5a6eed-ce46-4946-8a07-3856f717957e" class="outline-3">
<h3 id="h:0b5a6eed-ce46-4946-8a07-3856f717957e">requests库</h3>
<div class="outline-text-3" id="text-h:0b5a6eed-ce46-4946-8a07-3856f717957e">
<ul class="org-ul">
<li>requests使用了urllib3,但是API更加友好，推荐使用。</li>
<li>安装=pip install requests=</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://movie.douban.com/"</span>

<span style="color: #a0522d;">response</span> = requests.request(<span style="color: #8b2252;">"GET"</span>,url,headers={<span style="color: #8b2252;">"User-Agent"</span>:ua})

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response))
    <span style="color: #483d8b;">print</span>(response.url)
    <span style="color: #483d8b;">print</span>(response.status_code)
    <span style="color: #483d8b;">print</span>(response.request.headers) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#22836;</span>
    <span style="color: #483d8b;">print</span>(response.headers) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21709;&#24212;&#22836;</span>
    response.<span style="color: #a0522d;">encoding</span> = <span style="color: #8b2252;">"utf-8"</span>
    <span style="color: #483d8b;">print</span>(response.text[:200]) <span style="color: #b22222;">#</span><span style="color: #b22222;">HTML&#30340;&#20869;&#23481;</span>
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/movie.html'</span>,<span style="color: #8b2252;">"w"</span>,encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.text)
</pre>
</div>

<ul class="org-ul">
<li>requests默认使用Session对象，是为了多次和服务器端交互中保留会话的信息，例如：cookie。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#20351;&#29992;Session</span>
<span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:50.0) Gecko/20100101 Firefox/50.0"</span>
<span style="color: #a0522d;">urls</span> = [<span style="color: #8b2252;">"https://www.baidu.com/s?wd=xdd"</span>,<span style="color: #8b2252;">"https://www.baidu.com/s?wd=xdd"</span>]

<span style="color: #a0522d;">session</span> = requests.Session()
<span style="color: #a020f0;">with</span> session:
    <span style="color: #a020f0;">for</span> url <span style="color: #a020f0;">in</span> urls:
        <span style="color: #a0522d;">response</span> = session.get(url,headers = {<span style="color: #8b2252;">"User-Agent"</span>:ua})
        <span style="color: #b22222;"># </span><span style="color: #b22222;">response = requests.request("GET",url,headers={"User-Agent":ua}) #&#35266;&#23519;&#20004;&#31181;&#26041;&#24335;&#21306;&#21035;</span>
        <span style="color: #a020f0;">with</span> response:
            <span style="color: #483d8b;">print</span>(response.request.headers) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#22836;</span>
            <span style="color: #483d8b;">print</span>(response.cookies) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21709;&#24212;&#30340;cookie</span>
            <span style="color: #483d8b;">print</span>(response.text[:20]) <span style="color: #b22222;">#</span><span style="color: #b22222;">HTML&#30340;&#20869;&#23481;</span>
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"-"</span>*30)
</pre>
</div>

<ul class="org-ul">
<li>使用session访问，第二次带上了cookie</li>
</ul>


<figure id="orgf498ca0">
<img src="../../../img/python/robots_009.jpg" alt="robots_009.jpg">

<figcaption><span class="figure-number">Figure 8: </span>robots_009</figcaption>
</figure>
</div>
</div>
</section>
<section id="outline-container-h:93950bd9-2429-4fa5-8823-10fe7bac3876" class="outline-2">
<h2 id="h:93950bd9-2429-4fa5-8823-10fe7bac3876">HTML解析-Xpath</h2>
<div class="outline-text-2" id="text-h:93950bd9-2429-4fa5-8823-10fe7bac3876">
<p>
[toc]
</p>

<p>
HTML的内容返回给浏览器，浏览器就会解析它，并对它渲染。
</p>

<p>
HTML超文本表示语言，设计的初衷就是为了超越普通文本，让文本表现力更强。<br>
XML扩展标记语言，不是为了替代HTML，而是觉得HTML的设计中包含了过多的格式，承担了一部分数据之外的任务，所以才设计了XML只用来描述数据。
</p>

<p>
HTML和XML都有结构，使用标记形成树型的嵌套结构。DOM(Document Object
Model)来解析这种嵌套树型结构，浏览器往往都提供了对DOM操作的API，可以用面向对象的方式来操作DOM。
</p>
</div>
<div id="outline-container-h:3d601eb4-d05e-409b-817d-37dd4f8368f1" class="outline-3">
<h3 id="h:3d601eb4-d05e-409b-817d-37dd4f8368f1">XPath</h3>
<div class="outline-text-3" id="text-h:3d601eb4-d05e-409b-817d-37dd4f8368f1">
<ul class="org-ul">
<li><a href="http://www.w3school.com.cn/xpath/index.asp">http://www.w3school.com.cn/xpath/index.asp</a>中文教程</li>

<li>XPath是一门在XML文档中查找信息的语言。XPath可用来在XML文档中对元素和属性进行遍历。</li>

<li>测试工具：XMLQuire win7+需要.net框架4.0-4.5。</li>

<li>测试XML、XPath

<ol class="org-ol">
<li><p>
测试文档
</p>

<div class="org-src-container">
<pre class="src src-xml"><span style="color: #000000; background-color: #ffffff;">&lt;?</span><span style="color: #a020f0;">xml</span> <span style="color: #8b2252;">version="1.0" encoding="utf-8"</span><span style="color: #000000; background-color: #ffffff;">?&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">bookstore</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk101"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Gambardella, Matthew</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">XML Developer's Guide</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Computer</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">44.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2000-10-01</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">An in-depth look at creating applications </span>
<span style="color: #000000; background-color: #ffffff;">    with XML.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk102"</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"bookinfo even"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Ralls, Kim</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Midnight Rain</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Fantasy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">5.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2000-12-16</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">A former architect battles corporate zombies, </span>
<span style="color: #000000; background-color: #ffffff;">    an evil sorceress, and her own childhood to become queen </span>
<span style="color: #000000; background-color: #ffffff;">    of the world.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk103"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Corets, Eva</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Maeve Ascendant</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Fantasy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">5.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2000-11-17</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">After the collapse of a nanotechnology </span>
<span style="color: #000000; background-color: #ffffff;">    society in England, the young survivors lay the </span>
<span style="color: #000000; background-color: #ffffff;">    foundation for a new society.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk104"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Corets, Eva</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Oberon's Legacy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Fantasy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">5.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2001-03-10</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">In post-apocalypse England, the mysterious </span>
<span style="color: #000000; background-color: #ffffff;">    agent known only as Oberon helps to create a new life </span>
<span style="color: #000000; background-color: #ffffff;">    for the inhabitants of London. Sequel to Maeve </span>
<span style="color: #000000; background-color: #ffffff;">    Ascendant.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">bookstore</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
</pre>
</div></li>

<li>测试工具:XMLQuire win7+需要.NET框架4.0-4.5。<br>
<img src="../../../img/python/xpath_001.png" alt="xpath_001.png"></li>
</ol></li>
</ul>
</div>
<div id="outline-container-h:73350c13-31ad-4ee2-96b6-70ad6e516194" class="outline-4">
<h4 id="h:73350c13-31ad-4ee2-96b6-70ad6e516194">节点</h4>
<div class="outline-text-4" id="text-h:73350c13-31ad-4ee2-96b6-70ad6e516194">
<ul class="org-ul">
<li>在XPath中，有七种类型的节点：*元素、属性、文本、命名空间、处理指令、注释以及文档(根)节点。*

<ol class="org-ol">
<li>=/=根节点</li>
<li>=&lt;bookstore&gt;=元素节点</li>
<li>=&lt;author&gt;Corets,Eva&lt;/author&gt;=元素节点。</li>
<li><code>id</code>"bk104"=是属性节点，id是元素节点book的属性</li>
</ol></li>

<li>节点之间的嵌套形成*父子(parent,children)关系*。</li>

<li>具有统一个父结点的不同节点是*兄弟(sibling)关系*。</li>

<li><b>节点选择</b></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">操作符或表达式</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/</code></td>
<td class="org-left">从根节点开始找</td>
</tr>

<tr>
<td class="org-left"><code>//</code></td>
<td class="org-left">从当前节点开始的任意层找</td>
</tr>

<tr>
<td class="org-left"><code>.</code></td>
<td class="org-left">当前节点</td>
</tr>

<tr>
<td class="org-left"><code>..</code></td>
<td class="org-left">当前结点的父节点</td>
</tr>

<tr>
<td class="org-left"><code>@</code></td>
<td class="org-left">选择属性</td>
</tr>

<tr>
<td class="org-left"><code>节点名</code></td>
<td class="org-left">选取所有这个节点名的节点</td>
</tr>

<tr>
<td class="org-left"><code>*</code></td>
<td class="org-left">匹配任意元素节点</td>
</tr>

<tr>
<td class="org-left"><code>@*</code></td>
<td class="org-left">匹配任意属性节点</td>
</tr>

<tr>
<td class="org-left"><code>node()</code></td>
<td class="org-left">匹配任意类型的节点</td>
</tr>

<tr>
<td class="org-left"><code>text()</code></td>
<td class="org-left">匹配text类型节点</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><b>谓语(Predicates)</b></li>

<li>谓语用来查找某个特定的节点或者包含某个指定的值的节点。</li>
<li>*谓语被嵌在方括号中*。</li>
<li>谓语就是查询的条件。</li>
<li>即在路径选择时，在中括号内指定查询条件。</li>

<li><b>XPath轴(Axes)</b></li>

<li>轴的意思是相对于当前结点的节点集</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">轴名称</th>
<th scope="col" class="org-left">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ancestor</td>
<td class="org-left">选取当前结点的所有先辈(父、祖父等)</td>
</tr>

<tr>
<td class="org-left">ancestor-or-self</td>
<td class="org-left">选取当前节点的所有先辈(父、祖父等)以及当前节点本身</td>
</tr>

<tr>
<td class="org-left">attribute</td>
<td class="org-left">选取当前节点的所有属性。?? (????)::id</td>
</tr>

<tr>
<td class="org-left">child</td>
<td class="org-left">选取当前节点的所有子元素，title等价于child:title</td>
</tr>

<tr>
<td class="org-left">descendant</td>
<td class="org-left">选取当前节点的所有后代元素(子、孙等)</td>
</tr>

<tr>
<td class="org-left">descendant-or-self</td>
<td class="org-left">选取当前节点的所有后代运算(子、孙等)以及当前节点本身</td>
</tr>

<tr>
<td class="org-left">following</td>
<td class="org-left">选取文档中当前节点的结束标签之后的所有结点</td>
</tr>

<tr>
<td class="org-left">namespace</td>
<td class="org-left">选取当前节点的所有命名空间节点</td>
</tr>

<tr>
<td class="org-left">parent</td>
<td class="org-left">选取当前节点的父节点</td>
</tr>

<tr>
<td class="org-left">preceding</td>
<td class="org-left">选取当前节点的父节点</td>
</tr>

<tr>
<td class="org-left">preceding-sibling</td>
<td class="org-left">选取当前节点之前的所有同级节点</td>
</tr>

<tr>
<td class="org-left">self</td>
<td class="org-left">选取当前节点。等驾驭self::node()</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><b>步Step</b></li>

<li>步的语法=轴名称：节点测试[谓语]=</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">例子</th>
<th scope="col" class="org-left">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>child::book</code></td>
<td class="org-left">选取所有属于当前节点的只元素的book节点</td>
</tr>

<tr>
<td class="org-left"><code>attribute::lang</code></td>
<td class="org-left">选取当前节点的lang属性</td>
</tr>

<tr>
<td class="org-left"><code>child::*</code></td>
<td class="org-left">选取当前节点的所有只元素</td>
</tr>

<tr>
<td class="org-left"><code>attribute::*</code></td>
<td class="org-left">选取当前节点的所有属性</td>
</tr>

<tr>
<td class="org-left"><code>child::text()</code></td>
<td class="org-left">选取当前节点的所有文本子节点</td>
</tr>

<tr>
<td class="org-left"><code>child::node()</code></td>
<td class="org-left">选取当前节点的所有子节点</td>
</tr>

<tr>
<td class="org-left"><code>descendant::book</code></td>
<td class="org-left">选取当前节点的所有book后代</td>
</tr>

<tr>
<td class="org-left"><code>ancestor:book</code></td>
<td class="org-left">选择当前节点的所有book先辈</td>
</tr>

<tr>
<td class="org-left"><code>ancestor-or-self::book</code></td>
<td class="org-left">选取当前节点的所有book先辈以及当前节点(如果此节点是book节点)</td>
</tr>

<tr>
<td class="org-left"><code>child::*/child::price</code></td>
<td class="org-left">选取当前节点的所有price孙节点</td>
</tr>
</tbody>
</table>


<figure id="orgd36dfc2">
<img src="../../../img/python/xpath_002.jpg" alt="xpath_002.jpg">

<figcaption><span class="figure-number">Figure 9: </span>xpath_002</figcaption>
</figure>


<figure id="orgb802c88">
<img src="../../../img/python/xpath_003.jpg" alt="xpath_003.jpg">

<figcaption><span class="figure-number">Figure 10: </span>xpath_003</figcaption>
</figure>

<ul class="org-ul">
<li><b>XPATH示例</b></li>

<li>以斜杠开始的称为绝对路径，表示从根开始。</li>
<li>不以斜杠开始的称为相对路径，一般都是依照当前节点来计算。当前节点在上下文环境中，当前节点很可能已经补是根节点了。</li>
<li>一般为了方便，往往xml如果层次很深，都会使用=//=来查找节点。</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">路径表达式</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>title</code></td>
<td class="org-left">选取当前节点下所有title子节点</td>
</tr>

<tr>
<td class="org-left"><code>/book</code></td>
<td class="org-left">从根节点找子节点是book的，找不到</td>
</tr>

<tr>
<td class="org-left"><code>book/title</code></td>
<td class="org-left">当前节点下所有子节点book下的title节点</td>
</tr>

<tr>
<td class="org-left"><code>//title</code></td>
<td class="org-left">从根节点向下找任意层中title的结点</td>
</tr>

<tr>
<td class="org-left"><code>book//title</code></td>
<td class="org-left">当前节点下所有book子节点下任意层次的title节点</td>
</tr>

<tr>
<td class="org-left"><code>//@id</code></td>
<td class="org-left">任意层次下含有id的*属性，取回的是属性*</td>
</tr>

<tr>
<td class="org-left"><code>//book[@id]</code></td>
<td class="org-left">任意层次下含有id属性的book节点</td>
</tr>

<tr>
<td class="org-left"><code>//*[@id]</code></td>
<td class="org-left">任意层下含有id属性的节点</td>
</tr>

<tr>
<td class="org-left"><code>//book[@id</code>"bk102"]=</td>
<td class="org-left">任意层次下book节点，且含有id属性为bk102的节点。</td>
</tr>

<tr>
<td class="org-left"><code>/bookstore/book[1]</code></td>
<td class="org-left">根节点bookstore下第一个book节点，*从1开始*</td>
</tr>

<tr>
<td class="org-left"><code>/bookstore/book[1]/@id</code></td>
<td class="org-left">根节点bookstore下的第一个book节点的id属性</td>
</tr>

<tr>
<td class="org-left"><code>/bookstore/book[last()-1]</code></td>
<td class="org-left">根节点bookstore下*倒数*第二个book节点,函数last()返回最后一个元素索引</td>
</tr>

<tr>
<td class="org-left"><code>/bookstore/*</code></td>
<td class="org-left">匹配根节点bookstore的所有子节点，不递归</td>
</tr>

<tr>
<td class="org-left"><code>//*</code></td>
<td class="org-left">匹配所有子孙节点</td>
</tr>

<tr>
<td class="org-left"><code>//*[@*]</code></td>
<td class="org-left">匹配所有有属性的节点</td>
</tr>

<tr>
<td class="org-left">=//book/title</td>
<td class="org-left">//price=</td>
<td class="org-left">匹配任意层下的book下节点是title节点，或者任意层下的price</td>
</tr>

<tr>
<td class="org-left"><code>//book[position()=2]</code></td>
<td class="org-left">匹配book节点，取第二个</td>
</tr>

<tr>
<td class="org-left"><code>//book[position()&lt;last()-1]</code></td>
<td class="org-left">匹配book节点，取位置小于倒数第二个</td>
</tr>

<tr>
<td class="org-left"><code>//book[price&gt;40]</code></td>
<td class="org-left">匹配book节点，取*节点值*大于40的book节点</td>
</tr>

<tr>
<td class="org-left"><code>//book[2]/node()</code></td>
<td class="org-left">匹配位置为2的book节点下的所有类型的节点</td>
</tr>

<tr>
<td class="org-left"><code>//book[1]/text()</code></td>
<td class="org-left">匹配第一个book节点下的所有文本子节点</td>
</tr>

<tr>
<td class="org-left"><code>//book[1]/text()</code></td>
<td class="org-left">匹配第一个book节点下的所有文本节点</td>
</tr>

<tr>
<td class="org-left"><code>//*[local-name()</code>"book"]=</td>
<td class="org-left">匹配所有节点且不带限定名的节点名称为book的所有节点。local-name函数取不带限定名的名称。相当于指定*标签元素*为&#x2026;的节点</td>
</tr>

<tr>
<td class="org-left">下面这三种表达式等价=//book[price&lt;6]/price==//book/price[text()&lt;6]==//book/child::node()[local-name()="price" and text()&lt;6]=</td>
<td class="org-left">获取book节点下的price节点，且price中内容小于6的节点</td>
</tr>

<tr>
<td class="org-left">=//book//*[self::title or self::price]=等价于=//book//title</td>
<td class="org-left">//book/price=也等价于=//book//*[local-name()="title" or local-name()="price"]=</td>
<td class="org-left">所有book节点下子孙节点，且这些节点是title或者price。</td>
</tr>

<tr>
<td class="org-left"><code>//*[@class]</code></td>
<td class="org-left">所有有class属性的节点</td>
</tr>

<tr>
<td class="org-left"><code>//*[@class</code>"bookinfo even"]=</td>
<td class="org-left">所有属性为“bookinfo even”的节点</td>
</tr>

<tr>
<td class="org-left"><code>//*[contains(@class,'even')</code></td>
<td class="org-left">获取所有属性class中包含even字符串的节点</td>
</tr>

<tr>
<td class="org-left"><code>//*[contains(local-name(),'book')</code></td>
<td class="org-left">标签名包含book的节点</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>函数总结</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">函数</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>local-name()</code></td>
<td class="org-left">获取不带限定名的名称。相当于指定*标签元素*</td>
</tr>

<tr>
<td class="org-left"><code>text()</code></td>
<td class="org-left">获取标签之间的文本内容</td>
</tr>

<tr>
<td class="org-left"><code>node()</code></td>
<td class="org-left">所有节点。</td>
</tr>

<tr>
<td class="org-left"><code>contains(@class,str)</code></td>
<td class="org-left">包含</td>
</tr>

<tr>
<td class="org-left"><code>starts-with(local-name(),"book")</code></td>
<td class="org-left">以book开头</td>
</tr>

<tr>
<td class="org-left"><code>last()</code></td>
<td class="org-left">最后一个元素索引</td>
</tr>

<tr>
<td class="org-left"><code>position()</code></td>
<td class="org-left">元素索引</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e" class="outline-3">
<h3 id="h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e">lxml</h3>
<div class="outline-text-3" id="text-h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e">
<ul class="org-ul">
<li>lxml是Python下功能丰富的XML、HTML解析库，性能非常好，是对libxml2和libxslt的封装。</li>
<li>最新版本支持Python 2.6+,python3支持3.6.</li>

<li>在CentOS编译安装需要</li>
</ul>

<blockquote>
<p>
​#yum install libxml2-devel libxslt-devel
</p>
</blockquote>

<ul class="org-ul">
<li>注意,不同平台不一样，参看<a href="https://lxml.de/installation.html">https://lxml.de/installation.html</a></li>

<li>lxml安装=$ pip install lxml=</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;etree&#26500;&#24314;HTML</span>
<span style="color: #a0522d;">root</span> = etree.Element(<span style="color: #8b2252;">"html"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(root))
<span style="color: #483d8b;">print</span>(root.tag)

<span style="color: #a0522d;">body</span> = etree.Element(<span style="color: #8b2252;">"body"</span>)
root.append(body)
<span style="color: #483d8b;">print</span>(etree.tostring(root))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#23376;&#33410;&#28857;</span>
<span style="color: #a0522d;">sub</span> = etree.SubElement(body,<span style="color: #8b2252;">"child1"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(sub))
<span style="color: #a0522d;">sub</span> = etree.SubElement(body,<span style="color: #8b2252;">"child2"</span>).append(etree.Element(<span style="color: #8b2252;">"child21"</span>))
<span style="color: #a0522d;">html</span> = etree.tostring(root,pretty_print=<span style="color: #008b8b;">True</span>).decode()
<span style="color: #483d8b;">print</span>(html)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #a0522d;">r</span> = etree.HTML(html) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#26681;&#33410;&#28857;</span>
<span style="color: #483d8b;">print</span>(r.tag)
<span style="color: #483d8b;">print</span>(r.xpath(<span style="color: #8b2252;">"//*[contains(local-name(),'child')]"</span>))
</pre>
</div>


<figure id="org8a6134e">
<img src="../../../img/python/xpath_004.jpg" alt="xpath_004.jpg">

<figcaption><span class="figure-number">Figure 11: </span>xpath_004</figcaption>
</figure>

<ol class="org-ol">
<li>etree还提供了2个有用的函数</li>
<li>etree.HTML(text)解析HTML文档，返回根节点</li>
<li><b>anode.xpath('xpath路径')对节点使用xpath语法</b></li>

<li><b>练习：爬取“口碑榜”</b>
<ol class="org-ol">
<li>从豆瓣电影中获取”本周口碑榜”</li>
</ol></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree
<span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://movie.douban.com/"</span>
<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>

<span style="color: #a020f0;">with</span> requests.get(url,headers={<span style="color: #8b2252;">"User-agent"</span>:ua}) <span style="color: #a020f0;">as</span> response:
    <span style="color: #a020f0;">if</span> response.status_code==200:
        <span style="color: #a0522d;">content</span> = response.text <span style="color: #b22222;">#</span><span style="color: #b22222;">html&#20869;&#23481;</span>
        <span style="color: #a0522d;">html</span> = etree.HTML(content) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#26512;html&#65292;&#36820;&#22238;DOM&#26681;&#33410;&#28857;</span>
        <span style="color: #a0522d;">titles</span> = html.xpath(<span style="color: #8b2252;">"//div[@class='billboard-bd']//tr/td/a/text()"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;&#21015;&#34920;</span>
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> titles: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35910;&#29923;&#30005;&#24433;&#20043;&#26412;&#21608;&#25490;&#34892;&#27036;</span>
            <span style="color: #483d8b;">print</span>(i)
    <span style="color: #a020f0;">else</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#35775;&#38382;&#38169;&#35823;"</span>)
</pre>
</div>


<figure id="org86ee1c9">
<img src="../../../img/python/xpath_005.jpg" alt="xpath_005.jpg">

<figcaption><span class="figure-number">Figure 12: </span>xpath_005</figcaption>
</figure>
</div>
</div>
</section>
<section id="outline-container-h:05056423-ee64-468c-bdd6-ad4f63b6d935" class="outline-2">
<h2 id="h:05056423-ee64-468c-bdd6-ad4f63b6d935">BeautifulSoup4和JsonPath</h2>
<div class="outline-text-2" id="text-h:05056423-ee64-468c-bdd6-ad4f63b6d935">
<p>
[toc]
</p>
</div>
<div id="outline-container-h:3588ac25-80d5-414f-914c-fff2fad17e68" class="outline-3">
<h3 id="h:3588ac25-80d5-414f-914c-fff2fad17e68">BeautifulSoup4</h3>
<div class="outline-text-3" id="text-h:3588ac25-80d5-414f-914c-fff2fad17e68">
<ul class="org-ul">
<li>BeautifulSoup可以从HTML、XML中提取数据，目前BS4在持续开发。</li>

<li>官方中文文档<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/">https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/</a></li>

<li><b>安装</b>

<ol class="org-ol">
<li><code>pip install beautifulsoup4</code></li>
</ol></li>

<li>导入：=from bs4 import BuautifulSoup=</li>

<li>初始化：

<ol class="org-ol">
<li>BeautifulSoup(markup=““,features=None)
<ul class="org-ul">
<li>markup,被解析对象，可以是文件对象或者html字符串</li>
<li>feature指定解析器</li>
<li>return:返回一个文档对象</li>
</ul></li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#23545;&#35937;</span>
<span style="color: #a0522d;">soup</span> = BeautifulSoup(<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>))
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26631;&#35760;&#23383;&#31526;&#20018;</span>
<span style="color: #a0522d;">soup</span> = BeautifulSoup(<span style="color: #8b2252;">"&lt;html&gt;data&lt;/html&gt;"</span>)
</pre>
</div>

<ul class="org-ul">
<li>可以不指定解析器，就依赖系统已经安装的解析器库了。</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">解析器</th>
<th scope="col" class="org-left">使用方法</th>
<th scope="col" class="org-left">优势</th>
<th scope="col" class="org-left">劣势</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Python标准库</td>
<td class="org-left">BeautifulSoup(markup,"html.parser")</td>
<td class="org-left">Python的内置标准库执行速度适中文档容错能力强</td>
<td class="org-left">Python 2.7.3、3.2.2前 的版本中文档容错能力差</td>
</tr>

<tr>
<td class="org-left">lxml HTML 解析器</td>
<td class="org-left">BeautifulSoup(markup,"lxml")</td>
<td class="org-left">速度快文档容错能力强</td>
<td class="org-left">需要安装C语言库</td>
</tr>

<tr>
<td class="org-left">lxml XML 解析器</td>
<td class="org-left">BeautifulSoup(markup,["lxml","xml"])BeautifulSoup(markup,"xml")</td>
<td class="org-left">速度快唯一支持XML的解析器</td>
<td class="org-left">需要安装C语言库</td>
</tr>

<tr>
<td class="org-left">html5lib</td>
<td class="org-left">BeautifulSoup(markup,"html5lib")</td>
<td class="org-left">最好的容错性以浏览器的方式解析文档生成HTML5格式的文档</td>
<td class="org-left">速度慢不依赖外部扩展</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>BeautifulSoup(markup,"html.parser")使用Python标准库，容错差且性能一般。</li>
<li>BeautifulSoup(markup,"lxml")容错能力强，速度快。需要安装系统C库。</li>
<li>推荐使用lxml作为解析器，效率高。</li>
<li>需要手动指定解析器，以保证代码在所有运行环境中解析器一致。</li>

<li>使用下面内容构建test.html使用bs4解析它</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#39318;&#39029;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">xdd&#27426;&#36814;&#24744;</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"main"</span>&gt;
    &lt;<span style="color: #0000ff;">h3</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"title highlight"</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"http://www.python.org"</span>&gt;python&lt;/<span style="color: #0000ff;">a</span>&gt;&#39640;&#32423;&#29677;&lt;/<span style="color: #0000ff;">h3</span>&gt;
    &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"content"</span>&gt;
        &lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"first"</span>&gt;&#23383;&#20856;&lt;/<span style="color: #0000ff;">p</span>&gt;
        &lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"second"</span>&gt;&#21015;&#34920;&lt;/<span style="color: #0000ff;">p</span>&gt;
        &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"_csrf"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"absdoia23lkso234r23oslfn"</span>&gt;
        <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">comment</span><span style="color: #b22222;"> --&gt;</span>
        &lt;<span style="color: #0000ff;">img</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bg1"</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://www.xdd.com/"</span>&gt;
        &lt;<span style="color: #0000ff;">img</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bg2"</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://httpbin.org/"</span>&gt;
    &lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;<span style="color: #0000ff;">p</span>&gt;bottom&lt;/<span style="color: #0000ff;">p</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
</pre>
</div>

<ul class="org-ul">
<li><b>四种对象</b></li>

<li>BeautifulSoup将HTML文档解析成复杂的树型结构，每个节点都是Python的对象，可分为4种：
<ul class="org-ul">
<li>BeautifulSoup、Tag、NavigableString、Comment</li>

<li>*BeautifulSoup对象*：代表整个文档。</li>
<li>*Tag对象*：对应着HTML中的标签。有2个常用的属性：
<ol class="org-ol">
<li>name:Tag对象的名称，就是标签名称</li>
<li>attrs:标签的属性字典
<ul class="org-ul">
<li>多值属性，对于class属性可能是下面的形式，=&lt;h3 class="title highlight"&gt;python高级班&lt;/h3&gt;=这个属性就是多值({"class":["title","highlight"]})</li>
<li>属性可以被修改、删除</li>
</ul></li>
</ol></li>
</ul></li>

<li>BeautifulSoup.prettify()
​#带格式输出解析的文档对象(即有缩进的输出)，注意：直接输出BeautifulSoup会直接输出解析的文档对象，没有格式。</li>
<li>BeautifulSoup.div
​#输出匹配到的第一个div对象中的内容，返回对象是bs4.element.Tag类型</li>
<li>BeautifulSoup.h3.get("class")
​#获取文档中第一个标签为h3对象中class属性值</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.builder)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(0,soup) #&#36755;&#20986;&#25972;&#20010;&#35299;&#26512;&#30340;&#25991;&#26723;&#23545;&#35937;(&#19981;&#24102;&#26684;&#24335;&#65289;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(1,soup.prettify()) #&#25353;&#29031;&#26684;&#24335;&#36755;&#20986;&#25991;&#26723;&#20869;&#23481;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(2,soup.div,type(soup.div)) #&#31867;&#22411;bs4.element.Tag&#65292;Tag&#23545;&#35937;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(3,soup.div["class"]) #&#20250;&#25253;&#38169;&#65292;keyError&#65292;div&#27809;&#26377;class&#23646;&#24615;</span>
    <span style="color: #483d8b;">print</span>(3,soup.div.get(<span style="color: #8b2252;">"class"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;div&#30340;class&#23646;&#24615;&#65292;&#27809;&#26377;&#36820;&#22238;None</span>

    <span style="color: #483d8b;">print</span>(4,soup.div.h3[<span style="color: #8b2252;">"class"</span>]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20540;&#23646;&#24615;</span>
    <span style="color: #483d8b;">print</span>(4,soup.h3.get(<span style="color: #8b2252;">"class"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20540;&#23646;&#24615;,&#33719;&#21462;&#25991;&#26723;&#20013;&#31532;&#19968;h3&#26631;&#31614;&#20013;&#30340;class&#23646;&#24615;</span>
    <span style="color: #483d8b;">print</span>(4,soup.h3.attrs.get(<span style="color: #8b2252;">"class"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20540;&#23646;&#24615;</span>

    <span style="color: #483d8b;">print</span>(5,soup.img.get(<span style="color: #8b2252;">"src"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;img&#20013;src&#23646;&#24615;&#20540;</span>
    soup.<span style="color: #a0522d;">img</span>[<span style="color: #8b2252;">"src"</span>] = <span style="color: #8b2252;">"http://www.xddupdate.com"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20540;</span>
    <span style="color: #483d8b;">print</span>(5,soup.img[<span style="color: #8b2252;">"src"</span>])

    <span style="color: #483d8b;">print</span>(6,soup.a) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#19981;&#21040;&#36820;&#22238;None</span>
    <span style="color: #a020f0;">del</span> soup.h3[<span style="color: #8b2252;">"class"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#23646;&#24615;</span>
    <span style="color: #483d8b;">print</span>(4,soup.h3.get(<span style="color: #8b2252;">"class"</span>))
</pre>
</div>


<figure id="org167e3c7">
<img src="../../../img/python/bsoup_001.jpg" alt="bsoup_001.jpg">

<figcaption><span class="figure-number">Figure 13: </span>bsoup_001</figcaption>
</figure>

<ul class="org-ul">
<li>注意：我们一般不使用声明这种方式来操作HTML，此代码时为了熟悉对象类型</li>

<li><b>NavigableString</b></li>

<li>如果只想输出标记的文本，而不关心标记的话，就要使用NavigableString.</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.div.p.string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#20010;div&#19979;&#31532;&#19968;&#20010;p&#30340;&#23383;&#31526;&#20018;</span>
<span style="color: #483d8b;">print</span>(soup.p.string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19978;</span>
</pre>
</div>

<ul class="org-ul">
<li>*注释对象*：这就是HTML中的注释，它被BeautifulSoup解析后对应Comment对象。</li>
</ul>
</div>
<div id="outline-container-h:1e6751b5-780e-4f68-8535-4e3974da24a2" class="outline-4">
<h4 id="h:1e6751b5-780e-4f68-8535-4e3974da24a2">遍历文档树</h4>
<div class="outline-text-4" id="text-h:1e6751b5-780e-4f68-8535-4e3974da24a2">
<ul class="org-ul">
<li>在文档树中找到关心的内容才是日常的工资，也就是说如何遍历树中的节点。使用上面的test.html来测试</li>

<li><b>使用Tag</b>
<ul class="org-ul">
<li>soup.div可以找到从根节点开始查找第一个div节点,返回一个Tag对象</li>
<li>soup.div.p说明从根节点开始找到第一个div后返回一个Tag对象，这个Tag对象下继续找第一个p，找到返回Tag对象</li>
<li>soup.p返回了文字“字典”，而不是文字“bottom”说明遍历时*深度优先*，返回也是Tag对象</li>
</ul></li>
<li><b>遍历直接子节点</b>
<ul class="org-ul">
<li>Tag.contents #将对象的所有类型直接子节点以列表方式输出</li>
<li>Tag.children #返回子节点的迭代器
<ul class="org-ul">
<li>Tag.children #等价于Tag.contents</li>
</ul></li>
</ul></li>
<li><p>
<b>遍历所有子孙节点</b>
</p>
<ul class="org-ul">
<li>Tag.descendants
​#返回节点的所有类型子孙节点，可以看出迭代次序是深度优先</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.p.string)
    <span style="color: #483d8b;">print</span>(soup.div.contents) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#23376;&#26631;&#31614;&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> soup.div.children: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#23376;&#26631;&#31614;&#21487;&#36845;&#20195;&#23545;&#35937;</span>
        <span style="color: #483d8b;">print</span>(i.name)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(
        <span style="color: #a020f0;">lambda</span> x:x.name <span style="color: #a020f0;">if</span> x.name <span style="color: #a020f0;">else</span> x,
        soup.div.descendants <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#23376;&#23385;</span>
    )))
</pre>
</div>

<p>
<img src="../../../img/python/bsoup_002.jpg" alt="bsoup_002.jpg"><br>
</p></li>
<li><p>
<b>遍历字符串</b>
</p>
<ul class="org-ul">
<li>在前面的例子中，soup.div.string返回None，是因为string要求soup.div只能有一个NavigableString类型子节点，也就是这样=&lt;div&gt;only string&lt;/div&gt;=。</li>
<li>Tag.string #获取Tag下的string对象，如果多余1个结点返回None</li>
<li>Tag.strings #返回迭代器，带多余的空白字符。所有的string对象</li>
<li>Tag.stripped_strings #返回，会去除多余空白字符</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.div.string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;None&#65292;&#22240;&#20026;&#22810;&#20313;1&#20010;&#23376;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">""</span>.join(soup.div.strings).strip()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#36845;&#20195;&#22120;&#65292;&#24102;&#22810;&#20313;&#30340;&#31354;&#30333;&#23383;&#31526;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">""</span>.join(soup.div.stripped_strings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#36845;&#20195;&#22120;&#65292;&#21435;&#38500;&#22810;&#20313;&#31354;&#30333;&#23383;&#31526;</span>
</pre>
</div>


<figure id="org1da9083">
<img src="../../../img/python/bsoup_003.jpg" alt="bsoup_003.jpg">

<figcaption><span class="figure-number">Figure 14: </span>bsoup_003</figcaption>
</figure></li>

<li><p>
<b>遍历祖先节点</b>
</p>
<ul class="org-ul">
<li>BeautifulSoup.parent
​#获取根节点的父结点，必定返回None,根节点没有父结点</li>
<li>Tag.parent #获取第一个Tag的父结点</li>
<li>Tag.parent.parent.get("id") #获取第一个tag的父结点的父结点的id属性</li>
<li>Tag.parents #获取Tag节点的所有父结点，由近及远</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(soup))
    <span style="color: #483d8b;">print</span>(soup.parent)
    <span style="color: #483d8b;">print</span>(soup.div.parent.name) <span style="color: #b22222;">#</span><span style="color: #b22222;">body ,&#31532;&#19968;&#20010;div&#30340;&#29238;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(soup.p.parent.parent.get(<span style="color: #8b2252;">"id"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;id&#23646;&#24615;&#65292; main</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.name,soup.p.parents))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29238;&#36845;&#20195;&#22120;&#65292;&#30001;&#36817;&#21450;&#36828;</span>
</pre>
</div>

<p>
<img src="../../../img/python/bsoup_004.jpg" alt="bsoup_004.jpg"><br>
</p></li>
<li><p>
<b>遍历兄弟节点</b>
</p>
<ul class="org-ul">
<li>Tag.next_sibling
​#第一个Tag元素的下一个(下面)兄弟节点，注意：可能是一个文本节点</li>
<li>Tag.previous_sibling
​#第一个Tag元素之前的兄弟节点(上面)，注意：可能是一个文本节点</li>
<li>Tag.next_siblings #获取Tag元素的下面的所有兄弟节点</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(soup),<span style="color: #483d8b;">type</span>(soup.p))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{} [{}]"</span>.<span style="color: #483d8b;">format</span>(1,soup.p.next_sibling.encode()))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{} [{}]"</span>.<span style="color: #483d8b;">format</span>(2,soup.p.previous_sibling.encode()))
    <span style="color: #483d8b;">print</span>(soup.p.previous_sibling.next_sibling) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31561;&#20215;&#20110;soup.p</span>
    <span style="color: #483d8b;">print</span>(soup.p.next_sibling.previous_sibling)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#20215;&#20110;soup.p</span>
    <span style="color: #483d8b;">print</span>(soup.p)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_siblings))
</pre>
</div>

<p>
<img src="../../../img/python/bsoup_005.jpg" alt="bsoup_005.jpg"><br>
</p></li>
<li><p>
<b>遍历其他元素</b>
</p>
<ul class="org-ul">
<li>Tag.next_element
​#是下一个可被解析的对象(字符串或tag),和下一个兄弟节点next_sibling不一样</li>
<li>Tag.next_elements #返回所有下一个可被解析的对象，是个可迭代对象。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(soup),<span style="color: #483d8b;">type</span>(soup.p))
    <span style="color: #483d8b;">print</span>(soup.p.next_element) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;"&#23383;&#20856;"2&#20010;&#23383;</span>
    <span style="color: #483d8b;">print</span>(soup.p.next_element.next_element.encode())
    <span style="color: #483d8b;">print</span>(soup.p.next_element.next_element.next_element)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_elements))

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#27604;&#24046;&#24322;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_elements))
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_siblings))
</pre>
</div>


<figure id="orge100c70">
<img src="../../../img/python/bsoup_006.jpg" alt="bsoup_006.jpg">

<figcaption><span class="figure-number">Figure 15: </span>bsoup_006</figcaption>
</figure></li>
</ul>
</div>
</div>
<div id="outline-container-h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641" class="outline-4">
<h4 id="h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641">搜索文档树</h4>
<div class="outline-text-4" id="text-h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641">
<ul class="org-ul">
<li>find系有很多分发，请执行查询帮助<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/#id25">https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/#id25</a></li>

<li>=find_all(name=None,attrs={},recursive=True,text=None,limit=None,**kwargs)=#立即返回一个列表</li>

<li><b>name参数</b>:官方称为*fiter过滤器*，这个参数可以是一下

<ol class="org-ol">
<li>*字符串*：一个标签名称的字符串，会按照这个字符串全长匹配标签名
=print(soup.find_all('p'))=#返回文档中所有p标签</li>

<li><p>
<b>正则表达式对象</b>:按照”正则表达式对象”的模式匹配标签名
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> re
<span style="color: #483d8b;">print</span>(soup.find_all(re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"^h\d"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#31614;&#21517;&#20197;h&#24320;&#22836;&#21518;&#25509;&#25968;&#23383;</span>
</pre>
</div></li>

<li><p>
*列表*：或关系查找列表中的每个字符串
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all([<span style="color: #8b2252;">"p"</span>,<span style="color: #8b2252;">"h1"</span>,<span style="color: #8b2252;">"h3"</span>])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#20851;&#31995;&#65292;&#25214;&#20986;&#21015;&#34920;&#25152;&#26377;&#30340;&#26631;&#31614;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"^p|h|\d$"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;&#23436;&#25104;</span>
</pre>
</div></li>

<li><p>
<b>True或None</b>,则find_all返回全部非字符串节点、非注释节点，就是Tag标签类型
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.name, soup.find_all(<span style="color: #008b8b;">True</span>))))
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.name, soup.find_all(<span style="color: #008b8b;">None</span>))))
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.name, soup.find_all())))
</pre>
</div>


<figure id="org197bbbc">
<img src="../../../img/python/bsoup_007.jpg" alt="bsoup_007.jpg">

<figcaption><span class="figure-number">Figure 16: </span>bsoup_007</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #a0522d;">values</span> = [<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">None</span>,<span style="color: #008b8b;">False</span>]
    <span style="color: #a020f0;">for</span> value <span style="color: #a020f0;">in</span> values:
        <span style="color: #483d8b;">all</span> = soup.find_all(value)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(<span style="color: #483d8b;">all</span>[0]))
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">len</span>(<span style="color: #483d8b;">all</span>))

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #a0522d;">count</span> = 0
    <span style="color: #a020f0;">for</span> i,t <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(soup.descendants): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36941;&#21382;&#25152;&#26377;&#31867;&#22411;&#30340;&#23376;&#23385;&#33410;&#28857;</span>
        <span style="color: #483d8b;">print</span>(i,<span style="color: #483d8b;">type</span>(t),t.name)
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(t,Tag): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#23545;Tag&#31867;&#22411;&#35745;&#25968;</span>
            <span style="color: #a0522d;">count</span> += 1
    <span style="color: #483d8b;">print</span>(count)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#30446;&#19968;&#33268;&#65292;&#25152;&#20197;&#36820;&#22238;&#30340;&#26159;Tag&#31867;&#22411;&#30340;&#33410;&#28857;&#65292;&#28304;&#30721;&#20013;&#30830;&#23454;&#36820;&#22238;&#30340;Tag&#31867;&#22411;</span>
</pre>
</div>

<p>
<img src="../../../img/python/bsoup_008.jpg" alt="bsoup_008.jpg"><br>
</p></li>

<li><p>
<b>函数</b>
</p>

<ul class="org-ul">
<li>如果使用以上过滤器还不能提取想要的节点，可以使用函数，此函数仅只能*接收一个参数*。</li>
<li>如果这个函数返回True,表示当前节点配置；返回False则是不匹配。</li>

<li>示例：找出所有class属性且有多个值的节点(测试html中符合这个条件只有h3标签)</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">many_classes</span>(tag:Tag):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(tag))</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(tag.attrs))</span>
    <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">len</span>(tag.attrs.get(<span style="color: #8b2252;">"class"</span>,[])) &gt; 1

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.find_all(many_classes))
</pre>
</div>

<p>
<img src="../../../img/python/bsoup_009.jpg" alt="bsoup_009.jpg"><br>
</p></li>
</ol></li>

<li><p>
<b>keyword传参</b>
</p>

<ol class="org-ol">
<li>使用关键字传参，如果参数名不是find系函数已定义的位置参数名，参数会被kwargs收集并被*当做标签的属性*来搜索。</li>
<li>属性的传参可以是字符串、正则表达式对象、True、列表。</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #8b2252;">"first"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">id&#20026;first&#30340;&#25152;&#26377;&#32467;&#28857;&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(1,<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"\w+"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#25214;&#26377;di&#30340;&#25152;&#26377;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(2,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#26377;id&#30340;&#33410;&#28857;</span>

    <span style="color: #483d8b;">print</span>(3,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x[<span style="color: #8b2252;">"id"</span>],soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>))))
    <span style="color: #483d8b;">print</span>(4,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=[<span style="color: #8b2252;">"first"</span>,re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"^sec"</span>)])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;id&#30340;&#21517;&#31216;&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(5,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>,src=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#26465;&#20214;and,&#26082;&#26377;id&#21448;&#26377;src&#23646;&#24615;&#30340;&#33410;&#28857;&#21015;&#34920;</span>
</pre>
</div>


<figure id="org5d3aa94">
<img src="../../../img/python/bsoup_010.jpg" alt="bsoup_010.jpg">

<figcaption><span class="figure-number">Figure 17: </span>bsoup_010</figcaption>
</figure></li>

<li><p>
<b>css的class的特殊处理</b>
</p>

<ol class="org-ol">
<li>class是Python关键字，所以使用=class_=。class是多值属性，可以匹配其中任意一个，也可以完全匹配。</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"content"</span>))
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"title"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20351;&#29992;&#20219;&#24847;&#19968;&#20010;css&#31867;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"highlight"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20351;&#29992;&#20219;&#24847;&#19968;&#20010;css&#31867;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"highlight title"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39034;&#24207;&#38169;&#20102;&#65292;&#25214;&#19981;&#21040;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"title highlight"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39034;&#24207;&#19968;&#33268;&#65292;&#25214;&#21040;&#12290;&#23601;&#26159;&#23383;&#31526;&#20018;&#23436;&#20840;&#21305;&#37197;</span>
</pre>
</div></li>

<li><p>
<b>attrs参数</b>
</p>

<ul class="org-ul">
<li>attrs接收一个字典，字典的key为属性名，value可以是字符串、正则表达式对象、True、列表。可以多个属性</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"class"</span>:<span style="color: #8b2252;">"title"</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"class"</span>:<span style="color: #8b2252;">"highlight"</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"class"</span>:<span style="color: #8b2252;">"title highlight"</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #008b8b;">True</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"id"</span>:re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"\d$"</span>)}))
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.name,soup.find_all(attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #008b8b;">True</span>,<span style="color: #8b2252;">"src"</span>:<span style="color: #008b8b;">True</span>}))))
</pre>
</div></li>

<li><p>
<b>text参数</b>
</p>

<ul class="org-ul">
<li>可以通过text参数搜索文档中的字符串内容，接受字符串、正则表达式对象、True、列表</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:(<span style="color: #483d8b;">type</span>(x),x),soup.find_all(text=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"\w+"</span>))))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;&#31867;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:(<span style="color: #483d8b;">type</span>(x),x),soup.find_all(text=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"[a-z]+"</span>)))))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(soup.find_all(re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"^(h|p)"</span>),text=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"[a-z]+"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#36807;&#28388;Tag&#23545;&#35937;&#65292;&#24182;&#30475;&#23427;&#30340;string&#26159;&#21542;&#31526;&#21512;text&#21442;&#25968;&#35201;&#27714;&#65292;&#36820;&#22238;Tag&#23545;&#35937;</span>
</pre>
</div>

<p>
<img src="../../../img/python/bsoup_011.jpg" alt="bsoup_011.jpg"><br>
</p></li>

<li><p>
*limit参数*：显示返回结果的数量
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>,limit=3)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#21015;&#34920;&#20013;&#26377;3&#20010;&#32467;&#26524;</span>
</pre>
</div></li>

<li><b>recursive参数</b>

<ul class="org-ul">
<li>默认是递归搜索所有子孙节点，如果不需要请设置为False</li>
</ul></li>

<li><p>
<b>简化写法</b>
</p>
<ol class="org-ol">
<li>find_all()是非常常用的方法，可以简化省略掉</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"img"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;img&#26631;&#31614;&#23545;&#35937;&#30340;&#21015;&#34920;&#65292;&#31561;&#20215;&#20110;soup.find_all("img")</span>
    <span style="color: #483d8b;">print</span>(soup.img) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28145;&#24230;&#20248;&#20808;&#31532;&#19968;&#20010;img</span>

    <span style="color: #483d8b;">print</span>(soup.a.find_all(text=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;</span>
    <span style="color: #483d8b;">print</span>(soup.a(text=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;&#65292;&#21644;&#19978;&#38754;&#31561;&#20215;</span>
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"a"</span>,text=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;a&#26631;&#31614;&#23545;&#35937;</span>

    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>}))
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>})) <span style="color: #b22222;">#</span><span style="color: #b22222;">find_all&#30340;&#30465;&#30053;</span>
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"1"</span>)}))
</pre>
</div>


<figure id="orgc6877f7">
<img src="../../../img/python/bsoup_012.jpg" alt="bsoup_012.jpg">

<figcaption><span class="figure-number">Figure 18: </span>bsoup_012</figcaption>
</figure></li>

<li><p>
<b>find方法</b>
</p>
<ol class="org-ol">
<li><code>find(name,attrs,recursive,text,**kwargs)</code>
<ul class="org-ul">
<li>参数几乎和find_all一样。</li>
<li>找到了，find_all返回一个列表，而find返回一个单值，元素对象。</li>
<li>找不到，find_all返回一个空列表，而find返回一个None。</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.find(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>}).attrs.get(<span style="color: #8b2252;">"src"</span>,<span style="color: #8b2252;">"xdd"</span>))
    <span style="color: #483d8b;">print</span>(soup.find(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>}).get(<span style="color: #8b2252;">"src"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31616;&#21270;&#20102;attrs</span>
    <span style="color: #483d8b;">print</span>(soup.find(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>})[<span style="color: #8b2252;">"src"</span>])
</pre>
</div>


<figure id="org4e69e8d">
<img src="../../../img/python/bsoup_013.jpg" alt="bsoup_013.jpg">

<figcaption><span class="figure-number">Figure 19: </span>bsoup_013</figcaption>
</figure></li>
</ul>
</div>
</div>
<div id="outline-container-h:c31da1db-44a4-45bd-aa8d-551568b8e4a9" class="outline-4">
<h4 id="h:c31da1db-44a4-45bd-aa8d-551568b8e4a9">CSS选择器</h4>
<div class="outline-text-4" id="text-h:c31da1db-44a4-45bd-aa8d-551568b8e4a9">
<ul class="org-ul">
<li>和JQuery一样，可以使用CSS选择器来 查找节点</li>
<li>使用soup.select()方法，select方法支持大部分CSS选择器，返回列表。</li>
<li>CSS中，标签名直接使用，类名前加=.=点号,id名前加=#=井号。</li>

<li>BeautifulSoup.select("css选择器")</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20803;&#32032;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(1,soup.select(<span style="color: #8b2252;">"p"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#30340;p&#26631;&#31614;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(2,soup.select(<span style="color: #8b2252;">".title"</span>))

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#20102;&#20266;&#31867;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#23376;&#26631;&#31614;&#26159;p&#30340;&#21516;&#31867;&#22411;&#30340;&#25152;&#26377;p&#26631;&#31614;&#20013;&#30340;&#31532;&#20108;&#20010;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">(&#21516;&#31867;&#22411;)&#21516;&#26631;&#31614;&#21517;p&#30340;&#31532;2&#20010;&#65292;&#20266;&#31867;&#21482;&#23454;&#29616;&#20102;nth-of-type&#65292;&#19988;&#35201;&#27714;&#26159;&#25968;&#23383;</span>
    <span style="color: #483d8b;">print</span>(3,soup.select(<span style="color: #8b2252;">"div.content &gt;p:nth-of-type(2)"</span>))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">id&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(4,soup.select(<span style="color: #8b2252;">"p#second"</span>))
    <span style="color: #483d8b;">print</span>(5,soup.select(<span style="color: #8b2252;">"#bg1"</span>))

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#20195;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(6,soup.select(<span style="color: #8b2252;">"div p"</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">div&#19979;&#36880;&#23618;&#25214;p</span>
    <span style="color: #483d8b;">print</span>(7,soup.select(<span style="color: #8b2252;">"div div p"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">div&#19979;&#36880;&#23618;&#25214;div&#19979;&#36880;&#23618;&#25214;p</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23376;&#36873;&#25321;&#22120;&#65292;&#30452;&#25509;&#21518;&#20195;</span>
    <span style="color: #483d8b;">print</span>(8,soup.select(<span style="color: #8b2252;">"div &gt; p"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">div&#19979;&#30452;&#25509;&#23376;&#26631;&#31614;&#30340;p&#65292;&#26377;2&#20010;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#37051;&#20804;&#24351;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div p:nth-of-type(1) + [src]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;[]</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div p:nth-of-type(1) + p"</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;p&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div &gt; p:nth-of-type(2) + input"</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;input Tag</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div &gt; p:nth-of-type(2) + [type]"</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#19978;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26222;&#36890;&#20804;&#24351;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(10, soup.select(<span style="color: #8b2252;">"div p:nth-of-type(1) ~ [src]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;2&#20010;img</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23646;&#24615;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(11,soup.select(<span style="color: #8b2252;">"[src]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#23646;&#24615;src</span>
    <span style="color: #483d8b;">print</span>(12,soup.select(<span style="color: #8b2252;">"[src='/']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23646;&#24615;src&#31561;&#20110;/</span>
    <span style="color: #483d8b;">print</span>(13,soup.select(<span style="color: #8b2252;">"[src='http://www.xdd.com/']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#21305;&#37197;</span>
    <span style="color: #483d8b;">print</span>(14,soup.select(<span style="color: #8b2252;">"[src^='http://www']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;http://www&#24320;&#22836;</span>
    <span style="color: #483d8b;">print</span>(15,soup.select(<span style="color: #8b2252;">"[src$='com/']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;com/&#32467;&#23614;</span>
    <span style="color: #483d8b;">print</span>(16,soup.select(<span style="color: #8b2252;">"img[src*='xdd']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;xdd</span>
    <span style="color: #483d8b;">print</span>(17,soup.select(<span style="color: #8b2252;">"img[src*='.com']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;.com</span>
    <span style="color: #483d8b;">print</span>(18,soup.select(<span style="color: #8b2252;">"[class='title highlight']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#21305;&#37197;calss&#31561;&#20110;'title highlight'</span>
    <span style="color: #483d8b;">print</span>(19,soup.select(<span style="color: #8b2252;">"[class~=title]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20540;&#23646;&#24615;&#20013;&#26377;&#19968;&#20010;title</span>
</pre>
</div>


<figure id="org2575607">
<img src="../../../img/python/bsoup_014.jpg" alt="bsoup_014.jpg">

<figcaption><span class="figure-number">Figure 20: </span>bsoup_014</figcaption>
</figure>

<ul class="org-ul">
<li><b>获取文本内容</b></li>

<li>搜索节点的目的往往是为了提取该节点的文本内容，一般不需要HTML标记，只需要文字</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"d://xdd.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20803;&#32032;&#36873;&#25321;&#22120;</span>
    <span style="color: #a0522d;">ele</span> = soup.select(<span style="color: #8b2252;">"div"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#30340;div&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(ele))
    <span style="color: #483d8b;">print</span>(ele[0].string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23481;&#20165;&#20165;&#21482;&#33021;&#26159;&#25991;&#26412;&#31867;&#22411;&#65292;&#21542;&#21017;&#36820;&#22238;None</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].strings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].stripped_strings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#19981;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;</span>

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(ele[0])
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span> * 30)

    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].text))<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#36136;&#19978;&#23601;&#26159;get_text(),&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;&#30340;strings</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].get_text())) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#24182;join&#65292;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;&#65292;strip&#40664;&#35748;&#20026;False</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].get_text(strip=<span style="color: #008b8b;">True</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#24182;join&#65292;&#19981;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;</span>
</pre>
</div>


<figure id="orgf44d119">
<img src="../../../img/python/bsoup_015.jpg" alt="bsoup_015.jpg">

<figcaption><span class="figure-number">Figure 21: </span>bsoup_015</figcaption>
</figure>

<ul class="org-ul">
<li>bs4.element.Tag#string源码</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Tag</span>(PageElement):
@<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">string</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(<span style="color: #a020f0;">self</span>.contents) != 1:
            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">None</span>
        <span style="color: #a0522d;">child</span> = <span style="color: #a020f0;">self</span>.contents[0]
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(child, NavigableString):
            <span style="color: #a020f0;">return</span> child
        <span style="color: #a020f0;">return</span> child.string

    <span style="color: #228b22;">@string.setter</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">string</span>(<span style="color: #a020f0;">self</span>, string):
        <span style="color: #a020f0;">self</span>.clear()
        <span style="color: #a020f0;">self</span>.append(string.__class__(string))

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_all_strings</span>(<span style="color: #a020f0;">self</span>, strip=<span style="color: #008b8b;">False</span>, types=(NavigableString, CData)):
        <span style="color: #a020f0;">for</span> descendant <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>.descendants:
            <span style="color: #a020f0;">if</span> (
                (types <span style="color: #a020f0;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">isinstance</span>(descendant, NavigableString))
                <span style="color: #a020f0;">or</span>
                (types <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span> <span style="color: #a020f0;">and</span> <span style="color: #483d8b;">type</span>(descendant) <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> types)):
                <span style="color: #a020f0;">continue</span>
            <span style="color: #a020f0;">if</span> strip:
                <span style="color: #a0522d;">descendant</span> = descendant.strip()
                <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(descendant) == 0:
                    <span style="color: #a020f0;">continue</span>
            <span style="color: #a020f0;">yield</span> descendant

    <span style="color: #a0522d;">strings</span> = <span style="color: #483d8b;">property</span>(_all_strings)

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">stripped_strings</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">for</span> string <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>._all_strings(<span style="color: #008b8b;">True</span>):
            <span style="color: #a020f0;">yield</span> string

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_text</span>(<span style="color: #a020f0;">self</span>, separator=<span style="color: #8b2252;">""</span>, strip=<span style="color: #008b8b;">False</span>,
                 types=(NavigableString, CData)):
        <span style="color: #a020f0;">return</span> separator.join([s <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>._all_strings(
                    strip, types=types)])
    <span style="color: #a0522d;">getText</span> = get_text
    <span style="color: #a0522d;">text</span> = <span style="color: #483d8b;">property</span>(get_text)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0" class="outline-3">
<h3 id="h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0">Json解析</h3>
<div class="outline-text-3" id="text-h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0">
<ul class="org-ul">
<li>拿到一个Json字符串，如果想提取其中的部分内容，就需要遍历了。在遍历过程中进行判断。</li>
<li>还有一种方式，类似于XPath,叫做jsonPath。</li>
<li>安装=pip install jsonpath=</li>
<li>官网<a href="https://goessner.net/articles/JsonPath/">https://goessner.net/articles/JsonPath/</a></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">XPath</th>
<th scope="col" class="org-left">JsonPath</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/</code></td>
<td class="org-left"><code>$</code></td>
<td class="org-left">根元素</td>
</tr>

<tr>
<td class="org-left"><code>.</code></td>
<td class="org-left"><code>@</code></td>
<td class="org-left">当前节点</td>
</tr>

<tr>
<td class="org-left"><code>/</code></td>
<td class="org-left"><code>.=或者</code>[]=</td>
<td class="org-left">获取子节点</td>
</tr>

<tr>
<td class="org-left"><code>..</code></td>
<td class="org-left">不支持</td>
<td class="org-left">父节点</td>
</tr>

<tr>
<td class="org-left"><code>//</code></td>
<td class="org-left"><code>..</code></td>
<td class="org-left">任意层次</td>
</tr>

<tr>
<td class="org-left"><code>*</code></td>
<td class="org-left"><code>*</code></td>
<td class="org-left">通配符，匹配任意节点</td>
</tr>

<tr>
<td class="org-left"><code>@</code></td>
<td class="org-left">不支持</td>
<td class="org-left">json中没有属性</td>
</tr>

<tr>
<td class="org-left"><code>[]</code></td>
<td class="org-left"><code>[]</code></td>
<td class="org-left">下标操作</td>
</tr>

<tr>
<td class="org-left">=</td>
<td class="org-left">=</td>
<td class="org-left"><code>[,]</code></td>
<td class="org-left">XPath是或操作，JSONPath allows alternate names or array indices as a set.</td>
</tr>

<tr>
<td class="org-left">不支持</td>
<td class="org-left"><code>[start:stop:step]</code></td>
<td class="org-left">切片</td>
</tr>

<tr>
<td class="org-left"><code>[]</code></td>
<td class="org-left"><code>?()</code></td>
<td class="org-left">过滤操作</td>
</tr>

<tr>
<td class="org-left">不支持</td>
<td class="org-left"><code>()</code></td>
<td class="org-left">表达式计算</td>
</tr>

<tr>
<td class="org-left"><code>()</code></td>
<td class="org-left">不支持</td>
<td class="org-left">分组</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>综合示例，使用豆瓣电影的热门电影的Json<a href="https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0">https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-json">{
    "subjects":[
        {
            "rate":"8.8",
            "cover_x":1500,
            "title":"寄生虫",
            "url":"https://movie.douban.com/subject/27010768/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2561439800.jpg",
            "id":"27010768",
            "cover_y":2138,
            "is_new":false
        },
        {
            "rate":"7.7",
            "cover_x":1500,
            "title":"恶人传",
            "url":"https://movie.douban.com/subject/30211551/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2555084871.jpg",
            "id":"30211551",
            "cover_y":2145,
            "is_new":false
        },
        {
            "rate":"6.6",
            "cover_x":1500,
            "title":"异地母子情",
            "url":"https://movie.douban.com/subject/26261189/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2562107493.jpg",
            "id":"26261189",
            "cover_y":2222,
            "is_new":true
        },
        {
            "rate":"6.7",
            "cover_x":2025,
            "title":"我的生命之光",
            "url":"https://movie.douban.com/subject/26962841/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2563625370.jpg",
            "id":"26962841",
            "cover_y":3000,
            "is_new":true
        },
        {
            "rate":"7.3",
            "cover_x":2025,
            "title":"皮肤",
            "url":"https://movie.douban.com/subject/27041467/",
            "playable":false,
            "cover":"https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2559479239.jpg",
            "id":"27041467",
            "cover_y":3000,
            "is_new":true
        },
        {
            "rate":"8.9",
            "cover_x":2000,
            "title":"绿皮书",
            "url":"https://movie.douban.com/subject/27060077/",
            "playable":true,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2549177902.jpg",
            "id":"27060077",
            "cover_y":3167,
            "is_new":false
        },
        {
            "rate":"8.0",
            "cover_x":3600,
            "title":"疾速备战",
            "url":"https://movie.douban.com/subject/26909790/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2551393832.jpg",
            "id":"26909790",
            "cover_y":5550,
            "is_new":false
        },
        {
            "rate":"7.9",
            "cover_x":1786,
            "title":"流浪地球",
            "url":"https://movie.douban.com/subject/26266893/",
            "playable":true,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2545472803.jpg",
            "id":"26266893",
            "cover_y":2500,
            "is_new":false
        },
        {
            "rate":"8.2",
            "cover_x":684,
            "title":"沦落人",
            "url":"https://movie.douban.com/subject/30140231/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2555952192.jpg",
            "id":"30140231",
            "cover_y":960,
            "is_new":false
        },
        {
            "rate":"6.4",
            "cover_x":960,
            "title":"疯狂的外星人",
            "url":"https://movie.douban.com/subject/25986662/",
            "playable":true,
            "cover":"https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2541901817.jpg",
            "id":"25986662",
            "cover_y":1359,
            "is_new":false
        }
    ]
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> jsonpath <span style="color: #a020f0;">import</span> jsonpath
<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">import</span> json

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0"</span>

<span style="color: #a020f0;">with</span> requests.get(url,headers={<span style="color: #8b2252;">"User-agent"</span>:ua}) <span style="color: #a020f0;">as</span> response:
    <span style="color: #a020f0;">if</span> response.status_code==200:
        <span style="color: #a0522d;">text</span> = response.text
        <span style="color: #483d8b;">print</span>(text[:100])
        <span style="color: #a0522d;">js</span> = json.loads(text)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">str</span>(js)[:100]) <span style="color: #b22222;">#</span><span style="color: #b22222;">json&#36716;&#25442;&#20026;Python&#25968;&#25454;&#32467;&#26500;</span>

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30693;&#36947;&#25152;&#26377;&#30005;&#24433;&#30340;&#21517;&#31216;</span>
        <span style="color: #a0522d;">rs1</span> = jsonpath(js,<span style="color: #8b2252;">"$..title"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26681;&#30446;&#24405;&#24320;&#22987;&#65292;&#20219;&#24847;&#23618;&#27425;&#30340;title&#23646;&#24615;</span>
        <span style="color: #483d8b;">print</span>(rs1)

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#21040;&#25152;&#26377;subjects</span>
        <span style="color: #a0522d;">rs2</span> = jsonpath(js,<span style="color: #8b2252;">"$..subjects"</span>)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">len</span>(rs2),<span style="color: #483d8b;">str</span>(rs2[0])[:100]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30001;&#20110;&#22826;&#38271;&#65292;&#21462;&#21069;100&#20010;&#23383;&#31526;</span>

        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span> * 30)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040;&#25152;&#26377;&#24471;&#20998;&#39640;&#20110;8&#20998;&#30340;&#30005;&#24433;&#21517;&#31216;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#19979;&#20219;&#24847;&#23618;&#30340;subjects&#30340;&#23376;&#33410;&#28857;rate&#22823;&#20110;&#23383;&#31526;&#20018;8</span>
        <span style="color: #a0522d;">rs3</span> = jsonpath(js,<span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")]'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#65311;()&#26159;&#36807;&#28388;&#22120;</span>
        <span style="color: #483d8b;">print</span>(rs3)

        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#19979;&#20219;&#24847;&#23618;&#30340;subjects&#30340;&#23376;&#33410;&#28857;rate&#22823;&#20110;&#23383;&#31526;&#20018;8&#30340;&#33410;&#28857;&#30340;&#23376;&#33410;&#28857;title</span>
        <span style="color: #a0522d;">rs4</span> = jsonpath(js,<span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")].title'</span>)
        <span style="color: #483d8b;">print</span>(rs4)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span> * 30)

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#29255;</span>
        <span style="color: #a0522d;">rs5</span> = jsonpath(js,<span style="color: #8b2252;">"$..subjects[?(@.rate &gt; '6')].title"</span>)
        <span style="color: #483d8b;">print</span>(rs5[:2])
</pre>
</div>


<figure id="orgdfb64a9">
<img src="../../../img/python/bsoup_016.jpg" alt="bsoup_016.jpg">

<figcaption><span class="figure-number">Figure 22: </span>bsoup_016</figcaption>
</figure>
</div>
</div>
</section>
<section id="outline-container-h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f" class="outline-2">
<h2 id="h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f">RabbitMQ</h2>
<div class="outline-text-2" id="text-h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f">
<p>
[toc]
</p>

<ul class="org-ul">
<li>RabbitMQ是由LShift提供的一个Advanced Message Queuing
Protocol(AMQP)的开源实现，由以高性能、健壮以及可伸缩性出名的Erlang写成，因此也是继承了这些优点。</li>
</ul>
</div>
<div id="outline-container-h:f899334f-3118-41be-80e6-e8625d7b0dae" class="outline-3">
<h3 id="h:f899334f-3118-41be-80e6-e8625d7b0dae">安装</h3>
<div class="outline-text-3" id="text-h:f899334f-3118-41be-80e6-e8625d7b0dae">
<ul class="org-ul">
<li>选择RPM包下载，选择对应平台，本次安装在CentOS7，其他平台类似。<a href="https://www.rabbitmq.com/install-rpm.html">https://www.rabbitmq.com/install-rpm.html</a><br></li>

<li>由于使用了erlang语言开发，所以需要erlang的包。erlang和RabbitMQ的兼容性，参考<a href="https://www.rabbitmq.com/which-erlang.html#compatibility-matrix">https://www.rabbitmq.com/which-erlang.html#compatibility-matrix</a></li>

<li>第二种错误，可以修改host文件，修改主机名即可</li>

<li>下载
rabbitmq-server-3.7.16-1.el7.noarch.rpm、erlang-21.3.8.6-1.el7.x86_64.rpm。socat在CentOS中源中有。</li>
</ul>

<blockquote>
<p>
yum -y install erlang-21.3.8.6-1.el7.x86_64.rpm
rabbitmq-server-3.7.16-1.el7.noarch.rpm
</p>
</blockquote>

<ul class="org-ul">
<li>查看安装的文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">[root@xdd ~]# rpm -ql rabbitmq-server 
/etc/logrotate.d/rabbitmq-server
/etc/profile.d/rabbitmqctl-autocomplete.sh
/etc/rabbitmq
/usr/lib/ocf/resource.d/rabbitmq/rabbitmq-server
/usr/lib/ocf/resource.d/rabbitmq/rabbitmq-server-ha
/usr/lib/rabbitmq/autocomplete/bash_autocomplete.sh
/usr/lib/rabbitmq/autocomplete/zsh_autocomplete.sh
/usr/lib/rabbitmq/bin/cuttlefish
/usr/lib/rabbitmq/bin/rabbitmq-defaults
</pre>
</div>
</div>
</div>
<div id="outline-container-h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc" class="outline-3">
<h3 id="h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc">配置</h3>
<div class="outline-text-3" id="text-h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc">
<ul class="org-ul">
<li>参考资料<a href="https://www.rabbitmq.com/configure.html#config-location">https://www.rabbitmq.com/configure.html#config-location</a></li>
</ul>
</div>
<div id="outline-container-h:836f844f-b135-4993-837c-10a2d1bff7ff" class="outline-4">
<h4 id="h:836f844f-b135-4993-837c-10a2d1bff7ff">环境配置</h4>
<div class="outline-text-4" id="text-h:836f844f-b135-4993-837c-10a2d1bff7ff">
<ul class="org-ul">
<li>使用系统环境变量，如果没有使用rabbitmq-env.conf中定义环境变量，否则使用缺省值</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">RABBITMQ_NODE_IP_ADDRESS the empty string, meaning that it should bind to all network interfaces.  
RABBITMQ_NODE_PORT 5672  
RABBITMQ_DIST_PORT RABBITMQ_NODE_PORT + 20000  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#33410;&#28857;&#21644;&#23458;&#25143;&#31471;&#24037;&#20855;&#36890;&#20449;&#29992;  </span>
RABBITMQ_CONFIG_FILE &#37197;&#32622;&#25991;&#20214;&#36335;&#24452;&#40664;&#35748;&#20026;/etc/rabbitmq/rabbitmq  
</pre>
</div>

<p>
环境变量文件，可以不配置
</p>
</div>
</div>
<div id="outline-container-h:63d147a7-aede-4e74-826b-e7cfc32eaaf5" class="outline-4">
<h4 id="h:63d147a7-aede-4e74-826b-e7cfc32eaaf5">工作特性配置文件</h4>
<div class="outline-text-4" id="text-h:63d147a7-aede-4e74-826b-e7cfc32eaaf5">
<ul class="org-ul">
<li>rabbitmq.config配置文件</li>
<li>3.7支持新旧两种配置文件格式</li>

<li><p>
erlang配置文件格式，为了兼容继续采用
</p>


<figure id="orgd483bef">
<img src="../../../img/python/rabbitmq_001.png" alt="rabbitmq_001.png">

<figcaption><span class="figure-number">Figure 23: </span>rabbitmq_001</figcaption>
</figure></li>

<li>sysctl格式，如果不需要兼容，RabbitMQ鼓励使用。 (这个文件也可以不配置)
<img src="../../../img/python/rabbitmq_002.png" alt="rabbitmq_002.png"></li>
</ul>
</div>
</div>
<div id="outline-container-h:96ef7d6b-d211-4d63-81c1-381babafd986" class="outline-4">
<h4 id="h:96ef7d6b-d211-4d63-81c1-381babafd986">插件管理</h4>
<div class="outline-text-4" id="text-h:96ef7d6b-d211-4d63-81c1-381babafd986">
<p>
列出所有可用插件
</p>

<blockquote>
<p>
rabbitmq-plugins list
</p>
</blockquote>

<ul class="org-ul">
<li>启动WEB管理插件，会依赖启用其他几个插件。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">[root@xdd rabbitmq]$ rabbitmq-plugins enable rabbitmq_management
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e531ee22-998b-4f99-aab2-7ac5ad53508e" class="outline-4">
<h4 id="h:e531ee22-998b-4f99-aab2-7ac5ad53508e">启动服务</h4>
<div class="outline-text-4" id="text-h:e531ee22-998b-4f99-aab2-7ac5ad53508e">
<blockquote>
<p>
systemctl start rabbitmq-server
</p>
</blockquote>

<ul class="org-ul">
<li>启动中，可能出现下面的错误
<ol class="org-ol">
<li><code>Error when reading /var/lib/rabbitmq/.erlang.cookie:eacces=这就是这个文件的权限问题，修改属组、属组为rabbitmq即可
     =chown rabbitmq.rabbitmq /var/lib/rabbitmq/.erlang.cookie</code></li>
</ol></li>
<li>服务启动成功</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">[root@xdd ~]# ss -tanl | grep 5672
LISTEN     0      128          *:25672                    *:*
LISTEN     0      128          *:15672                    *:*
LISTEN     0      128         :::5672                    :::*
[root@xdd ~]#
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7881dc05-67bb-469e-9577-c9ad18bc3b95" class="outline-4">
<h4 id="h:7881dc05-67bb-469e-9577-c9ad18bc3b95">用户管理</h4>
<div class="outline-text-4" id="text-h:7881dc05-67bb-469e-9577-c9ad18bc3b95">
<ul class="org-ul">
<li>开始登陆WEB界面,=<a href="http://192.168.61.108(rabbitmq所在主机的ip):15672">http://192.168.61.108(rabbitmq所在主机的ip):15672</a>=<br>
<img src="../../../img/python/rabbitmq_003.png" alt="rabbitmq_003.png"></li>
<li>使用guest/guest只能本地登陆，远程登录会报错</li>

<li>rabbitmqctl命令
<ul class="org-ul">
<li><code>rabbitmqctl [-n &lt;node&gt;] [-1][-q] &lt;command&gt; [&lt;command options&gt;]</code></li>
<li>General options:
<ol class="org-ol">
<li><code>-n</code> node</li>
<li><code>-q</code>,&#x2013;quiet</li>
<li><code>-t</code>,&#x2013;timeout timeout</li>
<li><code>-l</code> longnames</li>
</ol></li>
<li>Commands:
<ol class="org-ol">
<li><code>add_user &lt;username&gt; &lt;password&gt;</code> 添加用户</li>
<li><code>list_user</code> 列出用户</li>
<li><code>delete_user username</code> 删除用户</li>
<li><code>change_password &lt;username&gt; &lt;password&gt;</code> 修改用户名，密码</li>
<li><code>set_user_tags &lt;username&gt; &lt;tag&gt; [...]</code> 设置用户tag</li>
<li>list_user_permissions 列出用户权限</li>
</ol></li>
</ul></li>

<li>添加用户：=rabbitmqctl add_user username password=<br></li>

<li>删除用户：=rabbitmqctl delete_user username=</li>

<li>更改密码：=rabbitmqctl change_password username newpassword=</li>

<li>设置权限Tags，其实就是分配组：=rabbitmqctl set_user_tags username tag=</li>

<li>设置xdd用户为管理员tag后登陆</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">rabbitmqctl add_user gdy gdy  #&#28155;&#21152;xdd&#29992;&#25143;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">rabbitmqctl list_users #&#26597;&#30475;&#25152;&#26377;&#29992;&#25143;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">rabbitmqctl set_user_tags gdy administrator #&#35774;&#32622;xdd&#29992;&#25143;&#20026;&#31649;&#29702;&#21592;&#29992;&#25143;</span>
</pre>
</div>

<ul class="org-ul">
<li>tag的意义如下：
<ol class="org-ol">
<li>administrator可以管理用户、权限、虚拟主机。
<img src="../../../img/python/rabbitmq_004.png" alt="rabbitmq_004.png"></li>
</ol></li>
<li>基本信息(web管理端口15672，协议端口5672)
<img src="../../../img/python/rabbitmq_005.png" alt="rabbitmq_005.png"><br></li>
<li>虚拟主机
<ol class="org-ol">
<li>缺省虚拟主机，默认只能是guest用户在本机链接，下图新建的用户gdy默认无法访问任何虚拟主机
<img src="../../../img/python/rabbitmq_006.png" alt="rabbitmq_006.png"></li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995" class="outline-3">
<h3 id="h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995">Pika库</h3>
<div class="outline-text-3" id="text-h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995">
<ul class="org-ul">
<li>Pika是纯Python实现的支持AMQP协议的库
<ol class="org-ol">
<li><code>pip install pika</code></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:e4d7a939-b004-45e1-bbec-7ba99ca86d67" class="outline-3">
<h3 id="h:e4d7a939-b004-45e1-bbec-7ba99ca86d67">RabbitMQ工作原理及应用</h3>
<div class="outline-text-3" id="text-h:e4d7a939-b004-45e1-bbec-7ba99ca86d67">
</div>
<div id="outline-container-h:f9cb405c-487c-4a23-938b-7ae7f21eea58" class="outline-4">
<h4 id="h:f9cb405c-487c-4a23-938b-7ae7f21eea58">工作模式</h4>
<div class="outline-text-4" id="text-h:f9cb405c-487c-4a23-938b-7ae7f21eea58">
<ul class="org-ul">
<li>参考官网<a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></li>
</ul>


<figure id="orgf4484bd">
<img src="../../../img/python/rabbitmq_007.png" alt="rabbitmq_007.png">

<figcaption><span class="figure-number">Figure 24: </span>rabbitmq_007</figcaption>
</figure>


<figure id="orgf73447d">
<img src="../../../img/python/rabbitmq_008.png" alt="rabbitmq_008.png">

<figcaption><span class="figure-number">Figure 25: </span>rabbitmq_008</figcaption>
</figure>

<ul class="org-ul">
<li><b>名词解释</b></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名词</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Server</td>
<td class="org-left">服务器接受客户端连接，实现消息队列及路由功能的进程(服务),也称为消息代理注意：客户端可用生产者，也可以是消费者，它们都需要连接到Server</td>
</tr>

<tr>
<td class="org-left">Connection</td>
<td class="org-left">网络物理连接</td>
</tr>

<tr>
<td class="org-left">Channel</td>
<td class="org-left">一个连接允许多个客户端连接</td>
</tr>

<tr>
<td class="org-left">Exchange</td>
<td class="org-left">交换器。接收生产者发来的消息，决定如何*路由*给服务器中的队列。常用的类型有：direct(point-to-point)topic(publish-subscribe)fanout(multicast)</td>
</tr>

<tr>
<td class="org-left">Message</td>
<td class="org-left">消息</td>
</tr>

<tr>
<td class="org-left">Message Queue</td>
<td class="org-left">消息队列，数据的存储载体</td>
</tr>

<tr>
<td class="org-left">Bind</td>
<td class="org-left">绑定建立消息队列和交换器之间的关系，也就是说交换器拿到数据，把什么样的数据送给哪个队列</td>
</tr>

<tr>
<td class="org-left">Virtual Host</td>
<td class="org-left">虚拟主机一批交换器、消息队列和相关对象的集合。为了多用户互不干扰，使用虚拟主机分组交换机，消息队列</td>
</tr>

<tr>
<td class="org-left">Topic</td>
<td class="org-left">主题、话题</td>
</tr>

<tr>
<td class="org-left">Broker</td>
<td class="org-left">可等价为Server</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-h:4900c67f-edda-4470-99d2-ca179d94a7da" class="outline-5">
<h5 id="h:4900c67f-edda-4470-99d2-ca179d94a7da">1.队列</h5>
<div class="outline-text-5" id="text-h:4900c67f-edda-4470-99d2-ca179d94a7da">
<ul class="org-ul">
<li>这种模式就是最简单的生产者消费者模型，消息队列就是一个FIFO的队列<br>
<img src="../../../img/python/rabbitmq_009.png" alt="rabbitmq_009.png"><br></li>
<li>生产者send.py,消费者receie.py<br></li>
<li>官方例子：<a href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">https://www.rabbitmq.com/tutorials/tutorial-one-python.html</a></li>

<li>注意：出现如下运行结果</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">pika.exceptions.ProbableAuthenticationError: (403, 'ACCESS_REFUSED - Login was refused using authentication mechanism PLAIN. For details see the broker logﬁle.')
</pre>
</div>

<ul class="org-ul">
<li>访问被拒绝，还是权限问题，原因还是guest用户只能访问localhost上的缺省虚拟主机</li>
<li><b>解决办法</b>
<ol class="org-ol">
<li>缺省虚拟主机，默认只能在本机访问，不要修改为远程访问，是安全的考虑。</li>
<li>因此，在Admin中Virtual hosts中，新建一个虚拟主机test。</li>
<li>注意：新建的test虚拟主机的Users是谁，本次是gdy用户</li>
</ol></li>
</ul>


<figure id="orgc18cf85">
<img src="../../../img/python/rabbitmq_010.jpg" alt="rabbitmq_010.jpg">

<figcaption><span class="figure-number">Figure 26: </span>rabbitmq_010</figcaption>
</figure>

<ul class="org-ul">
<li>在ConnectionParameters中没有用户名、密码填写的参数，它使用参数credentials传入，这个需要构建一个pika.credentials.Credentials对象。</li>

<li>参照官方例子，写一个小程序</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#29992;&#25143;&#21517;&#23494;&#30721;&#23545;&#35937;</span>
<span style="color: #a0522d;">credential</span> = pika.PlainCredentials(<span style="color: #8b2252;">"gdy"</span>,<span style="color: #8b2252;">"gdy"</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#38142;&#25509;&#21442;&#25968;</span>
<span style="color: #a0522d;">params</span> = pika.ConnectionParameters(
    <span style="color: #8b2252;">"192.168.61.108"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">ip&#22320;&#22336;</span>
    5672,  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31471;&#21475;</span>
    <span style="color: #8b2252;">"test"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#26426;</span>
    credential <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#21517;&#23494;&#30721;</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;"># &#31532;&#20108;&#31181;&#24314;&#31435;&#36830;&#25509;&#26041;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">params = pika.URLParameters("amqp://gdy:gdy@192.168.61.108:5672/test")</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#38431;&#21015;&#65292;queue&#21629;&#21517;&#20026;hello&#65292;&#22914;&#26524;queue&#19981;&#23384;&#22312;&#65292;&#28040;&#24687;&#23558;&#34987;dropped</span>
    channel.queue_declare(queue=<span style="color: #8b2252;">"hello"</span>)

    channel.basic_publish(
        exchange=<span style="color: #8b2252;">""</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#32570;&#30465;exchange</span>
        routing_key=<span style="color: #8b2252;">"hello"</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">routing_key&#24517;&#39035;&#25351;&#23450;&#65292;&#36825;&#37324;&#35201;&#27714;&#21644;&#30446;&#26631;queue&#19968;&#33268;</span>
        body=<span style="color: #8b2252;">"Hello world"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
    )
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;Sent Message OK"</span>)
</pre>
</div>

<ul class="org-ul">
<li>测试通过。去服务管理界面查看Exchanges和Queues。<br>
<img src="../../../img/python/rabbitmq_011.jpg" alt="rabbitmq_011.jpg"></li>

<li>URLParameters，也可以使用URL创建参数</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">amqp://username:password@host:port/&lt;virtual_host&gt;[?query-string] </span>
<span style="color: #a0522d;">parameters</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://guest:guest@rabbit-server1:5672/%2F'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">%2F&#25351;&#20195;/&#65292;&#23601;&#26159;&#32570;&#30465;&#34394;&#25311;&#20027;&#26426;</span>
</pre>
</div>

<ol class="org-ol">
<li>queue_declare声明一个queue，有必要可以创建。</li>
<li>basic_publish
exchange为空就使用缺省exchange,如果找不到指定的exchange,抛异</li>

<li>使用缺省exchange,就必须指定routing_key，使用它找到queue</li>
<li>修改上面生产者代码，让生产者连续发送send
Message。在web端查看Queues中Ready的变化</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#31181;&#24314;&#31435;&#36830;&#25509;&#26041;&#24335;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#38431;&#21015;&#65292;queue&#21629;&#21517;&#20026;hello&#65292;&#22914;&#26524;queue&#19981;&#23384;&#22312;&#65292;&#28040;&#24687;&#23558;&#34987;dropped</span>
    channel.queue_declare(queue=<span style="color: #8b2252;">"hello"</span>)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):

        channel.basic_publish(
            exchange=<span style="color: #8b2252;">""</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#32570;&#30465;exchange</span>
            routing_key=<span style="color: #8b2252;">"hello"</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">routing_key&#24517;&#39035;&#25351;&#23450;&#65292;&#36825;&#37324;&#35201;&#27714;&#21644;&#30446;&#26631;queue&#19968;&#33268;</span>
            body=<span style="color: #8b2252;">"data{:02}"</span>.<span style="color: #483d8b;">format</span>(i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
        )
        time.sleep(0.5)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;Sent Message OK"</span>)
</pre>
</div>


<figure id="org60bc55f">
<img src="../../../img/python/rabbitmq_012.jpg" alt="rabbitmq_012.jpg">

<figcaption><span class="figure-number">Figure 27: </span>rabbitmq_012</figcaption>
</figure>

<ul class="org-ul">
<li><b>构建receive.py消费者代码</b></li>

<li>单个消费消息
<ul class="org-ul">
<li>BlockingChannel.basic_get("queue名称",是否阻塞)-&gt;(method,props,body)
<ul class="org-ul">
<li>body为返回的消息</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
    <span style="color: #a0522d;">msg</span> = channel.basic_get(<span style="color: #8b2252;">"hello"</span>,<span style="color: #008b8b;">True</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21517;&#31216;&#20026;hello&#30340;queue&#38431;&#21015;&#20013;&#33719;&#21462;&#28040;&#24687;&#65292;&#33719;&#21462;&#19981;&#21040;&#38459;&#22622;</span>
    <span style="color: #a0522d;">method</span>,<span style="color: #a0522d;">props</span>,<span style="color: #a0522d;">body</span> = msg <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25343;&#19981;&#21040;&#30340;&#28040;&#24687;tuple&#20026;(None,None,None)</span>
    <span style="color: #a020f0;">if</span> body:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#33719;&#21462;&#21040;&#20102;&#19968;&#20010;&#28040;&#24687;Get A message = {}"</span>.<span style="color: #483d8b;">format</span>(body))
    <span style="color: #a020f0;">else</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#27809;&#26377;&#33719;&#21462;&#21040;&#28040;&#24687;empty"</span>)
</pre>
</div>


<figure id="orgec0390e">
<img src="../../../img/python/rabbitmq_013.jpg" alt="rabbitmq_013.jpg">

<figcaption><span class="figure-number">Figure 28: </span>rabbitmq_013</figcaption>
</figure>

<ul class="org-ul">
<li>获取到消息后msg的结构如下：</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">(&lt;Basic.GetOk(['delivery_tag=1', 'exchange=', 'message_count=38', 'redelivered=False', 'routing_key=hello'])&gt;, &lt;BasicProperties&gt;, b'data01')  
返回元组：(方法method,属性properties,消息body)
无数据返回：(None,None,None)
</pre>
</div>

<ol class="org-ol">
<li>批量消费消息recieve.py</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py &#28040;&#36153;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(channel,method,properties,body):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Get a message = {}"</span>.<span style="color: #483d8b;">format</span>(body))

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
    channel.basic_consume(
        <span style="color: #8b2252;">"hello"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#21517;</span>
        callback,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#22238;&#35843;&#20989;&#25968;</span>
        <span style="color: #008b8b;">True</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22238;&#24212;</span>
    )
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#31561;&#24453;&#28040;&#24687;&#65292;&#36864;&#20986;&#25353;CTRL+C;Waiting for messages. To exit press CTRL+C"</span>)
    channel.start_consuming()
</pre>
</div>


<figure id="org56b9ab8">
<img src="../../../img/python/rabbitmq_014.jpg" alt="rabbitmq_014.jpg">

<figcaption><span class="figure-number">Figure 29: </span>rabbitmq_014</figcaption>
</figure>
</div>
</div>
<div id="outline-container-h:7813c5d5-4fa0-407c-b24b-05261350d2a6" class="outline-5">
<h5 id="h:7813c5d5-4fa0-407c-b24b-05261350d2a6">2.工作队列</h5>
<div class="outline-text-5" id="text-h:7813c5d5-4fa0-407c-b24b-05261350d2a6">

<figure id="org213bcdb">
<img src="../../../img/python/rabbitmq_015.png" alt="rabbitmq_015.png">

<figcaption><span class="figure-number">Figure 30: </span>rabbitmq_015</figcaption>
</figure>

<ul class="org-ul">
<li>继续使用*队列*模式的生产者消费者代码，启动2个消费者。观察结果，可以看到，2个消费者是交替拿到不同的消息。</li>
<li>这种工作模式时一种竞争工作方式，对某一个消息来说，只能有一个消费者拿走它。
<ol class="org-ol">
<li>从结果知道，使用的是轮询方式拿走数据的。</li>
<li>注意：虽然上面的图中没有画出exchange。用到*缺省exchange*。</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:8432203e-692d-4394-ab8a-c4e05c965d68" class="outline-5">
<h5 id="h:8432203e-692d-4394-ab8a-c4e05c965d68">3.发布、订阅模式(Publish/Subscribe)</h5>
<div class="outline-text-5" id="text-h:8432203e-692d-4394-ab8a-c4e05c965d68">

<figure id="org915fc89">
<img src="../../../img/python/rabbitmq_016.png" alt="rabbitmq_016.png">

<figcaption><span class="figure-number">Figure 31: </span>rabbitmq_016</figcaption>
</figure>

<ul class="org-ul">
<li>Publish/Subscribe发布订阅，想象一下订阅者(消费者)订阅这个报纸(消息),都应该拿到一份同样内容的报纸。</li>
<li>订阅者和消费者之间还有一个exchange,可以想象成邮局，消费者去邮局订阅报纸，报社发报纸到邮局，邮局决定如何投递到消费者手中。</li>
<li>上例子中工作队列模式的使用，相当于，每个人只能拿到不同的报纸。所以不适合发布订阅模式。</li>

<li>当模式的exchange的type是fanout，就是一对多，即广播模式。</li>
<li>注意，同一个queue的消息只能被消费一次，所以，这里使用了多个queue,相当于为了保证不同的消费者拿到同样的数据，每一个消费者都应该有自己的queue。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#19968;&#20010;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=<span style="color: #8b2252;">"logs"</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#20132;&#25442;&#26426;</span>
    exchange_type=<span style="color: #8b2252;">"fanout"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24191;&#25773;</span>
)
</pre>
</div>

<ul class="org-ul">
<li>生产者使用*广播模式*。在test虚拟主机中构建了一个logs交换机</li>

<li>至于queue，可以由生产者创建，也可以由消费者创建。</li>
<li>本次采用使用消费者端创建，生产者把数据都发往交换机logs，采用了fanout，然后将数据通过交换机发往已经绑定到此交换机的所有queue。</li>
</ul>


<figure id="org1930e7f">
<img src="../../../img/python/rabbitmq_017.jpg" alt="rabbitmq_017.jpg">

<figcaption><span class="figure-number">Figure 32: </span>rabbitmq_017</figcaption>
</figure>

<ul class="org-ul">
<li>绑定Bingding,建立exchange和queue之间的联系</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#36153;&#32773;&#31471;</span>
<span style="color: #a0522d;">result</span> =channel.queue_declare(queue=<span style="color: #8b2252;">""</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#19968;&#20010;&#38543;&#26426;&#21517;&#31216;&#30340;queue</span>
<span style="color: #a0522d;">resutl</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#19968;&#20010;&#38543;&#26426;&#21517;&#31216;&#30340;queue,&#24182;&#22312;&#26029;&#24320;&#38142;&#25509;&#26102;&#21024;&#38500;queue</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;queue</span>
<span style="color: #a0522d;">q1</span>:<span style="color: #228b22;">Method</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span>:<span style="color: #228b22;">Method</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q1name</span> = q1.method.queue <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#36890;&#36807;result.method.queue &#26597;&#30475;&#38543;&#26426;&#21517;&#31216;</span>
<span style="color: #a0522d;">q2name</span> = q2.method.queue

<span style="color: #483d8b;">print</span>(q1name,q2name)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;</span>
channel.queue_bind(exchange=<span style="color: #8b2252;">"logs"</span>,queue=q1name)
channel.queue_bind(exchange=<span style="color: #8b2252;">"logs"</span>,queue=q2name)
</pre>
</div>

<ul class="org-ul">
<li><b>生成者代码</b>
<ol class="org-ol">
<li>注意观察 交换机和队列</li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py &#29983;&#20135;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
<span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20132;&#25442;&#26426;&#21644;&#27169;&#24335;</span>
    channel.exchange_declare(
        exchange=<span style="color: #8b2252;">"logs"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#20132;&#25442;&#26426;</span>
        exchange_type=<span style="color: #8b2252;">"fanout"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25159;&#20986;&#65292;&#24191;&#25773;</span>
    )

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):
        channel.basic_publish(
            exchange=<span style="color: #8b2252;">"logs"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#25351;&#23450;&#30340;exhcange</span>
            routing_key=<span style="color: #8b2252;">""</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24191;&#25773;&#27169;&#24335;&#65292;&#19981;&#25351;&#23450;routing_key</span>
            body = <span style="color: #8b2252;">"data-{:02}"</span>.<span style="color: #483d8b;">format</span>(i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
        )
        time.sleep(0.01)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#23436;&#25104;"</span>)
</pre>
</div>

<ol class="org-ol">
<li>特别注意：如果先开启生产者，由于没有队列queue,请观察数据</li>

<li><b>消费者代码</b>
<ol class="org-ol">
<li>构建queue并绑定到test虚拟机的logs交换机上</li>
</ol></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py &#28040;&#36153;&#32773;&#20195;&#30721;</span>

<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingConnection
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #a0522d;">connection</span>:<span style="color: #228b22;">BlockingConnection</span> = pika.BlockingConnection(pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>))
<span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(exchange=<span style="color: #8b2252;">"logs"</span>,exchange_type=<span style="color: #8b2252;">"fanout"</span>)

<span style="color: #a0522d;">q1</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">name1</span> = q1.method.queue <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#21517;</span>
<span style="color: #a0522d;">name2</span> = q2.method.queue

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#20132;&#25442;&#26426;&#32465;&#23450;queue</span>
channel.queue_bind(exchange=<span style="color: #8b2252;">"logs"</span>,queue=name1)
channel.queue_bind(exchange=<span style="color: #8b2252;">"logs"</span>,queue=name2)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(channel,method,properties,body):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">{}"</span>.<span style="color: #483d8b;">format</span>(channel,method))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#33719;&#21462;&#20102;&#19968;&#20010;&#28040;&#24687; Get a message = {}"</span>.<span style="color: #483d8b;">format</span>(body))

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#31532;&#19968;&#20010;&#38431;&#21015;&#32465;&#23450;&#28040;&#36153;&#32773;&#20989;&#25968;</span>
    channel.basic_consume(
        name1,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#21517;</span>
        callback, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#32773;&#22238;&#35843;&#20989;&#25968;</span>
        <span style="color: #008b8b;">True</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22238;&#24212;</span>
    )
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#31532;&#20108;&#20010;&#38431;&#21015;&#32465;&#23450;&#28040;&#36153;&#32773;&#20989;&#25968;</span>
    channel.basic_consume(name2,callback,<span style="color: #008b8b;">True</span>)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#31561;&#24453;&#28040;&#24687;&#65292;&#36864;&#20986;&#25353;CTRL+C;Waiting for messages. To exit press CTRL+C"</span>)
    channel.start_consuming()
</pre>
</div>

<ul class="org-ul">
<li>先启动消费者receie.py可以看到已经创建了exchange</li>
</ul>


<figure id="org2dfd723">
<img src="../../../img/python/rabbitmq_018.jpg" alt="rabbitmq_018.jpg">

<figcaption><span class="figure-number">Figure 33: </span>rabbitmq_018</figcaption>
</figure>

<ul class="org-ul">
<li>如果exchange是fanout，也就是广播了，routing_key就不用关心了。</li>
</ul>


<figure id="orgd82a9de">
<img src="../../../img/python/rabbitmq_019.jpg" alt="rabbitmq_019.jpg">

<figcaption><span class="figure-number">Figure 34: </span>rabbitmq_019</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">q1</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<ul class="org-ul">
<li>注意：演示时要先启动消费者，再启动生产。如果先尝试启动生产者，在启动消费者会导致部分数据丢失。因为：exchange收了数据，没有queue接受，所以，exchange丢弃了这些数据。</li>
</ul>
</div>
</div>
<div id="outline-container-h:e14de8c7-6c4e-43f6-9635-88318aa5e521" class="outline-5">
<h5 id="h:e14de8c7-6c4e-43f6-9635-88318aa5e521">4.路由模式Routing</h5>
<div class="outline-text-5" id="text-h:e14de8c7-6c4e-43f6-9635-88318aa5e521">

<figure id="org42854e7">
<img src="../../../img/python/rabbitmq_020.png" alt="rabbitmq_020.png">

<figcaption><span class="figure-number">Figure 35: </span>rabbitmq_020</figcaption>
</figure>

<ul class="org-ul">
<li>路由其实就是生产者的数据经过exhange的时候，通过匹配规则，决定数据的去向。</li>

<li>生产者代码，交换机类型为direct，指定路由的key</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send&#29983;&#20135;&#32773;</span>
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingConnection
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #a0522d;">exchangename</span> = <span style="color: #8b2252;">"color"</span>
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">"orange"</span>,<span style="color: #8b2252;">"black"</span>,<span style="color: #8b2252;">"green"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span>:<span style="color: #228b22;">BlockingConnection</span> = pika.BlockingConnection(pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>))
<span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()

<span style="color: #a020f0;">with</span> connection:
    channel.exchange_declare(
        exchange=exchangename,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#25351;&#23450;&#30340;exchange</span>
        exchange_type=<span style="color: #8b2252;">"direct"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#27169;&#24335;</span>
    )

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):
        <span style="color: #a0522d;">rk</span> = random.choice(colors)
        <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"{}-data-{:02}"</span>.<span style="color: #483d8b;">format</span>(rk,i)
        channel.basic_publish(
            exchange=exchangename,<span style="color: #b22222;">#</span>
            routing_key=rk,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;routing_key</span>
            body=msg <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
        )
        <span style="color: #483d8b;">print</span>(msg,<span style="color: #8b2252;">"----"</span>)
        time.sleep(0.01)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#23436;&#25104; Sent ok"</span>)
</pre>
</div>

<ol class="org-ol">
<li>消费者代码</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py&#28040;&#36153;&#32773;</span>
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingConnection
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #a0522d;">exchangename</span> = <span style="color: #8b2252;">"color"</span>
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">"orange"</span>,<span style="color: #8b2252;">"black"</span>,<span style="color: #8b2252;">"green"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span>:<span style="color: #228b22;">BlockingConnection</span> = pika.BlockingConnection(pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>))
<span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
channel.exchange_declare(exchange=exchangename,exchange_type=<span style="color: #8b2252;">"direct"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#21517;&#31216;&#38543;&#26426;&#65292;exclusive=True&#26029;&#24320;&#21024;&#38500;&#35813;&#38431;&#21015;</span>
<span style="color: #a0522d;">q1</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">name1</span> = q1.method.queue <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38431;&#21015;&#21517;</span>
<span style="color: #a0522d;">name2</span> = q2.method.queue
<span style="color: #483d8b;">print</span>(name1,name2)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;&#21040;&#20132;&#25442;&#26426;&#65292;&#32780;&#19988;&#19968;&#23450;&#35201;&#32465;&#23450;routing_key</span>
channel.queue_bind(exchange=exchangename,queue=name1,routing_key=colors[0])
channel.queue_bind(exchange=exchangename,queue=name2,routing_key=colors[1])
channel.queue_bind(exchange=exchangename,queue=name2,routing_key=colors[2])

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(channel,method,properties,body):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">{}"</span>.<span style="color: #483d8b;">format</span>(channel,method))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#33719;&#21462;&#20102;&#19968;&#20010;&#28040;&#24687;get a message = {}"</span>.<span style="color: #483d8b;">format</span>(body))
    <span style="color: #483d8b;">print</span>()

<span style="color: #a020f0;">with</span> connection:
    channel.basic_consume(
        name1,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#21517;</span>
        callback, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;&#22238;&#35843;&#20989;&#25968;</span>
        <span style="color: #008b8b;">True</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22238;&#24212;</span>
    )
    channel.basic_consume(name2,callback,<span style="color: #008b8b;">True</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#31561;&#24453;&#28040;&#24687;&#65292;&#36864;&#20986;&#25353;CTRL+C;Waiting for messages. To exit press CTRL+C"</span>)
    channel.start_consuming()
</pre>
</div>


<figure id="org4f44cc2">
<img src="../../../img/python/rabbitmq_021.png" alt="rabbitmq_021.png">

<figcaption><span class="figure-number">Figure 36: </span>rabbitmq_021</figcaption>
</figure>

<ul class="org-ul">
<li>注意：如果routing_key设置一样，绑定的时候指定routing_key='black',如下图。和fanout就类似了，都是1对多，但是不同。<br>
<img src="../../../img/python/rabbitmq_022.png" alt="rabbitmq_022.png">
<ol class="org-ol">
<li>因为fanout时，exchange不做数据过滤，1个消息，所有绑定的queue都会拿到一个副部。</li>
<li>direct时候，要按照routing_key分配数据，上图的black有2个queue设置了，就会把1个消息分发给这2个queue。</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:e653a929-3560-40ef-9b1e-509028546f6e" class="outline-5">
<h5 id="h:e653a929-3560-40ef-9b1e-509028546f6e">5.Topic话题</h5>
<div class="outline-text-5" id="text-h:e653a929-3560-40ef-9b1e-509028546f6e">

<figure id="org518f1d1">
<img src="../../../img/python/rabbitmq_023.png" alt="rabbitmq_023.png">

<figcaption><span class="figure-number">Figure 37: </span>rabbitmq_023</figcaption>
</figure>

<ul class="org-ul">
<li>Topic就是更加高级的路由，支持模式匹配而已。</li>
<li>Topic的routing_key必须使用=.=点号分割的单词组成。最多255个字节。</li>
<li>支持使用通配符：
<ol class="org-ol">
<li>=*=表示严格的一个单词</li>
<li>=#=表示0个或多个单词</li>
</ol></li>
<li>如果queue绑定的routing_key只是一个=#=,这个queue其实可以接收所有的消息。</li>
<li>如果没有使用任何通配符，效果类似于direct，因为只能和字符串匹配了。</li>

<li>生产者代码</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py&#29983;&#20135;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingConnection
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #a0522d;">exchangename</span> = <span style="color: #8b2252;">"products"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20135;&#21697;&#21644;&#39068;&#33394;&#25645;&#37197;</span>
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">"orange"</span>,<span style="color: #8b2252;">"black"</span>,<span style="color: #8b2252;">"green"</span>)
<span style="color: #a0522d;">topics</span> = (<span style="color: #8b2252;">"phone.*"</span>,<span style="color: #8b2252;">"*.red"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#31181;&#35805;&#39064;</span>
<span style="color: #a0522d;">product_type</span> = (<span style="color: #8b2252;">"phone"</span>,<span style="color: #8b2252;">"pc"</span>,<span style="color: #8b2252;">"tv"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">3&#31181;&#20135;&#21697;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span>:<span style="color: #228b22;">BlockingConnection</span> = pika.BlockingConnection(pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>))
<span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20132;&#25442;&#26426;&#20026;&#35805;&#39064;&#27169;&#24335;</span>
channel.exchange_declare(exchange=exchangename,exchange_type=<span style="color: #8b2252;">"topic"</span>)


<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):
        <span style="color: #a0522d;">rk</span> = <span style="color: #8b2252;">"{}.{}"</span>.<span style="color: #483d8b;">format</span>(random.choice(product_type),random.choice(colors))
        <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"{}-data-{:02}"</span>.<span style="color: #483d8b;">format</span>(rk,i)
        channel.basic_publish(
            exchange=exchangename,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#25351;&#23450;&#30340;exchange</span>
            routing_key=rk,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;routing_key</span>
            body=msg <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
        )
        <span style="color: #483d8b;">print</span>(msg,<span style="color: #8b2252;">"-----"</span>)
        time.sleep(0.5)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#23436;&#25104; Sent ok"</span>)
</pre>
</div>

<ol class="org-ol">
<li>消费者代码</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">recieve.py &#28040;&#36153;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingConnection
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#34394;&#25311;&#26426;&#21517;&#31216;</span>
<span style="color: #a0522d;">exchangename</span> = <span style="color: #8b2252;">"products"</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span>:<span style="color: #228b22;">BlockingConnection</span> = pika.BlockingConnection(pika.URLParameters(<span style="color: #8b2252;">"amqp://gdy:gdy@192.168.61.108:5672/test"</span>))
<span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#34394;&#25311;&#26426;&#65292;&#20132;&#25442;&#26426;&#20026;&#35805;&#39064;&#27169;&#24335;</span>
channel.exchange_declare(exchange=exchangename,exchange_type=<span style="color: #8b2252;">"topic"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#21517;&#31216;&#38543;&#26426;&#65292;exclusive=True&#26029;&#24320;&#21024;&#38500;&#35813;&#38431;&#21015;</span>
<span style="color: #a0522d;">q1</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">name1</span> = q1.method.queue <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38431;&#21015;&#21517;</span>
<span style="color: #a0522d;">name2</span> = q2.method.queue
<span style="color: #483d8b;">print</span>(name1,name2)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;&#21040;&#20132;&#25442;&#26426;&#65292;&#32780;&#19988;&#19968;&#23450;&#32465;&#23450;routing_key</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">q1&#21482;&#25910;&#38598;phone&#24320;&#22836;&#30340;routing_key&#30340;&#28040;&#24687;&#65292;&#20063;&#23601;&#26159;&#35828;&#21482;&#31649;&#25910;&#38598;&#31867;&#22411;&#20449;&#24687;</span>
channel.queue_bind(exchange=exchangename,queue=name1,routing_key=<span style="color: #8b2252;">"phone.*"</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">q2&#21482;&#25910;&#38598;red&#32467;&#23614;&#30340;routing_key&#30340;&#28040;&#24687;&#65292;&#20063;&#23601;&#26159;&#35828;&#21482;&#31649;&#32418;&#33394;&#30340;&#20449;&#24687;</span>
channel.queue_bind(exchange=exchangename,queue=name2,routing_key=<span style="color: #8b2252;">"*.red"</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(channel,method,properties,body):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">{}"</span>.<span style="color: #483d8b;">format</span>(channel,method))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#33719;&#21462;&#20102;&#19968;&#20010;&#28040;&#24687;Get a message = {}"</span>.<span style="color: #483d8b;">format</span>(body))
    <span style="color: #483d8b;">print</span>()

<span style="color: #a020f0;">with</span> connection:
    channel.basic_consume(
        name1,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#21517;</span>
        callback,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;&#22238;&#35843;&#20989;&#25968;</span>
        <span style="color: #008b8b;">True</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22238;&#24212;</span>
    )
    channel.basic_consume(name2,callback,<span style="color: #008b8b;">True</span>)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#31561;&#24453;&#28040;&#24687;&#65292;&#36864;&#20986;&#25353;CTRL+C;Waiting for messages. To exit press CTRL+C"</span>)
    channel.start_consuming()
</pre>
</div>


<figure id="org3b9bb9a">
<img src="../../../img/python/rabbitmq_024.png" alt="rabbitmq_024.png">

<figcaption><span class="figure-number">Figure 38: </span>rabbitmq_024</figcaption>
</figure>

<ul class="org-ul">
<li>观察消费者拿到的数据，注意观察phone.red的数据出现次数。
<img src="../../../img/python/rabbitmq_025.png" alt="rabbitmq_025.png"></li>

<li>由此，可以知道*交换机在路由消息的时候，只要和queue的routing_key匹配，就把消息发给该queue。*</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a2e85b01-fb8c-4897-a4a2-02928d876b55" class="outline-3">
<h3 id="h:a2e85b01-fb8c-4897-a4a2-02928d876b55">RPC远程过程调用</h3>
<div class="outline-text-3" id="text-h:a2e85b01-fb8c-4897-a4a2-02928d876b55">
<ul class="org-ul">
<li>RabbitMQ的RPC的应用场景较少，因为有更好的RPC通信框架。</li>
</ul>
</div>
<div id="outline-container-h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e" class="outline-4">
<h4 id="h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e">消息队列的作用</h4>
<div class="outline-text-4" id="text-h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e">
<ol class="org-ol">
<li>系统间解耦</li>
<li>解决生产者、消费者速度匹配</li>

<li>由于稍微上规模的项目都会分层、分模块开发，模块间或系统间尽量不要直接耦合，需要开放公共接口提供给别的模块或系统调用，而调用可能触发并发问题，为了缓冲和解耦，往往采用中间件技术。</li>
<li>RabbitMQ只是消息中间件中的一种应用程序，也是较常用的中间件服务。</li>
</ol>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
