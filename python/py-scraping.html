<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python:爬虫技术</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Python:爬虫技术</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:43f169a4-737b-4d12-9f4e-4116bed3204b">概述</a>
<ul>
<li><a href="#h:8c9c0136-6f27-4fed-ad05-7321982c9c20">爬虫分类</a>
<ul>
<li><a href="#h:0a1b3575-01c7-4bf8-a79e-889106c171da">1.通用爬虫</a></li>
<li><a href="#h:8c29fde1-320f-4b25-998d-301c7c39e794">2. 聚焦爬虫</a></li>
</ul>
</li>
<li><a href="#h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da">Robots协议</a></li>
<li><a href="#h:2c098648-38c9-4c35-b55f-babdf7ef491f">法律知识</a></li>
</ul>
</li>
<li><a href="#h:71806a2a-6d96-46d1-ac19-65115c660df6">HTTP请求和响应处理</a>
<ul>
<li><a href="#h:67f4c161-aec6-49d3-be64-d83915a3c7ef">urllib包</a>
<ul>
<li><a href="#h:9df4c633-a584-416f-8eb6-941240690a6d">urllib.request模块</a>
<ul>
<li><a href="#h:ecd703fa-1727-4078-a768-87546c280c7b">urlopen方法</a></li>
<li><a href="#h:3e8c98f8-b214-4e00-8869-0987739541a9">User-Agent问题</a></li>
<li><a href="#h:6764bce3-3fd3-4ecb-952a-f42a9175b634">Request类</a></li>
</ul>
</li>
<li><a href="#h:105dbd3f-e6cf-4c86-b867-cd3564e269dc">urllib.parse模块</a></li>
</ul>
</li>
<li><a href="#h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d">提交方法method</a>
<ul>
<li><a href="#h:2fa09768-b387-4f3d-acf8-fbb88dbf447e">GET方法</a></li>
<li><a href="#h:ba7b0e62-fa76-45c2-874e-5affab70c5be">POST方法</a></li>
<li><a href="#h:2382eb7c-e980-4563-a867-dc031a88b933">处理JSON数据</a></li>
</ul>
</li>
<li><a href="#h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b">HTTPS证书忽略</a></li>
<li><a href="#h:a9ad48b9-d19f-4761-9e40-2788c839e14b">urllib3库</a></li>
<li><a href="#h:0b5a6eed-ce46-4946-8a07-3856f717957e">requests库**</a></li>
</ul>
</li>
<li><a href="#h:93950bd9-2429-4fa5-8823-10fe7bac3876">HTML解析-Xpath</a>
<ul>
<li><a href="#h:3d601eb4-d05e-409b-817d-37dd4f8368f1">XPath***</a>
<ul>
<li><a href="#h:1e1c2fb8-7e5b-474e-ba3f-0f8db99312e3">工具</a></li>
<li><a href="#h:73350c13-31ad-4ee2-96b6-70ad6e516194">节点</a></li>
<li><a href="#h:7c017721-c274-498f-a399-f569cc79a159">节点选择</a></li>
<li><a href="#h:9a51d00f-6afb-4cf7-b311-c833940f7ac6">谓语(Predicates)</a></li>
<li><a href="#h:12b5a5e9-6c9e-40ac-b9f7-375caa0e8aed">XPath轴(Axes)</a></li>
<li><a href="#h:63837f91-0955-484a-a4b9-792528a7c687">步Step</a></li>
<li><a href="#h:9c27c201-88df-4512-94ef-3eba7f661464">XPATH示例</a></li>
</ul>
</li>
<li><a href="#h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e">lxml</a>
<ul>
<li><a href="#h:eab8c31e-1465-479c-8b71-da8958b900ab">练习：爬取“口碑榜”</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:e44aa8d4-2513-47de-bf5c-f2da6027fbb0">MongoDB在python中的使用</a>
<ul>
<li><a href="#h:87a88b38-e2ea-4d08-bfd7-52f3c1b5200b">安装</a></li>
<li><a href="#h:7c5d3e27-9211-450c-bba4-52fe1681a6ef">配置文件</a></li>
<li><a href="#h:1d5302bb-9086-44eb-b873-7f8c939913bb">客户端</a>
<ul>
<li><a href="#h:9fd2fd89-0dd3-4951-b0ae-c2be34617d2d">客户端连接</a></li>
<li><a href="#h:a7697b26-2e85-4591-b074-b3f502bbc6d4">Python链接</a></li>
</ul>
</li>
<li><a href="#h:4a19f701-a8b3-4944-84a7-e79f115ce759">基本概念</a></li>
<li><a href="#h:9ab10d84-4568-4826-8bbf-7bb5da35547c">插入数据</a></li>
<li><a href="#h:c3cbb4d4-42bc-48e5-b8f9-7247ae5c0385">文档</a></li>
<li><a href="#h:0b474c2e-a2a2-4e9b-9e70-2faa5aa04ecf">查询数据</a>
<ul>
<li><a href="#h:85455a5c-b5ac-49de-9929-a642c2c869c6">单条查询</a></li>
<li><a href="#h:47f762c9-c342-4a09-9e44-04ce86331cf4">多条查询</a></li>
<li><a href="#h:9ce1aabd-2a22-4aff-a698-bfca6f79c9e2">查询操作符</a></li>
<li><a href="#h:915c53dd-c905-40c7-bd42-c9b58453f051">投影</a></li>
<li><a href="#h:2aa49b92-af24-4173-a43f-8487749160bc">统计</a></li>
<li><a href="#h:f19fe17a-2c4c-49be-b2e9-756570f476f2">聚合</a></li>
<li><a href="#h:5eab4f89-6e2d-4333-a012-bfaa4dff7463">排序</a></li>
<li><a href="#h:76a88896-6c2a-4fb2-89d1-2380df0fc403">分页</a></li>
</ul>
</li>
<li><a href="#h:3f6d2783-2054-460e-bfce-e84b3041734a">更新</a></li>
<li><a href="#h:b7389762-82df-4c26-bb7e-02981740efa6">全文索引</a></li>
<li><a href="#h:888b2a5f-2c89-4ec5-8577-733337658097">删除</a></li>
</ul>
</li>
<li><a href="#h:05056423-ee64-468c-bdd6-ad4f63b6d935">HTML解析-BeautifulSoup4</a>
<ul>
<li><a href="#h:3588ac25-80d5-414f-914c-fff2fad17e68">BeautifulSoup4</a>
<ul>
<li><a href="#h:92a7357f-fd46-4b94-92a6-c8d7c3ab9d7f">安装</a></li>
<li><a href="#h:d61e1ef5-9e47-4c0c-bd1d-dae6373b48ea">初始化</a></li>
<li><a href="#h:205fa938-a497-4314-a9b6-63fe7837c826">四种对象</a>
<ul>
<li><a href="#h:4e6e25aa-236c-4d07-8974-99988843972a">BeautifulSoup对象</a></li>
<li><a href="#h:66bfc311-2309-4599-b3bd-795c6c657781">Tag对象</a></li>
<li><a href="#h:f372f832-a871-4ce8-9fc3-12ecad8fcfc0">NavigableString</a></li>
<li><a href="#h:03a4dad0-6b36-4185-80f3-a11b571a46b8">注释对象</a></li>
</ul>
</li>
<li><a href="#h:1e6751b5-780e-4f68-8535-4e3974da24a2">遍历文档树</a>
<ul>
<li><a href="#h:f79a7c2e-fce5-41e4-9567-8b89b57d8a7c">使用Tag</a></li>
<li><a href="#h:af4d40a5-350c-4bc8-b908-df663b1d1e79">遍历直接子节点</a></li>
<li><a href="#h:f4c96c66-28a9-4ab0-b581-34dedeceed66">遍历所有子孙节点</a></li>
<li><a href="#h:347c6706-8220-4f1a-ad6c-c0171b6ad795">遍历字符串</a></li>
<li><a href="#h:4cc29918-ee11-40a1-8f9d-5e97a595dd31">遍历祖先节点</a></li>
<li><a href="#h:24e5fb4f-e72e-42e5-b36c-d7dc16fad7c4">遍历兄弟节点</a></li>
<li><a href="#h:e4ffe803-59ef-4e07-abbf-b7c9414cb3b0">遍历其他元素*</a></li>
</ul>
</li>
<li><a href="#h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641">搜索文档树</a>
<ul>
<li><a href="#h:3da6606b-462f-4a9c-8393-bc154fac34e0">name参数</a></li>
<li><a href="#h:f7e80de2-1e3f-4eb9-8ecb-49f2dd33c98b">keyword传参</a></li>
<li><a href="#h:9d9cbff6-9daf-45ef-a76f-0b866aaaf51c">css的class的特殊处理</a></li>
<li><a href="#h:1c9b771f-a6ac-4a1a-bc4a-e22b988bf46b">attrs参数</a></li>
<li><a href="#h:754d5e24-da4d-4ce6-81c0-c1bdb48d23ec">string参数</a></li>
<li><a href="#h:c85ff078-808e-4709-a7f5-2b3dbad31bcf">limit参数</a></li>
<li><a href="#h:5f078c78-3d11-45db-865b-39d3567a8abd">recursive参数</a></li>
<li><a href="#h:2bbaa4f2-e804-48a2-a5ed-862a8bcb764b">简化写法</a></li>
<li><a href="#h:a4896334-f114-4a15-ae00-8cb8b3ad3fcf">find方法</a></li>
</ul>
</li>
<li><a href="#h:c31da1db-44a4-45bd-aa8d-551568b8e4a9">CSS选择器</a></li>
<li><a href="#h:76e09edf-517a-4a60-bffd-6e551de6232c">获取文本内容</a></li>
</ul>
</li>
<li><a href="#h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0">Json解析</a></li>
</ul>
</li>
<li><a href="#h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f">RabbitMQ</a>
<ul>
<li><a href="#h:038a8e0a-b7fa-406f-a43b-559d5d4ce264">部署</a>
<ul>
<li><a href="#h:f899334f-3118-41be-80e6-e8625d7b0dae">安装</a></li>
<li><a href="#h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc">配置</a>
<ul>
<li><a href="#h:836f844f-b135-4993-837c-10a2d1bff7ff">环境配置</a></li>
<li><a href="#h:63d147a7-aede-4e74-826b-e7cfc32eaaf5">工作特性配置文件</a></li>
</ul>
</li>
<li><a href="#h:96ef7d6b-d211-4d63-81c1-381babafd986">插件管理</a></li>
<li><a href="#h:e531ee22-998b-4f99-aab2-7ac5ad53508e">启动服务</a>
<ul>
<li><a href="#h:e4c43729-a03b-49a2-83b3-a5648366408b">容器方式启动服务</a></li>
</ul>
</li>
<li><a href="#h:7881dc05-67bb-469e-9577-c9ad18bc3b95">用户管理</a></li>
<li><a href="#h:095ec87e-eb33-4e63-8b92-d1b91333cbec">虚拟主机</a></li>
<li><a href="#h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995">Pika库</a></li>
</ul>
</li>
<li><a href="#h:e4d7a939-b004-45e1-bbec-7ba99ca86d67">RabbitMQ工作原理及应用</a>
<ul>
<li><a href="#h:f9cb405c-487c-4a23-938b-7ae7f21eea58">工作模式</a></li>
<li><a href="#h:c18c4a24-5e98-4822-a834-92acee7e0526">名词解释</a></li>
<li><a href="#h:4900c67f-edda-4470-99d2-ca179d94a7da">1.队列 *</a></li>
<li><a href="#h:7813c5d5-4fa0-407c-b24b-05261350d2a6">2.工作队列 **</a>
<ul>
<li><a href="#h:3ab8bf66-7611-412e-9a7e-101615ff1e49">应答</a></li>
<li><a href="#h:f4d969fd-b111-4f0a-8b4c-bdd219d1b095">持久化</a></li>
<li><a href="#h:aa02c42a-95d0-4127-a07a-2f944b3ebc17">公平分发</a></li>
</ul>
</li>
<li><a href="#h:8432203e-692d-4394-ab8a-c4e05c965d68">3.发布、订阅模式(Publish/Subscribe)</a></li>
<li><a href="#h:e14de8c7-6c4e-43f6-9635-88318aa5e521">4.路由模式Routing <b>*</b></a></li>
<li><a href="#h:e653a929-3560-40ef-9b1e-509028546f6e">5.Topic话题</a></li>
<li><a href="#h:a2e85b01-fb8c-4897-a4a2-02928d876b55">RPC远程过程调用</a></li>
</ul>
</li>
<li><a href="#h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e">消息队列的作用</a></li>
</ul>
</li>
<li><a href="#h:1e876ea3-1367-4ed1-92a5-5f98f72ee51f">模拟登陆oschina（新浪）</a>
<ul>
<li><a href="#h:bfaeced4-2794-4abc-a819-83aa115e6645">使用postman的python代码生成器生成代码</a></li>
</ul>
</li>
<li><a href="#h:1d186b06-a5e6-4418-9259-27d139be9804">并发爬取博客园</a>
<ul>
<li><a href="#h:403d48d9-bdfe-420d-a4e8-0cc9b5bd8a13">基础</a>
<ul>
<li><a href="#h:e1bdbb82-6dcf-4ea8-abc5-5cd0340c35e9">基本代码</a></li>
<li><a href="#h:a256b03d-fbf5-44d3-b3cb-3b715009e1c5">函数封装</a></li>
<li><a href="#h:f5e0de04-3a71-49e2-83a5-27e0ede3450e">异步</a></li>
</ul>
</li>
<li><a href="#h:9fb85552-33b5-45ac-a1ff-0fb31797895a">进阶（消息队列）</a>
<ul>
<li><a href="#h:7fd990ee-5335-4deb-8251-f77ebda98be4">选型</a></li>
<li><a href="#h:5ecb7169-1096-4e20-b2be-0a938165f08b">生产者消息者代码</a></li>
<li><a href="#h:7b31251d-dd58-4b06-a6bc-497569b37954">重构消息队列类</a></li>
<li><a href="#h:b979faff-bc3d-4980-8724-e753c793d2e8">重构爬虫代码</a></li>
<li><a href="#h:634dd262-47cb-4e1f-807c-52492a389242">持久化</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:94cc31e3-1836-4ff2-98d9-63f72f0ffa09">Selenium和PhantomJS</a>
<ul>
<li><a href="#h:bb5ddff5-d739-418c-adb8-8a47ebb53656">动态网页处理</a></li>
<li><a href="#h:6b0c075f-5eea-47b2-bef6-f57d40c39dac">PhantomJS</a></li>
<li><a href="#h:c26b4db8-aa7a-4640-8360-98c0866aae33">Selenium</a>
<ul>
<li><a href="#h:e8fe6eeb-a6c3-4529-99f5-7060a3e3f542">selenium基本语法学习</a>
<ul>
<li><a href="#h:fb324ca8-e199-43c6-ba87-92414ddb722f">元素定位</a></li>
<li><a href="#h:df1b2590-6ab1-459a-be94-b8f2749fe70e">元素访问</a></li>
</ul>
</li>
<li><a href="#h:868cd524-84d0-4192-8961-d41bdf0118d2">交互操作</a></li>
</ul>
</li>
<li><a href="#h:27366c3c-4cbc-4e34-899a-70de184213b6">开发实战</a>
<ul>
<li><a href="#h:139433f1-d9a4-4026-a125-556a3ced6348">处理异步请求</a></li>
<li><a href="#h:a1fc509e-3ba1-4781-adbf-33dff534e3e8">下拉框处理</a></li>
<li><a href="#h:a7a9142e-7cd3-4481-8698-4910272569a0">模拟键盘操作（模拟登录）</a></li>
<li><a href="#h:31ae2822-7d51-44b6-8461-ee1ebdcaad77">页面等待</a>
<ul>
<li><a href="#h:f823fe12-8581-43a6-afd5-09e1b0c8c11d">方法1 线程休眠</a></li>
<li><a href="#h:0b265b5c-a2f5-4c42-862d-dbd319b3b127">方法2 Selenium等待</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:07d25607-1e53-4011-82ef-4b4fdb0da343">总结</a></li>
</ul>
</li>
<li><a href="#h:0c2d52c0-d96a-496f-9731-991846240c5b">Scrapy 框架</a>
<ul>
<li><a href="#h:8cfc07b2-a961-4080-aa58-da37f737998f">Scrapy框架</a>
<ul>
<li><a href="#h:bde7be1f-e8c4-4e93-9110-6809d7d1938c">Scrapy架构</a></li>
<li><a href="#h:32dbdccc-c9fc-47a1-a956-e2934fd1efa9">数据流(Data flow)</a></li>
<li><a href="#h:0c514f23-b174-4744-8ed9-0b59cf45f5e6">组件</a></li>
<li><a href="#h:96fe61c2-936a-420b-b9ff-d093d5400bbd">安装scrapy</a></li>
</ul>
</li>
<li><a href="#h:d88d04ec-b09f-462a-ac74-6ddc4b8e8f4b">Scrapy开发</a>
<ul>
<li><a href="#h:d8be0ceb-9c3b-4a90-b677-4aa6ab66b039">项目编写流程</a></li>
<li><a href="#h:c30428d3-5773-4f51-9980-99935604615e">创建项目</a></li>
<li><a href="#h:1ac5d239-f9dd-4c3a-aa5d-07164a175c98">编写Item</a></li>
<li><a href="#h:de99b8fb-c341-4e97-a105-f8ac8930b719">编写爬虫</a>
<ul>
<li><a href="#h:979b0155-8049-49cd-8406-d5af2d91256b">解析HTML</a></li>
<li><a href="#h:029ef855-f59b-4a95-a63f-b4c7253bd6b9">item封装数据</a></li>
</ul>
</li>
<li><a href="#h:f2811a36-83d0-49fc-9cc1-e0cabc765b31">pipeline处理</a>
<ul>
<li><a href="#h:1b673185-1dce-407b-8126-ab18b2c7efc0">开启pipeline</a></li>
<li><a href="#h:398aaff9-22ef-4c52-a4bd-50058065af77">常用方法</a></li>
</ul>
</li>
<li><a href="#h:d4bd91dd-c8a0-4e50-9d1e-d4ba396d974a">url提取</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a28491bc-7501-46cf-9b10-95012c1c3809">爬取豆瓣读书项目</a>
<ul>
<li><a href="#h:f8090dbd-150e-4cf8-8be3-7a65dd724379">需求</a></li>
<li><a href="#h:fc4c9ea5-dbc2-4daf-a72e-8f70dcb7840c">链接分析</a></li>
<li><a href="#h:07f9ec8c-cdcc-4cad-a373-169cf0816355">项目开发</a>
<ul>
<li><a href="#h:d4e0cb82-1dc0-4ae3-99bd-147692763e58">创建项目</a></li>
<li><a href="#h:0da9cf1a-c3d7-4345-94e9-370e09d5119e">配置 settings.py</a></li>
<li><a href="#h:559b7299-f4ae-4fdf-89d4-e0a2ffe5e75f">编写 item</a></li>
<li><a href="#h:eed446f3-6556-40e8-a83b-59280f04c2a8">创建爬虫</a>
<ul>
<li><a href="#h:400acf8d-c42f-4bea-895d-2fdc5637ce2f">爬取</a></li>
</ul>
</li>
<li><a href="#h:10c6a941-9060-4b0a-95ba-df32c5e1ce6f">MongoDB pipeline</a></li>
<li><a href="#h:d0d95e55-9d23-4396-8387-0eda07942819">代理</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:af0b40b4-cce2-4983-b73e-221dda4c5d07">redis-py</a>
<ul>
<li><a href="#h:edd42eff-5740-4a25-a18d-8c9be8185c7f">官方</a></li>
<li><a href="#h:9a9bfafb-7543-4a08-857e-1151771a2ef1">安装库</a></li>
<li><a href="#h:445e81f7-bc9f-480a-917a-8b32f1aa5091">普通连接</a></li>
<li><a href="#h:d53a1a61-f006-4bac-a76c-6d9f86f98001">通过地址池连接</a></li>
<li><a href="#h:b11531e1-5924-4482-95b0-c7afa7b4c39b">Redis数据模型</a>
<ul>
<li><a href="#h:3e2e935b-c250-4647-88d8-4caa44558998">键Key</a></li>
<li><a href="#h:c5ede1fd-d766-4920-b765-6d6cab0d7718">字符串</a></li>
<li><a href="#h:a3d34cb4-fcfd-4891-9807-d2dad6f11519">查看帮助</a></li>
<li><a href="#h:0a83a70a-d632-4ef4-9829-78d74dd9031a">字符串设置</a>
<ul>
<li><a href="#h:38ce878a-7850-4d0e-963a-73037b756cb9">过期操作和生存时间</a></li>
<li><a href="#h:05707e41-5b32-43f8-b77c-63621e04bbb4">key操作</a></li>
<li><a href="#h:f0ea1610-fdd9-49bd-a9f7-a26c99199024">字符串获取</a></li>
<li><a href="#h:442907e1-0030-4d7a-b63c-4c7518efb03c">字符串操作</a></li>
<li><a href="#h:7b652d57-fb84-40e1-80a4-df3b2f86b781">自增、自减</a></li>
</ul>
</li>
<li><a href="#h:6512e200-5646-4f59-8455-634a3124461a">库操作</a></li>
<li><a href="#h:c34bd979-a8bf-4071-b2ae-13e5f44b910c">位图bitmap</a>
<ul>
<li><a href="#h:4dbd62eb-0655-4aa9-87b6-66a17a4f2d39">位操作</a></li>
</ul>
</li>
<li><a href="#h:8f5fdfee-9911-4d17-9111-5e75ed62bfb9">List列表</a></li>
<li><a href="#h:b55a4e37-6a72-4f77-9443-2f74c4b4c511">hash散列</a></li>
<li><a href="#h:6e8c0ef6-8d9e-4db1-8ce5-af534ce2d7cf">Set集合</a></li>
<li><a href="#h:74b51585-d16e-4f97-90d4-c8315d47b78d">SortedSet有序集合</a></li>
</ul>
</li>
<li><a href="#h:44877547-7bab-4d00-9c14-1516ad1d780f">操作</a>
<ul>
<li><a href="#h:061a3774-b478-4bcb-937b-6282062124c6">键操作</a></li>
<li><a href="#h:558aaa51-ee41-4808-9f22-2a215ebabfba">值操作：字符串操作</a></li>
<li><a href="#h:d320d6d6-a949-45ac-8639-b6f9ac252855">值操作：列表操作</a></li>
<li><a href="#h:c1d7fe88-f08d-4fef-ab7d-794a101cc35d">值操作：集合操作</a></li>
<li><a href="#h:0c7f498d-46a9-4848-b664-d78e305170e5">值操作：有序集合操作</a></li>
<li><a href="#h:3c73fe3f-0b8a-49ff-a401-a4cdc4e2077e">值操作：散列操作</a></li>
</ul>
</li>
<li><a href="#h:df82b2f5-ca37-45e7-925f-df245841aae8">订阅/发布</a></li>
<li><a href="#h:dae8b734-1bd4-4c30-9f92-1c526d0f233d">pipeline</a></li>
<li><a href="#h:4696288d-e308-4a21-9a63-c08e33f48d69">哨兵模式编程</a></li>
</ul>
</li>
<li><a href="#h:2da0aae3-853f-45cc-baf9-1f2c829dea04">Scrapy-redis组件</a>
<ul>
<li><a href="#h:36314aa3-da6a-4e00-a9c4-704cd7607c74">Scrapy-redis组件</a>
<ul>
<li><a href="#h:1a605ae5-ebfc-4d17-b7b5-944b01af5d76">安装</a></li>
<li><a href="#h:c9c13b24-f4fe-46b5-abcf-4a86403bc5da">配置</a></li>
</ul>
</li>
<li><a href="#h:1cfccd4e-47c5-4958-8e34-0c6e4e2ed3b7">redis安装</a></li>
<li><a href="#h:6681cfb6-c61d-4ad8-bd14-53d110ddc6c5">豆瓣影评分析项目</a>
<ul>
<li><a href="#h:7b16c6c2-72aa-4a18-85b8-76c17469211d">抓取内容分析</a></li>
<li><a href="#h:58e3cfc4-6eac-4dff-b40b-3df381af5258">创建Scrapy项目</a></li>
<li><a href="#h:50735c64-e988-49ef-9526-05e771abd10c">配置</a></li>
<li><a href="#h:4299e44e-6b97-4ed4-9dc4-ff6d2cce18de">构建Item</a></li>
<li><a href="#h:9927269f-1583-4aff-aa07-6b78a515a757">构建爬虫</a>
<ul>
<li><a href="#h:207c4109-615b-411c-9099-bcb1d46abbbd">爬取</a></li>
<li><a href="#h:7676e9be-a7a0-4343-a7d0-f6f6c4e46aa6">手动添加开始url</a></li>
<li><a href="#h:11c4443b-c4b7-4697-b5c0-b2ae28ef308e">开启pipeline</a></li>
<li><a href="#h:dda3f708-7dce-4893-94eb-7add74a8f5a8">代理（可选）</a></li>
</ul>
</li>
<li><a href="#h:43b7b12a-fdc5-4de4-9659-c289ede5898b">分析</a>
<ul>
<li><a href="#h:f26cd8a2-bbcc-40f0-a446-15b2b60100ec">jieba分词-结巴分词</a></li>
<li><a href="#h:99ebe28f-b670-4ee6-a94a-faf1dc4dc4c5">stopword 停用词</a></li>
<li><a href="#h:adedda1f-2aea-46ff-9709-e2a20210cbc2">worlcloud词云</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Python</a></li>
</ul>
<section id="outline-container-h:43f169a4-737b-4d12-9f4e-4116bed3204b" class="outline-2">
<h2 id="h:43f169a4-737b-4d12-9f4e-4116bed3204b">概述</h2>
<div class="outline-text-2" id="text-h:43f169a4-737b-4d12-9f4e-4116bed3204b">
<p>
爬虫，应该称为网络爬虫，也叫网页蜘蛛、网络机器人、网络蚂蚁等。
</p>

<p>
搜索引擎，就是网络爬虫的应用者。
</p>

<p>
为什么到了今天，反而这个词汇被频繁的提起呢?有搜索引擎不就够了吗?
</p>

<p>
实际上，大数据时代的到了，所有的企业都希望通过海量数据发现其中的价值。
</p>

<p>
所以，需要爬取对特定网站、特定类别的数据，而搜索引擎不能提供这样的功能，因此，需要自己开发爬虫来解决。
</p>

<p>
1991年，CERN诞生第一个WWW网站。慢慢地更多的网站涌现出来来。
</p>

<p>
网站多了，不方便找。最早，人工收集各种网站分门别类组织成网页。但是不能知道这么多网站的网页中是否有关心的数据。由此，出现了爬虫程序。
</p>

<p>
爬虫是一个程序，使用HTTP协议。网站只需要提供一个网页，往往是首页，从首页开始获取有用的数据，通过首页中的链接继续探索其他页面，将这些页面内容传输给爬虫程序。
</p>

<p>
有了爬虫，就出现了雅虎这样的搜索引擎站点。后来，拉里佩奇、谢盖而布林，凭借搜索引擎算法于1998年创建了谷歌公司。
</p>


<p>
保存？
</p>
<ul class="org-ul">
<li>Hadoop 大数据 HDFS, Mapreduce, HBASE</li>
</ul>

<p>
内容分词，一篇文章所有可能关键字-&gt;这篇文章的映射  存入倒排索引库
</p>
<ul class="org-ul">
<li>solr, ElasticSearch</li>
</ul>

<p>
pagerank 算法，排名问题
</p>
</div>
<div id="outline-container-h:8c9c0136-6f27-4fed-ad05-7321982c9c20" class="outline-3">
<h3 id="h:8c9c0136-6f27-4fed-ad05-7321982c9c20">爬虫分类</h3>
<div class="outline-text-3" id="text-h:8c9c0136-6f27-4fed-ad05-7321982c9c20">
</div>
<div id="outline-container-h:0a1b3575-01c7-4bf8-a79e-889106c171da" class="outline-4">
<h4 id="h:0a1b3575-01c7-4bf8-a79e-889106c171da">1.通用爬虫</h4>
<div class="outline-text-4" id="text-h:0a1b3575-01c7-4bf8-a79e-889106c171da">
<p>
常见就是搜索引擎，无差别的搜集数据、存储、提取关键字、构建索引库，给用户提供搜索接口。
</p>

<p>
爬取一般流程
</p>
<ol class="org-ol">
<li>初始化一批URL,将这些URL放到带爬队列</li>
<li>从队列取出这些URL，通过DNS解析IP，对IP对应的站点下载HTML页面，保存到本地服务器中，爬取完的URL放到已爬取队列。</li>
<li>分析这些网页内容，找出网页里面的其他关心的URL链接，继续执行第2步，直到爬取条件结束。</li>
</ol>

<p>
搜索引擎如何获取一个网站的URL
</p>
<ol class="org-ol">
<li>新网站主动提交给搜索引擎</li>
<li>通过其他网站页面中设置的外链接</li>
<li>搜索引擎和DNS服务商合作，获取最新收录的网站</li>
</ol>
</div>
</div>
<div id="outline-container-h:8c29fde1-320f-4b25-998d-301c7c39e794" class="outline-4">
<h4 id="h:8c29fde1-320f-4b25-998d-301c7c39e794">2. 聚焦爬虫</h4>
<div class="outline-text-4" id="text-h:8c29fde1-320f-4b25-998d-301c7c39e794">
<p>
有针对性的编写特定领域数据的爬取程序，针对某些类别数据采集的爬虫，是面向主题的爬虫
</p>
</div>
</div>
</div>
<div id="outline-container-h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da" class="outline-3">
<h3 id="h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da">Robots协议</h3>
<div class="outline-text-3" id="text-h:09c4be0e-15c0-4d32-a1f7-2c743a11f2da">
<p>
指定一个robots.txt文件，告诉爬虫引擎什么可以爬取
</p>

<ul class="org-ul">
<li>/ 表示网站根目录，表示网站所有目录。</li>
<li>Allow 允许爬取的目录</li>
<li>Disallow 禁止爬取的目录</li>
<li>可以使用通配符</li>
</ul>

<p>
robots是一个君子协定，"爬亦有道"
这个协议为了让搜索引擎更有效率搜索自己内容，提供了Sitemap这样的文件。Sitemap往往是一个XML文件，提供了网站想让大家爬取的内容的更新信息。<br>
这个文件禁止爬取的往往又是可能我们感兴趣的内容，反而泄露了这些地址。
</p>

<p>
示例：淘宝的robots<a href="http://www.taobao.com/robots.txt">http://www.taobao.com/robots.txt</a>
</p>

<div class="org-src-container">
<pre class="src src-txt">User-agent:  Baiduspider
Allow:  /article
Allow:  /oshtml
Allow:  /ershou
Allow: /$
Disallow:  /product/
Disallow:  /

User-Agent:  Googlebot
Allow:  /article
Allow:  /oshtml
Allow:  /product
Allow:  /spu
Allow:  /dianpu
Allow:  /oversea
Allow:  /list
Allow:  /ershou
Allow: /$
Disallow:  /

User-agent:  Bingbot
Allow:  /article
Allow:  /oshtml
Allow:  /product
Allow:  /spu
Allow:  /dianpu
Allow:  /oversea
Allow:  /list
Allow:  /ershou
Allow: /$
Disallow:  /

User-Agent:  360Spider
Allow:  /article
Allow:  /oshtml
Allow:  /ershou
Disallow:  /

User-Agent:  Yisouspider
Allow:  /article
Allow:  /oshtml
Allow:  /ershou
Disallow:  /

User-Agent:  Sogouspider
Allow:  /article
Allow:  /oshtml
Allow:  /product
Allow:  /ershou
Disallow:  /

User-Agent:  Yahoo!  Slurp
Allow:  /product
Allow:  /spu
Allow:  /dianpu
Allow:  /oversea
Allow:  /list
Allow:  /ershou
Allow: /$
Disallow:  /

User-Agent:  *
Disallow:  /
</pre>
</div>

<p>
示例马蜂窝tobots<a href="http://www.mafengwo.cn/robots.txt">http://www.mafengwo.cn/robots.txt</a>
</p>

<div class="org-src-container">
<pre class="src src-txt">User-agent: *
Disallow: /
Disallow: /poi/detail.php

Sitemap: http://www.mafengwo.cn/sitemapIndex.xml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2c098648-38c9-4c35-b55f-babdf7ef491f" class="outline-3">
<h3 id="h:2c098648-38c9-4c35-b55f-babdf7ef491f">法律知识</h3>
<div class="outline-text-3" id="text-h:2c098648-38c9-4c35-b55f-babdf7ef491f">
<p>
中国爬虫违法违规案例汇总: <a href="https://github.com/HiddenStrawberry/Crawler_Illegal_Cases_In_China">https://github.com/HiddenStrawberry/Crawler_Illegal_Cases_In_China</a>
</p>


<p>
<b>单位犯罪和个人犯罪的关系</b>
</p>

<p>
首先了解一下单位犯罪。除了自然人犯罪，还有单位犯罪，是指公司、企业、事业单位、机关、团体为单位谋取不利益，经单位决策机构或者负责人决定实施的，法律规定应当负刑事责任的危害社会的行行为。
</p>

<p>
我国刑法对单位犯罪原则上采取双罚制度，即单位犯罪的为，对单位判处罚金，并对其直接负责的主管人员和其他直接责任人员判处刑罚。相关司法解释规定，在审理单位故意犯罪案件时，对其直接负责的主管人员和其他直接责任人员，可不区分主犯、从犯，按照其在单位犯罪中所起的作用判处刑罚。
</p>

<p>
因此，公司犯罪有可能会牵连员工，尤其是案件中对非法获取数据有直接责任的爬虫工程师。这也是为什么当事人在公公司人小言微但还是被批捕的原因。
</p>

<p>
其次，是否可以"不知者不为罪"来辩解?刑法原则之一是法无明文规定不为罪，并没有"不知者不为罪"。主观上的恶意是衡量犯罪的要素之一，结合客观上的行为来推理主观恶意。破解别人的服务器，获取别人不公开的信息，不能说没有恶意，不能以不懂法来糖塞。
</p>

<p>
<b>重点: 什么样的爬虫是违法?</b>
</p>

<p>
如果爬虫程序采集到公民的姓名、身份证件号码、通信通讯取关系方式、住址、账号密码、财产状况、行踪轨迹等个人信息，并将之用于非法途径的，则肯定构成非法获取公民个人信息的违法行为。
</p>

<p>
除此之外，根据相关规定，对于违反国家有关规定，向他人出售或者提供公民个人信息，情节严重的，窃取或者以其他方法非法获取公民个人信息的，均可构成成"侵犯公民个人信息罪"，处三年以下有期徒刑或者拘役，并处或者单处罚金;情节特别严重的，处三年以上七年以下有期徒刑，并处罚金。
</p>

<p>
重点关注:下列情况下，爬虫有可能违法，严重的甚甚至构成犯罪。
</p>
<ul class="org-ul">
<li>爬虫程序规避网站经营者设置的反爬虫措施或者破解服务器防抓取措施，非法获取相关信息，情节严重的，有可能能构成"非法获取计算机信息系统数据罪"。</li>
<li>爬虫程序干扰被访问的网站或系统正常运营，后果严重的，触犯刑法，构成"破坏计算机信息系统罪"</li>
<li>爬虫采集的信息属于公民个人信息的，有可能构成非法获取公民个人信息的违法行为，情节严重的，有可能构成"侵犯公民个人信息罪"。</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:71806a2a-6d96-46d1-ac19-65115c660df6" class="outline-2">
<h2 id="h:71806a2a-6d96-46d1-ac19-65115c660df6">HTTP请求和响应处理</h2>
<div class="outline-text-2" id="text-h:71806a2a-6d96-46d1-ac19-65115c660df6">
<p>
其实爬取网页就是通过HTTP协议访问网页，不过通过浏览器反问往往是人的行为，把这种行为变成使用程序来访问。
</p>
</div>
<div id="outline-container-h:67f4c161-aec6-49d3-be64-d83915a3c7ef" class="outline-3">
<h3 id="h:67f4c161-aec6-49d3-be64-d83915a3c7ef">urllib包</h3>
<div class="outline-text-3" id="text-h:67f4c161-aec6-49d3-be64-d83915a3c7ef">
<p>
urllib是标准库，它一个工具包模块，包含下面模块来处理url: 
</p>
<ul class="org-ul">
<li>urllib.request 用于打开和读写url</li>
<li>urllib.error 包含了由urllib.request引起的异常</li>
<li>urllib.parse 用于解析url</li>
<li>urllib.robotparser 分析robots.txt文件</li>
</ul>

<p>
Python2中提供了urllib和urllib2。urllib提供较为底层的接口，urllib2对urllib进行了进一步封装。
</p>

<p>
Python3中将urllib合并到了urllib2中，并更名为标准库urllib包。
</p>
</div>
<div id="outline-container-h:9df4c633-a584-416f-8eb6-941240690a6d" class="outline-4">
<h4 id="h:9df4c633-a584-416f-8eb6-941240690a6d">urllib.request模块</h4>
<div class="outline-text-4" id="text-h:9df4c633-a584-416f-8eb6-941240690a6d">
<p>
模块定义了在基本和摘要式身份验证、重定向、cookies等应用中打开Url(主要是HTTP)的函数和类。
</p>
</div>
<div id="outline-container-h:ecd703fa-1727-4078-a768-87546c280c7b" class="outline-5">
<h5 id="h:ecd703fa-1727-4078-a768-87546c280c7b">urlopen方法</h5>
<div class="outline-text-5" id="text-h:ecd703fa-1727-4078-a768-87546c280c7b">
<p>
<code>urlopen(url,data=None)</code>
</p>
<ul class="org-ul">
<li>url是链接地址字符串，或请求类的实例</li>
<li>data提交的数据，如果data为Non发起的 <b>GET</b> 请求，否则发起 <b>POST</b> 请求。见 <code>urllib.request.Request#get_method</code></li>
<li>返回http.client.HTTPResponse类的相遇对象，这是一个类文件对象。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> urlopen
<span style="color: #a020f0;">from</span> http.client <span style="color: #a020f0;">import</span> HTTPResponse <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24456;&#31616;&#38475;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">request &#21457;&#36215;&#35831;&#27714;&#37117;&#21644;&#23427;&#26377;&#20851;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">urlopen(url, data=None) # data&#19981;&#20026;None&#23601;&#26159;POST&#35831;&#27714;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#19968;&#20010;url&#36820;&#22238;&#19968;&#20010;&#30456;&#24212;&#23545;&#35937;&#65292;&#31867;&#25991;&#20214;&#23545;&#35937;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#38754;&#38142;&#25509;&#35775;&#38382;&#21518;&#20250;&#26377;&#36339;&#36716;</span>
<span style="color: #a0522d;">response</span>:<span style="color: #228b22;">HTTPResponse</span> = urlopen(<span style="color: #8b2252;">'https://www.bing.com'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">request -&gt; response GET</span>

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response), response) <span style="color: #b22222;">#</span><span style="color: #b22222;">http.client.HTTPResponse&#31867;&#25991;&#20214;&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(response.status, response.reason) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29366;&#24577; 200 OK</span>
    <span style="color: #483d8b;">print</span>(response.headers)  <span style="color: #b22222;"># </span><span style="color: #b22222;">response.headers &#21644; response.info()&#26159;&#19968;&#20010;&#19996;&#35199;</span>
    <span style="color: #483d8b;">print</span>(response.geturl())  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#30495;&#27491;&#30340;URL 301 302 &#37325;&#23450;&#21521;&#21518;&#30340;url https://cn.bing.com/</span>
    <span style="color: #483d8b;">print</span>(response.read()) <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes -&gt; str?</span>

<span style="color: #483d8b;">print</span>(response.isclosed())
<span style="color: #483d8b;">print</span>(response.closed)
</pre>
</div>


<p>
上例，通过urllib.request.urlopen方法，发起一个HTTP的GET请求，WEB服务器返回了网页内容。
</p>

<p>
响应的数据被封装到类文件对象中，可以通过read方法、readline方法、readlines方法获取数据，status和reason属性表示返回的状态码，info方法返回头信息，等等。
</p>

<p>
注意url的变化，说明重定向过。
</p>
</div>
</div>
<div id="outline-container-h:3e8c98f8-b214-4e00-8869-0987739541a9" class="outline-5">
<h5 id="h:3e8c98f8-b214-4e00-8869-0987739541a9">User-Agent问题</h5>
<div class="outline-text-5" id="text-h:3e8c98f8-b214-4e00-8869-0987739541a9">
<p>
上例代码非常精简，即可以获得网站的响应数据。但目前urlopen方法通过url字符串和data发起HTTP的请求。如果想修改HTTP头，例如useragent,就的借助其他方式。
</p>

<p>
原码中构造的useragen如下：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">urllib.request.OpenerDirector</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">OpenerDirector</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">client_version</span> = <span style="color: #8b2252;">"Python-urllib/%s"</span> % __version__
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">addheaders</span> = [(<span style="color: #8b2252;">'User-agent'</span>, client_version)]
</pre>
</div>

<p>
当前显示为Python-urlib/3.13
</p>

<p>
有些网站是反爬虫的，所以要把爬虫伪装成浏览器。顺便打开一个浏览器，复制李立群的UA值，用来伪装。
</p>

<p>
<a href="https://httpbin.org/#/HTTP_Methods/get_get">https://httpbin.org/#/HTTP_Methods/get_get</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> urlopen

<span style="color: #a020f0;">from</span> http.client <span style="color: #a020f0;">import</span> HTTPResponse <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24456;&#31616;&#38475;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">request &#21457;&#36215;&#35831;&#27714;&#37117;&#21644;&#23427;&#26377;&#20851;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">urlopen(url, data=None) # data&#19981;&#20026;None&#23601;&#26159;POST&#35831;&#27714;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#29228;&#34411;&#26368;&#31616;&#21333;&#30340;&#26041;&#24335;&#65292;&#36890;&#29992;user-agent&#35299;&#35835;&#12289;&#36890;&#36807;&#34892;&#20026;&#21028;&#26029;&#65288;&#27491;&#24120;&#20154;&#19981;&#21487;&#33021;&#28857;&#37027;&#20040;&#24555;&#65289;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#20266;&#35013;</span>
<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">site = 'https://www.bing.com'</span>
<span style="color: #a0522d;">site</span> = <span style="color: #8b2252;">'https://httpbin.org/get'</span>
<span style="color: #a0522d;">response</span>:<span style="color: #228b22;">HTTPResponse</span> = urlopen(site) <span style="color: #b22222;"># </span><span style="color: #b22222;">request -&gt; response GET</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;request&#35831;&#27714;&#26102;&#37117;&#20250;&#24102;&#19978;</span>
<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response), response) <span style="color: #b22222;">#</span><span style="color: #b22222;">http.client.HTTPResponse&#31867;&#25991;&#20214;&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(response.status, response.reason) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29366;&#24577; 200 OK</span>
    <span style="color: #483d8b;">print</span>(response.headers)  <span style="color: #b22222;"># </span><span style="color: #b22222;">response.headers &#21644; response.info()&#26159;&#19968;&#20010;&#19996;&#35199;</span>
    <span style="color: #483d8b;">print</span>(response.geturl())  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#30495;&#27491;&#30340;URL 301 302 &#37325;&#23450;&#21521;&#21518;&#30340;url</span>
    <span style="color: #483d8b;">print</span>(response.read()) <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes -&gt; str?</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35831;&#27714;&#22836; "User-Agent": "Python-urllib/3.13"</span>

<span style="color: #483d8b;">print</span>(response.isclosed())
<span style="color: #483d8b;">print</span>(response.closed)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6764bce3-3fd3-4ecb-952a-f42a9175b634" class="outline-5">
<h5 id="h:6764bce3-3fd3-4ecb-952a-f42a9175b634">Request类</h5>
<div class="outline-text-5" id="text-h:6764bce3-3fd3-4ecb-952a-f42a9175b634">
<p>
<code>Request(url,data=None,headers={})</code>
</p>
<ul class="org-ul">
<li>初始化方法，构造一个请求对象。</li>
<li>可添加一个header的字典。</li>
<li>data参数决定是GET还是POST请求，参看Request.get_method()方法</li>
<li><code>obj.add_header(key,val)</code> 为header增加一个键值对。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> urlopen, Request
<span style="color: #a020f0;">from</span> http.client <span style="color: #a020f0;">import</span> HTTPResponse <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24456;&#31616;&#38475;</span>
<span style="color: #a020f0;">import</span> random


<span style="color: #b22222;"># </span><span style="color: #b22222;">request &#21457;&#36215;&#35831;&#27714;&#37117;&#21644;&#23427;&#26377;&#20851;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">urlopen(url, data=None) # data&#19981;&#20026;None&#23601;&#26159;POST&#35831;&#27714;</span>

<span style="color: #a0522d;">site</span> = <span style="color: #8b2252;">'https://www.bing.com'</span>
<span style="color: #a0522d;">site</span> = <span style="color: #8b2252;">'https://httpbin.org/get'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#29228;&#34411;&#26368;&#31616;&#21333;&#30340;&#26041;&#24335;&#65292;&#36890;&#29992;user-agent&#35299;&#35835;&#12289;&#36890;&#36807;&#34892;&#20026;&#21028;&#26029;&#65288;&#27491;&#24120;&#20154;&#19981;&#21487;&#33021;&#28857;&#37027;&#20040;&#24555;&#65289;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#20266;&#35013;</span>
<span style="color: #a0522d;">ua_list</span> = [
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">chrome</span>
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">safafi</span>
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:50.0) Gecko/20100101 Firefox/50.0"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">Firefox</span>
    <span style="color: #8b2252;">"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">IE</span>
]

<span style="color: #a0522d;">ua</span> = random.choice(ua_list)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26500;&#36896;request&#23545;&#35937;</span>
<span style="color: #a0522d;">request</span> = Request(site)
request.add_header(<span style="color: #8b2252;">'User-Agent'</span>, ua) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24456;&#37325;&#35201;&#65292;&#36890;&#36807;&#23427;&#21487;&#20197;&#23545;&#31227;&#21160;&#31471;&#20570;&#20986;&#26356;&#21451;&#22909;&#30340;&#20307;&#39564; Native App, Web App http&#35831;&#27714;</span>

<span style="color: #a0522d;">response</span>:<span style="color: #228b22;">HTTPResponse</span> = urlopen(request, timeout=20) <span style="color: #b22222;"># </span><span style="color: #b22222;">request&#23545;&#35937;&#25110;&#32773;url&#37117;&#21487;&#20197;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;request&#35831;&#27714;&#26102;&#37117;&#20250;&#24102;&#19978;</span>
<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response), response) <span style="color: #b22222;">#</span><span style="color: #b22222;">http.client.HTTPResponse&#31867;&#25991;&#20214;&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(response.status, response.reason) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29366;&#24577; 200 OK</span>
    <span style="color: #483d8b;">print</span>(response.headers)  <span style="color: #b22222;"># </span><span style="color: #b22222;">response.headers &#21644; response.info()&#26159;&#19968;&#20010;&#19996;&#35199;</span>
    <span style="color: #483d8b;">print</span>(response.geturl())  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#30495;&#27491;&#30340;URL 301 302 &#37325;&#23450;&#21521;&#21518;&#30340;url</span>
    <span style="color: #483d8b;">print</span>(response.read()) <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes -&gt; str?</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35831;&#27714;&#22836; "User-Agent": "Python-urllib/3.13"</span>


<span style="color: #483d8b;">print</span>(response.isclosed())
<span style="color: #483d8b;">print</span>(response.closed)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:105dbd3f-e6cf-4c86-b867-cd3564e269dc" class="outline-4">
<h4 id="h:105dbd3f-e6cf-4c86-b867-cd3564e269dc">urllib.parse模块</h4>
<div class="outline-text-4" id="text-h:105dbd3f-e6cf-4c86-b867-cd3564e269dc">
<p>
该模块可以完成对url的编解码
</p>

<ol class="org-ol">
<li>parse.urlencode({key:value}) #对查询字符串进行编码</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a0522d;">u</span> = parse.urlencode({
    <span style="color: #8b2252;">"url"</span>:<span style="color: #8b2252;">"http://www.xx.com/python"</span>,
    <span style="color: #8b2252;">"p_url"</span>:<span style="color: #8b2252;">"http://www.xx.com/python?id=1&amp;name=&#24352;&#19977;"</span>
})
<span style="color: #483d8b;">print</span>(u)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36816;&#34892;&#32467;&#26524;</span>
<span style="color: #a0522d;">url</span>=http%3A%2F%2Fwww.xx.com%2Fpython&amp;<span style="color: #a0522d;">p_url</span>=http%3A%2F%2Fwww.xx.com%2Fpython%3Fid%3D1%26name%3D%E5%BC%A0%E4%B8%89
</pre>
</div>

<p>
从运行结果来看冒号、斜杠、&amp;、等号、问号等符号全部被编码了，%之后实际上是单字节十六进制表示的值。
</p>

<p>
一般来说url中的地址部分，一般不需要使用中文路径，但是参数部分，不管GET还是POST方法，提交的数据中，可能有斜杆、等号、问号等符号，这样这些字符表示数据，不表示元字符。如果直接发给服务器端，就会导致接收方无法判断谁是元字符，谁是数据了。为了安全，一般会将数据部分的字符做url编码，这样就不会有歧义了。
</p>

<p>
后来可以传送中文，同样会做编码，一般先按照字符集的encoding要求转换成字节序列，每一个字节对应的十六进制字符串前加上百分号即可。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#39029;&#38754;&#20351;&#29992;utf-8&#32534;&#30721;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.baidu.com/s?wd=&#20013;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#38754;&#30340;url&#32534;&#30721;&#21518;&#65292;&#22914;&#19979;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.baidu.com/s?wd=%E4%B8%AD</span>

<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a0522d;">u</span> = parse.urlencode({<span style="color: #8b2252;">"wd"</span>:<span style="color: #8b2252;">"&#20013;"</span>}) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#30721;</span>
<span style="color: #a0522d;">url</span>= <span style="color: #8b2252;">"https://www.baidu.com/s?{}"</span>.<span style="color: #483d8b;">format</span>(u)
<span style="color: #483d8b;">print</span>(url)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#20013;"</span>.encode(<span style="color: #8b2252;">"utf-8"</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">b'xe4\xb8\xad'</span>
<span style="color: #483d8b;">print</span>(parse.unquote(u)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#30721;</span>
<span style="color: #483d8b;">print</span>(parse.unquote(url))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d" class="outline-3">
<h3 id="h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d">提交方法method</h3>
<div class="outline-text-3" id="text-h:efb48d46-7a70-4b3b-b622-f8d1ee235e7d">
<p>
常用的HTTP交互数据的方法是GET、POST
</p>

<ol class="org-ol">
<li>GET方法，数据是通过URL传递的，也就是说数据是在HTTP报文的header部分。</li>
<li>POST方法，数据是放在HTTP报文的body部分提交的。</li>
<li>数据是键值对形式，多个参数质检使用&amp;符号链接。例如a=1&amp;b=abc</li>
</ol>
</div>
<div id="outline-container-h:2fa09768-b387-4f3d-acf8-fbb88dbf447e" class="outline-4">
<h4 id="h:2fa09768-b387-4f3d-acf8-fbb88dbf447e">GET方法</h4>
<div class="outline-text-4" id="text-h:2fa09768-b387-4f3d-acf8-fbb88dbf447e">
<p>
链接 <code>必应</code> 搜索引擎官网，获取一个搜索的URL <code>http://cn.bing.com/search?q=jasper</code>
</p>

<p>
需求
</p>
<ul class="org-ul">
<li>请写程序完成对关键字bing搜索，将返回的结果保存到一个网页文件。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request, urlopen
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a0522d;">baseurl</span> = <span style="color: #8b2252;">'https://cn.bing.com/search'</span>
<span style="color: #a0522d;">params</span> = parse.urlencode({
    <span style="color: #8b2252;">'q'</span>:<span style="color: #8b2252;">'jasper'</span>
})
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}?{}"</span>.<span style="color: #483d8b;">format</span>(baseurl, params)
<span style="color: #483d8b;">print</span>(url)

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>

<span style="color: #a0522d;">request</span> = Request(url, headers={<span style="color: #8b2252;">'user-agent'</span>:ua})
<span style="color: #a020f0;">with</span> urlopen(request) <span style="color: #a020f0;">as</span> response:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.read())</span>
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/a.html'</span>, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.read())
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba7b0e62-fa76-45c2-874e-5affab70c5be" class="outline-4">
<h4 id="h:ba7b0e62-fa76-45c2-874e-5affab70c5be">POST方法</h4>
<div class="outline-text-4" id="text-h:ba7b0e62-fa76-45c2-874e-5affab70c5be">
<p>
测试网站
</p>
<ul class="org-ul">
<li><a href="https://httpbin.org/#/HTTP_Methods/post_post">https://httpbin.org/#/HTTP_Methods/post_post</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request, urlopen
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse
<span style="color: #a020f0;">import</span> simplejson

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://httpbin.org/post'</span>
<span style="color: #a0522d;">params</span> = parse.urlencode({
    <span style="color: #8b2252;">'q'</span>:<span style="color: #8b2252;">'jasper'</span>
})

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>

<span style="color: #a0522d;">request</span> = Request(url, headers={
    <span style="color: #8b2252;">'X-REQUEST'</span>:<span style="color: #8b2252;">'CICI'</span>,
    <span style="color: #8b2252;">'user-agent'</span>:ua
})

<span style="color: #a020f0;">with</span> urlopen(request, params.encode(<span style="color: #8b2252;">'utf-8'</span>)) <span style="color: #a020f0;">as</span> response:
    <span style="color: #483d8b;">print</span>(simplejson.loads(response.read()))
</pre>
</div>

<p>
执行结果
</p>
<div class="org-src-container">
<pre class="src src-python">{
    <span style="color: #8b2252;">'args'</span>: {

    },
    <span style="color: #8b2252;">'data'</span>: <span style="color: #8b2252;">''</span>,
    <span style="color: #8b2252;">'files'</span>: {

    },
    <span style="color: #8b2252;">'form'</span>: {
        <span style="color: #8b2252;">'q'</span>: <span style="color: #8b2252;">'jasper'</span>
    },
    <span style="color: #8b2252;">'headers'</span>: {
        <span style="color: #8b2252;">'Accept-Encoding'</span>: <span style="color: #8b2252;">'identity'</span>,
        <span style="color: #8b2252;">'Content-Length'</span>: <span style="color: #8b2252;">'8'</span>,
        <span style="color: #8b2252;">'Content-Type'</span>: <span style="color: #8b2252;">'application/x-www-form-urlencoded'</span>,
        <span style="color: #8b2252;">'Host'</span>: <span style="color: #8b2252;">'httpbin.org'</span>,
        <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0(WindowsNT10.0;Win64;x64)AppleWebKit/537.36(KHTML,</span>
<span style="color: #8b2252;">        likeGecko)Chrome/138.0.0.0Safari/537.36'</span>,
        <span style="color: #8b2252;">'X-Amzn-Trace-Id'</span>: <span style="color: #8b2252;">'Root=1-68932b41-6306d8875659ae8129ecb0ad'</span>,
        <span style="color: #8b2252;">'X-Request'</span>: <span style="color: #8b2252;">'CICI'</span>
    },
    <span style="color: #8b2252;">'json'</span>: <span style="color: #008b8b;">None</span>,
    <span style="color: #8b2252;">'origin'</span>: <span style="color: #8b2252;">'101.71.195.151'</span>,
    <span style="color: #8b2252;">'url'</span>: <span style="color: #8b2252;">'https: //httpbin.org/post'</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2382eb7c-e980-4563-a867-dc031a88b933" class="outline-4">
<h4 id="h:2382eb7c-e980-4563-a867-dc031a88b933">处理JSON数据</h4>
<div class="outline-text-4" id="text-h:2382eb7c-e980-4563-a867-dc031a88b933">
<p>
XMLHttpRequest（简称xhr），是浏览器提供的JS对象，通过它可以请求到服务器上的数据资源。
</p>

<p>
访问：<a href="https://movie.douban.com/">https://movie.douban.com/</a> 查看“豆瓣电影”,中的热门电影, 通过分析，我们知道这部分内容，是通过AJAX从后台拿到的JSON数据并插入到网页。
</p>
<ul class="org-ul">
<li>浏览器F12，过滤XHR，js请求返回json数据。如
<ul class="org-ul">
<li><a href="https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=50&amp;page_start=0">https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=50&amp;page_start=0</a>
<ul class="org-ul">
<li><code>%E7%83%AD%E9%97%A8</code> 是utf-8编码的中文”热门”</li>
<li>tag 标签”热门”，表示热门电影</li>
<li>type 数据类型，movie是电影</li>
<li>page_limit表示返回数据的总数</li>
<li>page_start 表示数据偏移</li>
</ul></li>
</ul></li>
</ul>

<p>
服务器返回json数据如下(略，轮播组件，共50条数据)
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request, urlopen
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse
<span style="color: #a020f0;">import</span> json

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://httpbin.org/post'</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://movie.douban.com/j/search_subjects'</span>
<span style="color: #a0522d;">params</span> = parse.urlencode({
    <span style="color: #8b2252;">"tag"</span>:<span style="color: #8b2252;">"&#28909;&#38376;"</span>,
    <span style="color: #8b2252;">"type"</span>: <span style="color: #8b2252;">"movie"</span>,
    <span style="color: #8b2252;">"page_limit"</span>: 5,
    <span style="color: #8b2252;">"page_start"</span>: 0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20559;&#31227;</span>

})

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}?{}"</span>.<span style="color: #483d8b;">format</span>(url, params)

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">POST</span>
<span style="color: #a0522d;">request</span> = Request(url, headers={
    <span style="color: #8b2252;">'user-agent'</span>:ua
})
<span style="color: #a020f0;">with</span> urlopen(request, params.encode(<span style="color: #8b2252;">'utf-8'</span>)) <span style="color: #a020f0;">as</span> response:  <span style="color: #b22222;"># </span><span style="color: #b22222;">urlopen(url, data) data&#19981;&#20026;None&#23601;&#26159;POST&#35831;&#27714;</span>
    <span style="color: #483d8b;">print</span>(response.status, response.reason, <span style="color: #8b2252;">'++++'</span>)
    <span style="color: #a0522d;">j</span> = json.loads(response.read())
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">len</span>(j[<span style="color: #8b2252;">'subjects'</span>]))
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b" class="outline-3">
<h3 id="h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b">HTTPS证书忽略</h3>
<div class="outline-text-3" id="text-h:7372ddc4-b3fa-43cb-88fd-29ab797d0e2b">
<p>
HTTPS使用SSL安全套层协议，在传输层对网络数据进行加密。HTTPS使用的时候需要证书，而证书需要CA认证。
</p>

<p>
CA(Certificate Authority)是数字证书认证中心的简称，是指发放、管理、废除数字证书的机构。
</p>

<p>
CA是受信任的第三方，有CA签发的证书具有可信任。如果用户由于信任了CA签发的证书导致的损失，可以追究CA的法律责任。
</p>

<p>
CA是层级结构，下级CA信任上级CA,且有上级CA颁发给下级CA证书并认证。
</p>

<p>
一些网站，例如淘宝，使用HTTPS加密数据更加安全。
</p>

<p>
以前旧版本12306网站需要下载证书
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen

<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("http://www.12306.cn/mormhweb/") #&#21487;&#20197;&#35775;&#38382;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("https://www.baidu.com/") #&#21487;&#20197;&#35775;&#38382;</span>

<span style="color: #a0522d;">request</span> = Request(<span style="color: #8b2252;">"https://www.12306.cn/mormhweb/"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#26412;&#25253;SSL&#35748;&#35777;&#24322;&#24120;</span>
request.add_header(
    <span style="color: #8b2252;">"User-agent"</span>,
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">ssl.CertificateError: hostname 'www.12306.cn' doesn't match either of ......</span>
<span style="color: #a020f0;">with</span> urlopen(request) <span style="color: #a020f0;">as</span> res:
    <span style="color: #483d8b;">print</span>(res._method)
    <span style="color: #483d8b;">print</span>(res.read())
</pre>
</div>

<p>
通过HTTPS访问12306的时候，失败的原因在于12306的证书未通过CA认证，1它是自己生成的证书，不可信。而其它网站访问，如<a href="https://www.baidu.com/%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%8F%90%E7%A4%BA%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E5%AE%83%E7%9A%84%E8%AF%81%E4%B9%A6%E7%9A%84%E5%8F%91%E8%A1%8C%E8%80%85%E5%8F%97%E4%BF%A1%E4%BB%BB%EF%BC%8C%E4%B8%94%E6%97%A9%E5%B0%B1%E5%AD%98%E5%82%A8%E5%9C%A8%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E4%B8%AD">https://www.baidu.com/%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%8F%90%E7%A4%BA%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E5%AE%83%E7%9A%84%E8%AF%81%E4%B9%A6%E7%9A%84%E5%8F%91%E8%A1%8C%E8%80%85%E5%8F%97%E4%BF%A1%E4%BB%BB%EF%BC%8C%E4%B8%94%E6%97%A9%E5%B0%B1%E5%AD%98%E5%82%A8%E5%9C%A8%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E4%B8%AD</a>。
</p>

<p>
现在12306证书是可信机构颁发的了。
</p>

<p>
遇到这种问题，解决思路：忽略证书不安全信息
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> urllib.request <span style="color: #a020f0;">import</span> Request,urlopen
<span style="color: #a020f0;">import</span> ssl <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;ssl&#27169;&#22359;</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("http://www.12306.cn/mormhweb/") #&#21487;&#20197;&#35775;&#38382;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">request = Request("https://www.baidu.com/") #&#21487;&#20197;&#35775;&#38382;</span>

<span style="color: #a0522d;">request</span> = Request(<span style="color: #8b2252;">"https://www.12306.cn/mormhweb/"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#26412;&#25253;SSL&#35748;&#35777;&#24322;&#24120;</span>
request.add_header(
    <span style="color: #8b2252;">"User-agent"</span>,
    <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24573;&#30053;&#19981;&#20449;&#20219;&#30340;&#35777;&#20070;</span>
<span style="color: #a0522d;">context</span> = ssl._create_unverified_context()
<span style="color: #a0522d;">res</span> = urlopen(request,context=context)

<span style="color: #b22222;"># </span><span style="color: #b22222;">ssl.CertificateError: hostname 'www.12306.cn' doesn't match either of ......</span>
<span style="color: #a020f0;">with</span> res:
    <span style="color: #483d8b;">print</span>(res._method)
    <span style="color: #483d8b;">print</span>(res.geturl())
    <span style="color: #483d8b;">print</span>(res.read().decode())
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a9ad48b9-d19f-4761-9e40-2788c839e14b" class="outline-3">
<h3 id="h:a9ad48b9-d19f-4761-9e40-2788c839e14b">urllib3库</h3>
<div class="outline-text-3" id="text-h:a9ad48b9-d19f-4761-9e40-2788c839e14b">
<p>
<a href="https://urllib3.readthedocs.io/en/latest/">https://urllib3.readthedocs.io/en/latest/</a>
</p>

<p>
标准库urlib缺少了一些关键的功能，非标准库的第三方库urllib3提供了，比如说连接池管理。
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install urllib3
</pre>
</div>

<p>
测试一下网站访问，<a href="https://movie.douban.com">https://movie.douban.com</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> urllib3
<span style="color: #a020f0;">from</span> urllib3 <span style="color: #a020f0;">import</span> PoolManager, HTTPResponse

<span style="color: #b22222;"># </span><span style="color: #b22222;">pool = PoolManager() # http &#23545;&#35937;</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://movie.douban.com/'</span>
<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>

<span style="color: #a020f0;">with</span> PoolManager() <span style="color: #a020f0;">as</span> http:
    <span style="color: #a0522d;">res</span>:<span style="color: #228b22;">HTTPResponse</span> = http.request(<span style="color: #8b2252;">'GET'</span>,url, headers={
        <span style="color: #8b2252;">'user-agent'</span>:ua
    })
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(res), res)</span>
    <span style="color: #483d8b;">print</span>(res.status, res.reason)
    <span style="color: #483d8b;">print</span>(res.headers)
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/a.html'</span>, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(res.data)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0b5a6eed-ce46-4946-8a07-3856f717957e" class="outline-3">
<h3 id="h:0b5a6eed-ce46-4946-8a07-3856f717957e">requests库**</h3>
<div class="outline-text-3" id="text-h:0b5a6eed-ce46-4946-8a07-3856f717957e">
<p>
requests使用了urllib3,但是API更加友好，推荐使用。
</p>

<p>
很多人做爬虫时基本都用requests，前面讲的都是基本原理，底层实现。
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install requests
</pre>
</div>

<p>
测试一下网站访问，<a href="https://movie.douban.com">https://movie.douban.com</a>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36"</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://movie.douban.com/"</span>

<span style="color: #a0522d;">response</span> = requests.request(<span style="color: #8b2252;">"GET"</span>,url,headers={<span style="color: #8b2252;">"User-Agent"</span>:ua})

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response))
    <span style="color: #483d8b;">print</span>(response.url)
    <span style="color: #483d8b;">print</span>(response.status_code)
    <span style="color: #483d8b;">print</span>(response.request.headers) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#22836;</span>
    <span style="color: #483d8b;">print</span>(response.headers) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21709;&#24212;&#22836;</span>
    response.<span style="color: #a0522d;">encoding</span> = <span style="color: #8b2252;">"utf-8"</span>
    <span style="color: #483d8b;">print</span>(response.text[:200]) <span style="color: #b22222;">#</span><span style="color: #b22222;">HTML&#30340;&#20869;&#23481;</span>
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/movie.html'</span>,<span style="color: #8b2252;">"w"</span>,encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.text)
</pre>
</div>

<p>
requests默认使用Session对象，是为了多次和服务器端交互中保留会话的信息，例如：cookie。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#20351;&#29992;Session</span>
<span style="color: #a020f0;">import</span> requests

<span style="color: #b22222;"># </span><span style="color: #b22222;">pool = PoolManager() # http &#23545;&#35937;</span>
<span style="color: #a0522d;">base_url</span> = <span style="color: #8b2252;">'https://movie.douban.com/'</span>
<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#21516;&#19968;&#20010;&#20250;&#35805;&#37324;&#21457;&#36215;2&#27425;&#35831;&#27714;</span>
<span style="color: #a020f0;">with</span> requests.Session() <span style="color: #a020f0;">as</span> session:
    <span style="color: #a020f0;">for</span> url <span style="color: #a020f0;">in</span> [base_url, base_url]:
        <span style="color: #a0522d;">response</span> = session.get(base_url, headers={<span style="color: #8b2252;">'user-agent'</span>:ua})
        <span style="color: #b22222;"># </span><span style="color: #b22222;">response = requests.get(base_url, headers={'user-agent': ua}) #&#35266;&#23519;&#20004;&#31181;&#26041;&#24335;&#21306;&#21035;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(response), response)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.__enter__())</span>

        <span style="color: #a020f0;">with</span> response:
            <span style="color: #483d8b;">print</span>(response.status_code, response.reason)
            <span style="color: #483d8b;">print</span>(response.encoding)
            <span style="color: #483d8b;">print</span>(response.cookies)
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
            <span style="color: #483d8b;">print</span>(*response.request.headers.items(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(*response.headers.items(), sep='\n')</span>

            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.content) # &#20869;&#23481; html&#25991;&#26412; bytes</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.text)  # &#20869;&#23481; html&#25991;&#26412;, content + encoding</span>
</pre>
</div>

<p>
使用session访问，第二次带上了cookie
</p>
</div>
</div>
</section>
<section id="outline-container-h:93950bd9-2429-4fa5-8823-10fe7bac3876" class="outline-2">
<h2 id="h:93950bd9-2429-4fa5-8823-10fe7bac3876">HTML解析-Xpath</h2>
<div class="outline-text-2" id="text-h:93950bd9-2429-4fa5-8823-10fe7bac3876">
<p>
HTML的内容返回给浏览器，浏览器就会解析它，并对它渲染。
</p>

<p>
HTML超文本表示语言，设计的初衷就是为了超越普通文本，让文本表现力更强。
</p>

<p>
XML扩展标记语言，不是为了替代HTML，而是觉得HTML的设计中包含了过多的格式，承担了一部分数据之外的任务，所以才设计了XML只用来描述数据。
</p>

<p>
HTML和XML都有结构，使用标记形成树型的嵌套结构。DOM(Document Object Model)来解析这种嵌套树型结构，浏览器往往都提供了对DOM操作的API，可以用面向对象的方式来操作DOM。
</p>
</div>
<div id="outline-container-h:3d601eb4-d05e-409b-817d-37dd4f8368f1" class="outline-3">
<h3 id="h:3d601eb4-d05e-409b-817d-37dd4f8368f1">XPath***</h3>
<div class="outline-text-3" id="text-h:3d601eb4-d05e-409b-817d-37dd4f8368f1">
<p>
<a href="https://www.w3school.com.cn/xpath/index.asp">https://www.w3school.com.cn/xpath/index.asp</a> 中文教程
</p>

<p>
XPath是一门在XML文档中查找信息的语言。XPath可用来在XML文档中对元素和属性进行遍历。
</p>
</div>
<div id="outline-container-h:1e1c2fb8-7e5b-474e-ba3f-0f8db99312e3" class="outline-4">
<h4 id="h:1e1c2fb8-7e5b-474e-ba3f-0f8db99312e3">工具</h4>
<div class="outline-text-4" id="text-h:1e1c2fb8-7e5b-474e-ba3f-0f8db99312e3">
<p>
测试工具：<a href="https://soft.3dmgame.com/down/203270.html">XMLQuire</a> win7+需要.net框架4.0-4.5。
</p>
<ul class="org-ul">
<li>解压后，进入xmlquire\XMLQuireWin8\Application Files\XMLQuire_1_1_7_804目录下，打开XMLQuire.exe</li>
</ul>

<p>
测试XML、XPath
</p>

<p>
测试文档 books.xml
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #000000; background-color: #ffffff;">&lt;?</span><span style="color: #a020f0;">xml</span> <span style="color: #8b2252;">version="1.0" encoding="utf-8"</span><span style="color: #000000; background-color: #ffffff;">?&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">bookstore</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk101"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Gambardella, Matthew</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">XML Developer's Guide</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Computer</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">44.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2000-10-01</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">An in-depth look at creating applications with XML.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk102"</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"bookinfo even"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Ralls, Kim</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Midnight Rain</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Fantasy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">5.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2000-12-16</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">A former architect battles corporate zombies, an evil sorceress, and her own childhood to become queen of the world.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk103"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Corets, Eva</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Maeve Ascendant</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Fantasy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">5.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2000-11-17</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">After the collapse of a nanotechnology society in England, the young survivors lay the foundation for a new society.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">book</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bk104"</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Corets, Eva</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">author</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Oberon's Legacy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">title</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">Fantasy</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">genre</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">5.95</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">price</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">2001-03-10</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">publish_date</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
    <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span><span style="color: #000000; background-color: #ffffff;">In post-apocalypse England, the mysterious agent known only as Oberon helps to create a new life for the inhabitants of London. Sequel to Maeve Ascendant.</span><span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">description</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
  <span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">book</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
<span style="color: #000000; background-color: #ffffff;">&lt;</span><span style="color: #000000; background-color: #ffffff;">/</span><span style="color: #0000ff;">bookstore</span><span style="color: #000000; background-color: #ffffff;">&gt;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:73350c13-31ad-4ee2-96b6-70ad6e516194" class="outline-4">
<h4 id="h:73350c13-31ad-4ee2-96b6-70ad6e516194">节点</h4>
<div class="outline-text-4" id="text-h:73350c13-31ad-4ee2-96b6-70ad6e516194">
<p>
在XPath中，有七种类型的节点：元素、属性、文本、命名空间、处理指令、注释以及文档(根)节点。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">举例</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">&lt;bookstore&gt;</td>
<td class="org-left">元素节点</td>
</tr>

<tr>
<td class="org-left">&lt;author&gt;Corets,Eva&lt;/author&gt;</td>
<td class="org-left">元素节点</td>
</tr>

<tr>
<td class="org-left">id="bk104"</td>
<td class="org-left">属性节点，id是元素节点book的属性</td>
</tr>

<tr>
<td class="org-left">44.95</td>
<td class="org-left">文本节点</td>
</tr>
</tbody>
</table>

<p>
节点之间的嵌套形成 <b>父子(parent,children)关系</b> 。
</p>

<p>
具有统一个父结点的不同节点是 <b>兄弟(sibling)关系</b> 。
</p>
</div>
</div>
<div id="outline-container-h:7c017721-c274-498f-a399-f569cc79a159" class="outline-4">
<h4 id="h:7c017721-c274-498f-a399-f569cc79a159">节点选择</h4>
<div class="outline-text-4" id="text-h:7c017721-c274-498f-a399-f569cc79a159">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">操作符或表达式</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">//</td>
<td class="org-left">从当前节点开始的任意层找</td>
</tr>

<tr>
<td class="org-left">.</td>
<td class="org-left">当前节点</td>
</tr>

<tr>
<td class="org-left">..</td>
<td class="org-left">当前结点的父节点</td>
</tr>

<tr>
<td class="org-left">@</td>
<td class="org-left">选择属性</td>
</tr>

<tr>
<td class="org-left">节点名</td>
<td class="org-left">选取所有这个节点名的节点</td>
</tr>

<tr>
<td class="org-left">*</td>
<td class="org-left">匹配任意元素节点</td>
</tr>

<tr>
<td class="org-left">@*</td>
<td class="org-left">匹配任意属性节点</td>
</tr>

<tr>
<td class="org-left">node()</td>
<td class="org-left">匹配任意类型的节点</td>
</tr>

<tr>
<td class="org-left">text()</td>
<td class="org-left">匹配text类型节点</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:9a51d00f-6afb-4cf7-b311-c833940f7ac6" class="outline-4">
<h4 id="h:9a51d00f-6afb-4cf7-b311-c833940f7ac6">谓语(Predicates)</h4>
<div class="outline-text-4" id="text-h:9a51d00f-6afb-4cf7-b311-c833940f7ac6">
<ol class="org-ol">
<li>谓语用来查找某个特定的节点或者包含某个指定的值的节点。</li>
<li><b>谓语被嵌在方括号中</b> 。</li>
<li>谓语就是查询的条件。</li>
<li>即在路径选择时，在中括号内指定查询条件。</li>
</ol>
</div>
</div>
<div id="outline-container-h:12b5a5e9-6c9e-40ac-b9f7-375caa0e8aed" class="outline-4">
<h4 id="h:12b5a5e9-6c9e-40ac-b9f7-375caa0e8aed">XPath轴(Axes)</h4>
<div class="outline-text-4" id="text-h:12b5a5e9-6c9e-40ac-b9f7-375caa0e8aed">
<p>
轴的意思是相对于当前结点的节点集
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">轴名称</th>
<th scope="col" class="org-left">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ancestor</td>
<td class="org-left">选取当前结点的所有先辈(父、祖父等)</td>
</tr>

<tr>
<td class="org-left">ancestor-or-self</td>
<td class="org-left">选取当前节点的所有先辈(父、祖父等)以及当前节点本身</td>
</tr>

<tr>
<td class="org-left">attribute</td>
<td class="org-left">选取当前节点的所有属性。@id等价于attribute::id</td>
</tr>

<tr>
<td class="org-left">child</td>
<td class="org-left">选取当前节点的所有子元素，title等价于child:title</td>
</tr>

<tr>
<td class="org-left">descendant</td>
<td class="org-left">选取当前节点的所有后代元素(子、孙等)</td>
</tr>

<tr>
<td class="org-left">descendant-or-self</td>
<td class="org-left">选取当前节点的所有后代运算(子、孙等)以及当前节点本身</td>
</tr>

<tr>
<td class="org-left">following</td>
<td class="org-left">选取文档中当前节点的结束标签之后的所有结点</td>
</tr>

<tr>
<td class="org-left">namespace</td>
<td class="org-left">选取当前节点的所有命名空间节点</td>
</tr>

<tr>
<td class="org-left">parent</td>
<td class="org-left">选取当前节点的父节点</td>
</tr>

<tr>
<td class="org-left">preceding</td>
<td class="org-left">直到所有这个节点的父辈节点，顺序选择这个父辈节点前的所有同级节点</td>
</tr>

<tr>
<td class="org-left">preceding-sibling</td>
<td class="org-left">选取当前节点之前的所有同级节点</td>
</tr>

<tr>
<td class="org-left">self</td>
<td class="org-left">选取当前节点。等驾驭self::node()</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:63837f91-0955-484a-a4b9-792528a7c687" class="outline-4">
<h4 id="h:63837f91-0955-484a-a4b9-792528a7c687">步Step</h4>
<div class="outline-text-4" id="text-h:63837f91-0955-484a-a4b9-792528a7c687">
<p>
步的语法 <code>轴名称：节点测试[谓语]</code>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">例子</th>
<th scope="col" class="org-left">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">child::book</td>
<td class="org-left">选取所有属于当前节点的只元素的book节点</td>
</tr>

<tr>
<td class="org-left">attribute::lang</td>
<td class="org-left">选取当前节点的lang属性</td>
</tr>

<tr>
<td class="org-left">child::*</td>
<td class="org-left">选取当前节点的所有只元素</td>
</tr>

<tr>
<td class="org-left">attribute::*</td>
<td class="org-left">选取当前节点的所有属性</td>
</tr>

<tr>
<td class="org-left">child::text()</td>
<td class="org-left">选取当前节点的所有文本子节点</td>
</tr>

<tr>
<td class="org-left">child::node()</td>
<td class="org-left">选取当前节点的所有子节点</td>
</tr>

<tr>
<td class="org-left">descendant::book</td>
<td class="org-left">选取当前节点的所有book后代</td>
</tr>

<tr>
<td class="org-left">ancestor:book</td>
<td class="org-left">选择当前节点的所有book先辈</td>
</tr>

<tr>
<td class="org-left">ancestor-or-self::book</td>
<td class="org-left">选取当前节点的所有book先辈以及当前节点(如果此节点是book节点)</td>
</tr>

<tr>
<td class="org-left">child::*/child::price</td>
<td class="org-left">选取当前节点的所有price孙节点</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:9c27c201-88df-4512-94ef-3eba7f661464" class="outline-4">
<h4 id="h:9c27c201-88df-4512-94ef-3eba7f661464">XPATH示例</h4>
<div class="outline-text-4" id="text-h:9c27c201-88df-4512-94ef-3eba7f661464">
<ol class="org-ol">
<li>以斜杠开始的称为绝对路径，表示从根开始。</li>
<li>不以斜杠开始的称为相对路径，一般都是依照当前节点来计算。当前节点在上下文环境中，当前节点很可能已经补是根节点了。</li>
<li>一般为了方便，往往xml如果层次很深，都会使用=//=来查找节点。</li>
</ol>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">路径表达式</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">title</td>
<td class="org-left">选取当前节点下所有title子节点</td>
</tr>

<tr>
<td class="org-left">/book</td>
<td class="org-left">从根节点找子节点是book的，找不到</td>
</tr>

<tr>
<td class="org-left">book/title</td>
<td class="org-left">当前节点下所有子节点book下的title节点</td>
</tr>

<tr>
<td class="org-left">//title</td>
<td class="org-left">从根节点向下找任意层中title的结点</td>
</tr>

<tr>
<td class="org-left">book//title</td>
<td class="org-left">当前节点下所有book子节点下任意层次的title节点</td>
</tr>

<tr>
<td class="org-left">//@id</td>
<td class="org-left">任意层次下含有id的 <b>属性</b> ，取回的是属性</td>
</tr>

<tr>
<td class="org-left">//book[@id]</td>
<td class="org-left">任意层次下含有id属性的book节点</td>
</tr>

<tr>
<td class="org-left">//*[@id]</td>
<td class="org-left">任意层下含有id属性的节点</td>
</tr>

<tr>
<td class="org-left">//book[@id="bk102"]</td>
<td class="org-left">任意层次下book节点，且含有id属性为bk102的节点。</td>
</tr>

<tr>
<td class="org-left">/bookstore/book[1]</td>
<td class="org-left">根节点bookstore下第一个book节点， <b>从1开始</b></td>
</tr>

<tr>
<td class="org-left">/bookstore/book[1]/@id</td>
<td class="org-left">根节点bookstore下的第一个book节点的id属性</td>
</tr>

<tr>
<td class="org-left">/bookstore/book[last()-1]</td>
<td class="org-left">根节点bookstore下*倒数*第二个book节点,函数last()返回最后一个元素索引</td>
</tr>

<tr>
<td class="org-left">/bookstore/*</td>
<td class="org-left">匹配根节点bookstore的所有子节点，不递归</td>
</tr>

<tr>
<td class="org-left">//*</td>
<td class="org-left">匹配所有子孙节点</td>
</tr>

<tr>
<td class="org-left">//*[@*]</td>
<td class="org-left">匹配所有有属性的节点</td>
</tr>

<tr>
<td class="org-left">//book[@*]</td>
<td class="org-left">匹配所有有属性的book节点</td>
</tr>

<tr>
<td class="org-left">//@*</td>
<td class="org-left">匹配所有属性</td>
</tr>

<tr>
<td class="org-left">//book/title &vert; //price</td>
<td class="org-left">匹配任意层下的book下节点是title节点，或者任意层下的price</td>
</tr>

<tr>
<td class="org-left">//book[position()=2]</td>
<td class="org-left">匹配book节点，取第二个</td>
</tr>

<tr>
<td class="org-left">//book[position()&lt;last()-1]</td>
<td class="org-left">匹配book节点，取位置小于倒数第二个</td>
</tr>

<tr>
<td class="org-left">//book[price&gt;40]</td>
<td class="org-left">匹配book节点，取节点值大于40的book节点</td>
</tr>

<tr>
<td class="org-left">//book[2]/node()</td>
<td class="org-left">匹配位置为2的book节点下的所有类型的节点</td>
</tr>

<tr>
<td class="org-left">//book[1]/text()</td>
<td class="org-left">匹配第一个book节点下的所有文本子节点</td>
</tr>

<tr>
<td class="org-left">//book[1]//text()</td>
<td class="org-left">匹配第一个book节点下的所有文本节点</td>
</tr>

<tr>
<td class="org-left">//*[local-name()="book"]</td>
<td class="org-left">匹配所有节点且不带限定名的节点名称为book的所有节点。local-name函数取不带限定名的名称。</td>
</tr>
</tbody>
</table>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">路径表达式</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">//book/child::node()</td>
<td class="org-left">所有有class属性的节点</td>
</tr>

<tr>
<td class="org-left">//book/child::node()[local-name()='price' and text() &lt; 10]</td>
<td class="org-left">所有book节点的子节点中名字叫做pricer 的</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">且其内容小于10的节点</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">等价于//book/price[text(),10]</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">//book[price&lt;6]/price</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">//book/price[text()&lt;6]</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">//book/child::node()[local-name()="price" and text()&lt;6]</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">这三种等价</td>
</tr>

<tr>
<td class="org-left">/book//*[self::title or self::price]</td>
<td class="org-left">所有book节点下子孙节点，且这些节点是title或者price</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">等价于 //book//title &vert; //book/price</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">也等价于=//book//*[local-name()="title" or local-name()="price"]</td>
</tr>

<tr>
<td class="org-left">//*[@class]</td>
<td class="org-left">所有有class属性的节点</td>
</tr>

<tr>
<td class="org-left">//*[@class="bookinfo even"]</td>
<td class="org-left">所有属性为“bookinfo even”的节点</td>
</tr>

<tr>
<td class="org-left">//*[contains(@class,'even')</td>
<td class="org-left">获取所有属性class中包含even字符串的节点</td>
</tr>

<tr>
<td class="org-left">//*[contains(local-name(),'book')</td>
<td class="org-left">标签名包含book的节点</td>
</tr>
</tbody>
</table>

<p>
轴少用。
</p>

<p>
函数总结
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">函数</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">local-name()</td>
<td class="org-left">获取不带限定名的名称。相当于指定*标签元素*</td>
</tr>

<tr>
<td class="org-left">text()</td>
<td class="org-left">获取标签之间的文本内容</td>
</tr>

<tr>
<td class="org-left">node()</td>
<td class="org-left">所有节点。</td>
</tr>

<tr>
<td class="org-left">contains(@class,str)</td>
<td class="org-left">包含</td>
</tr>

<tr>
<td class="org-left">starts-with(local-name(),"book")</td>
<td class="org-left">以book开头</td>
</tr>

<tr>
<td class="org-left">last()</td>
<td class="org-left">最后一个元素索引</td>
</tr>

<tr>
<td class="org-left">position()</td>
<td class="org-left">元素索引</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e" class="outline-3">
<h3 id="h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e">lxml</h3>
<div class="outline-text-3" id="text-h:70fe7a03-a80c-49da-9dd2-6b318dd9f93e">
<p>
lxml是Python下功能丰富的XML、HTML解析库，性能非常好，是对libxml2和libxslt的封装。
</p>

<p>
注意,不同平台不一样，参看<a href="https://lxml.de/installation.html">https://lxml.de/installation.html</a>
</p>

<p>
lxml安装
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install lxml
</pre>
</div>

<p>
<a href="https://lxml.de/tutorial.html">https://lxml.de/tutorial.html</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;etree&#26500;&#24314;HTML</span>
<span style="color: #a0522d;">root</span> = etree.Element(<span style="color: #8b2252;">"html"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(root))
<span style="color: #483d8b;">print</span>(root.tag)

<span style="color: #a0522d;">body</span> = etree.Element(<span style="color: #8b2252;">"body"</span>)
root.append(body)
<span style="color: #483d8b;">print</span>(etree.tostring(root))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#23376;&#33410;&#28857;</span>
<span style="color: #a0522d;">sub</span> = etree.SubElement(body,<span style="color: #8b2252;">"child1"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(sub))
<span style="color: #a0522d;">sub</span> = etree.SubElement(body,<span style="color: #8b2252;">"child2"</span>).append(etree.Element(<span style="color: #8b2252;">"child21"</span>))
<span style="color: #a0522d;">html</span> = etree.tostring(root,pretty_print=<span style="color: #008b8b;">True</span>).decode()
<span style="color: #483d8b;">print</span>(html)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #a0522d;">r</span> = etree.HTML(html) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#26681;&#33410;&#28857;</span>
<span style="color: #483d8b;">print</span>(r.tag)
<span style="color: #483d8b;">print</span>(r.xpath(<span style="color: #8b2252;">"//*[contains(local-name(),'child')]"</span>))
</pre>
</div>

<ol class="org-ol">
<li>etree还提供了2个有用的函数</li>
<li>etree.HTML(text)解析HTML文档，返回根节点</li>
<li><b>anode.xpath('xpath路径')对节点使用xpath语法</b></li>
</ol>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree

<span style="color: #b22222;"># </span><span style="color: #b22222;">root = etree.Element('html')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">body = etree.Element('body')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">root.append(body)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(root)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(body)</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">body.append(etree.Element('div'))</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">p = etree.SubElement(body, 'p')  # body&#37324;&#21152;&#20010;p&#26631;&#31614;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">print(etree.tostring(root, pretty_print=True))</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;"># b'&lt;html&gt;\n  &lt;body&gt;\n    &lt;div/&gt;\n    &lt;p/&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n'</span>

<span style="color: #a0522d;">root</span> = etree.HTML(b<span style="color: #8b2252;">'&lt;html&gt;</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">  &lt;body&gt;</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">    &lt;div/&gt;</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">    &lt;p&gt;test string&lt;p/&gt;</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">  &lt;/body&gt;</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">&lt;/html&gt;</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
<span style="color: #483d8b;">print</span>(etree.tostring(root))

<span style="color: #483d8b;">print</span>(root.xpath(<span style="color: #8b2252;">'//p/text()'</span>))

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">b'&lt;html&gt;\n  &lt;body&gt;\n    &lt;div/&gt;\n    &lt;p&gt;test string&lt;/p&gt;&lt;p/&gt;\n  &lt;/body&gt;\n&lt;/html&gt;'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">['test string']</span>
</pre>
</div>
</div>
<div id="outline-container-h:eab8c31e-1465-479c-8b71-da8958b900ab" class="outline-4">
<h4 id="h:eab8c31e-1465-479c-8b71-da8958b900ab">练习：爬取“口碑榜”</h4>
<div class="outline-text-4" id="text-h:eab8c31e-1465-479c-8b71-da8958b900ab">
<p>
从豆瓣电影中获取”本周口碑榜”
</p>

<ul class="org-ul">
<li>Chrome浏览器F12，选择 Elements (元素) 面板，按Ctrl+F，按xpath语法搜索</li>
<li>火狐浏览F12，按xpath语法搜索 //div[@class="billboard-bd"]//td/a/text()</li>
</ul>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"billboard-bd"</span>&gt;
            &lt;<span style="color: #0000ff;">table</span>&gt;
                    &lt;<span style="color: #0000ff;">tbody</span>&gt;&lt;<span style="color: #0000ff;">tr</span>&gt;
                        &lt;<span style="color: #0000ff;">td</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"order"</span>&gt;1&lt;/<span style="color: #0000ff;">td</span>&gt;
                        &lt;<span style="color: #0000ff;">td</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"title"</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">onclick</span>=<span style="color: #8b2252;">"moreurl(this, {from:'mv_rk'})"</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"https://movie.douban.com/subject/36809864/"</span>&gt;&#21335;&#20140;&#29031;&#30456;&#39302;&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">td</span>&gt;
                    &lt;/<span style="color: #0000ff;">tr</span>&gt;
                    &lt;<span style="color: #0000ff;">tr</span>&gt;
                        &lt;<span style="color: #0000ff;">td</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"order"</span>&gt;2&lt;/<span style="color: #0000ff;">td</span>&gt;
                        &lt;<span style="color: #0000ff;">td</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"title"</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">onclick</span>=<span style="color: #8b2252;">"moreurl(this, {from:'mv_rk'})"</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"https://movie.douban.com/subject/36448279/"</span>&gt;&#32599;&#23567;&#40657;&#25112;&#35760;2&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">td</span>&gt;
                    &lt;/<span style="color: #0000ff;">tr</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree
<span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://movie.douban.com/'</span>
<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36'</span>

<span style="color: #a0522d;">response</span> = requests.get(url, headers={<span style="color: #8b2252;">'user-agent'</span>: ua})

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(response.status_code)
    <span style="color: #a020f0;">if</span> 200 &lt;= response.status_code &lt; 300:
        <span style="color: #483d8b;">print</span>(response.text[:300]) <span style="color: #b22222;"># </span><span style="color: #b22222;">html&#20869;&#23481;</span>
        <span style="color: #a0522d;">root</span> = etree.HTML(response.content) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#26512;html,&#36820;&#22238;DOM&#26681;&#33410;&#28857;</span>
        <span style="color: #483d8b;">print</span>(root.xpath(<span style="color: #8b2252;">'//div[@class="billboard-bd"]//td/a/text()'</span>))
</pre>
</div>

<p>
执行结果
</p>
<div class="org-src-container">
<pre class="src src-sh">200
&lt;!DOCTYPE html&gt;
&lt;html <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"zh-CN"</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"ua-windows ua-webkit"</span>&gt;
&lt;head&gt;
    &lt;meta http-equiv=<span style="color: #8b2252;">"Content-Type"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"text/html; charset=utf-8"</span>&gt;
    &lt;meta <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"renderer"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"webkit"</span>&gt;
    &lt;meta <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"referrer"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"always"</span>&gt;
    &lt;meta <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"google-site-verification"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"ok0wCgT20tBBgo9_z</span>
<span style="color: #8b2252;">['&#21335;&#20140;&#29031;&#30456;&#39302;', '&#32599;&#23567;&#40657;&#25112;&#35760;2', '&#25103;&#21488;', '&#20851;&#20110;&#32422;&#20250;&#30340;&#19968;&#20999;', '&#20901;&#23130;&#32418;&#21253;', '&#38271;&#23433;&#30340;&#33620;&#26525;', '&#33457;&#28478;&#23569;&#22899;&#26432;&#20154;&#20107;&#20214;', '&#27809;&#20107;&#65292;&#27809;&#20107;&#65292;&#27809;&#20107;&#65281;', '&#40614;&#20811;&#30333;', '&#37011;&#21335;&#36974;&#21344;&#39046;&#38428;&#22982;&#33258;&#30001;&#37030;']</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:e44aa8d4-2513-47de-bf5c-f2da6027fbb0" class="outline-2">
<h2 id="h:e44aa8d4-2513-47de-bf5c-f2da6027fbb0">MongoDB在python中的使用</h2>
<div class="outline-text-2" id="text-h:e44aa8d4-2513-47de-bf5c-f2da6027fbb0">
<p>
它是由C++编写的分布式文档数据库，内部使用类似于Json的bson格式。
</p>
</div>
<div id="outline-container-h:87a88b38-e2ea-4d08-bfd7-52f3c1b5200b" class="outline-3">
<h3 id="h:87a88b38-e2ea-4d08-bfd7-52f3c1b5200b">安装</h3>
<div class="outline-text-3" id="text-h:87a88b38-e2ea-4d08-bfd7-52f3c1b5200b">
<p>
官方安装文档：<a href="https://www.mongodb.com/zh-cn/docs/manual/installation/">https://www.mongodb.com/zh-cn/docs/manual/installation/</a>
</p>

<ul class="org-ul">
<li>MongoDB Community Server Download
<ul class="org-ul">
<li><a href="https://www.mongodb.com/try/download/community">https://www.mongodb.com/try/download/community</a></li>
<li>如，windows下载官方zip，解压即可使用。
<ul class="org-ul">
<li><a href="https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-8.0.12.zip">https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-8.0.12.zip</a></li>
</ul></li>
</ul></li>
<li>MongoDB Shell Download
<ul class="org-ul">
<li><a href="https://www.mongodb.com/try/download/shell">https://www.mongodb.com/try/download/shell</a></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.mongodb.com/zh-cn/docs/manual/tutorial/install-mongodb-on-windows-zip/</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Server</span>
D:.
&#9474;  LICENSE-Community.txt
&#9474;  MPL-2
&#9474;  README
&#9474;  THIRD-PARTY-NOTICES
&#9474;
&#9492;&#9472;bin
        Install-Compass.ps1
        mongod.exe <span style="color: #b22222;">#</span><span style="color: #b22222;">Server</span>
        mongod.pdb
        mongos.exe <span style="color: #b22222;">#</span><span style="color: #b22222;">Router</span>
        mongos.pdb
        vc_redist.x64.exe
<span style="color: #b22222;"># </span><span style="color: #b22222;">client</span>
D:.
&#9474;  .sbom.json
&#9474;  LICENSE-crypt-library
&#9474;  LICENSE-mongosh
&#9474;  mongosh.1.gz
&#9474;  README
&#9474;  THIRD_PARTY_NOTICES
&#9474;
&#9492;&#9472;bin
        mongosh.exe
        mongosh_crypt_v1.dll
</pre>
</div>


<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">组件</th>
<th scope="col" class="org-left">文件名</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Server</td>
<td class="org-left">mongod.exe</td>
</tr>

<tr>
<td class="org-left">Router</td>
<td class="org-left">mongos.exe</td>
</tr>

<tr>
<td class="org-left">Client</td>
<td class="org-left">mongosh 旧版为mongo.exe</td>
</tr>

<tr>
<td class="org-left">MonitoringTools</td>
<td class="org-left">mongostat.exe,mongotop.exe</td>
</tr>

<tr>
<td class="org-left">importExportTools</td>
<td class="org-left">mongodump.exe,mongorestore.exe,mongoexport.exe,mongoimport.exe</td>
</tr>

<tr>
<td class="org-left">MiscellaneousTools</td>
<td class="org-left">bsondump.exe,mongofiles.exe,mongooplog.exe,mongoperf.exe</td>
</tr>
</tbody>
</table>

<p>
运行
</p>
<div class="org-src-container">
<pre class="src src-sh">./bin/mongod  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#25351;&#23450;&#25968;&#25454;&#30446;&#24405;&#65292;&#25253;&#38169;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">./bin/mongod  --dbpath="d:/tmp/mongo/db"</span>
</pre>
</div>


<p>
选项说明
</p>
<div class="org-src-container">
<pre class="src src-sh">--bind_ip ip    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36887;&#21495;&#20998;&#38548;ip&#22320;&#22336;&#12290;&#40664;&#35748;localhost</span>
--bing_ip_all   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;&#25152;&#26377;&#26412;&#22320;ip&#22320;&#22336;</span>
--port port     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31471;&#21475;&#65292;&#40664;&#35748;27017</span>
--dbpath path   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#36335;&#24452;&#65292;&#32570;&#30465;&#20026;=\data\db\=&#12290;windows&#19979;&#32570;&#30465;&#23601;&#26159;&#24403;&#21069;&#30424;&#31526;&#30340;&#26681;&#30446;&#24405;</span>
--logpath path  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26085;&#24535;&#25991;&#20214;&#65292;&#26367;&#20195;stdout,&#35828;&#26126;&#40664;&#35748;&#26159;&#25511;&#21046;&#21488;&#25171;&#21360;&#26085;&#24535;</span>
-f file         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#37197;&#32622;&#25991;&#20214;&#65292;yaml&#26684;&#24335;</span>

&#27880;&#20876;wiendows&#26381;&#21153;
--install                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#20876;windwos&#26381;&#21153;</span>
--serviceName name        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#21517;&#31216;</span>
--serviceDisplayName name <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#26174;&#31034;&#21517;</span>
</pre>
</div>

<p>
linux安装mongodb
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">debian</span>
wget https://repo.mongodb.org/apt/debian/dists/bookworm/mongodb-org/8.0/main/binary-amd64/mongodb-org-server_8.0.13_amd64.deb

&#9492;&#9472;$ dpkg -c ./mongodb-org-server_8.0.13_amd64.deb  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21253;&#25991;&#20214;</span>
-rw-r--r-- root/root       578 2013-12-19 13:41 ./etc/mongod.conf <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;</span>
-rw-r--r-- root/root       837 2013-12-19 13:41 ./lib/systemd/system/mongod.service <span style="color: #b22222;"># </span><span style="color: #b22222;">uint&#21551;&#21160;&#25991;&#20214;</span>
-rwxr-xr-x root/root 219688608 2013-12-19 13:41 ./usr/bin/mongod

vim /etc/mongod.conf
net:
  port: 27017
  bindIp: 0.0.0.0

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;&#26381;&#21153;</span>
systemctl start mongod.service 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7c5d3e27-9211-450c-bba4-52fe1681a6ef" class="outline-3">
<h3 id="h:7c5d3e27-9211-450c-bba4-52fe1681a6ef">配置文件</h3>
<div class="outline-text-3" id="text-h:7c5d3e27-9211-450c-bba4-52fe1681a6ef">
<p>
mongodb配置使用YAML格式
</p>
<ul class="org-ul">
<li>嵌套使用缩进晚餐，不支持Tab等制表符，支持空格</li>
<li>冒号后要有空格</li>
</ul>

<p>
Yaml参考<a href="https://www.w3cschool.cn/iqmrhf/dotvpozt.html">https://www.w3cschool.cn/iqmrhf/dotvpozt.html</a>
</p>

<p>
配置: <a href="https://www.mongodb.com/zh-cn/docs/manual/reference/configuration-options/">https://www.mongodb.com/zh-cn/docs/manual/reference/configuration-options/</a>
在mongodb安装目录新建配置文件mongodb.yml。内容如下：
</p>

<p>
mongod.yml
</p>
<div class="org-src-container">
<pre class="src src-sh">systemLog:
  destination: file
  path: <span style="color: #8b2252;">"d:/tmp/mongo/mongod.log"</span>
  logAppend: true
storage:
  dbPath: <span style="color: #8b2252;">"d:/tmp/mongo/db"</span>
net:
  bindIp: 127.0.0.1
  port: 27017
</pre>
</div>

<p>
选项
</p>
<ol class="org-ol">
<li>systemLog
<ul class="org-ul">
<li>destination,缺省是输出日志到std,file表示输出到文件</li>
<li>path,日志路径</li>
<li>logAppend,true表示在已存在的日志文件追加。默认false,每次启动服务，重新创建新的日志。</li>
</ul></li>
<li>storage</li>
<li>dbPath,必须指定mongodb的数据目录，目录必须存在。</li>
<li>net
<ol class="org-ol">
<li>bindlp,缺省绑定到127.0.0.1</li>
<li>port,端口，缺省为27017，客户端连接用</li>
</ol></li>
</ol>

<p>
windows下注册为服务的命令如下，使用了配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">mongod.exe -f <span style="color: #8b2252;">"D:/Application/mogodb/package/mongodb4.0/mongod.yml"</span> --serviceName mongod --serviceDisplayName mongo --install
</pre>
</div>

<p>
注意，注册服务需要管理员权限。
</p>

<p>
去掉配置文件中的配置日志信息部分。这样日志将会显示在控制台
</p>

<div class="org-src-container">
<pre class="src src-sh">storage:
  dbPath: <span style="color: #8b2252;">"d:/tmp/mongo/db"</span>
net:
  bindIp: 127.0.0.1
  port: 27017
</pre>
</div>

<p>
启动服务
</p>
<div class="org-src-container">
<pre class="src src-sh">./bin/mongod -f mongod.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1d5302bb-9086-44eb-b873-7f8c939913bb" class="outline-3">
<h3 id="h:1d5302bb-9086-44eb-b873-7f8c939913bb">客户端</h3>
<div class="outline-text-3" id="text-h:1d5302bb-9086-44eb-b873-7f8c939913bb">
</div>
<div id="outline-container-h:9fd2fd89-0dd3-4951-b0ae-c2be34617d2d" class="outline-4">
<h4 id="h:9fd2fd89-0dd3-4951-b0ae-c2be34617d2d">客户端连接</h4>
<div class="outline-text-4" id="text-h:9fd2fd89-0dd3-4951-b0ae-c2be34617d2d">
<p>
客户端连接文档：
</p>
<ul class="org-ul">
<li>mongosh:  <a href="https://www.mongodb.com/zh-cn/docs/mongodb-shell/connect/">https://www.mongodb.com/zh-cn/docs/mongodb-shell/connect/</a>
<ul class="org-ul">
<li>阿里文档：<a href="https://help.aliyun.com/zh/mongodb/getting-started/connection-instance">https://help.aliyun.com/zh/mongodb/getting-started/connection-instance</a></li>
</ul></li>
<li>compass GUI: <a href="https://www.mongodb.com/try/download/compass">https://www.mongodb.com/try/download/compass</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">./bin/mongosh <span style="color: #8b2252;">"mongodb://localhost:27017"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#26412; bin/mongo.exe</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25805;&#20316;</span>
<span style="color: #483d8b;">help</span> &#25171;&#24320;&#24110;&#21161;
show dbs    &#26597;&#30475;&#24403;&#21069;&#24211;
use blog    &#26377;&#23601;&#20999;&#25442;&#36807;&#21435;&#65292;&#27809;&#26377;&#23601;&#21019;&#24314;&#21518;&#20999;&#25442;&#36807;&#21435;&#12290;&#21018;&#21019;&#24314;&#30340;&#24182;&#19981;&#22312;&#25968;&#25454;&#24211;&#21015;&#34920;&#20013;&#65292;&#38656;&#35201;&#20889;&#20837;&#25968;&#25454;&#21518;&#25165;&#33021;&#30475;&#21040;
db          &#26597;&#30475;&#24403;&#21069;&#25968;&#25454;&#24211;
<span style="color: #0000ff;">db.users.insert</span>({user:<span style="color: #8b2252;">"tom"</span>,age:20}) db&#25351;&#20195;&#24403;&#21069;&#25968;&#25454;&#24211;&#65307;users&#38598;&#21512;&#21517;
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">test</span>&gt; help
  Shell Help:

    log                                        <span style="color: #8b2252;">'log.info(&lt;msg&gt;)'</span>: Write a custom info/warn/error/fatal/debug message to the log file
                                               <span style="color: #8b2252;">'log.getPath()'</span>: Gets a path to the current log file

    use                                        Set current database
    show                                       <span style="color: #8b2252;">'show databases'</span>/<span style="color: #8b2252;">'show dbs'</span>: Print a list of all available databases
                                               <span style="color: #8b2252;">'show collections'</span>/<span style="color: #8b2252;">'show tables'</span>: Print a list of all collections for current database
                                               <span style="color: #8b2252;">'show profile'</span>: Prints system.profile information
                                               <span style="color: #8b2252;">'show users'</span>: Print a list of all users for current database
                                               <span style="color: #8b2252;">'show roles'</span>: Print a list of all roles for current database
                                               <span style="color: #8b2252;">'show log &lt;name&gt;'</span>: Display log for current connection, if name is not set uses <span style="color: #8b2252;">'global'</span>
                                               <span style="color: #8b2252;">'show logs'</span>: Print all logger names.
    <span style="color: #a020f0;">exit</span>                                       Quit the MongoDB shell with exit/exit()/.exit
    quit                                       Quit the MongoDB shell with quit/quit()
    Mongo                                      Create a new connection and return the Mongo object. Usage: new Mongo(URI, options [optional])
    connect                                    Create a new connection and return the Database object. Usage: connect(URI, username [optional], password [optional])
    it                                         result of the last line evaluated; use to further iterate
    version                                    Shell version
    load                                       Loads and runs a JavaScript file into the current shell environment
    enableTelemetry                            Enables collection of anonymous usage data to improve the mongosh CLI
    disableTelemetry                           Disables collection of anonymous usage data to improve the mongosh CLI
    passwordPrompt                             Prompts the user for a password
    sleep                                      Sleep for the specified number of milliseconds
    print                                      Prints the contents of an object to the output
    printjson                                  Alias for print()
    convertShardKeyToHashed                    Returns the hashed value for the input using the same hashing <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">as</span> a hashed index.
    cls                                        Clears the screen like console.clear()
    isInteractive                              Returns whether the shell will enter or has entered interactive mode

  For more information on usage: https://mongodb.com/docs/manual/reference/method
<span style="color: #483d8b;">test</span>&gt; show dbs
admin    40.00 KiB
config  108.00 KiB
<span style="color: #483d8b;">local</span>    40.00 KiB
<span style="color: #483d8b;">test</span>&gt; db                                                                                                                                                                
<span style="color: #483d8b;">test</span>                                                                                                                                                                    
<span style="color: #483d8b;">test</span>&gt; use aaa      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;&#20889;&#25968;&#25454;&#30340;&#35805;&#65292;&#36864;&#20986;&#21518;&#19981;&#20250;&#21019;&#24314;&#24211;&#12290;                                                                                                                                                     </span>
switched to db aaa                                                                                                                                                      
aaa&gt;

aaa&gt; use users                                                                                                                                                          
switched to db users                                                                                                                                                    
users&gt; db.users.insert({<span style="color: #8b2252;">'name'</span>:<span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'age'</span>:20})  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#25968;&#25454;                                                                                             </span>
DeprecationWarning: Collection.insert() is deprecated. Use insertOne, insertMany, or bulkWrite.                                                                         
{                                                                                                                                                                       
  acknowledged: true,                                                                                                                                                   
  insertedIds: { <span style="color: #8b2252;">'0'</span>: ObjectId(<span style="color: #8b2252;">'6895bc37ad8daf59bceec4a9'</span>) }                                                                                                            
}                                                                                                                                                                       
users&gt; db.users.find()                                                                                                                                                  
[ { _id: ObjectId(<span style="color: #8b2252;">'6895bc37ad8daf59bceec4a9'</span>), name: <span style="color: #8b2252;">'tom'</span>, age: 20 } ]                                                                                                 
users&gt; 
</pre>
</div>

<p>
<b>Pycharm插件</b>
在settings/plugins中输入mongo，安装Mongo Plugin，完成后重启Pycharm。
</p>

<p>
菜单项view/Tool windows/Mongo Explorer
</p>
</div>
</div>
<div id="outline-container-h:a7697b26-2e85-4591-b074-b3f502bbc6d4" class="outline-4">
<h4 id="h:a7697b26-2e85-4591-b074-b3f502bbc6d4">Python链接</h4>
<div class="outline-text-4" id="text-h:a7697b26-2e85-4591-b074-b3f502bbc6d4">
<p>
Mongodb官方推荐使用pymongo。参考<a href="https://www.mongodb.com/zh-cn/docs/languages/python/pymongo-driver/current/">https://www.mongodb.com/zh-cn/docs/languages/python/pymongo-driver/current/</a> 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">pymongo-4.14.0</span>
pip install pymongo
</pre>
</div>

<p>
mongodb的链接字符串 <code>mongodb://gdy:gdy@127.0.0.1:27017/test</code>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #483d8b;">print</span>(client)

<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #b22222;"># </span><span style="color: #b22222;">db = client.users # &#19982;&#19978;&#38754;&#31561;&#20215;&#65292;&#22240;&#20026;MongoClient&#26377;__getitem__ __getattr__ &#26041;&#27861;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(db), db)

<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>]
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(table), table)

<span style="color: #a0522d;">result</span> = table.find() <span style="color: #b22222;"># </span><span style="color: #b22222;">select * from users.users</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result), *result)
client.close()

<span style="color: #b22222;"># </span><span style="color: #b22222;">with client:</span>
</pre>
</div>

<p>
执行结果
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">MongoClient</span>(<span style="color: #a0522d;">host</span>=[<span style="color: #8b2252;">'127.0.0.1:27017'</span>], <span style="color: #a0522d;">document_class</span>=dict, <span style="color: #a0522d;">tz_aware</span>=False, <span style="color: #a0522d;">connect</span>=True)
&lt;class <span style="color: #8b2252;">'pymongo.synchronous.database.Database'</span>&gt; Database(MongoClient(<span style="color: #a0522d;">host</span>=[<span style="color: #8b2252;">'127.0.0.1:27017'</span>], <span style="color: #a0522d;">document_class</span>=dict, <span style="color: #a0522d;">tz_aware</span>=False, <span style="color: #a0522d;">connect</span>=True), <span style="color: #8b2252;">'users'</span>)
&lt;class <span style="color: #8b2252;">'pymongo.synchronous.collection.Collection'</span>&gt; Collection(Database(MongoClient(<span style="color: #a0522d;">host</span>=[<span style="color: #8b2252;">'127.0.0.1:27017'</span>], <span style="color: #a0522d;">document_class</span>=dict, <span style="color: #a0522d;">tz_aware</span>=False, <span style="color: #a0522d;">connect</span>=True), <span style="color: #8b2252;">'users'</span>), <span style="color: #8b2252;">'users'</span>)
&lt;class <span style="color: #8b2252;">'pymongo.synchronous.cursor.Cursor'</span>&gt; {<span style="color: #8b2252;">'_id'</span>: ObjectId(<span style="color: #8b2252;">'6895bc37ad8daf59bceec4a9'</span>), <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'age'</span>: 20}
</pre>
</div>

<p>
即能用属性访问，又能像key一样访问，一定用到了魔术方法的 <code>__getattr__、__getitem__</code>
</p>
</div>
</div>
</div>
<div id="outline-container-h:4a19f701-a8b3-4944-84a7-e79f115ce759" class="outline-3">
<h3 id="h:4a19f701-a8b3-4944-84a7-e79f115ce759">基本概念</h3>
<div class="outline-text-3" id="text-h:4a19f701-a8b3-4944-84a7-e79f115ce759">
<p>
MongoDB中可以创建使用多个库，但有一些数据库名是保留的，可以直接访问这些特殊作用的数据库。
</p>

<ol class="org-ol">
<li>admin: 从权限的角度来看，这是"root"数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</li>
<li>local: 这个数据永远不会被赋值，可以用来存储限于本地单台服务器的任意集合</li>
<li>config: 当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</li>
</ol>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">RDBMS</th>
<th scope="col" class="org-left">MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Database</td>
<td class="org-left">Database</td>
</tr>

<tr>
<td class="org-left">Table</td>
<td class="org-left">Collection</td>
</tr>

<tr>
<td class="org-left">Row</td>
<td class="org-left">Document</td>
</tr>

<tr>
<td class="org-left">Column</td>
<td class="org-left">Field</td>
</tr>

<tr>
<td class="org-left">Join</td>
<td class="org-left">Embedded Document嵌入文档或Reference引用</td>
</tr>

<tr>
<td class="org-left">Primary Key</td>
<td class="org-left">主键(MongoDB提供了Key为_id)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:9ab10d84-4568-4826-8bbf-7bb5da35547c" class="outline-3">
<h3 id="h:9ab10d84-4568-4826-8bbf-7bb5da35547c">插入数据</h3>
<div class="outline-text-3" id="text-h:9ab10d84-4568-4826-8bbf-7bb5da35547c">
<p>
每条数据插入后都有一个唯一key,属性 <code>_id</code> 唯一标识一个文档。没有没有显示指明该属性，会自动生成一个Objectld类型的 <code>_id</code> 属性。
</p>

<p>
pymongo.collection.Collection类
</p>

<ol class="org-ol">
<li>db.collection.insert_one(dict)-&gt;InsertOneResult #单行插入
<ul class="org-ul">
<li>dict是一个字典</li>
<li>InsertOneResult:f返回结果ObjectId对象，即=_id=的值</li>
</ul></li>

<li>db.collection.insert_many([dict,&#x2026;])-&gt;[InsertOneResult,&#x2026;]
#多行插入

<ul class="org-ul">
<li>第一个参数是个列表，列表中记录需要插入的文档类型即dict</li>
<li>返回结果，被插入的对象所获得的id</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>]

<span style="color: #b22222;"># </span><span style="color: #b22222;">C</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21333;&#26465;&#25554;&#20837;</span>
<span style="color: #a0522d;">r</span> = table.insert_one({<span style="color: #8b2252;">'id'</span>:<span style="color: #8b2252;">'1'</span>,<span style="color: #8b2252;">'name'</span>:<span style="color: #8b2252;">'ben'</span>, <span style="color: #8b2252;">'age'</span>:20}) <span style="color: #b22222;"># </span><span style="color: #b22222;">_id</span>
<span style="color: #483d8b;">print</span>(r.inserted_id) <span style="color: #b22222;">#</span><span style="color: #b22222;">68961acd2a6de1bd5c0fd597</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25209;&#37327;&#25554;&#20837;</span>
<span style="color: #a0522d;">r</span> = table.insert_many([
    {<span style="color: #8b2252;">'id'</span>:257, <span style="color: #8b2252;">'name'</span>:<span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'age'</span>:32},
    {<span style="color: #8b2252;">'id'</span>:258, <span style="color: #8b2252;">'name'</span>:<span style="color: #8b2252;">'jerry'</span>, <span style="color: #8b2252;">'age'</span>:48}
])
<span style="color: #483d8b;">print</span>(r.inserted_ids)
<span style="color: #b22222;">#</span><span style="color: #b22222;">[ObjectId('68961ace2a6de1bd5c0fd598'), ObjectId('68961ace2a6de1bd5c0fd599')]</span>
<span style="color: #a0522d;">r</span> = table.insert_one({<span style="color: #8b2252;">'id'</span>:<span style="color: #8b2252;">'3'</span>,<span style="color: #8b2252;">'name'</span>:<span style="color: #8b2252;">'sam'</span>, <span style="color: #8b2252;">'age'</span>:16}) <span style="color: #b22222;"># </span><span style="color: #b22222;">_id</span>
<span style="color: #483d8b;">print</span>(r.inserted_id) <span style="color: #b22222;"># </span><span style="color: #b22222;">68961ace2a6de1bd5c0fd59a</span>

<span style="color: #a0522d;">result</span>  = table.find() <span style="color: #b22222;"># </span><span style="color: #b22222;">select * from users.users</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result), *result)
client.close()
</pre>
</div>

<p>
每条数据插入后都有一个唯一key，属性 <code>_id</code> 唯一标识一个文档。没有显式指明该属性，会自动生成一个ObjectId类型的 <code>_id</code> 属性。
</p>

<p>
ObjectID由12个字节组成
</p>
<ul class="org-ul">
<li>4个字节时间戳</li>
<li>3个字节机器识别码</li>
<li>2个字节进程id</li>
<li>3个字节随机数</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> datetime

<span style="color: #483d8b;">id</span> = <span style="color: #8b2252;">'68961ace2a6de1bd5c0fd59a'</span>
<span style="color: #a0522d;">x</span> = <span style="color: #483d8b;">id</span>[:8] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26102;&#38388;&#25139;&#25552;&#21462;</span>
<span style="color: #483d8b;">print</span>(x)
<span style="color: #483d8b;">print</span>(0x68961ace)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">int</span>(<span style="color: #8b2252;">'0x68961ace'</span>, 16))
<span style="color: #483d8b;">print</span>(datetime.datetime.fromtimestamp(0x68961ace))
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
<span style="color: #a0522d;">y</span> = <span style="color: #483d8b;">int</span>.from_bytes(<span style="color: #483d8b;">bytes</span>.fromhex(x), <span style="color: #8b2252;">'big'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;&#31471;&#27169;&#24335;</span>
<span style="color: #483d8b;">print</span>(y)
<span style="color: #483d8b;">print</span>(datetime.datetime.fromtimestamp(y))

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20063;&#21487;&#20197;&#20351;&#29992;&#20989;&#25968;&#33719;&#21462;</span>
<span style="color: #a020f0;">import</span> bson <span style="color: #b22222;">#</span><span style="color: #b22222;">json</span>
<span style="color: #a0522d;">z</span> = bson.ObjectId(<span style="color: #483d8b;">id</span>)
<span style="color: #483d8b;">print</span>(z)
<span style="color: #483d8b;">print</span>(z.generation_time)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c3cbb4d4-42bc-48e5-b8f9-7247ae5c0385" class="outline-3">
<h3 id="h:c3cbb4d4-42bc-48e5-b8f9-7247ae5c0385">文档</h3>
<div class="outline-text-3" id="text-h:c3cbb4d4-42bc-48e5-b8f9-7247ae5c0385">
<p>
每一条记录对应一个文档，其格式使用BSON。BSON即Binary Json。
</p>

<p>
BSON二进制格式如下:
</p>


<figure id="org6caf38d">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/python/images/img_20250820_152345.png" alt="img_20250820_152345.png" width="50%">

</figure>


<p>
查看"\db\collection-4-*.wt"对应的二进制格式
</p>

<div class="org-src-container">
<pre class="src src-nil">00 00 05 82 d7 35 00 00 00 07 5f 69 64 00 5d 45

35 表示文档二精制数据长度
07 表示MongoDB中特殊数据类型ObjectID
5f 69 64 ，ascii码_id

57 be 12 f2 bf 14 48 c7 43 de 10 69 64 00 01 01

5d 45 57 be 12 f2 bf 14 48 c7 43 de,ObjectId(‘5d4557be12f2bf1448c743de')_id的值
10 69 64,10表示类型int-32, 69 64是ascii码id
0101小端模式，十进制257
</pre>
</div>

<p>
mongodb数据类型参考 <a href="https://docs.mongodb.com/v3.6/reference/bson-types/">https://docs.mongodb.com/v3.6/reference/bson-types/</a>
</p>

<p>
<code>00 00 02 6e 61 6d 65 00 04 00 00 00 74 6f 6d 00</code>
</p>
<ul class="org-ul">
<li>02 表示数据类型UTF-8 String</li>
<li>6e 61 6d 65 表示字符串name</li>
<li>04, 表示字符串长度</li>
<li>74 6f 6d 00，表示字符串tom和结束符</li>
</ul>

<p>
<code>10 61 67 65 00 20 00</code>
</p>
<ul class="org-ul">
<li>10,表示数据类型int-32</li>
<li>61 67 65,表示字符串age</li>
<li>20,表示十进制32</li>
</ul>

<p>
文档
</p>
<ol class="org-ol">
<li>文档中，使用键值对</li>
<li>文档中的键/值对时*有序*的</li>
<li>键是字符串
<ul class="org-ul">
<li><b>区分大小写</b> ，使用UTF-8字符</li>
<li>键不能含有\0(空字符)。这个字符用来表示键字符串的结尾</li>
<li><code>.</code> 和 <code>$</code> 有特别的意义，只有在特定环境下才能使用</li>
<li>以下划线 <code>_</code> 开头的键是保留的，例如： <code>_id</code></li>
</ul></li>
<li>值可以是：
<ol class="org-ol">
<li>字符串，32位或64位整数、双精度、时间戳(毫秒)、布尔型、null</li>
<li>字节数组、BSON数组、BSON对象</li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-h:0b474c2e-a2a2-4e9b-9e70-2faa5aa04ecf" class="outline-3">
<h3 id="h:0b474c2e-a2a2-4e9b-9e70-2faa5aa04ecf">查询数据</h3>
<div class="outline-text-3" id="text-h:0b474c2e-a2a2-4e9b-9e70-2faa5aa04ecf">
<p>
pymongo.collection.Collection类
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">db.collection.find_one</span>(dict)-&gt;result &#26597;&#35810;&#21333;&#26465;&#25968;&#25454;
<span style="color: #0000ff;">db.collection.find</span>(dict)-&gt;resutl &#26597;&#35810;&#22810;&#26465;&#25968;&#25454;
</pre>
</div>

<ul class="org-ul">
<li>dict，使用查询操作符组成的字典</li>
<li>result，返回的结果集</li>
</ul>
</div>
<div id="outline-container-h:85455a5c-b5ac-49de-9929-a642c2c869c6" class="outline-4">
<h4 id="h:85455a5c-b5ac-49de-9929-a642c2c869c6">单条查询</h4>
<div class="outline-text-4" id="text-h:85455a5c-b5ac-49de-9929-a642c2c869c6">
<p>
find_on第一参数是filter, 相当于SQL的where子句。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection
<span style="color: #a020f0;">from</span> bson.objectid <span style="color: #a020f0;">import</span> ObjectId

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;</span>
<span style="color: #a0522d;">result</span> = users.find_one({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"tom"</span>})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result),result)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;key&#26597;&#35810;</span>
<span style="color: #a0522d;">result2</span> = users.find_one({<span style="color: #8b2252;">"_id"</span>:ObjectId(<span style="color: #8b2252;">"5d539433c1b3dcb23654814d"</span>)})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result2),result2)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#19981;&#21040;&#65292;&#36820;&#22238;None</span>
<span style="color: #a0522d;">result3</span> = users.find_one({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"tommy"</span>})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result3),result3)1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:47f762c9-c342-4a09-9e44-04ce86331cf4" class="outline-4">
<h4 id="h:47f762c9-c342-4a09-9e44-04ce86331cf4">多条查询</h4>
<div class="outline-text-4" id="text-h:47f762c9-c342-4a09-9e44-04ce86331cf4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#26465;&#26597;&#35810;</span>
<span style="color: #a0522d;">results</span> = users.find({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"tom"</span>})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(results))
<span style="color: #483d8b;">print</span>(results)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> results:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(x),x)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9ce1aabd-2a22-4aff-a698-bfca6f79c9e2" class="outline-4">
<h4 id="h:9ce1aabd-2a22-4aff-a698-bfca6f79c9e2">查询操作符</h4>
<div class="outline-text-4" id="text-h:9ce1aabd-2a22-4aff-a698-bfca6f79c9e2">
<p>
<a href="https://www.mongodb.com/zh-cn/docs/manual/reference/operator/query/">https://www.mongodb.com/zh-cn/docs/manual/reference/operator/query/</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">比较符号</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">$lt</td>
<td class="org-left">小于</td>
<td class="org-left">{"age":{"$lt":20}}</td>
</tr>

<tr>
<td class="org-left">$gt</td>
<td class="org-left">大于</td>
<td class="org-left">{"age":{"$gt":20}}</td>
</tr>

<tr>
<td class="org-left">$lte</td>
<td class="org-left">小于等于</td>
<td class="org-left">{"age":{"$lte":20}}</td>
</tr>

<tr>
<td class="org-left">$gte</td>
<td class="org-left">大于等于</td>
<td class="org-left">{"age":{"$gte":20}}</td>
</tr>

<tr>
<td class="org-left">$ne</td>
<td class="org-left">不等于</td>
<td class="org-left">{"age":{"$ne":20}}</td>
</tr>

<tr>
<td class="org-left">$eq</td>
<td class="org-left">等于，可以不用增符号</td>
<td class="org-left">{"age":{"$eq":20}}</td>
</tr>

<tr>
<td class="org-left">$in</td>
<td class="org-left">在范围内</td>
<td class="org-left">{"age":{"$in":[20,23]}}</td>
</tr>

<tr>
<td class="org-left">$nin</td>
<td class="org-left">不在范围内</td>
<td class="org-left">{"age":{"$nin":[20,30]]}}</td>
</tr>
</tbody>
</table>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">逻辑符号</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">$and</td>
<td class="org-left">与</td>
<td class="org-left">{"$and":[{"name":"tom"},{"age":{"$gt":20}}]}</td>
</tr>

<tr>
<td class="org-left">$or</td>
<td class="org-left">或</td>
<td class="org-left">{'$or':[ {'age':{'$lt':20}}, {'age':{'$gt':40}}]}</td>
</tr>

<tr>
<td class="org-left">$not</td>
<td class="org-left">非</td>
<td class="org-left">{'name':{'$not':{'$eq':'tom'}}}</td>
</tr>
</tbody>
</table>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">元素</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">$exists</td>
<td class="org-left">文档中是否有这个字段</td>
<td class="org-left">{'Name':{'$exists':True}}</td>
</tr>

<tr>
<td class="org-left">$type</td>
<td class="org-left">字段是否是指定的类型</td>
<td class="org-left">{'age':{'$type':16}}</td>
</tr>
</tbody>
</table>

<p>
常用类型
</p>
<ul class="org-ul">
<li>字符串类型编码为2,别名为string</li>
<li>整型编码为16,别名为int</li>
<li>长整型编码为18,别名为long</li>
</ul>

<p>
<a href="https://docs.mongodb.com/manual/reference/operator/query/type/#op._S_type">https://docs.mongodb.com/manual/reference/operator/query/type/#op._S_type</a>
</p>


<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">操作符</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">$regex</td>
<td class="org-left">文档中字段内容匹配</td>
<td class="org-left">{"name":{"$regex":"^t"}}</td>
</tr>

<tr>
<td class="org-left">$mod</td>
<td class="org-left">取模</td>
<td class="org-left">{"age":{"$mod":[10,2]}}模10余2</td>
</tr>
</tbody>
</table>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25805;&#20316;&#31526;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'age':{"$gt":20}}) # select * from users.users where name='tom' and age &gt; 20</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'age':{'$nin':[20, 16]}})</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'$and':[</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">{'name':'tom'}, {'age':{'$gt':20}}</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">]})</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'name':'tom', 'age':{'$gt':20}}) #&#19982;&#19978;&#38754;&#31561;&#20215;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'$or':[</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">{'age':{'$lt':20}}, {'age':{'$gt':40}}</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">]})</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'name':{'$not':{'$eq':'tom'}}})</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'id':{'$type':16}})</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'Name':{'$exists':True}})</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'name':{'$regex':'^t'}})</span>
<span style="color: #a0522d;">result</span> = table.find({<span style="color: #8b2252;">'age'</span>:{<span style="color: #8b2252;">'$mod'</span>:[10, 2]}})
<span style="color: #483d8b;">print</span>(*result, sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

client.close()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:915c53dd-c905-40c7-bd42-c9b58453f051" class="outline-4">
<h4 id="h:915c53dd-c905-40c7-bd42-c9b58453f051">投影</h4>
<div class="outline-text-4" id="text-h:915c53dd-c905-40c7-bd42-c9b58453f051">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25237;&#24433;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'age':{'$gt':20}}, ('name',))</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">result = table.find({'age':{'$gt':20}}, ['name', 'id']) #&#20801;&#35768;</span>
<span style="color: #a0522d;">result</span> = table.find({<span style="color: #8b2252;">'age'</span>:{<span style="color: #8b2252;">'$gt'</span>:20}}, {<span style="color: #8b2252;">'name'</span>:0, <span style="color: #8b2252;">'age'</span>:<span style="color: #008b8b;">False</span>}) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25490;&#38500;&#12290; 0&#20026;&#25490;&#38500;&#65292;&#38750;0&#20026;&#20801;&#35768;&#12290;&#20294;&#19981;&#33021;&#28151;&#20889;&#12290;</span>
<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> result:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(x), x)

client.close()
</pre>
</div>

<p>
可以使用列表、元组、字典描述字段，或排除投影的字段。
</p>
</div>
</div>
<div id="outline-container-h:2aa49b92-af24-4173-a43f-8487749160bc" class="outline-4">
<h4 id="h:2aa49b92-af24-4173-a43f-8487749160bc">统计</h4>
<div class="outline-text-4" id="text-h:2aa49b92-af24-4173-a43f-8487749160bc">
<ol class="org-ol">
<li>db.collection.find(条件字典).count() 统计次数(已过时)</li>
<li>db.collection.count_documents(条件字典)</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#35745;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#34987;&#24323;&#29992;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">count = users.find({"age":{"$gt":10}}).count()</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27714;&#20986;age&gt;10&#30340;&#25968;&#37327;</span>
<span style="color: #a0522d;">count</span> = users.count_documents({<span style="color: #8b2252;">"age"</span>:{<span style="color: #8b2252;">"$gt"</span>:10}})
<span style="color: #483d8b;">print</span>(count) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;41.2.3.4.5.6.7.8.9.10.11.12.13.14.</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">result</span> = table.find({<span style="color: #8b2252;">'age'</span>:{<span style="color: #8b2252;">'$gt'</span>:20}}).distinct(<span style="color: #8b2252;">'name'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21435; &#37325;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f19fe17a-2c4c-49be-b2e9-756570f476f2" class="outline-4">
<h4 id="h:f19fe17a-2c4c-49be-b2e9-756570f476f2">聚合</h4>
<div class="outline-text-4" id="text-h:f19fe17a-2c4c-49be-b2e9-756570f476f2">
<p>
<a href="https://www.mongodb.com/zh-cn/docs/manual/aggregation/">https://www.mongodb.com/zh-cn/docs/manual/aggregation/</a>
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32858;&#21512;</span>
<span style="color: #a0522d;">result</span> = table.aggregate([
    {<span style="color: #8b2252;">'$match'</span>:{<span style="color: #8b2252;">'age'</span>:{<span style="color: #8b2252;">'$gte'</span>:20}}}, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36807;&#28388;</span>
    { <span style="color: #8b2252;">'$count'</span>:<span style="color: #8b2252;">'age'</span>}
])
<span style="color: #483d8b;">print</span>(*result)
<span style="color: #a0522d;">result</span> = table.count_documents({<span style="color: #8b2252;">'age'</span>:{<span style="color: #8b2252;">'$gte'</span>:20}})
<span style="color: #483d8b;">print</span>(result)
client.close()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32858;&#21512;</span>
<span style="color: #a0522d;">result</span> = table.aggregate([
    {<span style="color: #8b2252;">'$match'</span>:{<span style="color: #8b2252;">'age'</span>:{<span style="color: #8b2252;">'$gte'</span>:5}}},
    {<span style="color: #8b2252;">'$group'</span>:{<span style="color: #8b2252;">'_id'</span>:<span style="color: #8b2252;">'$name'</span>, <span style="color: #8b2252;">'res'</span>:{<span style="color: #8b2252;">'$sum'</span>:<span style="color: #8b2252;">'$age'</span>}}} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#21069;&#38754;&#21152;$&#12290; &#25353;name&#20998;&#32452;&#65292;res&#20026;age&#21512;</span>
])
<span style="color: #483d8b;">print</span>(*result)

client.close()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5eab4f89-6e2d-4333-a012-bfaa4dff7463" class="outline-4">
<h4 id="h:5eab4f89-6e2d-4333-a012-bfaa4dff7463">排序</h4>
<div class="outline-text-4" id="text-h:5eab4f89-6e2d-4333-a012-bfaa4dff7463">
<ol class="org-ol">
<li>db.collection.find().sort(字段名，排序规则)</li>
<li>db.collection.find().sort(list)</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient, ASCENDING, DESCENDING
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25490;&#24207;</span>
<span style="color: #a0522d;">result</span> = table.find().sort(<span style="color: #8b2252;">'age'</span>, DESCENDING)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(result), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)

<span style="color: #a0522d;">result2</span> = table.find().sort([
    (<span style="color: #8b2252;">'name'</span>, DESCENDING), <span style="color: #b22222;"># </span><span style="color: #b22222;">name&#38477;&#24207;</span>
    (<span style="color: #8b2252;">'age'</span>, ASCENDING) <span style="color: #b22222;"># </span><span style="color: #b22222;">age&#21319;&#24207;</span>
])
<span style="color: #483d8b;">print</span>(*result2, sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

client.close()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:76a88896-6c2a-4fb2-89d1-2380df0fc403" class="outline-4">
<h4 id="h:76a88896-6c2a-4fb2-89d1-2380df0fc403">分页</h4>
<div class="outline-text-4" id="text-h:76a88896-6c2a-4fb2-89d1-2380df0fc403">
<ol class="org-ol">
<li>db.collection.find().skip(n).limit(m)
#分页，查询结果中跳过前n个，最多显示m个</li>

<li>skip(n)：从查询结果中跳过前面指定n个</li>
<li>limit(m):从查询结果中最多只显示m个</li>

<li>skip跳过几个，limit限制结果个数</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#39029;</span>
<span style="color: #a0522d;">results</span> = users.find()
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(results),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #a0522d;">results1</span> = users.find().skip(2) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36339;&#36807;&#21069;2&#20010;</span>
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(results1),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #a0522d;">results2</span> = users.find().skip(1).limit(2) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36339;&#36807;&#21069;1&#20010;&#26368;&#22810;&#26174;&#31034;2&#20010;</span>
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(results2),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3f6d2783-2054-460e-bfce-e84b3041734a" class="outline-3">
<h3 id="h:3f6d2783-2054-460e-bfce-e84b3041734a">更新</h3>
<div class="outline-text-3" id="text-h:3f6d2783-2054-460e-bfce-e84b3041734a">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">更新操作符</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">$inc</td>
<td class="org-left">对给定字段数字值增减</td>
<td class="org-left">{"$inc":{"age":-5}}对age的值-5</td>
</tr>

<tr>
<td class="org-left">$set</td>
<td class="org-left">设置字段值，如果字段不存在则创建</td>
<td class="org-left">{"$set":{"gender":"M"}}</td>
</tr>

<tr>
<td class="org-left">$unset</td>
<td class="org-left">移除字段</td>
<td class="org-left">{"$unset":{"Name":""}}</td>
</tr>
</tbody>
</table>


<ul class="org-ul">
<li>db.collection.updateOne(查询条件dict,更新dict)方法只更新查询结果集中的第一个</li>
<li>db.collection.update_many(查询条件dict，更新dict)方法多行更新</li>
<li>db.collection.replace_one(查询条件，新文档dict)
更新一个文档，会将匹配到的第一个结果中的文档替换为新文档。</li>

<li>替换文档，更新除 <code>_id</code> 外的所有字段</li>
</ul>

<p>
update_one更新第一个示例
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">U</span>
<span style="color: #483d8b;">print</span>(*table.find(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;,&#23558;name&#20026;tom&#30340;&#32467;&#26524;&#20013;&#31532;&#19968;&#34892;&#25991;&#26723;&#20013;age&#20943;5</span>
<span style="color: #a0522d;">r</span> = table.update_one({<span style="color: #8b2252;">'name'</span>:<span style="color: #8b2252;">'tom'</span>}, {<span style="color: #8b2252;">'$inc'</span>:{<span style="color: #8b2252;">'age'</span>: -5}})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(r), r.upserted_id, r.modified_count, r.matched_count)

<span style="color: #483d8b;">print</span>(*table.find(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

client.close()
</pre>
</div>


<p>
update_many更新多行
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;,&#23558;name&#20026;tom&#30340;&#23383;&#27573;&#37117;&#28155;&#21152;&#19968;&#20010;gender&#31561;&#20110;m&#30340;&#23646;&#24615;</span>
<span style="color: #a0522d;">result</span> = users.update_many({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"tom"</span>},{<span style="color: #8b2252;">"$set"</span>:{<span style="color: #8b2252;">"gender"</span>:<span style="color: #8b2252;">"M"</span>}})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result),result)
<span style="color: #483d8b;">print</span>(result.matched_count,result.modified_count)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;&#65292;&#23558;&#26377;name&#20026;tom&#30340;&#25991;&#26723;&#20013;&#21253;&#21547;Name&#23646;&#24615;&#30340;&#21024;&#38500;</span>
<span style="color: #a0522d;">result</span> = users.update_many({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"tom"</span>},{<span style="color: #8b2252;">"$unset"</span>:{<span style="color: #8b2252;">"Name"</span>:<span style="color: #8b2252;">""</span>}})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result),result)
<span style="color: #483d8b;">print</span>(result.matched_count,result.modified_count)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
</pre>
</div>


<p>
replace_one替换一个文档
</p>

<ul class="org-ul">
<li>更新除 <code>_id</code> 字段外的所有字段</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26367;&#25442;&#25991;&#26723;</span>
<span style="color: #a0522d;">result</span> = users.replace_one({<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"tom"</span>},{<span style="color: #8b2252;">"id"</span>:200,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"sam"</span>}) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#26367;&#25442;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result),result)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b7389762-82df-4c26-bb7e-02981740efa6" class="outline-3">
<h3 id="h:b7389762-82df-4c26-bb7e-02981740efa6">全文索引</h3>
<div class="outline-text-3" id="text-h:b7389762-82df-4c26-bb7e-02981740efa6">
<p>
<a href="https://www.mongodb.com/zh-cn/docs/manual/text-search/">https://www.mongodb.com/zh-cn/docs/manual/text-search/</a>
</p>

<p>
<a href="https://www.mongodb.com/zh-cn/docs/manual/core/indexes/create-index/">https://www.mongodb.com/zh-cn/docs/manual/core/indexes/create-index/</a>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient, ASCENDING, DESCENDING
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#20840;&#25991;&#32034;&#24341;</span>
<span style="color: #a0522d;">r</span> = table.create_index([(<span style="color: #8b2252;">'name'</span>, <span style="color: #8b2252;">'text'</span>), (<span style="color: #8b2252;">'age'</span>, DESCENDING)])
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(r), r)
<span style="color: #483d8b;">print</span>(*table.find(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

client.close()
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient, ASCENDING, DESCENDING
<span style="color: #a020f0;">from</span> pymongo.synchronous.database <span style="color: #a020f0;">import</span> Database

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'mongodb://127.0.0.1:27017'</span>
<span style="color: #a0522d;">client</span> = MongoClient(url)
<span style="color: #a0522d;">db</span>:<span style="color: #228b22;">Database</span> = client[<span style="color: #8b2252;">'users'</span>]
<span style="color: #a0522d;">table</span> = db[<span style="color: #8b2252;">'users'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">db.users</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;"># &#21019;&#24314;&#20840;&#25991;&#32034;&#24341;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">r = table.create_index([('name', 'text'), ('age', DESCENDING)])</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(r), r)</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#25991;&#25628;&#32034;</span>
<span style="color: #a0522d;">r</span> = table.find({<span style="color: #8b2252;">'$text'</span>:{<span style="color: #8b2252;">'$search'</span>: <span style="color: #8b2252;">'tom china'</span>}}) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25628;&#32034;&#21253;&#21547; tom&#25110;china&#30340;&#25991;&#26723;</span>
<span style="color: #483d8b;">print</span>(*r, sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

client.close()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:888b2a5f-2c89-4ec5-8577-733337658097" class="outline-3">
<h3 id="h:888b2a5f-2c89-4ec5-8577-733337658097">删除</h3>
<div class="outline-text-3" id="text-h:888b2a5f-2c89-4ec5-8577-733337658097">
<ul class="org-ul">
<li>db.collection.remove(条件dict) #删除，已过时的方法</li>
<li>db.collection.delete_one(条件dict) #将满足条件的结果删除第一行</li>
<li>db.collection.delete_many(条件dict)#将满足条件的结果全部删除</li>

<li>db.collection.delete_many({})删除所有文档，慎用</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient
<span style="color: #a020f0;">from</span> pymongo.collection <span style="color: #a020f0;">import</span> Collection
<span style="color: #a020f0;">from</span> pymongo.results <span style="color: #a020f0;">import</span> DeleteResult

<span style="color: #a0522d;">client</span> = MongoClient(<span style="color: #8b2252;">"mongodb://127.0.0.1:27017"</span>)
<span style="color: #a0522d;">db</span> = client[<span style="color: #8b2252;">"blog"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">users</span>:<span style="color: #228b22;">Collection</span> = db.users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;age&#20026;20&#30340;&#25991;&#26723;&#65292;&#21482;&#21024;&#38500;&#19968;&#26465;</span>
<span style="color: #a0522d;">result</span>:<span style="color: #228b22;">DeleteResult</span> = users.delete_one({<span style="color: #8b2252;">"age"</span>:20})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result),result.deleted_count)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25152;&#26377;&#23384;&#22312;age&#23383;&#27573;&#30340;&#25991;&#26723;</span>
<span style="color: #a0522d;">result2</span>:<span style="color: #228b22;">DeleteResult</span> = users.delete_many({<span style="color: #8b2252;">"age"</span>:{<span style="color: #8b2252;">"$exists"</span>:<span style="color: #008b8b;">True</span>}})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(result2),result2.deleted_count)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(users.find()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:05056423-ee64-468c-bdd6-ad4f63b6d935" class="outline-2">
<h2 id="h:05056423-ee64-468c-bdd6-ad4f63b6d935">HTML解析-BeautifulSoup4</h2>
<div class="outline-text-2" id="text-h:05056423-ee64-468c-bdd6-ad4f63b6d935">
</div>
<div id="outline-container-h:3588ac25-80d5-414f-914c-fff2fad17e68" class="outline-3">
<h3 id="h:3588ac25-80d5-414f-914c-fff2fad17e68">BeautifulSoup4</h3>
<div class="outline-text-3" id="text-h:3588ac25-80d5-414f-914c-fff2fad17e68">
<p>
BeautifulSoup可以从HTML、XML中提取数据，目前BS4在持续开发。
</p>

<p>
<a href="https://www.crummy.com/software/BeautifulSoup/">https://www.crummy.com/software/BeautifulSoup/</a>
</p>

<p>
官方中文文档<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/">https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/</a>
</p>
</div>
<div id="outline-container-h:92a7357f-fd46-4b94-92a6-c8d7c3ab9d7f" class="outline-4">
<h4 id="h:92a7357f-fd46-4b94-92a6-c8d7c3ab9d7f">安装</h4>
<div class="outline-text-4" id="text-h:92a7357f-fd46-4b94-92a6-c8d7c3ab9d7f">
<div class="org-src-container">
<pre class="src src-sh">pip install bs4
<span style="color: #b22222;">#</span><span style="color: #b22222;">pip install beautifulsoup4</span>

pip install lxml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d61e1ef5-9e47-4c0c-bd1d-dae6373b48ea" class="outline-4">
<h4 id="h:d61e1ef5-9e47-4c0c-bd1d-dae6373b48ea">初始化</h4>
<div class="outline-text-4" id="text-h:d61e1ef5-9e47-4c0c-bd1d-dae6373b48ea">
<p>
BeautifulSoup(markup=““,features=None)
</p>
<ul class="org-ul">
<li>markup,被解析对象，可以是文件对象或者html字符串</li>
<li>feature指定解析器</li>
<li>return:返回一个文档对象</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#23545;&#35937;</span>
<span style="color: #a0522d;">soup</span> = BeautifulSoup(<span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>))
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26631;&#35760;&#23383;&#31526;&#20018;</span>
<span style="color: #a0522d;">soup</span> = BeautifulSoup(<span style="color: #8b2252;">"&lt;html&gt;data&lt;/html&gt;"</span>)
</pre>
</div>

<p>
可以不指定解析器，就依赖系统已经安装的解析器库了。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">解析器</th>
<th scope="col" class="org-left">使用方法</th>
<th scope="col" class="org-left">优势</th>
<th scope="col" class="org-left">劣势</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Python标准库</td>
<td class="org-left">BeautifulSoup(markup,"html.parser")</td>
<td class="org-left">Python的内置标准库执行速度适中文档容错能力强</td>
<td class="org-left">Python 2.7.3、3.2.2前 的版本中文档容错能力差</td>
</tr>

<tr>
<td class="org-left">lxml HTML 解析器</td>
<td class="org-left">BeautifulSoup(markup,"lxml")</td>
<td class="org-left">速度快文档容错能力强</td>
<td class="org-left">需要安装C语言库</td>
</tr>

<tr>
<td class="org-left">lxml XML 解析器</td>
<td class="org-left">BeautifulSoup(markup,["lxml","xml"])BeautifulSoup(markup,"xml")</td>
<td class="org-left">速度快唯一支持XML的解析器</td>
<td class="org-left">需要安装C语言库</td>
</tr>

<tr>
<td class="org-left">html5lib</td>
<td class="org-left">BeautifulSoup(markup,"html5lib")</td>
<td class="org-left">最好的容错性以浏览器的方式解析文档生成HTML5格式的文档</td>
<td class="org-left">速度慢不依赖外部扩展</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>BeautifulSoup(markup,"html.parser")使用Python标准库，容错差且性能一般。</li>
<li>BeautifulSoup(markup,"lxml")容错能力强，速度快。需要安装系统C库。</li>
<li>推荐使用lxml作为解析器，效率高。</li>
<li>需要手动指定解析器，以保证代码在所有运行环境中解析器一致。</li>

<li>使用下面内容构建test.html使用bs4解析它</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#39318;&#39029;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">TEST</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"main"</span>&gt;
    &lt;<span style="color: #0000ff;">h3</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"title highlight"</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"http://www.python.org"</span>&gt;python&lt;/<span style="color: #0000ff;">a</span>&gt;&#39640;&#32423;&#29677;&lt;/<span style="color: #0000ff;">h3</span>&gt;
    &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"content"</span>&gt;
        &lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"first"</span>&gt;&#23383;&#20856;&lt;/<span style="color: #0000ff;">p</span>&gt;
        &lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"second"</span>&gt;&#21015;&#34920;&lt;/<span style="color: #0000ff;">p</span>&gt;
        &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"_csrf"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"absdoia23lkso234r23oslfn"</span>&gt;
        <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">comment</span><span style="color: #b22222;"> --&gt;</span>
        &lt;<span style="color: #0000ff;">img</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bg1"</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://www.cici.com/"</span>&gt;
        &lt;<span style="color: #0000ff;">img</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"bg2"</span> <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://httpbin.org/"</span>&gt;
    &lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;<span style="color: #0000ff;">p</span>&gt;bottom&lt;/<span style="color: #0000ff;">p</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)
    <span style="color: #483d8b;">print</span>(doc.prettify())
</pre>
</div>

<p>
将html对象转化为DOM树，剩下是如何定位数据了。
</p>
</div>
</div>
<div id="outline-container-h:205fa938-a497-4314-a9b6-63fe7837c826" class="outline-4">
<h4 id="h:205fa938-a497-4314-a9b6-63fe7837c826">四种对象</h4>
<div class="outline-text-4" id="text-h:205fa938-a497-4314-a9b6-63fe7837c826">
<p>
BeautifulSoup将HTML文档解析成复杂的树型结构，每个节点都是Python的对象，可分为4种：
</p>
<ul class="org-ul">
<li>BeautifulSoup、Tag、NavigableString、Comment</li>
</ul>
</div>
<div id="outline-container-h:4e6e25aa-236c-4d07-8974-99988843972a" class="outline-5">
<h5 id="h:4e6e25aa-236c-4d07-8974-99988843972a">BeautifulSoup对象</h5>
<div class="outline-text-5" id="text-h:4e6e25aa-236c-4d07-8974-99988843972a">
<p>
代表整个文档。
</p>
</div>
</div>
<div id="outline-container-h:66bfc311-2309-4599-b3bd-795c6c657781" class="outline-5">
<h5 id="h:66bfc311-2309-4599-b3bd-795c6c657781">Tag对象</h5>
<div class="outline-text-5" id="text-h:66bfc311-2309-4599-b3bd-795c6c657781">
<p>
对应着HTML中的标签。有2个常用的属性：
</p>

<ol class="org-ol">
<li>name:Tag对象的名称，就是标签名称</li>
<li>attrs:标签的属性字典
<ul class="org-ul">
<li>多值属性，对于class属性可能是下面的形式， <code>&lt;h3 class="title highlight"&gt;python高级班&lt;/h3&gt;</code> 这个属性就是多值({"class":["title","highlight"]})</li>
<li>属性可以被修改、删除</li>
</ul></li>

<li>BeautifulSoup.prettify()
​#带格式输出解析的文档对象(即有缩进的输出)，注意：直接输出BeautifulSoup会直接输出解析的文档对象，没有格式。</li>
<li>BeautifulSoup.div
​#输出匹配到的第一个div对象中的内容，返回对象是bs4.element.Tag类型</li>
<li>BeautifulSoup.h3.get("class")
​#获取文档中第一个标签为h3对象中class属性值</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.builder)
    <span style="color: #483d8b;">print</span>(0,soup) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#25972;&#20010;&#35299;&#26512;&#30340;&#25991;&#26723;&#23545;&#35937;(&#19981;&#24102;&#26684;&#24335;&#65289;</span>
    <span style="color: #483d8b;">print</span>(1,soup.prettify()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#29031;&#26684;&#24335;&#36755;&#20986;&#25991;&#26723;&#20869;&#23481;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #a0522d;">div</span> = soup.div
    <span style="color: #483d8b;">print</span>(2, div, <span style="color: #483d8b;">type</span>(div)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#22411;bs4.element.Tag&#65292;Tag&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(3, div.name, div.attrs)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23646;&#24615;&#33719;&#21462;</span>
    <span style="color: #483d8b;">print</span>(div.attrs[<span style="color: #8b2252;">'id'</span>], div.attrs.get(<span style="color: #8b2252;">'id'</span>), div.get(<span style="color: #8b2252;">'id'</span>), div[<span style="color: #8b2252;">'id'</span>]) <span style="color: #b22222;"># </span><span style="color: #b22222;">4&#31181;&#19968;&#26679;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(3, div['class']) #KeyError, div&#27809;&#26377;class&#23646;&#24615;</span>
    <span style="color: #483d8b;">print</span>(3, div.get(<span style="color: #8b2252;">'class'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#36820;&#22238;None</span>

    <span style="color: #a0522d;">h3</span> = soup.h3
    <span style="color: #483d8b;">print</span>(4, h3.get(<span style="color: #8b2252;">'class'</span>), h3[<span style="color: #8b2252;">"class"</span>], h3.attrs[<span style="color: #8b2252;">'class'</span>], h3.attrs.get(<span style="color: #8b2252;">'class'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20540;&#23646;&#24615; ['title', 'highlight']</span>

    <span style="color: #483d8b;">print</span>(5,soup.img.get(<span style="color: #8b2252;">"src"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;img&#20013;src&#23646;&#24615;&#20540;</span>
    soup.<span style="color: #a0522d;">img</span>[<span style="color: #8b2252;">"src"</span>] = <span style="color: #8b2252;">"http://www.ciciupdate.com"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20540;</span>
    <span style="color: #483d8b;">print</span>(5,soup.img[<span style="color: #8b2252;">"src"</span>])
    <span style="color: #483d8b;">print</span>(6,soup.a) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#19981;&#21040;&#36820;&#22238;None</span>

    <span style="color: #a020f0;">del</span> soup.h3[<span style="color: #8b2252;">"class"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#23646;&#24615;</span>
    <span style="color: #483d8b;">print</span>(4,soup.h3.get(<span style="color: #8b2252;">"class"</span>))
</pre>
</div>

<p>
注意：我们一般不使用声明这种方式来操作HTML，此代码时为了熟悉对象类型
</p>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(doc.prettify()) #&#25353;&#29031;&#26684;&#24335;&#36755;&#20986;&#25991;&#26723;&#20869;&#23481;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(doc)) # soup &#23545;&#35937;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Tag object &lt;=&gt; soup object</span>
    <span style="color: #a0522d;">x</span>:<span style="color: #228b22;">Tag</span> = doc.p <span style="color: #b22222;"># </span><span style="color: #b22222;">soup.find('p') __getattr__ &#25214;p&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(x), x, x.name)  <span style="color: #b22222;"># </span><span style="color: #b22222;">bs4.element.Tag &lt;p id="first"&gt;&#23383;&#20856;&lt;/p&gt;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">y = doc.div.div</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(y)</span>

    <span style="color: #483d8b;">print</span>(x.attrs, <span style="color: #483d8b;">type</span>(x.attrs))
    <span style="color: #483d8b;">print</span>(x.attrs.get(<span style="color: #8b2252;">'id'</span>), x.attrs[<span style="color: #8b2252;">'id'</span>])
    <span style="color: #483d8b;">print</span>(x.get(<span style="color: #8b2252;">'id'</span>), x[<span style="color: #8b2252;">'id'</span>]) <span style="color: #b22222;"># </span><span style="color: #b22222;">Tag __getitem__</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    <span style="color: #a0522d;">y</span> = doc.h3
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(y.attrs), y.attrs) <span style="color: #b22222;"># </span><span style="color: #b22222;">class &#22810;&#20540;&#23383;&#20856;</span>
    <span style="color: #483d8b;">print</span>(y.attrs.get(<span style="color: #8b2252;">'class'</span>))
    <span style="color: #483d8b;">print</span>(y.get(<span style="color: #8b2252;">'class'</span>), y[<span style="color: #8b2252;">'class'</span>])
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
    <span style="color: #a0522d;">img</span> = doc.div.img
    <span style="color: #483d8b;">print</span>(img.get(<span style="color: #8b2252;">'src'</span>))
    <span style="color: #a0522d;">img</span>[<span style="color: #8b2252;">'src'</span>] = <span style="color: #8b2252;">'https://baidu.com'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">Tag __setitem__</span>
    <span style="color: #483d8b;">print</span>(img.get(<span style="color: #8b2252;">'src'</span>))

    <span style="color: #a020f0;">del</span> img[<span style="color: #8b2252;">'src'</span>]
    <span style="color: #483d8b;">print</span>(img.get(<span style="color: #8b2252;">'src'</span>, <span style="color: #8b2252;">'nothing'</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f372f832-a871-4ce8-9fc3-12ecad8fcfc0" class="outline-5">
<h5 id="h:f372f832-a871-4ce8-9fc3-12ecad8fcfc0">NavigableString</h5>
<div class="outline-text-5" id="text-h:f372f832-a871-4ce8-9fc3-12ecad8fcfc0">
<p>
如果只想输出标记的文本，而不关心标记的话，就要使用NavigableString.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.div.p.string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#20010;div&#19979;&#31532;&#19968;&#20010;p&#30340;&#23383;&#31526;&#20018;</span>
<span style="color: #483d8b;">print</span>(soup.p.string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19978;</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)
    <span style="color: #483d8b;">print</span>(doc.p.string)
    <span style="color: #483d8b;">print</span>(doc.div.string) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20165;&#26377;&#19968;&#20010;&#25991;&#26412;&#31867;&#22411;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(doc.h3.a.string, <span style="color: #483d8b;">type</span>(doc.h3.a.string)) <span style="color: #b22222;"># </span><span style="color: #b22222;">python &lt;class 'bs4.element.NavigableString'&gt;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:03a4dad0-6b36-4185-80f3-a11b571a46b8" class="outline-5">
<h5 id="h:03a4dad0-6b36-4185-80f3-a11b571a46b8">注释对象</h5>
<div class="outline-text-5" id="text-h:03a4dad0-6b36-4185-80f3-a11b571a46b8">
<p>
这就是HTML中的注释，它被BeautifulSoup解析后对应Comment对象。
</p>
</div>
</div>
</div>
<div id="outline-container-h:1e6751b5-780e-4f68-8535-4e3974da24a2" class="outline-4">
<h4 id="h:1e6751b5-780e-4f68-8535-4e3974da24a2">遍历文档树</h4>
<div class="outline-text-4" id="text-h:1e6751b5-780e-4f68-8535-4e3974da24a2">
<p>
在文档树中找到关心的内容才是日常的工资，也就是说如何遍历树中的节点。使用上面的test.html来测试
</p>
</div>
<div id="outline-container-h:f79a7c2e-fce5-41e4-9567-8b89b57d8a7c" class="outline-5">
<h5 id="h:f79a7c2e-fce5-41e4-9567-8b89b57d8a7c">使用Tag</h5>
<div class="outline-text-5" id="text-h:f79a7c2e-fce5-41e4-9567-8b89b57d8a7c">
<ul class="org-ul">
<li>soup.div可以找到从根节点开始查找第一个div节点,返回一个Tag对象</li>
<li>soup.div.p说明从根节点开始找到第一个div后返回一个Tag对象，这个Tag对象下继续找第一个p，找到返回Tag对象</li>
<li>soup.p返回了文字“字典”，而不是文字“bottom”说明遍历时 <b>深度优先</b> ，返回也是Tag对象</li>
</ul>
</div>
</div>
<div id="outline-container-h:af4d40a5-350c-4bc8-b908-df663b1d1e79" class="outline-5">
<h5 id="h:af4d40a5-350c-4bc8-b908-df663b1d1e79">遍历直接子节点</h5>
<div class="outline-text-5" id="text-h:af4d40a5-350c-4bc8-b908-df663b1d1e79">
<ul class="org-ul">
<li>Tag.contents #将对象的所有类型直接子节点以列表方式输出</li>
<li>Tag.children #返回子节点的迭代器
<ul class="org-ul">
<li>Tag.children #等价于Tag.contents</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:f4c96c66-28a9-4ab0-b581-34dedeceed66" class="outline-5">
<h5 id="h:f4c96c66-28a9-4ab0-b581-34dedeceed66">遍历所有子孙节点</h5>
<div class="outline-text-5" id="text-h:f4c96c66-28a9-4ab0-b581-34dedeceed66">
<ul class="org-ul">
<li>Tag.descendants
​#返回节点的所有类型子孙节点，可以看出迭代次序是深度优先</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.p.string)
    <span style="color: #483d8b;">print</span>(soup.div.contents) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#23376;&#26631;&#31614;&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> soup.div.children: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#23376;&#26631;&#31614;&#21487;&#36845;&#20195;&#23545;&#35937;</span>
        <span style="color: #483d8b;">print</span>(i.name)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(
        <span style="color: #a020f0;">lambda</span> x:x.name <span style="color: #a020f0;">if</span> x.name <span style="color: #a020f0;">else</span> x,
        soup.div.descendants <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#23376;&#23385;</span>
    )))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:347c6706-8220-4f1a-ad6c-c0171b6ad795" class="outline-5">
<h5 id="h:347c6706-8220-4f1a-ad6c-c0171b6ad795">遍历字符串</h5>
<div class="outline-text-5" id="text-h:347c6706-8220-4f1a-ad6c-c0171b6ad795">
<p>
在前面的例子中，soup.div.string返回None，是因为string要求soup.div只能有一个NavigableString类型子节点，也就是这样 <code>&lt;div&gt;only string&lt;/div&gt;</code> 。
</p>

<p>
如果div有很多子孙节点，如何提取字符串？
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.div.string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;None&#65292;&#22240;&#20026;&#22810;&#20313;1&#20010;&#23376;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">""</span>.join(soup.div.strings) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#36845;&#20195;&#22120;&#65292;&#24102;&#22810;&#20313;&#30340;&#31354;&#30333;&#23383;&#31526;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">""</span>.join(soup.div.stripped_strings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#36845;&#20195;&#22120;&#65292;&#21435;&#38500;&#22810;&#20313;&#31354;&#30333;&#23383;&#31526;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4cc29918-ee11-40a1-8f9d-5e97a595dd31" class="outline-5">
<h5 id="h:4cc29918-ee11-40a1-8f9d-5e97a595dd31">遍历祖先节点</h5>
<div class="outline-text-5" id="text-h:4cc29918-ee11-40a1-8f9d-5e97a595dd31">
<ul class="org-ul">
<li>BeautifulSoup.parent
​#获取根节点的父结点，必定返回None,根节点没有父结点</li>
<li>Tag.parent #获取第一个Tag的父结点</li>
<li>Tag.parent.parent.get("id") #获取第一个tag的父结点的父结点的id属性</li>
<li>Tag.parents #获取Tag节点的所有父结点，由近及远</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(soup))
    <span style="color: #483d8b;">print</span>(soup.parent) <span style="color: #b22222;">#</span><span style="color: #b22222;">None &#26681;&#33410;&#28857;&#27809;&#26377;&#29238;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(soup.div.parent.name) <span style="color: #b22222;">#</span><span style="color: #b22222;">body ,&#31532;&#19968;&#20010;div&#30340;&#29238;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(soup.p.parent.parent.get(<span style="color: #8b2252;">"id"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;id&#23646;&#24615;&#65292; main</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.name,soup.p.parents))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29238;&#36845;&#20195;&#22120;&#65292;&#30001;&#36817;&#21450;&#36828;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:24e5fb4f-e72e-42e5-b36c-d7dc16fad7c4" class="outline-5">
<h5 id="h:24e5fb4f-e72e-42e5-b36c-d7dc16fad7c4">遍历兄弟节点</h5>
<div class="outline-text-5" id="text-h:24e5fb4f-e72e-42e5-b36c-d7dc16fad7c4">
<ul class="org-ul">
<li>Tag.next_sibling
​#第一个Tag元素的下一个(下面)兄弟节点，注意：可能是一个文本节点</li>
<li>Tag.previous_sibling
​#第一个Tag元素之前的兄弟节点(上面)，注意：可能是一个文本节点</li>
<li>Tag.next_siblings #获取Tag元素的下面的所有兄弟节点</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} [{}]'</span>.<span style="color: #483d8b;">format</span>(1, soup.p.next_sibling)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#20010;p&#20803;&#32032;&#30340;&#19979;&#19968;&#20010;&#20804;&#24351;&#33410;&#28857;,&#27880;&#24847;&#21487;&#33021;&#26159;&#19968;&#20010;&#25991;&#26412;&#33410;&#28857;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} [{}]'</span>.<span style="color: #483d8b;">format</span>(2, soup.previous_sibling))
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_siblings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#21516;&#32423;&#20804;&#24351;,&#21253;&#25324;&#25991;&#26412;&#12290;previous_siblings</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e4ffe803-59ef-4e07-abbf-b7c9414cb3b0" class="outline-5">
<h5 id="h:e4ffe803-59ef-4e07-abbf-b7c9414cb3b0">遍历其他元素*</h5>
<div class="outline-text-5" id="text-h:e4ffe803-59ef-4e07-abbf-b7c9414cb3b0">
<ul class="org-ul">
<li>Tag.next_element 是下一个可被解析的对象(字符串或tag),和下一个兄弟节点next_sibling不一样</li>
<li>Tag.next_elements #返回所有下一个可被解析的对象，是个可迭代对象。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(soup),<span style="color: #483d8b;">type</span>(soup.p))
    <span style="color: #483d8b;">print</span>(soup.p.next_element) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;"&#23383;&#20856;"2&#20010;&#23383;</span>
    <span style="color: #483d8b;">print</span>(soup.p.next_element.next_element.encode())
    <span style="color: #483d8b;">print</span>(soup.p.next_element.next_element.next_element)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_elements))

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#27604;&#24046;&#24322;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_elements))
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(soup.p.next_siblings))
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)
    <span style="color: #483d8b;">print</span>(doc.div.contents)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    <span style="color: #483d8b;">print</span>(*doc.div.children, sep=<span style="color: #8b2252;">'||'</span>)
    <span style="color: #483d8b;">print</span>(doc.parent)
    <span style="color: #483d8b;">print</span>(doc.div.parent.name)
    <span style="color: #483d8b;">print</span>(doc.div.parent.attrs)
    <span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.name, doc.div.p.parents)) <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#21482;&#26377;Tag&#31867;&#22411;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
    <span style="color: #483d8b;">print</span>(*doc.div.descendants, sep=<span style="color: #8b2252;">'|||'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#23618;&#27425;&#30340;&#23376;&#23385;&#65292;&#20063;&#21253;&#25324;&#25991;&#26412;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'============'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#19968;&#20010;&#20803;&#32032;</span>
    <span style="color: #483d8b;">print</span>(doc.div.p.next_sibling) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#36744;&#30340;&#26631;&#31614;&#23545;&#35937;&#65292;&#21253;&#25324;&#25991;&#26412;</span>
    <span style="color: #483d8b;">print</span>(doc.div.p.next_sibling.next_sibling)
    <span style="color: #483d8b;">print</span>(doc.div.p.next_sibling.next_sibling.next_sibling)
    <span style="color: #483d8b;">print</span>(doc.div.p.next_sibling.next_sibling.next_sibling.next_sibling)
    <span style="color: #483d8b;">print</span>(*doc.div.p.next_siblings, sep=<span style="color: #8b2252;">"***"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~'</span> * 30)
    <span style="color: #483d8b;">print</span>(doc.div.p.next_element) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23383;&#20856;</span>
    <span style="color: #483d8b;">print</span>(doc.div.p.next_element.next_element) <span style="color: #b22222;"># </span><span style="color: #b22222;">\n</span>
    <span style="color: #483d8b;">print</span>(doc.div.p.next_element.next_element.next_element) <span style="color: #b22222;"># </span><span style="color: #b22222;">p</span>
    <span style="color: #483d8b;">print</span>(doc.div.p.next_element.next_element.next_element.next_element) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
    <span style="color: #483d8b;">print</span>(*doc.div.p.next_elements, sep=<span style="color: #8b2252;">'&amp;&amp;&amp;'</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641" class="outline-4">
<h4 id="h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641">搜索文档树</h4>
<div class="outline-text-4" id="text-h:6aeeac0b-f92d-46a7-8ca6-b7d9b3c1e641">
<p>
find系有很多分发，请执行查询帮助
</p>
<ul class="org-ul">
<li><a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/#id25">https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/#id25</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">find_all</span>(<span style="color: #a0522d;">name</span>=None,<span style="color: #a0522d;">attrs</span>={},<span style="color: #a0522d;">recursive</span>=True,<span style="color: #a0522d;">string</span>=None,<span style="color: #a0522d;">limit</span>=None,**kwargs) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31435;&#21363;&#36820;&#22238;&#19968;&#20010;&#21015;&#34920;</span>
</pre>
</div>
</div>
<div id="outline-container-h:3da6606b-462f-4a9c-8393-bc154fac34e0" class="outline-5">
<h5 id="h:3da6606b-462f-4a9c-8393-bc154fac34e0">name参数</h5>
<div class="outline-text-5" id="text-h:3da6606b-462f-4a9c-8393-bc154fac34e0">
<p>
官方称为 <b>fiter过滤器</b> ，这个参数可以是一下
</p>

<p>
1 字符串：一个标签名称的字符串，会按照这个字符串全长匹配标签名
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #8b2252;">'p'</span>))<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26723;&#20013;&#25152;&#26377;p&#26631;&#31614;</span>
</pre>
</div>

<p>
2 正则表达式对象:按照”正则表达式对象”的模式匹配标签名
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> re
<span style="color: #483d8b;">print</span>(soup.find_all(re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"^h\d"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#31614;&#21517;&#20197;h&#24320;&#22836;&#21518;&#25509;&#25968;&#23383;</span>
</pre>
</div>

<p>
3 列表：或关系查找列表中的每个字符串
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all([<span style="color: #8b2252;">"p"</span>,<span style="color: #8b2252;">"h1"</span>,<span style="color: #8b2252;">"h3"</span>])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#20851;&#31995;&#65292;&#25214;&#20986;&#21015;&#34920;&#25152;&#26377;&#30340;&#26631;&#31614;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"^p|h|\d$"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;&#23436;&#25104;</span>
</pre>
</div>

<p>
4 True或None，则find_all返回全部非字符串节点、非注释节点，就是Tag标签类型
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.name, soup.find_all(<span style="color: #008b8b;">True</span>))))
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.name, soup.find_all(<span style="color: #008b8b;">None</span>))))
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: x.name, soup.find_all())))
</pre>
</div>

<p>
源码中确实上面三种情况都返回的Tag类型
</p>


<p>
5 函数
</p>
<ul class="org-ul">
<li>如果使用以上过滤器还不能提取想要的节点，可以使用函数，此函数仅只能*接收一个参数*。</li>
<li>如果这个函数返回True,表示当前节点配置；返回False则是不匹配。</li>

<li>示例：找出所有class属性且有多个值的节点(测试html中符合这个条件只有h3标签)</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">many_classes</span>(tag:Tag):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(tag))</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(tag.attrs))</span>
    <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">len</span>(tag.attrs.get(<span style="color: #8b2252;">"class"</span>,[])) &gt; 1

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.find_all(many_classes))
</pre>
</div>

<p>
范例: 找到出所有class属性且有多个值的节点
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag
<span style="color: #a020f0;">import</span> re

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35831;&#25552;&#21462;&#23646;&#24615;&#20540;&#26159;2&#20010;&#30340;&#26631;&#31614;&#23545;&#35937;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">def test(tag:Tag):</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;"># print('+++++++++++++')</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">if isinstance(tag, Tag):</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;"># print(type(tag), tag.name, tag.attrs.get('class'))</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;">attr = tag.get('class')</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;">if isinstance(attr, list):</span>
<span style="color: #b22222;">#             </span><span style="color: #b22222;">if len(attr) &gt;1:</span>
<span style="color: #b22222;">#                 </span><span style="color: #b22222;">print(tag.name)</span>
<span style="color: #b22222;">#                 </span><span style="color: #b22222;">return True</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">return False</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">def test(tag:Tag):</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">return True if isinstance(tag, Tag) and isinstance(tag.get('class'), list) and len(tag.get('class')) &gt;1 else False</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">def test(tag:Tag):</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">return isinstance(tag, Tag) and isinstance(tag.get('class'), list) and len(tag.get('class')) &gt;1</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">many_values</span>(tag:Tag):
    <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">isinstance</span>(tag, Tag) <span style="color: #a020f0;">and</span> <span style="color: #483d8b;">len</span>(tag.get(<span style="color: #8b2252;">'class'</span>, [])) &gt;1


<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">BeautifulSoup Tag&#25317;&#26377; find find_all&#26041;&#27861;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;1</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">x = doc.find_all('div') # &#25214;div&#26631;&#31614;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(x), x)</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print('-' * 30)</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">for i in x:</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">print(type(i), i)</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">print('&lt;&gt;'*30)</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(doc.find_all('p'))</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;2</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'h\d|p'</span>))) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21253;&#21547;&#26377;h&#25968;&#23383;&#30340;&#26631;&#31614;&#25110;&#32773;&#21253;&#21547;p&#30340;&#26631;&#31614;</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;3</span>
    <span style="color: #483d8b;">print</span>(doc.find_all([<span style="color: #8b2252;">'p'</span>, <span style="color: #8b2252;">'a'</span>])) <span style="color: #b22222;"># </span><span style="color: #b22222;">p &#26631;&#31614;&#25110;a&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'^(a|p)$'</span>))) <span style="color: #b22222;"># </span><span style="color: #b22222;">p &#26631;&#31614;&#25110;a&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(doc.find_all([<span style="color: #8b2252;">'p'</span>, <span style="color: #8b2252;">'a'</span>, re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'h\d'</span>)]))  <span style="color: #b22222;"># </span><span style="color: #b22222;">p &#26631;&#31614;&#25110;a&#26631;&#31614;&#25110;&#32773;&#21253;&#21547;&#26377;h&#25968;&#23383;&#30340;&#26631;&#31614;</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;4</span>
    <span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> <span style="color: #a0522d;">x</span>:<span style="color: #228b22;">x</span>.<span style="color: #228b22;">name</span>, <span style="color: #228b22;">doc</span>.<span style="color: #228b22;">find_all</span>(<span style="color: #008b8b;">None</span>))) <span style="color: #b22222;"># </span><span style="color: #b22222;">find_all =&gt; Tag&#31867;&#22411;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;5</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(many_values))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f7e80de2-1e3f-4eb9-8ecb-49f2dd33c98b" class="outline-5">
<h5 id="h:f7e80de2-1e3f-4eb9-8ecb-49f2dd33c98b">keyword传参</h5>
<div class="outline-text-5" id="text-h:f7e80de2-1e3f-4eb9-8ecb-49f2dd33c98b">
<ol class="org-ol">
<li>使用关键字传参，如果参数名不是find系函数已定义的位置参数名，参数会被kwargs收集并被 <b>当做标签的属性</b> 来搜索。</li>
<li>属性的传参可以是字符串、正则表达式对象、True、列表。</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #8b2252;">"first"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">id&#20026;first&#30340;&#25152;&#26377;&#32467;&#28857;&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(1,<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"\w+"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#25214;&#26377;di&#30340;&#25152;&#26377;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(2,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#26377;id&#30340;&#33410;&#28857;</span>

    <span style="color: #483d8b;">print</span>(3,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x[<span style="color: #8b2252;">"id"</span>],soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>))))
    <span style="color: #483d8b;">print</span>(4,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=[<span style="color: #8b2252;">"first"</span>,re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"^sec"</span>)])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;id&#30340;&#21517;&#31216;&#21015;&#34920;</span>
    <span style="color: #483d8b;">print</span>(5,<span style="color: #8b2252;">"- "</span> * 30)
    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>,src=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#26465;&#20214;and,&#26082;&#26377;id&#21448;&#26377;src&#23646;&#24615;&#30340;&#33410;&#28857;&#21015;&#34920;</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test</span>(t):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'++++'</span>)
    <span style="color: #a020f0;">if</span> t:
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(t), t)
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(doc.find_all(id='main')) # **kwargs</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #8b2252;">'first'</span>))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    <span style="color: #483d8b;">print</span>(doc.find_all(src=<span style="color: #008b8b;">True</span>, <span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">and</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(<span style="color: #483d8b;">id</span>=[<span style="color: #8b2252;">'second'</span>, re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'\d$'</span>)])) <span style="color: #b22222;"># </span><span style="color: #b22222;">or&#20851;&#31995;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
    <span style="color: #483d8b;">print</span>(*doc.find_all(<span style="color: #483d8b;">id</span>=test), sep=<span style="color: #8b2252;">'||||||||'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#31526;&#21512;&#26465;&#20214;&#30340;Tag&#23545;&#35937;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9d9cbff6-9daf-45ef-a76f-0b866aaaf51c" class="outline-5">
<h5 id="h:9d9cbff6-9daf-45ef-a76f-0b866aaaf51c">css的class的特殊处理</h5>
<div class="outline-text-5" id="text-h:9d9cbff6-9daf-45ef-a76f-0b866aaaf51c">
<ol class="org-ol">
<li>class是Python关键字，所以使用 <code>class_</code> 。class是多值属性，可以匹配其中任意一个，也可以完全匹配。</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"content"</span>))
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"title"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20351;&#29992;&#20219;&#24847;&#19968;&#20010;css&#31867;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"highlight"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20351;&#29992;&#20219;&#24847;&#19968;&#20010;css&#31867;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"highlight title"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39034;&#24207;&#38169;&#20102;&#65292;&#25214;&#19981;&#21040;</span>
<span style="color: #483d8b;">print</span>(soup.find_all(class_=<span style="color: #8b2252;">"title highlight"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39034;&#24207;&#19968;&#33268;&#65292;&#25214;&#21040;&#12290;&#23601;&#26159;&#23383;&#31526;&#20018;&#23436;&#20840;&#21305;&#37197;</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)

    <span style="color: #483d8b;">print</span>(doc.find_all(class_=<span style="color: #008b8b;">True</span>))
    <span style="color: #483d8b;">print</span>(doc.find_all(class_=<span style="color: #8b2252;">'highlight'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23383;&#31526;&#20840;&#38271;&#21305;&#37197;&#12290; &#21305;&#37197;</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(class_=<span style="color: #8b2252;">'highlight title'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23383;&#31526;&#19981;&#21305;&#37197;&#36820;&#22238;&#31354;</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(class_=<span style="color: #8b2252;">'title highlight'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    <span style="color: #483d8b;">print</span>(doc.find_all(class_=re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'e$'</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1c9b771f-a6ac-4a1a-bc4a-e22b988bf46b" class="outline-5">
<h5 id="h:1c9b771f-a6ac-4a1a-bc4a-e22b988bf46b">attrs参数</h5>
<div class="outline-text-5" id="text-h:1c9b771f-a6ac-4a1a-bc4a-e22b988bf46b">
<ul class="org-ul">
<li>attrs接收一个字典，字典的key为属性名，value可以是字符串、正则表达式对象、True、列表。可以多个属性</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"class"</span>:<span style="color: #8b2252;">"title"</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"class"</span>:<span style="color: #8b2252;">"highlight"</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"class"</span>:<span style="color: #8b2252;">"title highlight"</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #008b8b;">True</span>}))
<span style="color: #483d8b;">print</span>(soup.find_all(attrs={<span style="color: #8b2252;">"id"</span>:re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"\d$"</span>)}))
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.name,soup.find_all(attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #008b8b;">True</span>,<span style="color: #8b2252;">"src"</span>:<span style="color: #008b8b;">True</span>})))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24182;&#19988;and&#20851;&#31995;</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test</span>(t):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'++++'</span>)
    <span style="color: #a020f0;">if</span> t:
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(t), t)
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)

    <span style="color: #483d8b;">print</span>(doc.find_all(
        <span style="color: #8b2252;">'p'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">p&#26631;&#31614;</span>
        attrs={<span style="color: #8b2252;">'id'</span>:[re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'sec'</span>), <span style="color: #8b2252;">'first'</span>]} <span style="color: #b22222;"># </span><span style="color: #b22222;">id&#21253;&#21547;sec&#25110;&#32773;&#31561;&#20110;first</span>
    )) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28385;&#36275;p&#26631;&#31614;&#24182;&#19988;&#23646;&#24615;&#21305;&#37197;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:754d5e24-da4d-4ce6-81c0-c1bdb48d23ec" class="outline-5">
<h5 id="h:754d5e24-da4d-4ce6-81c0-c1bdb48d23ec">string参数</h5>
<div class="outline-text-5" id="text-h:754d5e24-da4d-4ce6-81c0-c1bdb48d23ec">
<ul class="org-ul">
<li>可以通过string参数搜索文档中的字符串内容，接受字符串、正则表达式对象、True、列表。旧版本为text参数</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:(<span style="color: #483d8b;">type</span>(x),x),soup.find_all(string=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"\w+"</span>))))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;&#31867;&#33410;&#28857;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:(<span style="color: #483d8b;">type</span>(x),x),soup.find_all(string=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"[a-z]+"</span>)))))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(soup.find_all(re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">"^(h|p)"</span>), string=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"[a-z]+"</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#36807;&#28388;Tag&#23545;&#35937;&#65292;&#24182;&#30475;&#23427;&#30340;string&#26159;&#21542;&#31526;&#21512;text&#21442;&#25968;&#35201;&#27714;&#65292;&#36820;&#22238;Tag&#23545;&#35937;</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)

    <span style="color: #483d8b;">print</span>(doc.find_all(string=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29420;&#31435;&#20351;&#29992;string&#21442;&#25968;&#65292;&#36820;&#22238;&#20803;&#32032;&#26159;&#23383;&#31526;&#20018;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.strip(), <span style="color: #483d8b;">filter</span>(<span style="color: #a020f0;">lambda</span> x:<span style="color: #483d8b;">len</span>(x.strip()) != 0, doc.find_all(string=<span style="color: #008b8b;">True</span>)))))
    <span style="color: #483d8b;">print</span>(doc.find_all(string=re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'[a-zA-Z]+'</span>)))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">string&#19981;&#29420;&#31435;&#20351;&#29992;&#65292;&#36820;&#22238;&#23601;&#26159;Tag&#31867;&#22411;&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(doc.find_all(href=<span style="color: #008b8b;">True</span>, string=re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'[a-zA-Z]+'</span>)))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">['html', '\n', '\n', '\n', '&#39318;&#39029;', '\n', '\n', '\n', 'TEST', '\n', '\n', 'python', '&#39640;&#32423;&#29677;', '\n', '\n', '&#23383;&#20856;', '\n', '&#21015;&#34920;', '\n', '\n', ' comment ', '\n', '\n', '\n', '\n', '\n', 'bottom', '\n']</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">['html', '&#39318;&#39029;', 'TEST', 'python', '&#39640;&#32423;&#29677;', '&#23383;&#20856;', '&#21015;&#34920;', 'comment', 'bottom']</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">['html', 'TEST', 'python', ' comment ', 'bottom']</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;a href="http://www.python.org"&gt;python&lt;/a&gt;]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c85ff078-808e-4709-a7f5-2b3dbad31bcf" class="outline-5">
<h5 id="h:c85ff078-808e-4709-a7f5-2b3dbad31bcf">limit参数</h5>
<div class="outline-text-5" id="text-h:c85ff078-808e-4709-a7f5-2b3dbad31bcf">
<p>
显示返回结果的数量
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #483d8b;">id</span>=<span style="color: #008b8b;">True</span>,limit=3)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#21015;&#34920;&#20013;&#26377;3&#20010;&#32467;&#26524;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5f078c78-3d11-45db-865b-39d3567a8abd" class="outline-5">
<h5 id="h:5f078c78-3d11-45db-865b-39d3567a8abd">recursive参数</h5>
<div class="outline-text-5" id="text-h:5f078c78-3d11-45db-865b-39d3567a8abd">
<ul class="org-ul">
<li>默认是递归搜索所有子孙节点，如果不需要请设置为False</li>
</ul>
</div>
</div>
<div id="outline-container-h:2bbaa4f2-e804-48a2-a5ed-862a8bcb764b" class="outline-5">
<h5 id="h:2bbaa4f2-e804-48a2-a5ed-862a8bcb764b">简化写法</h5>
<div class="outline-text-5" id="text-h:2bbaa4f2-e804-48a2-a5ed-862a8bcb764b">
<p>
find_all()是非常常用的方法，可以简化省略掉
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"img"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;img&#26631;&#31614;&#23545;&#35937;&#30340;&#21015;&#34920;&#65292;&#31561;&#20215;&#20110;soup.find_all("img")</span>
    <span style="color: #483d8b;">print</span>(soup.img) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28145;&#24230;&#20248;&#20808;&#31532;&#19968;&#20010;img, &#35843;&#29992;&#30340;soup.find('img)</span>

    <span style="color: #483d8b;">print</span>(soup.h3)
    <span style="color: #483d8b;">print</span>(soup.h3.find_all(string=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;</span>
    <span style="color: #483d8b;">print</span>(soup.h3(string=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25991;&#26412;&#65292;&#21644;&#19978;&#38754;&#31561;&#20215;</span>
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"p"</span>, string=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;a&#26631;&#31614;&#23545;&#35937;</span>

    <span style="color: #483d8b;">print</span>(soup.find_all(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>}))
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>})) <span style="color: #b22222;">#</span><span style="color: #b22222;">find_all&#30340;&#30465;&#30053;</span>
    <span style="color: #483d8b;">print</span>(soup(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">"1"</span>)}))
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)

    <span style="color: #483d8b;">print</span>(doc.div.div) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26412;&#36136;&#20351;&#29992; __getattr__, &#20869;&#37096;&#35843;&#29992;&#30340;find</span>
    <span style="color: #483d8b;">print</span>(doc.find(<span style="color: #8b2252;">'div'</span>).find(<span style="color: #8b2252;">'div'</span>))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
    <span style="color: #483d8b;">print</span>(doc.find_all(<span style="color: #8b2252;">'p'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31616;&#20889;doc('p')</span>
    <span style="color: #483d8b;">print</span>(doc(<span style="color: #8b2252;">'p'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;__call__&#65292;&#20869;&#37096;&#35843;&#29992;find_all</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4896334-f114-4a15-ae00-8cb8b3ad3fcf" class="outline-5">
<h5 id="h:a4896334-f114-4a15-ae00-8cb8b3ad3fcf">find方法</h5>
<div class="outline-text-5" id="text-h:a4896334-f114-4a15-ae00-8cb8b3ad3fcf">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">find</span>(name,attrs,recursive,string,**kwargs)
</pre>
</div>

<ul class="org-ul">
<li>参数几乎和find_all一样。</li>
<li>找到了，find_all返回一个列表，而find返回一个单值，元素对象。</li>
<li>找不到，find_all返回一个空列表，而find返回一个None。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(soup.find(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>}).attrs.get(<span style="color: #8b2252;">"src"</span>,<span style="color: #8b2252;">"cici"</span>))
<span style="color: #483d8b;">print</span>(soup.find(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>}).get(<span style="color: #8b2252;">"src"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31616;&#21270;&#20102;attrs</span>
<span style="color: #483d8b;">print</span>(soup.find(<span style="color: #8b2252;">"img"</span>,attrs={<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"bg1"</span>})[<span style="color: #8b2252;">"src"</span>])
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c31da1db-44a4-45bd-aa8d-551568b8e4a9" class="outline-4">
<h4 id="h:c31da1db-44a4-45bd-aa8d-551568b8e4a9">CSS选择器</h4>
<div class="outline-text-4" id="text-h:c31da1db-44a4-45bd-aa8d-551568b8e4a9">
<ul class="org-ul">
<li>和JQuery一样，可以使用CSS选择器来 查找节点</li>
<li>使用soup.select()方法，select方法支持大部分CSS选择器，返回列表。</li>
<li>CSS中，标签名直接使用，类名前加 <code>.</code> 点号,id名前加 <code>#</code> 井号。</li>

<li>BeautifulSoup.select("css选择器")</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20803;&#32032;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(1,soup.select(<span style="color: #8b2252;">"p"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#30340;p&#26631;&#31614;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(2,soup.select(<span style="color: #8b2252;">".title"</span>))

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#20102;&#20266;&#31867;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#23376;&#26631;&#31614;&#26159;p&#30340;&#21516;&#31867;&#22411;&#30340;&#25152;&#26377;p&#26631;&#31614;&#20013;&#30340;&#31532;&#20108;&#20010;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">(&#21516;&#31867;&#22411;)&#21516;&#26631;&#31614;&#21517;p&#30340;&#31532;2&#20010;&#65292;nth-of-type&#65292;&#19988;&#35201;&#27714;&#26159;&#25968;&#23383;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#26032;&#29256;&#26412;&#23454;&#29616;&#26356;&#22810;&#20266;&#31867;&#25903;&#25345;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;soupsieve.css_parser.CSSParser.parse_pseudo_class</span>
    <span style="color: #483d8b;">print</span>(3,soup.select(<span style="color: #8b2252;">"div.content &gt;p:nth-of-type(2)"</span>))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">id&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(4,soup.select(<span style="color: #8b2252;">"p#second"</span>))
    <span style="color: #483d8b;">print</span>(5,soup.select(<span style="color: #8b2252;">"#bg1"</span>))

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#20195;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(6,soup.select(<span style="color: #8b2252;">"div p"</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">div&#19979;&#36880;&#23618;&#25214;p</span>
    <span style="color: #483d8b;">print</span>(7,soup.select(<span style="color: #8b2252;">"div div p"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">div&#19979;&#36880;&#23618;&#25214;div&#19979;&#36880;&#23618;&#25214;p</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23376;&#36873;&#25321;&#22120;&#65292;&#30452;&#25509;&#21518;&#20195;</span>
    <span style="color: #483d8b;">print</span>(8,soup.select(<span style="color: #8b2252;">"div &gt; p"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">div&#19979;&#30452;&#25509;&#23376;&#26631;&#31614;&#30340;p&#65292;&#26377;2&#20010;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#37051;&#20804;&#24351;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div p:nth-of-type(1) + [src]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;[]</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div p:nth-of-type(1) + p"</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;p&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div &gt; p:nth-of-type(2) + input"</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;input Tag</span>
    <span style="color: #483d8b;">print</span>(9, soup.select(<span style="color: #8b2252;">"div &gt; p:nth-of-type(2) + [type]"</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#19978;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26222;&#36890;&#20804;&#24351;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(10, soup.select(<span style="color: #8b2252;">"div p:nth-of-type(1) ~ [src]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;2&#20010;img</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23646;&#24615;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(11,soup.select(<span style="color: #8b2252;">"[src]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#23646;&#24615;src</span>
    <span style="color: #483d8b;">print</span>(12,soup.select(<span style="color: #8b2252;">"[src='/']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23646;&#24615;src&#31561;&#20110;/</span>
    <span style="color: #483d8b;">print</span>(13,soup.select(<span style="color: #8b2252;">"[src='http://www.cici.com/']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#21305;&#37197;</span>
    <span style="color: #483d8b;">print</span>(14,soup.select(<span style="color: #8b2252;">"[src^='http://www']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;http://www&#24320;&#22836;</span>
    <span style="color: #483d8b;">print</span>(15,soup.select(<span style="color: #8b2252;">"[src$='com/']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;com/&#32467;&#23614;</span>
    <span style="color: #483d8b;">print</span>(16,soup.select(<span style="color: #8b2252;">"img[src*='cici']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;cici</span>
    <span style="color: #483d8b;">print</span>(17,soup.select(<span style="color: #8b2252;">"img[src*='.com']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;.com</span>
    <span style="color: #483d8b;">print</span>(18,soup.select(<span style="color: #8b2252;">"[class='title highlight']"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#21305;&#37197;calss&#31561;&#20110;'title highlight'</span>
    <span style="color: #483d8b;">print</span>(19,soup.select(<span style="color: #8b2252;">"[class~=title]"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20540;&#23646;&#24615;&#20013;&#26377;&#19968;&#20010;title</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">html&#35299;&#26512;3&#31181;&#26041;&#27861; lxml xpath; bs4 find*; bs4 select css selector</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#26631;&#31614;&#36873;&#25321;&#22120;</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'p'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#20889;xpath</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">2 id</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'p#first'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">3 group</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'p#first,p#second'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">4 class</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'.title'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#21518;&#20195; descendants</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'div h3'</span>))
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'div &gt; h3'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">6 &#20266;&#31867; pseudo-class</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'div.content &gt; p:nth-of-type(2)'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">7 sibling</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">+ &#30452;&#25509;&#20804;&#24351;</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'div.content &gt; p:nth-of-type(2) + input'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">~ &#21518;&#32493;&#20804;&#24351;</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'div.content &gt; p:nth-of-type(2) ~ input'</span>))
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'div.content &gt; p:nth-of-type(2) ~ img'</span>))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">8 &#23646;&#24615; attribute</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[src],a[href]'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;src&#23646;&#24615;&#25110;&#32773;a&#26631;&#31614;&#20013;&#20855;&#26377;href&#23646;&#24615;&#30340;</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[id=bg2]'</span>))
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[class="title highlight"]'</span>))
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[class~="title"]'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#22810;&#20540;&#23646;&#24615;&#20013;&#30340;&#19968;&#20010;</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[class*="title"]'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21253;&#21547;title</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[class^="title"]'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21069;&#38754;&#26377;title</span>
    <span style="color: #483d8b;">print</span>(doc.select(<span style="color: #8b2252;">'[class$="highlight"]'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21518;&#38754;&#26377;highlight</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:76e09edf-517a-4a60-bffd-6e551de6232c" class="outline-4">
<h4 id="h:76e09edf-517a-4a60-bffd-6e551de6232c">获取文本内容</h4>
<div class="outline-text-4" id="text-h:76e09edf-517a-4a60-bffd-6e551de6232c">
<ol class="org-ol">
<li>搜索节点的目的往往是为了提取该节点的文本内容，一般不需要HTML标记，只需要文字</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"test.html"</span>,encoding=<span style="color: #8b2252;">"utf-8"</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">soup</span> = BeautifulSoup(f,<span style="color: #8b2252;">"lxml"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20803;&#32032;&#36873;&#25321;&#22120;</span>
    <span style="color: #a0522d;">ele</span> = soup.select(<span style="color: #8b2252;">"div"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#30340;div&#26631;&#31614;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(ele))
    <span style="color: #483d8b;">print</span>(ele[0].string) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23481;&#20165;&#20165;&#21482;&#33021;&#26159;&#25991;&#26412;&#31867;&#22411;&#65292;&#21542;&#21017;&#36820;&#22238;None</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].strings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].stripped_strings)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#19981;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;</span>

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
    <span style="color: #483d8b;">print</span>(ele[0])
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span> * 30)

    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].text))<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#36136;&#19978;&#23601;&#26159;get_text(),&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;&#30340;strings</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].get_text())) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#24182;join&#65292;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;&#65292;strip&#40664;&#35748;&#20026;False</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(ele[0].get_text(strip=<span style="color: #008b8b;">True</span>))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#24182;join&#65292;&#19981;&#20445;&#30041;&#31354;&#30333;&#23383;&#31526;</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">import</span> re

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'test.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">doc</span> = BeautifulSoup(f, <span style="color: #8b2252;">'lxml'</span>)

    <span style="color: #483d8b;">print</span>(doc.find(<span style="color: #8b2252;">'div'</span>).string)
    <span style="color: #483d8b;">print</span>(*doc.find(<span style="color: #8b2252;">'div'</span>).strings)
    <span style="color: #483d8b;">print</span>(doc.find(<span style="color: #8b2252;">'div'</span>).text)
    <span style="color: #483d8b;">print</span>(*doc.find(<span style="color: #8b2252;">'div'</span>).stripped_strings, sep=<span style="color: #8b2252;">','</span>)
    <span style="color: #483d8b;">print</span>(doc.find(<span style="color: #8b2252;">'div'</span>).get_text(separator=<span style="color: #8b2252;">','</span> , strip=<span style="color: #008b8b;">True</span>))
</pre>
</div>

<ul class="org-ul">
<li>bs4.element.Tag#string源码</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Tag</span>(PageElement):
@<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">string</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(<span style="color: #a020f0;">self</span>.contents) != 1:
            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">None</span>
        <span style="color: #a0522d;">child</span> = <span style="color: #a020f0;">self</span>.contents[0]
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(child, NavigableString):
            <span style="color: #a020f0;">return</span> child
        <span style="color: #a020f0;">return</span> child.string

    <span style="color: #228b22;">@string.setter</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">string</span>(<span style="color: #a020f0;">self</span>, string):
        <span style="color: #a020f0;">self</span>.clear()
        <span style="color: #a020f0;">self</span>.append(string.__class__(string))

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_all_strings</span>(<span style="color: #a020f0;">self</span>, strip=<span style="color: #008b8b;">False</span>, types=(NavigableString, CData)):
        <span style="color: #a020f0;">for</span> descendant <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>.descendants:
            <span style="color: #a020f0;">if</span> (
                (types <span style="color: #a020f0;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">isinstance</span>(descendant, NavigableString))
                <span style="color: #a020f0;">or</span>
                (types <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span> <span style="color: #a020f0;">and</span> <span style="color: #483d8b;">type</span>(descendant) <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> types)):
                <span style="color: #a020f0;">continue</span>
            <span style="color: #a020f0;">if</span> strip:
                <span style="color: #a0522d;">descendant</span> = descendant.strip()
                <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(descendant) == 0:
                    <span style="color: #a020f0;">continue</span>
            <span style="color: #a020f0;">yield</span> descendant

    <span style="color: #a0522d;">strings</span> = <span style="color: #483d8b;">property</span>(_all_strings)

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">stripped_strings</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">for</span> string <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>._all_strings(<span style="color: #008b8b;">True</span>):
            <span style="color: #a020f0;">yield</span> string

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_text</span>(<span style="color: #a020f0;">self</span>, separator=<span style="color: #8b2252;">""</span>, strip=<span style="color: #008b8b;">False</span>,
                 types=(NavigableString, CData)):
        <span style="color: #a020f0;">return</span> separator.join([s <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>._all_strings(
                    strip, types=types)])
    <span style="color: #a0522d;">getText</span> = get_text
    <span style="color: #a0522d;">text</span> = <span style="color: #483d8b;">property</span>(get_text)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0" class="outline-3">
<h3 id="h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0">Json解析</h3>
<div class="outline-text-3" id="text-h:44d6af0a-e7e1-4119-ab2f-0f600d0d4ec0">
<p>
拿到一个Json字符串，如果想提取其中的部分内容，就需要遍历了。在遍历过程中进行判断。
</p>

<p>
还有一种方式，类似于XPath,叫做jsonPath。
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install jsonpath
</pre>
</div>

<p>
参考：
</p>
<ul class="org-ul">
<li>官网 <a href="https://goessner.net/articles/JsonPath/">https://goessner.net/articles/JsonPath/</a></li>
<li><a href="https://github.com/json-path/JsonPath">https://github.com/json-path/JsonPath</a></li>
<li><a href="https://github.com/alibaba/fastjson/wiki/JSONPath">https://github.com/alibaba/fastjson/wiki/JSONPath</a></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">XPath</th>
<th scope="col" class="org-left">JsonPath</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>/</code></td>
<td class="org-left"><code>$</code></td>
<td class="org-left">根元素</td>
</tr>

<tr>
<td class="org-left"><code>.</code></td>
<td class="org-left"><code>@</code></td>
<td class="org-left">当前节点</td>
</tr>

<tr>
<td class="org-left"><code>/</code></td>
<td class="org-left"><code>.=或者</code>[]=</td>
<td class="org-left">获取子节点</td>
</tr>

<tr>
<td class="org-left"><code>..</code></td>
<td class="org-left">不支持</td>
<td class="org-left">父节点</td>
</tr>

<tr>
<td class="org-left"><code>//</code></td>
<td class="org-left"><code>..</code></td>
<td class="org-left">任意层次</td>
</tr>

<tr>
<td class="org-left"><code>*</code></td>
<td class="org-left"><code>*</code></td>
<td class="org-left">通配符，匹配任意节点</td>
</tr>

<tr>
<td class="org-left"><code>@</code></td>
<td class="org-left">不支持</td>
<td class="org-left">json中没有属性</td>
</tr>

<tr>
<td class="org-left"><code>[]</code></td>
<td class="org-left"><code>[]</code></td>
<td class="org-left">下标操作</td>
</tr>

<tr>
<td class="org-left">=</td>
<td class="org-left">=</td>
<td class="org-left"><code>[,]</code></td>
<td class="org-left">XPath是或操作，JSONPath allows alternate names or array indices as a set.</td>
</tr>

<tr>
<td class="org-left">不支持</td>
<td class="org-left"><code>[start:stop:step]</code></td>
<td class="org-left">切片</td>
</tr>

<tr>
<td class="org-left"><code>[]</code></td>
<td class="org-left"><code>?()</code></td>
<td class="org-left">过滤操作</td>
</tr>

<tr>
<td class="org-left">不支持</td>
<td class="org-left"><code>()</code></td>
<td class="org-left">表达式计算</td>
</tr>

<tr>
<td class="org-left"><code>()</code></td>
<td class="org-left">不支持</td>
<td class="org-left">分组</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>综合示例，使用豆瓣电影的热门电影的Json<a href="https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0">https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-json">{
    "subjects":[
        {
            "rate":"8.8",
            "cover_x":1500,
            "title":"寄生虫",
            "url":"https://movie.douban.com/subject/27010768/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2561439800.jpg",
            "id":"27010768",
            "cover_y":2138,
            "is_new":false
        },
        {
            "rate":"7.7",
            "cover_x":1500,
            "title":"恶人传",
            "url":"https://movie.douban.com/subject/30211551/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2555084871.jpg",
            "id":"30211551",
            "cover_y":2145,
            "is_new":false
        },
        {
            "rate":"6.6",
            "cover_x":1500,
            "title":"异地母子情",
            "url":"https://movie.douban.com/subject/26261189/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2562107493.jpg",
            "id":"26261189",
            "cover_y":2222,
            "is_new":true
        },
        {
            "rate":"6.7",
            "cover_x":2025,
            "title":"我的生命之光",
            "url":"https://movie.douban.com/subject/26962841/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2563625370.jpg",
            "id":"26962841",
            "cover_y":3000,
            "is_new":true
        },
        {
            "rate":"7.3",
            "cover_x":2025,
            "title":"皮肤",
            "url":"https://movie.douban.com/subject/27041467/",
            "playable":false,
            "cover":"https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2559479239.jpg",
            "id":"27041467",
            "cover_y":3000,
            "is_new":true
        },
        {
            "rate":"8.9",
            "cover_x":2000,
            "title":"绿皮书",
            "url":"https://movie.douban.com/subject/27060077/",
            "playable":true,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2549177902.jpg",
            "id":"27060077",
            "cover_y":3167,
            "is_new":false
        },
        {
            "rate":"8.0",
            "cover_x":3600,
            "title":"疾速备战",
            "url":"https://movie.douban.com/subject/26909790/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2551393832.jpg",
            "id":"26909790",
            "cover_y":5550,
            "is_new":false
        },
        {
            "rate":"7.9",
            "cover_x":1786,
            "title":"流浪地球",
            "url":"https://movie.douban.com/subject/26266893/",
            "playable":true,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2545472803.jpg",
            "id":"26266893",
            "cover_y":2500,
            "is_new":false
        },
        {
            "rate":"8.2",
            "cover_x":684,
            "title":"沦落人",
            "url":"https://movie.douban.com/subject/30140231/",
            "playable":false,
            "cover":"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2555952192.jpg",
            "id":"30140231",
            "cover_y":960,
            "is_new":false
        },
        {
            "rate":"6.4",
            "cover_x":960,
            "title":"疯狂的外星人",
            "url":"https://movie.douban.com/subject/25986662/",
            "playable":true,
            "cover":"https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2541901817.jpg",
            "id":"25986662",
            "cover_y":1359,
            "is_new":false
        }
    ]
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> jsonpath <span style="color: #a020f0;">import</span> jsonpath
<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">import</span> json

<span style="color: #a0522d;">ua</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0"</span>

<span style="color: #a020f0;">with</span> requests.get(url,headers={<span style="color: #8b2252;">"User-agent"</span>:ua}) <span style="color: #a020f0;">as</span> response:
    <span style="color: #a020f0;">if</span> response.status_code==200:
        <span style="color: #a0522d;">text</span> = response.text
        <span style="color: #483d8b;">print</span>(text[:100])
        <span style="color: #a0522d;">js</span> = json.loads(text)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">str</span>(js)[:100]) <span style="color: #b22222;">#</span><span style="color: #b22222;">json&#36716;&#25442;&#20026;Python&#25968;&#25454;&#32467;&#26500;</span>

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30693;&#36947;&#25152;&#26377;&#30005;&#24433;&#30340;&#21517;&#31216;</span>
        <span style="color: #a0522d;">rs1</span> = jsonpath(js,<span style="color: #8b2252;">"$..title"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26681;&#30446;&#24405;&#24320;&#22987;&#65292;&#20219;&#24847;&#23618;&#27425;&#30340;title&#23646;&#24615;</span>
        <span style="color: #483d8b;">print</span>(rs1)

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#21040;&#25152;&#26377;subjects</span>
        <span style="color: #a0522d;">rs2</span> = jsonpath(js,<span style="color: #8b2252;">"$..subjects"</span>)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">len</span>(rs2),<span style="color: #483d8b;">str</span>(rs2[0])[:100]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30001;&#20110;&#22826;&#38271;&#65292;&#21462;&#21069;100&#20010;&#23383;&#31526;</span>

        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span> * 30)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040;&#25152;&#26377;&#24471;&#20998;&#39640;&#20110;8&#20998;&#30340;&#30005;&#24433;&#21517;&#31216;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#19979;&#20219;&#24847;&#23618;&#30340;subjects&#30340;&#23376;&#33410;&#28857;rate&#22823;&#20110;&#23383;&#31526;&#20018;8</span>
        <span style="color: #a0522d;">rs3</span> = jsonpath(js,<span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")]'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#65311;()&#26159;&#36807;&#28388;&#22120;</span>
        <span style="color: #483d8b;">print</span>(rs3)

        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#19979;&#20219;&#24847;&#23618;&#30340;subjects&#30340;&#23376;&#33410;&#28857;rate&#22823;&#20110;&#23383;&#31526;&#20018;8&#30340;&#33410;&#28857;&#30340;&#23376;&#33410;&#28857;title</span>
        <span style="color: #a0522d;">rs4</span> = jsonpath(js,<span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")].title'</span>)
        <span style="color: #483d8b;">print</span>(rs4)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span> * 30)

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#29255;</span>
        <span style="color: #a0522d;">rs5</span> = jsonpath(js,<span style="color: #8b2252;">"$..subjects[?(@.rate &gt; '6')].title"</span>)
        <span style="color: #483d8b;">print</span>(rs5[:2])
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> jsonpath <span style="color: #a020f0;">import</span> jsonpath
<span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">import</span> requests

<span style="color: #b22222;"># </span><span style="color: #b22222;">url = 'https://movie.douban.com/j/search_subjects?type=movie&amp;tag=%E7%83%AD%E9%97%A8&amp;page_limit=10&amp;page_start=0'</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">headers = {</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'User-agent': "Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML, like Gecko) Version/5.0.1 Safari/537.36"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">}</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">with requests.get(url, headers=headers) as response:</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">if response.status_code == 200:</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;"># text = response.text</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;"># print(type(text), text)</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;">with open('a.json', 'wb') as f:</span>
<span style="color: #b22222;">#             </span><span style="color: #b22222;">f.write(response.content)</span>

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'a.json'</span>, encoding=<span style="color: #8b2252;">'utf8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">j</span> = json.loads(f.read())
    <span style="color: #a0522d;">x</span> = jsonpath(j, <span style="color: #8b2252;">'$..title'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20869;&#37096;&#24322;&#24120;&#19981;&#25243;&#20986;&#65292;&#38169;&#20102;&#23601;False</span>
    <span style="color: #483d8b;">print</span>(x)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25343;&#21040;&#25152;&#26377;title&#21644;url</span>
    <span style="color: #483d8b;">print</span>(jsonpath(j, <span style="color: #8b2252;">'$..title,url'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath //tite|//url</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;8&#20998;&#20197;&#19978;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040;&#25152;&#26377;&#24471;&#20998;&#39640;&#20110;8&#20998;&#30340;&#30005;&#24433;&#21517;&#31216;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#19979;&#20219;&#24847;&#23618;&#30340;subjects&#30340;&#23376;&#33410;&#28857;rate&#22823;&#20110;&#23383;&#31526;&#20018;8</span>
    <span style="color: #483d8b;">print</span>(jsonpath(j, <span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")]'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">8&#20998;&#20197;&#19978;&#20449;&#24687;</span>
    <span style="color: #483d8b;">print</span>(jsonpath(j, <span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")].title,url'</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">8&#20998;&#20197;&#19978;title&#65292;url</span>
    <span style="color: #483d8b;">print</span>(jsonpath(j, <span style="color: #8b2252;">'$..subjects[?(@.rate &gt; "8")].title,url'</span>)[:2]) <span style="color: #b22222;"># </span><span style="color: #b22222;">8&#20998;&#20197;&#19978;title&#21644;url&#65292;&#20999;&#29255;</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f" class="outline-2">
<h2 id="h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f">RabbitMQ</h2>
<div class="outline-text-2" id="text-h:f0d4d7d1-eedf-4c95-a4d3-fd5e0ab73f7f">
<p>
RabbitMQ是由LShift提供的一个Advanced Message Queuing Protocol (AMQP)的开源实现，由以高性能、健壮以及可伸缩性出名的Erlang写成，因此也是继承了这些些优点。
</p>

<p>
很成熟，久经考验，应用广泛。
</p>

<p>
文档详细，客户端丰富，几乎常用语言都有RabbitMQ的开发库
</p>
</div>
<div id="outline-container-h:038a8e0a-b7fa-406f-a43b-559d5d4ce264" class="outline-3">
<h3 id="h:038a8e0a-b7fa-406f-a43b-559d5d4ce264">部署</h3>
<div class="outline-text-3" id="text-h:038a8e0a-b7fa-406f-a43b-559d5d4ce264">
</div>
<div id="outline-container-h:f899334f-3118-41be-80e6-e8625d7b0dae" class="outline-4">
<h4 id="h:f899334f-3118-41be-80e6-e8625d7b0dae">安装</h4>
<div class="outline-text-4" id="text-h:f899334f-3118-41be-80e6-e8625d7b0dae">
<p>
<a href="https://www.rabbitmq.com/docs/install-rpm">https://www.rabbitmq.com/docs/install-rpm</a>
</p>
<ul class="org-ul">
<li>选择RPM包下载，选择对应平台，本次安装在Rocky，其他平台类似。</li>
</ul>

<p>
由于使用了erlang语言开发，所以需要erlang的包。erlang和RabbitMQ的兼容性，参考<a href="https://www.rabbitmq.com/docs/which-erlang#compatibility-matrix">https://www.rabbitmq.com/docs/which-erlang#compatibility-matrix</a>
</p>

<ul class="org-ul">
<li>下载
rabbitmq-server-3.7.16-1.el7.noarch.rpm、erlang-21.3.8.6-1.el7.x86_64.rpm。socat在CentOS中源中有。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">yum -y install erlang-21.3.8.6-1.el7.x86_64.rpm
rabbitmq-server-3.7.16-1.el7.noarch.rpm
</pre>
</div>

<ul class="org-ul">
<li>查看安装的文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">[root@xdd ~]# rpm -ql rabbitmq-server 
/etc/logrotate.d/rabbitmq-server
/etc/profile.d/rabbitmqctl-autocomplete.sh
/etc/rabbitmq
/usr/lib/ocf/resource.d/rabbitmq/rabbitmq-server
/usr/lib/ocf/resource.d/rabbitmq/rabbitmq-server-ha
/usr/lib/rabbitmq/autocomplete/bash_autocomplete.sh
/usr/lib/rabbitmq/autocomplete/zsh_autocomplete.sh
/usr/lib/rabbitmq/bin/cuttlefish
/usr/lib/rabbitmq/bin/rabbitmq-defaults
</pre>
</div>
</div>
</div>
<div id="outline-container-h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc" class="outline-4">
<h4 id="h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc">配置</h4>
<div class="outline-text-4" id="text-h:824541cf-9ceb-48b3-aa3c-ff7c43bd97fc">
<ul class="org-ul">
<li>参考资料<a href="https://www.rabbitmq.com/configure.html#config-location">https://www.rabbitmq.com/configure.html#config-location</a></li>
</ul>
</div>
<div id="outline-container-h:836f844f-b135-4993-837c-10a2d1bff7ff" class="outline-5">
<h5 id="h:836f844f-b135-4993-837c-10a2d1bff7ff">环境配置</h5>
<div class="outline-text-5" id="text-h:836f844f-b135-4993-837c-10a2d1bff7ff">
<ul class="org-ul">
<li>使用系统环境变量，如果没有使用rabbitmq-env.conf中定义环境变量，否则使用缺省值</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">RABBITMQ_NODE_IP_ADDRESS the empty string, meaning that it should bind to all network interfaces.  
RABBITMQ_NODE_PORT 5672  
RABBITMQ_DIST_PORT RABBITMQ_NODE_PORT + 20000  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#33410;&#28857;&#21644;&#23458;&#25143;&#31471;&#24037;&#20855;&#36890;&#20449;&#29992;  </span>
RABBITMQ_CONFIG_FILE &#37197;&#32622;&#25991;&#20214;&#36335;&#24452;&#40664;&#35748;&#20026;/etc/rabbitmq/rabbitmq  
</pre>
</div>

<p>
环境变量文件，可以不配置
</p>
</div>
</div>
<div id="outline-container-h:63d147a7-aede-4e74-826b-e7cfc32eaaf5" class="outline-5">
<h5 id="h:63d147a7-aede-4e74-826b-e7cfc32eaaf5">工作特性配置文件</h5>
<div class="outline-text-5" id="text-h:63d147a7-aede-4e74-826b-e7cfc32eaaf5">
<ul class="org-ul">
<li>rabbitmq.config配置文件</li>
<li>3.7支持新旧两种配置文件格式
<ol class="org-ol">
<li>erlang配置文件格式，为了兼容继续采用</li>
<li>sysctl格式，如果不需要兼容，RabbitMQ鼓励使用。 (这个文件也可以不配置)</li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:96ef7d6b-d211-4d63-81c1-381babafd986" class="outline-4">
<h4 id="h:96ef7d6b-d211-4d63-81c1-381babafd986">插件管理</h4>
<div class="outline-text-4" id="text-h:96ef7d6b-d211-4d63-81c1-381babafd986">
<p>
列出所有可用插件
</p>

<div class="org-src-container">
<pre class="src src-sh">rabbitmq-plugins list
</pre>
</div>

<ul class="org-ul">
<li>启动WEB管理插件，会依赖启用其他几个插件。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">rabbitmq-plugins enable rabbitmq_management
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e531ee22-998b-4f99-aab2-7ac5ad53508e" class="outline-4">
<h4 id="h:e531ee22-998b-4f99-aab2-7ac5ad53508e">启动服务</h4>
<div class="outline-text-4" id="text-h:e531ee22-998b-4f99-aab2-7ac5ad53508e">
<div class="org-src-container">
<pre class="src src-sh">systemctl start rabbitmq-server
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">[root@xdd ~]# ss -tanl | grep 5672
LISTEN     0      128          *:25672                    *:*
LISTEN     0      128          *:15672                    *:*
LISTEN     0      128         :::5672                    :::*
[root@xdd ~]#
</pre>
</div>
</div>
<div id="outline-container-h:e4c43729-a03b-49a2-83b3-a5648366408b" class="outline-5">
<h5 id="h:e4c43729-a03b-49a2-83b3-a5648366408b">容器方式启动服务</h5>
<div class="outline-text-5" id="text-h:e4c43729-a03b-49a2-83b3-a5648366408b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25289;&#21462;docker&#38236;&#20687;</span>
docker pull rabbitmq:management
mkdir -p docker/rabbitmq

docker run -d --name=rabbitmq <span style="color: #8b2252;">\</span>
  -v ./docker/rabbitmq:/var/lib/rabbitmq <span style="color: #8b2252;">\</span>
  -p 15672:15672 -p 5672:5672 <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">RABBITMQ_DEFAULT_USER</span>=admin <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">RABBITMQ_DEFAULT_PASS</span>=admin <span style="color: #8b2252;">\</span>
  rabbitmq:management

<span style="color: #b22222;"># </span><span style="color: #b22222;">http://&lt;IP&gt;:15672 &#29992;&#25143;&#21517;&#21644;&#23494;&#30721;: admin</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7881dc05-67bb-469e-9577-c9ad18bc3b95" class="outline-4">
<h4 id="h:7881dc05-67bb-469e-9577-c9ad18bc3b95">用户管理</h4>
<div class="outline-text-4" id="text-h:7881dc05-67bb-469e-9577-c9ad18bc3b95">
<ul class="org-ul">
<li>开始登陆WEB界面, <a href="http://&lt;ip&gt;:15672">http://&lt;ip&gt;:15672</a></li>
<li>使用guest/guest只能本地登陆，远程登录会报错</li>
</ul>

<p>
rabbitmqctl命令
</p>
<div class="org-src-container">
<pre class="src src-sh">&#9492;&#9472;$ docker exec -i rabbitmq  rabbitmqctl          
rabbitmqctl [--node &lt;node&gt;] [--timeout &lt;timeout&gt;] [--longnames] [--quiet] &lt;command&gt; [&lt;command options&gt;]
Users:
   add_user                                      &#28155;&#21152;&#29992;&#25143;
   authenticate_user                             Attempts to authenticate a user. Exits with a non-zero code if authentication fails.
   change_password                               &#20462;&#25913;&#29992;&#25143;&#21517;&#65292;&#23494;&#30721;
   clear_password                                Clears (resets) password and disables password login for a user
   clear_user_limits                             Clears user connection/channel limits
   delete_user                                   &#21024;&#38500;&#29992;&#25143;
   list_user_limits                              Displays configured user limits
   list_users                                    &#21015;&#20986;&#29992;&#25143;
   set_user_limits                               Sets user limits
   set_user_tags                                 &#35774;&#32622;&#29992;&#25143;tag

docker exec -i rabbitmq  rabbitmqctl  help add_user
</pre>
</div>
<ul class="org-ul">
<li>添加用户： <code>rabbitmqctl add_user username password</code></li>
<li>删除用户： <code>rabbitmqctl delete_user username</code></li>
<li>更改密码： <code>rabbitmqctl change_password username newpassword</code></li>
<li>设置权限Tags，其实就是分配组： <code>rabbitmqctl set_user_tags username tag</code></li>
</ul>

<p>
用户tag
</p>
<ul class="org-ul">
<li>management
用户可以访问管理插件</li>
<li>policymaker
用户可以访问管理插件并管理他们有权访问的虚拟主机的策略和参数。</li>
<li>monitoring
用户可以访问管理插件并查看所有连接和通道以及节点相关信息。</li>
<li>administrator
用户可以执行监控可以执行的所有操作，管理用户、虚拟主机和权限，关闭其他用户的连接，以及管理所有虚拟主机的策略和参数。</li>
</ul>

<p>
设置jasper用户为管理员tag后登陆
</p>
<div class="org-src-container">
<pre class="src src-shell">rabbitmqctl add_user jasper 123456  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;jasper&#29992;&#25143;</span>
rabbitmqctl list_users <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#29992;&#25143;</span>
rabbitmqctl set_user_tags jasper administrator <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;admin&#29992;&#25143;&#20026;&#31649;&#29702;&#21592;&#29992;&#25143;</span>
</pre>
</div>

<ul class="org-ul">
<li>tag的意义如下：
<ol class="org-ol">
<li>administrator可以管理用户、权限、虚拟主机。</li>
</ol></li>
<li>基本信息(web管理端口15672，协议端口5672)</li>
<li>虚拟主机
<ol class="org-ol">
<li>缺省虚拟主机，默认只能是guest用户在本机链接，下图新建的用户gdy默认无法访问任何虚拟主机</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:095ec87e-eb33-4e63-8b92-d1b91333cbec" class="outline-4">
<h4 id="h:095ec87e-eb33-4e63-8b92-d1b91333cbec">虚拟主机</h4>
<div class="outline-text-4" id="text-h:095ec87e-eb33-4e63-8b92-d1b91333cbec">
<p>
/ 为确实虚拟主机
</p>

<p>
缺省虚拟主机，默认只是guest用户在本机连接。新建用户默认无法访问任何虚拟主机。
</p>

<p>
这里我们使用jasper用户在Admin页面中创建一个虚拟主机 test。
</p>
</div>
</div>
<div id="outline-container-h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995" class="outline-4">
<h4 id="h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995">Pika库</h4>
<div class="outline-text-4" id="text-h:10e5c492-88fa-44a7-a7c7-5ae4e6a12995">
<p>
Pika是纯Python实现的支持AMQP协议的库
</p>

<div class="org-src-container">
<pre class="src src-sh">pip install pika
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e4d7a939-b004-45e1-bbec-7ba99ca86d67" class="outline-3">
<h3 id="h:e4d7a939-b004-45e1-bbec-7ba99ca86d67">RabbitMQ工作原理及应用</h3>
<div class="outline-text-3" id="text-h:e4d7a939-b004-45e1-bbec-7ba99ca86d67">
</div>
<div id="outline-container-h:f9cb405c-487c-4a23-938b-7ae7f21eea58" class="outline-4">
<h4 id="h:f9cb405c-487c-4a23-938b-7ae7f21eea58">工作模式</h4>
<div class="outline-text-4" id="text-h:f9cb405c-487c-4a23-938b-7ae7f21eea58">
<p>
参考官网 <a href="https://www.rabbitmq.com/tutorials">https://www.rabbitmq.com/tutorials</a>
</p>
<ol class="org-ol">
<li>简单列表模式</li>
<li>工作队列模式</li>
<li>发布文章模式</li>
<li>路由模式</li>
<li>话题模式</li>
<li>RPC模式</li>
</ol>
</div>
</div>
<div id="outline-container-h:c18c4a24-5e98-4822-a834-92acee7e0526" class="outline-4">
<h4 id="h:c18c4a24-5e98-4822-a834-92acee7e0526">名词解释</h4>
<div class="outline-text-4" id="text-h:c18c4a24-5e98-4822-a834-92acee7e0526">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名词</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Server</td>
<td class="org-left">服务器。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">接受客户端连接，实现消息队列及路由功能的进程(服务),也称为消息代理</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">注意：客户端可用生产者，也可以是消费者，它们都需要连接到Server</td>
</tr>

<tr>
<td class="org-left">Connection</td>
<td class="org-left">网络物理连接</td>
</tr>

<tr>
<td class="org-left">Channel</td>
<td class="org-left">一个连接允许多个客户端连接</td>
</tr>

<tr>
<td class="org-left">Exchange</td>
<td class="org-left">交换器。接收生产者发来的消息，决定如何 <b>路由</b> 给服务器中的队列。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">常用的类型有：direct(point-to-point) 路由模式; topic(publish-subscribe) ; fanout(multicast)广播模式</td>
</tr>

<tr>
<td class="org-left">Message</td>
<td class="org-left">消息</td>
</tr>

<tr>
<td class="org-left">Message Queue</td>
<td class="org-left">消息队列，数据的存储载体</td>
</tr>

<tr>
<td class="org-left">Bind</td>
<td class="org-left">绑定。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">建立消息队列和交换器之间的关系，也就是说交换器拿到数据，把什么样的数据送给哪个队列</td>
</tr>

<tr>
<td class="org-left">Virtual Host</td>
<td class="org-left">虚拟主机。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">一批交换器、消息队列和相关对象的集合。为了多用户互不干扰，使用虚拟主机分组交换机，消息队列</td>
</tr>

<tr>
<td class="org-left">Topic</td>
<td class="org-left">主题、话题</td>
</tr>

<tr>
<td class="org-left">Broker</td>
<td class="org-left">可等价为Server</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:4900c67f-edda-4470-99d2-ca179d94a7da" class="outline-4">
<h4 id="h:4900c67f-edda-4470-99d2-ca179d94a7da">1.队列 *</h4>
<div class="outline-text-4" id="text-h:4900c67f-edda-4470-99d2-ca179d94a7da">
<ul class="org-ul">
<li>这种模式就是最简单的生产者消费者模型，消息队列就是一个FIFO的队列</li>
<li>生产者send.py,消费者receie.py</li>
<li>官方例子：<a href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">https://www.rabbitmq.com/tutorials/tutorial-one-python.html</a></li>
</ul>

<p>
参照官方例子，写一个小程序
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#29992;&#25143;&#21517;&#23494;&#30721;&#23545;&#35937;</span>
<span style="color: #a0522d;">credential</span> = pika.PlainCredentials(<span style="color: #8b2252;">"jasper"</span>,<span style="color: #8b2252;">"123456"</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#38142;&#25509;&#21442;&#25968;</span>
<span style="color: #a0522d;">params</span> = pika.ConnectionParameters(
    <span style="color: #8b2252;">"192.168.61.108"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">ip&#22320;&#22336;</span>
    5672,  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31471;&#21475;</span>
    <span style="color: #8b2252;">"test"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#26426;</span>
    credential <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#21517;&#23494;&#30721;</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;"># &#31532;&#20108;&#31181;&#24314;&#31435;&#36830;&#25509;&#26041;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">params = pika.URLParameters("amqp://jasper:123456@192.168.61.108:5672/test")</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#38431;&#21015;&#65292;queue&#21629;&#21517;&#20026;hello&#65292;&#22914;&#26524;queue&#19981;&#23384;&#22312;&#65292;&#28040;&#24687;&#23558;&#34987;dropped</span>
    channel.queue_declare(queue=<span style="color: #8b2252;">"hello"</span>)

    channel.basic_publish(
        exchange=<span style="color: #8b2252;">""</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#32570;&#30465;exchange</span>
        routing_key=<span style="color: #8b2252;">"hello"</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">routing_key&#24517;&#39035;&#25351;&#23450;&#65292;&#36825;&#37324;&#35201;&#27714;&#21644;&#30446;&#26631;queue&#19968;&#33268;</span>
        body=<span style="color: #8b2252;">"Hello world"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
    )
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;Sent Message OK"</span>)
</pre>
</div>

<p>
测试通过。去服务管理界面查看Exchanges和Queues。
</p>

<p>
注意：出现如下运行结果
</p>

<div class="org-src-container">
<pre class="src src-txt">pika.exceptions.ProbableAuthenticationError: (403, 'ACCESS_REFUSED - Login was refused using authentication mechanism PLAIN. For details see the broker logﬁle.')
</pre>
</div>

<ul class="org-ul">
<li>访问被拒绝，还是权限问题，原因还是guest用户只能访问localhost上的缺省虚拟主机</li>
</ul>

<p>
<b>解决办法</b>
</p>
<ol class="org-ol">
<li>缺省虚拟主机，默认只能在本机访问，不要修改为远程访问，是安全的考虑。</li>
<li>因此，在Admin中Virtual hosts中，新建一个虚拟主机test。</li>
<li>注意：新建的test虚拟主机的Users是谁，本次是gdy用户</li>
</ol>

<p>
在ConnectionParameters中没有用户名、密码填写的参数，它使用参数credentials传入，这个需要构建一个pika.credentials.Credentials对象。
</p>

<p>
URLParameters，也可以使用URL创建参数
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">amqp://username:password@host:port/&lt;virtual_host&gt;[?query-string] </span>
<span style="color: #a0522d;">parameters</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://guest:guest@rabbit-server1:5672/%2F'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">%2F&#25351;&#20195;/&#65292;&#23601;&#26159;&#32570;&#30465;&#34394;&#25311;&#20027;&#26426;</span>
</pre>
</div>

<ol class="org-ol">
<li>queue_declare声明一个queue，有必要的话，创建它。</li>
<li>basic_publish exchange为空就使用缺省exchange,如果找不到指定的exchange，抛异常</li>
</ol>

<p>
使用缺省exchange,就必须指定routing_key，使用它找到queue
</p>

<p>
修改上面生产者代码，让生产者连续发送send Message。在web端查看Queues中Ready的变化
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#31181;&#24314;&#31435;&#36830;&#25509;&#26041;&#24335;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://jasper:123456@192.168.61.108:5672/test"</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#38431;&#21015;&#65292;queue&#21629;&#21517;&#20026;hello&#65292;&#22914;&#26524;queue&#19981;&#23384;&#22312;&#65292;&#28040;&#24687;&#23558;&#34987;dropped</span>
    channel.queue_declare(queue=<span style="color: #8b2252;">"hello"</span>)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):

        channel.basic_publish(
            exchange=<span style="color: #8b2252;">""</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#32570;&#30465;exchange</span>
            routing_key=<span style="color: #8b2252;">"hello"</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">routing_key&#24517;&#39035;&#25351;&#23450;&#65292;&#36825;&#37324;&#35201;&#27714;&#21644;&#30446;&#26631;queue&#19968;&#33268;</span>
            body=<span style="color: #8b2252;">"data{:02}"</span>.<span style="color: #483d8b;">format</span>(i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
        )
        time.sleep(0.5)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;Sent Message OK"</span>)
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;">#</span><span style="color: #b22222;">from pika.credentials import PlainCredentials</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">sender</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">param = pika.ConnectionParameters(</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'192.168.226.130', '5672',</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'test', #&#34394;&#25311;&#26426;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">PlainCredentials('jasper', '123456')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">)</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>

channel.queue_declare(queue=<span style="color: #8b2252;">'hello'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#31471;&#22768;&#26126;&#12290;&#22914;&#26524;&#19981;&#23384;&#22312;&#65292;&#31435;&#21363;&#21019;&#24314;&#35813;q&#12290;&#21019;&#24314;&#30340;q&#19981;&#20250;&#22240;&#20026;&#36830;&#25509;&#20013;&#26029;&#32780;&#21024;&#38500;</span>

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):
    channel.basic_publish(exchange=<span style="color: #8b2252;">''</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=<span style="color: #8b2252;">'hello'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          body=<span style="color: #8b2252;">'data-{:2}'</span>.<span style="color: #483d8b;">format</span>(i))
    time.sleep(1)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [x] Sent 'Hello World!'"</span>)

connection.close()
</pre>
</div>


<p>
<b>构建receive.py消费者代码</b>
</p>

<p>
单个消费消息
</p>
<ul class="org-ul">
<li>BlockingChannel.basic_get("queue名称",是否阻塞)-&gt;(method,props,body)
<ul class="org-ul">
<li>body为返回的消息</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://jasper:123456@192.168.61.108:5672/test"</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
    <span style="color: #a0522d;">msg</span> = channel.basic_get(<span style="color: #8b2252;">"hello"</span>,<span style="color: #008b8b;">True</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21517;&#31216;&#20026;hello&#30340;queue&#38431;&#21015;&#20013;&#33719;&#21462;&#28040;&#24687;&#65292;&#33719;&#21462;&#19981;&#21040;&#38459;&#22622;</span>
    <span style="color: #a0522d;">method</span>,<span style="color: #a0522d;">props</span>,<span style="color: #a0522d;">body</span> = msg <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25343;&#19981;&#21040;&#30340;&#28040;&#24687;tuple&#20026;(None,None,None)</span>
    <span style="color: #a020f0;">if</span> body:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#33719;&#21462;&#21040;&#20102;&#19968;&#20010;&#28040;&#24687;Get A message = {}"</span>.<span style="color: #483d8b;">format</span>(body))
    <span style="color: #a020f0;">else</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#27809;&#26377;&#33719;&#21462;&#21040;&#28040;&#24687;empty"</span>)
</pre>
</div>


<p>
获取到消息后msg的结构如下：
</p>

<div class="org-src-container">
<pre class="src src-txt">(&lt;Basic.GetOk(['delivery_tag=1', 'exchange=', 'message_count=38', 'redelivered=False', 'routing_key=hello'])&gt;, &lt;BasicProperties&gt;, b'data01')  
返回元组：(方法method,属性properties,消息body)
无数据返回：(None,None,None)
</pre>
</div>

<p>
批量消费消息recieve.py
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py &#28040;&#36153;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">from</span> pika.adapters.blocking_connection <span style="color: #a020f0;">import</span> BlockingChannel

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://jasper:123456@192.168.61.108:5672/test"</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(channel,method,properties,body):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Get a message = {}"</span>.<span style="color: #483d8b;">format</span>(body))

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a0522d;">channel</span>:<span style="color: #228b22;">BlockingChannel</span> = connection.channel()
    channel.basic_consume(
        <span style="color: #8b2252;">"hello"</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#21517;</span>
        callback,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#22238;&#35843;&#20989;&#25968;</span>
        <span style="color: #008b8b;">True</span>,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22238;&#24212;</span>
    )
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#31561;&#24453;&#28040;&#24687;&#65292;&#36864;&#20986;&#25353;CTRL+C;Waiting for messages. To exit press CTRL+C"</span>)
    channel.start_consuming()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #b22222;">#</span><span style="color: #b22222;">channel.queue_declare(queue='hello') # q&#29983;&#20135;&#31471;&#21019;&#24314;&#30340;&#65292;&#25105;&#20204;&#30452;&#25509;&#25343;&#23601;&#34892;&#20102;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">" [x] Received </span>{body}<span style="color: #8b2252;">"</span>)

channel.basic_consume(queue=<span style="color: #8b2252;">'hello'</span>,
                      auto_ack=<span style="color: #008b8b;">True</span>,
                      on_message_callback=callback)

channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7813c5d5-4fa0-407c-b24b-05261350d2a6" class="outline-4">
<h4 id="h:7813c5d5-4fa0-407c-b24b-05261350d2a6">2.工作队列 **</h4>
<div class="outline-text-4" id="text-h:7813c5d5-4fa0-407c-b24b-05261350d2a6">
<p>
两个种方式：
</p>
<ul class="org-ul">
<li>继续使用队列模式的生产者和消费者代码，启动2个消费者</li>
<li>修改消费者代码，增加basic_consume方法</li>
</ul>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive &#28040;&#36153;&#32773;&#20195;&#30721;</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@10.0.0.152:5672/test'</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">" [x] Received </span>{body}<span style="color: #8b2252;">"</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback1</span>(ch, method, properties, body):
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">" [y] Received </span>{body}<span style="color: #8b2252;">"</span>)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a0522d;">channel</span> = connection.channel()
    channel.queue_declare(queue=<span style="color: #8b2252;">'hello'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#31471;&#21644;&#28040;&#36153;&#31471;&#37117;&#35201;&#30475;&#30475;q&#26159;&#21542;&#23384;&#22312;&#65292;&#19981;&#23384;&#22312;&#23601;&#21019;&#24314;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#36153;&#32773;&#65292;&#27599;&#19968;&#20010;&#28040;&#36153;&#32773;&#20351;&#29992;&#19968;&#20010;basic_consume</span>
    channel.basic_consume(queue=<span style="color: #8b2252;">'hello'</span>,
                          auto_ack=<span style="color: #008b8b;">True</span>,
                          on_message_callback=callback)
    channel.basic_consume(queue=<span style="color: #8b2252;">'hello'</span>,
                          auto_ack=<span style="color: #008b8b;">True</span>,
                          on_message_callback=callback1)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Waiting for message. To exit press CTRL+C'</span>)
    channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
</pre>
</div>

<p>
观察结果，可以看到，2个消费者是交替拿到不同的消息。
</p>

<ul class="org-ul">
<li>这种工作模式是一种竞争工作方式，对某一个消息来说，只能有有一个消费者拿走它。</li>
<li>从结果知道，使用的是轮询方式拿走数据的。</li>
</ul>

<p>
如果启动2个消费者解释器进程，实际上就有了4个消费者，还是是采用轮询来获取消息。
</p>

<p>
注意:虽然上面的图中没有画出exchange，用到缺省exchange。
</p>
</div>
<div id="outline-container-h:3ab8bf66-7611-412e-9a7e-101615ff1e49" class="outline-5">
<h5 id="h:3ab8bf66-7611-412e-9a7e-101615ff1e49">应答</h5>
<div class="outline-text-5" id="text-h:3ab8bf66-7611-412e-9a7e-101615ff1e49">
<p>
消息队列一般需要缓冲成千上万条消息，队列中消息只有一份，只能给一个消费者处理。消费者读取一个消息后，需要给RabbitMQServer一个确认(acknowledgement)，然后RabbitMQ才会删除它。
</p>

<p>
默认basic_consume中auto_ack为False，也就是需要手动确认收到到了，不会自动回应。
</p>
</div>
</div>
<div id="outline-container-h:f4d969fd-b111-4f0a-8b4c-bdd219d1b095" class="outline-5">
<h5 id="h:f4d969fd-b111-4f0a-8b4c-bdd219d1b095">持久化</h5>
<div class="outline-text-5" id="text-h:f4d969fd-b111-4f0a-8b4c-bdd219d1b095">
<p>
交换机、队列都不会持久化，如需持久化需要未交换机、队列设置durable为True。
</p>

<p>
消息持久化，需要队列首先持久化，然后生产者发布消息时增加持久化属性。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#31471;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#24687;&#25345;&#20037;&#21270; 1. &#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270; 2.&#25913;&#21464;&#28040;&#24687;&#30340;&#23646;&#24615;&#20540;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    channel.basic_publish(exchange=<span style="color: #8b2252;">''</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=<span style="color: #8b2252;">'hello'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          properties=pika.BasicProperties(delivery_mode=2),
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#25968;&#25454;&#65292;&#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270;</span>
                          body=<span style="color: #8b2252;">'data-{:2}'</span>.<span style="color: #483d8b;">format</span>(i))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#31471;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">durable=True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.exchange_declare(durable=True)</span>
channel.queue_declare(queue=<span style="color: #8b2252;">'hello'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">durable=True)</span>
</pre>
</div>

<p>
特殊注意，持久化不能保证百分百消息不丢失，如果数据在缓存中，还未真正写入磁盘，数据还是有部分丢失风险。
</p>
</div>
</div>
<div id="outline-container-h:aa02c42a-95d0-4127-a07a-2f944b3ebc17" class="outline-5">
<h5 id="h:aa02c42a-95d0-4127-a07a-2f944b3ebc17">公平分发</h5>
<div class="outline-text-5" id="text-h:aa02c42a-95d0-4127-a07a-2f944b3ebc17">
<p>
上面的轮询方式，不管消费者是否空闲还是繁忙，只是看似公平的分发，但其实Server没有关注消费者未确认消息数。
</p>

<p>
使用 <code>basic_qos(prefetch_count=1)</code> 来解决，该方法告诉RabbitMQ不不要一直给消费者发多条消息，如果消费者为确认上一条消息，就不要给它发了，发给别的不忙的消消费者
</p>

<p>
范例
</p>

<p>
生产者
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;">#</span><span style="color: #b22222;">from pika.credentials import PlainCredentials</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">sender</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">param = pika.ConnectionParameters(</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'192.168.226.130', '5672',</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'test', #&#34394;&#25311;&#26426;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">PlainCredentials('jasper', '123456')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">)</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>

channel.queue_declare(queue=<span style="color: #8b2252;">'hello'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#31471;&#22768;&#26126;&#12290;&#22914;&#26524;&#19981;&#23384;&#22312;&#65292;&#31435;&#21363;&#21019;&#24314;&#35813;q&#12290;&#21019;&#24314;&#30340;q&#19981;&#20250;&#22240;&#20026;&#36830;&#25509;&#20013;&#26029;&#32780;&#21024;&#38500;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#24687;&#25345;&#20037;&#21270; 1. &#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270; 2.&#25913;&#21464;&#28040;&#24687;&#30340;&#23646;&#24615;&#20540;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    channel.basic_publish(exchange=<span style="color: #8b2252;">''</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=<span style="color: #8b2252;">'hello'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          properties=pika.BasicProperties(delivery_mode=2),
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#25968;&#25454;&#65292;&#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270;</span>
                          body=<span style="color: #8b2252;">'data-{:2}'</span>.<span style="color: #483d8b;">format</span>(i))
    time.sleep(1)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [x] Sent 'Hello World!'"</span>)

connection.close()
</pre>
</div>

<p>
消费者1
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #b22222;"># </span><span style="color: #b22222;">durable=True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.exchange_declare(durable=True)</span>
channel.queue_declare(queue=<span style="color: #8b2252;">'hello'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">durable=True)</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #a0522d;">ctag</span> = method.consumer_tag
    <span style="color: #a0522d;">dtag</span> = method.delivery_tag
    time.sleep(5) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25925;&#24847;&#25918;&#24930;</span>
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{ctag}<span style="color: #8b2252;"> </span>{dtag}<span style="color: #8b2252;"> ** </span>{body}<span style="color: #8b2252;">"</span>)
    channel.basic_ack(dtag) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25163;&#21160;&#24212;&#31572;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#20026;&#28040;&#36153;&#32773;&#21495;</span>
channel.basic_qos(prefetch_count=1)
channel.basic_consume(queue=<span style="color: #8b2252;">'hello'</span>,
                      auto_ack=<span style="color: #008b8b;">False</span>,
                      on_message_callback=callback)

channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
</pre>
</div>

<p>
消费者2
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #b22222;"># </span><span style="color: #b22222;">durable=True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.exchange_declare(durable=True)</span>
channel.queue_declare(queue=<span style="color: #8b2252;">'hello'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">durable=True)</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #a0522d;">ctag</span> = method.consumer_tag
    <span style="color: #a0522d;">dtag</span> = method.delivery_tag
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{ctag}<span style="color: #8b2252;"> </span>{dtag}<span style="color: #8b2252;"> ** </span>{body}<span style="color: #8b2252;">"</span>)
    channel.basic_ack(dtag) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25163;&#21160;&#24212;&#31572;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#20026;&#28040;&#36153;&#32773;&#21495;</span>
channel.basic_qos(prefetch_count=1)
channel.basic_consume(queue=<span style="color: #8b2252;">'hello'</span>,
                      auto_ack=<span style="color: #008b8b;">False</span>,
                      on_message_callback=callback)

channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8432203e-692d-4394-ab8a-c4e05c965d68" class="outline-4">
<h4 id="h:8432203e-692d-4394-ab8a-c4e05c965d68">3.发布、订阅模式(Publish/Subscribe)</h4>
<div class="outline-text-4" id="text-h:8432203e-692d-4394-ab8a-c4e05c965d68">
<p>
Publish/Subscribe发布订阅，想象一下订阅者(消费者)订阅这个报纸(消息),都应该拿到一份同样内容的报纸。
</p>

<p>
订阅者和消费者之间还有一个exchange,可以想象成邮局，消费者去邮局订阅报纸，报社发报纸到邮局，邮局决定如何投递到消费者手中。
</p>

<p>
上例子中工作队列模式的使用，相当于，每个人只能拿到不同的报纸。所以不适合发布订阅模式。
</p>



<figure id="orgdf63d53">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/python/images/img_20250826_165145.png" alt="img_20250826_165145.png">

</figure>

<p>
当模式的exchange的type是fanout，就是一对多，即广播模式。
</p>

<p>
注意，同一个queue的消息只能被消费一次，所以，这里使用了多个queue,相当于为了保证不同的消费者拿到同样的数据，每一个消费者都应该有自己的queue。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#19968;&#20010;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=<span style="color: #8b2252;">"logs"</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#20132;&#25442;&#26426;</span>
    exchange_type=<span style="color: #8b2252;">"fanout"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24191;&#25773;</span>
)
</pre>
</div>

<p>
生产者使用 <b>广播模式</b> 。在test虚拟主机中构建了一个logs交换机。这个交换机是不持久的，服务重启就消失了。一般也不需要持久，如果需要持久，请设置参数durable=True。
</p>

<ol class="org-ol">
<li>至于queue，可以由生产者创建，也可以由消费者创建。</li>
<li>本次采用使用消费者端创建，生产者把数据都发往交换机logs，采用了fanout，然后将数据通过交换机发往已经绑定到此交换机的所有queue。</li>
</ol>

<p>
绑定Bingding,建立exchange和queue之间的联系
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#36153;&#32773;&#31471;</span>
<span style="color: #a0522d;">result</span> =channel.queue_declare(queue=<span style="color: #8b2252;">""</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#19968;&#20010;&#38543;&#26426;&#21517;&#31216;&#30340;queue</span>
<span style="color: #a0522d;">result</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#19968;&#20010;&#38543;&#26426;&#21517;&#31216;&#30340;queue,&#24182;&#22312;&#26029;&#24320;&#38142;&#25509;&#26102;&#21024;&#38500;queue</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">exclusive&#24847;&#24605;&#26159;&#21482;&#20801;&#35768;&#24403;&#21069;connection&#35775;&#38382;&#65292;&#24403;&#21069;&#36830;&#25509;&#26029;&#24320;&#26102;&#21024;&#38500;queue</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;queue</span>
<span style="color: #a0522d;">q1</span>:<span style="color: #228b22;">Method</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span>:<span style="color: #228b22;">Method</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q1name</span> = q1.method.queue <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#36890;&#36807;result.method.queue &#26597;&#30475;&#38543;&#26426;&#21517;&#31216;</span>
<span style="color: #a0522d;">q2name</span> = q2.method.queue
<span style="color: #483d8b;">print</span>(q1name,q2name)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;</span>
channel.queue_bind(exchange=<span style="color: #8b2252;">"logs"</span>,queue=q1name)
channel.queue_bind(exchange=<span style="color: #8b2252;">"logs"</span>,queue=q2name)
</pre>
</div>

<p>
<b>生成者代码</b>
</p>
<ol class="org-ol">
<li>注意观察 交换机和队列</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">send.py &#29983;&#20135;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">params</span> = pika.URLParameters(<span style="color: #8b2252;">"amqp://jasper:123456@192.168.61.108:5672/test"</span>)
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20132;&#25442;&#26426;&#21644;&#27169;&#24335;</span>
<span style="color: #a0522d;">exchange_name</span> = <span style="color: #8b2252;">'logs'</span>
channel.exchange_declare(
    exchange=exchange_name, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#20132;&#25442;&#26426;</span>
    exchange_type=<span style="color: #8b2252;">"fanout"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25159;&#20986;&#65292;&#24191;&#25773;</span>
)

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(40):
        channel.basic_publish(
            exchange=exchange_name, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#25351;&#23450;&#30340;exhcange</span>
            routing_key=<span style="color: #8b2252;">""</span>, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24191;&#25773;&#27169;&#24335;&#65292;&#19981;&#25351;&#23450;routing_key</span>
            body = <span style="color: #8b2252;">"data-{:02}"</span>.<span style="color: #483d8b;">format</span>(i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#24687;</span>
        )
        time.sleep(0.01)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Send OK"</span>)
</pre>
</div>

<p>
特别注意：如果先开启生产者，由于没有队列queue,请观察数据. 数据消失。应该提前启动消费者。
</p>

<p>
<b>消费者代码</b>
</p>
<ol class="org-ol">
<li>构建queue并绑定到test虚拟机的logs交换机上</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">receie.py &#28040;&#36153;&#32773;&#20195;&#30721;</span>

<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> pika

<span style="color: #a0522d;">exchange_name</span> = <span style="color: #8b2252;">'logs'</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(pika.URLParameters(<span style="color: #8b2252;">"amqp://jasper:123456@192.168.61.108:5672/test"</span>))
<span style="color: #a0522d;">channel</span> = connection.channel()
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=exchange_name, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#20132;&#25442;&#26426;</span>
    exchange_type=<span style="color: #8b2252;">"fanout"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25159;&#20986;&#65292;&#24191;&#25773;</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#21517;&#31216;&#38543;&#26426;&#65292;exclusive=True&#26029;&#24320;&#21024;&#38500;&#38431;&#21015;</span>
<span style="color: #a0522d;">q1</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">name1</span> = q1.method.queue <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38431;&#21015;&#21517;</span>
<span style="color: #a0522d;">name2</span> = q2.method.queue

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32465;&#23450;&#21040;&#20132;&#25442;&#26426;</span>
channel.queue_bind(exchange=exchange_name, queue=name1)
channel.queue_bind(exchange=exchange_name, queue=name2)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(channel,method,properties,body):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">{}"</span>.<span style="color: #483d8b;">format</span>(channel,method))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Get a message = {}"</span>.<span style="color: #483d8b;">format</span>(body))

<span style="color: #a020f0;">with</span> connection:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#36153;&#32773;&#65292;&#27599;&#19968;&#20010;&#28040;&#36153;&#32773;&#20351;&#29992;&#19968;&#20010;basic_consume</span>
    channel.basic_consume(queue=name1,
                    auto_ack=<span style="color: #008b8b;">True</span>,
                    on_message_callback=callback)
    channel.basic_consume(queue=name2,
                    auto_ack=<span style="color: #008b8b;">True</span>,
                    on_message_callback=callback)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Waiting for messages. To exit press CTRL+C"</span>)
    channel.start_consuming()
</pre>
</div>

<p>
先启动消费者receie.py可以看到已经创建了exchange
</p>


<p>
如果exchange是fanout，也就是广播了，routing_key就不用关心了。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">q1</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">""</span>,exclusive=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<ul class="org-ul">
<li>尝试先启动生产者，再启动消费者试试看。</li>
<li>会导致部分数据丢失。因为：exchange收了数据，没有queue接受，所以，exchange丢弃了这些数据。</li>
</ul>

<p>
范例：
</p>

<ul class="org-ul">
<li>生产者</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;">#</span><span style="color: #b22222;">from pika.credentials import PlainCredentials</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">sender</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">param = pika.ConnectionParameters(</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'192.168.226.130', '5672',</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">'test', #&#34394;&#25311;&#26426;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">PlainCredentials('jasper', '123456')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">)</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>

<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'logs'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'fanout'</span>
channel.exchange_declare(exchange=ex_name,
                         exchange_type=ex_type)

<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.queue_declare(queue='hello')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#31471;&#22768;&#26126;&#12290;&#22914;&#26524;&#19981;&#23384;&#22312;&#65292;&#31435;&#21363;&#21019;&#24314;&#35813;q&#12290;&#21019;&#24314;&#30340;q&#19981;&#20250;&#22240;&#20026;&#36830;&#25509;&#20013;&#26029;&#32780;&#21024;&#38500;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#24687;&#25345;&#20037;&#21270; 1. &#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270; 2.&#25913;&#21464;&#28040;&#24687;&#30340;&#23646;&#24615;&#20540;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    channel.basic_publish(exchange=ex_name, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=<span style="color: #8b2252;">''</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">properties=pika.BasicProperties(delivery_mode=2),</span>
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#25968;&#25454;&#65292;&#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270;</span>
                          body=<span style="color: #8b2252;">'data-{:2}'</span>.<span style="color: #483d8b;">format</span>(i)
    time.sleep(0.5)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [x] Sent 'Hello World!'"</span>)

connection.close()
</pre>
</div>

<ul class="org-ul">
<li>消费者</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>)

<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'logs'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'fanout'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(exchange=ex_name,
                         exchange_type=ex_type)
<span style="color: #a0522d;">result</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name1</span> = result.method.queue
channel.queue_bind(exchange=ex_name, queue=q_name1)
<span style="color: #a0522d;">result2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name2</span> = result2.method.queue
channel.queue_bind(exchange=ex_name, queue=q_name2)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #a0522d;">ctag</span> = method.consumer_tag
    <span style="color: #a0522d;">dtag</span> = method.delivery_tag
    <span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(5)</span>
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{ctag}<span style="color: #8b2252;"> </span>{dtag}<span style="color: #8b2252;"> ** </span>{body}<span style="color: #8b2252;">"</span>)
    channel.basic_ack(dtag) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25163;&#21160;&#24212;&#31572;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#20026;&#28040;&#36153;&#32773;&#21495;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.basic_qos(prefetch_count=1)</span>
<span style="color: #a0522d;">c1</span> = channel.basic_consume(queue=q_name1,
                      auto_ack=<span style="color: #008b8b;">False</span>,
                      on_message_callback=callback)
<span style="color: #a0522d;">c2</span> = channel.basic_consume(queue=q_name2,
                      auto_ack=<span style="color: #008b8b;">False</span>,
                      on_message_callback=callback)
channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e14de8c7-6c4e-43f6-9635-88318aa5e521" class="outline-4">
<h4 id="h:e14de8c7-6c4e-43f6-9635-88318aa5e521">4.路由模式Routing <b>*</b></h4>
<div class="outline-text-4" id="text-h:e14de8c7-6c4e-43f6-9635-88318aa5e521">

<figure id="org299ac0d">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/python/images/img_20250826_182122.png" alt="img_20250826_182122.png">

</figure>

<p>
路由其实就是生产者的数据经过exhange的时候，通过匹配规则，决定数据的去向。
</p>

<ul class="org-ul">
<li>生产者代码，交换机类型为direct，指定路由的key</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> random
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@10.0.0.152:5672/test'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20132;&#25442;&#26426;</span>
<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'colors'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">'orange'</span>, <span style="color: #8b2252;">'black'</span>, <span style="color: #8b2252;">'green'</span>)
channel.exchange_declare(exchange=ex_name,
                         exchange_type=ex_type) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36335;&#30001;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.queue_declare(queue='hello')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#31471;&#22768;&#26126;&#12290;&#22914;&#26524;&#19981;&#23384;&#22312;&#65292;&#31435;&#21363;&#21019;&#24314;&#35813;q&#12290;&#21019;&#24314;&#30340;q&#19981;&#20250;&#22240;&#20026;&#36830;&#25509;&#20013;&#26029;&#32780;&#21024;&#38500;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#24687;&#25345;&#20037;&#21270; 1. &#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270; 2.&#25913;&#21464;&#28040;&#24687;&#30340;&#23646;&#24615;&#20540;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    <span style="color: #a0522d;">rk</span> = random.choice(colors)
    channel.basic_publish(exchange=ex_name, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=rk, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">properties=pika.BasicProperties(delivery_mode=2),</span>
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#25968;&#25454;&#65292;&#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270;</span>
                          body=<span style="color: #8b2252;">'{}-data-{:2}'</span>.<span style="color: #483d8b;">format</span>(rk, i))
    time.sleep(0.5)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [x] Sent 'Hello World!'"</span>)

connection.close()
</pre>
</div>

<ul class="org-ul">
<li>消费者代码</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@10.0.0.152:5672/test'</span>)

<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'colors'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">'orange'</span>, <span style="color: #8b2252;">'black'</span>, <span style="color: #8b2252;">'green'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(exchange=ex_name,
                         exchange_type=ex_type)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#21517;&#31216;&#38543;&#26426;&#65292;exclusive=True&#26029;&#24320;&#21024;&#38500;&#35813;&#38431;&#21015;</span>
<span style="color: #a0522d;">result</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name1</span> = result.method.queue
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32465;&#23450;&#21040;&#20132;&#25442;&#26426;&#65292;&#32780;&#19988;&#19968;&#23450;&#35201;&#32465;&#23450;routing_key</span>
channel.queue_bind(exchange=ex_name, queue=q_name1, routing_key=colors[0])
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.queue_bind(q_name1, ex_name, colors[0])</span>

<span style="color: #a0522d;">result2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name2</span> = result2.method.queue
channel.queue_bind(q_name2, ex_name, colors[1])
channel.queue_bind(q_name2, ex_name, colors[2])

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #a0522d;">ctag</span> = method.consumer_tag
    <span style="color: #a0522d;">dtag</span> = method.delivery_tag
    <span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(5)</span>
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{ctag}<span style="color: #8b2252;"> </span>{dtag}<span style="color: #8b2252;"> ** </span>{body}<span style="color: #8b2252;">"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">channel.basic_ack(dtag) # &#25163;&#21160;&#24212;&#31572;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#20026;&#28040;&#36153;&#32773;&#21495;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.basic_qos(prefetch_count=1)</span>
<span style="color: #a0522d;">c1</span> = channel.basic_consume(queue=q_name1,
                      auto_ack=<span style="color: #008b8b;">True</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#24212;&#31572;</span>
                      on_message_callback=callback)
<span style="color: #a0522d;">c2</span> = channel.basic_consume(queue=q_name2,
                      auto_ack=<span style="color: #008b8b;">True</span>,
                      on_message_callback=callback)
channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
connection.close()
</pre>
</div>

<p>
注意：如果routing_key设置一样，绑定的时候指定routing_key='black'。和fanout就类似了，都是1对多，但是不同
</p>
<ol class="org-ol">
<li>因为fanout时，exchange不做数据过滤，1个消息，所有绑定的queue都会拿到一个副部。</li>
<li>direct时候，要按照routing_key分配数据，上图的black有2个queue设置了，就会把1个消息分发给这2个queue。</li>
</ol>
</div>
</div>
<div id="outline-container-h:e653a929-3560-40ef-9b1e-509028546f6e" class="outline-4">
<h4 id="h:e653a929-3560-40ef-9b1e-509028546f6e">5.Topic话题</h4>
<div class="outline-text-4" id="text-h:e653a929-3560-40ef-9b1e-509028546f6e">
<p>
Topic就是更加高级的路由，支持模式匹配而已。
</p>

<p>
Topic的routing_key必须使用=.=点号分割的单词组成。最多255个字节。
</p>

<p>
支持使用通配符：
</p>
<ol class="org-ol">
<li>*表示严格的一个单词</li>
<li>#表示0个或多个单词</li>
</ol>

<p>
如果queue绑定的routing_key只是一个#,这个queue其实可以接收所有的消息。
</p>

<p>
如果没有使用任何通配符，效果类似于direct，因为只能和字符串匹配了。
</p>

<p>
生产者代码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> random
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@10.0.0.152:5672/test'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36830;&#25509;</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#31435;&#36890;&#36947;</span>

<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'products'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'topic'</span>
<span style="color: #a0522d;">products</span> = (<span style="color: #8b2252;">'pc'</span>, <span style="color: #8b2252;">'phone'</span>, <span style="color: #8b2252;">'tv'</span>)
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">'orange'</span>, <span style="color: #8b2252;">'black'</span>, <span style="color: #8b2252;">'red'</span>)
channel.exchange_declare(exchange=ex_name,
                         exchange_type=ex_type)

<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.queue_declare(queue='hello')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#31471;&#22768;&#26126;&#12290;&#22914;&#26524;&#19981;&#23384;&#22312;&#65292;&#31435;&#21363;&#21019;&#24314;&#35813;q&#12290;&#21019;&#24314;&#30340;q&#19981;&#20250;&#22240;&#20026;&#36830;&#25509;&#20013;&#26029;&#32780;&#21024;&#38500;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#24687;&#25345;&#20037;&#21270; 1. &#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270; 2.&#25913;&#21464;&#28040;&#24687;&#30340;&#23646;&#24615;&#20540;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    <span style="color: #a0522d;">rk</span> = <span style="color: #8b2252;">"{}.{}"</span>.<span style="color: #483d8b;">format</span>(random.choice(products), random.choice(colors))
    <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'{}-data-{:2}'</span>.<span style="color: #483d8b;">format</span>(rk, i)
    channel.basic_publish(exchange=ex_name, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=rk, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">properties=pika.BasicProperties(delivery_mode=2),</span>
                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#25968;&#25454;&#65292;&#38431;&#21015;&#24517;&#39035;&#25345;&#20037;&#21270;</span>
                          body=msg)
    <span style="color: #483d8b;">print</span>(msg)
    time.sleep(0.5)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [x] Sent 'Hello World!'"</span>)

connection.close()
</pre>
</div>

<ul class="org-ul">
<li>消费者代码</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time
<span style="color: #b22222;"># </span><span style="color: #b22222;">receive</span>
<span style="color: #a0522d;">param</span> = pika.URLParameters(<span style="color: #8b2252;">'amqp://jasper:123456@10.0.0.152:5672/test'</span>)

<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(param)
<span style="color: #a0522d;">channel</span> = connection.channel()

<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'products'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'topic'</span>
<span style="color: #a0522d;">products</span> = (<span style="color: #8b2252;">'pc'</span>, <span style="color: #8b2252;">'phone'</span>, <span style="color: #8b2252;">'tv'</span>)
<span style="color: #a0522d;">colors</span> = (<span style="color: #8b2252;">'orange'</span>, <span style="color: #8b2252;">'black'</span>, <span style="color: #8b2252;">'red'</span>)
channel.exchange_declare(exchange=ex_name,
                         exchange_type=ex_type)

<span style="color: #a0522d;">result</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name1</span> = result.method.queue
channel.queue_bind(q_name1, ex_name, <span style="color: #8b2252;">'phone.*'</span>)

<span style="color: #a0522d;">result2</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name2</span> = result2.method.queue
channel.queue_bind(q_name2, ex_name, <span style="color: #8b2252;">'*.red'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #a0522d;">ctag</span> = method.consumer_tag
    <span style="color: #a0522d;">dtag</span> = method.delivery_tag
    <span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(5)</span>
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{ctag}<span style="color: #8b2252;"> </span>{dtag}<span style="color: #8b2252;"> ** </span>{body}<span style="color: #8b2252;">"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">channel.basic_ack(dtag) # &#25163;&#21160;&#24212;&#31572;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#20026;&#28040;&#36153;&#32773;&#21495;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">channel.basic_qos(prefetch_count=1)</span>
<span style="color: #a0522d;">c1</span> = channel.basic_consume(queue=q_name1,
                      auto_ack=<span style="color: #008b8b;">True</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#24212;&#31572;</span>
                      on_message_callback=callback)
<span style="color: #a0522d;">c2</span> = channel.basic_consume(queue=q_name2,
                      auto_ack=<span style="color: #008b8b;">True</span>,
                      on_message_callback=callback)
channel.start_consuming()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>
connection.close()
</pre>
</div>

<p>
观察消费者拿到的数据，注意观察phone.red的数据出现次数。
</p>

<p>
由此，可以知道 <b>交换机在路由消息的时候，只要和queue的routing_key匹配，就把消息发给该queue。</b>
</p>
</div>
</div>
<div id="outline-container-h:a2e85b01-fb8c-4897-a4a2-02928d876b55" class="outline-4">
<h4 id="h:a2e85b01-fb8c-4897-a4a2-02928d876b55">RPC远程过程调用</h4>
<div class="outline-text-4" id="text-h:a2e85b01-fb8c-4897-a4a2-02928d876b55">
<ul class="org-ul">
<li>RabbitMQ的RPC的应用场景较少，因为有更好的RPC通信框架。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e" class="outline-3">
<h3 id="h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e">消息队列的作用</h3>
<div class="outline-text-3" id="text-h:d8e7051a-9c3c-44e6-9012-4d62ce51a29e">
<ol class="org-ol">
<li>系统间解耦</li>
<li>解决生产者、消费者速度匹配</li>
</ol>

<p>
由于稍微上规模的项目都会分层、分模块开发，模块间或系统间尽量不要直接耦合，需要开放公共接口提供给别的模块或系统调用，而调用可能触发并发问题，为了缓冲和解耦，往往采用中间件技术。
</p>

<p>
RabbitMQ只是消息中间件中的一种应用程序，也是较常用的中间件服务。
</p>
</div>
</div>
</section>
<section id="outline-container-h:1e876ea3-1367-4ed1-92a5-5f98f72ee51f" class="outline-2">
<h2 id="h:1e876ea3-1367-4ed1-92a5-5f98f72ee51f">模拟登陆oschina（新浪）</h2>
<div class="outline-text-2" id="text-h:1e876ea3-1367-4ed1-92a5-5f98f72ee51f">
<p>
一般登录后，用户就可以一段时间内可以使用该用户身份操作，不需要频繁登录了。这背后往往使用了Cookie技术。
</p>

<p>
登录后，用户获得一个cookie值，这个值在浏览器当前会话中保存，只要不过期甚至可以保存很久。
</p>

<p>
用户每次向服务器提交请求时，将这些Cookie提交到服务器，服务器经过分析Cookie中的信息，以确认用户身份，确认是信任的用户身份，就可以继续使用网站功能。
</p>

<p>
Cookie网景公司发明。cookie一般是一个键值对name=value，但还可以包括expire过期时间、path路径、domain域、secure安全、httponly等信息。
</p>


<p>
清空oschina.net的所有cookies，重新登录，勾选”记住密码“
</p>

<p>
登陆前需将所有cookies清除
</p>

<ul class="org-ul">
<li>对比登录前后的cookie值，发现登录后有oscid</li>
<li>那就把这个HTTP 请求头放在代码中</li>
</ul>

<p>
注意：每次登录后要重新生成下面的headers
</p>

<p>
使用Postman将请求头改为KV对形式
</p>
</div>
<div id="outline-container-h:bfaeced4-2794-4abc-a819-83aa115e6645" class="outline-3">
<h3 id="h:bfaeced4-2794-4abc-a819-83aa115e6645">使用postman的python代码生成器生成代码</h3>
<div class="outline-text-3" id="text-h:bfaeced4-2794-4abc-a819-83aa115e6645">
<ul class="org-ul">
<li>浏览器登录oschina.net网站</li>
<li>F12，复制原始的请求信息到postman
<ul class="org-ul">
<li>打开postman新建请求，点击headers下面的Bulk Edit</li>
<li>粘贴请求header信息</li>
<li>点击code，以python requests代码展示</li>
</ul></li>
<li>复制生成的python，再进行修改</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://my.oschina.net/u/9494857/admin/profile"</span>

<span style="color: #a0522d;">headers</span> = {
  <span style="color: #8b2252;">'Accept'</span>: <span style="color: #8b2252;">'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7'</span>,
  <span style="color: #8b2252;">'Accept-Encoding'</span>: <span style="color: #8b2252;">'gzip, deflate, br, zstd'</span>,
  <span style="color: #8b2252;">'Accept-Language'</span>: <span style="color: #8b2252;">'zh-CN,zh;q=0.9'</span>,
  <span style="color: #8b2252;">'Connection'</span>: <span style="color: #8b2252;">'keep-alive'</span>,
  <span style="color: #8b2252;">'Cookie'</span>: <span style="color: #8b2252;">"aliyungf_tc=AQAAAMgC7FB9xAEADtR2e0KAzgb3hr0a; _user_behavior_=768762a3-dbce-4152-a024-264820556c9c; OSCHINA_SESSION=4DFB86BECA93B1D28BC8FEF2E1478E97; _reg_key_=EwiEfyB66X3jlOb4pNzk; oscid=ZV2oveUqo28xv80qumQtfRqukWzpKq2brNqjn0Y0a5kFTeUQUUbcPj2dwLIiVt%2FuobUFKx4%2FabVv%2BZ5n%2BrJhvE8p%2BKdiM%2FUIONcDpf9cQ%2FCwMTYxj0IZhKrEKkqVYfw%2BdNYj1bbHQEhDiqhDeFBZbsf7ouMp1Msoa4cH6mU1ZtM%3D"</span>,
  <span style="color: #8b2252;">'DNT'</span>: <span style="color: #8b2252;">'1'</span>,
  <span style="color: #8b2252;">'Host'</span>: <span style="color: #8b2252;">'my.oschina.net'</span>,
  <span style="color: #8b2252;">'Referer'</span>: <span style="color: #8b2252;">'https://www.oschina.net/'</span>,
  <span style="color: #8b2252;">'Sec-Fetch-Dest'</span>: <span style="color: #8b2252;">'document'</span>,
  <span style="color: #8b2252;">'Sec-Fetch-Mode'</span>: <span style="color: #8b2252;">'navigate'</span>,
  <span style="color: #8b2252;">'Sec-Fetch-Site'</span>: <span style="color: #8b2252;">'same-site'</span>,
  <span style="color: #8b2252;">'Sec-Fetch-User'</span>: <span style="color: #8b2252;">'?1'</span>,
  <span style="color: #8b2252;">'Upgrade-Insecure-Requests'</span>: <span style="color: #8b2252;">'1'</span>,
  <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36'</span>,
  <span style="color: #8b2252;">'sec-ch-ua'</span>: <span style="color: #8b2252;">'"Not;A=Brand";v="99", "Google Chrome";v="139", "Chromium";v="139"'</span>,
  <span style="color: #8b2252;">'sec-ch-ua-mobile'</span>: <span style="color: #8b2252;">'?0'</span>,
  <span style="color: #8b2252;">'sec-ch-ua-platform'</span>: <span style="color: #8b2252;">'"Windows"'</span>
}
<span style="color: #a0522d;">session</span> = requests.Session()

<span style="color: #a020f0;">with</span> session:
    <span style="color: #a0522d;">response</span> = session.get(url, headers=headers)
    <span style="color: #a020f0;">with</span> response:
        <span style="color: #483d8b;">print</span>(response.url)
        <span style="color: #483d8b;">print</span>(url)
        <span style="color: #a020f0;">if</span> url == response.url:
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#24050;&#30331;&#24405;'</span>)
            <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/profile.html'</span>, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
                f.write(response.content)
        <span style="color: #a020f0;">else</span>:
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#26410;&#30331;&#24405;'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">logout &#27983;&#35272;&#22120;&#29992;&#25143;&#30331;&#24405;&#20877;&#25191;&#34892;&#33050;&#26412;&#36820;&#22238;&#19968;&#26679;&#30340;&#32467;&#26524;&#12290;&#35828;&#26126;&#65292;&#22240;&#20026;&#29992;&#25143;&#22826;&#22810;&#20102;&#65292;&#22914;&#26524;&#20445;&#23384;&#65292;&#21644;sessionid&#26080;&#24322;&#12290; response set-cookie oscid&#28165;&#31354;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25105;&#20204;&#19968;&#23450;&#35201;&#22312;oscid&#20013;&#22686;&#21152;&#19968;&#20010;&#26102;&#38388;&#25139;&#65292;&#21040;&#26102;&#20505;&#36825;&#20010;&#20540;&#19968;&#23450;&#35201;&#36807;&#26399;&#12290;&#35777;&#20070;&#31614;&#21517;&#65292;&#38450;&#27490;&#20462;&#25913;&#12290;JWT &#38450;&#31713;&#25913;&#12290;</span>
</pre>
</div>

<p>
由于站点升级到了HTTP2，可能部分页面请求头有了变化。
</p>

<p>
也可以通过页面内容判断是否登录，这就需要解析页面了。
</p>

<p>
已登录访问页面，右上角会有用户信息，如果未登录，就会出现登录、注册。这就是判断依据。
</p>

<p>
新浪微博等都一样，只要允许记住用户登录，就可以通过上述方法登录后爬取内容
</p>
</div>
</div>
</section>
<section id="outline-container-h:1d186b06-a5e6-4418-9259-27d139be9804" class="outline-2">
<h2 id="h:1d186b06-a5e6-4418-9259-27d139be9804">并发爬取博客园</h2>
<div class="outline-text-2" id="text-h:1d186b06-a5e6-4418-9259-27d139be9804">
<p>
博客园的新闻分页地址 <a href="https://news.cnblogs.com/n/page/10/">https://news.cnblogs.com/n/page/10/</a> ，多线程成批爬取新闻的 <b>标题和链接</b>.
</p>

<p>
<a href="https://news.cnblogs.com/n/page/2/">https://news.cnblogs.com/n/page/2/</a> ，这个url中变化的是最后的数字一直在变，它是页码
</p>
</div>
<div id="outline-container-h:403d48d9-bdfe-420d-a4e8-0cc9b5bd8a13" class="outline-3">
<h3 id="h:403d48d9-bdfe-420d-a4e8-0cc9b5bd8a13">基础</h3>
<div class="outline-text-3" id="text-h:403d48d9-bdfe-420d-a4e8-0cc9b5bd8a13">
</div>
<div id="outline-container-h:e1bdbb82-6dcf-4ea8-abc5-5cd0340c35e9" class="outline-4">
<h4 id="h:e1bdbb82-6dcf-4ea8-abc5-5cd0340c35e9">基本代码</h4>
<div class="outline-text-4" id="text-h:e1bdbb82-6dcf-4ea8-abc5-5cd0340c35e9">
<p>
xpath解析html
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree

<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'https://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #a0522d;">headers</span> = {
  <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36'</span>,
}
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, 1)
<span style="color: #483d8b;">print</span>(url)

<span style="color: #a0522d;">response</span> = requests.get(url, headers=headers)

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(response.status_code)
    <span style="color: #a020f0;">if</span> response.status_code == 200:
        <span style="color: #a0522d;">xpath</span> = <span style="color: #8b2252;">'//h2[@class="news_entry"]/a/text()'</span>
        <span style="color: #a0522d;">doc</span> = etree.HTML(response.text)
        <span style="color: #a0522d;">e</span> = doc.xpath(xpath)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">len</span>(e), e)
</pre>
</div>

<p>
beatifulsoup解析html
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'https://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #a0522d;">headers</span> = {
  <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36'</span>,
}
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, 1)
<span style="color: #483d8b;">print</span>(url)

<span style="color: #a0522d;">response</span> = requests.get(url, headers=headers)

<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(response.status_code)
    <span style="color: #a020f0;">if</span> response.status_code == 200:
        <span style="color: #b22222;">## </span><span style="color: #b22222;">xpath&#26041;&#27861;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath = '//h2[@class="news_entry"]/a/text()'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">doc = etree.HTML(response.text)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">e = doc.xpath(xpath)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(len(e), e)</span>

        <span style="color: #a0522d;">doc</span> = BeautifulSoup(response.content, <span style="color: #8b2252;">'lxml'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(doc)</span>
        <span style="color: #b22222;">## </span><span style="color: #b22222;">beatifulsoup&#26041;&#27861;</span>
        <span style="color: #b22222;">## </span><span style="color: #b22222;">&#26041;&#27861;1 css&#36873;&#25321;&#22120;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">selector = 'h2.news_entry &gt; a'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">titles = doc.select(selector)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">for title in titles:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">print(title.get('href'), title.text)</span>

        <span style="color: #b22222;">## </span><span style="color: #b22222;">&#26041;&#27861;2 find_all</span>
        <span style="color: #a0522d;">h2s</span> = doc.find_all(<span style="color: #8b2252;">'h2'</span>, class_=<span style="color: #8b2252;">'news_entry'</span>)
        <span style="color: #a020f0;">for</span> h <span style="color: #a020f0;">in</span> h2s:
            <span style="color: #a0522d;">a</span> = h.a <span style="color: #b22222;"># </span><span style="color: #b22222;">h.find('a')</span>
            <span style="color: #483d8b;">print</span>(a.get(<span style="color: #8b2252;">'href'</span>), a.text)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a256b03d-fbf5-44d3-b3cb-3b715009e1c5" class="outline-4">
<h4 id="h:a256b03d-fbf5-44d3-b3cb-3b715009e1c5">函数封装</h4>
<div class="outline-text-4" id="text-h:a256b03d-fbf5-44d3-b3cb-3b715009e1c5">
<ol class="org-ol">
<li>增加爬取页链接生成函数</li>
<li>增加爬取分析函数</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup

<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'https://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #a0522d;">headers</span> = {
  <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36'</span>,
}

<span style="color: #a0522d;">urls</span> = [] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24453;&#29228;&#21462;url,&#20808;&#36827;&#20808;&#20986;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21338;&#23458;&#22253;&#30340;&#26032;&#38395;urls&#65292;&#27599;&#39029;30&#26465;&#26032;&#38395;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start_urls</span>(start=1, stop=2, step=1):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(start, stop, step):
        <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, i)
        urls.append(url)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#38142;&#25509;&#21019;&#24314;&#23436;&#25104;'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">crawler</span>():
    <span style="color: #a020f0;">for</span> url <span style="color: #a020f0;">in</span> urls:
        <span style="color: #a0522d;">response</span> = requests.get(url, headers=headers)
        <span style="color: #a020f0;">with</span> response:
            <span style="color: #483d8b;">print</span>(response.status_code)
            <span style="color: #a020f0;">if</span> response.status_code == 200:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath = '//h2[@class="news_entry"]/a/text()'</span>
                <span style="color: #b22222;"># </span><span style="color: #b22222;">selector = 'h2.news_entry &gt; a'</span>
                <span style="color: #b22222;"># </span><span style="color: #b22222;">find_all</span>
                <span style="color: #a0522d;">doc</span> = BeautifulSoup(response.content, <span style="color: #8b2252;">'lxml'</span>)
                <span style="color: #a0522d;">h2s</span> = doc.find_all(<span style="color: #8b2252;">'h2'</span>, class_=<span style="color: #8b2252;">'news_entry'</span>)
                <span style="color: #a020f0;">for</span> h <span style="color: #a020f0;">in</span> h2s:
                    <span style="color: #a0522d;">a</span> = h.a <span style="color: #b22222;"># </span><span style="color: #b22222;">h.find('a')</span>
                    <span style="color: #483d8b;">print</span>(a.get(<span style="color: #8b2252;">'href'</span>), a.text)

start_urls(1, 2)
<span style="color: #483d8b;">print</span>(urls)
crawler()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f5e0de04-3a71-49e2-83a5-27e0ede3450e" class="outline-4">
<h4 id="h:f5e0de04-3a71-49e2-83a5-27e0ede3450e">异步</h4>
<div class="outline-text-4" id="text-h:f5e0de04-3a71-49e2-83a5-27e0ede3450e">
<p>
上面函数可以直接使用多线程，可以分别执行。但是如果改成多线程，有什么问题吗？
</p>

<p>
使用多线程最大的问题在于这里使用的列表，一个线程正在追加URL，一个线程需要拿走一个URL。应该使用Queue来完成，线程安全。
1、 引入线程池
</p>

<p>
2、使用线程安全的先进先出Queue
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor


<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'http://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://news.cnblogs.com/n/page/2/ &#21015;&#34920;&#39029;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://news.cnblogs.com/n/628919/ &#35814;&#24773;&#39029;</span>

<span style="color: #a0522d;">headers</span> = {
    <span style="color: #8b2252;">'User-agent'</span>: <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML,like Gecko)"</span>
                  <span style="color: #8b2252;">" Version / 5.0.1Safari / 537.36"</span>
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#65292;&#38431;&#21015;&#65292;&#20197;&#21518;&#25442;&#25104;&#31532;&#19977;&#26041;&#38431;&#21015;</span>
<span style="color: #a0522d;">urls</span> = Queue()


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21338;&#23458;&#22253;&#30340;&#26032;&#38395;urls&#65292;&#27599;&#39029;30&#26465;&#26032;&#38395;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">starts_url</span>(start, stop, step=1):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(start, stop + 1, step):
        <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, i)
        <span style="color: #483d8b;">print</span>(url)
        urls.put(url)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21152;&#20837;&#38431;&#21015;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#20219;&#21153;&#38142;&#25509;&#21019;&#24314;&#23436;&#27605;'</span>)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#21462;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">crawler</span>():
    <span style="color: #a0522d;">url</span> = urls.get()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#65292;&#25343;&#19968;&#26465;</span>
    <span style="color: #a020f0;">with</span> requests.get(url, headers=headers) <span style="color: #a020f0;">as</span> response:
        <span style="color: #a0522d;">html</span> = response.text

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;</span>
        <span style="color: #a0522d;">soup</span> = BeautifulSoup(html, <span style="color: #8b2252;">'lxml'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">h2.news_entry &gt; a</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">//h2[@new_entry=""]/a</span>
        <span style="color: #a0522d;">titles</span> = soup.select(<span style="color: #8b2252;">'h2.news_entry &gt; a'</span>)
        <span style="color: #a020f0;">for</span> title <span style="color: #a020f0;">in</span> titles:
            <span style="color: #483d8b;">print</span>(title.get(<span style="color: #8b2252;">'href'</span>), title.text)


<span style="color: #b22222;"># </span><span style="color: #b22222;">starts_url(1, 1)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">crawler()</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#27744;</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(10)

executor.submit(starts_url, 1, 1)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    executor.submit(crawler)
</pre>
</div>

<p>
3、解析函数
</p>

<p>
4、修改循环条件为Event
</p>

<p>
解析内容是一个比较耗时的过程，不适合放在crawler中同步处理。同样使用队列解耦
</p>



<figure id="org91b761a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/python/images/img_20250829_173122.png" alt="img_20250829_173122.png" width="50%">

</figure>

<p>
现在线程都是拿一条数据，执行完就结束了。修改为可以不停的从队列中取数据
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event


<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'http://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://news.cnblogs.com/n/page/2/ &#21015;&#34920;&#39029;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://news.cnblogs.com/n/628919/ &#35814;&#24773;&#39029;</span>

<span style="color: #a0522d;">headers</span> = {
    <span style="color: #8b2252;">'User-agent'</span>: <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML,like Gecko)"</span>
                  <span style="color: #8b2252;">" Version / 5.0.1Safari / 537.36"</span>
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#65292;&#38431;&#21015;&#65292;&#20197;&#21518;&#25442;&#25104;&#31532;&#19977;&#26041;&#38431;&#21015;</span>
<span style="color: #a0522d;">urls</span> = Queue()<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24453;&#29228;&#21462;&#38431;&#21015;</span>
<span style="color: #a0522d;">htmls</span> = Queue() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24453;&#20998;&#26512;&#38431;&#21015;</span>
<span style="color: #a0522d;">outputs</span> = Queue() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24453;&#36755;&#20986;&#38431;&#21015;</span>



<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21338;&#23458;&#22253;&#30340;&#26032;&#38395;urls&#65292;&#27599;&#39029;30&#26465;&#26032;&#38395;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">starts_urls</span>(start, stop, step=1):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(start, stop + 1, step):
        <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, i)
        <span style="color: #483d8b;">print</span>(url)
        urls.put(url)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21152;&#20837;&#38431;&#21015;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#20219;&#21153;&#38142;&#25509;&#21019;&#24314;&#23436;&#27605;'</span>)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#21462;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">crawler</span>(e:Event):
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.is_set():
        <span style="color: #a0522d;">url</span> = urls.get()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#65292;&#25343;&#19968;&#26465;</span>
        <span style="color: #a020f0;">with</span> requests.get(url, headers=headers) <span style="color: #a020f0;">as</span> response:
            <span style="color: #a0522d;">html</span> = response.text
            htmls.put(html)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(e:Event):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;</span>
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.is_set():
        <span style="color: #a0522d;">html</span> = htmls.get()

        <span style="color: #a0522d;">soup</span> = BeautifulSoup(html, <span style="color: #8b2252;">'lxml'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath = '//h2[@class="news_entry"]/a/text()'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">selector = 'h2.news_entry &gt; a'</span>
        <span style="color: #a0522d;">titles</span> = soup.find_all(<span style="color: #8b2252;">'h2'</span>, class_=<span style="color: #8b2252;">'news_entry'</span>)
        <span style="color: #a020f0;">for</span> title <span style="color: #a020f0;">in</span> titles:
            <span style="color: #a0522d;">a</span> = title.a
            <span style="color: #a020f0;">if</span> a:
                <span style="color: #a0522d;">href</span> = BASE_URL + a.get(<span style="color: #8b2252;">'href'</span>)
                <span style="color: #a0522d;">txt</span> = a.txt
                <span style="color: #a0522d;">val</span> = href, txt
                outputs.put(val)
                <span style="color: #483d8b;">print</span>(val)

<span style="color: #b22222;"># </span><span style="color: #b22222;">start_urls(1, 1)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">crawler()</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">parse()</span>

<span style="color: #a0522d;">event</span> = Event()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#27744;</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(10)

executor.submit(starts_url, 1, 1)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    executor.submit(crawler, event)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    executor.submit(parse, event)
</pre>
</div>

<p>
html分析函数parse，分析完成后，需要将结果持久化。不要在parse中直接持久化，放入队列中，统一持久化
</p>

<p>
5、增加持久化函数
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> json

<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'https://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #a0522d;">headers</span> = {
  <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36'</span>,
}

<span style="color: #a0522d;">urls</span> = Queue() <span style="color: #b22222;"># </span><span style="color: #b22222;"># &#24453;&#29228;&#21462;url&#38431;&#21015; # &#26410;&#26469;&#20934;&#22791;&#29992; MQ&#20013;&#38388;&#20214; &#26367;&#25442;</span>
<span style="color: #a0522d;">htmls</span> = Queue()
<span style="color: #a0522d;">outputs</span> = Queue()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21338;&#23458;&#22253;&#30340;&#26032;&#38395;urls&#65292;&#27599;&#39029;30&#26465;&#26032;&#38395;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start_urls</span>(start=1, stop=1, step=1):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(start, stop+1, step):
        <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, i)
        urls.put(url)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#38142;&#25509;&#21019;&#24314;&#23436;&#25104;'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">crawler</span>(e:Event):
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.is_set():
        <span style="color: #a0522d;">url</span> = urls.get() <span style="color: #b22222;"># </span><span style="color: #b22222;">blocked</span>
        <span style="color: #a0522d;">response</span> = requests.get(url, headers=headers)
        <span style="color: #a020f0;">with</span> response:
            <span style="color: #a020f0;">if</span> response.status_code == 200:
                <span style="color: #a0522d;">html</span> = response.text
                htmls.put(html)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(e:Event):
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.is_set():
        <span style="color: #a0522d;">html</span> = htmls.get() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath = '//h2[@class="news_entry"]/a/text()'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">selector = 'h2.news_entry &gt; a'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">find_all</span>
        <span style="color: #a0522d;">doc</span> = BeautifulSoup(html, <span style="color: #8b2252;">'lxml'</span>)
        <span style="color: #a0522d;">h2s</span> = doc.find_all(<span style="color: #8b2252;">'h2'</span>, class_=<span style="color: #8b2252;">'news_entry'</span>)
        <span style="color: #a020f0;">for</span> i, h <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(h2s, 1):
            <span style="color: #a0522d;">a</span> = h.a <span style="color: #b22222;"># </span><span style="color: #b22222;">h.find('a')</span>
            <span style="color: #483d8b;">print</span>(i, a.get(<span style="color: #8b2252;">'href'</span>), a.text) <span style="color: #b22222;"># </span><span style="color: #b22222;">=&gt; &#25968;&#25454;&#21487;&#20197;&#23384;&#20648;&#21040;mongodb&#20013;</span>
            <span style="color: #a0522d;">val</span> = {
                <span style="color: #8b2252;">'href'</span>: BASE_URL + a.get(<span style="color: #8b2252;">'href'</span>),
                <span style="color: #8b2252;">'title'</span>: a.text
            }
            <span style="color: #b22222;"># </span><span style="color: #b22222;">Queue&#20013;python&#33258;&#24049;&#24207;&#21015;&#21270; pickle,&#20294;&#26159;&#31532;&#19977;&#26041;&#26410;&#24517;&#22914;&#27492;</span>
            outputs.put(val)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">persist</span>(e:Event, path:<span style="color: #483d8b;">str</span>):
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(path, <span style="color: #8b2252;">'a+'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.is_set():
            <span style="color: #a0522d;">val</span> = outputs.get() <span style="color: #b22222;"># </span><span style="color: #b22222;">dict</span>
            f.write(json.dumps(val))
            f.flush()

<span style="color: #b22222;"># </span><span style="color: #b22222;">start_urls(1, 1)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">crawler()</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">parse()</span>

<span style="color: #a0522d;">event</span> = Event()
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#27744;</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(10)

executor.submit(start_urls,1, 1)
executor.submit(persist, event, <span style="color: #8b2252;">'d:/tmp/titles.txt'</span>)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    executor.submit(crawler, event)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4):
    executor.submit(parse, event)
</pre>
</div>

<p>
这样一个实用的并行的爬虫就基本完成了，一般提取新的URL源源不断地注入到待爬取队列，就可以实现不间断的爬取了
</p>

<p>
可以很方便的扩展成多进程等版本
</p>
</div>
</div>
</div>
<div id="outline-container-h:9fb85552-33b5-45ac-a1ff-0fb31797895a" class="outline-3">
<h3 id="h:9fb85552-33b5-45ac-a1ff-0fb31797895a">进阶（消息队列）</h3>
<div class="outline-text-3" id="text-h:9fb85552-33b5-45ac-a1ff-0fb31797895a">
<p>
将队列换成第三方服务，本次采用较为常用RabbitMQ
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">params</span> = pika.URLParameters(
    <span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">direct&#36335;&#30001;&#65292;&#20132;&#25442;&#26426; queue &#30001;&#28040;&#36153;&#32773;&#38543;&#26426;&#29983;&#25104;&#21517;&#31216;&#32465;&#23450;rk&#65292;&#29983;&#20135;&#32773;exchange &#29983;&#25104;&#26102;&#20889;rk</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
<span style="color: #a0522d;">channel</span> = connection.channel()
<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'news'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
<span style="color: #a0522d;">rks</span> = (<span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'outputs'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=ex_name,
    exchange_type=ex_type)
<span style="color: #a0522d;">rk</span> = rks[0]

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'{}-data-{:2}'</span>.<span style="color: #483d8b;">format</span>(rk, i)
    channel.basic_publish(exchange=ex_name, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=rk, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          body=msg)
    <span style="color: #483d8b;">print</span>(msg)
    time.sleep(0.5)

connection.close()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">params</span> = pika.URLParameters(
    <span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">direct&#36335;&#30001;&#65292;&#20132;&#25442;&#26426; queue &#30001;&#28040;&#36153;&#32773;&#38543;&#26426;&#29983;&#25104;&#21517;&#31216;&#32465;&#23450;rk&#65292;&#29983;&#20135;&#32773;exchange &#29983;&#25104;&#26102;&#20889;rk</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
<span style="color: #a0522d;">channel</span> = connection.channel()
<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'news'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
<span style="color: #a0522d;">rks</span> = (<span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'outputs'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=ex_name,
    exchange_type=ex_type)
<span style="color: #a0522d;">rk</span> = rks[0]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#24182;&#32465;&#23450;</span>
<span style="color: #a0522d;">result</span> = channel.queue_declare(queue=<span style="color: #8b2252;">''</span>, exclusive=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">q_name</span> = result.method.queue
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32465;&#23450;&#21040;&#20132;&#25442;&#26426;&#65292;&#32780;&#19988;&#19968;&#23450;&#35201;&#32465;&#23450;routing_key</span>
channel.queue_bind(q_name, ex_name, rk)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{method.consumer_tag}<span style="color: #8b2252;"> -- </span>{body}<span style="color: #8b2252;">"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#38431;&#21015;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">method, properties, body = channel.basic_get(q_name,True)</span>
channel.basic_consume(
    q_name, on_message_callback=callback, auto_ack=<span style="color: #008b8b;">True</span>
)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [*] Waiting for messages. To exit press CTRL+C"</span>)
channel.start_consuming()
</pre>
</div>
</div>
<div id="outline-container-h:7fd990ee-5335-4deb-8251-f77ebda98be4" class="outline-4">
<h4 id="h:7fd990ee-5335-4deb-8251-f77ebda98be4">选型</h4>
<div class="outline-text-4" id="text-h:7fd990ee-5335-4deb-8251-f77ebda98be4">
<p>
1、队列工作模式选择
</p>

<p>
以爬虫程序的htmls队列为例，这个队列有多个生产者（爬取函数）写入，有多个消费者（解析函数）读取。每一个消息只能被消费一次。所以，采用RabbitMQ的 <b>工作队列模式</b>
</p>

<p>
RabbitMQ生产者、消费者两端都可以创建交换机、队列。
</p>

<p>
2、队列中如何如何分发
</p>

<p>
工作队列模式，说到底就是路由模式。RabbitMQ的队列和工作队列模式，交换机都工作在direct，其实都是路由模式，只不过使用了缺省交换机
</p>

<p>
我们自己使用，可以单独创建交换机，不使用缺省交换机
</p>

<p>
3、队列是否断开删除
</p>

<p>
如果丢几条新闻没有关系，exclusive=True。否则，就要选择队列exclusive=False，甚至是durable=True。
</p>
</div>
</div>
<div id="outline-container-h:5ecb7169-1096-4e20-b2be-0a938165f08b" class="outline-4">
<h4 id="h:5ecb7169-1096-4e20-b2be-0a938165f08b">生产者消息者代码</h4>
<div class="outline-text-4" id="text-h:5ecb7169-1096-4e20-b2be-0a938165f08b">
<p>
生产者代码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">params</span> = pika.URLParameters(
    <span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">direct&#36335;&#30001;&#65292;&#20132;&#25442;&#26426; queue &#30001;&#28040;&#36153;&#32773;&#38543;&#26426;&#29983;&#25104;&#21517;&#31216;&#32465;&#23450;rk&#65292;&#29983;&#20135;&#32773;exchange &#29983;&#25104;&#26102;&#20889;rk</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
<span style="color: #a0522d;">channel</span> = connection.channel()
<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'news'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
<span style="color: #a0522d;">rks</span> = (<span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'outputs'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=ex_name,
    exchange_type=ex_type)
<span style="color: #a0522d;">q_name</span> = rks[0]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#24182;&#32465;&#23450;</span>
<span style="color: #a0522d;">result</span> = channel.queue_declare(q_name, exclusive=<span style="color: #008b8b;">False</span>)
channel.queue_bind(q_name, ex_name)

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(50):
    <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'{}-data-{:2}'</span>.<span style="color: #483d8b;">format</span>(q_name, i)
    channel.basic_publish(exchange=ex_name, <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
                          routing_key=q_name, <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
                          body=msg)
    <span style="color: #483d8b;">print</span>(msg)
    time.sleep(0.5)



connection.close()
</pre>
</div>

<p>
消费者代码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">params</span> = pika.URLParameters(
    <span style="color: #8b2252;">'amqp://jasper:123456@192.168.226.130:5672/test'</span>
)

<span style="color: #b22222;"># </span><span style="color: #b22222;">direct&#36335;&#30001;&#65292;&#20132;&#25442;&#26426; queue &#30001;&#28040;&#36153;&#32773;&#38543;&#26426;&#29983;&#25104;&#21517;&#31216;&#32465;&#23450;rk&#65292;&#29983;&#20135;&#32773;exchange &#29983;&#25104;&#26102;&#20889;rk</span>
<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
<span style="color: #a0522d;">channel</span> = connection.channel()
<span style="color: #a0522d;">ex_name</span> = <span style="color: #8b2252;">'news'</span>
<span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
<span style="color: #a0522d;">rks</span> = (<span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'outputs'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
channel.exchange_declare(
    exchange=ex_name,
    exchange_type=ex_type)
<span style="color: #a0522d;">q_name</span> = rks[0]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#24182;&#32465;&#23450;</span>
<span style="color: #a0522d;">result</span> = channel.queue_declare(q_name, exclusive=<span style="color: #008b8b;">False</span>)
channel.queue_bind(q_name, ex_name)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">callback</span>(ch, method, properties, body):
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">"</span>{method.consumer_tag}<span style="color: #8b2252;"> -- </span>{body}<span style="color: #8b2252;">"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28040;&#36153;&#38431;&#21015;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">method, properties, body = channel.basic_get(q_name,True)</span>
channel.basic_consume(
    q_name, on_message_callback=callback, auto_ack=<span style="color: #008b8b;">True</span>
)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">" [*] Waiting for messages. To exit press CTRL+C"</span>)
channel.start_consuming()
</pre>
</div>

<p>
可以看到，前面一些代码一样，做一下类的封装。
</p>
</div>
</div>
<div id="outline-container-h:7b31251d-dd58-4b06-a6bc-497569b37954" class="outline-4">
<h4 id="h:7b31251d-dd58-4b06-a6bc-497569b37954">重构消息队列类</h4>
<div class="outline-text-4" id="text-h:7b31251d-dd58-4b06-a6bc-497569b37954">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#21253;&#25991;&#20214;</span>
./mq/__init__.py
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#32773;&#20195;&#30721;</span>
<span style="color: #a020f0;">import</span> pika
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Base</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, host, vh, exchange, queue, username, password, port=5672, **kwargs):
        <span style="color: #a0522d;">params</span> = pika.URLParameters(
            <span style="color: #8b2252;">'amqp://{}:{}@{}:{}/{}'</span>.<span style="color: #483d8b;">format</span>(
                username,password,host,port,vh
            )
        )

        <span style="color: #b22222;"># </span><span style="color: #b22222;">direct&#36335;&#30001;&#65292;&#20132;&#25442;&#26426; queue &#30001;&#28040;&#36153;&#32773;&#38543;&#26426;&#29983;&#25104;&#21517;&#31216;&#32465;&#23450;rk&#65292;&#29983;&#20135;&#32773;exchange &#29983;&#25104;&#26102;&#20889;rk</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">connection</span> = pika.BlockingConnection(params)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">channel</span> = <span style="color: #a020f0;">self</span>.connection.channel()
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">exchange</span> = exchange
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">queue</span> = queue
        <span style="color: #b22222;"># </span><span style="color: #b22222;">ex_name = 'news'</span>
        <span style="color: #a0522d;">ex_type</span> = <span style="color: #8b2252;">'direct'</span>
        <span style="color: #a0522d;">rks</span> = (<span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'outputs'</span>)

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20132;&#25442;&#26426;</span>
        <span style="color: #a020f0;">self</span>.channel.exchange_declare(
            exchange=exchange,
            exchange_type=ex_type)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">q_name = rks[0]</span>

        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#38431;&#21015;&#65292;&#24182;&#32465;&#23450;</span>
        <span style="color: #a0522d;">result</span> = <span style="color: #a020f0;">self</span>.channel.queue_declare(queue, exclusive=<span style="color: #008b8b;">False</span>)
        <span style="color: #a020f0;">self</span>.channel.queue_bind(queue, exchange)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__enter__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__exit__</span>(<span style="color: #a020f0;">self</span>, exc_type, exc_val, exc_tb):
        <span style="color: #a020f0;">self</span>.channel.close()
        <span style="color: #a020f0;">self</span>.connection.close()

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Producer</span>(Base):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">produce</span>(<span style="color: #a020f0;">self</span>, message:<span style="color: #483d8b;">str</span>):
        <span style="color: #a020f0;">self</span>.channel.basic_publish(
            exchange=<span style="color: #a020f0;">self</span>.exchange,  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#32570;&#30465; test/default</span>
            routing_key=<span style="color: #a020f0;">self</span>.queue,  <span style="color: #b22222;"># </span><span style="color: #b22222;">q&#30340;&#21517;&#23383;</span>
            body=message)

<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Consummer</span>(Base):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">consume</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">method</span>, <span style="color: #a0522d;">properties</span>, <span style="color: #a0522d;">body</span> = <span style="color: #a020f0;">self</span>.channel.basic_get(<span style="color: #a020f0;">self</span>.queue,<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;&#38459;&#22622;</span>
        <span style="color: #a020f0;">if</span> body:
            <span style="color: #a020f0;">return</span> body
        <span style="color: #a020f0;">else</span>:
            time.sleep(1)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print('~~~~')</span>

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">rks</span> = (<span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'outputs'</span>)

    <span style="color: #b22222;">#</span><span style="color: #b22222;">host, vh, exchange, queue, username, password, port=5672,</span>
    <span style="color: #a020f0;">with</span> Producer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456) <span style="color: #a020f0;">as</span> p:
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
            <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'{}-data-{:2}'</span>.<span style="color: #483d8b;">format</span>(p.queue, i)
            p.produce(msg)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">request --&gt; response</span>
    <span style="color: #a020f0;">with</span> Consummer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456) <span style="color: #a020f0;">as</span> c:
        <span style="color: #a020f0;">with</span> Producer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456) <span style="color: #a020f0;">as</span> p:
            <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
                <span style="color: #a0522d;">url</span> = c.consume()
                <span style="color: #a020f0;">if</span> url:
                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#21462;</span>
                    <span style="color: #a0522d;">html</span> = <span style="color: #8b2252;">'aa'</span>
                    p.produce(html)
                <span style="color: #483d8b;">print</span>(url, <span style="color: #8b2252;">'+++'</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">parse</span>
    <span style="color: #a020f0;">with</span> Consummer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456) <span style="color: #a020f0;">as</span> c:
        <span style="color: #a020f0;">with</span> Producer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'outputs'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456) <span style="color: #a020f0;">as</span> p:
            <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
                <span style="color: #a0522d;">html</span> = c.consume()
                <span style="color: #a020f0;">if</span> html:
                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;</span>
                    <span style="color: #a0522d;">value</span> = {}
                    p.produce(value)

    <span style="color: #a020f0;">with</span> Consummer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'outputs'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456) <span style="color: #a020f0;">as</span> c:
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
            <span style="color: #a0522d;">value</span> = c.consume()
            <span style="color: #a020f0;">if</span> value:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20837;&#24211;</span>
                <span style="color: #a020f0;">pass</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b979faff-bc3d-4980-8724-e753c793d2e8" class="outline-4">
<h4 id="h:b979faff-bc3d-4980-8724-e753c793d2e8">重构爬虫代码</h4>
<div class="outline-text-4" id="text-h:b979faff-bc3d-4980-8724-e753c793d2e8">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> bs4.element <span style="color: #a020f0;">import</span> Tag
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a020f0;">from</span> messagequeue <span style="color: #a020f0;">import</span> Producer, Consumer


<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'http://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://news.cnblogs.com/n/page/2/ &#21015;&#34920;&#39029;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://news.cnblogs.com/n/628919/ &#35814;&#24773;&#39029;</span>

<span style="color: #a0522d;">headers</span> = {
    <span style="color: #8b2252;">'User-agent'</span>: <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; Windows NT 6.1; zh-CN) AppleWebKit/537.36 (KHTML,like Gecko)"</span>
                  <span style="color: #8b2252;">" Version / 5.0.1Safari / 537.36"</span>
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#65292;&#38431;&#21015;&#65292;&#20197;&#21518;&#25442;&#25104;&#31532;&#19977;&#26041;&#38431;&#21015;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">urls = Queue()# &#24453;&#29228;&#21462;&#38431;&#21015;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">htmls = Queue() # &#24453;&#20998;&#26512;&#38431;&#21015;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">outputs = Queue() # &#24453;&#36755;&#20986;&#38431;&#21015;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21338;&#23458;&#22253;&#30340;&#26032;&#38395;urls&#65292;&#27599;&#39029;30&#26465;&#26032;&#38395;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">starts_url</span>(start, stop, step=1):
    <span style="color: #a0522d;">p</span> = Producer(<span style="color: #8b2252;">'192.168.1.5'</span>, 5672, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>)
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(start, stop + 1, step):
        <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, i)
        <span style="color: #483d8b;">print</span>(url)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">urls.put(url)  # &#21152;&#20837;&#38431;&#21015;</span>
        p.produce(url)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#20219;&#21153;&#38142;&#25509;&#21019;&#24314;&#23436;&#27605;'</span>)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#21462;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">crawler</span>(e:Event):
    <span style="color: #a0522d;">p</span> = Producer(<span style="color: #8b2252;">'192.168.1.5'</span>, 5672, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>)
    <span style="color: #a0522d;">c</span> = Consumer(<span style="color: #8b2252;">'192.168.1.5'</span>, 5672, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.wait(1):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">url = urls.get()  # &#38459;&#22622;&#65292;&#25343;&#19968;&#26465;</span>
        <span style="color: #a0522d;">url</span> = c.consume()
        <span style="color: #a020f0;">if</span> url:
            <span style="color: #a020f0;">with</span> requests.get(url, headers=headers) <span style="color: #a020f0;">as</span> response:
                <span style="color: #a020f0;">if</span> response.status_code == 200:
                    <span style="color: #a0522d;">html</span> = response.text
                    <span style="color: #b22222;">#</span><span style="color: #b22222;">htmls.put(html)</span>
                    p.produce(html)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(e:Event):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;</span>
    <span style="color: #a0522d;">p</span> = Producer(<span style="color: #8b2252;">'192.168.1.5'</span>, 5672, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>)
    <span style="color: #a0522d;">c</span> = Consumer(<span style="color: #8b2252;">'192.168.1.5'</span>, 5672, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.wait(1):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">html = htmls.get()</span>
        <span style="color: #a0522d;">html</span> = c.consume()

        <span style="color: #a020f0;">if</span> html:
            <span style="color: #a0522d;">soup</span> = BeautifulSoup(html, <span style="color: #8b2252;">'lxml'</span>)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">h2.news_entry &gt; a</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">//h2[@new_entry=""]/a</span>
            <span style="color: #a0522d;">titles</span> = soup.select(<span style="color: #8b2252;">'h2.news_entry &gt; a'</span>)
            <span style="color: #a020f0;">for</span> title <span style="color: #a020f0;">in</span> titles:
                <span style="color: #a0522d;">val</span> = simplejson.dumps({
                    <span style="color: #8b2252;">'title'</span>: title.text,
                    <span style="color: #8b2252;">'url'</span>: BASE_URL + title.get(<span style="color: #8b2252;">'href'</span>,<span style="color: #8b2252;">''</span>)
                })
                <span style="color: #b22222;"># </span><span style="color: #b22222;">outputs.put(val)</span>
                p.produce(val)
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(val)</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">persist</span>(path, e: Event):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20197;&#21518;&#25345;&#20037;&#21270;&#21040;&#25968;&#25454;&#24211;&#24403;&#20013;&#21435;</span>
    <span style="color: #a0522d;">c</span> = Consumer(<span style="color: #8b2252;">'192.168.1.5'</span>, 5672, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'lqx'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>)
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(path, <span style="color: #8b2252;">'a+'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.wait(1):
            <span style="color: #b22222;"># </span><span style="color: #b22222;">val = outputs.get()</span>
            <span style="color: #a0522d;">data</span> = c.consume()
            <span style="color: #a020f0;">if</span> data:
                <span style="color: #a0522d;">val</span> = simplejson.loads(data)
                f.write(<span style="color: #8b2252;">"{}</span><span style="color: #008b8b;">\x01</span><span style="color: #8b2252;">{}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>.<span style="color: #483d8b;">format</span>(val[<span style="color: #8b2252;">'url'</span>], val[<span style="color: #8b2252;">'title'</span>]))
                f.flush()

<span style="color: #a0522d;">event</span> = Event()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#27744;</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(10)

executor.submit(starts_url, 1, 2)
executor.submit(persist, <span style="color: #8b2252;">'d:/news.txt'</span>, event)

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    executor.submit(crawler, event)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4):
    executor.submit(parse, event)
</pre>
</div>
<p>
爬取、解析、存储、url生成都可以完全独立，分别部署
</p>
</div>
</div>
<div id="outline-container-h:634dd262-47cb-4e1f-807c-52492a389242" class="outline-4">
<h4 id="h:634dd262-47cb-4e1f-807c-52492a389242">持久化</h4>
<div class="outline-text-4" id="text-h:634dd262-47cb-4e1f-807c-52492a389242">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> lxml <span style="color: #a020f0;">import</span> etree
<span style="color: #a020f0;">from</span> bs4 <span style="color: #a020f0;">import</span> BeautifulSoup
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">from</span> mq <span style="color: #a020f0;">import</span> Producer, Consummer
<span style="color: #a020f0;">import</span> pymongo

<span style="color: #a0522d;">BASE_URL</span> = <span style="color: #8b2252;">'https://news.cnblogs.com'</span>
<span style="color: #a0522d;">NEWS_PAGE</span> = <span style="color: #8b2252;">'/n/page/'</span>
<span style="color: #a0522d;">headers</span> = {
  <span style="color: #8b2252;">'User-Agent'</span>: <span style="color: #8b2252;">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36'</span>,
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">urls = Queue() # # &#24453;&#29228;&#21462;url&#38431;&#21015; # &#26410;&#26469;&#20934;&#22791;&#29992; MQ&#20013;&#38388;&#20214; &#26367;&#25442;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">htmls = Queue()</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">outputs = Queue()</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21338;&#23458;&#22253;&#30340;&#26032;&#38395;urls&#65292;&#27599;&#39029;30&#26465;&#26032;&#38395;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start_urls</span>(start=1, stop=1, step=1):
    <span style="color: #a0522d;">p</span> = Producer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456)
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(start, stop+1, step):
        <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"{}{}{}/"</span>.<span style="color: #483d8b;">format</span>(BASE_URL, NEWS_PAGE, i)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">urls.put(url)</span>
        p.produce(url)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#38142;&#25509;&#21019;&#24314;&#23436;&#25104;'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#21462;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">crawler</span>(e:Event):
    <span style="color: #a0522d;">c</span> = Consummer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'urls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456)
    <span style="color: #a0522d;">p</span> = Producer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.wait(1):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">url = urls.get() # blocked</span>
        <span style="color: #a0522d;">url</span> = c.consume()
        <span style="color: #a020f0;">if</span> url:
            <span style="color: #a0522d;">response</span> = requests.get(url, headers=headers)
            <span style="color: #a020f0;">with</span> response:
                <span style="color: #a020f0;">if</span> response.status_code == 200:
                    <span style="color: #a0522d;">html</span> = response.text
                    <span style="color: #b22222;"># </span><span style="color: #b22222;">htmls.put(html)</span>
                    p.produce(html)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;&#39029;&#38754;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(e:Event):
    <span style="color: #a0522d;">c</span> = Consummer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'htmls'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456)
    <span style="color: #a0522d;">p</span> = Producer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'outputs'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.is_set():
        <span style="color: #b22222;"># </span><span style="color: #b22222;">html = htmls.get() # &#38459;&#22622;</span>
        <span style="color: #a0522d;">html</span> = c.consume()
        <span style="color: #a020f0;">if</span> html:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath = '//h2[@class="news_entry"]/a/text()'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">selector = 'h2.news_entry &gt; a'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">find_all</span>
            <span style="color: #a0522d;">doc</span> = BeautifulSoup(html, <span style="color: #8b2252;">'lxml'</span>)
            <span style="color: #a0522d;">h2s</span> = doc.find_all(<span style="color: #8b2252;">'h2'</span>, class_=<span style="color: #8b2252;">'news_entry'</span>)
            <span style="color: #a020f0;">for</span> i, h <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(h2s, 1):
                <span style="color: #a0522d;">a</span> = h.a <span style="color: #b22222;"># </span><span style="color: #b22222;">h.find('a')</span>
                <span style="color: #483d8b;">print</span>(i, a.get(<span style="color: #8b2252;">'href'</span>), a.text) <span style="color: #b22222;"># </span><span style="color: #b22222;">=&gt; &#25968;&#25454;&#21487;&#20197;&#23384;&#20648;&#21040;mongodb&#20013;</span>
                <span style="color: #a0522d;">val</span> = {
                    <span style="color: #8b2252;">'id'</span>: i,
                    <span style="color: #8b2252;">'href'</span>: BASE_URL + a.get(<span style="color: #8b2252;">'href'</span>),
                    <span style="color: #8b2252;">'title'</span>: a.text
                }
                <span style="color: #b22222;"># </span><span style="color: #b22222;">Queue&#20013;python&#33258;&#24049;&#24207;&#21015;&#21270; pickle,&#20294;&#26159;&#31532;&#19977;&#26041;&#26410;&#24517;&#22914;&#27492;</span>
                <span style="color: #b22222;"># </span><span style="color: #b22222;">outputs.put(val)</span>
                p.produce(json.dumps(val))

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#21270;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">persist</span>(e:Event, path:<span style="color: #483d8b;">str</span>):
    <span style="color: #a0522d;">c</span> = Consummer(<span style="color: #8b2252;">'192.168.226.130'</span>, <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'news'</span>, <span style="color: #8b2252;">'outputs'</span>, <span style="color: #8b2252;">'jasper'</span>, 123456)
    <span style="color: #a0522d;">client</span> = pymongo.MongoClient(
        <span style="color: #8b2252;">'mongodb://192.168.226.130:27017'</span>
    )
    <span style="color: #a0522d;">db</span> = client.news  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24211;</span>
    <span style="color: #a0522d;">href</span> = db.href  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#65292;&#38598;&#21512;&#65292;n&#26465; &#25991;&#26723;</span>
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> e.wait(1):
        <span style="color: #a0522d;">value</span> = c.consume()
        <span style="color: #a020f0;">if</span> value:
            <span style="color: #a020f0;">try</span>:
                href.insert_one(json.loads(value))
            <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> ex:
                <span style="color: #483d8b;">print</span>(ex)
                <span style="color: #483d8b;">print</span>(value)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">with open(path, 'ab') as f:</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">while not e.is_set():</span>
    <span style="color: #b22222;">#         </span><span style="color: #b22222;"># val = outputs.get() # dict</span>
    <span style="color: #b22222;">#         </span><span style="color: #b22222;">value = c.consume()</span>
    <span style="color: #b22222;">#         </span><span style="color: #b22222;">if value:</span>
    <span style="color: #b22222;">#             </span><span style="color: #b22222;"># print(value)</span>
    <span style="color: #b22222;">#             </span><span style="color: #b22222;">f.write(value + b',\n')</span>
    <span style="color: #b22222;">#             </span><span style="color: #b22222;">f.flush()</span>

<span style="color: #a0522d;">event</span> = Event()
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#27744;</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(10)

executor.submit(start_urls,1, 2)
executor.submit(persist, event, <span style="color: #8b2252;">'d:/tmp/titles.txt'</span>)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    executor.submit(crawler, event)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4):
    executor.submit(parse, event)
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:94cc31e3-1836-4ff2-98d9-63f72f0ffa09" class="outline-2">
<h2 id="h:94cc31e3-1836-4ff2-98d9-63f72f0ffa09">Selenium和PhantomJS</h2>
<div class="outline-text-2" id="text-h:94cc31e3-1836-4ff2-98d9-63f72f0ffa09">
</div>
<div id="outline-container-h:bb5ddff5-d739-418c-adb8-8a47ebb53656" class="outline-3">
<h3 id="h:bb5ddff5-d739-418c-adb8-8a47ebb53656">动态网页处理</h3>
<div class="outline-text-3" id="text-h:bb5ddff5-d739-418c-adb8-8a47ebb53656">
<p>
很多网站都采用A JAX技术、SPA技术，部分内容都是异步动态加载的。可以提高用户体验，减少不必要的流量，方便CDN加速等。
</p>

<p>
但是，对于爬虫程序爬取到的HTML页面相当于页面模板了，动态内容不在其中
</p>

<p>
解决办法之一，如果能构造一个包含JS引擎的浏览器，让它加载网页并和网站交互，我们编程从这个浏览器获取内容包括动态内容。这个浏览器不需要和用户交互的界面，只要能支持HTTP、HTTPS协议和服务器端交互，能解析HTML、CSS、JS就行。
</p>
</div>
</div>
<div id="outline-container-h:6b0c075f-5eea-47b2-bef6-f57d40c39dac" class="outline-3">
<h3 id="h:6b0c075f-5eea-47b2-bef6-f57d40c39dac">PhantomJS</h3>
<div class="outline-text-3" id="text-h:6b0c075f-5eea-47b2-bef6-f57d40c39dac">
<p>
它是一个headless无头浏览器，支持Javascript。可以运行在Windows、Linux、Mac OS等。
</p>

<p>
所谓无头浏览器，就是包含Js引擎、浏览器排版引擎等核心组件，但是没有和用户交互的界面的浏览器。
</p>

<ul class="org-ul">
<li>官网 <a href="http://phantomjs.org/">http://phantomjs.org/</a></li>
<li>官方文档 <a href="http://phantomjs.org/documentation/">http://phantomjs.org/documentation/</a></li>
<li>下载 <a href="http://phantomjs.org/download.html">http://phantomjs.org/download.html</a>
下载对应操作系统的PhantomJS，解压缩就可以使用</li>
</ul>

<p>
测试编写test.js，运行命令 <code>phantomjs/bin/phantomjs.exe test.js</code>
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #8b2252;">"use strict"</span>;
console.log(<span style="color: #8b2252;">'hello world'</span>);
phantom.exit();
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c26b4db8-aa7a-4640-8360-98c0866aae33" class="outline-3">
<h3 id="h:c26b4db8-aa7a-4640-8360-98c0866aae33">Selenium</h3>
<div class="outline-text-3" id="text-h:c26b4db8-aa7a-4640-8360-98c0866aae33">
<p>
它是一个WEB自动化测试工具。它可以直接运行在浏览器中，支持主流的浏览器，包括PhantomJS（无头浏览器）
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install selenium
</pre>
</div>

<p>
官网：<a href="https://www.selenium.dev/">https://www.selenium.dev/</a>
</p>
</div>
<div id="outline-container-h:e8fe6eeb-a6c3-4529-99f5-7060a3e3f542" class="outline-4">
<h4 id="h:e8fe6eeb-a6c3-4529-99f5-7060a3e3f542">selenium基本语法学习</h4>
<div class="outline-text-4" id="text-h:e8fe6eeb-a6c3-4529-99f5-7060a3e3f542">
</div>
<div id="outline-container-h:fb324ca8-e199-43c6-ba87-92414ddb722f" class="outline-5">
<h5 id="h:fb324ca8-e199-43c6-ba87-92414ddb722f">元素定位</h5>
<div class="outline-text-5" id="text-h:fb324ca8-e199-43c6-ba87-92414ddb722f">
<p>
Selenium元素定位是指通过特定的方法在网页中准确定位到需要操作的元素，例如按钮、文本框、下拉菜单等。以下是一些常用的Selenium元素定位相关的语法：
</p>

<p>
Selenium3.x版本前
</p>
<div class="org-src-container">
<pre class="src src-sh">&#22312;Selenium3.x&#29256;&#26412;&#21450;&#20043;&#21069;&#65292;&#35821;&#27861;&#22914;&#19979;&#65306;
&#65288;1&#65289;&#36890;&#36807;ID&#23450;&#20301;&#20803;&#32032;
element = driver.find_element_by_id(<span style="color: #8b2252;">"element_id"</span>)
&#65288;2&#65289;&#36890;&#36807;&#21517;&#31216;&#23450;&#20301;&#20803;&#32032;
element = driver.find_element_by_name(<span style="color: #8b2252;">"element_name"</span>)
&#65288;3&#65289;&#36890;&#36807;&#31867;&#21517;&#23450;&#20301;&#20803;&#32032;
element = driver.find_element_by_class_name(<span style="color: #8b2252;">"class_name"</span>)
&#65288;4&#65289;&#36890;&#36807;&#26631;&#31614;&#21517;&#23450;&#20301;&#20803;&#32032;
element = driver.find_element_by_tag_name(<span style="color: #8b2252;">"tag_name"</span>)
&#65288;5&#65289;&#36890;&#36807;&#38142;&#25509;&#25991;&#26412;&#23450;&#20301;&#20803;&#32032;&#65288;&lt;a&gt; &#26631;&#31614;&#65289;
element = driver.find_element_by_link_text(<span style="color: #8b2252;">"link_text"</span>)
&#65288;6&#65289;&#36890;&#36807;&#37096;&#20998;&#38142;&#25509;&#25991;&#26412;&#23450;&#20301;&#20803;&#32032;&#65288;&lt;a&gt; &#26631;&#31614;&#65289;
element = driver.find_element_by_partial_link_text(<span style="color: #8b2252;">"partial_link_text"</span>)
&#65288;7&#65289;&#36890;&#36807;XPath&#23450;&#20301;&#20803;&#32032;
element = driver.find_element_by_xpath(<span style="color: #8b2252;">"xpath_expression"</span>)
&#65288;8&#65289;&#36890;&#36807;CSS&#36873;&#25321;&#22120;&#23450;&#20301;&#20803;&#32032;
element = driver.find_element_by_css_selector(<span style="color: #8b2252;">"css_selector"</span>)
&#19978;&#38754;&#37117;&#26159;&#33719;&#21462;&#21333;&#20010;&#20803;&#32032;&#65292;&#35201;&#33719;&#21462;&#22810;&#20010;&#20803;&#32032;&#65292;&#23558;&#20854;&#20013;&#30340;element&#20462;&#25913;&#20026;elements&#21363;&#21487;&#12290;
</pre>
</div>

<p>
Selenium4.x版本后
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20803;&#32032;&#30340;&#23450;&#20301;&#19981;&#20877;&#26159;&#19978;&#38754;&#36825;&#31181;&#19968;&#20010;&#31867;&#22411;&#19968;&#20010;&#26041;&#27861;&#30340;&#27169;&#24335;&#65292;&#32780;&#26159;&#21464;&#20026;&#20004;&#20010;&#26041;&#27861;find_element&#21644;find_elements&#65306;
find_element&#26041;&#27861;&#36820;&#22238;&#19968;&#20010;&#20803;&#32032;
ind_elements&#26041;&#27861;&#36820;&#22238;&#19968;&#20010;&#21015;&#34920;

&#36890;&#36807;ID&#36824;&#26159;NAME&#31561;&#33719;&#21462;&#26041;&#24335;&#65292;&#21464;&#20026;&#19968;&#20010;By&#23545;&#35937;&#30340;&#23646;&#24615;&#65292;&#20316;&#20026;&#21442;&#25968;&#20837;&#21442;&#21040;find_element&#21644;find_elements&#26041;&#27861;&#20013;
    ID = <span style="color: #8b2252;">"id"</span>
    XPATH = <span style="color: #8b2252;">"xpath"</span>
    LINK_TEXT = <span style="color: #8b2252;">"link text"</span>
    PARTIAL_LINK_TEXT = <span style="color: #8b2252;">"partial link text"</span>
    NAME = <span style="color: #8b2252;">"name"</span>
    TAG_NAME = <span style="color: #8b2252;">"tag name"</span>
    CLASS_NAME = <span style="color: #8b2252;">"class name"</span>
    CSS_SELECTOR = <span style="color: #8b2252;">"css selector"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;xpath&#36873;&#25321;&#20803;&#32032;(&#19975;&#37329;&#27833;)</span>
<span style="color: #0000ff;">driver.find_element</span>(By.XPATH, <span style="color: #8b2252;">'//*[@id="kw"]'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;css&#36873;&#25321;&#22120;&#36873;&#25321;&#20803;&#32032;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.CSS_SELECTOR, <span style="color: #8b2252;">'#kw'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;name&#23646;&#24615;&#20540;&#36873;&#25321;&#20803;&#32032;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.NAME, <span style="color: #8b2252;">'wd'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#31867;&#21517;&#36873;&#25321;&#20803;&#32032;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.CLASS_NAME, <span style="color: #8b2252;">'s_ipt'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#38142;&#25509;&#25991;&#26412;&#36873;&#25321;&#20803;&#32032;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.LINK_TEXT, <span style="color: #8b2252;">'hao123'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#21253;&#21547;&#25991;&#26412;&#36873;&#25321;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.PARTIAL_LINK_TEXT, <span style="color: #8b2252;">'hao'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#26631;&#31614;&#21517;&#36873;&#25321;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30446;&#26631;&#20803;&#32032;&#22312;&#24403;&#21069;html&#20013;&#26159;&#21807;&#19968;&#26631;&#31614;&#25110;&#20247;&#22810;&#26631;&#31614;&#31532;&#19968;&#20010;&#26102;&#20505;&#20351;&#29992;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.TAG_NAME, <span style="color: #8b2252;">'title'</span>) 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;id&#36873;&#25321;</span>
<span style="color: #0000ff;">driver.find_element</span>(By.ID, <span style="color: #8b2252;">'su'</span>) 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:df1b2590-6ab1-459a-be94-b8f2749fe70e" class="outline-5">
<h5 id="h:df1b2590-6ab1-459a-be94-b8f2749fe70e">元素访问</h5>
<div class="outline-text-5" id="text-h:df1b2590-6ab1-459a-be94-b8f2749fe70e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#20803;&#32032;&#25991;&#26412;</span>
element_text = element.text
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#20803;&#32032;&#23646;&#24615;</span>
attribute_value = element.get_attribute(<span style="color: #8b2252;">"attribute_name"</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#28857;&#20987;&#25805;&#20316;</span>
<span style="color: #0000ff;">element.click</span>()
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;&#25991;&#26412;&#21040;&#36755;&#20837;&#26694;</span>
<span style="color: #0000ff;">element.send_keys</span>(<span style="color: #8b2252;">"text"</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#34920;&#21333;</span>
<span style="color: #0000ff;">element.submit</span>()
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#25442;&#21040;iframe</span>
<span style="color: #0000ff;">driver.switch_to.frame</span>(element)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:868cd524-84d0-4192-8961-d41bdf0118d2" class="outline-4">
<h4 id="h:868cd524-84d0-4192-8961-d41bdf0118d2">交互操作</h4>
<div class="outline-text-4" id="text-h:868cd524-84d0-4192-8961-d41bdf0118d2">
<p>
单击元素
</p>
<ul class="org-ul">
<li>使用click()方法实现单击操作：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
element.click()
</pre>
</div>

<p>
输入内容
</p>
<ul class="org-ul">
<li>使用send_keys()方法实现单击操作：</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
element.send_keys(<span style="color: #8b2252;">"&#35201;&#36755;&#20837;&#30340;&#23383;&#31526;&#20018;"</span>)
</pre>
</div>

<p>
前进和后退操作
</p>
<ul class="org-ul">
<li>使用driver.back()方法实现后退操作，driver.forward()方法实现前进操作：</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">driver</span> = webdriver.Chrome()
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20570;&#20960;&#39033;&#32593;&#32476;&#25805;&#20316;&#65292;&#26368;&#22909;&#26159;&#21487;&#20197;&#21069;&#24448;&#26032;&#39029;&#38754;&#30340;&#25805;&#20316;</span>
driver.back()
driver.forward()
</pre>
</div>

<p>
JS模拟鼠标滚动
</p>
<ul class="org-ul">
<li>使用execute_script()方法实现鼠标滚动：</li>
</ul>

<div class="org-src-container">
<pre class="src src-python">driver.execute_script(<span style="color: #8b2252;">"window.scrollTo(0,document.body.scrollHeight)"</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">JS&#20195;&#30721;&#65292;&#36890;&#36807;&#20462;&#25913;scrollHeight&#30340;&#20540;&#21487;&#20197;&#35843;&#25972;&#28378;&#21160;&#30340;&#20301;&#32622;&#65292;&#22914;&#23558;scrollHeight&#20462;&#25913;&#20026;0&#21017;&#34920;&#31034;&#28378;&#21160;&#33267;&#39029;&#38754;&#39030;&#37096;&#12290;</span>
</pre>
</div>

<p>
获取网页代码
</p>
<ul class="org-ul">
<li>使用 page_source 属性获取当前网页的完整代码：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">page_source</span> = driver.page_source
<span style="color: #483d8b;">print</span>(page_source)
</pre>
</div>

<ul class="org-ul">
<li>获取特定元素的代码片段：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
<span style="color: #a0522d;">element_html</span> = element.get_attribute(<span style="color: #8b2252;">"outerHTML"</span>)
<span style="color: #483d8b;">print</span>(element_html)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#25351;&#23450;&#20803;&#32032;&#30340;HTML&#20195;&#30721;&#29255;&#27573;&#65292;&#21253;&#25324;&#20803;&#32032;&#26412;&#36523;&#21450;&#20854;&#25152;&#26377;&#23376;&#20803;&#32032;</span>
</pre>
</div>

<p>
获取当前网页的 URL
</p>
<ul class="org-ul">
<li>使用current_url属性获取当前网页的 URL：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">url</span> = driver.current_url
<span style="color: #483d8b;">print</span>(url)
</pre>
</div>

<p>
右键单击元素
</p>
<ul class="org-ul">
<li>使用context_click()方法实现右键单击操作：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
ActionChains(driver).context_click(element).perform()
</pre>
</div>

<p>
悬停在元素上
</p>
<ul class="org-ul">
<li>使用move_to_element()方法实现悬停操作：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
ActionChains(driver).move_to_element(element).perform()
</pre>
</div>

<p>
元素拖放
</p>
<ul class="org-ul">
<li>使用drag_and_drop()方法实现元素拖放操作：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">source_element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
<span style="color: #a0522d;">target_element</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>)
ActionChains(driver).drag_and_drop(source_element, target_element).perform()
</pre>
</div>

<p>
等待操作完成
</p>
<ul class="org-ul">
<li>使用显式等待（Explicit Wait）机制等待特定条件达成：</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium.webdriver.support.ui <span style="color: #a020f0;">import</span> WebDriverWait
<span style="color: #a020f0;">from</span> selenium.webdriver.support <span style="color: #a020f0;">import</span> expected_conditions <span style="color: #a020f0;">as</span> EC

<span style="color: #a0522d;">element</span> = WebDriverWait(driver, 10).until(
    EC.presence_of_element_located((By.XPATH, <span style="color: #8b2252;">'xpath_expression'</span>))
)
&#20195;&#30721;&#35828;&#26126;&#65306;
WebDriverWait&#31867;&#29992;&#20110;&#35774;&#32622;&#26368;&#38271;&#31561;&#24453;&#26102;&#38388;&#65292;&#24182;&#25552;&#20379;&#20102;&#22810;&#31181;&#26465;&#20214;&#26469;&#31561;&#24453;&#29305;&#23450;&#26465;&#20214;&#36798;&#25104;&#12290;
EC.presence_of_element_located()&#26159;&#19968;&#20010;&#39044;&#23450;&#20041;&#30340;&#26465;&#20214;&#65292;&#29992;&#20110;&#31561;&#24453;&#20803;&#32032;&#20986;&#29616;&#22312;&#39029;&#38754;&#20013;&#12290;
</pre>
</div>
<ul class="org-ul">
<li>使用隐式等待（Implicit Wait）机制等待特定时间段：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python">driver.implicitly_wait(10)
</pre>
</div>

<p>
异步加载页面的处理
</p>
<ul class="org-ul">
<li>使用page_load_timeout属性设置页面加载超时时间：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python">driver.set_page_load_timeout(10)
&#22914;&#26524;&#39029;&#38754;&#22312;&#25351;&#23450;&#26102;&#38388;&#20869;&#26410;&#23436;&#20840;&#21152;&#36733;&#23436;&#25104;&#65292;&#23558;&#25243;&#20986;TimeoutException&#24322;&#24120;&#12290;
</pre>
</div>

<ul class="org-ul">
<li>使用execute_script()方法判断页面是否加载完成：</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">is_page_loaded</span> = driver.execute_script(<span style="color: #8b2252;">"return document.readyState"</span>) == <span style="color: #8b2252;">"complete"</span>
</pre>
</div>

<p>
关闭网页
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;close()&#26041;&#27861;&#20851;&#38381;&#24403;&#21069;&#31383;&#21475;&#65306;</span>
driver.close()
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;quit()&#26041;&#27861;&#36864;&#20986;&#25972;&#20010;&#27983;&#35272;&#22120;&#20250;&#35805;&#65306;</span>
driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:27366c3c-4cbc-4e34-899a-70de184213b6" class="outline-3">
<h3 id="h:27366c3c-4cbc-4e34-899a-70de184213b6">开发实战</h3>
<div class="outline-text-3" id="text-h:27366c3c-4cbc-4e34-899a-70de184213b6">
<ul class="org-ul">
<li>不同浏览器都会提供操作的接口，Selenium就是使用这些接口来操作浏览器</li>
<li>Selenium最核心的对象就是webdriver，通过它就可以操作浏览器、截图、HTTP访问、解析HTML等</li>
</ul>

<p>
注意：从Selenium 4开始，PhantomJS被废弃了，建议使用基于Chrome的Headless模式代替。
</p>
</div>
<div id="outline-container-h:139433f1-d9a4-4026-a125-556a3ced6348" class="outline-4">
<h4 id="h:139433f1-d9a4-4026-a125-556a3ced6348">处理异步请求</h4>
<div class="outline-text-4" id="text-h:139433f1-d9a4-4026-a125-556a3ced6348">
<p>
Chrome Headless是一个无界面的浏览器环境，它是Google Chrome浏览器在59版本之后新增的一种运行模式。与传统的浏览器不同，Chrome Headless可以在后台执行网页操作，而无需显示可见的用户界面。
</p>

<p>
它更轻量级，节省了系统资源，并且执行速度更快。其次，它稳定性高，不受弹窗、广告或其他干扰因素的影响。
</p>

<p>
bing/baidu的查询结果是通过异步请求返回结果，所以，直接访问页面不能直接获取到搜索结果
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver
<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #a020f0;">from</span> selenium.webdriver.chrome.options <span style="color: #a020f0;">import</span> Options
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;ChromeOptions&#23545;&#35937;&#65292;&#37197;&#32622;Chrome Headless&#36873;&#39033;</span>
<span style="color: #a0522d;">options</span> = webdriver.ChromeOptions()
options.add_argument(<span style="color: #8b2252;">'--headless'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Chrome&#20026;Headless&#27169;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">options.add_argument("--disable-gpu")  # &#31105;&#29992;GPU&#21152;&#36895;</span>

<span style="color: #a0522d;">driver</span> = webdriver.Chrome(options=options)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1280, 1924)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_path</span> = <span style="color: #8b2252;">'d:/tmp/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_path,datetime.datetime.now(),random.randint(1, 100)
    )
    driver.save_screenshot(filename)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#32593;&#39029;GET&#26041;&#27861;&#65292;&#27169;&#25311;&#27983;&#35272;&#22120;&#22320;&#22336;&#26639;&#36755;&#20837;&#32593;&#22336;</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.baidu.com/s?'</span> + parse.urlencode({
    <span style="color: #8b2252;">'wd'</span>: <span style="color: #8b2252;">'python'</span>
})
driver.get(url)
<span style="color: #483d8b;">print</span>(url) <span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.baidu.com/s?wd=python</span>

time.sleep(1)
savepic()

<span style="color: #a0522d;">MAXRETRIES</span> = 6 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#23581;&#35797;&#27425;&#25968;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(MAXRETRIES):
    time.sleep(4)
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">ele</span> = driver.find_element(By.ID,  <span style="color: #8b2252;">'content_left'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#26597;&#35810;&#32467;&#26524;&#26469;&#20102;&#65292;&#23601;&#20250;&#26377;&#36825;&#20010;id&#30340;&#26631;&#31614;</span>
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> ele.is_displayed(): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#24453;&#25968;&#25454;&#26174;&#31034;&#20986;&#26469;</span>
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'display none'</span>)
            <span style="color: #a020f0;">continue</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'displayed'</span>)
        savepic()
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(e)

driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
PhantomJS
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;bing&#26597;&#35810;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26680;&#24515;&#23545;&#35937;</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;PhantomJS&#30340;&#25191;&#34892;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #a0522d;">driver</span> = webdriver.PhantomJS(<span style="color: #8b2252;">'d:/python/phantomjs/bin/phantomjs.exe'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1280, 1024)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#32593;&#39029;GET&#26041;&#27861;&#65292;&#27169;&#25311;&#27983;&#35272;&#22120;&#22320;&#22336;&#26639;&#36755;&#20837;&#32593;&#22336;</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'http://www.bing.com/search?'</span> + parse.urlencode({
    <span style="color: #8b2252;">'q'</span>: <span style="color: #8b2252;">'python'</span>
})
driver.get(url)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_dir</span> = <span style="color: #8b2252;">'d:/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_dir,
        datetime.datetime.now(),
        random.randint(1, 100)
    )

    driver.save_screenshot(filename)

<span style="color: #b22222;">#</span><span style="color: #b22222;">time.sleep(10) # &#31561;&#31561;&#25130;&#22270;&#23601;&#33021;&#30475;&#21040;&#20869;&#23481;</span>
savepic()

<span style="color: #a0522d;">MAXRETRIES</span> = 5 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#37325;&#35797;&#27425;&#25968;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(MAXRETRIES):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24490;&#29615;&#27979;&#35797;</span>
    time.sleep(1)
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">ele</span> = driver.find_element_by_id(<span style="color: #8b2252;">'b_results'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#26597;&#35810;&#32467;&#26524;&#26469;&#20102;&#65292;&#23601;&#20250;&#26377;&#36825;&#20010;id&#30340;&#26631;&#31614;</span>
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> ele.is_displayed():  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#24453;&#25968;&#25454;&#26174;&#31034;&#20986;&#26469;</span>
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'diplay none'</span>)
            <span style="color: #a020f0;">continue</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'ok'</span>)
        savepic()
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(e)

driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
可能结果未必能看到，说明数据回来了，而且组织好了，但是没有显示出来
</p>

<p>
可以增加判断元素是否显示的代码，直到等待的数据呈现在页面上
</p>
</div>
</div>
<div id="outline-container-h:a1fc509e-3ba1-4781-adbf-33dff534e3e8" class="outline-4">
<h4 id="h:a1fc509e-3ba1-4781-adbf-33dff534e3e8">下拉框处理</h4>
<div class="outline-text-4" id="text-h:a1fc509e-3ba1-4781-adbf-33dff534e3e8">
<p>
了解即可。
</p>

<p>
Selenium专门提供了Select类来处理网页中的下拉框
</p>

<p>
不过下拉框用的页面越来越少了,本次使用 <a href="https://www.oschina.net/search?scope=project&amp;q=python">https://www.oschina.net/search?scope=project&amp;q=python</a>
</p>

<div class="org-src-container">
<pre class="src src-html"># oschina&#36719;&#20214;&#25628;&#32034;
&lt;<span style="color: #0000ff;">select</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'tag1'</span> <span style="color: #a0522d;">onchange</span>=<span style="color: #8b2252;">"submit();"</span>&gt;
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'0'</span>&gt;&#25152;&#26377;&#20998;&#31867;&lt;/<span style="color: #0000ff;">option</span>&gt;
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'309'</span> &gt;Web&#24212;&#29992;&#24320;&#21457;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'331'</span> &gt;&#25163;&#26426;/&#31227;&#21160;&#24320;&#21457;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'364'</span> &gt;iOS&#20195;&#30721;&#24211;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'12'</span> &gt;&#31243;&#24207;&#24320;&#21457;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'11'</span> &gt;&#24320;&#21457;&#24037;&#20855;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'273'</span> &gt;jQuery &#25554;&#20214;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'256'</span> &gt;&#24314;&#31449;&#31995;&#32479;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'5'</span> &gt;&#20225;&#19994;&#24212;&#29992;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'10'</span> &gt;&#26381;&#21153;&#22120;&#36719;&#20214;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'6'</span> &gt;&#25968;&#25454;&#24211;&#30456;&#20851;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'8'</span> &gt;&#24212;&#29992;&#24037;&#20855;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'18'</span> &gt;&#25554;&#20214;&#21644;&#25193;&#23637;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'7'</span> &gt;&#28216;&#25103;/&#23089;&#20048;&lt;/<span style="color: #0000ff;">option</span>&gt;
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'14'</span> &gt;&#31649;&#29702;&#21644;&#30417;&#25511;&lt;/<span style="color: #0000ff;">option</span>&gt; 
    &lt;<span style="color: #0000ff;">option</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">'9'</span> &gt;&#20854;&#20182;&#24320;&#28304;&lt;/<span style="color: #0000ff;">option</span>&gt;
&lt;/<span style="color: #0000ff;">select</span>&gt;
</pre>
</div>

<p>
这个下拉框影响下一个下拉框“所有子类”。下面就模拟来操作下拉框，需要使用
selenium.webdriver.support.select.Select
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26680;&#24515;&#23545;&#35937;</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">from</span> selenium.webdriver.support.ui <span style="color: #a020f0;">import</span> Select

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;PhantomJS&#30340;&#25191;&#34892;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #a0522d;">driver</span> = webdriver.PhantomJS(<span style="color: #8b2252;">'d:/python/phantomjs/bin/phantomjs.exe'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1280, 1024)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_dir</span> = <span style="color: #8b2252;">'d:/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_dir,
        datetime.datetime.now(),
        random.randint(1, 100)
    )

    driver.save_screenshot(filename)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#32593;&#39029;GET&#26041;&#27861;&#65292;&#27169;&#25311;&#27983;&#35272;&#22120;&#22320;&#22336;&#26639;&#36755;&#20837;&#32593;&#22336;</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.oschina.net/search?q=python&amp;scope=project'</span>
driver.get(url)

<span style="color: #a0522d;">ele</span> = driver.find_element_by_name(<span style="color: #8b2252;">'tag1'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#20803;&#32032;</span>
<span style="color: #483d8b;">print</span>(ele.tag_name) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26631;&#31614;&#21517;</span>
<span style="color: #483d8b;">print</span>(driver.current_url) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;url</span>
savepic()

<span style="color: #a0522d;">s</span> = Select(ele)
<span style="color: #b22222;">#</span><span style="color: #b22222;">s.select_by_index(1)</span>
s.select_by_value(<span style="color: #8b2252;">'309'</span>)
<span style="color: #483d8b;">print</span>(driver.current_url) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#39029;&#38754;</span>
savepic()

driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
由于该网页改版，舍弃了select，无法测试。
</p>
</div>
</div>
<div id="outline-container-h:a7a9142e-7cd3-4481-8698-4910272569a0" class="outline-4">
<h4 id="h:a7a9142e-7cd3-4481-8698-4910272569a0">模拟键盘操作（模拟登录）</h4>
<div class="outline-text-4" id="text-h:a7a9142e-7cd3-4481-8698-4910272569a0">
<p>
webdriver提供了一些列find方法，用户获取一个网页中的元素。元素对象可以使用send_keys模拟键盘输入
</p>

<p>
oschina的登录页，登录成功后会跳转到首页，首页右上角会显示会员信息，如果未登录，无此信息
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver
<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #a020f0;">from</span> selenium.webdriver.common.keys <span style="color: #a020f0;">import</span> Keys
<span style="color: #a020f0;">from</span> selenium.webdriver.chrome.options <span style="color: #a020f0;">import</span> Options
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;ChromeOptions&#23545;&#35937;&#65292;&#37197;&#32622;Chrome Headless&#36873;&#39033;</span>
<span style="color: #a0522d;">options</span> = webdriver.ChromeOptions()
options.add_argument(<span style="color: #8b2252;">'--headless'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Chrome&#20026;Headless&#27169;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">options.add_argument("--disable-gpu")  # &#31105;&#29992;GPU&#21152;&#36895;</span>

<span style="color: #a0522d;">driver</span> = webdriver.Chrome(options=options)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1920, 1080)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_path</span> = <span style="color: #8b2252;">'d:/tmp/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_path,datetime.datetime.now(),random.randint(1, 100)
    )
    driver.save_screenshot(filename)

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.oschina.net/'</span>
driver.get(url)
savepic()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28857;&#20987;&#30331;&#24405;&#39029;</span>
<span style="color: #a0522d;">login_button</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'//div[@class="user-bar"]/ul/a'</span>)
<span style="color: #483d8b;">print</span>(login_button.get_attribute(<span style="color: #8b2252;">'href'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#23646;&#24615;&#20540;</span>
login_button.click() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28857;&#20987;&#20803;&#32032;</span>
<span style="color: #483d8b;">print</span>(driver.current_url) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;url</span>
savepic()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30331;&#24405;&#39029;&#65292;&#20999;&#25442;&#26631;&#31614;&#39029;</span>
<span style="color: #a0522d;">tab</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'//div[@data-osc-tab="password"]'</span>)
tab.click()
savepic()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#25143;&#21517;&#21644;&#23494;&#30721;</span>
<span style="color: #a0522d;">username</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'//input[@name="username"]'</span>)
<span style="color: #a0522d;">password</span> = driver.find_element(By.XPATH, <span style="color: #8b2252;">'//input[@name="password"]'</span>)
username.send_keys(<span style="color: #8b2252;">'1xxxx'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20837;&#29992;&#25143;&#21517;</span>
password.send_keys(<span style="color: #8b2252;">'1xxxx'</span>)
savepic()

password.send_keys(Keys.ENTER) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#38190;&#30424;&#25970;&#20987;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773;&#21512;&#24182; password.send_keys('1xxxx', Keys.ENTER)</span>
time.sleep(5) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#24453;2&#31186;</span>
<span style="color: #483d8b;">print</span>(driver.current_url)
savepic()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#30331;&#24405;&#21518;&#33719;&#24471;cookies</span>
<span style="color: #a0522d;">cookies</span> = driver.get_cookies()
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(cookies), cookies)
<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> cookies:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(c), c)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#35831;&#27714;</span>
<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> requests.cookies <span style="color: #a020f0;">import</span> RequestsCookieJar

<span style="color: #b22222;"># </span><span style="color: #b22222;">cookies = [</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">{'domain': '.oschina.net', 'httpOnly': False, 'name': 'Hm_lpvt_a411c4d1664dd70048ee98afe7b28f0b', 'path': '/',</span>
<span style="color: #b22222;">#      </span><span style="color: #b22222;">'sameSite': 'Lax', 'secure': False, 'value': '1757401509'},</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">{'domain': '.oschina.net', 'expiry': 1788937508, 'httpOnly': True, 'name': 'oscid', 'path': '/', 'sameSite': 'Lax',</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">'secure': False,</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">'value': 'H1%2FKYVEN1WFHSFPDrSA9WFqLGKWIss6348jpkpX6ZA9DObORyc2LnhWySW0ENLj4GqXLr%2FTP6VOvr9IfJ5TwnVBG3CBGsEj5KmkZ5du2cqfS2%2FTtQ4Nrpbczj4EkvwhjZw9Cxw8hQktrhwfqZTVm0w%3D%3D'},</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">]</span>

<span style="color: #a0522d;">headers</span> = {
    <span style="color: #8b2252;">'referer'</span>:<span style="color: #8b2252;">'https://www.oschina.net/'</span>,
    <span style="color: #8b2252;">'User-agent'</span>:<span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36"</span>
}

<span style="color: #a0522d;">jar</span> = RequestsCookieJar()
<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> cookies:
    jar.<span style="color: #483d8b;">set</span>(c.get(<span style="color: #8b2252;">'name'</span>), c.get(<span style="color: #8b2252;">'value'</span>))

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.oschina.net/'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#24102;cookie</span>
<span style="color: #a020f0;">with</span> requests.get(url, headers=headers) <span style="color: #a020f0;">as</span> response:
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/nocookies.html'</span>, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.content)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24102;cookie</span>
<span style="color: #a020f0;">with</span> requests.get(url, headers=headers, cookies=jar) <span style="color: #a020f0;">as</span> response:
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/cookies.html'</span>, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.content)

driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
PhantomJS
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#24320;&#28304;&#20013;&#22269;&#30331;&#38470;</span>
<span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26680;&#24515;&#23545;&#35937;</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> selenium.webdriver.common.keys <span style="color: #a020f0;">import</span> Keys

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;PhantomJS&#30340;&#25191;&#34892;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #a0522d;">driver</span> = webdriver.PhantomJS(<span style="color: #8b2252;">'d:/python/phantomjs/bin/phantomjs.exe'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1280, 1024)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_dir</span> = <span style="color: #8b2252;">'d:/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_dir,
        datetime.datetime.now(),
        random.randint(1, 100)
    )

    driver.save_screenshot(filename)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#32593;&#39029;GET&#26041;&#27861;&#65292;&#27169;&#25311;&#27983;&#35272;&#22120;&#22320;&#22336;&#26639;&#36755;&#20837;&#32593;&#22336;</span>
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.oschina.net/home/login'</span>
driver.get(url)
<span style="color: #483d8b;">print</span>(driver.current_url) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;url</span>
savepic()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#36755;&#20837;&#29992;&#25143;&#21517;&#23494;&#30721;</span>
<span style="color: #a0522d;">username</span> = driver.find_element_by_id(<span style="color: #8b2252;">'userMail'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#20803;&#32032;</span>
username.send_keys(<span style="color: #8b2252;">'ja@cici.com'</span>)
<span style="color: #a0522d;">password</span> = driver.find_element_by_id(<span style="color: #8b2252;">'userPassword'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#20803;&#32032;</span>
password.send_keys(<span style="color: #8b2252;">'cici.com18'</span>)
savepic()

password.send_keys(Keys.ENTER)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    time.sleep(1)
    <span style="color: #a020f0;">try</span>:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath&#23450;&#20301;&#25968;&#25454;</span>
        <span style="color: #a0522d;">ele</span> = driver.find_element_by_xpath(<span style="color: #8b2252;">'//div[@title="cici_wayne"]'</span>)
        <span style="color: #483d8b;">print</span>(ele.tag_name, <span style="color: #8b2252;">'!~~~~~~'</span>)
        <span style="color: #483d8b;">print</span>(ele.get_attribute(<span style="color: #8b2252;">'data-user-id'</span>))
        savepic()
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(e)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#30331;&#24405;&#21518;&#33719;&#24471;cookies</span>
<span style="color: #a0522d;">cookies</span> = driver.get_cookies()
<span style="color: #483d8b;">print</span>(cookies)

<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> cookies:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(c))
    <span style="color: #483d8b;">print</span>(c)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">from</span> requests.cookies <span style="color: #a020f0;">import</span> RequestsCookieJar

<span style="color: #a0522d;">jar</span> = RequestsCookieJar()
<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> cookies:
    jar.<span style="color: #483d8b;">set</span>(c.get(<span style="color: #8b2252;">'name'</span>), c.get(<span style="color: #8b2252;">'value'</span>))

<span style="color: #483d8b;">print</span>(jar)

<span style="color: #a0522d;">headers</span> = {<span style="color: #8b2252;">'User-agent'</span>: <span style="color: #8b2252;">"Mozilla/5.0 (Windows; U; "</span>
<span style="color: #8b2252;">"Windows NT 6.1; zh-CN) AppleWebKit/537.36(KHTML, like Gecko) Version / 5.0.1Safari / 537.36"</span>}

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'========== &#19981;&#24102;cookie =========='</span>)
<span style="color: #a0522d;">response</span> = requests.get(url, headers=headers)
<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(10, response.url)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#23601;&#26159;&#30331;&#24405;&#39029;</span>
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/nocookie.html'</span>, <span style="color: #8b2252;">'w'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.text)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'========== &#24102;cookie =========='</span>)
<span style="color: #a0522d;">response</span> = requests.get(url, headers=headers, cookies=jar)
<span style="color: #a020f0;">with</span> response:
    <span style="color: #483d8b;">print</span>(11, response.url)
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/withcookie.html'</span>, <span style="color: #8b2252;">'w'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(response.text)

driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:31ae2822-7d51-44b6-8461-ee1ebdcaad77" class="outline-4">
<h4 id="h:31ae2822-7d51-44b6-8461-ee1ebdcaad77">页面等待</h4>
<div class="outline-text-4" id="text-h:31ae2822-7d51-44b6-8461-ee1ebdcaad77">
<p>
越来越多的页面使用Ajax这样的异步加载技术，这就会导致代码中要访问的页面元素，还没有被加载就被访问了，抛出异常。
</p>
</div>
<div id="outline-container-h:f823fe12-8581-43a6-afd5-09e1b0c8c11d" class="outline-5">
<h5 id="h:f823fe12-8581-43a6-afd5-09e1b0c8c11d">方法1 线程休眠</h5>
<div class="outline-text-5" id="text-h:f823fe12-8581-43a6-afd5-09e1b0c8c11d">
<p>
使用time.sleep(n)来等待数据加载
</p>

<p>
配合循环一直等到数据被加载完成，可以解决很多页面动态加载或加载慢的问题。当然可以设置一个最大重试次数，以免一直循环下去。参看本文“处理异步请求”
</p>
</div>
</div>
<div id="outline-container-h:0b265b5c-a2f5-4c42-862d-dbd319b3b127" class="outline-5">
<h5 id="h:0b265b5c-a2f5-4c42-862d-dbd319b3b127">方法2 Selenium等待</h5>
<div class="outline-text-5" id="text-h:0b265b5c-a2f5-4c42-862d-dbd319b3b127">
<p>
Selenium的等待分为：显示等待和隐式等待
</p>

<ul class="org-ul">
<li>隐式等待，等待特定的时间</li>
<li>显式等待，指定一个条件，一直等到这个条件成立后继续执行，也可以设置超时时间，超时会抛异常</li>
</ul>

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://www.selenium.dev/zh-cn/documentation/webdriver/waits/">https://www.selenium.dev/zh-cn/documentation/webdriver/waits/</a></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:9b58329b-6c00-403a-b27e-390b3b1d5c77"></a>显示等待<br>
<div class="outline-text-6" id="text-h:9b58329b-6c00-403a-b27e-390b3b1d5c77">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver
<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #a020f0;">from</span> selenium.webdriver.common.keys <span style="color: #a020f0;">import</span> Keys
<span style="color: #a020f0;">from</span> selenium.webdriver.support.wait <span style="color: #a020f0;">import</span> WebDriverWait
<span style="color: #a020f0;">from</span> selenium.webdriver.support <span style="color: #a020f0;">import</span> expected_conditions <span style="color: #a020f0;">as</span> EC
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;ChromeOptions&#23545;&#35937;&#65292;&#37197;&#32622;Chrome Headless&#36873;&#39033;</span>
<span style="color: #a0522d;">options</span> = webdriver.ChromeOptions()
options.add_argument(<span style="color: #8b2252;">'--headless'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Chrome&#20026;Headless&#27169;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">options.add_argument("--disable-gpu")  # &#31105;&#29992;GPU&#21152;&#36895;</span>

<span style="color: #a0522d;">driver</span> = webdriver.Chrome(options=options)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1920, 1080)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_path</span> = <span style="color: #8b2252;">'d:/tmp/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_path,datetime.datetime.now(),random.randint(1, 100)
    )
    driver.save_screenshot(filename)

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.baidu.com/s?'</span> + parse.urlencode({
    <span style="color: #8b2252;">'wd'</span>: <span style="color: #8b2252;">'python'</span>
})
driver.get(url)
<span style="color: #483d8b;">print</span>(url) <span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.baidu.com/s?wd=python</span>
savepic()

<span style="color: #a020f0;">try</span>:
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
    WebDriverWait(driver, timeout=5).until(
        <span style="color: #a020f0;">lambda</span> d: d.find_element(By.ID, <span style="color: #8b2252;">'content_left'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#20010;&#20803;&#32032;&#20182;&#22312;&#65292;&#20294;&#36824;&#27809;&#26469;&#24471;&#21450;&#26174;&#31034;</span>
    )
    savepic()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span>*30)
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
<span style="color: #a020f0;">finally</span>:
    driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
上面代码还没有显示出来内容。所以可以在until中加入条件
</p>

<p>
Expected Conditions: <a href="https://www.selenium.dev/documentation/webdriver/support_features/expected_conditions/">https://www.selenium.dev/documentation/webdriver/support_features/expected_conditions/</a>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">expected_conditionsn内置条件</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">title_is</td>
<td class="org-left">判断当前页面的title是否精确等于预期</td>
</tr>

<tr>
<td class="org-left">title_contains</td>
<td class="org-left">判断当前页面的title是否包含预期字符串</td>
</tr>

<tr>
<td class="org-left"><b>presence_of_element_located</b></td>
<td class="org-left">判断某个元素是否被加到了dom树里，并不代表该元素一定可见</td>
</tr>

<tr>
<td class="org-left"><b>visibility_of_element_located</b></td>
<td class="org-left">判断某个元素是否可见。可见代表元素非隐藏，并且元素的宽和高都不等于0</td>
</tr>

<tr>
<td class="org-left">visibility_of</td>
<td class="org-left">跟上面的方法做一样的事情，只是上面的方法要传入locator，这个方法直接传定位到的element就好了</td>
</tr>

<tr>
<td class="org-left">presence_of_all_elements_located</td>
<td class="org-left">判断是否至少有1个元素存在于dom树中。举个例子，如果页面上有n个元素的class都是’column-md-3’，那么只要有1个元素存在，这个方法就返回True</td>
</tr>

<tr>
<td class="org-left">text_to_be_present_in_element</td>
<td class="org-left">判断某个元素中的text是否包含了预期的字符串</td>
</tr>

<tr>
<td class="org-left">text_to_be_present_in_element_value</td>
<td class="org-left">判断某个元素中的value属性是否包含了预期的字符串</td>
</tr>

<tr>
<td class="org-left">frame_to_be_available_and_switch_to_it</td>
<td class="org-left">判断该frame是否可以switch进去，如果可以的话，返回True并且switch进去，否则返回False</td>
</tr>

<tr>
<td class="org-left">invisibility_of_element_located</td>
<td class="org-left">判断某个元素中是否不存在于dom树或不可见</td>
</tr>

<tr>
<td class="org-left">element_to_be_clickable</td>
<td class="org-left">判断某个元素中是否可见并且是enable的，这样的话才叫clickable</td>
</tr>

<tr>
<td class="org-left">staleness_of</td>
<td class="org-left">等某个元素从dom树中移除，注意，这个方法也是返回True或False</td>
</tr>

<tr>
<td class="org-left">element_to_be_selected</td>
<td class="org-left">判断某个元素是否被选中了,一般用在下拉列表</td>
</tr>

<tr>
<td class="org-left">element_selection_state_to_be</td>
<td class="org-left">判断某个元素的选中状态是否符合预期</td>
</tr>

<tr>
<td class="org-left">element_located_selection_state_to_be</td>
<td class="org-left">跟上面的方法作用一样，只是上面的方法传入定位到的element，而这个方法传入locator</td>
</tr>

<tr>
<td class="org-left">alert_is_present</td>
<td class="org-left">判断页面上是否存在alert</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver
<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #a020f0;">from</span> selenium.webdriver.common.keys <span style="color: #a020f0;">import</span> Keys
<span style="color: #a020f0;">from</span> selenium.webdriver.support.wait <span style="color: #a020f0;">import</span> WebDriverWait
<span style="color: #a020f0;">from</span> selenium.webdriver.support <span style="color: #a020f0;">import</span> expected_conditions <span style="color: #a020f0;">as</span> EC
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;ChromeOptions&#23545;&#35937;&#65292;&#37197;&#32622;Chrome Headless&#36873;&#39033;</span>
<span style="color: #a0522d;">options</span> = webdriver.ChromeOptions()
options.add_argument(<span style="color: #8b2252;">'--headless'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Chrome&#20026;Headless&#27169;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">options.add_argument("--disable-gpu")  # &#31105;&#29992;GPU&#21152;&#36895;</span>

<span style="color: #a0522d;">driver</span> = webdriver.Chrome(options=options)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1920, 1080)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_path</span> = <span style="color: #8b2252;">'d:/tmp/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}-{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_path,datetime.datetime.now(),random.randint(1, 100)
    )
    driver.save_screenshot(filename)

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.baidu.com/s?'</span> + parse.urlencode({
    <span style="color: #8b2252;">'wd'</span>: <span style="color: #8b2252;">'python'</span>
})
driver.get(url)
<span style="color: #483d8b;">print</span>(url) <span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.baidu.com/s?wd=python</span>
savepic()

<span style="color: #a020f0;">try</span>:
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
    WebDriverWait(driver, timeout=5).until(
        <span style="color: #b22222;"># </span><span style="color: #b22222;">lambda d: d.find_element(By.ID, 'content_left') # &#36825;&#20010;&#20803;&#32032;&#20182;&#22312;&#65292;&#20294;&#36824;&#27809;&#26469;&#24471;&#21450;&#26174;&#31034;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">EC.presence_of_element_located((By.ID, 'content_left')) # &#21512;&#19978;&#38754;&#25928;&#26524;&#19968;&#26679;</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">lambda d: d.find_element(By.ID, 'content_left').is_displayed()</span>
        EC.visibility_of_element_located((By.ID, <span style="color: #8b2252;">'content_left'</span>))
    )
    savepic()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span>*30)
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
<span style="color: #a020f0;">finally</span>:
    driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
PhantomJS
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20301;&#25628;&#32034;&#26694;&#65292;&#25628;&#32034;&#30005;&#24433;</span>
<span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26680;&#24515;&#23545;&#35937;</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random

<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38190;&#30424;&#25805;&#20316;</span>
<span style="color: #a020f0;">from</span> selenium.webdriver.common.keys <span style="color: #a020f0;">import</span> Keys
<span style="color: #b22222;"># </span><span style="color: #b22222;">WebDriverWait &#36127;&#36131;&#24490;&#29615;&#31561;&#24453;</span>
<span style="color: #a020f0;">from</span> selenium.webdriver.support.wait <span style="color: #a020f0;">import</span> WebDriverWait
<span style="color: #b22222;"># </span><span style="color: #b22222;">expected_conditions&#26465;&#20214;&#65292;&#36127;&#36131;&#26465;&#20214;&#35302;&#21457;</span>
<span style="color: #a020f0;">from</span> selenium.webdriver.support <span style="color: #a020f0;">import</span> expected_conditions <span style="color: #a020f0;">as</span> EC


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;PhantomJS&#30340;&#25191;&#34892;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #a0522d;">driver</span> = webdriver.PhantomJS(<span style="color: #8b2252;">'d:/python/phantomjs/bin/phantomjs.exe'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1280, 1024)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_dir</span> = <span style="color: #8b2252;">'d:/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_dir,
        datetime.datetime.now(),
        random.randint(1, 100)
    )

    driver.save_screenshot(filename)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#32593;&#39029;GET&#26041;&#27861;&#65292;&#27169;&#25311;&#27983;&#35272;&#22120;&#22320;&#22336;&#26639;&#36755;&#20837;&#32593;&#22336;</span>
<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #a020f0;">from</span> selenium.webdriver.support.ui <span style="color: #a020f0;">import</span> WebDriverWait <span style="color: #b22222;"># </span><span style="color: #b22222;">available since 2.4.0</span>
<span style="color: #a020f0;">from</span> selenium.webdriver.support <span style="color: #a020f0;">import</span> expected_conditions <span style="color: #a020f0;">as</span> EC <span style="color: #b22222;"># </span><span style="color: #b22222;">available since 2.26.0</span>

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'http://cn.bing.com/search?q=douban+TRON'</span>
driver.get(url)
<span style="color: #483d8b;">print</span>(url)
<span style="color: #483d8b;">print</span>(driver.current_url) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;url</span>

<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">ele</span> = WebDriverWait(driver, 20).until(

        EC.visibility_of_element_located(
            (By.ID, <span style="color: #8b2252;">"b_results"</span>)
        )
    )

    savepic()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
<span style="color: #a020f0;">finally</span>:
    driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
默认的查看频率是0.5秒每次，当元素存在则立即返回这个元素。
</p>

<p>
上面代码发现看到的还是一片空白，所以要使用另外一个条件visibility_of_element_located
</p>
<div class="org-src-container">
<pre class="src src-python">EC.visibility_of_element_located((By.ID, <span style="color: #8b2252;">'content_left'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20803;&#32452;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:49f76dfc-9d16-4579-a30e-291a74836840"></a>隐式等待<br>
<div class="outline-text-6" id="text-h:49f76dfc-9d16-4579-a30e-291a74836840">
<p>
如果出现No Such Element Exception，则智能的等待指定的时长。缺省值是0
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver
<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By
<span style="color: #a020f0;">from</span> selenium.webdriver.common.keys <span style="color: #a020f0;">import</span> Keys
<span style="color: #a020f0;">from</span> selenium.webdriver.support.wait <span style="color: #a020f0;">import</span> WebDriverWait
<span style="color: #a020f0;">from</span> selenium.webdriver.support <span style="color: #a020f0;">import</span> expected_conditions <span style="color: #a020f0;">as</span> EC
<span style="color: #a020f0;">from</span> urllib <span style="color: #a020f0;">import</span> parse

<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> time

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;ChromeOptions&#23545;&#35937;&#65292;&#37197;&#32622;Chrome Headless&#36873;&#39033;</span>
<span style="color: #a0522d;">options</span> = webdriver.ChromeOptions()
options.add_argument(<span style="color: #8b2252;">'--headless'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Chrome&#20026;Headless&#27169;&#24335;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">options.add_argument("--disable-gpu")  # &#31105;&#29992;GPU&#21152;&#36895;</span>

<span style="color: #a0522d;">driver</span> = webdriver.Chrome(options=options)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1920, 1080)
driver.implicitly_wait(10) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#19968;&#35774;&#23450;&#38544;&#24335;&#31561;&#24453;&#31186;&#25968;&#65292;&#22914;&#26524;find_element&#25214;&#19981;&#21040;&#65292;&#20250;&#31561;&#24453;10&#31186;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_path</span> = <span style="color: #8b2252;">'d:/tmp/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}-{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_path,datetime.datetime.now(),random.randint(1, 100)
    )
    driver.save_screenshot(filename)

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://www.baidu.com/s?'</span> + parse.urlencode({
    <span style="color: #8b2252;">'wd'</span>: <span style="color: #8b2252;">'python'</span>
})
driver.get(url)
<span style="color: #483d8b;">print</span>(url) <span style="color: #b22222;"># </span><span style="color: #b22222;">https://www.baidu.com/s?wd=python</span>
savepic()

<span style="color: #a020f0;">try</span>:
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">WebDriverWait(driver, timeout=5).until(</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;"># lambda d: d.find_element(By.ID, 'content_left') # &#36825;&#20010;&#20803;&#32032;&#20182;&#22312;&#65292;&#20294;&#36824;&#27809;&#26469;&#24471;&#21450;&#26174;&#31034;</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;"># EC.presence_of_element_located((By.ID, 'content_left')) # &#21512;&#19978;&#38754;&#25928;&#26524;&#19968;&#26679;</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;"># lambda d: d.find_element(By.ID, 'content_left').is_displayed()</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">EC.visibility_of_element_located((By.ID, 'content_left'))</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">)</span>
    <span style="color: #a0522d;">e</span> = driver.find_element(By.ID, <span style="color: #8b2252;">'content_left'</span>)
    <span style="color: #483d8b;">print</span>(e, e.is_displayed())
    savepic()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span>*30)
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
<span style="color: #a020f0;">finally</span>:
    driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<p>
PhantomJS
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20301;&#25628;&#32034;&#26694;&#65292;&#25628;&#32034;&#30005;&#24433;</span>
<span style="color: #a020f0;">from</span> selenium <span style="color: #a020f0;">import</span> webdriver <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26680;&#24515;&#23545;&#35937;</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> random

<span style="color: #a020f0;">from</span> selenium.webdriver.common.by <span style="color: #a020f0;">import</span> By

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;PhantomJS&#30340;&#25191;&#34892;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #a0522d;">driver</span> = webdriver.PhantomJS(<span style="color: #8b2252;">'d:/python/phantomjs/bin/phantomjs.exe'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31383;&#21475;&#22823;&#23567;</span>
driver.set_window_size(1280, 1024)
driver.implicitly_wait(10) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#19968;&#35774;&#23450;&#38544;&#24335;&#31561;&#24453;&#31186;&#25968;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#22270;&#29255;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">savepic</span>():
    <span style="color: #a0522d;">base_dir</span> = <span style="color: #8b2252;">'d:/'</span>
    <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'{}{:%Y%m%d%H%M%S}{:03}.png'</span>.<span style="color: #483d8b;">format</span>(
        base_dir,
        datetime.datetime.now(),
        random.randint(1, 100)
    )

    driver.save_screenshot(filename)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#32593;&#39029;GET&#26041;&#27861;&#65292;&#27169;&#25311;&#27983;&#35272;&#22120;&#22320;&#22336;&#26639;&#36755;&#20837;&#32593;&#22336;</span>

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'http://cn.bing.com/search?q=douban+TRON'</span>
driver.get(url)
<span style="color: #483d8b;">print</span>(url)
<span style="color: #483d8b;">print</span>(driver.current_url) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;url</span>

<span style="color: #a020f0;">try</span>:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">ele = WebDriverWait(driver, 20).until(</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">EC.visibility_of_element_located(</span>
    <span style="color: #b22222;">#         </span><span style="color: #b22222;">(By.ID, "b_results")</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">)</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">)</span>
    driver.find_element_by_id(<span style="color: #8b2252;">'b_results'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">driver.find_element_by_id('abcdefgh')</span>
    savepic()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
<span style="color: #a020f0;">finally</span>:
    driver.<span style="color: #008b8b;">quit</span>()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python">driver.implicitly_wait(10) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#19968;&#35774;&#23450;&#38544;&#24335;&#31561;&#24453;&#31186;&#25968;&#65292;&#22914;&#26524;find_element&#25214;&#19981;&#21040;&#65292;&#20250;&#31561;&#24453;10&#31186;</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:07d25607-1e53-4011-82ef-4b4fdb0da343" class="outline-3">
<h3 id="h:07d25607-1e53-4011-82ef-4b4fdb0da343">总结</h3>
<div class="outline-text-3" id="text-h:07d25607-1e53-4011-82ef-4b4fdb0da343">
<p>
Selenium的WebDriver是其核心，从Selenium2开始就是最重要的编程核心对象，在Selenium3中更是如此。
</p>

<p>
和浏览器交互全靠它，它可以：
</p>
<ul class="org-ul">
<li>打开URL，可以跟踪跳转，可以返回当前页面的实际URL</li>
<li>获取页面的title</li>
<li>处理cookie</li>
<li>控制浏览器的操作，例如前进、后退、刷新、关闭，最大化等</li>
<li>执行JS脚本</li>
<li>在DOM中搜索页面元素Web Element，指定的或一批，find系方法</li>
<li>操作网页元素
<ul class="org-ul">
<li>模拟下拉框操作Select(element)</li>
<li>在元素上模拟鼠标操作click()</li>
<li>在元素上模拟键盘输入send_keys()</li>
<li>获取元素文字 text</li>
<li>获取元素的属性 get_attribute()</li>
</ul></li>
</ul>

<p>
Selenium通过WebDriver来驱动浏览器工作，而浏览器是一个个独立的浏览器进程。
</p>
</div>
</div>
</section>
<section id="outline-container-h:0c2d52c0-d96a-496f-9731-991846240c5b" class="outline-2">
<h2 id="h:0c2d52c0-d96a-496f-9731-991846240c5b">Scrapy 框架</h2>
<div class="outline-text-2" id="text-h:0c2d52c0-d96a-496f-9731-991846240c5b">
</div>
<div id="outline-container-h:8cfc07b2-a961-4080-aa58-da37f737998f" class="outline-3">
<h3 id="h:8cfc07b2-a961-4080-aa58-da37f737998f">Scrapy框架</h3>
<div class="outline-text-3" id="text-h:8cfc07b2-a961-4080-aa58-da37f737998f">
<p>
Scrapy是用Python实现的一个为了爬取网站数据，提取结构性数据而编写的应用框架。 可以应用在包括数据挖掘、信息处理或存储历史数据等一系列的程序中。
</p>

<p>
Scrapy使用Twisted基于事件的高效异步网络框架来处理网络通信，可以加快下载速度，不用自己去实现异步框架，并且包含了各种中间件接口，可以灵活的完成各种需求。
</p>
</div>
<div id="outline-container-h:bde7be1f-e8c4-4e93-9110-6809d7d1938c" class="outline-4">
<h4 id="h:bde7be1f-e8c4-4e93-9110-6809d7d1938c">Scrapy架构</h4>
<div class="outline-text-4" id="text-h:bde7be1f-e8c4-4e93-9110-6809d7d1938c">
<p>
<a href="https://docs.scrapy.org/en/latest/topics/architecture.html#architecture-overview">https://docs.scrapy.org/en/latest/topics/architecture.html#architecture-overview</a>
</p>


<figure id="orgee519cc">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/python/images/img_20250910_110005.png" alt="img_20250910_110005.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:32dbdccc-c9fc-47a1-a956-e2934fd1efa9" class="outline-4">
<h4 id="h:32dbdccc-c9fc-47a1-a956-e2934fd1efa9">数据流(Data flow)</h4>
<div class="outline-text-4" id="text-h:32dbdccc-c9fc-47a1-a956-e2934fd1efa9">
<ol class="org-ol">
<li>引擎打开一个网站(open a domain)，找到处理该网站的Spider并向该spider请求第一个（批）要爬取的URL(s)</li>
<li>引擎从Spider中获取到第一个要爬取的URL并加入到调度器(Scheduler)作为请求以备调度</li>
<li>引擎向调度器请求下一个要爬取的URL</li>
<li>调度器返回下一个要爬取的URL给引擎，引擎将URL通过下载中间件并转发给下载器(Downloader)</li>
<li>一旦页面下载完毕，下载器生成一个该页面的Response，并将其通过下载中间件发送给引擎</li>
<li>引擎从下载器中接收到Response，然后通过Spider中间件发送给Spider处理</li>
<li>Spider处理Response并返回提取到的Item及(跟进的)新的Request给引擎</li>
<li>引擎将Spider返回的Item交给Item Pipeline，将Spider返回的Request交给调度器</li>
<li>(从第3步)重复执行，直到调度器中没有待处理的request，引擎关闭</li>
</ol>

<p>
注意：只有当调度器中没有任何request了，整个程序才会停止执行。如果有下载失败的URL，会重新下载
</p>
</div>
</div>
<div id="outline-container-h:0c514f23-b174-4744-8ed9-0b59cf45f5e6" class="outline-4">
<h4 id="h:0c514f23-b174-4744-8ed9-0b59cf45f5e6">组件</h4>
<div class="outline-text-4" id="text-h:0c514f23-b174-4744-8ed9-0b59cf45f5e6">
<p>
Scrapy Engine
</p>
<ul class="org-ul">
<li>引擎，负责控制数据流在系统中所有组件中流动，并在相应动作发生时触发事件。 此组件相当于爬虫的“大脑”，是整个爬虫的调度中心。</li>
</ul>

<p>
调度器(Scheduler)
</p>
<ul class="org-ul">
<li>调度器接收从引擎发送过来的request，并将他们入队，以便之后引擎请求他们时提供给引擎。</li>
<li>初始的爬取URL和后续在页面中获取的待爬取的URL将放入调度器中，等待爬取。同时调度器会 <b>自动去除重复的URL</b> （如果特定的URL不需要去重也可以通过设置实现，如post请求的URL）</li>
</ul>

<p>
下载器(Downloader)
</p>
<ul class="org-ul">
<li>下载器负责获取页面数据并提供给引擎，而后提供给spider。</li>
</ul>

<p>
Spiders爬虫
</p>
<ul class="org-ul">
<li>Spider是编写的类，作用如下：</li>
<li>Scrapy用户编写用于分析response并提取item(即获取到的item)</li>
<li>额外跟进的URL，将额外跟进的URL提交给引擎，加入到Scheduler调度器中。将每个spider负责处理一个特定(或一些)网站。</li>
</ul>

<p>
Item Pipeline
</p>
<ul class="org-ul">
<li>Item Pipeline负责处理被spider提取出来的item。典型的处理有清理、 验证及持久化(例如存取到数据库中)。</li>
<li>当页面被爬虫解析所需的数据存入Item后，将被发送到项目管道(Pipeline)，并经过设置好次序的pipeline程序处理这些数据，最后将存入本地文件或存入数据库</li>
<li>类似管道 <code>$ ls | grep test</code> 或者类似于Django 模板中的过滤器。</li>
</ul>

<p>
以下是item pipeline的一些典型应用：
</p>
<ul class="org-ul">
<li>清理HTML数据</li>
<li>验证爬取的数据(检查item包含某些字段)</li>
<li>查重(或丢弃)</li>
<li>将爬取结果保存到数据库中</li>
</ul>

<p>
<b>下载器中间件(Downloader middlewares)</b>
</p>

<p>
简单讲就是自定义扩展下载功能的组件
</p>

<ul class="org-ul">
<li>下载器中间件，是在引擎和下载器之间的特定钩子(specific hook)，处理它们之间的请求request和响应response。 它提供了一个简便的机制，通过插入自定义代码来扩展Scrapy功能。</li>
<li>通过设置下载器中间件可以实现爬虫自动更换user-agent、IP等功能。</li>
</ul>

<p>
<b>Spider中间件(Spider middlewares)</b>
</p>

<p>
Spider中间件，是在引擎和Spider之间的特定钩子(specific hook)，处理spider的输入(response)和输出(items或requests)。 也提供了同样的简便机制，通过插入自定义代码来扩展Scrapy功能。
</p>
</div>
</div>
<div id="outline-container-h:96fe61c2-936a-420b-b9ff-d093d5400bbd" class="outline-4">
<h4 id="h:96fe61c2-936a-420b-b9ff-d093d5400bbd">安装scrapy</h4>
<div class="outline-text-4" id="text-h:96fe61c2-936a-420b-b9ff-d093d5400bbd">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;scrapy&#26694;&#26550;</span>
pip install scrapy
</pre>
</div>


<p>
windows下出现如下问题
</p>

<div class="org-src-container">
<pre class="src src-sh">copying src\twisted\words\xish\xpathparser.g -&gt; build\lib.win-amd64-3.5\twisted\words\xish
 running build_ext
 building <span style="color: #8b2252;">'twisted.test.raiser'</span> extension
 error: Microsoft Visual C++ 14.0 is required. Get it with <span style="color: #8b2252;">"Microsoft Visual C++ Build </span>
<span style="color: #8b2252;">Tools"</span>: http://landinghub.visualstudio.com/visual-cpp-build-tools

&#35299;&#20915;&#26041;&#26696;&#26159;&#65292;&#19979;&#36733;&#32534;&#35793;&#22909;&#30340;twisted&#65292;https://www.lfd.uci.edu/~gohlke/pythonlibs/#twisted
python3.5 &#19979;&#36733; Twisted-18.4.0-cp35-cp35m-win_amd64.whl
python3.6 &#19979;&#36733; Twisted-18.4.0-cp36-cp36m-win_amd64.whl

&#23433;&#35013;twisted
$ pip install Twisted-18.4.0-cp35-cp35m-win_amd64.whl
&#20043;&#21518;&#22312;&#23433;&#35013;scrapy&#23601;&#27809;&#26377;&#20160;&#20040;&#38382;&#39064;&#20102;
</pre>
</div>

<p>
安装好，使用scrapy命令看看
</p>
<div class="org-src-container">
<pre class="src src-sh">(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy
Scrapy 2.13.3 - no active project

Usage:
  scrapy &lt;command&gt; [options] [args]

Available commands:
  bench         Run quick benchmark test
  fetch         Fetch a URL using the Scrapy downloader
  genspider     Generate new spider using pre-defined templates
  runspider     Run a self-contained spider (without creating a project)
  settings      Get settings values
  shell         Interactive scraping console
  startproject  Create new project
  version       Print Scrapy version
  view          Open URL<span style="color: #a020f0;"> in</span> browser, as seen by Scrapy

  [ more ]      More commands available when run from project directory

Use <span style="color: #8b2252;">"scrapy &lt;command&gt; -h"</span> to see more info about a command

<span style="color: #b22222;">#</span><span style="color: #b22222;">startproject &#21019;&#24314;&#23436;&#39033;&#30446;&#65292;&#21629;&#20196;&#36873;&#39033;</span>
(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy      
Scrapy 2.13.3 - active project: first

Usage:
  scrapy &lt;command&gt; [options] [args]

Available commands:
  bench         Run quick benchmark test
  check         Check spider contracts
  crawl         Run a spider
  edit          Edit spider
  fetch         Fetch a URL using the Scrapy downloader
  genspider     Generate new spider using pre-defined templates
  list          List available spiders
  parse         Parse URL (using its spider) and print the results
  runspider     Run a self-contained spider (without creating a project)
  settings      Get settings values
  shell         Interactive scraping console
  startproject  Create new project
  version       Print Scrapy version
  view          Open URL<span style="color: #a020f0;"> in</span> browser, as seen by Scrapy

Use <span style="color: #8b2252;">"scrapy &lt;command&gt; -h"</span> to see more info about a command
</pre>
</div>

<p>
Scrapy从2.x开始不支持python2，从2.4.x开始要求python3.6+
</p>
</div>
</div>
</div>
<div id="outline-container-h:d88d04ec-b09f-462a-ac74-6ddc4b8e8f4b" class="outline-3">
<h3 id="h:d88d04ec-b09f-462a-ac74-6ddc4b8e8f4b">Scrapy开发</h3>
<div class="outline-text-3" id="text-h:d88d04ec-b09f-462a-ac74-6ddc4b8e8f4b">
</div>
<div id="outline-container-h:d8be0ceb-9c3b-4a90-b677-4aa6ab66b039" class="outline-4">
<h4 id="h:d8be0ceb-9c3b-4a90-b677-4aa6ab66b039">项目编写流程</h4>
<div class="outline-text-4" id="text-h:d8be0ceb-9c3b-4a90-b677-4aa6ab66b039">
<ul class="org-ul">
<li>创建项目
<ul class="org-ul">
<li>使用 scrapy startproject proname 创建一个scrapy项目</li>
<li>scrapy startproject &lt;project_name&gt; [project_dir]</li>
</ul></li>
<li>编写item
<ul class="org-ul">
<li>在items.py中编写Item类，明确从response中提取的item</li>
</ul></li>
<li>编写爬虫
<ul class="org-ul">
<li>编写spiders/proname_spider.py，即爬取网站的spider并提取出item</li>
</ul></li>
<li>编写item pipeline
<ul class="org-ul">
<li>item的处理，可以存储</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:c30428d3-5773-4f51-9980-99935604615e" class="outline-4">
<h4 id="h:c30428d3-5773-4f51-9980-99935604615e">创建项目</h4>
<div class="outline-text-4" id="text-h:c30428d3-5773-4f51-9980-99935604615e">
<p>
豆瓣书评爬取
</p>

<p>
标签为“编程”，第一页、第二页链接
</p>
<ul class="org-ul">
<li><a href="https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T">https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T</a></li>
<li><a href="https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=20&amp;type=T">https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=20&amp;type=T</a></li>
</ul>

<p>
随便找一个目录来创建项目，执行下面命令
</p>
<div class="org-src-container">
<pre class="src src-sh">scrapy startproject first .
</pre>
</div>
<p>
会产生如下目录和文件
</p>

<div class="org-src-container">
<pre class="src src-sh">./
 &#9500;&#9472; scrapy.cfg
 &#9492;&#9472; first
    &#9500;&#9472; items.py
     &#9500;&#9472; middlewares.py
     &#9500;&#9472; pipelines.py
     &#9500;&#9472; settings.py
     &#9500;&#9472; __init__.py
     &#9492;&#9472; spiders
         &#9492;&#9472; __init__.py


./ &#39033;&#30446;&#30446;&#24405;
- scrapy.cfg   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#26377;&#30340;&#37325;&#35201;&#30340;&#39033;&#30446;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
- first        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39033;&#30446;&#30446;&#24405;</span>
- __init__.py  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#26377;&#65292;&#21253;&#25991;&#20214;</span>
- items.py     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;Item&#31867;&#65292;&#20174;scrapy.Item&#32487;&#25215;&#65292;&#37324;&#38754;&#23450;&#20041;scrapy.Field&#31867;&#23454;&#20363;</span>
- pipelines.py <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#35201;&#30340;&#26159;process_item()&#26041;&#27861;&#65292;&#22788;&#29702;item</span>
- settings.py&#65306;
  - BOT_NAME                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29228;&#34411;&#21517;</span>
  - ROBOTSTXT_OBEY = True   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#36981;&#20174;robots&#21327;&#35758;</span>
  - USER_AGENT = <span style="color: #8b2252;">''</span>         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#29228;&#21462;&#26102;&#20351;&#29992;</span>
  - CONCURRENT_REQEUST = 16 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;16&#20010;&#24182;&#34892;</span>
  - DOWNLOAD_DELAY = 3      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#24310;&#26102;&#65292;&#19968;&#33324;&#35201;&#35774;&#32622;&#65292;&#19981;&#23452;&#36807;&#24555;&#21457;&#36215;&#36830;&#32493;&#35831;&#27714;</span>
  - COOKIES_ENABLED = False <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#30465;&#26159;&#21551;&#29992;&#65292;&#19968;&#33324;&#38656;&#35201;&#30331;&#24405;&#26102;&#25165;&#38656;&#35201;&#24320;&#21551;cookie</span>
  - SPIDER_MIDDLEWARES      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29228;&#34411;&#20013;&#38388;&#20214;</span>
  - DOWNLOADER_MIDDLEWARES  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#20013;&#38388;&#20214;</span>
    - <span style="color: #8b2252;">'first.middlewares.FirstDownloaderMiddleware'</span>: 543
    - 543 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36234;&#23567;&#20248;&#20808;&#32423;&#36234;&#39640;</span>
  - ITEM_PIPELINES          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#36947;&#37197;&#32622;</span>
    - <span style="color: #8b2252;">'firstscrapy.pipelines.FirstscrapyPipeline'</span>: 300
    - item <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20132;&#32473;&#21738;&#19968;&#20010;&#31649;&#36947;&#22788;&#29702;&#65292;300 &#36234;&#23567;&#20248;&#20808;&#32423;&#36234;&#39640;</span>
- spiders&#30446;&#24405;
  - __init__.py             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#26377;&#65292;&#21487;&#20197;&#22312;&#36825;&#37324;&#20889;&#29228;&#34411;&#31867;&#65292;&#20063;&#21487;&#20197;&#20889;&#29228;&#34411;&#23376;&#27169;&#22359;</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">settings.py&#21442;&#32771;</span>
<span style="color: #a0522d;">BOT_NAME</span> = <span style="color: #8b2252;">'first'</span>
<span style="color: #a0522d;">SPIDER_MODULES</span> = [<span style="color: #8b2252;">'first.spiders'</span>]
<span style="color: #a0522d;">NEWSPIDER_MODULE</span> = <span style="color: #8b2252;">'first.spiders'</span>

<span style="color: #a0522d;">USER_AGENT</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1)AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.75 Safari/537.36"</span>
<span style="color: #a0522d;">ROBOTSTXT_OBEY</span> = <span style="color: #008b8b;">False</span>

<span style="color: #a0522d;">DOWNLOAD_DELAY</span> = 3

<span style="color: #b22222;"># </span><span style="color: #b22222;">Disable cookies (enabled by default)</span>
<span style="color: #a0522d;">COOKIES_ENABLED</span> = <span style="color: #008b8b;">True</span>
</pre>
</div>

<p>
注意一定要更改User-Agent，否则访问 <a href="https://book.douban.com/">https://book.douban.com/</a> 会返回403
</p>
</div>
</div>
<div id="outline-container-h:1ac5d239-f9dd-4c3a-aa5d-07164a175c98" class="outline-4">
<h4 id="h:1ac5d239-f9dd-4c3a-aa5d-07164a175c98">编写Item</h4>
<div class="outline-text-4" id="text-h:1ac5d239-f9dd-4c3a-aa5d-07164a175c98">
<p>
在items.py中编写
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookItem</span>(scrapy.Item):
    <span style="color: #a0522d;">title</span> = scrapy.Field() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20070;&#21517;</span>
    <span style="color: #a0522d;">rate</span> = scrapy.Field() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35780;&#20998;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:de99b8fb-c341-4e97-a105-f8ac8930b719" class="outline-4">
<h4 id="h:de99b8fb-c341-4e97-a105-f8ac8930b719">编写爬虫</h4>
<div class="outline-text-4" id="text-h:de99b8fb-c341-4e97-a105-f8ac8930b719">
<p>
为爬取豆瓣书评编写爬虫类，在spiders目录下
</p>

<p>
编写的爬虫类需要继承自scrapy.Spider，在这个类中定义爬虫名、爬取范围、其实地址等
</p>

<p>
在scrapy.Spider中parse方法未实现，所以子类应该实现parse方法。该方法传入response对象
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">scrapy&#28304;&#30721;&#20013;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">scrapy.spiders.Spider.parse</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Spider</span>():
    <span style="color: #a020f0;">if</span> TYPE_CHECKING:
        parse: CallbackT
    <span style="color: #a020f0;">else</span>:

        <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response: Response, **kwargs: Any) -&gt; Any:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#26512;&#36820;&#22238;&#30340;&#20869;&#23481;</span>
            <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">NotImplementedError</span>(
                f<span style="color: #8b2252;">"</span>{<span style="color: #a020f0;">self</span>.__class__.<span style="color: #483d8b;">__name__</span>}<span style="color: #8b2252;">.parse callback is not defined"</span>
            )
</pre>
</div>

<p>
爬取读书频道，tag为“编程”的书名和评分
</p>
<ul class="org-ul">
<li><a href="https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=20&amp;type=T">https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=20&amp;type=T</a></li>
</ul>

<p>
使用模板创建spider
</p>
<div class="org-src-container">
<pre class="src src-sh">scrapy genspider -t basic book douban.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">./first/spiders/book.py</span>
</pre>
</div>

<p>
./first/spiders/book.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">BookSpider </span>
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'doubanbook'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#21517;&#65292;&#21487;&#20462;&#25913;&#65292;&#37325;&#35201; </span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">'douban.com'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#29228;&#21462;&#33539;&#22260; </span>
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T'</span> 
    <span style="color: #a0522d;">start_urls</span> = [url] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36215;&#22987;URL </span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#36733;&#22120;&#33719;&#21462;&#20102;WEB Server&#30340;response&#23601;&#34892;&#20102;&#65292;parse&#23601;&#26159;&#35299;&#26512;&#21709;&#24212;&#30340;&#20869;&#23481; </span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response): 
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response), <span style="color: #8b2252;">'~~~~~~~~~'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">scrapy.http.response.html.HtmlResponse </span>
        <span style="color: #483d8b;">print</span>(response) 
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
</pre>
</div>

<p>
使用crawl爬取子命令
</p>
<div class="org-src-container">
<pre class="src src-sh">scrapy list
scrapy crawl -h
scrapy crawl [options] &lt;spider&gt;


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#29228;&#34411;&#21517;&#31216;&#24320;&#22987;&#29228;&#21462;</span>
scrapy crawl doubanbook

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#19981;&#25171;&#21360;&#26085;&#24535;</span>
scrapy crawl doubanbook --nolog
</pre>
</div>


<p>
response是服务器端HTTP响应，它是scrapy.http.response.html.HtmlResponse类。由此，修改代码如下
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.http.response.html <span style="color: #a020f0;">import</span> HtmlResponse

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">BookSpider</span>
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'doubanbook'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#21517; </span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">'douban.com'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#29228;&#21462;&#33539;&#22260; </span>
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T'</span> 
    <span style="color: #a0522d;">start_urls</span> = [url] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36215;&#22987;URL </span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#36733;&#22120;&#33719;&#21462;&#20102;WEB Server&#30340;response&#23601;&#34892;&#20102;&#65292;parse&#23601;&#26159;&#35299;&#26512;&#21709;&#24212;&#30340;&#20869;&#23481; </span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse): 
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response)) <span style="color: #b22222;">#</span><span style="color: #b22222;">scrapy.http.response.html.HtmlResponse </span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30) 
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(response.text), <span style="color: #483d8b;">type</span>(response.body))
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
        <span style="color: #483d8b;">print</span>(response.encoding)
        <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'o:/testbook.html'</span>, <span style="color: #8b2252;">'w'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
            <span style="color: #a020f0;">try</span>: 
                f.write(response.text) 
                f.flush() 
            <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e: 
                <span style="color: #483d8b;">print</span>(e)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.http <span style="color: #a020f0;">import</span> HtmlResponse

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"doubanbook"</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>]
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T"</span>
    <span style="color: #a0522d;">start_urls</span> = [url]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse): <span style="color: #b22222;"># </span><span style="color: #b22222;">parse&#20989;&#25968;&#65292;&#35299;&#26512;html</span>
        <span style="color: #483d8b;">print</span>(response.status)
        <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/book.html'</span>, <span style="color: #8b2252;">'wb'</span>) <span style="color: #a020f0;">as</span> f:
            f.write(response.body)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">titles = response.xpath('//li[@class="subject-item"]//h2/a/text()').extract() # SelectorList -&gt; list</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">for title in titles:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">print(type(title), title.strip())</span>
</pre>
</div>
</div>
<div id="outline-container-h:979b0155-8049-49cd-8406-d5af2d91256b" class="outline-5">
<h5 id="h:979b0155-8049-49cd-8406-d5af2d91256b">解析HTML</h5>
<div class="outline-text-5" id="text-h:979b0155-8049-49cd-8406-d5af2d91256b">
<p>
爬虫获得的内容response对象，可以使用解析库来解析
</p>

<p>
scrapy包装了lxml，父类TextResponse类也提供了xpath方法和css方法，可以混合使用这两套接口解析HTML。
</p>

<p>
选择器参考: <a href="https://docs.scrapy.org/en/latest/topics/selectors.html#using-selectors">https://docs.scrapy.org/en/latest/topics/selectors.html#using-selectors</a>
</p>

<p>
xpath返回scrapy.selector.unified.SelectorList对象，里面装着scrapy.selector.unified.Selector对象。
</p>

<p>
t.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.http.response.html <span style="color: #a020f0;">import</span> HtmlResponse

<span style="color: #a0522d;">response</span> = HtmlResponse(<span style="color: #8b2252;">'file:///O:/testbook.html'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26500;&#36896;&#23545;&#35937;</span>

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'o:/testbook.html'</span>, encoding=<span style="color: #8b2252;">'utf8'</span>) <span style="color: #a020f0;">as</span> f: 
    response._set_body(f.read()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22635;&#20805;&#25968;&#25454; </span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(response.text)</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#25152;&#26377;&#26631;&#39064;&#21450;&#35780;&#20998;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath&#35299;&#26512; </span>
    <span style="color: #a0522d;">subjects</span> = response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>) 
    <span style="color: #a020f0;">for</span> subject <span style="color: #a020f0;">in</span> subjects: 
        <span style="color: #a0522d;">title</span> = subject.xpath(<span style="color: #8b2252;">'.//h2/a/text()'</span>).extract() <span style="color: #b22222;"># </span><span style="color: #b22222;">list </span>
        <span style="color: #483d8b;">print</span>(title[0].strip())

        <span style="color: #a0522d;">rate</span> = subject.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).extract()
        <span style="color: #483d8b;">print</span>(rate[0].strip()) 

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30) 
    <span style="color: #b22222;"># </span><span style="color: #b22222;">css&#35299;&#26512; </span>
    <span style="color: #a0522d;">subjects</span> = response.css(<span style="color: #8b2252;">'li.subject-item'</span>) 
    <span style="color: #a020f0;">for</span> subject <span style="color: #a020f0;">in</span> subjects: 
        <span style="color: #a0522d;">title</span> = subject.css(<span style="color: #8b2252;">'h2 a::text'</span>).extract() 
        <span style="color: #483d8b;">print</span>(title[0].strip()) 

        <span style="color: #a0522d;">rate</span> = subject.css(<span style="color: #8b2252;">'span.rating_nums::text'</span>).extract() 
        <span style="color: #483d8b;">print</span>(rate[0].strip()) 
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath&#21644;css&#28151;&#21512;&#20351;&#29992;&#12289;&#27491;&#21017;&#34920;&#36798;&#24335;&#21305;&#37197; </span>
    <span style="color: #a0522d;">subjects</span> = response.css(<span style="color: #8b2252;">'li.subject-item'</span>) 
    <span style="color: #a020f0;">for</span> subject <span style="color: #a020f0;">in</span> subjects:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#21462;&#38142;&#25509;</span>
        <span style="color: #a0522d;">href</span> =subject.xpath(<span style="color: #8b2252;">'.//h2'</span>).css(<span style="color: #8b2252;">'a::attr(href)'</span>).extract()
        <span style="color: #483d8b;">print</span>(href[0])

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;</span>
        <span style="color: #483d8b;">id</span> = subject.xpath(<span style="color: #8b2252;">'.//h2/a/@href'</span>).re(r<span style="color: #8b2252;">'\d*99\d*'</span>)
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">id</span>: 
            <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">id</span>[0]) 

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35201;&#27714;&#26174;&#31034;9&#20998;&#20197;&#19978;&#25968;&#25454; </span>
        <span style="color: #a0522d;">rate</span> = subject.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).re(r<span style="color: #8b2252;">'^9.*'</span>) 
        <span style="color: #b22222;"># </span><span style="color: #b22222;">rate = subject.css('span.rating_nums::text').re(r'^9\..*') </span>
        <span style="color: #a020f0;">if</span> rate: 
            <span style="color: #483d8b;">print</span>(rate)
</pre>
</div>

<p>
上例练习t.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> scrapy.http <span style="color: #a020f0;">import</span> HtmlResponse
<span style="color: #a020f0;">from</span> scrapy.selector.unified <span style="color: #a020f0;">import</span> SelectorList, Selector

<span style="color: #a0522d;">response</span> = HtmlResponse(<span style="color: #8b2252;">''</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>)
<span style="color: #483d8b;">print</span>(response)

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/book.html'</span>, <span style="color: #8b2252;">'rb'</span>) <span style="color: #a020f0;">as</span> f:
    response._set_body(f.read())
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.text)</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath&#35299;&#26512;</span>
    <span style="color: #a0522d;">subjects</span>:<span style="color: #228b22;">SelectorList</span> = response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>)
    <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(s), s)</span>
        <span style="color: #a0522d;">s</span>:<span style="color: #228b22;">Selector</span> = s
        <span style="color: #a0522d;">titlelist</span> = s.xpath(<span style="color: #8b2252;">'.//h2/a/text()'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath css =&gt; SelectorList -&gt; List</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(titlelist)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(titlelist.extract())</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(titlelist.getall())</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(titlelist.extract_first())</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(titlelist.get().strip())</span>
        <span style="color: #a0522d;">title</span> = titlelist.get(<span style="color: #8b2252;">''</span>).strip()
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> title: <span style="color: #a020f0;">continue</span>
        <span style="color: #a0522d;">rate</span> = s.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).get(<span style="color: #8b2252;">'0'</span>).strip()
        <span style="color: #483d8b;">print</span>(title, rate)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">css&#35299;&#26512;</span>
    <span style="color: #a0522d;">subjects</span> = response.css(<span style="color: #8b2252;">'li.subject-item'</span>)
    <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
        <span style="color: #a0522d;">title</span> = s.css(<span style="color: #8b2252;">'h2 a::text'</span>).get(<span style="color: #8b2252;">''</span>).strip()
        <span style="color: #a0522d;">rate</span> = s.css(<span style="color: #8b2252;">'span.rating_nums::text'</span>).get(<span style="color: #8b2252;">'0'</span>).strip()
        <span style="color: #483d8b;">print</span>(title, rate)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28151;&#21512;&#25552;&#21462;</span>
    <span style="color: #a0522d;">subjects</span> = response.css(<span style="color: #8b2252;">'li.subject-item'</span>)
    <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
        <span style="color: #a0522d;">title</span> = s.css(<span style="color: #8b2252;">'h2'</span>).xpath(<span style="color: #8b2252;">'./a/text()'</span>).get(<span style="color: #8b2252;">''</span>).strip()
        <span style="color: #a0522d;">rate</span> = s.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).get(<span style="color: #8b2252;">'0'</span>).strip()

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#21462;&#19968;&#23450;&#20998;&#25968;&#30340;title rate&#24590;&#20040;&#20570;&#65311;</span>
    <span style="color: #a0522d;">subjects</span> = response.css(<span style="color: #8b2252;">'li.subject-item'</span>)
    <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
        <span style="color: #a0522d;">rate</span> = s.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).re(<span style="color: #8b2252;">'^9.*'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">re -&gt; list</span>
        <span style="color: #a020f0;">if</span> rate:
            <span style="color: #a0522d;">title</span> = s.css(<span style="color: #8b2252;">'h2'</span>).xpath(<span style="color: #8b2252;">'./a/text()'</span>).get(<span style="color: #8b2252;">''</span>).strip()
            <span style="color: #483d8b;">print</span>(title, rate)
</pre>
</div>

<p>
建议scrapy中使用xpath解析。
</p>
</div>
</div>
<div id="outline-container-h:029ef855-f59b-4a95-a63f-b4c7253bd6b9" class="outline-5">
<h5 id="h:029ef855-f59b-4a95-a63f-b4c7253bd6b9">item封装数据</h5>
<div class="outline-text-5" id="text-h:029ef855-f59b-4a95-a63f-b4c7253bd6b9">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">spiders/books.py</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"doubanbook"</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>]
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T"</span>
    <span style="color: #a0522d;">start_urls</span> = [url]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse): <span style="color: #b22222;"># </span><span style="color: #b22222;">parse&#20989;&#25968;&#65292;&#35299;&#26512;html</span>
        <span style="color: #a0522d;">items</span> = []
        <span style="color: #a0522d;">subjects</span> = response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>)
        <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
            <span style="color: #a0522d;">title</span> = s.xpath(<span style="color: #8b2252;">'.//h2/a/text()'</span>).get(<span style="color: #8b2252;">''</span>).strip()
            <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> title: <span style="color: #a020f0;">continue</span>
            <span style="color: #a0522d;">rate</span> = s.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).get(<span style="color: #8b2252;">'0'</span>).strip()
            <span style="color: #483d8b;">print</span>(title, rate)
            <span style="color: #a0522d;">item</span> = BookItem()
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'title'</span>] = title
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'rate'</span>] = rate
            items.append(item)

        <span style="color: #a020f0;">return</span> items <span style="color: #b22222;"># </span><span style="color: #b22222;">parse&#26041;&#27861;&#24517;&#39035;&#36820;&#22238;&#21487;&#36845;&#20195;&#23545;&#35937;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.status)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">with open('d:/tmp/book.html', 'wb') as f:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">f.write(response.body)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">titles = response.xpath('//li[@class="subject-item"]//h2/a/text()').extract() # SelectorList -&gt; list</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">for title in titles:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">print(type(title), title.strip())</span>
</pre>
</div>

<p>
使用命令保存return的数据
</p>
<div class="org-src-container">
<pre class="src src-sh">scrapy crawl -h
<span style="color: #b22222;"># </span><span style="color: #b22222;">--output=FILE, -o FILE dump scraped items into FILE (use - for stdout)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#25193;&#23637;&#21517;&#25903;&#25345;'json', 'jsonlines', 'jl', 'csv', 'xml', 'marshal', 'pickle'</span>

scrapy crawl doubanbook -o dbbooks.json
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f2811a36-83d0-49fc-9cc1-e0cabc765b31" class="outline-4">
<h4 id="h:f2811a36-83d0-49fc-9cc1-e0cabc765b31">pipeline处理</h4>
<div class="outline-text-4" id="text-h:f2811a36-83d0-49fc-9cc1-e0cabc765b31">
<p>
将bookspider.py中BookSpider改成生成器，只需要把 return items 改造成 yield item ，即由产生一个列表变成yield一个个item
</p>

<p>
脚手架帮我们创建了一个pipelines.py文件和一个类
</p>
</div>
<div id="outline-container-h:1b673185-1dce-407b-8126-ab18b2c7efc0" class="outline-5">
<h5 id="h:1b673185-1dce-407b-8126-ab18b2c7efc0">开启pipeline</h5>
<div class="outline-text-5" id="text-h:1b673185-1dce-407b-8126-ab18b2c7efc0">
<p>
settings.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">Configure item pipelines</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span>
<span style="color: #a0522d;">ITEM_PIPELINES</span> = {
    <span style="color: #8b2252;">'first.pipelines.FirstPipeline'</span>: 300,
}
</pre>
</div>
<p>
整数300表示优先级，越小越高。取值范围为0-1000
</p>
</div>
</div>
<div id="outline-container-h:398aaff9-22ef-4c52-a4bd-50058065af77" class="outline-5">
<h5 id="h:398aaff9-22ef-4c52-a4bd-50058065af77">常用方法</h5>
<div class="outline-text-5" id="text-h:398aaff9-22ef-4c52-a4bd-50058065af77">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">参数</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">process_item(self, item, spider)</td>
<td class="org-left">item爬取的一个个数据</td>
<td class="org-left">必须</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">spider表示item的爬取者</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">每一个item处理都调用</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">返回一个Item对象，或抛出DropItem异常</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">被丢弃的Item对象将不会被之后的pipeline组件处理</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">open_spider(self, spider)</td>
<td class="org-left">spider表示被开启的spider 调用一次</td>
<td class="org-left">可选</td>
</tr>

<tr>
<td class="org-left">close_spider(self, spider)</td>
<td class="org-left">spider表示被关闭的spider 调用一次</td>
<td class="org-left">可选</td>
</tr>

<tr>
<td class="org-left"><code>__init__(self)</code></td>
<td class="org-left">spider实例创建时调用一次</td>
<td class="org-left">可选</td>
</tr>
</tbody>
</table>

<p>
常用方法
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">.\first\pipelines.py</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See: https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span>
<span style="color: #a020f0;">from</span> itemadapter <span style="color: #a020f0;">import</span> ItemAdapter
<span style="color: #a020f0;">from</span> scrapy.exceptions <span style="color: #a020f0;">import</span> DropItem


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">FirstPipeline</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#35774;&#32622;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~init~~~'</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">open_spider</span>(<span style="color: #a020f0;">self</span>, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#26576;spider&#24320;&#21551;&#26102;&#35843;&#29992;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider),spider.name, spider)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">close_spider</span>(<span style="color: #a020f0;">self</span>, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#26576;spider&#20851;&#38381;&#26102;&#35843;&#29992;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider),spider.name, spider)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_item</span>(<span style="color: #a020f0;">self</span>, item, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;item&#37117;&#35843;&#29992;&#19968;&#27425;&#36825;&#20010;&#26041;&#27861;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider), spider.name, <span style="color: #8b2252;">'++++++++++++++++++'</span>)
        <span style="color: #483d8b;">print</span>(item,<span style="color: #8b2252;">'~~~~~~~~~~~~~~'</span>)
        <span style="color: #a020f0;">return</span> item <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32473;&#19979;&#19968;&#32423; item:Item dict None</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">raise DropItem # &#25172;&#25481;</span>
</pre>
</div>

<p>
测试一下
</p>
<div class="org-src-container">
<pre class="src src-sh">(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy crawl  doubanbook
</pre>
</div>

<p>
需求
</p>

<p>
通过pipeline将爬取的数据存入json文件中
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">D:\project\pyproj\pycharm\first\spiders\book.py</span>
<span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.http <span style="color: #a020f0;">import</span> HtmlResponse
<span style="color: #a020f0;">from</span> ..items <span style="color: #a020f0;">import</span> BookItem

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"doubanbook"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#21517;&#31216;</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#33539;&#22260;</span>
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T"</span>
    <span style="color: #a0522d;">start_urls</span> = [url] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36215;&#22987;URL</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">spider&#19978;&#33258;&#23450;&#20041;&#37197;&#32622;&#20449;&#24687;</span>
    <span style="color: #a0522d;">custom_settings</span> = {
        <span style="color: #8b2252;">'filename'</span>:<span style="color: #8b2252;">'d:/tmp/b1.json'</span>
    }

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse): <span style="color: #b22222;"># </span><span style="color: #b22222;">parse&#20989;&#25968;&#65292;&#35299;&#26512;html</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">items = []</span>
        <span style="color: #a0522d;">subjects</span> = response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>)
        <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
            <span style="color: #a0522d;">title</span> = s.xpath(<span style="color: #8b2252;">'.//h2/a/text()'</span>).get(<span style="color: #8b2252;">''</span>).strip()
            <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> title: <span style="color: #a020f0;">continue</span>
            <span style="color: #a0522d;">rate</span> = s.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).get(<span style="color: #8b2252;">'0'</span>).strip()
            <span style="color: #a0522d;">item</span> = BookItem()
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'title'</span>] = title
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'rate'</span>] = rate
            <span style="color: #b22222;"># </span><span style="color: #b22222;">items.append(item)</span>
            <span style="color: #a020f0;">yield</span> item
        <span style="color: #b22222;"># </span><span style="color: #b22222;">return items # parse&#26041;&#27861;&#24517;&#39035;&#36820;&#22238;&#21487;&#36845;&#20195;&#23545;&#35937;</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.status)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">with open('d:/tmp/book.html', 'wb') as f:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">f.write(response.body)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">titles = response.xpath('//li[@class="subject-item"]//h2/a/text()').extract() # SelectorList -&gt; list</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">for title in titles:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">print(type(title), title.strip())</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">D:\project\pyproj\pycharm\first\pipelines.py</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Define your item pipelines here</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Don't forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See: https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span>
<span style="color: #a020f0;">import</span> json

<span style="color: #b22222;"># </span><span style="color: #b22222;">useful for handling different item types with a single interface</span>
<span style="color: #a020f0;">from</span> itemadapter <span style="color: #a020f0;">import</span> ItemAdapter
<span style="color: #a020f0;">from</span> scrapy.exceptions <span style="color: #a020f0;">import</span> DropItem


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">FirstPipeline</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#35774;&#32622;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~init~~~'</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">open_spider</span>(<span style="color: #a020f0;">self</span>, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#26576;spider&#24320;&#21551;&#26102;&#35843;&#29992;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider),spider.name, spider)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">self.file = open('d:/tmp/book.json', 'w', encoding='utf-8')</span>
        <span style="color: #483d8b;">print</span>(spider.settings.get(<span style="color: #8b2252;">'filename'</span>, <span style="color: #8b2252;">'aaaa'</span>))
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span> = <span style="color: #483d8b;">open</span>(spider.settings[<span style="color: #8b2252;">'filename'</span>], <span style="color: #8b2252;">'w'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.write(<span style="color: #8b2252;">'[</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">close_spider</span>(<span style="color: #a020f0;">self</span>, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#26576;spider&#20851;&#38381;&#26102;&#35843;&#29992;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider),spider.name, spider)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.write(<span style="color: #8b2252;">']'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.close()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_item</span>(<span style="color: #a020f0;">self</span>, item, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;item&#37117;&#35843;&#29992;&#19968;&#27425;&#36825;&#20010;&#26041;&#27861;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider), spider.name, <span style="color: #8b2252;">'++++++++++++++++++'</span>)
        <span style="color: #483d8b;">print</span>(item,<span style="color: #8b2252;">'~~~~~~~~~~~~~~'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.write(json.dumps(<span style="color: #483d8b;">dict</span>(item)) + <span style="color: #8b2252;">',</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
        <span style="color: #a020f0;">return</span> item <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32473;&#19979;&#19968;&#32423; item:Item dict None</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">raise DropItem # &#25172;&#25481;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">D:\project\pyproj\pycharm\first\spiders\book.py</span>
<span style="color: #a020f0;">import</span> json

<span style="color: #b22222;"># </span><span style="color: #b22222;">useful for handling different item types with a single interface</span>
<span style="color: #a020f0;">from</span> itemadapter <span style="color: #a020f0;">import</span> ItemAdapter
<span style="color: #a020f0;">from</span> scrapy.exceptions <span style="color: #a020f0;">import</span> DropItem


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">FirstPipeline</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, path): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#35774;&#32622;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~init~~~'</span>)
        <span style="color: #483d8b;">print</span>(path, <span style="color: #8b2252;">'&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">path</span> = path

    @<span style="color: #483d8b;">classmethod</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">from_crawler</span>(cls, crawler):
        <span style="color: #a020f0;">return</span> cls(
            path = crawler.settings.get(<span style="color: #8b2252;">'FILENAME'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;3&#65292;</span>
        )

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">open_spider</span>(<span style="color: #a020f0;">self</span>, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#26576;spider&#24320;&#21551;&#26102;&#35843;&#29992;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider),spider.name, spider)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">self.file = open('d:/tmp/book.json', 'w', encoding='utf-8')</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(spider.settings.get('filename', 'aaaa')) # &#26041;&#27861;1 &#33258;&#23450;&#20041;spider&#37197;&#32622;&#65371;'filename':'d:/tmp/b1.json'&#65373;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(spider.settings.get('FILENAME', 'cccc')) # &#26041;&#27861;2 &#20840;&#23616;settings.py&#37197;&#32622; FILENAME = ':/tmp/b2.json'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">self.file = open(spider.settings['filename'], 'w', encoding='utf-8')</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span> = <span style="color: #483d8b;">open</span>(<span style="color: #a020f0;">self</span>.path, <span style="color: #8b2252;">'w'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.write(<span style="color: #8b2252;">'[</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">close_spider</span>(<span style="color: #a020f0;">self</span>, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#26576;spider&#20851;&#38381;&#26102;&#35843;&#29992;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider),spider.name, spider)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.write(<span style="color: #8b2252;">']'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.close()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_item</span>(<span style="color: #a020f0;">self</span>, item, spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;item&#37117;&#35843;&#29992;&#19968;&#27425;&#36825;&#20010;&#26041;&#27861;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(spider), spider.name, <span style="color: #8b2252;">'++++++++++++++++++'</span>)
        <span style="color: #483d8b;">print</span>(item,<span style="color: #8b2252;">'~~~~~~~~~~~~~~'</span>)
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">file</span>.write(json.dumps(<span style="color: #483d8b;">dict</span>(item)) + <span style="color: #8b2252;">',</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
        <span style="color: #a020f0;">return</span> item <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32473;&#19979;&#19968;&#32423; item:Item dict None</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">raise DropItem # &#25172;&#25481;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d4bd91dd-c8a0-4e50-9d1e-d4ba396d974a" class="outline-4">
<h4 id="h:d4bd91dd-c8a0-4e50-9d1e-d4ba396d974a">url提取</h4>
<div class="outline-text-4" id="text-h:d4bd91dd-c8a0-4e50-9d1e-d4ba396d974a">
<p>
如果要爬取下一页内容，可以自己分析每一页的页码变化，也可以通过提取分页栏的链接
</p>

<p>
测试提取路径，t.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> scrapy.http <span style="color: #a020f0;">import</span> HtmlResponse
<span style="color: #a020f0;">from</span> scrapy.selector.unified <span style="color: #a020f0;">import</span> SelectorList, Selector

<span style="color: #a0522d;">response</span> = HtmlResponse(<span style="color: #8b2252;">'https://book.douban.com'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>)
<span style="color: #483d8b;">print</span>(response)

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'d:/tmp/book.html'</span>, <span style="color: #8b2252;">'rb'</span>) <span style="color: #a020f0;">as</span> f:
    response._set_body(f.read())
    <span style="color: #a0522d;">h</span> = response.xpath(<span style="color: #8b2252;">'//span[@class="next"]//a/@href'</span>)
    <span style="color: #483d8b;">print</span>(h)
    <span style="color: #483d8b;">print</span>(h.re(r<span style="color: #8b2252;">'.*start=[24]0[^\d]+'</span>))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#36335;&#24452;</span>
    <span style="color: #483d8b;">print</span>(response.urljoin(h.re(r<span style="color: #8b2252;">'.*start=[24]0[^\d]+'</span>)[0]))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">spider/books.py</span>
<span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.http.response.html <span style="color: #a020f0;">import</span> HtmlResponse
<span style="color: #a020f0;">from</span> ..items <span style="color: #a020f0;">import</span> BookItem

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider): <span style="color: #b22222;"># </span><span style="color: #b22222;">BookSpider </span>
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'doubanbook'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#21517;</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">'douban.com'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#29228;&#21462;&#33539;&#22260;</span>
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T'</span> 
    <span style="color: #a0522d;">start_urls</span> = [url] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36215;&#22987;URL</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">spider&#19978;&#33258;&#23450;&#20041;&#37197;&#32622;&#20449;&#24687; </span>
    <span style="color: #a0522d;">custom_settings</span> = {  
        <span style="color: #8b2252;">'filename'</span> : <span style="color: #8b2252;">'o:/books.json'</span>
     }

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#36733;&#22120;&#33719;&#21462;&#20102;WEB Server&#30340;response&#23601;&#34892;&#20102;&#65292;parse&#23601;&#26159;&#35299;&#26512;&#21709;&#24212;&#30340;&#20869;&#23481;    </span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse): 
        <span style="color: #b22222;">#</span><span style="color: #b22222;">items = []  </span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">xpath&#35299;&#26512;    </span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#19979;&#19968;&#39029;&#65292;&#21482;&#26159;&#27979;&#35797;&#65292;&#25152;&#20197;&#20351;&#29992;re&#26469;&#25511;&#21046;&#39029;&#30721; </span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        <span style="color: #a0522d;">urls</span> = response.xpath(<span style="color: #8b2252;">'//div[@class="paginator"]/span[@class="next"]/a/@href'</span>).re(
                            r<span style="color: #8b2252;">'.*start=[24]\d[^\d].*'</span>) 
        <span style="color: #483d8b;">print</span>(urls)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        <span style="color: #a020f0;">yield</span> <span style="color: #a020f0;">from</span> (scrapy.Request(response.urljoin(url)) <span style="color: #a020f0;">for</span> url <span style="color: #a020f0;">in</span> urls)   
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'++++++++++++++++++++++++'</span>)

        <span style="color: #a0522d;">subjects</span> = response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>) 
        <span style="color: #a020f0;">for</span> subject <span style="color: #a020f0;">in</span> subjects:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#20915;&#22270;&#20070;&#21103;&#26631;&#39064;&#25340;&#25509; </span>
            <span style="color: #a0522d;">title</span> = <span style="color: #8b2252;">""</span>.join(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.strip(), subject.xpath(<span style="color: #8b2252;">'.//h2/a//text()'</span>).extract())) 
            <span style="color: #a0522d;">rate</span> = subject.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).extract_first() 
            <span style="color: #b22222;">#</span><span style="color: #b22222;">print(rate) # &#26377;&#30340;&#27809;&#26377;&#35780;&#20998;&#65292;&#35201;&#27880;&#24847;&#21487;&#33021;&#36820;&#22238;None</span>

            <span style="color: #a0522d;">item</span> = BookItem()
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'title'</span>] = title
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'rate'</span>] = rate 
            <span style="color: #b22222;">#</span><span style="color: #b22222;">items.append(item) </span>
            <span style="color: #a020f0;">yield</span> item

        <span style="color: #b22222;">#</span><span style="color: #b22222;">return items</span>
</pre>
</div>

<p>
同上练习
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">spider/books.py</span>
<span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.http <span style="color: #a020f0;">import</span> HtmlResponse
<span style="color: #a020f0;">from</span> ..items <span style="color: #a020f0;">import</span> BookItem

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BookSpider</span>(scrapy.Spider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"doubanbook"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#21517;&#31216;</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29228;&#34411;&#33539;&#22260;</span>
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T"</span>
    <span style="color: #a0522d;">start_urls</span> = [url] <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36215;&#22987;URL</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">spider&#19978;&#33258;&#23450;&#20041;&#37197;&#32622;&#20449;&#24687;</span>
    <span style="color: #a0522d;">custom_settings</span> = {
        <span style="color: #8b2252;">'filename'</span>:<span style="color: #8b2252;">'d:/tmp/b1.json'</span>
    }

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse): <span style="color: #b22222;"># </span><span style="color: #b22222;">parse&#20989;&#25968;&#65292;&#35299;&#26512;html</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#21462;&#21518;&#32493;&#29228;&#21462;&#30340;&#38142;&#25509;</span>
        <span style="color: #a0522d;">urls</span> = response.xpath(<span style="color: #8b2252;">'//div[@class="paginator"]//a/@href'</span>).re(r<span style="color: #8b2252;">'.*start=[24]0[^\d]+'</span>)
        <span style="color: #a020f0;">for</span> url <span style="color: #a020f0;">in</span> urls:
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*+'</span>*30)
            <span style="color: #483d8b;">print</span>(response.urljoin(url))
            <span style="color: #a020f0;">yield</span> scrapy.http.Request(response.urljoin(url)) <span style="color: #b22222;"># </span><span style="color: #b22222;">=&gt; &#22914;&#26524;&#26159;&#35831;&#27714;&#23601;&#36827;scheduler</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">request\None\item</span>
        <span style="color: #a0522d;">subjects</span> = response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>)
        <span style="color: #a020f0;">for</span> s <span style="color: #a020f0;">in</span> subjects:
            <span style="color: #a0522d;">title</span> = s.xpath(<span style="color: #8b2252;">'.//h2/a/text()'</span>).get(<span style="color: #8b2252;">''</span>).strip()
            <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> title: <span style="color: #a020f0;">continue</span>
            <span style="color: #a0522d;">rate</span> = s.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).get(<span style="color: #8b2252;">'0'</span>).strip()
            <span style="color: #a0522d;">item</span> = BookItem()
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'title'</span>] = title
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'rate'</span>] = rate
            <span style="color: #b22222;"># </span><span style="color: #b22222;">items.append(item)</span>
            <span style="color: #a020f0;">yield</span> item <span style="color: #b22222;"># </span><span style="color: #b22222;">=&gt; pipeline &#22914;&#26524;&#26159;item&#23601;&#36827;pipeline</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">return items # parse&#26041;&#27861;&#24517;&#39035;&#36820;&#22238;&#21487;&#36845;&#20195;&#23545;&#35937;</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response.status)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">with open('d:/tmp/book.html', 'wb') as f:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">f.write(response.body)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">titles = response.xpath('//li[@class="subject-item"]//h2/a/text()').extract() # SelectorList -&gt; list</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">for title in titles:</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">print(type(title), title.strip())</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a28491bc-7501-46cf-9b10-95012c1c3809" class="outline-2">
<h2 id="h:a28491bc-7501-46cf-9b10-95012c1c3809">爬取豆瓣读书项目</h2>
<div class="outline-text-2" id="text-h:a28491bc-7501-46cf-9b10-95012c1c3809">
</div>
<div id="outline-container-h:f8090dbd-150e-4cf8-8be3-7a65dd724379" class="outline-3">
<h3 id="h:f8090dbd-150e-4cf8-8be3-7a65dd724379">需求</h3>
<div class="outline-text-3" id="text-h:f8090dbd-150e-4cf8-8be3-7a65dd724379">
<p>
爬取豆瓣读书，并提取后续链接加入待爬取队列。
</p>
</div>
</div>
<div id="outline-container-h:fc4c9ea5-dbc2-4daf-a72e-8f70dcb7840c" class="outline-3">
<h3 id="h:fc4c9ea5-dbc2-4daf-a72e-8f70dcb7840c">链接分析</h3>
<div class="outline-text-3" id="text-h:fc4c9ea5-dbc2-4daf-a72e-8f70dcb7840c">
<ul class="org-ul">
<li>第一页 <a href="https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T">https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T</a></li>
<li>第二页 <a href="https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=20&amp;type=T">https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=20&amp;type=T</a></li>
</ul>

<p>
start 的值一直在变化。
</p>
</div>
</div>
<div id="outline-container-h:07f9ec8c-cdcc-4cad-a373-169cf0816355" class="outline-3">
<h3 id="h:07f9ec8c-cdcc-4cad-a373-169cf0816355">项目开发</h3>
<div class="outline-text-3" id="text-h:07f9ec8c-cdcc-4cad-a373-169cf0816355">
</div>
<div id="outline-container-h:d4e0cb82-1dc0-4ae3-99bd-147692763e58" class="outline-4">
<h4 id="h:d4e0cb82-1dc0-4ae3-99bd-147692763e58">创建项目</h4>
<div class="outline-text-4" id="text-h:d4e0cb82-1dc0-4ae3-99bd-147692763e58">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#39033;&#30446;</span>
(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy startproject books .
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0da9cf1a-c3d7-4345-94e9-370e09d5119e" class="outline-4">
<h4 id="h:0da9cf1a-c3d7-4345-94e9-370e09d5119e">配置 settings.py</h4>
<div class="outline-text-4" id="text-h:0da9cf1a-c3d7-4345-94e9-370e09d5119e">
<p>
D:\project\pyproj\pycharm\books\settings.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">BOT_NAME</span> = <span style="color: #8b2252;">"books"</span>

<span style="color: #a0522d;">SPIDER_MODULES</span> = [<span style="color: #8b2252;">"books.spiders"</span>]
<span style="color: #a0522d;">NEWSPIDER_MODULE</span> = <span style="color: #8b2252;">"books.spiders"</span>

<span style="color: #a0522d;">ADDONS</span> = {}

<span style="color: #a0522d;">USER_AGENT</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36"</span>

<span style="color: #a0522d;">ROBOTSTXT_OBEY</span> = <span style="color: #008b8b;">False</span>
<span style="color: #a0522d;">CONCURRENT_REQUESTS</span> = 4
<span style="color: #a0522d;">DOWNLOAD_DELAY</span> = 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#31186;&#29228;&#19968;&#27425;</span>
<span style="color: #a0522d;">COOKIES_ENABLED</span> = <span style="color: #008b8b;">False</span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#27425;&#20840;&#26032;&#30340;&#35831;&#27714;&#65307;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:559b7299-f4ae-4fdf-89d4-e0a2ffe5e75f" class="outline-4">
<h4 id="h:559b7299-f4ae-4fdf-89d4-e0a2ffe5e75f">编写 item</h4>
<div class="outline-text-4" id="text-h:559b7299-f4ae-4fdf-89d4-e0a2ffe5e75f">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BooksItem</span>(scrapy.Item):
    <span style="color: #a0522d;">title</span> = scrapy.Field()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20070;&#21517;</span>
    <span style="color: #a0522d;">rate</span> = scrapy.Field()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#25968;</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;BooksItem {}&gt; ~~"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">dict</span>(<span style="color: #a020f0;">self</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eed446f3-6556-40e8-a83b-59280f04c2a8" class="outline-4">
<h4 id="h:eed446f3-6556-40e8-a83b-59280f04c2a8">创建爬虫</h4>
<div class="outline-text-4" id="text-h:eed446f3-6556-40e8-a83b-59280f04c2a8">
<div class="org-src-container">
<pre class="src src-sh">scrapy genspider [-t template] &lt;name&gt; &lt;domain&gt;
</pre>
</div>

<p>
模板：-t 模板，这个选项可以使用一个模板来创建爬虫类，常用模板有 basic、crawl。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#27169;&#26495;&#21019;&#24314;spider&#65292;&#36825;&#37324;&#19981;&#29992;&#22522;&#30784;&#27169;&#26495;&#65292;&#32780;&#20351;&#29992;crawl&#27169;&#26495;</span>
(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy genspider -t crawl doubanbook douban.com
Created spider <span style="color: #8b2252;">'doubanbook'</span> using template <span style="color: #8b2252;">'crawl'</span><span style="color: #a020f0;"> in</span> module:
  books.spiders.doubanbook

./
 &#9500;&#9472; scrapy.cfg
 &#9492;&#9472; books
    &#9500;&#9472; items.py
     &#9500;&#9472; middlewares.py
     &#9500;&#9472; pipelines.py
     &#9500;&#9472; settings.py
     &#9500;&#9472; __init__.py
     &#9492;&#9472; spiders
         &#9500;&#9472; __init__.py
         &#9492;&#9472; doubanbook.py
(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy list 
doubanbook
</pre>
</div>

<p>
使用模板创建爬虫 ，得到如下代码：
</p>

<p>
D:\project\pyproj\pycharm\books\spiders\doubanbook.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.linkextractors <span style="color: #a020f0;">import</span> LinkExtractor
<span style="color: #a020f0;">from</span> scrapy.spiders <span style="color: #a020f0;">import</span> CrawlSpider, Rule


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">DoubanbookSpider</span>(CrawlSpider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"doubanbook"</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>]
    <span style="color: #a0522d;">start_urls</span> = [<span style="color: #8b2252;">"https://douban.com"</span>]

    <span style="color: #a0522d;">rules</span> = (Rule(LinkExtractor(allow=r<span style="color: #8b2252;">"Items/"</span>), callback=<span style="color: #8b2252;">"parse_item"</span>, follow=<span style="color: #008b8b;">True</span>),)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse_item</span>(<span style="color: #a020f0;">self</span>, response):
        <span style="color: #a0522d;">item</span> = {}
        <span style="color: #b22222;">#</span><span style="color: #b22222;">item["domain_id"] = response.xpath('//input[@id="sid"]/@value').get()</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">item["name"] = response.xpath('//div[@id="name"]').get()</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">item["description"] = response.xpath('//div[@id="description"]').get()</span>
        <span style="color: #a020f0;">return</span> item
</pre>
</div>

<p>
scrapy.spiders.crawl.CrawlSpider 是 scrapy.spiders.Spider 的子类，增强了功能。在其中可以使用 LinkExtractor、Rule。
</p>

<p>
规则 Rule 定义：
</p>
<ul class="org-ul">
<li>rules 元组里面定义多条规则 Rule，用规则来方便地跟进链接。</li>
<li>LinkExtractor 从 response 中提取链接。
<ul class="org-ul">
<li>allow 需要一个对象或可迭代对象，其中配置正则表达式，表示匹配什么链接，即只关心 &lt;a&gt; 标签。</li>
</ul></li>
<li>callback 定义匹配链接后执行的回调，特别注意 <b>不要使用 parse 这个名称</b> 。返回一个包含 Item 或 Request 对象的列表。
<ul class="org-ul">
<li>参考 <code>scrapy.spiders.crawl.CrawlSpider#_parse_response</code> 。</li>
</ul></li>
<li>follow 是否跟进链接。</li>
</ul>

<p>
由此得到一个本例程的规则，如下：
</p>

<p>
books\spiders\doubanbook.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.linkextractors <span style="color: #a020f0;">import</span> LinkExtractor
<span style="color: #a020f0;">from</span> scrapy.spiders <span style="color: #a020f0;">import</span> CrawlSpider, Rule
<span style="color: #a020f0;">from</span> scrapy.http <span style="color: #a020f0;">import</span> HtmlResponse
<span style="color: #a020f0;">from</span> ..items <span style="color: #a020f0;">import</span> BooksItem

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">DoubanbookSpider</span>(CrawlSpider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"dbbook"</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>]
    <span style="color: #a0522d;">start_urls</span> = [<span style="color: #8b2252;">"https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=0&amp;type=T"</span>]

    <span style="color: #a0522d;">rules</span> = (Rule(LinkExtractor(allow=r<span style="color: #8b2252;">"start=[24]0&amp;"</span>), callback=<span style="color: #8b2252;">"parse_item"</span>, follow=<span style="color: #008b8b;">False</span>),)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#30340;&#36215;&#22987;&#39029;&#21482;&#21040;&#37324;&#38754;&#25552;&#21462;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Link &lt;a href&#21305;&#37197;&#65292;&#21305;&#37197;&#21040;&#20102;&#26576;&#20010;href&#30340;&#38142;&#25509;&#65292;&#25165;&#31639;&#20320;&#24863;&#20852;&#36259;&#30340;&#38142;&#25509;&#65292;&#21152;&#20837;&#21040;&#24453;&#29228;&#21462;&#38431;&#21015;(&#21435;&#37325;)</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse_item</span>(<span style="color: #a020f0;">self</span>, response:HtmlResponse):
        <span style="color: #a020f0;">for</span> subject <span style="color: #a020f0;">in</span> response.xpath(<span style="color: #8b2252;">'//li[@class="subject-item"]'</span>):
            <span style="color: #a0522d;">item</span> = BooksItem()
            <span style="color: #a0522d;">title</span> = subject.xpath(<span style="color: #8b2252;">'.//h2/a//text()'</span>).extract()
            <span style="color: #b22222;"># </span><span style="color: #b22222;">['\n\n    &#32534;&#31243;&#19981;&#38590;\n\n\n    \n      ', ' : &#20840;&#24425;&#22270;&#35299; + &#24494;&#35838; + Python &#32534;&#31243; ', '\n\n  '] 9.5 +++</span>
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'title'</span>] = <span style="color: #8b2252;">''</span>.join(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:x.strip(), title)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21512;&#24182;&#21103;&#26631;&#39064;</span>
            <span style="color: #a0522d;">rate</span> = subject.xpath(<span style="color: #8b2252;">'.//span[@class="rating_nums"]/text()'</span>).get(<span style="color: #8b2252;">'0'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;&#35780;&#20998;&#40664;&#35748;&#32473;0</span>
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'rate'</span>] = rate
            <span style="color: #483d8b;">print</span>(title, rate, <span style="color: #8b2252;">'+++'</span>)
            <span style="color: #a020f0;">yield</span> item
</pre>
</div>

<ul class="org-ul">
<li>爬虫会首先爬取start_urls，按照规则Rule，会分析并抽取页面面内匹配的链接，并发起对这些链接的请求，任一请求响应后，执行回调函数parse_item</li>
<li>回调中response就是提取到的链接的页面请求返回的HTML，直接对这这个HTML使用xpath或css分析即可</li>
<li>follow决定着是否在回调函数parse_item中对response内容中的链接进行抽取，如果跟进则抽取加入到待爬取队列中</li>
</ul>
</div>
<div id="outline-container-h:400acf8d-c42f-4bea-895d-2fdc5637ce2f" class="outline-5">
<h5 id="h:400acf8d-c42f-4bea-895d-2fdc5637ce2f">爬取</h5>
<div class="outline-text-5" id="text-h:400acf8d-c42f-4bea-895d-2fdc5637ce2f">
<div class="org-src-container">
<pre class="src src-sh">scrapy crawl dbbook
</pre>
</div>

<p>
将follow改为True试一试。改成True，上面的代码只能爬取一页。
</p>
</div>
</div>
</div>
<div id="outline-container-h:10c6a941-9060-4b0a-95ba-df32c5e1ce6f" class="outline-4">
<h4 id="h:10c6a941-9060-4b0a-95ba-df32c5e1ce6f">MongoDB pipeline</h4>
<div class="outline-text-4" id="text-h:10c6a941-9060-4b0a-95ba-df32c5e1ce6f">
<p>
在settings.py中开启pipeline
</p>
<div class="org-src-container">
<pre class="src src-sh">ITEM_PIPELINES = {
   <span style="color: #8b2252;">"books.pipelines.BooksPipeline"</span>: 300,
}
</pre>
</div>

<p>
在settings.py末尾添加mongo配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">MongoDB</span>
MONGO_URI = <span style="color: #8b2252;">"mongodb://192.168.226.130:27017"</span>
MONGO_DATABASE = <span style="color: #8b2252;">"dbbooks"</span>
MONGO_COLLECTION = <span style="color: #8b2252;">"rates"</span>
</pre>
</div>

<p>
将数据存入MongoDB中
</p>

<p>
books\pipelines.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> itemadapter <span style="color: #a020f0;">import</span> ItemAdapter
<span style="color: #a020f0;">import</span> pymongo

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BooksPipeline</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, mongo_uri, mongo_db, mongo_collection):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">mongo_uri</span> = mongo_uri
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">mongo_db</span> = mongo_db
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">mongo_coll</span> = mongo_collection

    @<span style="color: #483d8b;">classmethod</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">from_crawler</span>(cls, crawler):
        <span style="color: #a020f0;">return</span> cls(
            mongo_uri=crawler.settings.get(<span style="color: #8b2252;">"MONGO_URI"</span>),
            mongo_db=crawler.settings.get(<span style="color: #8b2252;">"MONGO_DATABASE"</span>),
            mongo_collection=crawler.settings.get(<span style="color: #8b2252;">"MONGO_COLLECTION"</span>)
        )

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">open_spider</span>(<span style="color: #a020f0;">self</span>, spider):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">client</span> = pymongo.MongoClient(<span style="color: #a020f0;">self</span>.mongo_uri)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">db</span> = <span style="color: #a020f0;">self</span>.client[<span style="color: #a020f0;">self</span>.mongo_db]
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">coll</span> = <span style="color: #a020f0;">self</span>.db[<span style="color: #a020f0;">self</span>.mongo_coll]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">close_spider</span>(<span style="color: #a020f0;">self</span>, spider):
        <span style="color: #a020f0;">self</span>.client.close()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_item</span>(<span style="color: #a020f0;">self</span>, item, spider):
        <span style="color: #a020f0;">self</span>.coll.insert_one(ItemAdapter(item).asdict())
        <span style="color: #a020f0;">return</span> item
</pre>
</div>

<p>
修改Spider中rules中的allow的正则表达式为
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">books\spiders\doubanbook.py</span>
<span style="color: #a0522d;">rules</span> = (Rule(LinkExtractor(allow=r<span style="color: #8b2252;">"start=\d+"</span>), callback=<span style="color: #8b2252;">"parse_item"</span>, follow=<span style="color: #008b8b;">True</span>),)
</pre>
</div>

<p>
则可以返回一千条数据，豆瓣做了分页的限制 <a href="https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=1000&amp;type=T">https://book.douban.com/tag/%E7%BC%96%E7%A8%8B?start=1000&amp;type=T</a>。但是这样大规模集中爬取，会很快被网站禁止，所以需要 <b>反爬</b> 。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pymongo <span style="color: #a020f0;">import</span> MongoClient

<span style="color: #a0522d;">MONGO_URI</span> = <span style="color: #8b2252;">"mongodb://192.168.226.130:27017"</span>
<span style="color: #a0522d;">MONGO_DATABASE</span> = <span style="color: #8b2252;">"dbbooks"</span>
<span style="color: #a0522d;">MONGO_COLLECTION</span> = <span style="color: #8b2252;">"rates"</span>

<span style="color: #a0522d;">client</span> = MongoClient(MONGO_URI)
<span style="color: #a0522d;">db</span> = client[MONGO_DATABASE] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;</span>
<span style="color: #a0522d;">coll</span> = db[MONGO_COLLECTION] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#21512;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#26465;&#26597;&#35810;</span>
<span style="color: #483d8b;">print</span>(coll.find({}).count())  <span style="color: #b22222;"># </span><span style="color: #b22222;">1000</span>
</pre>
</div>

<p>
参考：<a href="https://docs.scrapy.org/en/latest/topics/item-pipeline.html#write-items-to-mongodb">https://docs.scrapy.org/en/latest/topics/item-pipeline.html#write-items-to-mongodb</a>
</p>
</div>
</div>
<div id="outline-container-h:d0d95e55-9d23-4396-8387-0eda07942819" class="outline-4">
<h4 id="h:d0d95e55-9d23-4396-8387-0eda07942819">代理</h4>
<div class="outline-text-4" id="text-h:d0d95e55-9d23-4396-8387-0eda07942819">
<p>
在爬取过程中，豆瓣使用了反爬策略，可能会出现以下现象：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">302&#21040;&#23433;&#20840;&#39029;&#38754;</span>
Status Code: 302 Moved Temporarily
Location: https://sec.douban.com/b?<span style="color: #a0522d;">r</span>=https://book.douban.comxxx
</pre>
</div>

<p>
这相当于封了 IP，所以，可以在爬取时使用代理来解决。
</p>

<p>
思路：在发起 HTTP 请求之前，会经过下载中间件，自定义一个下载中间件，在其中临时获取一个代理地址，然后再发起 HTTP 请求。
</p>

<p>
访问 <a href="https://myip.ipip.net/">https://myip.ipip.net/</a> 测试自己的出公网口IP
</p>

<p>
IP代理商
</p>
<ul class="org-ul">
<li><a href="https://h.wandouip.com/get/api">https://h.wandouip.com/get/api</a></li>
</ul>

<p>
1、下载中间件
</p>

<p>
仿照 middlewares.py 中的下载中间件BooksDownloaderMiddleware，编写 process_request阶段，返回 None。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> scrapy.http.request <span style="color: #a020f0;">import</span> Request
<span style="color: #a020f0;">import</span> random

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ProxyDownloaderMiddleware</span>:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#20195;&#29702;IP&#27744;&#65292;&#21487;&#20197;&#20174;&#32593;&#32476;&#25628;&#32034;&#65292;&#21487;&#20197;&#20174;&#37197;&#32622;&#25991;&#20214;&#20013;&#35835;&#21462;</span>
    <span style="color: #a0522d;">proxy_ip</span> = <span style="color: #8b2252;">'192.168.0.163'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20195;&#29702;ip</span>
    <span style="color: #a0522d;">proxy_port</span> = <span style="color: #8b2252;">'58591'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20195;&#29702;&#31471;&#21475;&#21495;</span>
    <span style="color: #a0522d;">proxies</span> = [
        f<span style="color: #8b2252;">'http://</span>{proxy_ip}<span style="color: #8b2252;">:</span>{proxy_port}<span style="color: #8b2252;">'</span>,
    ]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_request</span>(<span style="color: #a020f0;">self</span>, request: Request, spider):
        request.<span style="color: #a0522d;">meta</span>[<span style="color: #8b2252;">'proxy'</span>] = random.choice(<span style="color: #a020f0;">self</span>.proxies)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;proxy</span>
        <span style="color: #483d8b;">print</span>(request.url, request.meta[<span style="color: #8b2252;">'proxy'</span>])
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
</pre>
</div>
<p>
2、配置
</p>

<p>
在 settings.py 中配置：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">3&#31186;</span>
<span style="color: #a0522d;">DOWNLOAD_DELAY</span> = 3

<span style="color: #a0522d;">DOWNLOADER_MIDDLEWARES</span> = {
    <span style="color: #8b2252;">'spiderman.middlewares.ProxyDownloaderMiddleware'</span>: 125,
}
</pre>
</div>
<p>
增加一个测试用的 spider 类，如果代理设置成功，该爬虫返回的内容就会是当前代理的信息：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">books\spiders\iptest.py</span>
<span style="color: #a020f0;">import</span> scrapy

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">IPTestSpider</span>(scrapy.Spider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'test'</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">'ipip.net'</span>]
    <span style="color: #a0522d;">start_urls</span> = [<span style="color: #8b2252;">'http://myip.ipip.net/'</span>]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response, **kwargs):
        <span style="color: #a0522d;">text</span> = response.text
        <span style="color: #483d8b;">print</span>(1, <span style="color: #8b2252;">'--&gt;'</span>, text)
        <span style="color: #a020f0;">return</span> text
</pre>
</div>
<p>
执行
</p>
<div class="org-src-container">
<pre class="src src-sh">scrapy crawl test
</pre>
</div>
<p>
查看打印的内容，是不是代理的地址信息。如果代理测试成功，就可以继续下面的操作。
</p>

<p>
在 settings.py 中开启 pipeline：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">ITEM_PIPELINES</span> = {
   <span style="color: #8b2252;">"books.pipelines.BooksPipeline"</span>: 300,
}
</pre>
</div>

<p>
将数据存入 json 文件：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> json

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">BooksPipeline</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_item</span>(<span style="color: #a020f0;">self</span>, item, spider):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">item &#33719;&#21462;&#30340;item&#65307;spider &#33719;&#21462;&#35813;item&#30340;spider</span>
        <span style="color: #a020f0;">self</span>.jsonfile.write(json.dumps(<span style="color: #483d8b;">dict</span>(item)) + <span style="color: #8b2252;">',</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
        <span style="color: #a020f0;">return</span> item  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21521;&#21518;&#22788;&#29702;</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">open_spider</span>(<span style="color: #a020f0;">self</span>, spider):
        <span style="color: #a0522d;">filename</span> = <span style="color: #8b2252;">'e:/books.json'</span>

        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">jsonfile</span> = <span style="color: #483d8b;">open</span>(filename, <span style="color: #8b2252;">'w'</span>)
        <span style="color: #a020f0;">self</span>.jsonfile.write(<span style="color: #8b2252;">'[</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">close_spider</span>(<span style="color: #a020f0;">self</span>, spider):
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">self</span>.jsonfile:
            <span style="color: #a020f0;">self</span>.jsonfile.write(<span style="color: #8b2252;">']'</span>)
            <span style="color: #a020f0;">self</span>.jsonfile.close()
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:af0b40b4-cce2-4983-b73e-221dda4c5d07" class="outline-2">
<h2 id="h:af0b40b4-cce2-4983-b73e-221dda4c5d07">redis-py</h2>
<div class="outline-text-2" id="text-h:af0b40b4-cce2-4983-b73e-221dda4c5d07">
</div>
<div id="outline-container-h:edd42eff-5740-4a25-a18d-8c9be8185c7f" class="outline-3">
<h3 id="h:edd42eff-5740-4a25-a18d-8c9be8185c7f">官方</h3>
<div class="outline-text-3" id="text-h:edd42eff-5740-4a25-a18d-8c9be8185c7f">
<ul class="org-ul">
<li>文档 <a href="https://redis.io/docs/latest/develop/clients/redis-py/">https://redis.io/docs/latest/develop/clients/redis-py/</a></li>
<li>仓库 <a href="https://github.com/redis/redis-py">https://github.com/redis/redis-py</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:9a9bfafb-7543-4a08-857e-1151771a2ef1" class="outline-3">
<h3 id="h:9a9bfafb-7543-4a08-857e-1151771a2ef1">安装库</h3>
<div class="outline-text-3" id="text-h:9a9bfafb-7543-4a08-857e-1151771a2ef1">
<div class="org-src-container">
<pre class="src src-sh">pip install redis
</pre>
</div>
</div>
</div>
<div id="outline-container-h:445e81f7-bc9f-480a-917a-8b32f1aa5091" class="outline-3">
<h3 id="h:445e81f7-bc9f-480a-917a-8b32f1aa5091">普通连接</h3>
<div class="outline-text-3" id="text-h:445e81f7-bc9f-480a-917a-8b32f1aa5091">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">r</span> = redis.Redis(host=<span style="color: #8b2252;">'10.0.0.5'</span>, port=6379, decode_responses=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<ul class="org-ul">
<li>decode_responses 表示响应的结果是解码后的</li>
</ul>

<p>
指定密码
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">r</span> = redis.Redis(host=<span style="color: #8b2252;">'10.0.0.5'</span>, port=6379, password=<span style="color: #8b2252;">'111111'</span>)
</pre>
</div>

<p>
指定库
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">r</span> = redis.Redis(host=<span style="color: #8b2252;">'10.0.0.5'</span>, port=6379, password=<span style="color: #8b2252;">'111111'</span>, db=5)
</pre>
</div>

<p>
使用TLS连接Redis
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis

<span style="color: #a0522d;">r</span> = redis.Redis(
    host=<span style="color: #8b2252;">"10.0.0.5"</span>, port=6379,
    username=<span style="color: #8b2252;">"default"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">use your Redis user. More info https://redis.io/docs/latest/operate/oss_and_stack/management/security/acl/</span>
    password=<span style="color: #8b2252;">"secret"</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">use your Redis password</span>
    ssl=<span style="color: #008b8b;">True</span>,
    ssl_certfile=<span style="color: #8b2252;">"./redis_user.crt"</span>,
    ssl_keyfile=<span style="color: #8b2252;">"./redis_user_private.key"</span>,
    ssl_ca_certs=<span style="color: #8b2252;">"./redis_ca.pem"</span>,
)
</pre>
</div>

<p>
示例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis

<span style="color: #a0522d;">db</span> = redis.Redis(<span style="color: #8b2252;">'192.168.226.130'</span>, password=<span style="color: #8b2252;">'123456'</span>)
<span style="color: #483d8b;">print</span>(db)
<span style="color: #483d8b;">print</span>(db.keys(<span style="color: #8b2252;">'*'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#24403;&#21069;&#24211;&#30340;&#20013;keys</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23383;&#31526;&#20018; set get [key:str]</span>
db.<span style="color: #483d8b;">set</span>(<span style="color: #8b2252;">'t1'</span>, 0b01100010) <span style="color: #b22222;"># </span><span style="color: #b22222;">98 int</span>
<span style="color: #483d8b;">print</span>(db.get(<span style="color: #8b2252;">'t1'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">b'98'</span>

db.<span style="color: #483d8b;">set</span>(0b11, 0x63)
<span style="color: #483d8b;">print</span>(db.get(0b11)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#65292;&#25968;&#20540;&#20250;&#36716;&#25104;&#23383;&#31526;&#20018;</span>
<span style="color: #483d8b;">print</span>(db.get(3))    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#65292;&#25968;&#20540;&#20250;&#36716;&#25104;&#23383;&#31526;&#20018;</span>
<span style="color: #483d8b;">print</span>(db.get(<span style="color: #8b2252;">'3'</span>))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#65292;&#25968;&#20540;&#20250;&#36716;&#25104;&#23383;&#31526;&#20018;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d53a1a61-f006-4bac-a76c-6d9f86f98001" class="outline-3">
<h3 id="h:d53a1a61-f006-4bac-a76c-6d9f86f98001">通过地址池连接</h3>
<div class="outline-text-3" id="text-h:d53a1a61-f006-4bac-a76c-6d9f86f98001">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis

<span style="color: #b22222;"># </span><span style="color: #b22222;">pool=redis.ConnectionPool(host='10.0.0.5', db=2, password='111111')</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">pool = redis.ConnectionPool.from_url("redis://:111111@10.0.0.5/4")</span>
<span style="color: #a0522d;">pool</span> = redis.ConnectionPool.from_url(<span style="color: #8b2252;">"redis://:111111@10.0.0.5/4?decode_responses=True&amp;socket_timeout=10&amp;encoding=utf-8"</span>)
<span style="color: #a0522d;">r</span> = redis.Redis(connection_pool=pool)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;</span>
<span style="color: #a0522d;">r</span> = redis.Redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/8'</span>)
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis

<span style="color: #a0522d;">r</span> = redis.Redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/8'</span>)
<span style="color: #a0522d;">pool</span> = r.connection_pool
<span style="color: #483d8b;">print</span>(r.keys(<span style="color: #8b2252;">'*'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;&#21629;&#20196;&#29992;&#23436;&#20043;&#21518;&#25968;&#25454;&#23601;&#21448;&#22238;&#21040;&#20102;_available_connections&#21487;&#29992;&#36830;&#25509;&#20013;</span>
<span style="color: #483d8b;">print</span>(r.connection_pool)
<span style="color: #483d8b;">print</span>(pool._in_use_connections)
<span style="color: #483d8b;">print</span>(pool._available_connections[0])
<span style="color: #483d8b;">print</span>(pool._available_connections[0]._sock)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(r.keys(<span style="color: #8b2252;">'*'</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;&#21629;&#20196;&#29992;&#23436;&#20043;&#21518;&#25968;&#25454;&#23601;&#21448;&#22238;&#21040;&#20102;_available_connections&#21487;&#29992;&#36830;&#25509;&#20013;</span>
<span style="color: #483d8b;">print</span>(r.connection_pool)
<span style="color: #483d8b;">print</span>(pool._in_use_connections)
<span style="color: #483d8b;">print</span>(pool._available_connections[0])
<span style="color: #483d8b;">print</span>(pool._available_connections[0]._sock)

pool.disconnect()
</pre>
</div>

<p>
r.keys()方法每一次执行，代码中都会去获取一个连接池中的连接，命令执行后立即归还连接。
</p>
</div>
</div>
<div id="outline-container-h:b11531e1-5924-4482-95b0-c7afa7b4c39b" class="outline-3">
<h3 id="h:b11531e1-5924-4482-95b0-c7afa7b4c39b">Redis数据模型</h3>
<div class="outline-text-3" id="text-h:b11531e1-5924-4482-95b0-c7afa7b4c39b">
<p>
redis支持数据模型非常丰富
</p>

<p>
参考资料：<a href="https://redis.io/docs/latest/develop/data-types/">https://redis.io/docs/latest/develop/data-types/</a>
</p>
</div>
<div id="outline-container-h:3e2e935b-c250-4647-88d8-4caa44558998" class="outline-4">
<h4 id="h:3e2e935b-c250-4647-88d8-4caa44558998">键Key</h4>
<div class="outline-text-4" id="text-h:3e2e935b-c250-4647-88d8-4caa44558998">
<ul class="org-ul">
<li>Redis key需要一个二进制值，可以用任何二进制序列作为key值，可以是简单字符串，也可以是个JPEG文件的二精制序列。空字符串也有效率key值</li>
<li>key取值原则
<ol class="org-ol">
<li>键值不需要太长，消耗内存，而且查找这类键值的计算成本较高</li>
<li>键值不宜过短，可读性较差</li>
<li>习惯上key采用=user:123:password=  形式，表示用户id为123的用户的密码</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:c5ede1fd-d766-4920-b765-6d6cab0d7718" class="outline-4">
<h4 id="h:c5ede1fd-d766-4920-b765-6d6cab0d7718">字符串</h4>
<div class="outline-text-4" id="text-h:c5ede1fd-d766-4920-b765-6d6cab0d7718">
<ul class="org-ul">
<li>字符串是一种基本简单的Redis值类型。说是字符串，其实可以是任意可以序列化的数据。</li>
<li>一个字符串类型的值最多能存储*512M字节*的内容。</li>
</ul>
</div>
</div>
<div id="outline-container-h:a3d34cb4-fcfd-4891-9807-d2dad6f11519" class="outline-4">
<h4 id="h:a3d34cb4-fcfd-4891-9807-d2dad6f11519">查看帮助</h4>
<div class="outline-text-4" id="text-h:a3d34cb4-fcfd-4891-9807-d2dad6f11519">
<ul class="org-ul">
<li>使用redis-cli可以进入redis命令行界面</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&gt; Help &#26597;&#30475;&#24110;&#21161;
&gt; Help &lt;tab&gt; &#20351;&#29992;tab&#24314;&#20999;&#25442;&#24110;&#21161;
&gt; Help set &#26597;&#30475;set&#21629;&#20196;&#24110;&#21161;
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; help
redis-cli 8.2.0
To get help about Redis commands type:
      <span style="color: #8b2252;">"help @&lt;group&gt;"</span> to get a list of commands<span style="color: #a020f0;"> in</span> &lt;group&gt;
      <span style="color: #8b2252;">"help &lt;command&gt;"</span> for help on &lt;command&gt;
      <span style="color: #8b2252;">"help &lt;tab&gt;"</span> to get a list of possible help topics
      <span style="color: #8b2252;">"quit"</span> to exit

To set redis-cli preferences:
      <span style="color: #8b2252;">":set hints"</span> enable online hints
      <span style="color: #8b2252;">":set nohints"</span> disable online hints

<span style="color: #b22222;"># </span><span style="color: #b22222;">string&#31867;&#22411;&#21629;&#20196;</span>
127.0.0.1:6379&gt; help @string
<span style="color: #b22222;"># </span><span style="color: #b22222;">list&#21015;&#34920;&#30456;&#20851;&#30340;&#21629;&#20196;</span>
127.0.0.1:6379&gt; help @list
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a83a70a-d632-4ef4-9829-78d74dd9031a" class="outline-4">
<h4 id="h:0a83a70a-d632-4ef4-9829-78d74dd9031a">字符串设置</h4>
<div class="outline-text-4" id="text-h:0a83a70a-d632-4ef4-9829-78d74dd9031a">
<p>
语法：=SET key value [Ex seconds][PX milliseconds] [NX|XX]=  设置字符串值（设置单个键值）
</p>
<ol class="org-ol">
<li><code>EX</code> 设置过期时间，秒，等同于 <code>SETEX key seconds value</code></li>
<li><code>PX</code> 设置过期时间，毫秒，等同于 <code>PSETEX key millieconds value</code></li>
<li><code>NX</code> 键不存在，才能设置，等同于 <code>SETNX key value</code></li>
<li><code>XX</code> 键存在时，才能设置</li>
</ol>

<p>
设置多个键值 <code>MSET key value [key value ...]</code>  
</p>
<ul class="org-ul">
<li>设置多个键值字符串，key存在则覆盖，key不存在则增加。原子操作</li>
</ul>

<p>
<code>MSETNX key value [key value ...]</code>  可以不存在则设置，key存在则失败。nx指代不存在。也是原子操作命令。
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set s1 abc
OK
127.0.0.1:6379&gt; get s1
<span style="color: #8b2252;">"abc"</span>
127.0.0.1:6379&gt; mset s2 a s3 b s4 c
OK
127.0.0.1:6379&gt; keys *
1) <span style="color: #8b2252;">"xdd"</span>
2) <span style="color: #8b2252;">"3"</span>
3) <span style="color: #8b2252;">"s1"</span>
4) <span style="color: #8b2252;">"s2"</span>
5) <span style="color: #8b2252;">"s3"</span>
6) <span style="color: #8b2252;">"s4"</span>
127.0.0.1:6379&gt; msetnx s1 s
(integer) 0
127.0.0.1:6379&gt; get s1
<span style="color: #8b2252;">"abc"</span>
</pre>
</div>
</div>
<div id="outline-container-h:38ce878a-7850-4d0e-963a-73037b756cb9" class="outline-5">
<h5 id="h:38ce878a-7850-4d0e-963a-73037b756cb9">过期操作和生存时间</h5>
<div class="outline-text-5" id="text-h:38ce878a-7850-4d0e-963a-73037b756cb9">
<p>
Redis中可以给每个Key设置一个生存时间(秒或毫秒),当达到这个时长后，这些键值将会被自动删除
</p>

<p>
设置多少秒或者毫秒后过期
</p>
<ol class="org-ol">
<li><code>EXPIRE key seconds</code>  设置key多少秒后过期</li>
<li><code>PEXPIRE key milliseconds</code>  设置key多少毫秒后过期</li>
</ol>

<p>
设置在指定Unix时间戳过期
</p>
<ul class="org-ul">
<li><code>EXPIREAT key timestamp</code>   设置到指定时间戳后过期</li>
<li><code>PEXPIREAT key milliseconds-timestamp</code></li>
</ul>

<p>
持久key，即取消过期
</p>
<ul class="org-ul">
<li><code>PERSIST key</code>  持久key，即取消过期</li>
</ul>

<p>
<b>适用场景</b>
</p>
<ul class="org-ul">
<li>多少秒过期，例如一个缓存数据失效</li>
<li><code>PEXPIREAT key milliseconds-timestamp</code>  比如现在开始缓存数据，0点失效</li>
</ul>

<p>
Time to Live,key的剩余生存时间
</p>
<ul class="org-ul">
<li><code>TTL key</code>  查看key的剩余生存时间，秒级别</li>
<li><code>PTTL key</code>  查看key的剩余生存时间，毫秒级别</li>
<li>命令返回结果：
<ul class="org-ul">
<li>key存在但没有设置TTL，返回-1</li>
<li>key存在，但还在生存期内，返回剩余的秒或者毫秒</li>
<li>key曾经存在，但已经消亡，返回-2(2.8版本之前返回-1)</li>
</ul></li>
</ul>

<p>
示例一：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35774;&#32622;&#38190;&#20540;s5:abc 20 &#31186;&#21518;&#36807;&#26399;
<span style="color: #b22222;"># </span><span style="color: #b22222;">set s5 abc ex 20</span>
&#26597;&#30475;s5&#21097;&#20313;&#36807;&#26399;&#26102;&#38388;
<span style="color: #b22222;"># </span><span style="color: #b22222;">ttl s5</span>
127.0.0.1:6379[1]&gt; set s5 abc ex 20
OK
127.0.0.1:6379[1]&gt; ttl s5
(integer) 17
127.0.0.1:6379[1]&gt; ttl s5
(integer) 15
127.0.0.1:6379[1]&gt; ttl s5
(integer) 14
127.0.0.1:6379[1]&gt; ttl s5
(integer) 12
127.0.0.1:6379[1]&gt; ttl s5
(integer) 11
127.0.0.1:6379[1]&gt; ttl s5
(integer) -2
127.0.0.1:6379[1]&gt;1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">命令</th>
<th scope="col" class="org-left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>ttl s6</code></td>
<td class="org-left">查看key为s6的键过期时间，秒级别</td>
</tr>

<tr>
<td class="org-left"><code>pttl s6</code></td>
<td class="org-left">查看key为s6的键过期时间，毫秒级</td>
</tr>

<tr>
<td class="org-left"><code>setnx s6 6</code></td>
<td class="org-left">设置key为s6的值为6</td>
</tr>

<tr>
<td class="org-left"><code>expire s6 60</code></td>
<td class="org-left">设置key为s6的键60秒后过期</td>
</tr>

<tr>
<td class="org-left"><code>persist s6</code></td>
<td class="org-left">取消key为s6的过期时间，即永不过期</td>
</tr>

<tr>
<td class="org-left"><code>EXPIREAT cache 1355292000</code></td>
<td class="org-left">设置key为cache在1355292000(秒)时间戳后过期</td>
</tr>

<tr>
<td class="org-left"><code>PEXPIREAT cache 1555555555005</code></td>
<td class="org-left">设置key为cache在1555555555005(毫秒)时间戳后过期</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:05707e41-5b32-43f8-b77c-63621e04bbb4" class="outline-5">
<h5 id="h:05707e41-5b32-43f8-b77c-63621e04bbb4">key操作</h5>
<div class="outline-text-5" id="text-h:05707e41-5b32-43f8-b77c-63621e04bbb4">
<p>
语法：=keys pattern=  查询key
</p>
<ul class="org-ul">
<li>pattern可以取如下值：
<ol class="org-ol">
<li><code>*</code>  任意长度字符</li>
<li><code>?</code>  任意一个字符</li>
<li><code>[]</code>  字符集合，表示一个字符</li>
</ol></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">命令</th>
<th scope="col" class="org-left">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>keys *</code></td>
<td class="org-left">查看当前库中所有key键</td>
</tr>

<tr>
<td class="org-left"><code>keys s?</code></td>
<td class="org-left">查看当前库中以s开头，只有两个字符的key</td>
</tr>

<tr>
<td class="org-left"><code>keys s[13]</code></td>
<td class="org-left">查看当前库中以s开头，只有两个字符，且第二个字符时1或者3的key</td>
</tr>

<tr>
<td class="org-left"><code>keys s[1-3]</code></td>
<td class="org-left">查看当前库中以s开头，只有两个字符，且第二字符在[1,3]之间的key</td>
</tr>

<tr>
<td class="org-left"><code>keys s*</code></td>
<td class="org-left">查看当前库中以s开头的字符</td>
</tr>

<tr>
<td class="org-left"><code>keys ??</code></td>
<td class="org-left">查看当前库中是两个字符组成的key</td>
</tr>
</tbody>
</table>

<p>
其他相关命令
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">命令</td>
<td class="org-left">意义</td>
</tr>

<tr>
<td class="org-left"><code>TYPE key</code></td>
<td class="org-left">key类型</td>
</tr>

<tr>
<td class="org-left"><code>EXISTS key</code></td>
<td class="org-left">key是否存在</td>
</tr>

<tr>
<td class="org-left"><code>RENAME key newkey</code></td>
<td class="org-left">将key的建值重命名为newkey</td>
</tr>

<tr>
<td class="org-left"><code>RENAMENX key newkey</code></td>
<td class="org-left">将key的键值重命令为newkey</td>
</tr>

<tr>
<td class="org-left"><code>DEL key [key ...]</code></td>
<td class="org-left">将key键值对删除</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:f0ea1610-fdd9-49bd-a9f7-a26c99199024" class="outline-5">
<h5 id="h:f0ea1610-fdd9-49bd-a9f7-a26c99199024">字符串获取</h5>
<div class="outline-text-5" id="text-h:f0ea1610-fdd9-49bd-a9f7-a26c99199024">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">命令</td>
<td class="org-left">意义</td>
</tr>

<tr>
<td class="org-left"><code>GET key</code></td>
<td class="org-left">获取值</td>
</tr>

<tr>
<td class="org-left"><code>MGET key [key ...]</code></td>
<td class="org-left">获取多个给定的键的值</td>
</tr>

<tr>
<td class="org-left"><code>GETSET key value</code></td>
<td class="org-left">返回旧值并设置新值，如果键不存在，就创建并赋值</td>
</tr>

<tr>
<td class="org-left"><code>STRLEN key</code></td>
<td class="org-left">获取key的value字符串长度</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; keys *
1) <span style="color: #8b2252;">"xdd"</span>
2) <span style="color: #8b2252;">"3"</span>
3) <span style="color: #8b2252;">"s2"</span>
4) <span style="color: #8b2252;">"s3"</span>
5) <span style="color: #8b2252;">"s4"</span>
127.0.0.1:6379&gt; get s4
<span style="color: #8b2252;">"c"</span>
127.0.0.1:6379&gt; mget s2 s3 s1
1) <span style="color: #8b2252;">"a"</span>
2) <span style="color: #8b2252;">"b"</span>
3) (nil)
127.0.0.1:6379&gt; strlen s2
(integer) 1
127.0.0.1:6379&gt; getset s5 100
(nil)
127.0.0.1:6379&gt; get s5
<span style="color: #8b2252;">"100"</span>
127.0.0.1:6379&gt; keys *
1) <span style="color: #8b2252;">"xdd"</span>
2) <span style="color: #8b2252;">"3"</span>
3) <span style="color: #8b2252;">"s2"</span>
4) <span style="color: #8b2252;">"s3"</span>
5) <span style="color: #8b2252;">"s4"</span>
6) <span style="color: #8b2252;">"s5"</span>
127.0.0.1:6379&gt;1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:442907e1-0030-4d7a-b63c-4c7518efb03c" class="outline-5">
<h5 id="h:442907e1-0030-4d7a-b63c-4c7518efb03c">字符串操作</h5>
<div class="outline-text-5" id="text-h:442907e1-0030-4d7a-b63c-4c7518efb03c">
<p>
追加字符串
</p>
<ol class="org-ol">
<li><code>APPEND key value</code>    追加字符串。如果键存在就追加；如果不存在就等同于=  SET key value=</li>
</ol>

<p>
获取子字符串
</p>
<ol class="org-ol">
<li><code>GETRANGE key start end</code>  索引值从0开始，支持负索引，-1表示最后一个字符。范围是[start,end],start必须在end的左边，否则返回空串</li>
</ol>

<p>
覆盖字符串
</p>
<ol class="org-ol">
<li><code>SETRANGE key offset value</code>  从指定索引处开始覆盖字符串，返回覆盖后字符串长度。key不存在会创建新的。</li>
</ol>

<p>
简单示例
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; select 1
OK
127.0.0.1:6379[1]&gt; keys *
(empty list or set)
127.0.0.1:6379[1]&gt; append s2 abc
(integer) 3
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc"</span>
127.0.0.1:6379[1]&gt; append s2 efg
(integer) 6
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abcefg"</span>
127.0.0.1:6379[1]&gt; getrange s2 1 3
<span style="color: #8b2252;">"bce"</span>
127.0.0.1:6379[1]&gt; getrange s2 0 -1
<span style="color: #8b2252;">"abcefg"</span>
127.0.0.1:6379[1]&gt; setrange s2 3 12
(integer) 6
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc12g"</span>
127.0.0.1:6379[1]&gt; setrange s2 -1 123456
(error) ERR offset is out of range
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc12g"</span>
127.0.0.1:6379[1]&gt; setrange s2 3 123456789
(integer) 12
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc123456789"</span>
127.0.0.1:6379[1]&gt; setrange s7 3 abc
(integer) 6
127.0.0.1:6379[1]&gt; get s7
<span style="color: #8b2252;">"\x00\x00\x00abc"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7b652d57-fb84-40e1-80a4-df3b2f86b781" class="outline-5">
<h5 id="h:7b652d57-fb84-40e1-80a4-df3b2f86b781">自增、自减</h5>
<div class="outline-text-5" id="text-h:7b652d57-fb84-40e1-80a4-df3b2f86b781">
<ul class="org-ul">
<li><code>INCR key</code>  将key键对应的值增加1.必须是integer类型</li>
<li><code>DECR key</code>  将key键对应的值减少1，必须是integer类型</li>
<li><code>INCRby key decrement</code>  将key键对应的值增加decrement。
<ol class="org-ol">
<li>decrement是数字，可以为正负</li>
<li>key对应的value必须是integer类型</li>
</ol></li>

<li><code>DECRBY key decrement</code>  将key键对应的值减少加decrement。
<ul class="org-ul">
<li>decrement是数字，可以为正负</li>
<li>key对应的value必须是integer类型</li>
</ul></li>

<li>简单示例</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379[1]&gt; flushdb
OK
127.0.0.1:6379[1]&gt; keys *
(empty list or set)
127.0.0.1:6379[1]&gt; set s1 ab1
OK
127.0.0.1:6379[1]&gt; set s2 4
OK
127.0.0.1:6379[1]&gt; incr s1
(error) ERR value is not an integer or out of range
127.0.0.1:6379[1]&gt; incr s2
(integer) 5
127.0.0.1:6379[1]&gt; incr s3
(integer) 1
127.0.0.1:6379[1]&gt; incr s2
(integer) 6
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"6"</span>
127.0.0.1:6379[1]&gt; keys *
1) <span style="color: #8b2252;">"s3"</span>
2) <span style="color: #8b2252;">"s2"</span>
3) <span style="color: #8b2252;">"s1"</span>
127.0.0.1:6379[1]&gt; get s3
<span style="color: #8b2252;">"1"</span>
127.0.0.1:6379[1]&gt; incrby s2 -10
(integer) -4
127.0.0.1:6379[1]&gt; incrby s2 8
(integer) 4
127.0.0.1:6379[1]&gt; decrby s2 -10
(integer) 14
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"14"</span>
127.0.0.1:6379[1]&gt;1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.29.30.31.32.33.
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6512e200-5646-4f59-8455-634a3124461a" class="outline-4">
<h4 id="h:6512e200-5646-4f59-8455-634a3124461a">库操作</h4>
<div class="outline-text-4" id="text-h:6512e200-5646-4f59-8455-634a3124461a">
<p>
<code>redis-cli --help</code>   #查看帮助
</p>

<p>
<code>redis-cli -n 2</code>   # 登录到第2号库
</p>
<ul class="org-ul">
<li>登录后命令上中切换库
<ol class="org-ol">
<li><code>SELECT n</code>  选择第n号库</li>
<li><code>FLUSHDB</code>   清除 <b>当前库</b> 数据</li>
<li><code>FLUSHALL</code>  清除 <b>所有库</b> 中的数据</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:c34bd979-a8bf-4071-b2ae-13e5f44b910c" class="outline-4">
<h4 id="h:c34bd979-a8bf-4071-b2ae-13e5f44b910c">位图bitmap</h4>
<div class="outline-text-4" id="text-h:c34bd979-a8bf-4071-b2ae-13e5f44b910c">
<p>
位图不是真正的数类型，它是定义在字符串类型上，只不过把字符串按位操作
</p>

<p>
一个字符串类型的值最多能存储512M字节的内容，可以表示 \(2^{32}\) 位
</p>

<ol class="org-ol">
<li>位上限：
<ul class="org-ul">
<li>\(512 = 2^9\)</li>
<li>\(1M = 1024 \times 1024 = 2^{10+10}\)</li>
<li>\(1Byte = 8bit = 2^{3bit}\)</li>
<li>\(2^{9+10+10+3} = 2^{32}b = 4294967296b\), 接近43忆个位</li>
</ul></li>

<li><code>SETBIT key offset value</code>  设置某一位上的值
<ol class="org-ol">
<li>offset 偏移量，从0开始</li>
<li>value不写，默认是0，只能是0或1</li>
</ol></li>

<li><code>GETBIT key offset</code>  获取某一位上的值</li>
<li><code>BITPOS key bit [start][end]</code>  返回指定值bit[0或者1]在指定区间上第一次出现的位置</li>
<li><code>BITCOUNT key [start] [end]</code>  统计指针位区间上值为1的个数，从左向右从0开始，从右向左从-1开始，注意：官方start,end指的是字节的索引。
<ul class="org-ul">
<li><code>BITCOUNT testkey 0 0</code>  <b>表示从索引为0个字节到索引为0个字节，就是第一个字节的统计</b></li>
<li><code>BITCOUNT testkey 0 -1</code>    等同于=BITCOUNT testkey=</li>
<li>最常用的是 <code>BITCOUNT testkey</code></li>
</ul></li>
</ol>


<p>
示例：
</p>

<div class="org-src-container">
<pre class="src src-sh">0 1 2 3 4 5 6 7 &#32034;&#24341;&#20301;
  1 1         1
----------------- 16&#36827;&#21046;
6 1  <span style="color: #b22222;"># </span><span style="color: #b22222;">0x61=a</span>
127.0.0.1:6379&gt; setbit s1 7 1
(integer) 0
127.0.0.1:6379&gt; setbit s1 1 1
(integer) 0
127.0.0.1:6379&gt; setbit s1 2 1
(integer) 0
127.0.0.1:6379&gt; get s1
<span style="color: #8b2252;">"a"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23383;&#31526;&#20018;7 &#30340;16&#36827;&#21046;&#20026;37. &#21363; 0011 0111</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">0 1 2 3 4 5 6 7  #&#32034;&#24341;&#20301;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">0 0 1 1 0 1 1 1  #&#20108;&#36827;&#21046;</span>
127.0.0.1:6379&gt; set s2 7  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25442;&#20026;&#23383;&#31526;&#20018;7&#65292;&#23545;&#24212;16&#36827;&#21046;&#20026;0x37</span>
OK
127.0.0.1:6379&gt; getbit s2 0 <span style="color: #b22222;">#</span>
(integer) 0
127.0.0.1:6379&gt; getbit s2 1
(integer) 0
127.0.0.1:6379&gt; getbit s2 2
(integer) 1
127.0.0.1:6379&gt; getbit s2 3
(integer) 1
127.0.0.1:6379&gt; getbit s2 4
(integer) 0
127.0.0.1:6379&gt; getbit s2 5
(integer) 1
127.0.0.1:6379&gt; BITCOUNT s2 <span style="color: #b22222;">#</span><span style="color: #b22222;">5 &#32479;&#35745;1&#30340;&#20010;&#25968;</span>
(integer) 5
127.0.0.1:6379&gt; bitpos s2 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#31532;&#19968;&#27425;&#20986;&#29616;&#30340;&#32034;&#24341;</span>
(integer) 2

127.0.0.1:6379&gt; set str1 abc
OK
127.0.0.1:6379&gt; setbit str1 6 1
(integer) 0
127.0.0.1:6379&gt; setbit str1 7 0
(integer) 1
127.0.0.1:6379&gt; get str1
<span style="color: #8b2252;">"bbc"</span>

127.0.0.1:6379[1]&gt; SETBIT ss 2 1
(integer) 0
127.0.0.1:6379[1]&gt; SETBIT ss 18 1
(integer) 0
127.0.0.1:6379[1]&gt; get ss
<span style="color: #8b2252;">" \x00 "</span>
127.0.0.1:6379[1]&gt; BITPOS ss 1
(integer) 2
127.0.0.1:6379[1]&gt; BITPOS ss 1 1
(integer) 18
127.0.0.1:6379[1]&gt; BITPOS ss 1 2
(integer) 18
127.0.0.1:6379[1]&gt; BITPOS ss 1 3
(integer) -1
127.0.0.1:6379[1]&gt; STRLEN ss
(integer) 3
</pre>
</div>
</div>
<div id="outline-container-h:4dbd62eb-0655-4aa9-87b6-66a17a4f2d39" class="outline-5">
<h5 id="h:4dbd62eb-0655-4aa9-87b6-66a17a4f2d39">位操作</h5>
<div class="outline-text-5" id="text-h:4dbd62eb-0655-4aa9-87b6-66a17a4f2d39">
<ul class="org-ul">
<li>对于一个或多个保存二进制位的字符串key进行位元操作，并将结果保存到destkey上operation可以是AND、OR、NOT、XOR这四种操作中的任意一种</li>
<li><code>BITOP AND destkey key [key ...]</code>  对一个或多个key求 <b>位与</b> ，并将结果保存到destkey</li>
<li><code>BITOP OR destkey key [key ...]</code>  对一个或多个key求 <b>位或</b> ，并将结果保存到destkey</li>
<li><code>BITOP XOR destkey key [key ...]</code>  对一个或多个key求 <b>位异或</b>, 并将结果保存到destkey</li>
<li><code>BITOP NOT destkey key</code>  对给定key求 <b>逻辑非</b> ，并将结果保存到destkey</li>
<li>除了NOT操作之外，其他操作都可以接受一个或多个key作为输入，当BITOP处理不同长度的字符串时，较短的那个字符串所缺少的部分会被看作0.空的key也被看作是包含0的字符串序列</li>
</ul>

<p>
示例：a位或b
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set s1 a
OK
127.0.0.1:6379&gt; set s2 b
OK
127.0.0.1:6379&gt; BITOP OR ss s1 s2
(integer) 1
127.0.0.1:6379&gt; get ss
<span style="color: #8b2252;">"c"</span>

a a
b 0x0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#32034;&#24341;&#23545;&#40784;</span>
------- <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25353;&#20301;&#25110;  &#30456;&#24403;&#20110;&#30456;&#21152;</span>
c a
127.0.0.1:6379&gt; set s5 aa
OK
127.0.0.1:6379&gt; set s6 b
OK
127.0.0.1:6379&gt; bitop or s7 s5 s6
(integer) 2
127.0.0.1:6379&gt; get s7
<span style="color: #8b2252;">"ca"</span>


127.0.0.1:6379&gt; set s3 &#20013;
OK
127.0.0.1:6379&gt; get s3
<span style="color: #8b2252;">"\xe4\xb8\xad"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">utf-8</span>
127.0.0.1:6379&gt; BITCOUNT s3
(integer) 13
</pre>
</div>

<p>
位图练习:
</p>
<ol class="org-ol">
<li>指定时间段内(月、年)网站用户上线次数统计(活跃用户)</li>
<li>按天统计网站活跃用户</li>
</ol>

<p>
参考
1、指定时间段内(月、年)网站用户上线次数统计(活跃用户)
</p>
<ul class="org-ul">
<li>为每一个用户做上线记录，某天登陆就标记一次。</li>
<li>用户ID为key，天作为offset，上线置为1，ID为500的用户，今年的第一天上线，第30天上线：</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">setbit u:500 1 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#20301;&#22270;&#26631;&#35760;&#65292;&#19978;&#32447;&#19968;&#27425;&#22312;&#23545;&#24212;&#22825;&#25968;&#19978;&#26631;&#35760;&#19968;&#27425;</span>
setbit u:500 30 1
bitcount u:500 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#19968;&#20849;&#19978;&#32447;&#27425;&#25968;</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh">import redis

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38142;&#25509;redis&#25968;&#25454;&#24211;</span>
db = redis.Redis(<span style="color: #8b2252;">"192.168.61.109"</span>,6379,<span style="color: #a0522d;">db</span>=2)
<span style="color: #0000ff;">print</span>(db.keys(<span style="color: #8b2252;">"*"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;keys</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">user1</span>
<span style="color: #0000ff;">db.setbit</span>(<span style="color: #8b2252;">"u:1"</span>,1,1) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#22825;&#30331;&#24405;&#65292;&#26631;&#35760;&#19968;&#27425;</span>
<span style="color: #0000ff;">db.setbit</span>(<span style="color: #8b2252;">"u:1"</span>,30,1) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;30&#22825;&#30331;&#38470;&#65292;&#26631;&#35760;&#19968;&#27425;</span>
<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">"id&#20026;500&#30340;&#29992;&#25143;&#30331;&#24405;&#27425;&#25968;&#65306;"</span>,db.bitcount(<span style="color: #8b2252;">"u:500"</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">user2</span>
<span style="color: #0000ff;">db.setbit</span>(<span style="color: #8b2252;">"u:2"</span>,110,1)
<span style="color: #0000ff;">db.setbit</span>(<span style="color: #8b2252;">"u:2"</span>,300,1)

<span style="color: #b22222;"># </span><span style="color: #b22222;">user101&#65292;&#27169;&#25311;&#30331;&#24405;&#65292;&#27599;3&#22825;&#30331;&#38470;&#19968;&#27425;</span>
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> range(3,365,3):
    db.setbit(<span style="color: #8b2252;">"u:101"</span>,i,1)

<span style="color: #b22222;"># </span><span style="color: #b22222;">user102,&#27169;&#25311;&#30331;&#24405;&#65292;&#27599;2&#22825;&#30331;&#38470;&#19968;&#27425;</span>
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> range(3,365,2):
    db.setbit(<span style="color: #8b2252;">"u:102"</span>,i,1)

userlist = db.keys(<span style="color: #8b2252;">"u*"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#25152;&#26377;&#29992;&#25143;&#30331;&#24405;&#20449;&#24687;</span>
<span style="color: #0000ff;">print</span>(userlist)

active = [] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#27963;&#36291;&#29992;&#25143;</span>
inactive = [] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#38750;&#27963;&#36291;&#29992;&#25143;</span>

<span style="color: #a020f0;">for</span> u<span style="color: #a020f0;"> in</span> userlist:
    logincount = db.bitcount(u)
    <span style="color: #a020f0;">if</span> logincount &gt;100:
        active.append(u)
    <span style="color: #a020f0;">else</span>:
        inactive.append(u)

<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">"&#27963;&#36291;&#29992;&#25143;&#20026;&#65306;{}"</span>.format(active))
<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">"&#38750;&#27963;&#36291;&#29992;&#25143;&#20026;&#65306;{}"</span>.format(inactive))
</pre>
</div>

<p>
2、按天统计网站活跃用户
</p>
<ul class="org-ul">
<li>这是日活、周活、月活等统计。天作为key,用户ID为offset，上线设置为1</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27573;&#26102;&#38388;&#20869;&#27963;&#36291;&#29992;&#25143;&#25968;&#65306;</span>
setbit 20160602 15 1
setbit 20160601 123 1
setbit 20160606 123 1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27714;6&#26376;1&#26085;&#21040;6&#26376;10&#26085;&#30340;&#27963;&#36291;&#29992;&#25143;</span>
BITOP OR 20160601-10 20160601 20160602 20160603 20160610
bitcount 20160601-10 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26524;&#20026;2</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; setbit 20160602 15 1
(integer) 0
127.0.0.1:6379&gt; setbit 20160601 123 1
(integer) 0
127.0.0.1:6379&gt; setbit 20160606 123 1
(integer) 0
127.0.0.1:6379&gt; BITOP OR 20160601-10 20160601 20160602 20160603 20160610 
(integer) 16
127.0.0.1:6379&gt; bitcount 20160601-10
(integer) 2
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8f5fdfee-9911-4d17-9111-5e75ed62bfb9" class="outline-4">
<h4 id="h:8f5fdfee-9911-4d17-9111-5e75ed62bfb9">List列表</h4>
<div class="outline-text-4" id="text-h:8f5fdfee-9911-4d17-9111-5e75ed62bfb9">
<ul class="org-ul">
<li>其列表是基于双向链表实现，列表头尾增删快，中间增删慢</li>
<li>元素是字符串类型</li>
<li>元素可以重复出现</li>
<li>索引支持正索引和负索引，从左至右从0开始，从右至左从-1开始</li>
</ul>

<p>
命令说明
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字母</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>B</code></td>
<td class="org-left">Block阻塞</td>
</tr>

<tr>
<td class="org-left"><code>L</code></td>
<td class="org-left">Left左起，或指列表</td>
</tr>

<tr>
<td class="org-left"><code>R</code></td>
<td class="org-left">Right右起</td>
</tr>

<tr>
<td class="org-left"><code>X</code></td>
<td class="org-left">exist存在</td>
</tr>
</tbody>
</table>

<p>
<b>查看长度</b>
</p>
<ul class="org-ul">
<li><code>LLEN key</code>  返回列表元素个数</li>
</ul>

<p>
<b>添加元素</b>
</p>
<ul class="org-ul">
<li><code>LPUSH key value [value ...]</code>  从左边向队列中压入元素</li>
<li><code>LPUSHX key value</code>  从左边向队列加入元素，要求key必须存在(即列表已经存在)</li>
<li><code>RPUSH key value [value ...]</code>  从右边向队列中压如数据</li>
<li><code>RPUSHX key value</code>  要求key存在(即列表已经存在)，从右边向队列中加入元素</li>
<li><code>LINSERT key BEFORE|AFTER pivot value</code>  在列表中某个存在的值(pivot)前后后插入元素一次，key或pivot不存在，不进行任何操作</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; rpush lst 1 2 3 4 5
(integer) 5
127.0.0.1:6379&gt; lrange lst 0 -1
1) <span style="color: #8b2252;">"1"</span>
2) <span style="color: #8b2252;">"2"</span>
3) <span style="color: #8b2252;">"3"</span>
4) <span style="color: #8b2252;">"4"</span>
5) <span style="color: #8b2252;">"5"</span>
127.0.0.1:6379&gt; LINSERT lst after 2 python
(integer) 6
127.0.0.1:6379&gt; lrange lst 0 -1
1) <span style="color: #8b2252;">"1"</span>
2) <span style="color: #8b2252;">"2"</span>
3) <span style="color: #8b2252;">"python"</span>
4) <span style="color: #8b2252;">"3"</span>
5) <span style="color: #8b2252;">"4"</span>
6) <span style="color: #8b2252;">"5"</span>
127.0.0.1:6379&gt; LINSERT lst before 2 ruby
(integer) 7
127.0.0.1:6379&gt; lrange lst 0 -1
1) <span style="color: #8b2252;">"1"</span>
2) <span style="color: #8b2252;">"ruby"</span>
3) <span style="color: #8b2252;">"2"</span>
4) <span style="color: #8b2252;">"python"</span>
5) <span style="color: #8b2252;">"3"</span>
6) <span style="color: #8b2252;">"4"</span>
7) <span style="color: #8b2252;">"5"</span>
</pre>
</div>

<p>
<b>弹出元素</b>
</p>
<ul class="org-ul">
<li><code>LPOP key</code>  从左边弹出列表中一个元素</li>
<li><code>RPOP key</code>  从右边弹出列表中一个元素</li>
<li><code>RPOPLPUSH source destination</code>  从源列表中右边pop一个元素，从左边加入到目标列表
<ul class="org-ul">
<li>source 源列表，需要从右边弹出一个元素的列表</li>
<li>destination 目标列表，需要从左边加入元素的列表</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; lpush s1 1 2 3 4 5 6
(integer) 6
127.0.0.1:6379&gt; lpop s1
<span style="color: #8b2252;">"6"</span>
127.0.0.1:6379&gt; lpush s2 11 12 13
(integer) 3
127.0.0.1:6379&gt; RPOPLPUSH s1 s2
<span style="color: #8b2252;">"1"</span>
127.0.0.1:6379&gt; RPOPLPUSH s1 s2
<span style="color: #8b2252;">"2"</span>
127.0.0.1:6379&gt; rpop s2
<span style="color: #8b2252;">"11"</span>
127.0.0.1:6379&gt; lpop s2
<span style="color: #8b2252;">"2"</span>
127.0.0.1:6379&gt; lpop s2
<span style="color: #8b2252;">"1"</span>
</pre>
</div>

<p>
<b>元素访问与修改</b>
</p>
<ul class="org-ul">
<li><code>LRANGE key start stop</code>    返回列表中指定访问的元素，例如 <code>LRANGE user 0 -1</code></li>
<li><code>LINDEX key index</code>  返回列表中指定索引位置的元素</li>
<li><code>LSET key index value</code>  设置列表中指定索引位置的元素值，index不能超界</li>
</ul>

<p>
<b>移除元素</b>
</p>
<ul class="org-ul">
<li><code>LREM key count value</code>  从左边删除列表中与value相等的元素删除count个
<ul class="org-ul">
<li>count&gt;0 从左至右搜索，移除与value相等的元素，数量至多为count次</li>
<li>count&lt;0 从右至左搜索，移除与value相等的元素，数量至多为-count次</li>
<li>count = 0 移除列表中所有value值</li>
</ul></li>

<li><code>LTRIM key start stop</code>  去除指定 <b>范围外</b> 的元素
<ul class="org-ul">
<li>保留范围区间[start,stop]其余全部移除</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">RPUSH listkey c abc c ab 123 ab bj ab redis list
LTRIM listkey 0 -1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20160;&#20040;&#37117;&#27809;&#26377;&#21435;&#38500;</span>
LTRIM listkey 1 -1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21435;&#25481;&#24038;&#36793;&#22836;</span>
LTRIM listkey 1 10000
</pre>
</div>

<ul class="org-ul">
<li>LINSERT key BEFORE|AFTER pivot value在列表中某个存在的值(pivot)前或后插入元素一次，key或pivot不存在,不进行任何操作</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">RPUSH Ist 1 23428
LINSERT Ist AFTER 2 Python <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;lst&#20013;2&#21518;&#38754;&#25554;&#20837;Python</span>
LINSERT Ist BEFORE 2 Ruby
</pre>
</div>

<p>
<b>阻塞</b>
</p>
<ul class="org-ul">
<li>如果弹出的列表不存在或者为空，就会*阻塞*</li>
<li>超时时间设置为0，就是永久阻塞，直到有数据可以弹出</li>
<li>如果多个客户端阻塞就在同一个列表上，使用First In First Service原则，先到先服务</li>
<li><code>BLPOP key [key ...] timeout</code>  列表右边阻塞弹出一个元素。
<ul class="org-ul">
<li>key列表键名</li>
<li>timeout是超时秒数，为0表示永久阻塞</li>
<li>返回弹出列表名和弹出的值，如果有多个列表，会优先从第一个列表中弹出。</li>
</ul></li>
<li><code>BRPOP key [key ...] timeout</code>  列表右边阻塞弹出一个元素</li>
<li><code>BRPOPLPUSH source destination timeout</code>  从一个列表尾部阻塞弹出元素压入到另一个列表的头部</li>
</ul>

<p>
应用场景
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#24335;&#28040;&#24687;&#38431;&#21015;</span>
BLPOP MyQueue 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;&#33719;&#21462;</span>
RPUSH MyQueue hello <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21521;&#28040;&#24687;&#38431;&#21015;&#28155;&#21152;&#20540;</span>
</pre>
</div>

<p>
应用：微博某贴最后评论的50条
</p>

<div class="org-src-container">
<pre class="src src-sh">LPUSH u1234:forumid:comments <span style="color: #8b2252;">"&#36825;&#26159;&#31532;1&#26465;&#35780;&#35770;"</span>
LPUSH u1234:forumid:comments <span style="color: #8b2252;">"&#36825;&#26159;&#31532;2&#26465;&#35780;&#35770;"</span>
LPUSH u1234:forumid:comments <span style="color: #8b2252;">"&#36825;&#26159;&#31532;3&#26465;&#35780;&#35770;"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;LTRIM&#21407;&#22240;&#26159;&#65292;&#33719;&#21462;&#21518;&#21487;&#20197;&#28165;&#26970;&#22810;&#20313;&#23384;&#25918;&#22312;redis&#20013;&#30340;&#35780;&#35770;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b55a4e37-6a72-4f77-9443-2f74c4b4c511" class="outline-4">
<h4 id="h:b55a4e37-6a72-4f77-9443-2f74c4b4c511">hash散列</h4>
<div class="outline-text-4" id="text-h:b55a4e37-6a72-4f77-9443-2f74c4b4c511">
<p>
值是由field和value组成的map键值对
</p>

<p>
field和value都是字符串类型
</p>

<p>
设置key
</p>
<ul class="org-ul">
<li><code>HSET key field value</code>  设置单个字段。field不存在就创建，存在覆盖value</li>
<li><code>HSETNX key field value</code>  设置单个字段，要求field不存在。如果key不存在，相当于field也不存在</li>
<li><code>HMSET key field value [field value ...]</code>  设置多个字段</li>
</ul>

<p>
长度和判断
</p>
<ul class="org-ul">
<li><code>HLEN key</code>  返回字段个数</li>
<li><code>HSTRLEN key field</code></li>
<li><code>HEXISTS key field</code>  判断字段是否存在。key或者field不存在，返回0</li>
</ul>

<p>
获取值
</p>
<ul class="org-ul">
<li><code>HGET key field</code>  返回字段值</li>
<li><code>HMGET key field [field ...]</code>  返回多个字段值</li>
<li><code>HGETALL key</code>  返回所有的键值对</li>
<li><code>HKEYS key</code>  返回所有字段名</li>
<li><code>HVALS key</code>  返回所有值</li>
</ul>

<p>
计算
</p>
<ul class="org-ul">
<li><code>HINCRBY key field increment</code>  在字段对应的值上进行整数的增量计算</li>
<li><code>HINCRBYFLOAT key field increment</code>  在字段对应的值上进行浮点数的增量计算</li>
</ul>

<p>
删除
</p>
<ul class="org-ul">
<li><code>HDEL key field [field ...]</code>  删除指定的字段</li>
</ul>

<p>
简单示例
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HINCRBY number x -50
(integer) -50
127.0.0.1:6379&gt; HGET number x
<span style="color: #8b2252;">"-50"</span>
127.0.0.1:6379&gt; HINCRBYFLOAT number x 3.14
<span style="color: #8b2252;">"-46.86"</span>
127.0.0.1:6379&gt; HGET number x
<span style="color: #8b2252;">"-46.86"</span>
127.0.0.1:6379&gt; hdel number x
(integer)1
</pre>
</div>

<p>
<b>Hash用途</b>
</p>
<ul class="org-ul">
<li>节约内存空间。每创建一个键，它就会为这个键存储一些附加的管理信息(比如这个键的类型，这个键最后一次被访问的时间等等)</li>
<li>所以数据库里面的键越多，redis数据库服务器在储存附加管理信息方面耗费的内存就越多，花在管理数据库键上的CPU时间也会越多</li>
</ul>

<p>
应用场景
</p>
<ul class="org-ul">
<li>用户纬度统计
<ul class="org-ul">
<li>统计数包括：关注数、粉丝数、喜欢商品数、发帖数</li>
<li>用户为key，不同维度为Field,value为统计数</li>
<li>比如关注了5个人</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-sh">HSET user:100000 follow 5
HINCRBY user:100000 follow 1
</pre>
</div>

<ul class="org-ul">
<li>商品维度统计
<ul class="org-ul">
<li>统计值包括喜欢数，评论数，购买数，浏览数等</li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">HSET item:58000 fav 500
HINCRBY item:58000 fav 1
</pre>
</div>

<ul class="org-ul">
<li>缓存用户信息
<ul class="org-ul">
<li>登录后，反复需要读取用户的常用信息，最好的方式就是缓存起来</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">set</span> user:001 <span style="color: #8b2252;">"bob,18,20010101"</span>
mset user:001:name <span style="color: #8b2252;">"bob"</span> user:001:age 18 user:001:birthday <span style="color: #8b2252;">"20010101"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21487;&#21462;&#65292;&#37325;&#22797;&#20540;&#22810;</span>
hmset user:001 name <span style="color: #8b2252;">"bob"</span> age 18 birthday <span style="color: #8b2252;">"20010101"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6e8c0ef6-8d9e-4db1-8ce5-af534ce2d7cf" class="outline-4">
<h4 id="h:6e8c0ef6-8d9e-4db1-8ce5-af534ce2d7cf">Set集合</h4>
<div class="outline-text-4" id="text-h:6e8c0ef6-8d9e-4db1-8ce5-af534ce2d7cf">
<p>
集合的元素是无序的、去重的、元素是字符串类型。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;set&#31867;&#22411;&#30456;&#20851;&#30340;&#21629;&#20196;</span>
127.0.0.1:6379&gt; help @set
</pre>
</div>

<p>
<b>添加和删除</b>
</p>
<ul class="org-ul">
<li><code>SADD key member [member ...]</code>  增加一个或多个元素，元素已经存在将忽略</li>
<li><code>SREM key member [member ...]</code>  移除一个或多个元素，元素不存在自动忽略</li>
<li><code>SMOVE source destination member</code>  把元素从源集合移动到目标集合</li>
</ul>

<p>
<b>查询和长度</b>
</p>
<ul class="org-ul">
<li><code>SCARD key</code>  返回集合中元素的个数。不需要遍历。</li>
<li><code>SMEMBERS key</code>  返回集合中的所有元素。注意，如果集合中元素过多，应当避免使用该方法</li>
<li><code>SISMEMBER key number</code>  元素是否在集合中</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SADD ss 1 2 1 2 3 5 6 8 5 6
(integer) 6
127.0.0.1:6379&gt; SCARD ss
(integer) 6
127.0.0.1:6379&gt; SMEMBERS ss
1) <span style="color: #8b2252;">"1"</span>
2) <span style="color: #8b2252;">"2"</span>
3) <span style="color: #8b2252;">"3"</span>
4) <span style="color: #8b2252;">"5"</span>
5) <span style="color: #8b2252;">"6"</span>
6) <span style="color: #8b2252;">"8"</span>
127.0.0.1:6379&gt; SREM ss 1 2 5
(integer) 3
127.0.0.1:6379&gt; SMEMBERS ss
1) <span style="color: #8b2252;">"3"</span>
2) <span style="color: #8b2252;">"6"</span>
3) <span style="color: #8b2252;">"8"</span>
</pre>
</div>

<ul class="org-ul">
<li>注意：元素相同的两个集合未必有相同的顺序，去重且有序可使用有序集合</li>
</ul>

<p>
<b>随机获取移除</b>
</p>
<ul class="org-ul">
<li><code>SRANDMEMBER key [count]</code>  随机返回结合中个鸡丁个数的元素

<ol class="org-ol">
<li>如果count为正数，且小于集合基数，那么命令返回一个包含count个元素的数组，数组中的元素各不相同。如果count大于等于集合基数，那么返回整个集合</li>
<li>如果count为负数，那么命令返回一个数组，数组中的元素可能会重复出现多次，而数组长度为count的绝对值</li>
<li>如果count为0 返回空</li>
<li>如果count不指定，随机返回一个元素</li>
</ol></li>

<li><code>SPOP key</code>  从集合中随机移除一个元素并返回该元素</li>
</ul>

<p>
<b>集合运算</b>
</p>

<ul class="org-ul">
<li><b>差集</b>
<ul class="org-ul">
<li><code>SDIFF key [key ...]</code>  从第一个key的集合中去除其他集合和自己的交集部分</li>
<li><code>SDIFFSTORE destination key [key ...]</code>  将差集结果存储在目标key中</li>
</ul></li>
</ul>



<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; sadd number1 123 456 789
(integer) 3
127.0.0.1:6379&gt; sadd number2 123 456 999
(integer) 3
127.0.0.1:6379&gt; sdiff number1 number2
1) <span style="color: #8b2252;">"789"</span>
</pre>
</div>

<ul class="org-ul">
<li><b>交集</b>
<ul class="org-ul">
<li><code>SINTER key [key ...]</code>  取所有集合交集部分</li>
<li><code>SINTERSTORE destination key [key ...]</code>  将交集结果存储在目标key中</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; sadd number1 123 456 789
(integer) 3
127.0.0.1:6379&gt; sadd number2 123 456 999
(integer) 3
127.0.0.1:6379&gt; sinter number1 number2
1) <span style="color: #8b2252;">"123"</span>
2) <span style="color: #8b2252;">"456"</span>
</pre>
</div>

<ul class="org-ul">
<li><b>并集</b>
<ul class="org-ul">
<li><code>SUNION key [key ...]</code>  取所有集合交集部分</li>
<li><code>SINTERSTORE destination key [key ...]</code>  将交集结果存储在目标key中</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; sadd number1 123 456 789
(integer) 3
127.0.0.1:6379&gt; sadd number2 123 456 999
(integer) 3
127.0.0.1:6379&gt; SUNION number1 number2
1) <span style="color: #8b2252;">"123"</span>
2) <span style="color: #8b2252;">"456"</span>
3) <span style="color: #8b2252;">"789"</span>
4) <span style="color: #8b2252;">"999"</span>
</pre>
</div>

<p>
应用场景示例：微博的共同关注
</p>

<ol class="org-ol">
<li>需求：当用户访问另一个用户的时候，会显示出两个用户共同关注哪些相同的用户</li>
<li>设计：将每个用户关注的用户放在集合中，求交集即可</li>
</ol>


<div class="org-src-container">
<pre class="src src-sh">peter = {<span style="color: #8b2252;">"john"</span>,<span style="color: #8b2252;">"jack"</span>,<span style="color: #8b2252;">"may"</span>}
ben = {<span style="color: #8b2252;">"john"</span>,<span style="color: #8b2252;">"jack"</span>,<span style="color: #8b2252;">"tom"</span>}
&#37027;&#20040;peter&#21644;ben&#30340;&#20849;&#21516;&#20851;&#27880;&#20026;&#65306;
SINTER peter ben <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26524;&#20026;&#65306;{&#8220;john","jack"}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:74b51585-d16e-4f97-90d4-c8315d47b78d" class="outline-4">
<h4 id="h:74b51585-d16e-4f97-90d4-c8315d47b78d">SortedSet有序集合</h4>
<div class="outline-text-4" id="text-h:74b51585-d16e-4f97-90d4-c8315d47b78d">
<p>
类似Set集合，有序的集合。每一个元素都关联着一个浮点数分值(Score)，并按照分值从小到大的顺序排列集合中的元素。分值可以相同
</p>
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; help zadd

  ZADD key [NX|XX] [GT|LT] [CH] [INCR] score member [score member ...]
  summary: Adds one or more members to a sorted set, or updates their scores. Creates the key if it doesn<span style="color: #8b2252;">'t exist.</span>
<span style="color: #8b2252;">  since: 1.2.0</span>
<span style="color: #8b2252;">  group: sorted-set</span>

<span style="color: #8b2252;"># &#26597;&#30475;sorted-set&#30456;&#20851;&#21629;&#20196;</span>
<span style="color: #8b2252;">127.0.0.1:6379&gt; help @sorted-set</span>
</pre>
</div>

<p>
<b>添加</b>
</p>
<ul class="org-ul">
<li><code>ZADD key score member [score member ...]</code>  增加一个或多个元素。如果元素已经存在，则使用新的score</li>
</ul>

<p>
<b>简单查询</b>
</p>
<ul class="org-ul">
<li><code>ZCARD key</code>  返回集合的元素个数</li>
<li><code>ZCOUNT key min max</code>  返回指定score范围元素的个数</li>
<li><code>ZSCORE key member</code>  显示分值</li>
</ul>

<p>
<b>修改</b>
</p>
<ul class="org-ul">
<li><code>ZINCRBY key increment member</code>  增加或减少分值。increment为负数就是减少</li>
</ul>

<p>
<b>高级查询</b>
</p>
<ul class="org-ul">
<li><code>ZRANGE key start stop [WITHSCORES]</code>  返回指定索引区间元素(从大到小)
<ul class="org-ul">
<li>WITHSCORES 选项，带上时返回序列中会携带分值</li>
<li>有序集合里面，如果score相同，则按照字典序lexicographical order排列</li>
<li>默认按照score从大到小，如果需要score从小到大排列，使用ZREVRANGE</li>
</ul></li>

<li><code>ZREVRANGE key start stop [WITHSCORES]</code>  返回指定索引区间元素(从小到大)
<ul class="org-ul">
<li>WITHSCORES 选项，带上时返回序列中会携带分值</li>
<li>如果score相同，则按照字典序lexicographical order的*逆序*排列</li>
<li>默认按照score从大到小，如果需要score从小到大排列，使用ZRANGE</li>
</ul></li>

<li><code>ZRANK key number</code>  返回元素的排名(索引)</li>
<li><code>ZREVRANK key number</code>  返回元素的逆序排名(索引)</li>
<li><code>ZRANGEBYSCORE key min max [WITHSCORES][LIMIT offset count]</code>  返回指定分数区间的元素
<ul class="org-ul">
<li>返回score默认属于[min,max]之间，元素按照score升序排列，score相同字典序</li>
<li>LIMIT中offset代表跳过多少个元素，count是返回几个。类似于Mysql</li>
<li>使用小括号，修改区间为开区间，例如 <code>(5 10</code></li>
<li>-inf和+inf表示负无穷和正无穷</li>
</ul></li>

<li><code>ZREVRANGEBYSCORE key max min [WITHSCORES][LIMIT offset count]</code>  降序返回指定分数区间的元素
<ul class="org-ul">
<li>返回score默认属于[min,max]之间，元素按照score降序排列，score相同字典降序</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#36807;&#20010;&#20540;&#21040;employees&#20013;</span>
127.0.0.1:6379&gt; ZADD employees 3500 jack 4000 peter 4000 john 4500 tom 2500 david
(integer) 0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;employees&#38598;&#21512;&#25152;&#26377;key</span>
127.0.0.1:6379&gt; zrange employees 0 -1
1) <span style="color: #8b2252;">"david"</span>
2) <span style="color: #8b2252;">"jack"</span>
3) <span style="color: #8b2252;">"john"</span>
4) <span style="color: #8b2252;">"peter"</span>
5) <span style="color: #8b2252;">"tom"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;employees&#26377;&#24207;&#38598;&#21512;&#20013;&#20998;&#20540;&#22312;[3000,4000]&#30340;&#38598;&#21512;&#20010;&#25968;</span>
127.0.0.1:6379&gt; ZCOUNT employees 3000 4000
(integer) 3
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#20540;david &#20854;&#20998;&#20540;&#20026;3.2</span>
127.0.0.1:6379&gt; zadd employees 3.2 david
(integer) 0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;david&#30340;&#20998;&#20540;</span>
127.0.0.1:6379&gt; ZSCORE employees david
<span style="color: #8b2252;">"3.2000000000000002"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;jack&#30340;&#20998;&#20540;&#22686;&#21152;1.5</span>
127.0.0.1:6379&gt; ZINCRBY employees 1.5 jack
<span style="color: #8b2252;">"3501.5"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;tom&#30340;&#20998;&#20540;&#20943;&#23569;500</span>
127.0.0.1:6379&gt; zincrby employees -500 tom
<span style="color: #8b2252;">"4000"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24102;&#20998;&#20540;&#26174;&#31034;employees&#26377;&#24207;&#38598;&#21512;</span>
127.0.0.1:6379&gt; zrange employees  0 -1 WITHSCORES
1) <span style="color: #8b2252;">"david"</span>
2) <span style="color: #8b2252;">"3.2000000000000002"</span>
3) <span style="color: #8b2252;">"jack"</span>
4) <span style="color: #8b2252;">"3501.5"</span>
5) <span style="color: #8b2252;">"john"</span>
6) <span style="color: #8b2252;">"4000"</span>
7) <span style="color: #8b2252;">"peter"</span>
8) <span style="color: #8b2252;">"4000"</span>
9) <span style="color: #8b2252;">"tom"</span>
10) <span style="color: #8b2252;">"4000"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;peter&#30340;&#25490;&#21517;</span>
127.0.0.1:6379&gt; zrank employees peter
(integer) 3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36870;&#24207;&#21518;&#30340;&#32034;&#24341;0&#21040;-1&#65292;&#21363;&#36820;&#22238;&#25152;&#26377;</span>
127.0.0.1:6379&gt; zrevrange employees 0 -1 WITHSCORES
1) <span style="color: #8b2252;">"tom"</span>
2) <span style="color: #8b2252;">"4000"</span>
3) <span style="color: #8b2252;">"peter"</span>
4) <span style="color: #8b2252;">"4000"</span>
5) <span style="color: #8b2252;">"john"</span>
6) <span style="color: #8b2252;">"4000"</span>
7) <span style="color: #8b2252;">"jack"</span>
8) <span style="color: #8b2252;">"3501.5"</span>
9) <span style="color: #8b2252;">"david"</span>
10) <span style="color: #8b2252;">"3.2000000000000002"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;peter&#30340;&#36870;&#24207;&#25490;&#21517;</span>
127.0.0.1:6379&gt; zrevrank employees peter
(integer) 1
127.0.0.1:6379&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39640;&#32423;&#26597;&#35810;&#31034;&#20363;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#20998;&#20540;&#22312;[3500,4000]&#33539;&#22260;&#20869;&#30340;&#38190;&#65292;&#21319;&#24207;&#25490;&#21015;&#26174;&#31034;</span>
127.0.0.1:6379&gt; zrangebyscore employees 3500 4000
1) <span style="color: #8b2252;">"jack"</span>
2) <span style="color: #8b2252;">"john"</span>
3) <span style="color: #8b2252;">"peter"</span>
4) <span style="color: #8b2252;">"tom"</span>

127.0.0.1:6379&gt; zrangebyscore employees (4000 5000 WITHSCORES
(empty list or set)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23567;&#25324;&#21495;&#34920;&#31034;&#38381;&#21306;&#38388;&#21464;&#20026;&#24320;&#21306;&#38388;&#12290;&#26597;&#35810;&#20998;&#20540;&#22312;(2000,5000)&#33539;&#22260;&#20869;&#30340;&#38190;&#21644;&#20540;&#65292;&#21319;&#24207;&#25490;&#21015;&#26174;&#31034;</span>
127.0.0.1:6379&gt; zrangebyscore employees (2000 5000 WITHSCORES
1) <span style="color: #8b2252;">"jack"</span>
2) <span style="color: #8b2252;">"3501.5"</span>
3) <span style="color: #8b2252;">"john"</span>
4) <span style="color: #8b2252;">"4000"</span>
5) <span style="color: #8b2252;">"peter"</span>
6) <span style="color: #8b2252;">"4000"</span>
7) <span style="color: #8b2252;">"tom"</span>
8) <span style="color: #8b2252;">"4000"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#20998;&#20540;&#22312;(2000,5000)&#33539;&#22260;&#20869;&#30340;&#38190;&#21644;&#20540;&#65292;&#21319;&#24207;&#25490;&#21015;&#26174;&#31034;&#65292;&#36339;&#36807;&#31532;&#19968;&#20010;&#65292;&#26368;&#22810;&#26174;&#31034;2&#20010;</span>
127.0.0.1:6379&gt; zrangebyscore employees (2000 5000 WITHSCORES LIMIT 1 2
1) <span style="color: #8b2252;">"john"</span>
2) <span style="color: #8b2252;">"4000"</span>
3) <span style="color: #8b2252;">"peter"</span>
4) <span style="color: #8b2252;">"4000"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#20998;&#20540;&#22312;[&#27491;&#26080;&#31351;&#22823;&#65292;&#36127;&#26080;&#31351;&#22823;]&#30340;&#38190;&#65292;&#38477;&#24207;&#26174;&#31034;</span>
127.0.0.1:6379&gt; zrevrangebyscore employees +inf -inf
1) <span style="color: #8b2252;">"tom"</span>
2) <span style="color: #8b2252;">"peter"</span>
3) <span style="color: #8b2252;">"john"</span>
4) <span style="color: #8b2252;">"jack"</span>
5) <span style="color: #8b2252;">"david"</span>
</pre>
</div>

<p>
<b>删除</b>
</p>
<ul class="org-ul">
<li><code>ZREM key member [member ...]</code>  移除一个或多个元素。元素不存在，自动忽略</li>
<li><code>ZREMRANGEBYRANK key start stop</code>  移除指定排名范围的元素</li>
<li><code>ZREMRANGEBYSCORE key min max</code>  移除指定分值范围的元素</li>
</ul>


<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; zadd employees 1000 tom 2000 john 2000 jahh 3000 peter 4000 david 5000 xdd
(integer) 6
127.0.0.1:6379&gt; ZRANGEBYSCORE employees -inf +inf WITHSCORES
1) <span style="color: #8b2252;">"tom"</span>
2) <span style="color: #8b2252;">"1000"</span>
3) <span style="color: #8b2252;">"jahh"</span>
4) <span style="color: #8b2252;">"2000"</span>
5) <span style="color: #8b2252;">"john"</span>
6) <span style="color: #8b2252;">"2000"</span>
7) <span style="color: #8b2252;">"peter"</span>
8) <span style="color: #8b2252;">"3000"</span>
9) <span style="color: #8b2252;">"david"</span>
10) <span style="color: #8b2252;">"4000"</span>
11) <span style="color: #8b2252;">"xdd"</span>
12) <span style="color: #8b2252;">"5000"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;employees&#20013;&#20998;&#32034;&#24341;&#22312;[0,1]&#33539;&#22260;&#20869;&#30340;&#20540;</span>
127.0.0.1:6379&gt; ZREMRANGEBYRANK employees 0 1
(integer) 2
127.0.0.1:6379&gt; ZRANGEBYSCORE employees -inf +inf WITHSCORES
1) <span style="color: #8b2252;">"john"</span>
2) <span style="color: #8b2252;">"2000"</span>
3) <span style="color: #8b2252;">"peter"</span>
4) <span style="color: #8b2252;">"3000"</span>
5) <span style="color: #8b2252;">"david"</span>
6) <span style="color: #8b2252;">"4000"</span>
7) <span style="color: #8b2252;">"xdd"</span>
8) <span style="color: #8b2252;">"5000"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;employees&#38598;&#21512;&#20013;&#20998;&#20540;&#22312;[4000,5000]&#33539;&#22260;&#20869;&#30340;&#20540;</span>
127.0.0.1:6379&gt; ZREMRANGEBYSCORE employees 4000 5000
(integer) 2
127.0.0.1:6379&gt; ZRANGEBYSCORE employees -inf +inf WITHSCORES
1) <span style="color: #8b2252;">"john"</span>
2) <span style="color: #8b2252;">"2000"</span>
3) <span style="color: #8b2252;">"peter"</span>
4) <span style="color: #8b2252;">"3000"</span>
</pre>
</div>

<p>
<b>集合运算</b>
</p>

<ul class="org-ul">
<li><b>并集</b></li>
<li><code>ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]</code>  并集运算

<ul class="org-ul">
<li>numkeys指定key的数量，必须</li>
<li>WEIGHTS选项，与前面设定的key对应，对应key中每一个score都要乘以这个权重</li>
<li>AGGREGATE选项，指定并集结果的聚合方式
<ul class="org-ul">
<li>SUM: 将所有集合中某一个元素的score值之和作为结果集中该成员的score值，默认行为</li>
<li>MIN: 将所有集合中某一个元素的score值中最小值作为结果集中该成员的score值</li>
<li>MAX: 将所有集合中某一个元素的score值中最大值作为结果集中该成员的score值</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; zadd s1 70 tom 80 peter 60 john
(integer) 3
127.0.0.1:6379&gt; zadd s2 90 peter 60 ben
(integer) 2
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27714;s1 s2&#30340;&#20132;&#38598;&#65292;s1&#30340;&#26435;&#37325;&#26159;1&#65292;s2&#30340;&#26435;&#37325;&#26159;1&#65292;&#40664;&#35748;&#21512;&#24182;&#21518;&#30340;&#20998;&#25903;&#20351;&#29992;sum&#27714;&#21644;&#26041;&#24335;</span>
127.0.0.1:6379&gt; ZUNIONSTORE scores-all 2 s1 s2
(integer) 4
127.0.0.1:6379&gt; ZRANGEBYSCORE scores-all -inf +inf WITHSCORES
1) <span style="color: #8b2252;">"ben"</span>
2) <span style="color: #8b2252;">"60"</span>
3) <span style="color: #8b2252;">"john"</span>
4) <span style="color: #8b2252;">"60"</span>
5) <span style="color: #8b2252;">"tom"</span>
6) <span style="color: #8b2252;">"70"</span>
7) <span style="color: #8b2252;">"peter"</span>
8) <span style="color: #8b2252;">"170"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27714;s1 s2&#30340;&#20132;&#38598;&#65292;s1&#30340;&#26435;&#37325;&#26159;1&#65292;s2&#30340;&#26435;&#37325;&#26159;1&#65292;&#21512;&#24182;&#21518;&#30340;&#20998;&#25903;&#20351;&#29992;sum&#27714;&#21644;&#26041;&#24335;</span>
127.0.0.1:6379&gt; ZUNIONSTORE scores-all1 2 s1 s2 aggregate sum
(integer) 4
127.0.0.1:6379&gt; ZRANGEBYSCORE scores-all1 -inf +inf WITHSCORES
1) <span style="color: #8b2252;">"ben"</span>
2) <span style="color: #8b2252;">"60"</span>
3) <span style="color: #8b2252;">"john"</span>
4) <span style="color: #8b2252;">"60"</span>
5) <span style="color: #8b2252;">"tom"</span>
6) <span style="color: #8b2252;">"70"</span>
7) <span style="color: #8b2252;">"peter"</span>
8) <span style="color: #8b2252;">"170"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27714;s1 s2&#30340;&#20132;&#38598;&#65292;s1&#30340;&#26435;&#37325;&#26159;1&#65292;s2&#30340;&#26435;&#37325;&#26159;0.5&#65292;&#21512;&#24182;&#21518;&#30340;&#20998;&#25903;&#20351;&#29992;sum&#27714;&#21644;&#26041;&#24335;</span>
127.0.0.1:6379&gt; ZUNIONSTORE scores-all2 2 s1 s2 weights 1 0.5 aggregate sum
(integer) 4
127.0.0.1:6379&gt; ZRANGEBYSCORE scores-all2 -inf +inf WITHSCORES
1) <span style="color: #8b2252;">"ben"</span>
2) <span style="color: #8b2252;">"30"</span>
3) <span style="color: #8b2252;">"john"</span>
4) <span style="color: #8b2252;">"60"</span>
5) <span style="color: #8b2252;">"tom"</span>
6) <span style="color: #8b2252;">"70"</span>
7) <span style="color: #8b2252;">"peter"</span>
8) <span style="color: #8b2252;">"125"</span>
</pre>
</div>

<ul class="org-ul">
<li><b>交集</b></li>
<li><code>ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]</code>  
<ul class="org-ul">
<li>numkeys指定key的数量，必须</li>
<li>WEIGHTS选项，与前面设定的key对应，对应key中每一个score都要乘以这个权重</li>
<li>AGGREGATE选项，指定交集结果的聚合方式
<ul class="org-ul">
<li>SUM:将所有集合中某一个元素的score值之和作为结果集中该成员的score值</li>
<li>MIN:将所有结合中某一个元素的score值中最小值作为结果集中该成员的score值</li>
<li>MAX:将所有集合中某一个元素的score值中最大值作为结果集中该成员的score值</li>
</ul></li>
</ul></li>
</ul>

<p>
应用练习：音乐排行榜的实现
</p>

<ul class="org-ul">
<li>每首歌的歌名作为元素(先补补考虑重复)</li>
<li>每首歌的播放次数作为分值</li>
<li>ZREVRANGE来获取播放次数最多的歌曲(就是最多播放榜了，云音乐热歌榜，没有竞价，没有权重)</li>
</ul>

<p>
python中redis库是3.x版本代码如下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">redis&#29256;&#26412;3.x&#29256;&#26412;</span>
import redis

r = redis.Redis(<span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">"192.168.61.109"</span>,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">db</span>=3)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;&#25968;&#25454;&#24211;</span>
<span style="color: #0000ff;">r.flushdb</span>()
<span style="color: #0000ff;">r.zadd</span>(<span style="color: #8b2252;">"mboard"</span>,{<span style="color: #8b2252;">"yellow"</span>:1,<span style="color: #8b2252;">"rolling inthe deep"</span>:1,<span style="color: #8b2252;">"happy"</span>:1,<span style="color: #8b2252;">"just the way you are"</span>:1})
<span style="color: #0000ff;">r.zadd</span>(<span style="color: #8b2252;">"mboard"</span>,{<span style="color: #8b2252;">"eye of the tiger"</span>:1,<span style="color: #8b2252;">"billie jean"</span>:1,<span style="color: #8b2252;">"say you say me"</span>:1,<span style="color: #8b2252;">"payphone"</span>:1})
<span style="color: #0000ff;">r.zadd</span>(<span style="color: #8b2252;">"mboard"</span>,{<span style="color: #8b2252;">"my heart will go on"</span>:1,<span style="color: #8b2252;">"when you believe"</span>:1,<span style="color: #8b2252;">"hero"</span>:1})

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;yellow&#30340;&#20998;&#20540;&#20026;50</span>
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">"mboard"</span>,50,<span style="color: #8b2252;">"yellow"</span>)
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">"mboard"</span>,60,<span style="color: #8b2252;">"rolling in the deep"</span>)
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">"mboard"</span>,68.8,<span style="color: #8b2252;">"my heart will go on"</span>)
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">"mboard"</span>,70,<span style="color: #8b2252;">"when you believe"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#20803;&#32032;</span>
allmusic = r.zrange(<span style="color: #8b2252;">"mboard"</span>,0,-1,<span style="color: #a0522d;">withscores</span>=True)
<span style="color: #0000ff;">print</span>(<span style="color: #483d8b;">type</span>(allmusic))

<span style="color: #a020f0;">for</span> m<span style="color: #a020f0;"> in</span> allmusic:
    print(m)

<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">" -"</span>*30)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25490;&#34892;&#27036;</span>
musicboard = r.zrevrange(<span style="color: #8b2252;">"mboard"</span>,0,9,<span style="color: #a0522d;">withscores</span>=True)
<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">"&#27431;&#32654;&#28909;&#26354;&#27036;"</span>)

<span style="color: #a020f0;">for</span> i,m<span style="color: #a020f0;"> in</span> enumerate(musicboard):
    print(i,*m)
</pre>
</div>

<p>
python中如果redis版本是2.x代码如下：
</p>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">redis&#24211; 2.x&#29256;&#26412;</span>
import redis

r = redis.Redis(<span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">'192.168.142.135'</span>, <span style="color: #a0522d;">port</span>=6379, <span style="color: #a0522d;">db</span>=3)

<span style="color: #0000ff;">r.zadd</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'yellow'</span>,1,<span style="color: #8b2252;">'rolling in the deep'</span>,1,<span style="color: #8b2252;">'happy'</span>,1,<span style="color: #8b2252;">'just the way you are'</span>,1)
<span style="color: #0000ff;">r.zadd</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'eye of the tiger'</span>,1,<span style="color: #8b2252;">'billie jean'</span>,1,<span style="color: #8b2252;">'say you say me'</span>,1,<span style="color: #8b2252;">'payphone'</span>,1)
<span style="color: #0000ff;">r.zadd</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'my heart will go on'</span>,1,<span style="color: #8b2252;">'when you believe'</span>,1,<span style="color: #8b2252;">'hero'</span>,1)

<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'yellow'</span>,50)
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'rolling in the deep'</span>,60)
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'my heart will go on'</span>,68.8)
<span style="color: #0000ff;">r.zincrby</span>(<span style="color: #8b2252;">'mboard'</span>,<span style="color: #8b2252;">'when you believe'</span>,70)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#20803;&#32032;</span>
allmusic = r.zrange(<span style="color: #8b2252;">'mboard'</span>, 0, -1, <span style="color: #a0522d;">withscores</span>=True)
<span style="color: #0000ff;">print</span>(<span style="color: #483d8b;">type</span>(allmusic))
<span style="color: #a020f0;">for</span> m<span style="color: #a020f0;"> in</span> allmusic:
    print(m)

<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">'-'</span>*30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25490;&#34892;&#27036;</span>
musicboard = r.zrevrange(<span style="color: #8b2252;">'mboard'</span>, 0, 9, True)
<span style="color: #0000ff;">print</span>(<span style="color: #8b2252;">'&#27431;&#32654;&#28909;&#26354;&#27036;'</span>)
<span style="color: #a020f0;">for</span> i, m<span style="color: #a020f0;"> in</span> enumerate(musicboard):
    print(i, *m)
</pre>
</div>

<p>
<b>应用场景</b>
</p>

<p>
新浪微博翻页
</p>
<ul class="org-ul">
<li>新闻网站、播客、论坛、搜索引擎，页面列表条目多，都需要分页</li>
<li>blog这个key使用时间戳作为score</li>
</ul>

<div class="org-src-container">
<pre class="src src-nil">ZADD blog 1407000000 '今天天气不错'=
ZADD blog 1450000000 '今天我们学习Redis' 
ZADD blog 1560000000 '几个Redis使用示例' 
ZREVRANGE blog 10 20
显示所有播客中最后的评论的条目
</pre>
</div>

<p>
京东图书畅销榜
</p>
<ul class="org-ul">
<li>统计单日榜，计算出周榜单、月榜单、年榜单</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#22825;&#32479;&#35745;&#19968;&#27425;&#27036;&#21333;</span>
ZADD bk:it:01 1000 <span style="color: #8b2252;">'java'</span> 1500 <span style="color: #8b2252;">'Redis'</span> 2000 <span style="color: #8b2252;">'haoop'</span> 100 <span style="color: #8b2252;">'scala'</span> 80 <span style="color: #8b2252;">'python'</span>
ZADD bk:it:02 1020 <span style="color: #8b2252;">'java'</span> 1500 <span style="color: #8b2252;">'Redis'</span> 2100 <span style="color: #8b2252;">'haoop'</span> 120 <span style="color: #8b2252;">'python'</span> 110 <span style="color: #8b2252;">'scala'</span>
ZADD bk:it:03 1620 <span style="color: #8b2252;">'java'</span> 1510 <span style="color: #8b2252;">'Redis'</span> 3000 <span style="color: #8b2252;">'haoop'</span> 150 <span style="color: #8b2252;">'storm'</span> 120 <span style="color: #8b2252;">'python'</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27714;&#38144;&#21806;&#21069;10&#21517;</span>
- &#30001;&#20110;&#19978;&#38754;&#30340;&#26085;&#27036;&#21333;&#26159;&#32047;&#35745;&#20540;&#65292;&#25152;&#20197;&#19981;&#33021;&#30452;&#25509;&#20351;&#29992;&#24182;&#38598;&#65292;&#35201;&#25351;&#23450;&#32858;&#21512;&#36816;&#31639;&#20026;MAX
127.0.0.1:6379&gt; ZUNIONSTORE bk:it:01-03 3 bk:it:01 bk:it:02 bk:it:03 AGGREGATE MAX
(integer) 6
127.0.0.1:6379&gt; ZREVRANGE bk:it:01-03 0 9 WITHSCORES
 1) <span style="color: #8b2252;">"haoop"</span>
 2) <span style="color: #8b2252;">"3000"</span>
 3) <span style="color: #8b2252;">"java"</span>
 4) <span style="color: #8b2252;">"1620"</span>
 5) <span style="color: #8b2252;">"Redis"</span>
 6) <span style="color: #8b2252;">"1510"</span>
 7) <span style="color: #8b2252;">"storm"</span>
 8) <span style="color: #8b2252;">"150"</span>
 9) <span style="color: #8b2252;">"python"</span>
10) <span style="color: #8b2252;">"120"</span>
11) <span style="color: #8b2252;">"scala"</span>
12) <span style="color: #8b2252;">"110"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#22914;&#26524;&#21442;&#19982;&#24182;&#38598;&#20803;&#32032;&#30340;&#20803;&#32032;&#22826;&#22810;&#65292;&#20250;&#28040;&#32791;&#22823;&#37327;&#20869;&#23384;&#21644;&#35745;&#31639;&#26102;&#38388;&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;Redis&#26381;&#21153;&#38459;&#22622;&#65292;&#22914;&#26524;&#38750;&#35201;&#35745;&#31639;&#65292;&#36873;&#22312;&#31354;&#38386;&#26102;&#38388;&#25110;&#22791;&#29992;&#26381;&#21153;&#22120;&#19978;&#35745;&#31639;&#12290;</span>

&#21478;&#19968;&#31181;&#32479;&#35745;, &#38750;&#32047;&#21152;&#20540;&#65292;&#27599;&#22825;&#21334;&#20102;&#22810;&#23569;&#26412;&#20070;&#65292;&#19981;&#26159;&#32047;&#35745;&#21334;&#20102;&#22810;&#23569;&#26412;&#20070;&#12290;
ZADD bk:it:01 50 <span style="color: #8b2252;">'java'</span> 20 <span style="color: #8b2252;">'Redis'</span> 40 <span style="color: #8b2252;">'haoop'</span>
ZADD bk:it:02 70 <span style="color: #8b2252;">'java'</span> 30 <span style="color: #8b2252;">'Redis'</span> 20 <span style="color: #8b2252;">'haoop'</span>
ZADD bk:it:03 20 <span style="color: #8b2252;">'java'</span> 30 <span style="color: #8b2252;">'Redis'</span> 5 <span style="color: #8b2252;">'haoop'</span>
ZUNIONSTORE bk:it:01-03 3 bk:it:01 bk:it:02 bk:it:03 AGGREGATE sum
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:44877547-7bab-4d00-9c14-1516ad1d780f" class="outline-3">
<h3 id="h:44877547-7bab-4d00-9c14-1516ad1d780f">操作</h3>
<div class="outline-text-3" id="text-h:44877547-7bab-4d00-9c14-1516ad1d780f">
<p>
参考：<a href="https://blog.51cto.com/u_8406447/5769475">https://blog.51cto.com/u_8406447/5769475</a>
</p>
</div>
<div id="outline-container-h:061a3774-b478-4bcb-937b-6282062124c6" class="outline-4">
<h4 id="h:061a3774-b478-4bcb-937b-6282062124c6">键操作</h4>
<div class="outline-text-4" id="text-h:061a3774-b478-4bcb-937b-6282062124c6">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">参数说明</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">示例说明</th>
<th scope="col" class="org-left">示例结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>exists(name)</code></td>
<td class="org-left">判断一个键是否存在</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.exists('name')</code></td>
<td class="org-left">是否存在name这个键</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left"><code>delete(name)</code></td>
<td class="org-left">删除一个键</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.delete('name')</code></td>
<td class="org-left">删除name这个键</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left"><code>type(name)</code></td>
<td class="org-left">判断键类型</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.type('name')</code></td>
<td class="org-left">判断name这个键类型</td>
<td class="org-left">b'string'</td>
</tr>

<tr>
<td class="org-left"><code>keys(pattern)</code></td>
<td class="org-left">获取所有符合规则的键</td>
<td class="org-left">pattern：匹配规则</td>
<td class="org-left"><code>redis.keys('n*')</code></td>
<td class="org-left">获取所有以n开头的键</td>
<td class="org-left">[b'name']</td>
</tr>

<tr>
<td class="org-left"><code>randomkey()</code></td>
<td class="org-left">获取随机的一个键</td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>redis.randomkey()</code></td>
<td class="org-left">获取随机的一个键</td>
<td class="org-left">b'name'</td>
</tr>

<tr>
<td class="org-left"><code>rename(src, dst)</code></td>
<td class="org-left">重命名键</td>
<td class="org-left">src：原键名；</td>
<td class="org-left"><code>redis.rename('name', 'nickname')</code></td>
<td class="org-left">将name重命名为nickname</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">dst：新键名</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>dbsize()</code></td>
<td class="org-left">获取当前数据库中键的数目</td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>redis.dbsize()</code></td>
<td class="org-left">获取当前数据库中键的数目</td>
<td class="org-left">100</td>
</tr>

<tr>
<td class="org-left"><code>expire(name, time)</code></td>
<td class="org-left">设定键的过期时间，单位为秒</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.expire('name', 2)</code></td>
<td class="org-left">将name键的过期时间设置为2秒</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">time：秒数</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>ttl(name)</code></td>
<td class="org-left">获取键的过期时间，单位为秒，-1表示永久不过期</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.ttl('name')</code></td>
<td class="org-left">获取name这个键的过期时间</td>
<td class="org-left">-1</td>
</tr>

<tr>
<td class="org-left"><code>move(name, db)</code></td>
<td class="org-left">将键移动到其他数据库</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.move('name', 2)</code></td>
<td class="org-left">将name移动到2号数据库</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">db：数据库代号</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>flushdb()</code></td>
<td class="org-left">删除当前选择数据库中的所有键</td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>redis.flushdb()</code></td>
<td class="org-left">删除当前选择数据库中的所有键</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>flushall()</code></td>
<td class="org-left">删除所有数据库中的所有键</td>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>redis.flushall()</code></td>
<td class="org-left">删除所有数据库中的所有键</td>
<td class="org-left">True</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:558aaa51-ee41-4808-9f22-2a215ebabfba" class="outline-4">
<h4 id="h:558aaa51-ee41-4808-9f22-2a215ebabfba">值操作：字符串操作</h4>
<div class="outline-text-4" id="text-h:558aaa51-ee41-4808-9f22-2a215ebabfba">
<p>
Redis支持最基本的键值对形式存储
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">参数说明</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">示例说明</th>
<th scope="col" class="org-left">示例结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>set(name, value)</code></td>
<td class="org-left">给数据库中键为name的string赋予值value</td>
<td class="org-left">name: 键名；  value: 值</td>
<td class="org-left"><code>redis.set('name', 'Bob')</code></td>
<td class="org-left">给name这个键的value赋值为Bob</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>get(name)</code></td>
<td class="org-left">返回数据库中键为name的string的value</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.get('name')</code></td>
<td class="org-left">返回name这个键的value</td>
<td class="org-left">b'Bob'</td>
</tr>

<tr>
<td class="org-left"><code>getset(name, value)</code></td>
<td class="org-left">给数据库中键为name的string赋予值value并返回上次的value</td>
<td class="org-left">name：键名；   value：新值</td>
<td class="org-left"><code>redis.getset('name', 'Mike')</code></td>
<td class="org-left">赋值name为Mike并得到上次的value</td>
<td class="org-left">b'Bob'</td>
</tr>

<tr>
<td class="org-left"><code>mget(keys, *args)</code></td>
<td class="org-left">返回多个键对应的value</td>
<td class="org-left">keys：键的列表</td>
<td class="org-left"><code>redis.mget(['name', 'nickname'])</code></td>
<td class="org-left">返回name和nickname的value</td>
<td class="org-left">[b'Mike', b'Miker']</td>
</tr>

<tr>
<td class="org-left"><code>setnx(name, value)</code></td>
<td class="org-left">如果不存在这个键值对，则更新value，否则不变</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.setnx('newname', 'James')</code></td>
<td class="org-left">如果newname这个键不存在，则设置值为James</td>
<td class="org-left">第一次运行结果是True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">第二次运行结果是False</td>
</tr>

<tr>
<td class="org-left"><code>setex(name, time, value)</code></td>
<td class="org-left">设置可以对应的值为string类型的value，并指定此键值对应的有效期</td>
<td class="org-left">name: 键名；time: 有效期；value：值</td>
<td class="org-left"><code>redis.setex('name', 1, 'James')</code></td>
<td class="org-left">将name这个键的值设为James，有效期为1秒</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>setrange(name, offset, value)</code></td>
<td class="org-left">设置指定键的value值的子字符串</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.set('name', 'Hello')</code></td>
<td class="org-left">设置name为Hello字符串，并在index为6的位置补World</td>
<td class="org-left">11 修改后的字符串长度</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">offset：偏移量；   value：值</td>
<td class="org-left"><code>redis.setrange('name', 6, 'World')</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>mset(mapping)</code></td>
<td class="org-left">批量赋值</td>
<td class="org-left">mapping：字典</td>
<td class="org-left"><code>redis.mset({'name1': 'Durant', 'name2': 'James'})</code></td>
<td class="org-left">将name1设为Durant，name2设为James</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>msetnx(mapping)</code></td>
<td class="org-left">键均不存在时才批量赋值</td>
<td class="org-left">mapping：字典</td>
<td class="org-left"><code>redis.msetnx({'name3': 'Smith', 'name4': 'Curry'})</code></td>
<td class="org-left">在name3和name4均不存在的情况下才设置二者值</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>incr(name, amount=1)</code></td>
<td class="org-left">键为name的value增值操作，默认为1</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.incr('age', 1)</code></td>
<td class="org-left">age对应的值增1，若不存在，则会创建并设置为1</td>
<td class="org-left">1 即修改后的值</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">键不存在则被创建并设为amount</td>
<td class="org-left">amount：增长的值</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>decr(name, amount=1)</code></td>
<td class="org-left">键为name的value减值操作，默认为1</td>
<td class="org-left">name：键名； amount：减少的值</td>
<td class="org-left"><code>redis.decr('age', 1)</code></td>
<td class="org-left">age对应的值减1，若不存在，则会创建并设置为-1</td>
<td class="org-left">-1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">键不存在则被创建并将value设置为-amount</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">即修改后的值</td>
</tr>

<tr>
<td class="org-left"><code>append(key, value)</code></td>
<td class="org-left">键为name的string的值附加value</td>
<td class="org-left">key：键名</td>
<td class="org-left"><code>redis.append('nickname', 'OK')</code></td>
<td class="org-left">向键为nickname的值后追加OK</td>
<td class="org-left">13 即修改后的字符串长度</td>
</tr>

<tr>
<td class="org-left"><code>substr(name, start, end</code>-1)=</td>
<td class="org-left">返回键为name的string的子串</td>
<td class="org-left">name：键名； start：起始索引；</td>
<td class="org-left"><code>redis.substr('name', 1, 4)</code></td>
<td class="org-left">返回键为name的值的字符串，截取索引为1~4的字符</td>
<td class="org-left">b'ello'</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">end：终止索引，默认为-1，表示截取到末尾</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>getrange(key, start, end)</code></td>
<td class="org-left">获取键的value值从start到end的子字符串</td>
<td class="org-left">key：键名； start：起始索引； end：终止索引</td>
<td class="org-left"><code>redis.getrange('name', 1, 4)</code></td>
<td class="org-left">返回键为name的值的字符串，截取索引为1~4的字符</td>
<td class="org-left">b'ello'</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:d320d6d6-a949-45ac-8639-b6f9ac252855" class="outline-4">
<h4 id="h:d320d6d6-a949-45ac-8639-b6f9ac252855">值操作：列表操作</h4>
<div class="outline-text-4" id="text-h:d320d6d6-a949-45ac-8639-b6f9ac252855">
<p>
Redis还提供了列表存储，列表内的元素可以重复，而且可以从两端存储
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">参数说明</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">示例说明</th>
<th scope="col" class="org-left">示例结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>rpush(name, *values)</code></td>
<td class="org-left">在键为name的列表末尾添加值为value的元素，可以传多个</td>
<td class="org-left">name：键名；values：值</td>
<td class="org-left"><code>redis.rpush('list', 1, 2, 3)</code></td>
<td class="org-left">向键为list的列表尾添加1、2、3</td>
<td class="org-left">3列表大小</td>
</tr>

<tr>
<td class="org-left"><code>lpush(name, *values)</code></td>
<td class="org-left">在键为name的列表头添加值为value的元素，可以传多个</td>
<td class="org-left">name：键名；values：值</td>
<td class="org-left"><code>redis.lpush('list', 0)</code></td>
<td class="org-left">向键为list的列表头部添加0</td>
<td class="org-left">4列表大小</td>
</tr>

<tr>
<td class="org-left"><code>llen(name)</code></td>
<td class="org-left">返回键为name的列表的长度</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.llen('list')</code></td>
<td class="org-left">返回键为list的列表的长度</td>
<td class="org-left">4</td>
</tr>

<tr>
<td class="org-left"><code>lrange(name, start, end)</code></td>
<td class="org-left">返回键为name的列表中start至end之间的元素</td>
<td class="org-left">name：键名；start：起始索引；end：终止索引</td>
<td class="org-left"><code>redis.lrange('list', 1, 3)</code></td>
<td class="org-left">返回起始索引为1终止索引为3的索引范围对应的列表</td>
<td class="org-left">[b'3', b'2', b'1']</td>
</tr>

<tr>
<td class="org-left"><code>ltrim(name, start, end)</code></td>
<td class="org-left">截取键为name的列表，保留索引为start到end的内容</td>
<td class="org-left">name：键名；start：起始索引；end：终止索引</td>
<td class="org-left"><code>ltrim('list', 1, 3)</code></td>
<td class="org-left">保留键为list的索引为1到3的元素</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>lindex(name, index)</code></td>
<td class="org-left">返回键为name的列表中index位置的元素</td>
<td class="org-left">name：键名； index：索引</td>
<td class="org-left"><code>redis.lindex('list', 1)</code></td>
<td class="org-left">返回键为list的列表索引为1的元素</td>
<td class="org-left">b'2'</td>
</tr>

<tr>
<td class="org-left"><code>lset(name, index, value)</code></td>
<td class="org-left">给键为name的列表中index位置的元素赋值，越界则报错</td>
<td class="org-left">name：键名； index：索引位置；value：值</td>
<td class="org-left"><code>redis.lset('list', 1, 5)</code></td>
<td class="org-left">将键为list的列表中索引为1的位置赋值为5</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>lrem(name, count, value)</code></td>
<td class="org-left">删除count个键的列表中值为value的元素</td>
<td class="org-left">name：键名；count：删除个数；value：值</td>
<td class="org-left"><code>redis.lrem('list', 2, 3)</code></td>
<td class="org-left">将键为list的列表删除两个3</td>
<td class="org-left">1即删除的个数</td>
</tr>

<tr>
<td class="org-left"><code>lpop(name)</code></td>
<td class="org-left">返回并删除键为name的列表中的首元素</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.lpop('list')</code></td>
<td class="org-left">返回并删除名为list的列表中的第一个元素</td>
<td class="org-left">b'5'</td>
</tr>

<tr>
<td class="org-left"><code>rpop(name)</code></td>
<td class="org-left">返回并删除键为name的列表中的尾元素</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.rpop('list')</code></td>
<td class="org-left">返回并删除名为list的列表中的最后一个元素</td>
<td class="org-left">b'2'</td>
</tr>

<tr>
<td class="org-left"><code>blpop(keys, timeout=0)</code></td>
<td class="org-left">返回并删除名称在keys中的list中的首个元素，如果列表为空，则会一直阻塞等待</td>
<td class="org-left">keys：键列表；</td>
<td class="org-left"><code>redis.blpop('list')</code></td>
<td class="org-left">返回并删除键为list的列表中的第一个元素</td>
<td class="org-left">[b'5']</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">timeout： 超时等待时间，0为一直等待</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>brpop(keys, timeout=0)</code></td>
<td class="org-left">返回并删除键为name的列表中的尾元素，如果list为空，则会一直阻塞等待</td>
<td class="org-left">keys：键列表；</td>
<td class="org-left"><code>redis.brpop('list')</code></td>
<td class="org-left">返回并删除名为list的列表中的最后一个元素</td>
<td class="org-left">[b'2']</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">timeout：超时等待时间，0为一直等待</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>rpoplpush(src, dst)</code></td>
<td class="org-left">返回并删除名称为src的列表的尾元素，并将该元素添加到名称为dst的列表头部</td>
<td class="org-left">src：源列表的键；</td>
<td class="org-left"><code>redis.rpoplpush('list', 'list2')</code></td>
<td class="org-left">将键为list的列表尾元素删除并将其添加到键为list2的列表头部，然后返回</td>
<td class="org-left">b'2'</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">dst：目标列表的key</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:c1d7fe88-f08d-4fef-ab7d-794a101cc35d" class="outline-4">
<h4 id="h:c1d7fe88-f08d-4fef-ab7d-794a101cc35d">值操作：集合操作</h4>
<div class="outline-text-4" id="text-h:c1d7fe88-f08d-4fef-ab7d-794a101cc35d">
<p>
Redis还提供了集合存储，集合中的元素都是不重复的
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">参数说明</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">示例说明</th>
<th scope="col" class="org-left">示例结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>sadd(name, *values)</code></td>
<td class="org-left">向键为name的集合中添加元素</td>
<td class="org-left">name：键名；values：值，可为多个</td>
<td class="org-left"><code>redis.sadd('tags', 'Book', 'Tea', 'Coffee')</code></td>
<td class="org-left">向键为tags的集合中添加Book、Tea和Coffee这3个内容</td>
<td class="org-left">3即插入的数据个数</td>
</tr>

<tr>
<td class="org-left"><code>srem(name, *values)</code></td>
<td class="org-left">从键为name的集合中删除元素</td>
<td class="org-left">name：键名； values：值，可为多个</td>
<td class="org-left"><code>redis.srem('tags', 'Book')</code></td>
<td class="org-left">从键为tags的集合中删除Book</td>
<td class="org-left">1即删除的数据个数</td>
</tr>

<tr>
<td class="org-left"><code>spop(name)</code></td>
<td class="org-left">随机返回并删除键为name的集合中的一个元素</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.spop('tags')</code></td>
<td class="org-left">从键为tags的集合中随机删除并返回该元素</td>
<td class="org-left">b'Tea'</td>
</tr>

<tr>
<td class="org-left"><code>smove(src, dst, value)</code></td>
<td class="org-left">从src对应的集合中移除元素并将其添加到dst对应的集合中</td>
<td class="org-left">src：源集合；</td>
<td class="org-left"><code>redis.smove('tags', 'tags2', 'Coffee')</code></td>
<td class="org-left">从键为tags的集合中删除元素Coffee并将其添加到键为tags2的集合</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">dst：目标集合；value：元素值</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>scard(name)</code></td>
<td class="org-left">返回键为name的集合的元素个数</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.scard('tags')</code></td>
<td class="org-left">获取键为tags的集合中的元素个数</td>
<td class="org-left">3</td>
</tr>

<tr>
<td class="org-left"><code>sismember(name, value)</code></td>
<td class="org-left">测试member是否是键为name的集合的元素</td>
<td class="org-left">name：键值</td>
<td class="org-left"><code>redis.sismember('tags', 'Book')</code></td>
<td class="org-left">判断Book是否是键为tags的集合元素</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left"><code>sinter(keys, *args)</code></td>
<td class="org-left">返回所有给定键的集合的交集</td>
<td class="org-left">keys：键列表</td>
<td class="org-left"><code>redis.sinter(['tags', 'tags2'])</code></td>
<td class="org-left">返回键为tags的集合和键为tags2的集合的交集</td>
<td class="org-left"><code>{b'Coffee'}</code></td>
</tr>

<tr>
<td class="org-left"><code>sinterstore(dest, keys, *args)</code></td>
<td class="org-left">求交集并将交集保存到dest的集合</td>
<td class="org-left">dest：结果集合；keys：键列表</td>
<td class="org-left"><code>redis.sinterstore('inttag', ['tags', 'tags2'])</code></td>
<td class="org-left">求键为tags的集合和键为tags2的集合的交集并将其保存为inttag</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left"><code>sunion(keys, *args)</code></td>
<td class="org-left">返回所有给定键的集合的并集</td>
<td class="org-left">keys：键列表</td>
<td class="org-left"><code>redis.sunion(['tags', 'tags2'])</code></td>
<td class="org-left">返回键为tags的集合和键为tags2的集合的并集</td>
<td class="org-left"><code>{b'Coffee', b'Book', b'Pen'}</code></td>
</tr>

<tr>
<td class="org-left"><code>sunionstore(dest, keys, *args)</code></td>
<td class="org-left">求并集并将并集保存到dest的集合</td>
<td class="org-left">dest：结果集合；</td>
<td class="org-left"><code>redis.sunionstore('inttag', ['tags', 'tags2'])</code></td>
<td class="org-left">求键为tags的集合和键为tags2的集合的并集并将其保存为inttag</td>
<td class="org-left">3</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">keys：键列表</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>sdiff(keys, *args)</code></td>
<td class="org-left">返回所有给定键的集合的差集</td>
<td class="org-left">keys：键列表</td>
<td class="org-left"><code>redis.sdiff(['tags', 'tags2'])</code></td>
<td class="org-left">返回键为tags的集合和键为tags2的集合的差集</td>
<td class="org-left"><code>{b'Book', b'Pen'}</code></td>
</tr>

<tr>
<td class="org-left"><code>sdiffstore(dest, keys, *args)</code></td>
<td class="org-left">求差集并将差集保存到dest集合</td>
<td class="org-left">dest：结果集合；keys：键列表</td>
<td class="org-left"><code>redis.sdiffstore('inttag', ['tags', 'tags2'])</code></td>
<td class="org-left">求键为tags的集合和键为tags2的集合的差集并将其保存为inttag`</td>
<td class="org-left">3</td>
</tr>

<tr>
<td class="org-left"><code>smembers(name)</code></td>
<td class="org-left">返回键为name的集合的所有元素</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.smembers('tags')</code></td>
<td class="org-left">返回键为tags的集合的所有元素</td>
<td class="org-left"><code>{b'Pen', b'Book', b'Coffee'}</code></td>
</tr>

<tr>
<td class="org-left"><code>srandmember(name)</code></td>
<td class="org-left">随机返回键为name的集合中的一个元素，但不删除元素</td>
<td class="org-left">name：键值</td>
<td class="org-left"><code>redis.srandmember('tags')</code></td>
<td class="org-left">随机返回键为tags的集合中的一个元素</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:0c7f498d-46a9-4848-b664-d78e305170e5" class="outline-4">
<h4 id="h:0c7f498d-46a9-4848-b664-d78e305170e5">值操作：有序集合操作</h4>
<div class="outline-text-4" id="text-h:0c7f498d-46a9-4848-b664-d78e305170e5">
<p>
有序集合比集合多了一个分数字段，利用它可以对集合中的数据进行排序
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">参数说明</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">示例说明</th>
<th scope="col" class="org-left">示例结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>zadd(name, *args, **kwargs)</code></td>
<td class="org-left">向键为name的zset中添加元素member，score用于排序。 如果该元素存在，则更新其顺序</td>
<td class="org-left">name： 键名；args：可变参数</td>
<td class="org-left"><code>redis.zadd('grade', 100, 'Bob', 98, 'Mike')</code></td>
<td class="org-left">向键为grade的zset中添加Bob（其score为100），并添加Mike（其score为98）</td>
<td class="org-left">2即添加的元素个数</td>
</tr>

<tr>
<td class="org-left"><code>zrem(name, *values)</code></td>
<td class="org-left">删除键为name的zset中的元素</td>
<td class="org-left">name：键名； values：元素</td>
<td class="org-left"><code>redis.zrem('grade', 'Mike')</code></td>
<td class="org-left">从键为grade的zset中删除Mike</td>
<td class="org-left">1即删除的元素个数</td>
</tr>

<tr>
<td class="org-left"><code>zincrby(name, value, amount=1)</code></td>
<td class="org-left">如果在键为name的zset中已经存在元素value，则将该元素的score增加amount；否则向该集合中添加该元素，其score的值为amount</td>
<td class="org-left">name：key名；</td>
<td class="org-left"><code>redis.zincrby('grade', 'Bob', -2)</code></td>
<td class="org-left">键为grade的zset中Bob的score减2</td>
<td class="org-left">98.0</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">value：元素；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">即修改后的值</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">amount：增长的score值</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>zrank(name, value)</code></td>
<td class="org-left">返回键为name的zset中元素的排名，按score从小到大排序，即名次</td>
<td class="org-left">name：键名； value：元素值</td>
<td class="org-left"><code>redis.zrank('grade', 'Amy')</code></td>
<td class="org-left">得到键为grade的zset中Amy的排名</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left"><code>zrevrank(name, value)</code></td>
<td class="org-left">返回键为name的zset中元素的倒数排名（按score从大到小排序），即名次</td>
<td class="org-left">name：键名；value：元素值</td>
<td class="org-left"><code>redis.zrevrank('grade', 'Amy')</code></td>
<td class="org-left">得到键为grade的zset中Amy的倒数排名</td>
<td class="org-left">2</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>zrevrange(name, start, end, withscores=False)</code></td>
<td class="org-left">返回键为name的zset（按score从大到小排序）中index从start到end的所有元素</td>
<td class="org-left">name：键值；</td>
<td class="org-left"><code>redis.zrevrange('grade', 0, 3)</code></td>
<td class="org-left">返回键为grade的zset中前四名元素</td>
<td class="org-left"><code>[b'Bob', b'Mike', b'Amy', b'James']</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">start：开始索引；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">end：结束索引；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">withscores：是否带score</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>zrangebyscore(name, min, max, start=None, num=None, withscores=False)</code></td>
<td class="org-left">返回键为name的zset中score在给定区间的元素</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.zrangebyscore('grade', 80, 95)</code></td>
<td class="org-left">返回键为grade的zset中score在80和95之间的元素</td>
<td class="org-left"><code>[b'Bob', b'Mike', b'Amy', b'James']</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">min：最低score；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">max：最高score；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">start：起始索引；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">num：个数</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">withscores：是否带score</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>zcount(name, min, max)</code></td>
<td class="org-left">返回键为name的zset中score在给定区间的数量</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.zcount('grade', 80, 95)</code></td>
<td class="org-left">返回键为grade的zset中score在80到95的元素个数</td>
<td class="org-left">2</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">min：最低score；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">max：最高score</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>zcard(name)</code></td>
<td class="org-left">返回键为name的zset的元素个数</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.zcard('grade')</code></td>
<td class="org-left">获取键为grade的zset中元素的个数</td>
<td class="org-left">3</td>
</tr>

<tr>
<td class="org-left"><code>zremrangebyrank(name, min, max)</code></td>
<td class="org-left">删除键为name的zset中排名在给定区间的元素</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.zremrangebyrank('grade', 0, 0)</code></td>
<td class="org-left">删除键为grade的zset中排名第一的元素</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">min：最低位次；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">即删除的元素个数</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">max：最高位次</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>zremrangebyscore(name, min, max)</code></td>
<td class="org-left">删除键为name的zset中score在给定区间的元素</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.zremrangebyscore('grade', 80, 90)</code></td>
<td class="org-left">删除score在80到90之间的元素</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">min：最低score；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">即删除的元素个数</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">max：最高score</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:3c73fe3f-0b8a-49ff-a401-a4cdc4e2077e" class="outline-4">
<h4 id="h:3c73fe3f-0b8a-49ff-a401-a4cdc4e2077e">值操作：散列操作</h4>
<div class="outline-text-4" id="text-h:3c73fe3f-0b8a-49ff-a401-a4cdc4e2077e">
<p>
Redis还提供了散列表的数据结构，我们可以用 <code>name</code>
指定一个散列表的名称，表内存储了各个键值对
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">参数说明</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">示例说明</th>
<th scope="col" class="org-left">示例结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>hset(name, key, value)</code></td>
<td class="org-left">向键为name的散列表中添加映射</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>hset('price', 'cake', 5)</code></td>
<td class="org-left">向键为price的散列表中添加映射关系，cake的值为5</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">key：映射键名；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">即添加的映射个数</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">value：映射键值</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hsetnx(name, key, value)</code></td>
<td class="org-left">如果映射键名不存在，则向键为name的散列表中添加映射</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>hsetnx('price', 'book', 6)</code></td>
<td class="org-left">向键为price的散列表中添加映射关系，book的值为6</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">key：映射键名</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">即添加的映射个数</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">value：映射键值</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hget(name, key)</code></td>
<td class="org-left">返回键为name的散列表中key对应的值</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.hget('price', 'cake')</code></td>
<td class="org-left">获取键为price的散列表中键名为cake的值</td>
<td class="org-left">5</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">key：映射键名</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hmget(name, keys, *args)</code></td>
<td class="org-left">返回键为name的散列表中各个键对应的值</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.hmget('price', ['apple', 'orange'])</code></td>
<td class="org-left">获取键为price的散列表中apple和orange的值</td>
<td class="org-left"><code>[b'3', b'7']</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">keys：映射键名列表</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hmset(name, mapping)</code></td>
<td class="org-left">向键为name的散列表中批量添加映射</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.hmset('price', {'banana': 2, 'pear': 6})</code></td>
<td class="org-left">向键为price的散列表中批量添加映射</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">mapping：映射字典</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hincrby(name, key, amount=1)</code></td>
<td class="org-left">将键为name的散列表中映射的值增加amount</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.hincrby('price', 'apple', 3)</code></td>
<td class="org-left">key为price的散列表中apple的值增加3</td>
<td class="org-left">6</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">key：映射键名；</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">修改后的值</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">amount：增长量</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hexists(name, key)</code></td>
<td class="org-left">键为name的散列表中是否存在键名为键的映射</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.hexists('price', 'banana')</code></td>
<td class="org-left">键为price的散列表中banana的值是否存在</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">key：映射键名</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hdel(name, *keys)</code></td>
<td class="org-left">在键为name的散列表中，删除键名为键的映射</td>
<td class="org-left">name：键名；</td>
<td class="org-left"><code>redis.hdel('price', 'banana')</code></td>
<td class="org-left">从键为price的散列表中删除键名为banana的映射</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">keys：映射键名</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>hlen(name)</code></td>
<td class="org-left">从键为name的散列表中获取映射个数</td>
<td class="org-left">name： 键名</td>
<td class="org-left"><code>redis.hlen('price')</code></td>
<td class="org-left">从键为price的散列表中获取映射个数</td>
<td class="org-left">6</td>
</tr>

<tr>
<td class="org-left"><code>hkeys(name)</code></td>
<td class="org-left">从键为name的散列表中获取所有映射键名</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.hkeys('price')</code></td>
<td class="org-left">从键为price的散列表中获取所有映射键名</td>
<td class="org-left"><code>[b'cake', b'book', b'banana', b'pear']</code></td>
</tr>

<tr>
<td class="org-left"><code>hvals(name)</code></td>
<td class="org-left">从键为name的散列表中获取所有映射键值</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.hvals('price')</code></td>
<td class="org-left">从键为price的散列表中获取所有映射键值</td>
<td class="org-left"><code>[b'5', b'6', b'2', b'6']</code></td>
</tr>

<tr>
<td class="org-left"><code>hgetall(name)</code></td>
<td class="org-left">从键为name的散列表中获取所有映射键值对</td>
<td class="org-left">name：键名</td>
<td class="org-left"><code>redis.hgetall('price')</code></td>
<td class="org-left">从键为price的散列表中获取所有映射键值对</td>
<td class="org-left"><code>{b'cake': b'5', b'book': b'6', b'orange': b'7', b'pear': b'6'}</code></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-h:df82b2f5-ca37-45e7-925f-df245841aae8" class="outline-3">
<h3 id="h:df82b2f5-ca37-45e7-925f-df245841aae8">订阅/发布</h3>
<div class="outline-text-3" id="text-h:df82b2f5-ca37-45e7-925f-df245841aae8">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SUBSCRIBE ch1 ch2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35746;&#38405;&#32773;&#20107;&#20808;&#35746;&#38405;&#25351;&#23450;&#30340;&#39057;&#36947;&#65292;&#20043;&#21518;&#21457;&#24067;&#30340;&#28040;&#24687;&#25165;&#33021;&#25910;&#21040;&#12290;&#38459;&#22622;&#30417;&#21548;</span>
1) <span style="color: #8b2252;">"subscribe"</span>
2) <span style="color: #8b2252;">"ch1"</span>
3) (integer) 1
1) <span style="color: #8b2252;">"subscribe"</span>
2) <span style="color: #8b2252;">"ch2"</span>
3) (integer) 2

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21457;&#24067;&#32773;&#21457;&#24067;&#28040;&#24687;</span>
127.0.0.1:6379&gt; PUBLISH ch1 test1
(integer) 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35746;&#38405;&#32773;&#20010;&#25968;</span>
127.0.0.1:6379&gt; PUBLISH ch1 test2
(integer) 1
127.0.0.1:6379&gt; PUBLISH ch2 t1
(integer) 1

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35746;&#38405;&#32773;&#26174;&#31034;</span>
127.0.0.1:6379&gt; SUBSCRIBE ch1 ch2
1) <span style="color: #8b2252;">"subscribe"</span>
2) <span style="color: #8b2252;">"ch1"</span>
3) (integer) 1
1) <span style="color: #8b2252;">"subscribe"</span>
2) <span style="color: #8b2252;">"ch2"</span>
3) (integer) 2
1) <span style="color: #8b2252;">"message"</span>
2) <span style="color: #8b2252;">"ch1"</span>
3) <span style="color: #8b2252;">"test1"</span>
1) <span style="color: #8b2252;">"message"</span>
2) <span style="color: #8b2252;">"ch1"</span>
3) <span style="color: #8b2252;">"test2"</span>
1) <span style="color: #8b2252;">"message"</span>
2) <span style="color: #8b2252;">"ch2"</span>
3) <span style="color: #8b2252;">"t1"</span>
</pre>
</div>

<p>
<b>订阅</b>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> redis

<span style="color: #a020f0;">with</span> redis.Redis.from_url(<span style="color: #8b2252;">"redis://:111111@10.0.0.5/4"</span>) <span style="color: #a020f0;">as</span> c:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28040;&#36153;&#32773;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38656;&#35201;&#20808;&#21019;&#24314;&#35746;&#38405;&#23545;&#35937;</span>
    <span style="color: #a0522d;">p1</span> = c.pubsub()
    p1.subscribe(<span style="color: #8b2252;">"c1"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;"># &#38459;&#22622;&#30340;&#26041;&#24335;&#25509;&#25910;&#28040;&#24687;</span>
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> p1.listen():
        <span style="color: #483d8b;">print</span>(i,<span style="color: #483d8b;">type</span>(i))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;&#38459;&#22622;&#30340;&#26041;&#24335;&#25509;&#25910;&#28040;&#24687;</span>
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #a0522d;">msg</span> = p1.get_message(ignore_subscribe_messages=<span style="color: #008b8b;">True</span>)
        <span style="color: #a020f0;">if</span> msg:
            <span style="color: #483d8b;">print</span>(msg)
        time.sleep(0.5)
</pre>
</div>

<p>
<b>发布</b>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis

<span style="color: #a020f0;">with</span> redis.Redis.from_url(<span style="color: #8b2252;">"redis://:111111@10.0.0.5/4"</span>) <span style="color: #a020f0;">as</span> c:
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(c), c)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#20135;&#32773;</span>
    <span style="color: #a0522d;">p</span> = c.publish(<span style="color: #8b2252;">"c1"</span>, 11111)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#35746;&#38405;&#30340;&#20010;&#25968;:"</span>, p)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dae8b734-1bd4-4c30-9f92-1c526d0f233d" class="outline-3">
<h3 id="h:dae8b734-1bd4-4c30-9f92-1c526d0f233d">pipeline</h3>
<div class="outline-text-3" id="text-h:dae8b734-1bd4-4c30-9f92-1c526d0f233d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis

<span style="color: #a0522d;">r</span> = redis.Redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/8'</span>)
<span style="color: #a0522d;">pool</span> = r.connection_pool

<span style="color: #b22222;"># </span><span style="color: #b22222;">pipeline, &#19968;&#31995;&#21015;&#21160;&#20316;</span>
<span style="color: #a0522d;">pl</span> = r.pipeline(<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20107;&#21153;&#65292;&#35201;&#20040;&#20840;&#37096;&#25104;&#21151;&#25191;&#34892;&#65292;&#35201;&#20040;&#22833;&#36133;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(pl), pl, <span style="color: #483d8b;">id</span>(pl))
<span style="color: #a0522d;">x</span> = pl.mset({<span style="color: #8b2252;">'s1'</span>:1, <span style="color: #8b2252;">'s2'</span>:2, <span style="color: #8b2252;">'s3'</span>:3})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(pl), pl, <span style="color: #483d8b;">id</span>(pl)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#30340;&#26159;pipeline&#33258;&#24049;&#12290;redis.client.Pipeline</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(x), x, <span style="color: #483d8b;">id</span>(x))
pl.msetnx({<span style="color: #8b2252;">'s4'</span>:4, <span style="color: #8b2252;">'s3'</span>:3})
<span style="color: #a0522d;">results</span> = pl.mget((<span style="color: #8b2252;">'s1'</span>, <span style="color: #8b2252;">'s2'</span>, <span style="color: #8b2252;">'s3'</span>, <span style="color: #8b2252;">'s4'</span>)).execute()
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(results), results)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38142;&#24335;&#20889;&#27861;</span>
<span style="color: #a0522d;">results</span> = pl.mset(
        {<span style="color: #8b2252;">'s1'</span>:1, <span style="color: #8b2252;">'s2'</span>:2, <span style="color: #8b2252;">'s3'</span>:3}
    ).msetnx(
        {<span style="color: #8b2252;">'s4'</span>:4, <span style="color: #8b2252;">'s3'</span>:3}
    ).mget((<span style="color: #8b2252;">'s1'</span>, <span style="color: #8b2252;">'s2'</span>, <span style="color: #8b2252;">'s3'</span>, <span style="color: #8b2252;">'s4'</span>)).execute()
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(results), results) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32467;&#26524;&#26159;&#19968;&#20010;&#21015;&#34920;&#65292;&#26377;&#27599;&#19968;&#20010;&#21629;&#20196;&#25191;&#34892;&#30340;&#32467;&#26524;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;class 'list'&gt; [True, False, [b'1', b'2', b'3', None]]</span>

r.close()
</pre>
</div>

<p>
特别注意，如果我们需要事务处理的时候，可以考虑pipeline中开启，保证一系列操作完整操作。
</p>
</div>
</div>
<div id="outline-container-h:4696288d-e308-4a21-9a63-c08e33f48d69" class="outline-3">
<h3 id="h:4696288d-e308-4a21-9a63-c08e33f48d69">哨兵模式编程</h3>
<div class="outline-text-3" id="text-h:4696288d-e308-4a21-9a63-c08e33f48d69">
<p>
<a href="https://github.com/RedisLabs/redis-py#sentinel-support">https://github.com/RedisLabs/redis-py#sentinel-support</a>
</p>

<p>
通过哨兵获取主节点和从节点
</p>

<ul class="org-ul">
<li>返回的元组方式</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> redis.sentinel <span style="color: #a020f0;">import</span> Sentinel

<span style="color: #a0522d;">sentinels</span> = Sentinel([(<span style="color: #8b2252;">"10.0.0.4"</span>, 26379)])

<span style="color: #b22222;"># </span><span style="color: #b22222;">mymaster2&#26159;&#38598;&#32676;&#30340;&#26631;&#35782;&#31526;</span>
<span style="color: #483d8b;">print</span>(sentinels.discover_master(<span style="color: #8b2252;">"mymaster2"</span>))
<span style="color: #483d8b;">print</span>(sentinels.discover_slaves(<span style="color: #8b2252;">"mymaster2"</span>))

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">('10.0.0.5', 6379)</span>
<span style="color: #8b2252;">[('10.0.0.4', 6379)]</span>
<span style="color: #8b2252;">"""</span>
</pre>
</div>

<p>
如果 <b>抛异常，无法访问Sentinel</b> ，请修改Sentinel的配置，增加 <code>protected-mode no</code> 。保护模式如果开启，只接受回环地址连接，拒绝外部链接，而且正常应该配置多个哨兵，避免一个哨兵出现独裁情况，如果配置多个哨兵，开启保护，也会拒绝其它sentinel的连接，从而导致哨兵配置无法生效。
</p>

<ul class="org-ul">
<li>返回Redis类的方式</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> redis.sentinel <span style="color: #a020f0;">import</span> Sentinel

<span style="color: #a0522d;">sentinels</span> = Sentinel([(<span style="color: #8b2252;">"10.0.0.4"</span>, 26379)])

<span style="color: #a0522d;">m_rd</span> = sentinels.master_for(<span style="color: #8b2252;">"mymaster2"</span>)
<span style="color: #a0522d;">s_rd</span> = sentinels.slave_for(<span style="color: #8b2252;">"mymaster2"</span>)
<span style="color: #483d8b;">print</span>(m_rd, <span style="color: #483d8b;">type</span>(m_rd), s_rd, <span style="color: #483d8b;">type</span>(s_rd))

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">Redis&lt;SentinelConnectionPool&lt;service=mymaster2(master)&gt; &lt;class 'redis.client.Redis'&gt;</span>
<span style="color: #8b2252;">Redis&lt;SentinelConnectionPool&lt;service=mymaster2(slave)&gt; &lt;class 'redis.client.Redis'&gt;</span>
<span style="color: #8b2252;">"""</span>
</pre>
</div>

<p>
返回的Redis类可以直接用来连接redis
</p>

<p>
需要加入库号和密码
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> redis.sentinel <span style="color: #a020f0;">import</span> Sentinel

<span style="color: #a0522d;">sentinels</span> = Sentinel([(<span style="color: #8b2252;">"10.0.0.4"</span>, 26379)])

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;&#28304;&#30721;&#21487;&#20197;&#30475;&#20986;&#65292;&#21487;&#20197;&#36890;&#36807;&#22622;&#20837;&#24211;&#21495;&#21644;&#23494;&#30721;&#30340;&#26041;&#24335;&#26469;&#35775;&#38382;&#24211;</span>
<span style="color: #a0522d;">m_rd</span> = sentinels.master_for(<span style="color: #8b2252;">"mymaster2"</span>, db=1, password=<span style="color: #8b2252;">"111111"</span>)
<span style="color: #a0522d;">s_rd</span> = sentinels.slave_for(<span style="color: #8b2252;">"mymaster2"</span>, db=1, password=<span style="color: #8b2252;">"111111"</span>)
<span style="color: #483d8b;">print</span>(m_rd, <span style="color: #483d8b;">type</span>(m_rd), s_rd, <span style="color: #483d8b;">type</span>(s_rd))
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;&#36820;&#22238;&#30340;&#31867;&#30452;&#25509;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="color: #483d8b;">print</span>(m_rd.keys())
<span style="color: #483d8b;">print</span>(s_rd.keys())
<span style="color: #483d8b;">print</span>(m_rd.get(<span style="color: #8b2252;">"a"</span>))
<span style="color: #483d8b;">print</span>(s_rd.get(<span style="color: #8b2252;">"a"</span>))

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">Redis&lt;SentinelConnectionPool&lt;service=mymaster2(master)&gt; &lt;class 'redis.client.Redis'&gt; Redis&lt;SentinelConnectionPool&lt;service=mymaster2(slave)&gt; &lt;class 'redis.client.Redis'&gt;</span>
<span style="color: #8b2252;">[b's2', b'a', b's1', b's3', b'c', b'3', b'd']</span>
<span style="color: #8b2252;">[b'd', b'c', b's3', b'a', b's2', b'3', b's1']</span>
<span style="color: #8b2252;">b'2'</span>
<span style="color: #8b2252;">b'2'</span>
<span style="color: #8b2252;">"""</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:2da0aae3-853f-45cc-baf9-1f2c829dea04" class="outline-2">
<h2 id="h:2da0aae3-853f-45cc-baf9-1f2c829dea04">Scrapy-redis组件</h2>
<div class="outline-text-2" id="text-h:2da0aae3-853f-45cc-baf9-1f2c829dea04">
</div>
<div id="outline-container-h:36314aa3-da6a-4e00-a9c4-704cd7607c74" class="outline-3">
<h3 id="h:36314aa3-da6a-4e00-a9c4-704cd7607c74">Scrapy-redis组件</h3>
<div class="outline-text-3" id="text-h:36314aa3-da6a-4e00-a9c4-704cd7607c74">
<p>
这是一个能给Scrapy框架引入分布式的组件。把架构中的Scheduler替换成redis.
</p>

<p>
分布式由Redis提供，可以在不同节点上运行爬虫，共用同一个Redis实例。
</p>

<p>
在Redis中存储待爬取的URLs、Items。
</p>

<p>
github: <a href="https://github.com/rmax/scrapy-redis">https://github.com/rmax/scrapy-redis</a>
</p>

<p>
特点：
</p>
<ul class="org-ul">
<li>分布式爬取/抓取
<ul class="org-ul">
<li>您可以启动多个共享单个 redis 队列的爬虫实例。最适合广泛的多域名爬取。</li>
</ul></li>
<li>分布式后处理
<ul class="org-ul">
<li>抓取的项目将被推送到 redis 队列中，这意味着您可以启动共享项目队列的任意数量的后处理进程。</li>
</ul></li>
<li>Scrapy 即插即用组件
<ul class="org-ul">
<li>调度程序 + 重复过滤器、项目管道、基础蜘蛛。</li>
</ul></li>
<li>在此分叉版本中：添加了json对 Redis 数据的支持</li>
</ul>
</div>
<div id="outline-container-h:1a605ae5-ebfc-4d17-b7b5-944b01af5d76" class="outline-4">
<h4 id="h:1a605ae5-ebfc-4d17-b7b5-944b01af5d76">安装</h4>
<div class="outline-text-4" id="text-h:1a605ae5-ebfc-4d17-b7b5-944b01af5d76">
<div class="org-src-container">
<pre class="src src-python">pip install scrapy-redis
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c9c13b24-f4fe-46b5-abcf-4a86403bc5da" class="outline-4">
<h4 id="h:c9c13b24-f4fe-46b5-abcf-4a86403bc5da">配置</h4>
<div class="outline-text-4" id="text-h:c9c13b24-f4fe-46b5-abcf-4a86403bc5da">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">Enables scheduling storing requests queue in redis. </span>
<span style="color: #a0522d;">SCHEDULER</span> = <span style="color: #8b2252;">"scrapy_redis.scheduler.Scheduler"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Ensure all spiders share same duplicates filter through redis. </span>
<span style="color: #a0522d;">DUPEFILTER_CLASS</span> = <span style="color: #8b2252;">"scrapy_redis.dupefilter.RFPDupeFilter"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Store scraped item in redis for post-processing.</span>
<span style="color: #a0522d;">ITEM_PIPELINES</span> = { <span style="color: #8b2252;">'scrapy_redis.pipelines.RedisPipeline'</span>: 300}

<span style="color: #b22222;"># </span><span style="color: #b22222;">The item pipeline serializes and stores the items in this redis key.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#20010;key&#24456;&#37325;&#35201;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_ITEMS_KEY = '%(spider)s:items'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Specify the host and port to use when connecting to Redis (optional). </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_HOST = 'localhost'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_PORT = 6379</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Specify the full Redis URL for connecting (optional).</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">If set, this takes precedence over the REDIS_HOST and REDIS_PORT settings.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_URL = 'redis://user:pass@hostname:9001'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Default start urls key for RedisSpider and RedisCrawlSpider.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_START_URLS_KEY = '%(name)s:start_urls'</span>
</pre>
</div>

<p>
在以下方面做了增强
</p>

<p>
Scheduler + Duplication Filter, Item Pipeline, Base Spiders
</p>
<ul class="org-ul">
<li>Duplication Filter
<ul class="org-ul">
<li>scrapy使用set来去重，去重的指纹有method+url+body+header去重比例小。参考，scrapy.utils.request.request_fingerprint</li>
<li>scrapy-redis使用同样的scrapy指纹算法，使用redis的set类型去重。生成指纹的hash存入Redis set中比对</li>
<li>使用Redis服务，实现 <b>增量式爬虫</b></li>
</ul></li>
<li>Scheduler
<ul class="org-ul">
<li>本质上将原来的普通队列，变成了redis以提供多爬虫多进程共享，并行能力增强。</li>
</ul></li>
<li>Duplication Filter
<ul class="org-ul">
<li>scrapy使用set来去重，scrapy-redis使用redis的set类型去重 Item Pipeline</li>
</ul></li>
<li>Item Pipelline
<ul class="org-ul">
<li>在Item Pipeline增加一个处理，即将数据items存入redis的items queue中 Base Spiders</li>
</ul></li>
<li>Base Spiders
<ul class="org-ul">
<li>提供了使用了RedisMixin的RedisSpider和RedisCrawlSpider，从Redis中读取Url。</li>
</ul></li>
</ul>

<p>
Redis是服务，爬虫就是它的客户端，客户端就可以扩展出并行的很多爬虫一起爬取。
</p>
</div>
</div>
</div>
<div id="outline-container-h:1cfccd4e-47c5-4958-8e34-0c6e4e2ed3b7" class="outline-3">
<h3 id="h:1cfccd4e-47c5-4958-8e34-0c6e4e2ed3b7">redis安装</h3>
<div class="outline-text-3" id="text-h:1cfccd4e-47c5-4958-8e34-0c6e4e2ed3b7">
<p>
这里不再赘述。
</p>
</div>
</div>
<div id="outline-container-h:6681cfb6-c61d-4ad8-bd14-53d110ddc6c5" class="outline-3">
<h3 id="h:6681cfb6-c61d-4ad8-bd14-53d110ddc6c5">豆瓣影评分析项目</h3>
<div class="outline-text-3" id="text-h:6681cfb6-c61d-4ad8-bd14-53d110ddc6c5">
</div>
<div id="outline-container-h:7b16c6c2-72aa-4a18-85b8-76c17469211d" class="outline-4">
<h4 id="h:7b16c6c2-72aa-4a18-85b8-76c17469211d">抓取内容分析</h4>
<div class="outline-text-4" id="text-h:7b16c6c2-72aa-4a18-85b8-76c17469211d">
<p>
抓取最新top 1电影，分析其影评
</p>

<p>
提取影评的xpath = //div[@class="comment-item"]//span[@class="short"]
</p>
</div>
</div>
<div id="outline-container-h:58e3cfc4-6eac-4dff-b40b-3df381af5258" class="outline-4">
<h4 id="h:58e3cfc4-6eac-4dff-b40b-3df381af5258">创建Scrapy项目</h4>
<div class="outline-text-4" id="text-h:58e3cfc4-6eac-4dff-b40b-3df381af5258">
<div class="org-src-container">
<pre class="src src-sh">scrapy startproject review .
</pre>
</div>
</div>
</div>
<div id="outline-container-h:50735c64-e988-49ef-9526-05e771abd10c" class="outline-4">
<h4 id="h:50735c64-e988-49ef-9526-05e771abd10c">配置</h4>
<div class="outline-text-4" id="text-h:50735c64-e988-49ef-9526-05e771abd10c">
<p>
D:\project\pyproj\pycharm\books\settings.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">BOT_NAME</span> = <span style="color: #8b2252;">"review"</span>

<span style="color: #a0522d;">SPIDER_MODULES</span> = [<span style="color: #8b2252;">"review.spiders"</span>]
<span style="color: #a0522d;">NEWSPIDER_MODULE</span> = <span style="color: #8b2252;">"review.spiders"</span>

<span style="color: #a0522d;">ADDONS</span> = {}

<span style="color: #a0522d;">USER_AGENT</span> = <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36"</span>

<span style="color: #a0522d;">ROBOTSTXT_OBEY</span> = <span style="color: #008b8b;">False</span>
<span style="color: #a0522d;">CONCURRENT_REQUESTS</span> = 4
<span style="color: #a0522d;">DOWNLOAD_DELAY</span> = 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#31186;&#29228;&#19968;&#27425;</span>
<span style="color: #a0522d;">COOKIES_ENABLED</span> = <span style="color: #008b8b;">False</span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#27425;&#20840;&#26032;&#30340;&#35831;&#27714;&#65307;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Disable Telnet Console (enabled by default)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">TELNETCONSOLE_ENABLED = False</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">Enable or disable spider middlewares</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See https://docs.scrapy.org/en/latest/topics/spider-middleware.html</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">SPIDER_MIDDLEWARES = {</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">'dbreview.middlewares.DbreviewSpiderMiddleware': 543,</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Enable or disable downloader middlewares</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See https://docs.scrapy.org/en/latest/topics/downloader-middleware.html</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">DOWNLOADER_MIDDLEWARES = {</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">'dbreview.middlewares.DbreviewDownloaderMiddleware': 543,</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Enable or disable extensions</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See https://docs.scrapy.org/en/latest/topics/extensions.html</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">EXTENSIONS = {</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">'scrapy.extensions.telnet.TelnetConsole': None,</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Configure item pipelines</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">See https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ITEM_PIPELINES = {</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">#    'dbreview.pipelines.DbreviewPipeline': 299,</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">'scrapy_redis.pipelines.RedisPipeline': 300</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">}</span>



<span style="color: #b22222;"># </span><span style="color: #b22222;">scrapy-redis</span>
<span style="color: #a0522d;">DUPEFILTER_CLASS</span> = <span style="color: #8b2252;">"scrapy_redis.dupefilter.RFPDupeFilter"</span>
<span style="color: #a0522d;">SCHEDULER</span> = <span style="color: #8b2252;">"scrapy_redis.scheduler.Scheduler"</span>
<span style="color: #a0522d;">REDIS_URL</span> = <span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Default start urls key for RedisSpider and RedisCrawlSpider.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_START_URLS_KEY = '%(name)s:start_urls'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#40664;&#35748;&#30340;ITEM_PIPELINES</span>
<span style="color: #a0522d;">ITEM_PIPELINES</span> = {
    <span style="color: #8b2252;">'scrapy_redis.pipelines.RedisPipeline'</span>: 300
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4299e44e-6b97-4ed4-9dc4-ff6d2cce18de" class="outline-4">
<h4 id="h:4299e44e-6b97-4ed4-9dc4-ff6d2cce18de">构建Item</h4>
<div class="outline-text-4" id="text-h:4299e44e-6b97-4ed4-9dc4-ff6d2cce18de">
<p>
D:\project\pyproj\pycharm\review\items.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ReviewItem</span>(scrapy.Item):
    <span style="color: #a0522d;">comment</span> = scrapy.Field()

    <span style="color: #b22222;"># </span><span style="color: #b22222;">def __repr__(self):</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">return "{}".format(dict(self))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9927269f-1583-4aff-aa07-6b78a515a757" class="outline-4">
<h4 id="h:9927269f-1583-4aff-aa07-6b78a515a757">构建爬虫</h4>
<div class="outline-text-4" id="text-h:9927269f-1583-4aff-aa07-6b78a515a757">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29228;&#34411;</span>
scrapy genspider -t crawl dbreview douban.com

(.venv1) PS D:\project\pyproj\pycharm&gt; scrapy list   
dbreview
</pre>
</div>

<p>
写完先测试，然后将类型改为RedisCrawlSpider
</p>

<p>
review\spiders\dbreview.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> scrapy
<span style="color: #a020f0;">from</span> scrapy.linkextractors <span style="color: #a020f0;">import</span> LinkExtractor
<span style="color: #a020f0;">from</span> scrapy.spiders <span style="color: #a020f0;">import</span> CrawlSpider, Rule
<span style="color: #a020f0;">from</span> scrapy_redis.spiders <span style="color: #a020f0;">import</span> RedisCrawlSpider
<span style="color: #a020f0;">from</span> ..items <span style="color: #a020f0;">import</span> ReviewItem

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">DbreviewSpider</span>(RedisCrawlSpider): <span style="color: #b22222;"># </span><span style="color: #b22222;">-t crawl RedisCrawlSpider; -t basic RedisSpider</span>
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">"dbreview"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">REDIS_START_URLS_KEY : default: "&lt;spider.name&gt;:start_urls"</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">LPUSH dbreview:start_urls https://movie.douban.com/subject/27605659/comments?status=P</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">"douban.com"</span>]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">start_urls = ["https://movie.douban.com/subject/27605659/comments?status=P"] # &#36215;&#22987;&#39029; &#35201;&#25442;&#25481;&#65292;&#36890;&#36807;redis&#23384;&#20837;</span>
    <span style="color: #8b2252;">"""Spider that reads urls from redis queue (myspider:start_urls)"""</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">redis_key = 'dbreview:start_urls' # &#32570;&#30465;&#20540;&#26159; REDIS_START_URLS_KEY &#37197;&#32622;</span>

    <span style="color: #a0522d;">rules</span> = (Rule(LinkExtractor(allow=r<span style="color: #8b2252;">"start=20"</span>), callback=<span style="color: #8b2252;">"parse_item"</span>, follow=<span style="color: #008b8b;">False</span>),)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">rules = (Rule(LinkExtractor(allow=r"start=\d+"), callback="parse_item", follow=True),)</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse_item</span>(<span style="color: #a020f0;">self</span>, response):
        <span style="color: #a0522d;">comments</span> = response.xpath(<span style="color: #8b2252;">'//span[@class="short"]//text()'</span>).extract() <span style="color: #b22222;"># </span><span style="color: #b22222;">list</span>
        <span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> comments:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(type(c), c, '++++++++++++')</span>
            <span style="color: #a0522d;">item</span> = ReviewItem()
            <span style="color: #a0522d;">item</span>[<span style="color: #8b2252;">'comment'</span>] = c
            <span style="color: #a020f0;">yield</span>  item
</pre>
</div>
</div>
<div id="outline-container-h:207c4109-615b-411c-9099-bcb1d46abbbd" class="outline-5">
<h5 id="h:207c4109-615b-411c-9099-bcb1d46abbbd">爬取</h5>
<div class="outline-text-5" id="text-h:207c4109-615b-411c-9099-bcb1d46abbbd">
<div class="org-src-container">
<pre class="src src-sh">scrapy crawl dbreview
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7676e9be-a7a0-4343-a7d0-f6f6c4e46aa6" class="outline-5">
<h5 id="h:7676e9be-a7a0-4343-a7d0-f6f6c4e46aa6">手动添加开始url</h5>
<div class="outline-text-5" id="text-h:7676e9be-a7a0-4343-a7d0-f6f6c4e46aa6">
<p>
会发现程序会卡住，这是因为在等待起始URL，手动添加开始url
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LPUSH dbreview:start_urls https://movie.douban.com/subject/27605659/comments?<span style="color: #a0522d;">status</span>=P
</pre>
</div>
</div>
</div>
<div id="outline-container-h:11c4443b-c4b7-4697-b5c0-b2ae28ef308e" class="outline-5">
<h5 id="h:11c4443b-c4b7-4697-b5c0-b2ae28ef308e">开启pipeline</h5>
<div class="outline-text-5" id="text-h:11c4443b-c4b7-4697-b5c0-b2ae28ef308e">
<p>
settings.py
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#40664;&#35748;&#30340;ITEM_PIPELINES</span>
ITEM_PIPELINES = {
    <span style="color: #8b2252;">'scrapy_redis.pipelines.RedisPipeline'</span>: 300
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dda3f708-7dce-4893-94eb-7add74a8f5a8" class="outline-5">
<h5 id="h:dda3f708-7dce-4893-94eb-7add74a8f5a8">代理（可选）</h5>
<div class="outline-text-5" id="text-h:dda3f708-7dce-4893-94eb-7add74a8f5a8">
<p>
解决反爬问题
</p>

<p>
思路：在发起 HTTP 请求之前，会经过下载中间件，自定义一个下载中间件，在其中临时获取一个代理地址，然后再发起 HTTP 请求。
</p>

<p>
访问 <a href="https://myip.ipip.net/">https://myip.ipip.net/</a> 测试自己的出公网口IP
</p>

<p>
IP代理商
</p>
<ul class="org-ul">
<li><a href="https://h.wandouip.com/get/api">https://h.wandouip.com/get/api</a></li>
</ul>

<p>
1、下载中间件
</p>

<p>
仿照 middlewares.py 中的下载中间件编写 process_request阶段，返回 None。
</p>

<p>
review\middlewares.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> scrapy.http.request <span style="color: #a020f0;">import</span> Request
<span style="color: #a020f0;">import</span> random

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ProxyDownloaderMiddleware</span>:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#20195;&#29702;IP&#27744;&#65292;&#21487;&#20197;&#20174;&#32593;&#32476;&#25628;&#32034;&#65292;&#21487;&#20197;&#20174;&#37197;&#32622;&#25991;&#20214;&#20013;&#35835;&#21462;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#20889;&#19968;&#20010;&#26041;&#27861;&#65292;&#20174;IP&#30340;json&#20013;&#25552;&#21462;&#65292;&#21487;&#20197;&#23384;redis, &#21152;&#36807;&#26399;</span>
    <span style="color: #a0522d;">proxy_ip</span> = <span style="color: #8b2252;">'192.168.0.163'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20195;&#29702;ip</span>
    <span style="color: #a0522d;">proxy_port</span> = <span style="color: #8b2252;">'58591'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20195;&#29702;&#31471;&#21475;&#21495;</span>
    <span style="color: #a0522d;">proxies</span> = [
        f<span style="color: #8b2252;">'http://</span>{proxy_ip}<span style="color: #8b2252;">:</span>{proxy_port}<span style="color: #8b2252;">'</span>,
    ]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">process_request</span>(<span style="color: #a020f0;">self</span>, request: Request, spider):
        request.<span style="color: #a0522d;">meta</span>[<span style="color: #8b2252;">'proxy'</span>] = random.choice(<span style="color: #a020f0;">self</span>.proxies)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;proxy</span>
</pre>
</div>
<p>
2、配置
</p>

<p>
在 settings.py 中配置：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">3&#31186;</span>
<span style="color: #a0522d;">DOWNLOAD_DELAY</span> = 3

<span style="color: #a0522d;">DOWNLOADER_MIDDLEWARES</span> = {
    <span style="color: #8b2252;">'spiderman.middlewares.ProxyDownloaderMiddleware'</span>: 125,
}
</pre>
</div>

<p>
增加一个测试用的 spider 类，如果代理设置成功，该爬虫返回的内容就会是当前代理的信息：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">review\spiders\iptest.py</span>
<span style="color: #a020f0;">import</span> scrapy

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">IPTestSpider</span>(scrapy.Spider):
    <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'test'</span>
    <span style="color: #a0522d;">allowed_domains</span> = [<span style="color: #8b2252;">'ipip.net'</span>]
    <span style="color: #a0522d;">start_urls</span> = [<span style="color: #8b2252;">'http://myip.ipip.net/'</span>]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">parse</span>(<span style="color: #a020f0;">self</span>, response, **kwargs):
        <span style="color: #a0522d;">text</span> = response.text
        <span style="color: #483d8b;">print</span>(1, <span style="color: #8b2252;">'--&gt;'</span>, text)
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">None</span>
</pre>
</div>

<p>
执行
</p>
<div class="org-src-container">
<pre class="src src-sh">scrapy crawl test
</pre>
</div>
<p>
查看打印的内容，是不是代理的地址信息。如果代理测试成功，就可以继续下面的操作。
</p>
</div>
</div>
</div>
<div id="outline-container-h:43b7b12a-fdc5-4de4-9659-c289ede5898b" class="outline-4">
<h4 id="h:43b7b12a-fdc5-4de4-9659-c289ede5898b">分析</h4>
<div class="outline-text-4" id="text-h:43b7b12a-fdc5-4de4-9659-c289ede5898b">
<p>
使用爬虫，爬取所有数据，然后使用redis中的数据开始分析
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis
<span style="color: #a020f0;">import</span> simplejson

<span style="color: #a0522d;">client</span> = redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/0'</span>)
<span style="color: #a0522d;">comments</span> = client.lrange(<span style="color: #8b2252;">'dbreview:items'</span>, 0, -1)

<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> comments:
    <span style="color: #a0522d;">x</span> = simplejson.loads(c).get(<span style="color: #8b2252;">'comment'</span>)
    <span style="color: #a020f0;">if</span> x:
        <span style="color: #483d8b;">print</span>(x)

client.close()
<span style="color: #b22222;">#</span><span style="color: #b22222;">--------------------------------------------------------</span>
&#36842;&#22763;&#23612;&#25784;&#20986;&#26469;&#30340;&#29609;&#24847;&#65292;&#31967;&#36427;&#20102;&#19968;&#20010;&#22909;&#39064;&#26448;&#65292;&#19968;&#24110;&#20013;&#22269;&#28436;&#21592;&#35828;&#30528;&#19981;&#37027;&#20040;&#26631;&#20934;&#30340;&#33521;&#35821;&#22312;&#37027;&#37324;&#25343;&#33108;&#25343;&#35843;&#30340;&#24565;&#21488;&#35789;&#30495;&#26159;&#23604;&#23596;&#33267;&#26497;
-----------------------
&#65288;70/100&#65289;&#24037;&#25972;&#27969;&#30021;&#21512;&#26684;&#30340;&#21830;&#19994;&#29255;&#12290;&#36842;&#22763;&#23612;&#20844;&#20027;&#30005;&#24433;&#37324;&#21697;&#36136;&#19978;&#20056;&#30340;&#23384;&#22312;&#12290;&#21016;&#20134;&#33778;&#30340;&#34920;&#28436;&#26159;&#27809;&#26377;&#38382;&#39064;&#30340;&#65292;&#21160;&#20316;&#25103;&#31934;&#24425;&#65292;&#30011;&#38754;&#36136;&#24863;&#19968;&#27969;&#65292;&#29255;&#23614;&#20986;&#23383;&#24149;&#26102;&#30340;title design&#36229;&#22909;&#30475;&#12290;&#20013;&#22269;&#20844;&#20027;&#33457;&#26408;&#20848;&#27809;&#26377;&#35753;&#20154;&#22833;&#26395;&#12290;
-----------------------
&#22826;&#20986;&#25103;&#20102;&#65292;&#27827;&#21271;&#22303;&#27004;&#65311;Niubi
-----------------------
&#36319;&#29609;&#20284;&#30340;&#65292;&#24369;&#26234;&#19968;&#32676;&#20154;&#65292;&#25104;&#23601;&#19968;&#20010;&#20154;&#12290;
&#30495;&#23454;&#19982;&#36923;&#36753;&#24182;&#19981;&#38656;&#35201;&#12290;
-----------------------
&#20808;&#35828;&#32467;&#35770;&#65306;&#22771;&#26159;&#20013;&#22269;&#22771;&#65292;&#39746;&#36824;&#26159;&#32769;&#22806;&#37027;&#20010;&#21170;&#65292;&#36896;&#22411;&#26159;&#26085;&#26412;&#33402;&#20238;&#65292;&#20869;&#26680;&#26159;&#32769;&#32654;&#36229;&#32423;&#33521;&#38596;&#20027;&#20041;&#12290;
&#24635;&#20043;&#26159;&#22806;&#22269;&#23545;&#20013;&#22269;&#29255;&#38754;&#21270;&#30340;&#35748;&#35782;&#12290;
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;
&#30475;&#23436;&#25402;&#19981;&#36866;&#30340;&#65292;&#30005;&#24433;&#36824;&#26159;&#26126;&#26174;&#30340;&#36842;&#22763;&#23612;&#39118;&#26684;&#12290;&#33021;&#29702;&#35299;&#36842;&#22763;&#23612;&#24819;&#20984;&#29616;&#33457;&#26408;&#20848;&#30340;&#33521;&#21191;&#22899;&#24615;&#35282;&#33394;&#65292;&#20294;&#26159;&#22914;&#26524;&#36825;&#31181;&#31934;&#31070;&#26159;&#20197;&#36140;&#20302;&#20013;&#22269;&#21644;&#22899;&#24615;&#20026;&#34924;&#25176;&#65292;&#37027;&#20040;&#25105;&#34920;&#31034;&#25298;&#32477;&#65281;&#25972;&#20307;&#25402;&#23616;&#38480;&#30340;&#65292;&#20174;&#24041;&#20432;&#22899;&#24043;&#35282;&#33394;&#30340;&#33707;&#21517;&#20854;&#22937;&#21040;&#21018;&#35757;&#32451;&#19981;&#20037;&#30340;&#20960;&#20154;&#23567;&#38431;&#25327;&#25937;&#22269;&#23478;&#21644;&#30343;&#24093;&#65292;&#20877;&#21040;&#25972;&#20307;&#33829;&#36896;&#30340;&#22899;&#24615;&#20197;&#19977;&#20174;&#22235;&#24503;&#21644;&#23233;&#20154;&#20026;&#33635;&#32768;&#30340;&#22855;&#24618;&#24605;&#24819;&#12290;&#22810;&#31181;&#25991;&#21270;&#26434;&#31941;&#65292;&#22810;&#37325;&#39118;&#26684;&#26434;&#31941;&#12290;&#24433;&#29255;&#26174;&#28982;&#19981;&#20102;&#35299;&#20013;&#22269;&#25991;&#21270;&#21644;&#33457;&#26408;&#20848;&#31934;&#31070;&#12290;&#22823;&#27010;&#20174;&#22836;&#33267;&#23614;&#26368;&#33021;&#25552;&#29616;&#33457;&#26408;&#20848;&#31934;&#31070;&#30340;&#23601;&#26159;&#21073;&#19978;&#37027;&#20960;&#20010;&#23383;&#20102;&#21543;&#12290;
-----------------------
</pre>
</div>
</div>
<div id="outline-container-h:f26cd8a2-bbcc-40f0-a446-15b2b60100ec" class="outline-5">
<h5 id="h:f26cd8a2-bbcc-40f0-a446-15b2b60100ec">jieba分词-结巴分词</h5>
<div class="outline-text-5" id="text-h:f26cd8a2-bbcc-40f0-a446-15b2b60100ec">
<p>
官网 <a href="https://github.com/fxsjy/jieba">https://github.com/fxsjy/jieba</a>
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install jieba
</pre>
</div>

<p>
测试代码
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> jieba

<span style="color: #a0522d;">seg_list</span> = jieba.cut(<span style="color: #8b2252;">"&#25105;&#26469;&#21040;&#21271;&#20140;&#28165;&#21326;&#22823;&#23398;"</span>, cut_all=<span style="color: #008b8b;">True</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Full Mode: "</span> + <span style="color: #8b2252;">"/ "</span>.join(seg_list))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#27169;&#24335;</span>

<span style="color: #a0522d;">seg_list</span> = jieba.cut(<span style="color: #8b2252;">"&#25105;&#26469;&#21040;&#21271;&#20140;&#28165;&#21326;&#22823;&#23398;"</span>, cut_all=<span style="color: #008b8b;">False</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Default Mode: "</span> + <span style="color: #8b2252;">"/ "</span>.join(seg_list))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31934;&#30830;&#27169;&#24335;</span>

<span style="color: #a0522d;">seg_list</span> = jieba.lcut(<span style="color: #8b2252;">"&#20182;&#26469;&#21040;&#20102;&#32593;&#26131;&#26477;&#30740;&#22823;&#21414;"</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#26159;&#31934;&#30830;&#27169;&#24335;</span>
<span style="color: #483d8b;">print</span>(seg_list)

<span style="color: #a0522d;">seg_list</span> = jieba.lcut_for_search(<span style="color: #8b2252;">"&#23567;&#26126;&#30805;&#22763;&#27605;&#19994;&#20110;&#20013;&#22269;&#31185;&#23398;&#38498;&#35745;&#31639;&#25152;&#65292;&#21518;&#22312;&#26085;&#26412;&#20140;&#37117;&#22823;&#23398;&#28145;&#36896;"</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25628;&#32034;&#24341;&#25806;&#27169;&#24335;</span>
<span style="color: #483d8b;">print</span>(seg_list)
<span style="color: #b22222;"># </span><span style="color: #b22222;">------------------------------------------------</span>
Full Mode: &#25105;/ &#26469;&#21040;/ &#21271;&#20140;/ &#28165;&#21326;/ &#28165;&#21326;&#22823;&#23398;/ &#21326;&#22823;/ &#22823;&#23398;
Default Mode: &#25105;/ &#26469;&#21040;/ &#21271;&#20140;/ &#28165;&#21326;&#22823;&#23398;
[<span style="color: #8b2252;">'&#20182;'</span>, <span style="color: #8b2252;">'&#26469;&#21040;'</span>, <span style="color: #8b2252;">'&#20102;'</span>, <span style="color: #8b2252;">'&#32593;&#26131;'</span>, <span style="color: #8b2252;">'&#26477;&#30740;'</span>, <span style="color: #8b2252;">'&#22823;&#21414;'</span>]
[<span style="color: #8b2252;">'&#23567;&#26126;'</span>, <span style="color: #8b2252;">'&#30805;&#22763;'</span>, <span style="color: #8b2252;">'&#27605;&#19994;'</span>, <span style="color: #8b2252;">'&#20110;'</span>, <span style="color: #8b2252;">'&#20013;&#22269;'</span>, <span style="color: #8b2252;">'&#31185;&#23398;'</span>, <span style="color: #8b2252;">'&#23398;&#38498;'</span>, <span style="color: #8b2252;">'&#31185;&#23398;&#38498;'</span>, <span style="color: #8b2252;">'&#20013;&#22269;&#31185;&#23398;&#38498;'</span>, <span style="color: #8b2252;">'&#35745;&#31639;'</span>, <span style="color: #8b2252;">'&#35745;&#31639;&#25152;'</span>, <span style="color: #8b2252;">'&#65292;'</span>, <span style="color: #8b2252;">'&#21518;'</span>, <span style="color: #8b2252;">'&#22312;'</span>, <span style="color: #8b2252;">'&#26085;&#26412;'</span>, <span style="color: #8b2252;">'&#20140;&#37117;'</span>, <span style="color: #8b2252;">'&#22823;&#23398;'</span>, <span style="color: #8b2252;">'&#26085;&#26412;&#20140;&#37117;&#22823;&#23398;'</span>, <span style="color: #8b2252;">'&#28145;&#36896;'</span>]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:99ebe28f-b670-4ee6-a94a-faf1dc4dc4c5" class="outline-5">
<h5 id="h:99ebe28f-b670-4ee6-a94a-faf1dc4dc4c5">stopword 停用词</h5>
<div class="outline-text-5" id="text-h:99ebe28f-b670-4ee6-a94a-faf1dc4dc4c5">
<p>
数据清洗：把脏数据洗掉。检测出并去除掉数据中无效或无关的数据。例如，空值、非法值的检测，重复数据检测等。
</p>

<p>
对于一条条影评来说，我们分析的数据中包含了很多无效的数据，比如标点符号、英文的冠词、中文"的"等等，需要把它们清除掉。
</p>

<p>
使用停用词来去除这些无效的数据。
</p>

<p>
范例
</p>

<p>
创建文件 chineseStopWords.txt，添加不用的词
</p>
<div class="org-src-container">
<pre class="src src-sh">&#65292;
&#12290;
&#65281;
&#37027;&#20040;
</pre>
</div>

<p>
测试文件
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis
<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a020f0;">import</span> jieba

<span style="color: #a0522d;">client</span> = redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/0'</span>)
<span style="color: #a0522d;">comments</span> = client.lrange(<span style="color: #8b2252;">'dbreview:items'</span>, 0, -1)

<span style="color: #a0522d;">stopwords</span> = <span style="color: #483d8b;">set</span>() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20572;&#29992;&#35789;</span>
<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'./chineseStopWords.txt'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(line.encode())</span>
        stopwords.add(line.rstrip(<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>))
    stopwords.add(<span style="color: #8b2252;">' '</span>)
    stopwords.add(<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #a0522d;">words</span> = {}

<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> comments:
    <span style="color: #a0522d;">review</span> = simplejson.loads(c).get(<span style="color: #8b2252;">'comment'</span>)
    <span style="color: #a020f0;">for</span> word <span style="color: #a020f0;">in</span> jieba.cut(review): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#35789;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#35745;</span>
        <span style="color: #a020f0;">if</span> word <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> stopwords:
            <span style="color: #a0522d;">words</span>[word] = words.get(word, 0) + 1

<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">sorted</span>(words.items(), key=<span style="color: #a020f0;">lambda</span> x:x[1], reverse=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25353;&#21333;&#35789;&#20498;&#25490;</span>

client.close()
</pre>
</div>

<p>
执行结果
</p>
<div class="org-src-container">
<pre class="src src-sh">[(<span style="color: #8b2252;">'&#30340;'</span>, 48), (<span style="color: #8b2252;">'&#26159;'</span>, 12), (<span style="color: #8b2252;">'&#39064;&#26448;'</span>, 11), (<span style="color: #8b2252;">'&#20102;'</span>, 9), (<span style="color: #8b2252;">'&#65311;'</span> xxxx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:adedda1f-2aea-46ff-9709-e2a20210cbc2" class="outline-5">
<h5 id="h:adedda1f-2aea-46ff-9709-e2a20210cbc2">worlcloud词云</h5>
<div class="outline-text-5" id="text-h:adedda1f-2aea-46ff-9709-e2a20210cbc2">
<p>
wordcloud词云: <a href="https://github.com/amueller/word_cloud">https://github.com/amueller/word_cloud</a> 
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20381;&#36182;numpy&#12289;matplotlib</span>
pip install wordcloud

<span style="color: #b22222;">#</span><span style="color: #b22222;">matplotlib&#65306;python&#20013;&#32472;&#21046;&#20108;&#32500;&#22270;&#30340;&#27169;&#22359;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">pip install matplotlib</span>
</pre>
</div>


<p>
常用方法
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fit_words(frequencies)</td>
<td class="org-left">Create a word_cloud from words and frequencies.</td>
</tr>

<tr>
<td class="org-left">generate(text)</td>
<td class="org-left">Generate wordcloud from text.</td>
</tr>

<tr>
<td class="org-left">generate_from_frequencies(frequencies[, …])</td>
<td class="org-left">Create a word_cloud from words and frequencies.</td>
</tr>

<tr>
<td class="org-left">generate_from_text(text)</td>
<td class="org-left">Generate wordcloud from text.</td>
</tr>

<tr>
<td class="org-left">process_text(text)</td>
<td class="org-left">Splits a long text into words, eliminates the stopwords.</td>
</tr>

<tr>
<td class="org-left">recolor([random_state, color_func, colormap])</td>
<td class="org-left">Recolor existing layout.</td>
</tr>

<tr>
<td class="org-left">to_array()</td>
<td class="org-left">Convert to numpy array.</td>
</tr>

<tr>
<td class="org-left">to_file(filename)</td>
<td class="org-left">Export to image file.</td>
</tr>

<tr>
<td class="org-left">to_svg([embed_font, optimize_embedded_font, …])</td>
<td class="org-left">Export to SVG.</td>
</tr>
</tbody>
</table>

<p>
WordCloud参数
</p>
<ul class="org-ul">
<li>font_path：指明要用的字体的路径</li>
<li>width：默认值400。设定词云画布的宽度</li>
<li>height：默认值200。画布高度</li>
<li>mask：默认无。用来设定词云的形状</li>
<li>min_font_size：默认值4，整数类型。设定最小的词的尺寸/大小</li>
<li>max_font_size：默认无，整数型。设定最大词的大小</li>
<li>max_words：默认值200。设定词云最多显示的词的个数</li>
<li>background_color：默认值为黑色。设定词云画布底色</li>
<li>Scale：默认值1。值越大，图像密度越大越清晰</li>
</ul>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis
<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a020f0;">import</span> jieba

<span style="color: #a0522d;">client</span> = redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/0'</span>)
<span style="color: #a0522d;">comments</span> = client.lrange(<span style="color: #8b2252;">'dbreview:items'</span>, 0, -1)

<span style="color: #a0522d;">stopwords</span> = <span style="color: #483d8b;">set</span>() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20572;&#29992;&#35789;</span>
<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'./chineseStopWords.txt'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(line.encode())</span>
        stopwords.add(line.rstrip(<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>))
    stopwords.add(<span style="color: #8b2252;">' '</span>)
    stopwords.add(<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #a0522d;">words</span> = {}

<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> comments:
    <span style="color: #a0522d;">review</span> = simplejson.loads(c).get(<span style="color: #8b2252;">'comment'</span>)
    <span style="color: #a020f0;">for</span> word <span style="color: #a020f0;">in</span> jieba.cut(review): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#35789;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#35745;</span>
        <span style="color: #a020f0;">if</span> word <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> stopwords:
            <span style="color: #a0522d;">words</span>[word] = words.get(word, 0) + 1

<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">sorted</span>(words.items(), key=<span style="color: #a020f0;">lambda</span> x:x[1], reverse=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25353;&#21333;&#35789;&#20498;&#25490;</span>

<span style="color: #a020f0;">from</span> wordcloud <span style="color: #a020f0;">import</span> WordCloud
<span style="color: #a020f0;">import</span> matplotlib.pyplot <span style="color: #a020f0;">as</span> plt
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#24377;&#19981;&#20986;&#22270;&#29255;&#65292;&#25351;&#23450;Qt5Agg&#35299;&#20915;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">import matplotlib</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">matplotlib.use('Qt5Agg') # pip install pyqt5</span>

<span style="color: #a0522d;">wdc</span> = WordCloud(font_path=<span style="color: #8b2252;">'simhei.ttf'</span>, scale=15, max_font_size=40)

plt.figure(2)
wdc.fit_words(words) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;&#21333;&#35789;&#21019;&#24314;&#35789;&#20113;</span>
plt.imshow(wdc)      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#19968;&#20010;&#22270;&#26174;&#31034;&#22312;&#20108;&#32500;&#22352;&#26631;&#36724;&#19978;</span>
plt.axis(<span style="color: #8b2252;">'off'</span>)      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25171;&#21360;&#22352;&#26631;&#31532; </span>
plt.show()           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23637;&#31034;</span>

client.close()
</pre>
</div>

<p>
词频
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> redis
<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a020f0;">import</span> jieba

<span style="color: #a0522d;">client</span> = redis.from_url(<span style="color: #8b2252;">'redis://:123456@192.168.226.130:6379/0'</span>)
<span style="color: #a0522d;">comments</span> = client.lrange(<span style="color: #8b2252;">'dbreview:items'</span>, 0, -1)

<span style="color: #a0522d;">stopwords</span> = <span style="color: #483d8b;">set</span>() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20572;&#29992;&#35789;</span>
<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">'./chineseStopWords.txt'</span>, encoding=<span style="color: #8b2252;">'utf-8'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> f:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(line.encode())</span>
        stopwords.add(line.rstrip(<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>))
    stopwords.add(<span style="color: #8b2252;">' '</span>)
    stopwords.add(<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #a0522d;">words</span> = {}
<span style="color: #a0522d;">total</span> = 0
<span style="color: #a020f0;">for</span> c <span style="color: #a020f0;">in</span> comments:
    <span style="color: #a0522d;">review</span> = simplejson.loads(c).get(<span style="color: #8b2252;">'comment'</span>)
    <span style="color: #a020f0;">for</span> word <span style="color: #a020f0;">in</span> jieba.cut(review): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#35789;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#35745;</span>
        <span style="color: #a020f0;">if</span> word <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> stopwords:
            <span style="color: #a0522d;">words</span>[word] = words.get(word, 0) + 1
            <span style="color: #a0522d;">total</span> += 1

<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">len</span>(words))
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">sorted</span>(words.items(), key=<span style="color: #a020f0;">lambda</span> x:x[1], reverse=<span style="color: #008b8b;">True</span>)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25353;&#21333;&#35789;&#20498;&#25490;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24635;&#25968;</span>
<span style="color: #483d8b;">print</span>(total)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35789;&#39057;</span>
<span style="color: #a0522d;">frenq</span> = {k:v/total <span style="color: #a020f0;">for</span> k,v <span style="color: #a020f0;">in</span> words.items()}
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">sorted</span>(frenq.items(), key=<span style="color: #a020f0;">lambda</span> x:x[1], reverse=<span style="color: #008b8b;">True</span>))

<span style="color: #a020f0;">from</span> wordcloud <span style="color: #a020f0;">import</span> WordCloud
<span style="color: #a020f0;">import</span> matplotlib.pyplot <span style="color: #a020f0;">as</span> plt
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#24377;&#19981;&#20986;&#22270;&#29255;&#65292;&#25351;&#23450;Qt5Agg&#35299;&#20915;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">import matplotlib</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">matplotlib.use('Qt5Agg') # pip install pyqt5</span>

<span style="color: #a0522d;">wdc</span> = WordCloud(font_path=<span style="color: #8b2252;">'simhei.ttf'</span>, scale=15, max_font_size=40)

plt.figure(2)
wdc.fit_words(frenq) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;&#21333;&#35789;&#21644;&#35789;&#39057;&#21019;&#24314;&#35789;&#20113;</span>
plt.imshow(wdc)      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#19968;&#20010;&#22270;&#26174;&#31034;&#22312;&#20108;&#32500;&#22352;&#26631;&#36724;&#19978;</span>
plt.axis(<span style="color: #8b2252;">'off'</span>)      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25171;&#21360;&#22352;&#26631;&#31532;</span>
plt.show()           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23637;&#31034;</span>

client.close()
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
