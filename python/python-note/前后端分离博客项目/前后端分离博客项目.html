<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python: 前后端分离博客项目</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Python: 前后端分离博客项目</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:5576a5af-e170-4286-a809-b09ecf0006d7">博客系统</a>
<ul>
<li><a href="#h:8e858e6d-f0f0-45d6-b969-cfd702dbdfba">数据库模型设计</a>
<ul>
<li><a href="#h:1abe2926-8c10-4c57-bb5c-0268d6ff1987">分析</a></li>
<li><a href="#h:29ee4b12-3579-4a66-b33d-f18859ea7165">数据库设计</a>
<ul>
<li><a href="#h:5312f395-6883-4dac-b978-303e7be06498">创建数据库</a></li>
<li><a href="#h:13e80511-5cd6-4570-8c21-8714fae37d7e">用户表user</a></li>
<li><a href="#orgac15bc3">系统表auth_user</a></li>
<li><a href="#h:a8b56961-dee8-42ef-b7e6-08526d52969e">文章表post</a></li>
</ul>
</li>
<li><a href="#h:60240dfa-b819-4e1c-921b-5d14367c8ece">项目</a>
<ul>
<li><a href="#h:65093d73-c03a-4d8e-8167-c79088270fa8">项目构建</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0fb0d61d-ad66-4c23-b1f7-ed66a2cb0bc7">项目构建和基础知识</a>
<ul>
<li><a href="#h:908b8308-a395-409d-ab96-9173d083d9e6">概述</a></li>
<li><a href="#h:2e4923df-6bf2-4eaa-ab09-8ad8c84b3982">安装Django</a></li>
<li><a href="#h:c32e2da5-2cb1-4365-af22-bd6309746a7a">创建Django项目</a>
<ul>
<li><a href="#h:1e90c990-0549-41f0-b9ba-6796476ea00f">数据库配置</a></li>
<li><a href="#h:0674244f-e898-4721-86d0-e9958c061d55">MySQL数据库驱动</a></li>
<li><a href="#h:fc5a4e84-c7bb-45e6-ad43-7a2e24b996ee">创建应用</a></li>
<li><a href="#h:ca220398-f7b9-40b5-97ee-547eb88277b8">注册应用</a></li>
<li><a href="#org01c4384">迁移</a></li>
</ul>
</li>
<li><a href="#org54e897a">如果使用自建use表</a>
<ul>
<li><a href="#h:deca07ae-0a55-4089-b766-d6a50e12a47d">模型Model</a></li>
<li><a href="#h:b3cf9f14-2314-4ca6-b8e7-c040f7a68703">创建User的Model类</a></li>
</ul>
</li>
<li><a href="#h:de578544-d4f2-4706-ad64-c819d3210959">Django后台管理</a></li>
<li><a href="#h:2a94a3a7-cb99-4a99-a4d0-ddc8b8629169">路由（重要）</a></li>
</ul>
</li>
<li><a href="#h:82fc7377-e915-4d33-babe-aedf458c95eb">Django模板技术</a>
<ul>
<li><a href="#h:2a9d1d94-4532-4b87-81db-f3a89607fca3">模板配置</a></li>
<li><a href="#h:fbd99f6a-e10a-4154-a886-d862825ae16f">模板渲染</a></li>
<li><a href="#h:a6794a58-2021-4cf3-9116-80e8e3a5e254">DTL语法(模板语法)</a>
<ul>
<li><a href="#h:5f11a19c-280e-4b5c-bb1d-db609c3f5aaf">变量</a></li>
<li><a href="#h:d67e337e-ccd0-401b-b7f9-98941b6ce67b">模板标签</a></li>
<li><a href="#h:b29e3522-a78c-41be-86c1-6f9a0b305a22">模板实例</a></li>
<li><a href="#h:a539f05a-6cbd-4d47-a1de-9390bd0922e6">附加&#x2013;Pycharm模板自定义</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:5507a5c6-5cb6-476a-b1da-aeee85d2c35e">Restful-API设计</a>
<ul>
<li><a href="#h:ecc47935-e604-4631-9013-3aab0b063012">RESTFul</a>
<ul>
<li><a href="#h:49af8863-8cc8-445c-b2a6-b98063d63816">1.协议</a></li>
<li><a href="#h:1acdca45-9360-418e-ad1f-d8a5c6bc3a3e">2.HTTP方法</a></li>
<li><a href="#h:77e8fb6d-c20e-4d85-bccd-6e337306b639">3.使用名称</a></li>
<li><a href="#h:4511c1d3-8530-47ab-8ae0-a32858ba5be6">4.集合功能</a></li>
<li><a href="#h:99dc4087-5906-46a8-bd31-78b68f8ff9e7">5.状态码</a></li>
<li><a href="#h:a4f53546-95ed-4a6e-a2f1-4bdbdc67b3e2">6.错误处理</a></li>
<li><a href="#h:158c39ff-9c3e-46e8-aae9-a1aefd6553cd">7.版本</a></li>
<li><a href="#h:c4c86260-2559-4655-8d9e-f636d1505df0">8. 返回结果</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d4c1ba92-5f0c-4b3a-899f-7873c7cd467a">注册接口设计和实现</a>
<ul>
<li><a href="#h:dfda6f78-6fe5-4735-a5f4-c5b7f812762b">用户注册接口设计</a></li>
<li><a href="#h:1a518a1d-5758-4380-b733-81e81c017706">路由配置</a></li>
<li><a href="#h:d28b5cb8-02b1-4e07-b28e-2d740c16cfd6">测试JSON数据</a></li>
<li><a href="#h:f5311f9b-8545-4029-a844-8a6b96ffe528">CSRF处理</a></li>
<li><a href="#h:40656b8a-5c03-4112-b091-2ffb0a10a251">JSON数据处理</a></li>
<li><a href="#h:ebdf4250-239e-4d66-91a8-70fd5ace2202">错误处理</a></li>
<li><a href="#h:072b4093-653e-4127-ae38-d10df3504097">注册代码 v1</a></li>
<li><a href="#h:1c3fa3d6-39ca-4a00-ad25-05029416bb65">Django日志</a></li>
<li><a href="#h:17cfb619-7269-462b-9679-1b8a3d9bb8c7">模型操作</a>
<ul>
<li><a href="#h:2544a594-26d4-45ab-aafd-61d119abfb14">管理器对象</a></li>
<li><a href="#h:472308d4-65c6-467f-afd1-742d5670f43e">查询</a></li>
</ul>
</li>
<li><a href="#h:79d9aeb6-6538-4b1a-80cf-0441d3b155fe">注册接口设计完善</a></li>
<li><a href="#h:d02ec722-cab8-4256-af8b-410127950a20">注册代码 v2</a></li>
</ul>
</li>
<li><a href="#h:6329a26b-e608-496a-9981-bf28deb4b20f">登录接口设计和实现</a>
<ul>
<li><a href="#h:899060e4-25d5-456f-a443-2106b8113684">用户登录接口设计</a></li>
<li><a href="#h:56e75baa-0b75-46df-9cdc-c26ec2d8879d">路由配置</a></li>
<li><a href="#h:d094d52b-bafd-4b39-a2cc-391bcc4c0022">认证接口</a>
<ul>
<li><a href="#h:a7285988-9465-4e51-99a3-3393535c6749">认证流程</a></li>
<li><a href="#h:fcbe48ab-9ee9-4b74-b304-3c5525d97c4f">Django的认证</a></li>
<li><a href="#h:964b4cb1-25b3-449b-b48e-e638bda86f53">中间件技术Middleware</a></li>
</ul>
</li>
<li><a href="#h:d7b73a3a-7742-4bad-ba59-597f2e0d9c56">代码参考</a></li>
</ul>
</li>
<li><a href="#h:ecb5af9a-c858-4c89-9011-a08b2b0c923c">博文接口实现</a>
<ul>
<li><a href="#h:1a04237e-d588-442d-bdb4-746f7aa8d905">创建博文应用</a></li>
<li><a href="#h:2a36bad0-198d-4d4b-9229-2376d89609ee">发布接口实现</a>
<ul>
<li><a href="#h:263ffedb-95b4-46fd-9236-765e92eb2bb4">显示事务处理</a></li>
</ul>
</li>
<li><a href="#h:6b1b783b-a065-4a4b-aecf-ccb37374424d">文章接口实现</a></li>
<li><a href="#h:5d768b55-fb83-4029-aca7-147e98ce35ef">列表页接口实现</a>
<ul>
<li><a href="#h:1838ff94-d958-4944-8bd8-46da421bcf42">改写校验函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:ab043578-1b85-4bdb-b412-17d7a08c7061">前端开发及登录功能实现</a>
<ul>
<li><a href="#h:2a1f7cef-fbfc-4cc8-9bd0-572a1139956a">开发环境设置</a></li>
<li><a href="#h:19aac4a1-0284-43cc-a9f5-b4a832f44497">开发</a>
<ul>
<li><a href="#h:29488dbd-a446-4e2c-9e08-0b26154cac48">前端路由</a></li>
<li><a href="#h:42c12639-219d-4d3e-aa80-19bf58fe0b97">登录组件</a></li>
<li><a href="#h:0a3a7aa3-8099-4dd9-8a85-8ad470d21dae">注册组件</a></li>
<li><a href="#h:eedefb16-14c9-4816-bf60-1d98b8b80327">导航栏链接</a></li>
<li><a href="#h:5a32628c-dab9-4154-9733-b2bdc87e9c70">分层</a></li>
<li><a href="#h:6dd995b4-6cf1-42b9-ab10-f735a8aae72a">登录功能实现</a></li>
</ul>
</li>
<li><a href="#h:391c0e6b-fd59-44a2-ad47-c9e660db47ff">token持久化&#x2013;LocalStorage</a></li>
<li><a href="#h:a34ba445-8806-4a4e-9d89-336c702220f3">Mobx状态管理</a></li>
<li><a href="#h:60860465-c797-4218-aa59-27a0bd2eb419">跳转</a></li>
<li><a href="#h:a100db74-8fa6-4ff8-b88a-378e282bc6cf">Login登录功能代码实现</a></li>
</ul>
</li>
<li><a href="#h:355669cf-8ac0-4504-904f-44d75f34b6a0">注册功能代码实现</a>
<ul>
<li><a href="#h:362a1e37-f984-4d6c-910f-229ca446b4a6">注册功能实现</a></li>
<li><a href="#h:187d9f1e-0a28-40ae-b71b-2aa6e7dea296">Ant Design</a></li>
<li><a href="#h:1c887c99-a63e-44b3-95cd-0636df68945e">信息显示</a></li>
<li><a href="#h:7bd98031-5ec4-443d-a7ad-60ff1c30f4fe">进阶装饰器</a></li>
</ul>
</li>
<li><a href="#h:9dcd95c6-7beb-444c-a716-5456bae2c5e9">博文业务代码实现和Antd组件</a>
<ul>
<li><a href="#h:b7f03f69-3294-4bfb-a11b-ce2315d98551">导航菜单</a></li>
<li><a href="#h:021def2b-5cf8-46df-bac4-c2d5612e85c0">页面布局</a></li>
<li><a href="#h:7161fae6-e3e7-4cba-ab6d-da240375c45e">博文业务</a></li>
<li><a href="#h:597d0cf2-2f4a-4a6f-a33c-4112a6a2daaf">业务层</a></li>
<li><a href="#h:d0f06259-123b-406c-82d2-e890e09700b6">发布组件</a></li>
<li><a href="#h:5d7d567a-e2df-4f23-b1d2-0843c758f1f9">富文本编辑器</a></li>
<li><a href="#h:e8481067-1cb5-44d0-80e5-86c655c6e628">业务层改进</a></li>
<li><a href="#h:6cd8e77e-c68b-4ca3-be4e-46f8978a3fa3">详情页组件</a></li>
<li><a href="#h:a93bce79-d7d3-41e3-ad48-c71a5dae312a">文章列表页组件</a>
<ul>
<li><a href="#h:a9a795d3-034b-41d6-a5a3-ef0f6ba989f1">List组件</a></li>
</ul>
</li>
<li><a href="#h:43383cb6-c4a9-467e-b738-1611d61e8faf">分页功能</a>
<ul>
<li><a href="#h:84c66087-1fe7-4aaf-aff7-74f3395bd685">国际化</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d3614d6d-3876-4326-9ace-cd20f9df9d70">项目部署</a>
<ul>
<li><a href="#h:77405a37-bdc1-4f4b-8d4d-b186fea9a7d0">Django 打包</a></li>
<li><a href="#h:ae32511d-2909-4b0e-bcf9-b001c184edc2">WSGI</a></li>
<li><a href="#h:e71c9208-5f11-4cdc-8f4d-518b32b89655">uWSGI</a></li>
<li><a href="#h:531e8839-c96e-489f-a66b-f53626a25a85">uWSGI+Django部署</a>
<ul>
<li><a href="#h:8c3dff55-6664-41da-af14-9757d8a1a874">uwsgi配置文件</a></li>
</ul>
</li>
<li><a href="#h:9185b89b-14dd-499c-8c9b-daa39778fe37">React项目打包</a></li>
<li><a href="#h:c77e494a-c921-4d14-8256-379cd67d7c6a">nginx uwsgi部署</a>
<ul>
<li><a href="#h:905435b7-6141-4b92-9c21-ebe0293f0362">tengine安装</a></li>
<li><a href="#h:b6b1c7f3-daf6-439a-ae14-01dbceaa3ef8">http部署</a></li>
<li><a href="#h:f2c7c726-1700-46dc-8945-4f0c8a12e84a">uwsgi部署</a></li>
</ul>
</li>
<li><a href="#h:57f85199-6bac-4176-beab-3fd39aebf2a0">部署图</a></li>
<li><a href="#h:91193b33-eb0b-41b9-858d-409153ca09cc">MVC设计模式</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a41882ae-8e1b-49a9-bc6b-dc1a42cb8a06">Session</a>
<ul>
<li><a href="#h:1b51cfd9-d386-40d1-bf4e-d39052400add">Session-Cookie机制</a></li>
<li><a href="#h:00125130-88c9-489a-b030-378e2cc122a7">开启session支持</a></li>
<li><a href="#h:79bb20b6-9c21-4a66-9791-c44961341cdd">登录登出实现</a>
<ul>
<li><a href="#h:cf04c31b-5db7-4da6-a563-dc4c394301ae">登录实现</a></li>
<li><a href="#h:6c828a95-b6c7-4435-b4b9-595ef9fcd48e">认证实现</a></li>
<li><a href="#h:9eac4773-3e36-40a0-ae19-6f8123e55d40">登录代码</a></li>
<li><a href="#h:e8ec8605-2d82-47c2-9032-7103d4dbb9c2">不需要认证的view函数中使用Session</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:063f8fb3-8941-4194-986f-af4d0345aeae">Celery调度+Redis安装</a>
<ul>
<li><a href="#h:9f13b1bc-1b9c-4ee5-9f90-9c380a700b01">常用应用</a></li>
<li><a href="#h:f2133bdb-eb52-4366-bee2-456bd8bfaa44">角色</a></li>
<li><a href="#h:e1a64a83-ae9f-4ced-93bf-6f6e106aa689">安装</a></li>
<li><a href="#h:6f37594c-0051-46aa-8746-e5529645b932">测试</a>
<ul>
<li><a href="#h:a49a66e6-d683-403f-9227-058ec79afd58">Redis安装配置</a></li>
<li><a href="#h:c0b21400-af23-4fc4-98f8-18dfea47b6ff">broker配置使用</a></li>
<li><a href="#h:af3524be-95b5-40e9-a562-e542463568a0">Celery使用</a></li>
</ul>
</li>
<li><a href="#h:b6590d7a-c511-49fa-8ec3-24b2b705aab4">发邮件</a>
<ul>
<li><a href="#h:7ccc6bec-6312-45db-82db-6508f564e0be">Celery在Django中的集成方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0299e760-6eec-4054-bbba-663ccabbf47d">Flask框架简单使用</a>
<ul>
<li><a href="#h:8f951cdd-a700-4325-bd3e-b18e86dca438">快速构建</a></li>
<li><a href="#h:0fc0ab65-1a91-4273-a1b9-6ddbed3020b6">蓝图</a></li>
<li><a href="#h:1fa97270-4557-4b69-8536-d714e5604af0">模板</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Python</a></li>
</ul>
<section id="outline-container-h:5576a5af-e170-4286-a809-b09ecf0006d7" class="outline-2">
<h2 id="h:5576a5af-e170-4286-a809-b09ecf0006d7">博客系统</h2>
<div class="outline-text-2" id="text-h:5576a5af-e170-4286-a809-b09ecf0006d7">
</div>
<div id="outline-container-h:8e858e6d-f0f0-45d6-b969-cfd702dbdfba" class="outline-3">
<h3 id="h:8e858e6d-f0f0-45d6-b969-cfd702dbdfba">数据库模型设计</h3>
<div class="outline-text-3" id="text-h:8e858e6d-f0f0-45d6-b969-cfd702dbdfba">
</div>
<div id="outline-container-h:1abe2926-8c10-4c57-bb5c-0268d6ff1987" class="outline-4">
<h4 id="h:1abe2926-8c10-4c57-bb5c-0268d6ff1987">分析</h4>
<div class="outline-text-4" id="text-h:1abe2926-8c10-4c57-bb5c-0268d6ff1987">
<p>
多人使用博客系统。采用BS架构实现。市面上多数某某系统归根结底都是这种设计。
</p>

<p>
博客系统，核心模块有：
</p>
<ol class="org-ol">
<li>用户管理
<ul class="org-ul">
<li>注册、登录</li>
<li>删除查用户</li>
</ul></li>
<li>博文管理
<ul class="org-ul">
<li>增删改查博文</li>
</ul></li>
</ol>

<p>
需要数据库，本次使用Mysql8+, InnoDB引擎。
</p>

<p>
需要支持多用户登录，各自可以管理自己的博文(增删改查)，管理是不公开的，但是博文是不需要登录就可以公开预览的。
</p>

<p>
先不要思考过多的功能，先完成最小的核心需求代码。
</p>
</div>
</div>
<div id="outline-container-h:29ee4b12-3579-4a66-b33d-f18859ea7165" class="outline-4">
<h4 id="h:29ee4b12-3579-4a66-b33d-f18859ea7165">数据库设计</h4>
<div class="outline-text-4" id="text-h:29ee4b12-3579-4a66-b33d-f18859ea7165">
</div>
<div id="outline-container-h:5312f395-6883-4dac-b978-303e7be06498" class="outline-5">
<h5 id="h:5312f395-6883-4dac-b978-303e7be06498">创建数据库</h5>
<div class="outline-text-5" id="text-h:5312f395-6883-4dac-b978-303e7be06498">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> `blog2` <span style="color: #a020f0;">DEFAULT</span> <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4;
</pre>
</div>


<p>
需要用户表、文章表
</p>
</div>
</div>
<div id="outline-container-h:13e80511-5cd6-4570-8c21-8714fae37d7e" class="outline-5">
<h5 id="h:13e80511-5cd6-4570-8c21-8714fae37d7e">用户表user</h5>
<div class="outline-text-5" id="text-h:13e80511-5cd6-4570-8c21-8714fae37d7e">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">主键，唯一标识</td>
</tr>

<tr>
<td class="org-left">username</td>
<td class="org-left">登录名，唯一</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">用户姓名，描述性字段</td>
</tr>

<tr>
<td class="org-left">email</td>
<td class="org-left">电子邮箱，注册用信息，应该唯一。可用作登录名、可用于密码找回</td>
</tr>

<tr>
<td class="org-left">password</td>
<td class="org-left">密码存储。注意，不能明文存储密码。一般采用单向加密算法，如MD5</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `<span style="color: #483d8b;">user</span>` (
    `id` <span style="color: #228b22;">INT</span> ( 11 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
    `<span style="color: #a020f0;">name</span>` <span style="color: #228b22;">VARCHAR</span> ( 48 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    `email` <span style="color: #228b22;">VARCHAR</span> ( 64 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    `password` <span style="color: #228b22;">VARCHAR</span> ( 128 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> ( `id` ),
<span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `email` ( `email` )
) ENGINE = INNODB <span style="color: #a020f0;">DEFAULT</span> CHARSET = utf8;
</pre>
</div>

<p>
<b>密码算法</b>
</p>

<p>
密码一般采用单向散列算法，算法保证不可逆。
</p>
<ul class="org-ul">
<li>MD5(Message Digest Algorithm 5): 输出128位数值。被广泛采用，但已经极度不安全，不建议采用</li>
<li>SHA(Secure Hash Algorithm): 较新算法
<ul class="org-ul">
<li>由于SHA-0, SHA-1相继被王小云教授破解</li>
<li>SHA-2包含SHA-224, SHA-256, SHA-384, SHA-512</li>
<li>SHA3于2012年由非NSA设计，内部算法设计不同SHA-1和SHA-2</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> hashlib <span style="color: #a020f0;">import</span> md5, sha1, sha256, sha512, sha3_256, sha3_512

<span style="color: #a0522d;">has</span> = (md5, sha1, sha256, sha512, sha3_256, sha3_512)

<span style="color: #483d8b;">print</span>(md5(b<span style="color: #8b2252;">'abc'</span>).hexdigest()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986; 'abc' &#30340; MD5 &#21704;&#24076;&#65288;&#21313;&#20845;&#36827;&#21046;&#65289;</span>
<span style="color: #483d8b;">print</span>(md5(b<span style="color: #8b2252;">'abd'</span>).hexdigest())

<span style="color: #a0522d;">s</span> = b<span style="color: #8b2252;">'abc'</span>
<span style="color: #a020f0;">for</span> h <span style="color: #a020f0;">in</span> has:
    <span style="color: #a0522d;">o</span> = h(s)
    <span style="color: #a0522d;">y</span> = o.digest()
    <span style="color: #a0522d;">x</span> = o.hexdigest() 
    <span style="color: #483d8b;">print</span>(s,h)
    <span style="color: #483d8b;">print</span>(x, <span style="color: #483d8b;">len</span>(x), y, <span style="color: #483d8b;">len</span>(y))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">digest()&#65306;&#36820;&#22238;&#21407;&#22987;&#23383;&#33410;&#65288;bytes &#23545;&#35937;&#65289;&#65292;&#38271;&#24230;&#30001;&#31639;&#27861;&#20915;&#23450;&#65288;&#22914; MD5=16 &#23383;&#33410;&#65292;SHA256=32 &#23383;&#33410;&#65289;&#12290;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">hexdigest()&#65306;&#36820;&#22238;&#21313;&#20845;&#36827;&#21046;&#23383;&#31526;&#20018;&#65292;&#38271;&#24230;&#26159;&#21407;&#22987;&#23383;&#33410;&#38271;&#24230;&#30340; 2 &#20493;&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgac15bc3" class="outline-5">
<h5 id="orgac15bc3">系统表auth_user</h5>
<div class="outline-text-5" id="text-orgac15bc3">
<p>
在Django中也可以使用内建的用户系统，它提供了用户、用户组、权限表。
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `auth_user` (
  `id` <span style="color: #228b22;">INT</span> (11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `PASSWORD` <span style="color: #228b22;">VARCHAR</span> (128) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_login` DATETIME (6) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `is_superuser` TINYINT (1) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `username` <span style="color: #228b22;">VARCHAR</span> (150) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">VARCHAR</span> (30) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">VARCHAR</span> (150) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `email` <span style="color: #228b22;">VARCHAR</span> (254) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `is_staff` TINYINT (1) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `is_active` TINYINT (1) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `date_joined` DATETIME (6) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`),
  <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `username` (`username`)
) ENGINE = InnoDB AUTO_INCREMENT = 2_DEFAULTCHARSET = utf8mb4;
</pre>
</div>

<p>
这个表唯一的问题就是email并没有设定唯一键，可以迁移后，修改表手动增加。
</p>

<p>
一般是自己创建user表，不推荐使用内建的表。
</p>
</div>
</div>
<div id="outline-container-h:a8b56961-dee8-42ef-b7e6-08526d52969e" class="outline-5">
<h5 id="h:a8b56961-dee8-42ef-b7e6-08526d52969e">文章表post</h5>
<div class="outline-text-5" id="text-h:a8b56961-dee8-42ef-b7e6-08526d52969e">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">主键，唯一标识</td>
</tr>

<tr>
<td class="org-left">title</td>
<td class="org-left">标题，描述性字段</td>
</tr>

<tr>
<td class="org-left">author</td>
<td class="org-left">博文作者要求必须是注册用户，这个字段应该存储userid</td>
</tr>

<tr>
<td class="org-left">postdate</td>
<td class="org-left">发布日期，日期类型</td>
</tr>

<tr>
<td class="org-left">content</td>
<td class="org-left">文章内容，博文内容可能很长，一般来说不会小于256个字符的</td>
</tr>
</tbody>
</table>

<p>
一对多关系：一篇博文属于一个作者，一个作者有多篇博文。
</p>

<ol class="org-ol">
<li>博客内容选取什么字段类型？</li>
<li>多大合适？</li>
<li>博文图片如何处理？</li>
<li>适合和其它字段放在同一张表吗？</li>
</ol>


<p>
<b>Content字段的设计</b>
</p>
<ol class="org-ol">
<li>字段类型 ：博文一般很长，不可能只有几百个字符，需要大文本字段。MySQL中，选择TEXT类型，而不是char或者varchar类型。</li>
<li>大小 ：text类型是65535个字符，如果不够用，选择longtext,有\(2^{32}-1\)个字符长度。足够使用了。</li>
<li>图片存储 ：博文就像HTML一样，图片是通过*路径信息*将图片是嵌入在内容中的，所以保存的内容还是字符串。图片来源有2中：
<ul class="org-ul">
<li>外联：通过URL链接访问，本站不用存储该图片，但容易引起盗链问题。</li>
<li>本站存储：需要提供博文的在线文本编辑器，提供图片上传到网站存储，并生成图片URL，这个URL嵌入博客正文中，不会有盗链问题，但要解决众多图片存储问题、水印问题、在线压缩问题、临时或垃圾图片清理等等难题。</li>

<li>本博客项目不实现图片功能</li>
</ul></li>
<li>字段考虑
<ul class="org-ul">
<li>content字段存储文本类型大字段，一般不和数据频繁查询的字段放在一张表中，需要拆到另一张表中。</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `post` (
    `id` BIGINT ( 20 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
    `title` <span style="color: #228b22;">VARCHAR</span> ( 256 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    `author_id` <span style="color: #228b22;">INT</span> ( 11 ) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    `postdate` datetime <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> ( `id` ),
    <span style="color: #a020f0;">KEY</span> `author_id` ( `author_id` ),
<span style="color: #a020f0;">CONSTRAINT</span> `fk_post_user` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> ( `author_id` ) <span style="color: #a020f0;">REFERENCES</span> `<span style="color: #483d8b;">user</span>` ( `id` ) 
) ENGINE = INNODB <span style="color: #a020f0;">DEFAULT</span> CHARSET = utf8;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `content` (
    `id` BIGINT ( 20 ) UNSIGNED <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    `content` text <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
    <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> ( `id` ) <span style="color: #a020f0;">USING</span> BTREE,
<span style="color: #a020f0;">CONSTRAINT</span> `fk_content_post` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> ( `id` ) <span style="color: #a020f0;">REFERENCES</span> `post` ( `id` ) 
) ENGINE = INNODB <span style="color: #a020f0;">DEFAULT</span> CHARSET = utf8;
</pre>
</div>

<p>
注：这里的SQL脚本本次不要用来生成表，使用ORM库写代码来创建表，用来检查实体类构建是否正确。
</p>

<p>
用户完成的功能有登录、注册、登出等，auth_user表基本满足。
</p>

<p>
博客功能有用户发文、文章列表、文章详情等，post、content表基本满足。
</p>
</div>
</div>
</div>
<div id="outline-container-h:60240dfa-b819-4e1c-921b-5d14367c8ece" class="outline-4">
<h4 id="h:60240dfa-b819-4e1c-921b-5d14367c8ece">项目</h4>
<div class="outline-text-4" id="text-h:60240dfa-b819-4e1c-921b-5d14367c8ece">
</div>
<div id="outline-container-h:65093d73-c03a-4d8e-8167-c79088270fa8" class="outline-5">
<h5 id="h:65093d73-c03a-4d8e-8167-c79088270fa8">项目构建</h5>
<div class="outline-text-5" id="text-h:65093d73-c03a-4d8e-8167-c79088270fa8">
<ul class="org-ul">
<li>在Pycharm中创建一个项目，使用虚拟环境，Python使用版本是3.13.3</li>

<li>使用虚拟环境，Python挑选喜欢的版本(本次选用3.13.3)</li>

<li>注：Pycharm中可通过setting重新设置虚拟环境。</li>

<li>本次项目使用Django开发后台。</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-h:0fb0d61d-ad66-4c23-b1f7-ed66a2cb0bc7" class="outline-3">
<h3 id="h:0fb0d61d-ad66-4c23-b1f7-ed66a2cb0bc7">项目构建和基础知识</h3>
<div class="outline-text-3" id="text-h:0fb0d61d-ad66-4c23-b1f7-ed66a2cb0bc7">
</div>
<div id="outline-container-h:908b8308-a395-409d-ab96-9173d083d9e6" class="outline-4">
<h4 id="h:908b8308-a395-409d-ab96-9173d083d9e6">概述</h4>
<div class="outline-text-4" id="text-h:908b8308-a395-409d-ab96-9173d083d9e6">
<ul class="org-ul">
<li>Django采用MVC架构设计的开源的WEB快速开发框架。</li>
<li>优点：
<ol class="org-ol">
<li>能够快速开发，自带ORM、Template、Form、Auth核心组件</li>
<li>MVC设计模式</li>
<li>实用的管理后台Admin</li>
<li>简洁的url设计</li>
<li>周边插件丰富</li>
</ol></li>
<li>缺点：架构重、同步阻塞</li>
<li>所有Django的设计目标就是一款大而全，便于企业快速开发项目的框架，因此企业应用较广。</li>
</ul>
</div>
</div>
<div id="outline-container-h:2e4923df-6bf2-4eaa-ab09-8ad8c84b3982" class="outline-4">
<h4 id="h:2e4923df-6bf2-4eaa-ab09-8ad8c84b3982">安装Django</h4>
<div class="outline-text-4" id="text-h:2e4923df-6bf2-4eaa-ab09-8ad8c84b3982">
<ul class="org-ul">
<li>Python实用3.13.3</li>
<li>Python虚拟环境：<a href="https://docs.python.org/zh-cn/3.13/library/venv.html">https://docs.python.org/zh-cn/3.13/library/venv.html</a></li>
<li>Django的下载地址<a href="https://www.djangoproject.com/download/">https://www.djangoproject.com/download/</a></li>
<li>Django文档：<a href="https://docs.djangoproject.com/">https://docs.djangoproject.com/</a></li>
</ul>

<p>
Python版本依赖，<a href="https://docs.djangoproject.com/en/5.2/faq/install/#what-python-version-can-i-use-with-django">参看</a>
</p>
<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Django version</th>
<th scope="col" class="org-left">Python versions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">4.2</td>
<td class="org-left">3.8, 3.9, 3.10, 3.11, 3.12 (added in 4.2.8)</td>
</tr>

<tr>
<td class="org-right">5.0</td>
<td class="org-left">3.10, 3.11, 3.12</td>
</tr>

<tr>
<td class="org-right">5.1</td>
<td class="org-left">3.10, 3.11, 3.12, 3.13 (added in 5.1.3)</td>
</tr>

<tr>
<td class="org-right">5.2</td>
<td class="org-left">3.10, 3.11, 3.12, 3.13</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;python&#34394;&#25311;&#29615;&#22659;, &#24182;&#21551;&#21160;</span>
python -m venv .venv
<span style="color: #483d8b;">.</span><span style="color: #8b2252;">\.</span>venv\Scripts\activate

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#34394;&#25311;&#29615;&#22659;&#20013;&#23433;&#35013;</span>
python -m pip install <span style="color: #a0522d;">Django</span>==5.2.1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">django-admin --version <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;django&#29256;&#26412;</span>
django-admin --help <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20351;&#29992;&#24110;&#21161;</span>
django-admin startproject --help <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;startproject&#21629;&#20196;&#24110;&#21161;</span>
</pre>
</div>

<p>
注意：本文若未特殊声明，所有的命令操作都在项目的根目录下
</p>
</div>
</div>
<div id="outline-container-h:c32e2da5-2cb1-4365-af22-bd6309746a7a" class="outline-4">
<h4 id="h:c32e2da5-2cb1-4365-af22-bd6309746a7a">创建Django项目</h4>
<div class="outline-text-4" id="text-h:c32e2da5-2cb1-4365-af22-bd6309746a7a">
<p>
当前目录下，创建名为blog的django项目
</p>

<div class="org-src-container">
<pre class="src src-sh">django-admin startproject blog .
</pre>
</div>

<p>
上句命令就在当前项目根目录中构建了Django项目的初始文件。 <code>.</code> 点代表项目根目录。
</p>

<div class="org-src-container">
<pre class="src src-text">F:\CLASSES\TPROJECTS\BLOG10 
&#9500;&#9472; manage.py
 &#9492;&#9472; blog
     &#9500;&#9472;  settings.py
     &#9500;&#9472;  urls.py  #&#36335;&#24452;&#26144;&#23556;
     &#9500;&#9472;  wsgi.py
     &#9500;&#9472;  asgi.py
     &#9492;&#9472;  __init__.py
</pre>
</div>

<p>
重要文件说明
</p>
<ol class="org-ol">
<li>manage.py:本项目管理的命令行工具。应用创建、数据库迁移等都使用它完成</li>
<li>blog/settings.py：本项目的核心配置文件。
<ul class="org-ul">
<li>应用、数据库配置</li>
<li>模板、静态文件</li>
<li>中间件、日志</li>
<li>第三方插件配置</li>
</ul></li>
<li>blog/urls.py:URL路径映射配置。项目初始，只配置了/admin的路由。</li>
<li>blog/wsgi:定义WSGI接口信息。部署用，一般无需改动。
<ul class="org-ul">
<li><code>return WSGIHandler()</code>
<ul class="org-ul">
<li><code>__call__(self, environ, start_response)</code></li>
</ul></li>
</ul></li>
</ol>


<p>
主路由文件url.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.contrib <span style="color: #a020f0;">import</span> admin
<span style="color: #a020f0;">from</span> django.urls <span style="color: #a020f0;">import</span> path

<span style="color: #a0522d;">urlpatterns</span> = [
    path(<span style="color: #8b2252;">'admin/'</span>, admin.site.urls), <span style="color: #b22222;"># </span><span style="color: #b22222;">/admin/ &#36335;&#24452;&#23545;&#24212;&#65292;&#22810;&#32423;url&#22788;&#29702;</span>
]
</pre>
</div>
</div>
<div id="outline-container-h:1e90c990-0549-41f0-b9ba-6796476ea00f" class="outline-5">
<h5 id="h:1e90c990-0549-41f0-b9ba-6796476ea00f">数据库配置</h5>
<div class="outline-text-5" id="text-h:1e90c990-0549-41f0-b9ba-6796476ea00f">
<p>
使用数据库，需要修改默认的数据库配置。
</p>

<p>
在主项目的settings.py下DATABASES。默认使用的sqlite，修改为mysql。
</p>

<div class="org-src-container">
<pre class="src src-py">#https://docs.djangoproject.com/en/5.2/ref/settings/#databases
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'gdy',
        'USER': 'gdy',
        'PASSWORD': 'gdy',
        'HOST': '127.0.0.1',
        'PORT': '3306',
    }
}
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">配置项</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">HOST</td>
<td class="org-left">数据库主机。缺省是空字符串，代表localhost。如果是=/=开头表示使用UnixSocket链接</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left">端口</td>
</tr>

<tr>
<td class="org-left">USER</td>
<td class="org-left">用户名</td>
</tr>

<tr>
<td class="org-left">PASSWORD</td>
<td class="org-left">密码</td>
</tr>

<tr>
<td class="org-left">NAME</td>
<td class="org-left">库名</td>
</tr>

<tr>
<td class="org-left">OPTIONS</td>
<td class="org-left">选项、字典类型，参考MySQL文档</td>
</tr>
</tbody>
</table>

<ol class="org-ol">
<li>数据库引擎ENGINE</li>
<li>内建引擎有
<ul class="org-ul">
<li>django.db.backends.postgresql</li>
<li>django.db.backends.mysql</li>
<li>django.db.backends.sqlite3</li>
<li>django.db.backends.oracle</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:0674244f-e898-4721-86d0-e9958c061d55" class="outline-5">
<h5 id="h:0674244f-e898-4721-86d0-e9958c061d55">MySQL数据库驱动</h5>
<div class="outline-text-5" id="text-h:0674244f-e898-4721-86d0-e9958c061d55">
<p>
<a href="https://docs.djangoproject.com/en/5.2/ref/databases/#mysql-db-api-drivers">https://docs.djangoproject.com/en/5.2/ref/databases/#mysql-db-api-drivers</a>
</p>

<p>
Django支持MySQL8+
</p>

<p>
Django官方推荐使用本地驱动mysqlclient 1.4.3+
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;mysql&#39537;&#21160;</span>
pip install mysqlclient
</pre>
</div>

<p>
Linux、Mac请参照官网安装依赖库  
</p>
<ul class="org-ul">
<li><a href="https://pypi.org/project/mysqlclient/">https://pypi.org/project/mysqlclient/</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:fc5a4e84-c7bb-45e6-ad43-7a2e24b996ee" class="outline-5">
<h5 id="h:fc5a4e84-c7bb-45e6-ad43-7a2e24b996ee">创建应用</h5>
<div class="outline-text-5" id="text-h:fc5a4e84-c7bb-45e6-ad43-7a2e24b996ee">
<p>
创建用户应用
</p>
<div class="org-src-container">
<pre class="src src-sh">python manage.py startapp user
</pre>
</div>

<p>
创建应用后，项目根目录下产生一个user目录，有如下文件：
</p>
<ol class="org-ol">
<li>admin.py: 应用后台管理声明文件</li>
<li>models.py: 模型层Model类定义</li>
<li>views.py: 定义URL响应函数或类</li>
<li>migrations包: 数据迁移文件生成目录</li>
<li>apps.py: 应用的信息定义文件</li>
</ol>

<p>
user应用创建后应该完成以下功能：
</p>
<ol class="org-ol">
<li>用户注册</li>
<li>用户登录</li>
</ol>
</div>
</div>
<div id="outline-container-h:ca220398-f7b9-40b5-97ee-547eb88277b8" class="outline-5">
<h5 id="h:ca220398-f7b9-40b5-97ee-547eb88277b8">注册应用</h5>
<div class="outline-text-5" id="text-h:ca220398-f7b9-40b5-97ee-547eb88277b8">
<p>
在settings.py中，增加user应用。目的是为了 <b>后台管理</b> admin使用，或 <b>迁移</b> migrate使用
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">settings.py&#25991;&#20214;&#20013;</span>
<span style="color: #a0522d;">INSTALLED_APPS</span> = [
    <span style="color: #8b2252;">'django.contrib.admin'</span>,
    <span style="color: #8b2252;">'django.contrib.auth'</span>,
    <span style="color: #8b2252;">'django.contrib.contenttypes'</span>,
    <span style="color: #8b2252;">'django.contrib.sessions'</span>,
    <span style="color: #8b2252;">'django.contrib.messages'</span>,
    <span style="color: #8b2252;">'django.contrib.staticfiles'</span>,
    <span style="color: #8b2252;">'user'</span>
]
</pre>
</div>

<p>
本次user应用使用内建的表auth_user，所以不用注册user表。删除post表外键和user表。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> `blog`.`post` <span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> `post_ibfk_1`
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `blog`.`<span style="color: #483d8b;">user</span>`;
</pre>
</div>
</div>
</div>
<div id="outline-container-org01c4384" class="outline-5">
<h5 id="org01c4384">迁移</h5>
<div class="outline-text-5" id="text-org01c4384">
<p>
Django内部也有应用，它们需要表。这些表的迁移文件已经生成了，只需要迁移。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">python manage.py makemigrations #&#19981;&#29992;&#20570;&#12290;user &#19979;&#38754;&#36824;&#27809;&#26377;modes&#31867;</span>
python manage.py migrate
</pre>
</div>

<p>
迁移后，产生下面这些表：
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; show tables ;
+----------------------------+
| Tables_in_blog             |
+----------------------------+
| auth_group                 |
| auth_group_permissions     |
| auth_permission            |
| auth_user                  |
| auth_user_groups           |
| auth_user_user_permissions |
| content                    |
| django_admin_log           |
| django_content_type        |
| django_migrations          |
| django_session             |
| post                       |
+----------------------------+
</pre>
</div>

<p>
创建post表指向auth_user表的外键
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> `blog`.`post` 
<span style="color: #a020f0;">ADD</span> <span style="color: #a020f0;">CONSTRAINT</span> `post_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`author_id`) <span style="color: #a020f0;">REFERENCES</span> `blog`.`auth_user` (`id`);
</pre>
</div>

<p>
auth_user表结构
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `blog`.`Untitled`  (
  `id` <span style="color: #228b22;">int</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `password` <span style="color: #228b22;">varchar</span>(128) <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_0900_ai_ci <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_login` datetime(6) <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `is_superuser` tinyint(1) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `username` <span style="color: #228b22;">varchar</span>(150) <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_0900_ai_ci <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">varchar</span>(150) <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_0900_ai_ci <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">varchar</span>(150) <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_0900_ai_ci <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `email` <span style="color: #228b22;">varchar</span>(254) <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_0900_ai_ci <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `is_staff` tinyint(1) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `is_active` tinyint(1) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `date_joined` datetime(6) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`) <span style="color: #a020f0;">USING</span> BTREE,
  <span style="color: #a020f0;">UNIQUE</span> INDEX `username`(`username` <span style="color: #a020f0;">ASC</span>) <span style="color: #a020f0;">USING</span> BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> = utf8mb4 <span style="color: #a020f0;">COLLATE</span> = utf8mb4_0900_ai_ci ROW_FORMAT = <span style="color: #a020f0;">Dynamic</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org54e897a" class="outline-4">
<h4 id="org54e897a">如果使用自建use表</h4>
<div class="outline-text-4" id="text-org54e897a">
</div>
<div id="outline-container-h:deca07ae-0a55-4089-b766-d6a50e12a47d" class="outline-5">
<h5 id="h:deca07ae-0a55-4089-b766-d6a50e12a47d">模型Model</h5>
<div class="outline-text-5" id="text-h:deca07ae-0a55-4089-b766-d6a50e12a47d">
<ul class="org-ul">
<li><b>字段类型</b></li>
</ul>

<p>
<a href="https://docs.djangoproject.com/zh-hans/5.1/ref/models/fields/#field-options">官方文档</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段类</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AutoField</td>
<td class="org-left">自增的整数字段。如果不指定，django会为模型类自动增加主键字段</td>
</tr>

<tr>
<td class="org-left">BooleanField</td>
<td class="org-left">布尔值字段，True和False。对应表单控件CheckboxInput</td>
</tr>

<tr>
<td class="org-left">NullBooleanField</td>
<td class="org-left">比BooleanField多一个null值</td>
</tr>

<tr>
<td class="org-left">CharField</td>
<td class="org-left">字符串，max_length设定字符长度。对应表单控件TextInput</td>
</tr>

<tr>
<td class="org-left">TextField</td>
<td class="org-left">大文本字段，一般超过4000个字符使用。对应表单控件Textarea</td>
</tr>

<tr>
<td class="org-left">IntegerField</td>
<td class="org-left">整数字段, 一般4字节</td>
</tr>

<tr>
<td class="org-left">BigIntegerField</td>
<td class="org-left">更大整数字段，8字节</td>
</tr>

<tr>
<td class="org-left">DecimalField</td>
<td class="org-left">使用Python的Decimal实例表示十进制浮点数。max_digits总位数，decimal_places小数点后的位数</td>
</tr>

<tr>
<td class="org-left">FloatField</td>
<td class="org-left">Python的Float实例表示的浮点数</td>
</tr>

<tr>
<td class="org-left">DateField</td>
<td class="org-left">使用Python的datetime.date实例表示的日期</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">auto_now=False每次修改对象自动设置为当前时间。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">auto_now_add=False对象第一次创建时自动设置为当前时间。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">auto_now_add、auto_now、default互斥。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">对应控件为TextInput，关联了一个Js编写的日历控件</td>
</tr>

<tr>
<td class="org-left">TimeField</td>
<td class="org-left">使用Python的datetime.time实例表示的时间，参数同上</td>
</tr>

<tr>
<td class="org-left">DateTimeField</td>
<td class="org-left">使用Python的datetime.datetime实例表示的时间，参数同上</td>
</tr>

<tr>
<td class="org-left">FileField</td>
<td class="org-left">一个上传文件的字段</td>
</tr>

<tr>
<td class="org-left">ImageField</td>
<td class="org-left">继承了FileField的所有属性和方法，但是对上传的文件进行校验，确保是一个有效的图片</td>
</tr>

<tr>
<td class="org-left">EmailField</td>
<td class="org-left">能做Email检验，基于CharField，默认max_length=254</td>
</tr>

<tr>
<td class="org-left">GenericIPAddressField</td>
<td class="org-left">支持IPv4、IPv6检验，缺省对应文本框输入</td>
</tr>

<tr>
<td class="org-left">URLField</td>
<td class="org-left">能做URL检验，基于基于CharField，默认max_length=200</td>
</tr>
</tbody>
</table>


<ul class="org-ul">
<li><b>缺省主键</b>
<ol class="org-ol">
<li>缺省情况下，Django的每一个Model都有一个名为id的AutoField字段，如下
<ul class="org-ul">
<li><code>id = models.AutoField(primary_key=True)</code></li>
</ul></li>
<li>如果显示定义了主键，这种缺省主键就不会被创建了。Python之禅中说“显示优于隐试”，所以，尽量使用自己定义的主键，哪怕该字段名就是id，也是一种不错的选择。</li>
</ol></li>
<li><b>字段选项</b></li>
</ul>

<p>
<a href="https://docs.djangoproject.com/zh-hans/5.1/ref/models/fields/#field-options">官方文档</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">值</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">db_column</td>
<td class="org-left">表中字段的名称。如果未指定，则使用属性名</td>
</tr>

<tr>
<td class="org-left">primary_key</td>
<td class="org-left">是否主键</td>
</tr>

<tr>
<td class="org-left">unique</td>
<td class="org-left">是否是唯一键</td>
</tr>

<tr>
<td class="org-left">default</td>
<td class="org-left">缺省值。这个缺省值不是数据库字段的缺省值，而是新对象产生的时候被填入的缺省值</td>
</tr>

<tr>
<td class="org-left">null</td>
<td class="org-left">表的字段是否可为null，默认为False</td>
</tr>

<tr>
<td class="org-left">blank</td>
<td class="org-left">Django表单验证中，如果True，则允许该字段为空。默认为False</td>
</tr>

<tr>
<td class="org-left">db_index</td>
<td class="org-left">字段是否有索引</td>
</tr>

<tr>
<td class="org-left">to_field</td>
<td class="org-left">关联对象的字段。默认情况下，Django 使用相关对象的主键。如果你引用了一个不同的字段，这个字段必须有 unique=True</td>
</tr>
</tbody>
</table>

<p>
关系类型字段类
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ForeignKey</td>
<td class="org-left">外键，表示一对多</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">ForeignKey('production.Manufacturer')</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">自关联ForeignKey('self')</td>
</tr>

<tr>
<td class="org-left">ManyToManyField</td>
<td class="org-left">表示多对多</td>
</tr>

<tr>
<td class="org-left">OneToOneField</td>
<td class="org-left">表示一对一</td>
</tr>
</tbody>
</table>

<p>
一对多时，自动创建会增加_id后缀。
</p>
<ul class="org-ul">
<li>从一访问多，使用 <code>对象.小写模型类_set</code></li>
<li>从一访问一，使用 <code>对象.小写模型类</code></li>
</ul>

<p>
访问id <code>对象.属性_id</code>
</p>
</div>
</div>
<div id="outline-container-h:b3cf9f14-2314-4ca6-b8e7-c040f7a68703" class="outline-5">
<h5 id="h:b3cf9f14-2314-4ca6-b8e7-c040f7a68703">创建User的Model类</h5>
<div class="outline-text-5" id="text-h:b3cf9f14-2314-4ca6-b8e7-c040f7a68703">
<ul class="org-ul">
<li>基类models.Model</li>
<li>表名不指定默认使用 <code>&lt;appname&gt;_&lt;model_name&gt;</code> 。使用Meta类修改表名</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">/user/models.py&#25991;&#20214;</span>
<span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> models

<span style="color: #b22222;"># </span><span style="color: #b22222;">user&#34920;&#27169;&#22411;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">User</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">"user"</span>
    <span style="color: #483d8b;">id</span> = models.AutoField(primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = models.CharField(max_length=48,null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">email</span> = models.CharField(max_length=64,unique=<span style="color: #008b8b;">True</span>,null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">password</span> = models.CharField(max_length=128,null=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;user {} {}&gt;"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>,<span style="color: #a020f0;">self</span>.name)

    <span style="color: #a0522d;">__str__</span> = __repr__
</pre>
</div>

<p>
Meta类的使用，参考<a href="https://docs.djangoproject.com/en/1.11/ref/models/options/#django.db.models.Options.db_table">https://docs.djangoproject.com/en/1.11/ref/models/options/#django.db.models.Options.db_table</a>
</p>

<ol class="org-ol">
<li><b>迁移Migration</b>
<ul class="org-ul">
<li>迁移：从模型定义生成数据库的表</li>
</ul></li>
</ol>


<ol class="org-ol">
<li><p>
生成迁移文件。执行 <code>python manage.py makemigrations</code>
</p>

<div class="org-src-container">
<pre class="src src-cmd">(venv) D:\MyPythonUse\DjangoWeb&gt;python manage.py makemigrations
Migrations for 'user':
user\migrations\0001_initial.py
    - Create model User

生成如下文件
user
├─ migrations
    ├─  0001_initial.py
    └─  __init__.py
</pre>
</div>

<ul class="org-ul">
<li>修改MOdel类，还需要调用 <code>python manage.py makemigrations</code> ，然后migrate，迁移文件的序号会增加。</li>

<li>注意：
<ol class="org-ol">
<li>迁移的应用必须在settings.py的INSTALLED_APPS中注册。</li>
<li>不要谁便删除这些迁移文件，因为后面的改动都是要依据这些迁移文件的。</li>
</ol></li>

<li>生成的迁移文件0001_initial.py内容如下：</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> migrations, models


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Migration</span>(migrations.Migration):

    <span style="color: #a0522d;">initial</span> = <span style="color: #008b8b;">True</span>

    <span style="color: #a0522d;">dependencies</span> = [
    ]

    <span style="color: #a0522d;">operations</span> = [
        migrations.CreateModel(
            name=<span style="color: #8b2252;">'User'</span>,
            fields=[
                (<span style="color: #8b2252;">'id'</span>, models.AutoField(primary_key=<span style="color: #008b8b;">True</span>, serialize=<span style="color: #008b8b;">False</span>)),
                (<span style="color: #8b2252;">'name'</span>, models.CharField(max_length=48)),
                (<span style="color: #8b2252;">'email'</span>, models.CharField(max_length=64, unique=<span style="color: #008b8b;">True</span>)),
                (<span style="color: #8b2252;">'password'</span>, models.CharField(max_length=128)),
            ],
            options={
                <span style="color: #8b2252;">'db_table'</span>: <span style="color: #8b2252;">'user'</span>,
            },
        ),
    ]
</pre>
</div></li>

<li>执行迁移生成数据库的表 <code>python manage.py migrate</code>

<ul class="org-ul">
<li>执行了迁移，还同时生成了admin管理用的表。</li>
<li>查看数据库，user表创建好了，字段设置完全正确。</li>
</ul></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-h:de578544-d4f2-4706-ad64-c819d3210959" class="outline-4">
<h4 id="h:de578544-d4f2-4706-ad64-c819d3210959">Django后台管理</h4>
<div class="outline-text-4" id="text-h:de578544-d4f2-4706-ad64-c819d3210959">
<p>
1、 <b>创建管理员</b>
</p>
<ul class="org-ul">
<li>命令=python manage.py createsuperuser=
<ul class="org-ul">
<li>管理会用户名admin</li>
<li><p>
密码adminadmin
</p>

<div class="org-src-container">
<pre class="src src-sh">python manage.py createsuperuser

Username: admin
Email address: admin@admin.com
Password: 
<span style="color: #0000ff;">Password</span> (again): 
The password is too similar to the email address.
</pre>
</div>

<p>
会在auth_user表中创建admin用户
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select username,password from auth_user;
| admin    | pbkdf2_sha256$<span style="color: #a0522d;">1000000</span>$<span style="color: #a0522d;">Jxxxxx</span>$<span style="color: #a0522d;">xxxxxxxxxxxxxxxxxx</span>= |
</pre>
</div></li>
</ul></li>
</ul>

<p>
2、 <b>本地化</b>
</p>
<ul class="org-ul">
<li><p>
settings.py中可以设置语言、时区。语言名称可以查看=django\contrib\admin\locale=目录
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;djweb/settings.py&#25991;&#20214;&#20013;&#23545;&#24212;&#21464;&#37327;</span>
<span style="color: #a0522d;">LANGUAGE_CODE</span> = <span style="color: #8b2252;">'en-us'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">'zh-Hans' </span>
<span style="color: #a0522d;">TIME_ZONE</span> = <span style="color: #8b2252;">'Asia/Shanghai'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">'UTC'</span>
<span style="color: #a0522d;">USE_TZ</span> = <span style="color: #008b8b;">True</span>
</pre>
</div></li>
</ul>

<p>
3、 <b>启动WEB Server</b>
</p>
<div class="org-src-container">
<pre class="src src-sh">python manage.py runserver <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748; 127.0.0.1:8000</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">python manage.py runserver 0.0.0.0:8000</span>
</pre>
</div>

<ul class="org-ul">
<li>访问<a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a> 看到服务启动正常</li>
<li>访问<a href="http://127.0.0.1:8000/admin/">http://127.0.0.1:8000/admin/</a> 可以登录后台管理界面
<ul class="org-ul">
<li>注意：用户名密码为之前第一步创建管理员时设定的</li>
<li>用户名：admin   密码：adminadmin</li>
<li>可以在页面创建普通用户</li>
</ul></li>
</ul>

<p>
4、 <b>注册应用模块</b>
</p>
<ul class="org-ul">
<li>注册后user可以被管理员用户在web界面进行增删改操作</li>
</ul>

<p>
登录后如果希望后来能够管理这些表，就需要在admin文件中注册对应的models
</p>

<p>
举例
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">models.py</span>
<span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> models

<span style="color: #b22222;"># </span><span style="color: #b22222;">Create your models here.</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Post</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">meta</span>:
        <span style="color: #a0522d;">db_table</span>=<span style="color: #8b2252;">"a"</span>
    <span style="color: #a020f0;">pass</span>
</pre>
</div>

<p>
在admin.py文件中注册
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.contrib <span style="color: #a020f0;">import</span> admin

<span style="color: #b22222;"># </span><span style="color: #b22222;">Register your models here.</span>
<span style="color: #a020f0;">from</span> .models <span style="color: #a020f0;">import</span> Post
admin.site.register(Post)
</pre>
</div>

<p>
登录成功后，可以看到注册的表了。
</p>
</div>
</div>
<div id="outline-container-h:2a94a3a7-cb99-4a99-a4d0-ddc8b8629169" class="outline-4">
<h4 id="h:2a94a3a7-cb99-4a99-a4d0-ddc8b8629169">路由（重要）</h4>
<div class="outline-text-4" id="text-h:2a94a3a7-cb99-4a99-a4d0-ddc8b8629169">
<p>
路由功能就是实现URL模式匹配和处理函数之间的映射。
</p>

<p>
路由配置要在项目的urls.py中配置，也可以多级配置，在每一个应用中，建立一个urls.py文件配置路由映射。
</p>

<p>
官方文档：
</p>
<ul class="org-ul">
<li>URL调度器: <a href="https://docs.djangoproject.com/zh-hans/5.2/topics/http/urls/">https://docs.djangoproject.com/zh-hans/5.2/topics/http/urls/</a></li>
<li>path函数: <a href="https://docs.djangoproject.com/en/5.2/ref/urls/#django.urls.path">https://docs.djangoproject.com/en/5.2/ref/urls/#django.urls.path</a></li>

<li>url函数(Django 2.x之前)
<ul class="org-ul">
<li>url(regex,view,kwargs=None,name=None) 进行模式匹配
<ol class="org-ol">
<li>regex: 正则表达式，与之匹配的URL会执行对应的第二个参数view</li>
<li>view: 用于执行与正则表达式匹配的URL请求</li>
<li>kwargs: 视图使用的字典类型的参数</li>
<li>name: 用来反向获取URL</li>
</ol></li>
</ul></li>
<li>path函数(2.x+)
<ul class="org-ul">
<li>path(route, view, kwargs=None, name=None)
<ul class="org-ul">
<li>对URL进行模式匹配</li>
<li>可以使用尖括号来捕获部分URL成分。一旦使用了尖括号提取成分，每一个成分都会变成一个 <b>实参</b></li>
<li><b>注入</b> 到视图函数中，视图函数必须增加形参接收</li>
<li>形参函数基本同url函数</li>
</ul></li>
</ul></li>
</ul>

<p>
还有一个re_path函数(2.x+)可以使用正则表达式，本质上就是url函数。
</p>

<p>
urls.py 内容如下
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.contrib <span style="color: #a020f0;">import</span> admin
<span style="color: #a020f0;">from</span> django.urls <span style="color: #a020f0;">import</span> path
<span style="color: #a020f0;">from</span> django.urls <span style="color: #a020f0;">import</span> re_path
<span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse,HttpRequest

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>(request:HttpRequest):
    <span style="color: #8b2252;">"""&#35270;&#22270;&#20989;&#25968;&#65306;&#35831;&#27714;&#36827;&#26469;&#36820;&#22238;&#21709;&#24212;"""</span>
    <span style="color: #a0522d;">res</span> = HttpResponse(b<span style="color: #8b2252;">"Hello word xdd"</span>)
    <span style="color: #483d8b;">print</span>(res.charset) <span style="color: #b22222;">#</span><span style="color: #b22222;">utf-8</span>
    <span style="color: #a020f0;">return</span> res

<span style="color: #a0522d;">urlpatterns</span> = [
    path(<span style="color: #8b2252;">'admin/'</span>, admin.site.urls),
    re_path(r<span style="color: #8b2252;">'^$'</span>,index),
    re_path(r<span style="color: #8b2252;">'^index$'</span>,index) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#36335;&#24452;&#21487;&#20197;&#25351;&#21521;&#21516;&#19968;&#20010;&#20989;&#25968;&#25191;&#34892;</span>
]
</pre>
</div>

<ul class="org-ul">
<li>启动web服务=python manage.py runserver=
<ol class="org-ol">
<li>访问=<a href="http://127.0.0.1:8000/index=%E5%92%8C=http://127.0.0.1:8000/=%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E8%AE%BF%E9%97%AE%E7%95%8C%E9%9D%A2">http://127.0.0.1:8000/index=%E5%92%8C=http://127.0.0.1:8000/=%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E8%AE%BF%E9%97%AE%E7%95%8C%E9%9D%A2</a></li>
</ol></li>
<li>url的定义与访问
<ol class="org-ol">
<li><code>url(r'^index/$',index)</code>
<ul class="org-ul">
<li>=<a href="http://127.0.0.1:8000/index/=%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE">http://127.0.0.1:8000/index/=%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE</a></li>
<li><code>http://127.0.0.1:8000/index=可以访问，但会自动补一个=/</code></li>
</ul></li>
<li><code>url(r'^index$',index)</code>
<ul class="org-ul">
<li>=<a href="http://127.0.0.1:8000/index=%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE">http://127.0.0.1:8000/index=%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE</a></li>
<li>=<a href="http://127.0.0.1:8000/index/=%E4%B8%8D%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE">http://127.0.0.1:8000/index/=%E4%B8%8D%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE</a></li>
</ul></li>
</ol></li>
<li>请求信息测试和JSON响应,修改上面index函数</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse,HttpRequest,JsonResponse

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>(request:HttpRequest):
    <span style="color: #8b2252;">"""&#35270;&#22270;&#20989;&#25968;&#65306;&#35831;&#27714;&#36827;&#26469;&#36820;&#22238;&#21709;&#24212;"""</span>
    <span style="color: #a0522d;">d</span> = {}
    <span style="color: #a0522d;">d</span>[<span style="color: #8b2252;">"method"</span>] = request.method
    <span style="color: #a0522d;">d</span>[<span style="color: #8b2252;">"path"</span>] = request.path
    <span style="color: #a0522d;">d</span>[<span style="color: #8b2252;">"path_info"</span>] = request.path_info
    <span style="color: #a0522d;">d</span>[<span style="color: #8b2252;">"GETparams"</span>] = request.GET

    <span style="color: #a020f0;">return</span> JsonResponse(d)
</pre>
</div>

<ul class="org-ul">
<li>在项目中首页数使用HTML显示，为了加载速度快，一般多使用静态页面。如果首页内容多，还有部分数据需要变化，将变化部分使用AJAX技术从后台获取数据。</li>
<li>本次，为了学习模板技术，只将首页采用Django的模板技术实现。</li>
</ul>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">URL configuration for blog project.</span>

<span style="color: #8b2252;">The `urlpatterns` list routes URLs to views. For more information please see:</span>
<span style="color: #8b2252;">    https://docs.djangoproject.com/en/5.2/topics/http/urls/</span>
<span style="color: #8b2252;">Examples:</span>
<span style="color: #8b2252;">Function views</span>
<span style="color: #8b2252;">    1. Add an import:  from my_app import views</span>
<span style="color: #8b2252;">    2. Add a URL to urlpatterns:  path('', views.home, name='home')</span>
<span style="color: #8b2252;">Class-based views</span>
<span style="color: #8b2252;">    1. Add an import:  from other_app.views import Home</span>
<span style="color: #8b2252;">    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')</span>
<span style="color: #8b2252;">Including another URLconf</span>
<span style="color: #8b2252;">    1. Import the include() function: from django.urls import include, path</span>
<span style="color: #8b2252;">    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">from</span> django.contrib <span style="color: #a020f0;">import</span> admin
<span style="color: #a020f0;">from</span> django.urls <span style="color: #a020f0;">import</span> path, re_path <span style="color: #b22222;">#</span><span style="color: #b22222;">url</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">from django.shortcuts import HttpResponse #WSGI&#24555;&#25463;&#26041;&#27861;&#65292;&#36824;&#21487;&#20197;&#20174;django.http&#20013;&#23548;&#20837;</span>
<span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse, HttpRequest
<span style="color: #b22222;"># </span><span style="color: #b22222;">HttpRequest&#26159;&#29238;&#31867;&#65307;WSGIRequest&#26159;&#23376;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">view&#20989;&#25968;, &#26681;&#25454;&#35831;&#27714;&#65292;&#36820;&#22238;&#30456;&#24212;&#30340;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">function-based view =&gt; FBV</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35201;&#27714;&#24517;&#39035;&#25552;&#20379;&#33267;&#23569;&#19968;&#20010;&#21442;&#25968;&#65292;&#31532;&#19968;&#20010;&#21442;&#25968;&#35299;&#20915;request&#27880;&#20837;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>(request:HttpRequest):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
    <span style="color: #483d8b;">print</span>(request)
    <span style="color: #483d8b;">print</span>(request.path_info)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">response = HttpResponse('&#36825;&#26159;&#39318;&#39029;', charset='gbk') # makebytes() &#32534;&#30721;&#65311; ; charset='utf-8'; DEFAULT_CHARSET &#22312;settings&#20013;&#20840;&#23616;&#37197;&#32622;</span>
    <span style="color: #a0522d;">response</span> = HttpResponse(<span style="color: #8b2252;">'&#36825;&#26159;&#39318;&#39029;'</span>)
    <span style="color: #483d8b;">print</span>(response.charset)
    <span style="color: #a020f0;">return</span> response

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#21516;url path &#21644;&#19981;&#21516;&#30340;&#20989;&#25968;&#20043;&#38388;&#30340;&#23545;&#24212;&#20851;&#31995;&#65292;&#19981;&#31649;&#20160;&#20040;&#20989;&#25968;&#25191;&#34892;&#65292;&#26368;&#32456;&#37117;&#24212;&#35813;&#36820;&#22238;&#36820;&#22238;&#20540;(&#20934;&#22791;&#36820;&#22238;&#30340;&#20869;&#23481;)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36335;&#24452;&#21305;&#37197;&#65306;&#23436;&#20840;&#21305;&#37197;&#12289;&#27169;&#24335;&#21305;&#37197;</span>
<span style="color: #a0522d;">urlpatterns</span> = [
    path(<span style="color: #8b2252;">'admin/'</span>, admin.site.urls), <span style="color: #b22222;"># </span><span style="color: #b22222;">/admin/ &#36335;&#24452;&#23545;&#24212;&#65292;&#22810;&#32423;url&#22788;&#29702;</span>
    path(<span style="color: #8b2252;">''</span>, index), <span style="color: #b22222;">#  </span><span style="color: #b22222;">'/' =&gt; index &#20989;&#25968;&#65292; request&#23454;&#21442;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">path('index', index), # '/index' OK ; '/index/' Wrong</span>
    path(<span style="color: #8b2252;">'index/'</span>, index), <span style="color: #b22222;"># </span><span style="color: #b22222;">'/index' 301 '/index/'; '/index/' OK</span>
]
<span style="color: #b22222;"># </span><span style="color: #b22222;">/index =&gt; server &#31471;&#65292;&#20998;&#26512;url&#65292;&#36820;&#22238;&#19968;&#20010;&#26032;&#36335;&#24452;301 location /index/</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">path route&#23450;&#20041;&#19981;&#20197;/&#32467;&#23614;&#65292;&#24448;&#24448;&#20195;&#34920;&#23601;&#26159; ^index$</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">URL configuration for blog project.</span>

<span style="color: #8b2252;">The `urlpatterns` list routes URLs to views. For more information please see:</span>
<span style="color: #8b2252;">    https://docs.djangoproject.com/en/5.2/topics/http/urls/</span>
<span style="color: #8b2252;">Examples:</span>
<span style="color: #8b2252;">Function views</span>
<span style="color: #8b2252;">    1. Add an import:  from my_app import views</span>
<span style="color: #8b2252;">    2. Add a URL to urlpatterns:  path('', views.home, name='home')</span>
<span style="color: #8b2252;">Class-based views</span>
<span style="color: #8b2252;">    1. Add an import:  from other_app.views import Home</span>
<span style="color: #8b2252;">    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')</span>
<span style="color: #8b2252;">Including another URLconf</span>
<span style="color: #8b2252;">    1. Import the include() function: from django.urls import include, path</span>
<span style="color: #8b2252;">    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">from</span> django.contrib <span style="color: #a020f0;">import</span> admin
<span style="color: #a020f0;">from</span> django.urls <span style="color: #a020f0;">import</span> path, re_path <span style="color: #b22222;">#</span><span style="color: #b22222;">url</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">from django.shortcuts import HttpResponse #WSGI&#24555;&#25463;&#26041;&#27861;&#65292;&#36824;&#21487;&#20197;&#20174;django.http&#20013;&#23548;&#20837;</span>
<span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse, HttpRequest
<span style="color: #a020f0;">from</span> django.core.handlers.wsgi <span style="color: #a020f0;">import</span> WSGIRequest
<span style="color: #b22222;"># </span><span style="color: #b22222;">HttpRequest&#26159;&#29238;&#31867;&#65307;WSGIRequest&#26159;&#23376;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">view&#20989;&#25968;, &#26681;&#25454;&#35831;&#27714;&#65292;&#36820;&#22238;&#30456;&#24212;&#30340;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">function-based view =&gt; FBV</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35201;&#27714;&#24517;&#39035;&#25552;&#20379;&#33267;&#23569;&#19968;&#20010;&#21442;&#25968;&#65292;&#31532;&#19968;&#20010;&#21442;&#25968;&#35299;&#20915;request&#27880;&#20837;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>(request:WSGIRequest):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
    <span style="color: #483d8b;">print</span>(request)
    <span style="color: #483d8b;">print</span>(request.path_info)
    <span style="color: #483d8b;">print</span>(request.GET) <span style="color: #b22222;"># </span><span style="color: #b22222;">query string &#26597;&#35810;&#23383;&#31526;&#20018;&#30340;&#23553;&#35013; MultiValueDict &#29233;&#22909; interest=music&amp;interest=movie</span>
    <span style="color: #483d8b;">print</span>(request.POST) <span style="color: #b22222;"># </span><span style="color: #b22222;">QueryDict MultiValueDict request body</span>
    <span style="color: #483d8b;">print</span>(request.COOKIES)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span>*30)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">response = HttpResponse('&#36825;&#26159;&#39318;&#39029;', charset='gbk') # makebytes() &#32534;&#30721;&#65311; ; charset='utf-8'; DEFAULT_CHARSET &#22312;settings&#20013;&#20840;&#23616;&#37197;&#32622;</span>
    <span style="color: #a0522d;">response</span> = HttpResponse(<span style="color: #8b2252;">'&#36825;&#26159;&#39318;&#39029;'</span>)
    <span style="color: #483d8b;">print</span>(response.charset)
    <span style="color: #a020f0;">return</span> response

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#21516;url path &#21644;&#19981;&#21516;&#30340;&#20989;&#25968;&#20043;&#38388;&#30340;&#23545;&#24212;&#20851;&#31995;&#65292;&#19981;&#31649;&#20160;&#20040;&#20989;&#25968;&#25191;&#34892;&#65292;&#26368;&#32456;&#37117;&#24212;&#35813;&#36820;&#22238;&#36820;&#22238;&#20540;(&#20934;&#22791;&#36820;&#22238;&#30340;&#20869;&#23481;)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36335;&#24452;&#21305;&#37197;&#65306;&#23436;&#20840;&#21305;&#37197;&#12289;&#27169;&#24335;&#21305;&#37197;</span>
<span style="color: #a0522d;">urlpatterns</span> = [
    path(<span style="color: #8b2252;">'admin/'</span>, admin.site.urls), <span style="color: #b22222;"># </span><span style="color: #b22222;">/admin/ &#36335;&#24452;&#23545;&#24212;&#65292;&#22810;&#32423;url&#22788;&#29702;</span>
    path(<span style="color: #8b2252;">''</span>, index), <span style="color: #b22222;">#  </span><span style="color: #b22222;">'/' =&gt; index &#20989;&#25968;&#65292; request&#23454;&#21442;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">path('index', index), # '/index' OK ; '/index/' Wrong</span>
    path(<span style="color: #8b2252;">'index/'</span>, index), <span style="color: #b22222;"># </span><span style="color: #b22222;">'/index' 301 '/index/'; '/index/' OK</span>
]
<span style="color: #b22222;"># </span><span style="color: #b22222;">/index =&gt; server &#31471;&#65292;&#20998;&#26512;url&#65292;&#36820;&#22238;&#19968;&#20010;&#26032;&#36335;&#24452;301 location /index/</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">path route&#23450;&#20041;&#19981;&#20197;/&#32467;&#23614;&#65292;&#24448;&#24448;&#20195;&#34920;&#23601;&#26159; ^index$</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:82fc7377-e915-4d33-babe-aedf458c95eb" class="outline-3">
<h3 id="h:82fc7377-e915-4d33-babe-aedf458c95eb">Django模板技术</h3>
<div class="outline-text-3" id="text-h:82fc7377-e915-4d33-babe-aedf458c95eb">
<p>
[toc]
</p>

<p>
如果使用react实现前端页面，其实Django就没有必须使用模板，它其实就是一个纯后台服务程序，接收请求，响应数据，前端接口设计就可以是纯粹的Restful风格。
</p>

<p>
模板的目的就是为了可视化，将数据按照一定布局格式输出，而不是为了数据处理，所以一般不会有复杂的处理逻辑。模板的引入实现了业务逻辑和显示格式的分离。这样，在开发中，就可以分工协作，页面开发完成页面布局设计，后台开发完成数据处理逻辑实现。
</p>

<ul class="org-ul">
<li>Python的模板引擎默认使用Django template language(DTL)构建</li>
</ul>
</div>
<div id="outline-container-h:2a9d1d94-4532-4b87-81db-f3a89607fca3" class="outline-4">
<h4 id="h:2a9d1d94-4532-4b87-81db-f3a89607fca3">模板配置</h4>
<div class="outline-text-4" id="text-h:2a9d1d94-4532-4b87-81db-f3a89607fca3">
<ul class="org-ul">
<li>在=djweb/settings.py=中，设置模板项目的路径</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">BASE_DIR</span> = os.path.dirname(os.path.dirname(os.path.abspath(__file__))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#21477;&#35805;&#21462;&#39033;&#30446;&#26681;&#30446;&#24405;</span>
<span style="color: #a0522d;">TEMPLATES</span> = [
    {
        <span style="color: #8b2252;">'BACKEND'</span>: <span style="color: #8b2252;">'django.template.backends.django.DjangoTemplates'</span>,
        <span style="color: #8b2252;">'DIRS'</span>: [os.path.abspath(os.path.join(BASE_DIR,<span style="color: #8b2252;">'templates'</span>))], <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21046;&#23450;&#27169;&#26495;&#25991;&#20214;&#22841;&#36335;&#24452;</span>
        <span style="color: #8b2252;">'APP_DIRS'</span>: <span style="color: #008b8b;">True</span>,
        <span style="color: #8b2252;">'OPTIONS'</span>: {
            <span style="color: #8b2252;">'context_processors'</span>: [
                <span style="color: #8b2252;">'django.template.context_processors.debug'</span>,
                <span style="color: #8b2252;">'django.template.context_processors.request'</span>,
                <span style="color: #8b2252;">'django.contrib.auth.context_processors.auth'</span>,
                <span style="color: #8b2252;">'django.contrib.messages.context_processors.messages'</span>,
            ],
        },
    },
]
</pre>
</div>

<ul class="org-ul">
<li><b>DIRS</b>:列表，定义模板文件的搜索路径顺序。os.path.join(BASE_DIR,'templates')即项目根目录下templates目录，请构建这个目录。
<ol class="org-ol">
<li>项目根目录中构建templates文件夹。模板文件目录</li>
</ol></li>
<li><b>APP_DIRS</b>:是否运行在每个已经安装的应用中查找模板。应用自己目录下游templates目录，例如：=django/contrilb/admin/templates=。如果应用需要可分离、可重用，建议吧模板放到应用目录下</li>
<li>*BASE_DIR*是项目根目录，=os.path.join(BASE_DIR,'templates')=就是在manage.py这一层建立一个目录templates。这个路径就是以后默认找模板的地方。</li>
</ul>
</div>
</div>
<div id="outline-container-h:fbd99f6a-e10a-4154-a886-d862825ae16f" class="outline-4">
<h4 id="h:fbd99f6a-e10a-4154-a886-d862825ae16f">模板渲染</h4>
<div class="outline-text-4" id="text-h:fbd99f6a-e10a-4154-a886-d862825ae16f">
<ul class="org-ul">
<li><p>
<b>模板页</b>
</p>
<ol class="org-ol">
<li>新建html文件，在=/templates/index.html=目录下</li>
</ol>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Django web &#27169;&#26495;&#25216;&#26415;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&#25105;&#26159;&#27169;&#26495;&#65292;&#25968;&#25454;&#26159;{{content}}
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div></li>

<li><p>
<b>模板处理</b>
</p>
<ol class="org-ol">
<li>*加载模板*：模板是一个文件，需要从磁盘读取并加载。要将模板放置在指定的模板文件夹中</li>
<li>*渲染*：模板需要使用内容数据渲染</li>
<li>测试：修改=djweb/urls.py=文件中的index函数。</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.template <span style="color: #a020f0;">import</span> loader

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>(request:HttpRequest):
    <span style="color: #8b2252;">"""&#35270;&#22270;&#20989;&#25968;&#65306;&#35831;&#27714;&#36827;&#26469;&#36820;&#22238;&#21709;&#24212;"""</span>
    <span style="color: #a0522d;">template</span> = loader.get_template(<span style="color: #8b2252;">"index.html"</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#36733;&#22120;&#27169;&#22359;&#25628;&#32034;&#27169;&#26495;&#24182;&#21152;&#36733;&#23427;</span>
    <span style="color: #483d8b;">print</span>(template.origin) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27169;&#26495;&#36335;&#24452;</span>
    <span style="color: #a0522d;">context</span> = {<span style="color: #8b2252;">"content"</span>:<span style="color: #8b2252;">"www.xdd.com"</span>} <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23383;&#20856;&#25968;&#25454;</span>
    <span style="color: #a020f0;">return</span> HttpResponse(template.render(context,request))
</pre>
</div>

<ol class="org-ol">
<li>运行server <code>python manage.py runserver</code></li>
<li>访问=<a href="http://127.0.0.1:8000/=%E7%95%8C%E9%9D%A2%E5%A6%82%E4%B8%8B%EF%BC%9A%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0">http://127.0.0.1:8000/=%E7%95%8C%E9%9D%A2%E5%A6%82%E4%B8%8B%EF%BC%9A%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0</a></li>
</ol></li>
<li><p>
<b>render快捷渲染函数</b>
</p>
<ol class="org-ol">
<li>上面2个步骤代码编写繁琐，Django提供了对其的封装-------&#x2013;&#x2014;快捷函数render。</li>
<li><code>render(request,template_name,context=None)</code> 返回HTTPResponse对象
<ul class="org-ul">
<li>template_name #模板名称</li>
<li>context 数据字典</li>
<li>render_to_string()
是其核心方法，其实就是拿数据替换HTML中的指定位置后返回一个字符串</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-py">from django.shortcuts import  render

def index(request:HttpRequest):
    """视图函数：请求进来返回响应"""
    return render(request,"index.html",{"content":"www.xdd.com"})
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:a6794a58-2021-4cf3-9116-80e8e3a5e254" class="outline-4">
<h4 id="h:a6794a58-2021-4cf3-9116-80e8e3a5e254">DTL语法(模板语法)</h4>
<div class="outline-text-4" id="text-h:a6794a58-2021-4cf3-9116-80e8e3a5e254">
</div>
<div id="outline-container-h:5f11a19c-280e-4b5c-bb1d-db609c3f5aaf" class="outline-5">
<h5 id="h:5f11a19c-280e-4b5c-bb1d-db609c3f5aaf">变量</h5>
<div class="outline-text-5" id="text-h:5f11a19c-280e-4b5c-bb1d-db609c3f5aaf">
<ul class="org-ul">
<li>语法：={{ variable }}=</li>
<li>变量名由字母、数字、下划线、点号组成。</li>
<li>点号使用的时候，例如foo.bar,遵循以下顺序：
<ol class="org-ol">
<li>字典查找，例如=foo["bar"]=,把foo当做字典，bar当做key</li>

<li>属性或方法的查找，例如=foo.bar=,把foo当做对象，bar当做属性或方法</li>

<li>数字索引查找，例如=foo[1]=,把foo当做列表一样，使用索引访问</li>

<li><p>
示例： 修改=djweb/urls.py=文件中的index函数
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.shortcuts <span style="color: #a020f0;">import</span>  render
<span style="color: #a020f0;">import</span> datetime

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>(request:HttpRequest):
    <span style="color: #8b2252;">"""&#35270;&#22270;&#20989;&#25968;&#65306;&#35831;&#27714;&#36827;&#26469;&#36820;&#22238;&#21709;&#24212;"""</span>
    <span style="color: #a0522d;">my_dict</span> = {
        <span style="color: #8b2252;">"a"</span>:100,
        <span style="color: #8b2252;">"b"</span>:0,
        <span style="color: #8b2252;">"c"</span>:<span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">range</span>(10,20)),
        <span style="color: #8b2252;">"d"</span>:<span style="color: #8b2252;">'abc'</span>,
        <span style="color: #8b2252;">"date"</span>:datetime.datetime.now()
    }
    <span style="color: #a0522d;">context</span> = {<span style="color: #8b2252;">"content"</span>:<span style="color: #8b2252;">"www.xdd.com"</span>,<span style="color: #8b2252;">"my_dict"</span>:my_dict}
    <span style="color: #a020f0;">return</span> render(request,<span style="color: #8b2252;">"index.html"</span>,context)
</pre>
</div>

<ul class="org-ul">
<li>如果*变量未能找到，则缺省插入空字符串*。</li>
<li>在*模板中调用方法，不能加小括号*，自然也不能传递参数。</li>
<li>={{my_dict.a}}=复合第一条，当做字典的key就可以访问了</li>
<li>={{my_dict.keys}}=正确写法。符合第二条，当做my_dict对象的属性和方法。</li>
<li>错误写法={{my_dict.keys()}}=。</li>
</ul></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:d67e337e-ccd0-401b-b7f9-98941b6ce67b" class="outline-5">
<h5 id="h:d67e337e-ccd0-401b-b7f9-98941b6ce67b">模板标签</h5>
<div class="outline-text-5" id="text-h:d67e337e-ccd0-401b-b7f9-98941b6ce67b">
<ol class="org-ol">
<li><b>=if/else=标签</b>
<ul class="org-ul">
<li><p>
基本语法如下：
</p>

<div class="org-src-container">
<pre class="src src-txt">{% if condition %}
    ... display
{% endif %}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-txt">{% if condition %}
    ... display 1
{% elif condition2 %}
    ... display 2
{% else %}
    ... display 3
{% endif %}
</pre>
</div></li>

<li>条件也支持=and、or、not=</li>

<li>注意,因为这些标签是断开的，所以不能像Python一样使用缩进就可以表示出来，必须有个结束标签，例如endif、endfor。</li>
</ul></li>

<li><p>
<b>=for=标签</b>
</p>
<ul class="org-ul">
<li><a href="https://docs.djangoproject.com/en/2.0/ref/templates/builtins/#for">https://docs.djangoproject.com/en/2.0/ref/templates/builtins/#for</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Django web &#27169;&#26495;&#25216;&#26415;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&#25105;&#26159;&#27169;&#26495;&#65292;&#25968;&#25454;&#26159;{{content}}

&lt;<span style="color: #0000ff;">ul</span>&gt;
{% for athlete in athlete_list  %}
    &lt;<span style="color: #0000ff;">li</span>&gt;{{ athlete.name }}&lt;/<span style="color: #0000ff;">li</span>&gt;
{% endfor %}
&lt;/<span style="color: #0000ff;">ul</span>&gt;

&lt;<span style="color: #0000ff;">ul</span>&gt;
{% for person in person_list %}
    &lt;<span style="color: #0000ff;">li</span>&gt; {{ person.name }}&lt;/<span style="color: #0000ff;">li</span>&gt;
{% endfor %}
&lt;/<span style="color: #0000ff;">ul</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">变量</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>forloop.counter</code></td>
<td class="org-left">当前循环从1开始的计数</td>
</tr>

<tr>
<td class="org-left"><code>forloop.counter0</code></td>
<td class="org-left">当前循环从0开始的计数</td>
</tr>

<tr>
<td class="org-left"><code>forloop.revcounter</code></td>
<td class="org-left">从循环的末尾开始倒计数1</td>
</tr>

<tr>
<td class="org-left"><code>forloop.revcounter0</code></td>
<td class="org-left">从循环的末尾开始倒计数到0</td>
</tr>

<tr>
<td class="org-left"><code>forloop.first</code></td>
<td class="org-left">第一次进入循环</td>
</tr>

<tr>
<td class="org-left"><code>forloop.last</code></td>
<td class="org-left">最后一次进入循环</td>
</tr>

<tr>
<td class="org-left"><code>forloop.parentloop</code></td>
<td class="org-left">循环嵌套时，内层当前循环的外层循环</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>给标签增加一个reversed使得该列表被反向迭代:</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">{% for athlete in athlete_list reversed %}
...
{% empty %}
... &#22914;&#26524;&#34987;&#36845;&#20195;&#30340;&#21015;&#34920;&#26159;&#31354;&#30340;&#25110;&#32773;&#19981;&#23384;&#22312;&#65292;&#25191;&#34892;empty
{% endfor %}
</pre>
</div>

<ul class="org-ul">
<li>可以嵌套使用{% for %}标签：</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">{% for athlete in athlete_list %}
    &lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ athlete.name }}</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
    &lt;<span style="color: #0000ff;">ul</span>&gt;
    &lt;% for sport in athlete.sports_played %&gt;
        &lt;<span style="color: #0000ff;">li</span>&gt;{{ sport }}&lt;/<span style="color: #0000ff;">li</span>&gt;
    &lt;% endfor %&gt;
    &lt;/<span style="color: #0000ff;">ul</span>&gt;
{% endfor %}
</pre>
</div></li>

<li><p>
<b>=ifequel/ifnotequal=标签</b>
</p>
<ul class="org-ul">
<li>={% ifequal %}=标签比较两个值，当他们相等时，显示在={% ifequal %}=和={% endifequal %}=之中所有的值。下面的例子比较两个模板变量user和currentuser:</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">{% ifequal user currentuser %}
    &lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Welcome!</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
{% endifequal %}
</pre>
</div>

<ul class="org-ul">
<li>和={% if %}=类似，={% ifequal %}=支持可选的={% else %}=标签：</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">{% ifequal section 'sitenews' %}
    &lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Site News</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
{% else %}
    &lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">No News Here</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
{% endifequal %}
</pre>
</div>

<ul class="org-ul">
<li>其他标签
<ol class="org-ol">
<li>*csrf_token*用于跨站请求伪造保护，防止跨站攻击的。={% csrf_token %}=</li>
</ol></li>
</ul></li>
<li><p>
<b>注释标签</b>
</p>
<ul class="org-ul">
<li>单行注释={# #}=</li>
<li>多行注释={% comment %}&#x2026; {% endcomment %}=</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">{# &#36825;&#26159;&#19968;&#20010;&#27880;&#37322; #}
{% comment %}
&#36825;&#26159;&#22810;&#34892;&#27880;&#37322;
{% endcomment %}
</pre>
</div></li>

<li><p>
<b>过滤器</b>
</p>
<ul class="org-ul">
<li>模板过滤器可以在遍历被显示前修改它。</li>
<li>语法 <code>{{ 变量|过滤器}}</code>
<ol class="org-ol">
<li>过滤器使用管道字符=|=,例如={{ name|lower}}=,={{ name }}=变量被过滤器lower处理后，文档大写转换文本为小写。</li>
<li>过滤管道可以被*套接*，一个过滤器管道的输出又可以作为下一个管道的输入。
<ul class="org-ul">
<li>例如={{ my_list|first|upper }}=,将列表第一个元素并将其转化为大写。</li>
</ul></li>
<li><b>过滤器传参</b>
<ul class="org-ul">
<li>有些过滤器可以传递参数，过滤器的参数跟随冒号之后并且总是以双引号包含。</li>
<li>例如:
<ol class="org-ol">
<li><code>{{bio|truncatewords:"30"}}</code>,截取显示变量bio的前30个词。</li>
<li><code>{{ my_list|join:"," }}</code>,将my_list的所有元素使用=,=逗号连接起来</li>
</ol></li>
</ul></li>
</ol></li>
<li>其他过滤器</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">过滤器</th>
<th scope="col" class="org-left">说明</th>
<th scope="col" class="org-left">举例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>cut</code></td>
<td class="org-left">切掉字符串中的指定字符</td>
<td class="org-left">={{ value</td>
<td class="org-left">cut:"b"}}=</td>
</tr>

<tr>
<td class="org-left"><code>lower</code></td>
<td class="org-left">转换为小写</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>upper</code></td>
<td class="org-left">转换为大写</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>truncatewords</code></td>
<td class="org-left">指定的长度截取字符串</td>
<td class="org-left">={{ bio</td>
<td class="org-left">truncatewords:"30"}}=</td>
</tr>

<tr>
<td class="org-left"><code>join</code></td>
<td class="org-left">对序列拼接</td>
<td class="org-left">={{ d.e</td>
<td class="org-left">join:"//"}}=</td>
</tr>

<tr>
<td class="org-left">=first=取序列第一个元素</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>last</code></td>
<td class="org-left">取序列最后元素</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>yesno</code></td>
<td class="org-left">变量可以是True、False、Noneyesno的参数给定逗号分隔的三个值，返回3个值中的一个。True对应第一个False对应第二个None对应第三个如果参数只有2个，None等效False处理</td>
<td class="org-left">={{value</td>
<td class="org-left">yesno:"yeah,no,maybe"}}=</td>
</tr>

<tr>
<td class="org-left"><code>add</code></td>
<td class="org-left">加法，参数是负数就是减法</td>
<td class="org-left">数字加={{value</td>
<td class="org-left">add:"100"}}=列表合并={{mylist</td>
<td class="org-left">add:newlist}}=</td>
</tr>

<tr>
<td class="org-left"><code>divisibleby</code></td>
<td class="org-left">能否被整除</td>
<td class="org-left">={{value</td>
<td class="org-left">divisibleby:"3" }}=能被3整除返回True</td>
</tr>

<tr>
<td class="org-left"><code>addslashes</code></td>
<td class="org-left">在反斜杠、单引号或者双引号前面加上反斜杠</td>
<td class="org-left">={{value</td>
<td class="org-left">addslashes }}=</td>
</tr>

<tr>
<td class="org-left"><code>length</code></td>
<td class="org-left">返回变量的长度</td>
<td class="org-left">={% if my_list</td>
<td class="org-left">length &gt;1 %}=</td>
</tr>

<tr>
<td class="org-left"><code>default</code></td>
<td class="org-left">变量等价False则使用缺省值</td>
<td class="org-left">={{value</td>
<td class="org-left">default:"nothing"}}=</td>
</tr>

<tr>
<td class="org-left"><code>default_if_none</code></td>
<td class="org-left">变量为None使用缺省值</td>
<td class="org-left">={{value</td>
<td class="org-left">default_if_none:"nothing"}}=</td>
</tr>

<tr>
<td class="org-left"><code>date</code></td>
<td class="org-left">格式化date或者datetime对象</td>
<td class="org-left">实例：={{my_dict.date</td>
<td class="org-left">date:'Y n j'}}=Y 2000年n 1-12月j 1-31日</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>时间的格式字符查看<a href="https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#date">https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#date</a></li>
<li>过滤参考<a href="https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#join">https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#join</a></li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:b29e3522-a78c-41be-86c1-6f9a0b305a22" class="outline-5">
<h5 id="h:b29e3522-a78c-41be-86c1-6f9a0b305a22">模板实例</h5>
<div class="outline-text-5" id="text-h:b29e3522-a78c-41be-86c1-6f9a0b305a22">
<ol class="org-ol">
<li><p>
奇偶行列表输出
</p>
<ul class="org-ul">
<li>使用下面字典my_dict的c的列表，在模板网页中列表ul输出多行数据
<ol class="org-ol">
<li>要求奇偶行颜色不同</li>
<li>每行有行号(从1开始)</li>
<li>列表中所有数据都增大100</li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from django.http import HttpResponse,HttpRequest,JsonResponse
from django.template import loader
from django.shortcuts import  render
import datetime

def index(request:HttpRequest):
"""视图函数：请求进来返回响应"""
my_dict = {
    "a":100,
    "b":0,
    "c":list(range(10,20)),
    "d":'abc',
    "date":datetime.datetime.now()
}
context = {"content":"www.xdd.com","my_dict":my_dict}
return render(request,"index.html",context)
</pre>
</div>

<ul class="org-ul">
<li>模板页面</li>
</ul>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Django web &#27169;&#26495;&#25216;&#26415;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&#25105;&#26159;&#27169;&#26495;&#65292;&#25968;&#25454;&#26159;{{content}}

&lt;<span style="color: #0000ff;">ul</span>&gt;
{% for athlete in my_dict.items  %}
    {% ifequal athlete.0 "c" %}
        {% for dt in athlete.1 %}
            &lt;<span style="color: #0000ff;">li</span>&gt;{{ forloop.parentloop.counter }} | {{ forloop.counter }} | {{ athlete.0 }} -- {{ dt|add:"100" }}&lt;/<span style="color: #0000ff;">li</span>&gt;
        {% endfor %}
    {% else %}
        {% ifequal athlete.0 "date" %}
            &lt;<span style="color: #0000ff;">li</span>&gt;{{ forloop.counter }} | {{ athlete.0 }} -- {{ athlete.1|date:'Y-n-j' }}&lt;/<span style="color: #0000ff;">li</span>&gt;
        {% else %}
            &lt;<span style="color: #0000ff;">li</span>&gt;{{ forloop.counter }} | {{ athlete.0 }} &lt;/<span style="color: #0000ff;">li</span>&gt;
        {% endifequal %}
    {% endifequal %}
{% endfor %}
&lt;/<span style="color: #0000ff;">ul</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:a539f05a-6cbd-4d47-a1de-9390bd0922e6" class="outline-5">
<h5 id="h:a539f05a-6cbd-4d47-a1de-9390bd0922e6">附加&#x2013;Pycharm模板自定义</h5>
<div class="outline-text-5" id="text-h:a539f05a-6cbd-4d47-a1de-9390bd0922e6">
<ol class="org-ol">
<li>第一步：</li>
<li>第二步</li>
<li>第三步</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5507a5c6-5cb6-476a-b1da-aeee85d2c35e" class="outline-3">
<h3 id="h:5507a5c6-5cb6-476a-b1da-aeee85d2c35e">Restful-API设计</h3>
<div class="outline-text-3" id="text-h:5507a5c6-5cb6-476a-b1da-aeee85d2c35e">
<p>
[toc]
</p>
</div>
<div id="outline-container-h:ecc47935-e604-4631-9013-3aab0b063012" class="outline-4">
<h4 id="h:ecc47935-e604-4631-9013-3aab0b063012">RESTFul</h4>
<div class="outline-text-4" id="text-h:ecc47935-e604-4631-9013-3aab0b063012">
<ul class="org-ul">
<li>REST(Representational State Transfer),表现层状态转移。</li>
<li>它首次出现在2000年Roy Fielding的博士论文中，Roy
Fielding是HTTP规范的主要编写者之一。<br></li>
<li>表现层是资源的表现层，对于网络中的资源就需要URI(Uniform Resource
Identiﬁer)来指向。</li>
</ul>
</div>
<div id="outline-container-h:49af8863-8cc8-445c-b2a6-b98063d63816" class="outline-5">
<h5 id="h:49af8863-8cc8-445c-b2a6-b98063d63816">1.协议</h5>
<div class="outline-text-5" id="text-h:49af8863-8cc8-445c-b2a6-b98063d63816">
<ul class="org-ul">
<li>使用HTTP或者HTTPS。对外若有安全性要求，可以使用HTTPS。但是内部服务间调用可以使用HTTP或HTTPS。</li>
</ul>
</div>
</div>
<div id="outline-container-h:1acdca45-9360-418e-ad1f-d8a5c6bc3a3e" class="outline-5">
<h5 id="h:1acdca45-9360-418e-ad1f-d8a5c6bc3a3e">2.HTTP方法</h5>
<div class="outline-text-5" id="text-h:1acdca45-9360-418e-ad1f-d8a5c6bc3a3e">
<ul class="org-ul">
<li>HTTP请求中的方法表示执行的*动作*</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">常用方法(动词)</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GET</td>
<td class="org-left">获取资源</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left">创建新的资源</td>
</tr>

<tr>
<td class="org-left">PUT</td>
<td class="org-left">更新资源</td>
</tr>

<tr>
<td class="org-left">PATCH</td>
<td class="org-left">部分更新资源</td>
</tr>

<tr>
<td class="org-left">DELETE</td>
<td class="org-left">删除资源</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:77e8fb6d-c20e-4d85-bccd-6e337306b639" class="outline-5">
<h5 id="h:77e8fb6d-c20e-4d85-bccd-6e337306b639">3.使用名称</h5>
<div class="outline-text-5" id="text-h:77e8fb6d-c20e-4d85-bccd-6e337306b639">
<p>
URL指向*资源*，在URL路径的描述中，只需要出现名称，而不要出现动词。动词由HTTP方法提供。<br>
不要单复数混用，建议名称使用复数。<br>
Restful的核心是资源，URL应该指向资源，所以应该是使用名称表达式，而不是动词表达。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">路径</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GET</td>
<td class="org-left"><code>/posts</code></td>
<td class="org-left">返回所有文章</td>
</tr>

<tr>
<td class="org-left">GET</td>
<td class="org-left"><code>/posts/10</code></td>
<td class="org-left">返回id为10的文章</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left"><code>/posts</code></td>
<td class="org-left">创建新的文章</td>
</tr>

<tr>
<td class="org-left">PUT</td>
<td class="org-left"><code>/posts/10</code></td>
<td class="org-left">更新id为10的文章</td>
</tr>

<tr>
<td class="org-left">DELETE</td>
<td class="org-left"><code>/posts/10</code></td>
<td class="org-left">删除id为10的文章</td>
</tr>

<tr>
<td class="org-left">PATCH</td>
<td class="org-left"><code>/posts/10</code></td>
<td class="org-left">部分更新id为10的文章数据</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>不要出现如下的访问路径</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">/getAllPosts
/addPost
/updatePost
/delPost
</pre>
</div>

<ul class="org-ul">
<li>GET方法只是获取资源，而不是改变资源状态。改变资源请使用POST,PUT,DELETE等方法。</li>

<li>例如：使用=GET /posts/10=就可以获取资源了，但是却使用=Get /posts/10/del=或=GET /posts/10?v=del=,本意是想删除。但这样不好，GET方法请求只为获取资源，不要改变资源状态。</li>

<li>子资源的访问</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">路径Endpoint</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GET</td>
<td class="org-left"><code>/posts/10/authors</code></td>
<td class="org-left">返回id为10的文章的所有作者</td>
</tr>

<tr>
<td class="org-left">GET</td>
<td class="org-left"><code>/posts/10/authors/8</code></td>
<td class="org-left">返回id为10的文章的作者中id为4的</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:4511c1d3-8530-47ab-8ae0-a32858ba5be6" class="outline-5">
<h5 id="h:4511c1d3-8530-47ab-8ae0-a32858ba5be6">4.集合功能</h5>
<div class="outline-text-5" id="text-h:4511c1d3-8530-47ab-8ae0-a32858ba5be6">
<ul class="org-ul">
<li>过滤Filtering
<ol class="org-ol">
<li>指定过滤条件=GET /posts?tag=python=</li>
</ol></li>
<li>排序Sorting
<ol class="org-ol">
<li>指定排序条件。有很多种设计风格，例如使用=+=表示asc,=-<code>表示desc。=GET /posts?sort=+title,-id=获取=GET /posts?sort=title_asc,id_desc</code></li>
</ol></li>
<li>分页Pagination
<ol class="org-ol">
<li>一般情况下，查询返回的记录数非常多，必须分页。=GET /posts?page=58&amp;size=20=</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:99dc4087-5906-46a8-bd31-78b68f8ff9e7" class="outline-5">
<h5 id="h:99dc4087-5906-46a8-bd31-78b68f8ff9e7">5.状态码</h5>
<div class="outline-text-5" id="text-h:99dc4087-5906-46a8-bd31-78b68f8ff9e7">
<ul class="org-ul">
<li>使用HTTP响应的状态码表示动作的成功与否。</li>
<li>2xx表示用户请求服务端成功的处理；4xx表示用户请求的错误；5xx表示服务器端出错了。</li>
</ul>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Status Code</th>
<th scope="col" class="org-left">说明</th>
<th scope="col" class="org-left">Method</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">200</td>
<td class="org-left">OK</td>
<td class="org-left">GET</td>
<td class="org-left">成功获取资源</td>
</tr>

<tr>
<td class="org-right">201</td>
<td class="org-left">CREATED</td>
<td class="org-left">POST,PUT,PATCH</td>
<td class="org-left">成功创建或修改</td>
</tr>

<tr>
<td class="org-right">204</td>
<td class="org-left">NO CONTENT</td>
<td class="org-left">DELETE</td>
<td class="org-left">成功删除资源</td>
</tr>

<tr>
<td class="org-right">400</td>
<td class="org-left">Bad Request</td>
<td class="org-left">ALL</td>
<td class="org-left">请求中有错误，例如：GET时参数有问题，PUT时提交的数据错误等</td>
</tr>

<tr>
<td class="org-right">401</td>
<td class="org-left">Unauthorized</td>
<td class="org-left">ALL</td>
<td class="org-left">权限未通过认证</td>
</tr>

<tr>
<td class="org-right">403</td>
<td class="org-left">Forbidden</td>
<td class="org-left">ALL</td>
<td class="org-left">有无权限都禁止访问该资源</td>
</tr>

<tr>
<td class="org-right">404</td>
<td class="org-left">Forbidden</td>
<td class="org-left">ALL</td>
<td class="org-left">请求资源不存在</td>
</tr>

<tr>
<td class="org-right">500</td>
<td class="org-left">internal Server Error</td>
<td class="org-left">ALL</td>
<td class="org-left">服务器端错误</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>详细状态码参考<a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:a4f53546-95ed-4a6e-a2f1-4bdbdc67b3e2" class="outline-5">
<h5 id="h:a4f53546-95ed-4a6e-a2f1-4bdbdc67b3e2">6.错误处理</h5>
<div class="outline-text-5" id="text-h:a4f53546-95ed-4a6e-a2f1-4bdbdc67b3e2">
<ul class="org-ul">
<li>在Restful
API设计中，错误处理也非常重要。单单从无状态码中无法详尽描述错误的信息。</li>

<li><p>
返回消息
</p>

<div class="org-src-container">
<pre class="src src-json">{error:"user NOT Found"}
</pre>
</div></li>

<li><p>
从错误消息中了解到错误号、错误信息、错误描述等信息。甚至更详细的信息可以通过code查阅文档
</p>

<div class="org-src-container">
<pre class="src src-json">{
    "code":10056,
    "message":"Invalid ID",
    "description":"More details"
}
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:158c39ff-9c3e-46e8-aae9-a1aefd6553cd" class="outline-5">
<h5 id="h:158c39ff-9c3e-46e8-aae9-a1aefd6553cd">7.版本</h5>
<div class="outline-text-5" id="text-h:158c39ff-9c3e-46e8-aae9-a1aefd6553cd">
<ul class="org-ul">
<li>强烈要求使用版本、版本号使用简单数字，例如v2。</li>
<li>2种风格
<ol class="org-ol">
<li><code>http://api.xdd.com/v1/posts/10</code> 这种风格会跨域，适合较大的项目</li>
<li><code>http://www.xdd.com/api/v1/posts/10</code></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:c4c86260-2559-4655-8d9e-f636d1505df0" class="outline-5">
<h5 id="h:c4c86260-2559-4655-8d9e-f636d1505df0">8. 返回结果</h5>
<div class="outline-text-5" id="text-h:c4c86260-2559-4655-8d9e-f636d1505df0">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">方法</th>
<th scope="col" class="org-left">路径</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GET</td>
<td class="org-left">/posts</td>
<td class="org-left">返回所有文章的列表</td>
</tr>

<tr>
<td class="org-left">GET</td>
<td class="org-left">/posts/10</td>
<td class="org-left">返回id为10的文章对象</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left">/posts</td>
<td class="org-left">创建更新的文章并返回这个对象</td>
</tr>

<tr>
<td class="org-left">PUT</td>
<td class="org-left">/posts/10</td>
<td class="org-left">更新id为10的文章并返回这个对象</td>
</tr>

<tr>
<td class="org-left">DELETE</td>
<td class="org-left">/posts/10</td>
<td class="org-left">删除id为10的文章返回一个空对象</td>
</tr>

<tr>
<td class="org-left">PATCH</td>
<td class="org-left">/posts/10</td>
<td class="org-left">部分更新id为10的文章数据并返回这个对象</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><b>数据一律采用JSON格式</b></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d4c1ba92-5f0c-4b3a-899f-7873c7cd467a" class="outline-3">
<h3 id="h:d4c1ba92-5f0c-4b3a-899f-7873c7cd467a">注册接口设计和实现</h3>
<div class="outline-text-3" id="text-h:d4c1ba92-5f0c-4b3a-899f-7873c7cd467a">
<p>
[toc]
</p>

<ul class="org-ul">
<li>提供用户注册处理</li>
<li>提供用户登录处理</li>
<li>提供路由配置</li>
</ul>
</div>
<div id="outline-container-h:dfda6f78-6fe5-4735-a5f4-c5b7f812762b" class="outline-4">
<h4 id="h:dfda6f78-6fe5-4735-a5f4-c5b7f812762b">用户注册接口设计</h4>
<div class="outline-text-4" id="text-h:dfda6f78-6fe5-4735-a5f4-c5b7f812762b">
<ul class="org-ul">
<li>接受用户通过Post方法提交的注册信息，提交的数据是JSON格式数据</li>
<li>检查email是否存在与数据库表中，如果存在返回错误状态码，例如4xx,如果不存在，将用户提交的数据存入表中</li>
<li>整个过程都采用AJAX异步过程，用户提交JSON数据，服务端获取数据后处理，返回JSON。</li>
</ul>

<div class="org-src-container">
<pre class="src src-text">POST /users/ &#21019;&#24314;&#29992;&#25143;

&#35831;&#27714;&#20307; application/json
{
    "password":"string",
    "name":"string",
    "email":"string"
}

&#21709;&#24212;
201 &#21019;&#24314;&#25104;&#21151;
400 &#35831;&#27714;&#25968;&#25454;&#38169;&#35823;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1a518a1d-5758-4380-b733-81e81c017706" class="outline-4">
<h4 id="h:1a518a1d-5758-4380-b733-81e81c017706">路由配置</h4>
<div class="outline-text-4" id="text-h:1a518a1d-5758-4380-b733-81e81c017706">
<ul class="org-ul">
<li>为了避免项目中的urls.py条目过多，也为了让应用自己管理路由，采用多级路由</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># djweb/urls.py文件
from django.urls import include
urlpatterns = [
    path('admin/', admin.site.urls),
    re_path(r'^$',index),
    re_path(r'^index$',index),#不同路径可以指向同一个函数执行
    re_path(r'^users/',include("user.urls")),
]
</pre>
</div>

<ul class="org-ul">
<li>include函数参数写*应用.路由模块*,该函数就会动态导入指定的包的模块，从模块里面读取urlpatterns,返回三元组。</li>

<li>url函数第二参数如果不是可调用对象，如果是元组或列表，则会从路径中除去已匹配的部分，将剩余部分与应用中的路由模块的urlpatterns进行匹配。</li>

<li>新建=user/uls.py=文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># user/uls.py
from django.conf.urls import re_path
from .views import reg

urlpatterns = [
    re_path(r'^$',reg), #/users/
]
</pre>
</div>

<ul class="org-ul">
<li>在=user/views.py=文件中添加reg方法</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">user/views.py</span>
<span style="color: #a020f0;">from</span> django.shortcuts <span style="color: #a020f0;">import</span> render
<span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse,HttpRequest

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">reg</span>(request:HttpRequest):
    <span style="color: #a020f0;">return</span> HttpResponse(<span style="color: #8b2252;">"user.reg"</span>)
</pre>
</div>

<ul class="org-ul">
<li>浏览器中输入=<a href="http://127.0.0.1:8000/users/=%E6%B5%8B%E8%AF%95(%E8%BF%99%E6%98%AFGET%E8%AF%B7%E6%B1%82),%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%93%8D%E5%BA%94%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%E4%B8%8B%E9%9D%A2%E5%BC%80%E5%A7%8B%E5%AE%8C%E5%96%84%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0">http://127.0.0.1:8000/users/=%E6%B5%8B%E8%AF%95(%E8%BF%99%E6%98%AFGET%E8%AF%B7%E6%B1%82),%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%93%8D%E5%BA%94%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%E4%B8%8B%E9%9D%A2%E5%BC%80%E5%A7%8B%E5%AE%8C%E5%96%84%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0</a>。</li>
<li>在=user/views.py=中编写*视图函数reg*</li>
</ul>
</div>
</div>
<div id="outline-container-h:d28b5cb8-02b1-4e07-b28e-2d740c16cfd6" class="outline-4">
<h4 id="h:d28b5cb8-02b1-4e07-b28e-2d740c16cfd6">测试JSON数据</h4>
<div class="outline-text-4" id="text-h:d28b5cb8-02b1-4e07-b28e-2d740c16cfd6">
<ul class="org-ul">
<li>使用POST方法，提交数据类型为application/json，json字符串要使用*双引号*。</li>
<li><p>
这个数据是注册用的，由客户端提交。
</p>
<ol class="org-ol">
<li>数据提交模板为：</li>
</ol>

<div class="org-src-container">
<pre class="src src-json">{
    "password":"abc",
    "name":"xdd",
    "email":"xdd@xdd.com"
}
</pre>
</div>

<ol class="org-ol">
<li>可以使用Postman软件测试。</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:f5311f9b-8545-4029-a844-8a6b96ffe528" class="outline-4">
<h4 id="h:f5311f9b-8545-4029-a844-8a6b96ffe528">CSRF处理</h4>
<div class="outline-text-4" id="text-h:f5311f9b-8545-4029-a844-8a6b96ffe528">
<ul class="org-ul">
<li>在Post数据的时候，发现出现了下面的提示
<ol class="org-ol">
<li>原因：*默认Django
CsrfViewMiddleware中间件会对所有POST方法提交的信息做CSRF校验*。</li>
</ol></li>
<li>CSRF或XSRF(Cross-site Request Forgery),即跨站请求伪造。它也被称为：one
click attack/session
riding。是一种对网站的恶意利用。它伪造成来自受信任用户发起的请求，难以防范。</li>
<li>原理： 
<ol class="org-ol">
<li>用户登录某网站A完成登录认证，网站返回敏感信息的Cookie,即使是会话级的Cookie</li>
<li>用户没有关闭浏览器，或认证的Cookie一段时间内不过期还持久化了，用户就访问攻击网站B</li>
<li>攻击网站B看似一切正常，但是某些页面里面有一些隐藏运行的代码，或者诱骗用户操作的按钮等</li>
<li>这些代码一旦运行就是悄悄地向网站A发起特殊请求，由于网站A的Cookie还有效，且访问的是网站A，则其Cookie就可以一并发给网站A</li>
<li>网站A看到这些Cookie就只能认为是登录用户发起的合理合法请求，就会执行</li>
</ol></li>
<li>CSRF解决
<ol class="org-ol">
<li><p>
关闭CSRF中间件(不推荐)
</p>

<div class="org-src-container">
<pre class="src src-py">#djweb/settings.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware', #注释掉
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
</pre>
</div></li>

<li>csrftoken验证

<ul class="org-ul">
<li>在表单POST提交时，需要发给服务器一个csrf_token</li>
<li>模板中的表单Form中增加={% csrf_token %}=，它返回到了浏览器端就会为cookie增加csrftoken字段，还会在表单中增加一个名为csrfiddlewaretoken隐藏控件=&lt;input type='hidden' name='csrfmiddlewaretoken' value='jZTxU0v5mPoLvugcfLbS1B6vT8COYrKuxMzodWv8oNAr3a4ouWlb5AaYG2tQi3dD' /&gt;=</li>
<li>POST提交表单数据时，需要将csrfmiddlewaretoken一并提交，Cookie中的csrf_token也一并会提交，最终在中间件中比较，相符通过，不相符就看到上面的403提示</li>
</ul></li>

<li>双cookie验证

<ul class="org-ul">
<li>访问本站先获得csrftoken的cookie</li>
<li>如果使用AJAX进行POST，需要在每一次请求Header中增加自定义字段X-CSRFTOKEN，其值来自cookie中获取的csrftoken值</li>
<li>在服务端比较cookie和X-CSRFTOKEN中的csrftoken，相符通过</li>
</ul></li>
</ol></li>
<li>现在没有前端代码，为了测试方便，可以选择第一种方法先禁用中间件，测试完成后开启。</li>
</ul>
</div>
</div>
<div id="outline-container-h:40656b8a-5c03-4112-b091-2ffb0a10a251" class="outline-4">
<h4 id="h:40656b8a-5c03-4112-b091-2ffb0a10a251">JSON数据处理</h4>
<div class="outline-text-4" id="text-h:40656b8a-5c03-4112-b091-2ffb0a10a251">
<ul class="org-ul">
<li>simplejson标准库方便好用，功能强大。
<ol class="org-ol">
<li><code>pip install simplejson</code></li>
</ol></li>
<li>浏览器端提交的数据放在了请求对象的body中，需要使用simplejson解析，解析的方式同Json模块，但是simplejson更方便。</li>
</ul>
</div>
</div>
<div id="outline-container-h:ebdf4250-239e-4d66-91a8-70fd5ace2202" class="outline-4">
<h4 id="h:ebdf4250-239e-4d66-91a8-70fd5ace2202">错误处理</h4>
<div class="outline-text-4" id="text-h:ebdf4250-239e-4d66-91a8-70fd5ace2202">
<ul class="org-ul">
<li>Django中有很多异常类，定义在django.http下，这些类都继承自HttpResponse。</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">#user/views.py文件

from django.http import HttpResponse,HttpRequest,HttpResponseBadRequest,JsonResponse
import simplejson

def reg(request:HttpRequest):
    print(request.POST)
    print(request.body)
    # print("- " * 30)
    try:
        payload = simplejson.loads(request.body)
        email = payload['email']
        name = payload['name']
        password = payload["password"]
        print(email,name,password)
        return JsonResponse({},status=201) #创建成功返回201
    except Exception as e: #有任何异常，都返回
        print(e)
        return HttpResponseBadRequest() #这里返回实例，这不是异常类
</pre>
</div>

<ul class="org-ul">
<li>将上面代码增加邮箱检查、用户信息保存功能，就要用到Django的模型操作。</li>
<li>本次采用Restful实践的设计，采用返回错误状态码+JSON错误信息方式。</li>
</ul>
</div>
</div>
<div id="outline-container-h:072b4093-653e-4127-ae38-d10df3504097" class="outline-4">
<h4 id="h:072b4093-653e-4127-ae38-d10df3504097">注册代码 v1</h4>
<div class="outline-text-4" id="text-h:072b4093-653e-4127-ae38-d10df3504097">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">user/views.py&#25991;&#20214;</span>

<span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse,HttpRequest,HttpResponseBadRequest,JsonResponse
<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a020f0;">from</span> .models <span style="color: #a020f0;">import</span> User

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">reg</span>(request:HttpRequest):

    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">payload</span> = simplejson.loads(request.body)
        <span style="color: #a0522d;">email</span> = payload[<span style="color: #8b2252;">'email'</span>]
        <span style="color: #a0522d;">query</span> = User.objects.<span style="color: #483d8b;">filter</span>(email=email)
        <span style="color: #483d8b;">print</span>(query)
        <span style="color: #483d8b;">print</span>(query.query) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;sQL&#35821;&#21477;</span>
        <span style="color: #a020f0;">if</span> query.first():
            <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:<span style="color: #8b2252;">"&#29992;&#25143;&#24050;&#23384;&#22312;"</span>},status=400);

        <span style="color: #a0522d;">name</span> = payload[<span style="color: #8b2252;">'name'</span>]
        <span style="color: #a0522d;">password</span> = payload[<span style="color: #8b2252;">"password"</span>]
        <span style="color: #483d8b;">print</span>(email,name,password)

        <span style="color: #a0522d;">user</span> = User()
        user.<span style="color: #a0522d;">email</span> = email
        user.<span style="color: #a0522d;">name</span> = name
        user.<span style="color: #a0522d;">password</span> = password
        user.save()

        <span style="color: #a020f0;">return</span> JsonResponse({},status=201) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25104;&#21151;&#36820;&#22238;201</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20219;&#20309;&#24322;&#24120;&#65292;&#37117;&#36820;&#22238;</span>
        <span style="color: #483d8b;">print</span>(e)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#36820;&#22238;&#38169;&#35823;&#20449;&#24687;&#21644;400&#65292;&#25152;&#26377;&#20854;&#20182;&#38169;&#35823;&#19968;&#24459;&#29992;&#25143;&#21517;&#23494;&#30721;&#38169;&#35823;</span>
        <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:<span style="color: #8b2252;">"&#29992;&#25143;&#21517;&#25110;&#23494;&#30721;&#38169;&#35823;"</span>},status=400)
</pre>
</div>

<ol class="org-ol">
<li><b>邮箱检查</b>
<ul class="org-ul">
<li>邮箱检查需要查user表，需要使用filter方法。</li>
<li>email=email,前面是字段名email，后面是email变量。查询后返回结果，如果查询有结果，则说明该email已经存在，邮箱已经注册，返回400到前端</li>
</ul></li>
<li><b>用户信息存储</b>
<ul class="org-ul">
<li>创建User类实例，属性存储数据，最后调用save方法。Django默认是在save()、delete()的时候事务*自动提交*。</li>
<li>如果提交抛出任何错误，则捕获此异常做相应处理。</li>
<li>如果没有异常，则返回201，不要返回任何用户信息。之后可能需要验证、用户登录等操作。<br></li>
</ul></li>
<li><b>异常处理</b>
<ul class="org-ul">
<li>出现获取输入框提交信息异常，就返回400</li>
<li>查询邮箱存在，返回400</li>
<li>save()方法保存数据，有异常，则返回400</li>
<li>注意一点，Django的异常类继承自HttpResponse类，所以不能raise,只能return</li>
<li>前端通过状态码判断是否成功</li>
<li>由于采用Restful实战，所有异常全部返回JSON的错误信息，所以一律使用了JsonResponse</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:1c3fa3d6-39ca-4a00-ad25-05029416bb65" class="outline-4">
<h4 id="h:1c3fa3d6-39ca-4a00-ad25-05029416bb65">Django日志</h4>
<div class="outline-text-4" id="text-h:1c3fa3d6-39ca-4a00-ad25-05029416bb65">
<ul class="org-ul">
<li>Django的日志配置在settings.py中
<ol class="org-ol">
<li>参考文档<a href="https://docs.djangoproject.com/en/2.2/topics/logging/#configuring-logging">https://docs.djangoproject.com/en/2.2/topics/logging/#configuring-logging</a></li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-py">LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'level': "DEBUG",
        },
    },
}
</pre>
</div>

<ul class="org-ul">
<li>配置后，就可以在控制台看到执行的SQL语句。</li>
<li>注意，必须*DEBUG=True,同时level是DEBUG*,否则从控制台看不到SQL语句。</li>
</ul>
</div>
</div>
<div id="outline-container-h:17cfb619-7269-462b-9679-1b8a3d9bb8c7" class="outline-4">
<h4 id="h:17cfb619-7269-462b-9679-1b8a3d9bb8c7">模型操作</h4>
<div class="outline-text-4" id="text-h:17cfb619-7269-462b-9679-1b8a3d9bb8c7">
</div>
<div id="outline-container-h:2544a594-26d4-45ab-aafd-61d119abfb14" class="outline-5">
<h5 id="h:2544a594-26d4-45ab-aafd-61d119abfb14">管理器对象</h5>
<div class="outline-text-5" id="text-h:2544a594-26d4-45ab-aafd-61d119abfb14">
<ul class="org-ul">
<li>Django会为模型类提供一个*objects对象*，它是django.db.models.manager.Manager类型，用于与数据库交互。当定义模型类的时候没有指定管理器，则Django会为模型类提供一个objects的管理器。</li>

<li>如果在模型类中手动指定管理器后，Django不再提供默认的objects的管理器了。</li>

<li>管理器是Django的模型进行数据库*查询*操作的接口，Django应用的每个模型都至少拥有一个管理器。</li>

<li><b>Django ORM</b>

<ol class="org-ol">
<li>数据的校验validation是在对象的Save、update方法上</li>
<li>对模型对象的CRUD,被Django ORM转换成相应的SQL语句操作不同的数据源。</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:472308d4-65c6-467f-afd1-742d5670f43e" class="outline-5">
<h5 id="h:472308d4-65c6-467f-afd1-742d5670f43e">查询</h5>
<div class="outline-text-5" id="text-h:472308d4-65c6-467f-afd1-742d5670f43e">
<ul class="org-ul">
<li><b>查询集</b>
<ol class="org-ol">
<li>查询会返回结果的集，它是django.db.models.query.QuerySet类型。</li>
<li>它是惰性求值，和sqlalchemy一样。结果就是查询的集。</li>
<li>它是可迭代对象。</li>
</ol></li>

<li><b>惰性求值</b>
<ul class="org-ul">
<li>创建查询集不会带来任何数据库的访问，直到调用方法使用数据时，才会访问数据库。在迭代、序列化、if语句中都会立即求值。</li>
</ul></li>
<li><b>缓存：</b>
<ul class="org-ul">
<li>每一个查询集都包含一个缓存，来最小化对数据库的访问。</li>
<li>新建查询集，缓存为空。首次对查询集求值时，会发生数据库查询，Django会把查询的结果存在这个缓存中，并返回请求的结果，接下来对查询集求值将使用缓存的结果。<br></li>
<li>观察下面的2个例子是要看真正生成的语句了
<ol class="org-ol">
<li><p>
没有使用缓存，每次都要去查库，查了2次库
</p>

<div class="org-src-container">
<pre class="src src-py">[user.name for user in User.objects.all()]
[user.name for user in User.objects.all()]
</pre>
</div></li>

<li><p>
下面的语句使用缓存，因为使用同一个结果集
</p>

<div class="org-src-container">
<pre class="src src-py">qs = User.objects.all()
[user.name for user in qs]
[user.name for user in qs]
</pre>
</div></li>
</ol></li>
</ul></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:1f26061f-ed09-40d1-912d-d285a4ba8638"></a>限制查询集(切片)<br>
<div class="outline-text-6" id="text-h:1f26061f-ed09-40d1-912d-d285a4ba8638">
<ul class="org-ul">
<li>查询集对象可以直接使用索引下标的方式(不支持负索引)，相当于SQL语句中的limit和offset子句。</li>
<li>注意使用索引返回的新的结果集，依然是惰性求值，不会立即查询。</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">qs = User.objects.all()[20:40]
# LIMIT 20 OFFSET 20
qs = User.objects.all()[20:30]
# LIMIT 10 OFFSET 20
</pre>
</div>
</div>
</li>
<li><a id="h:5fd198d8-3663-492c-8c6f-0b7fbd60e729"></a>过滤器<br>
<div class="outline-text-6" id="text-h:5fd198d8-3663-492c-8c6f-0b7fbd60e729">
<ol class="org-ol">
<li>返回*查询集*的方法，称为过滤器，如下：</li>
</ol>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">all()</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">filter()</td>
<td class="org-left">过滤，返回满足条件的数据</td>
</tr>

<tr>
<td class="org-left">exclude()</td>
<td class="org-left">排除，排除满足条件的数据</td>
</tr>

<tr>
<td class="org-left">order_by()</td>
<td class="org-left">排序，注意参数是字符串</td>
</tr>

<tr>
<td class="org-left">values()</td>
<td class="org-left">返回一个对象字典的列表，列表的元素是字典，字典内是字段和值的键值对</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><code>filter(k1=v1).filter(k2=v2)=等价于=filter(k1=v1,k2=v2)</code></li>
<li><code>filter(pk=10)=这里pk指的就是主键，不用关心主键字段名，当然也可以使用主键名=filter(emp_no=10)</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-py">mgr = User.objects
print(mgr.all())
print(mgr.values())
print(mgr.filter(pk=1).values())
print(mgr.exclude(pk=4))
print(mgr.exclude(id=1).values())
print(mgr.exclude(id=6).order_by("-id"))
print(mgr.exclude(id=6).order_by("-id").values())
print(mgr.exclude(id=6).values().order_by("-pk"))
</pre>
</div>

<ul class="org-ul">
<li>返回*单个值*的方法</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">get()</td>
<td class="org-left">仅返回单个满足条件的对象如果未能返回对象则抛出DoesNotExist异常；如果能返回多条，抛出MultipleObjectsReturned异常</td>
</tr>

<tr>
<td class="org-left">count()</td>
<td class="org-left">返回当前查询的总条数</td>
</tr>

<tr>
<td class="org-left">first()</td>
<td class="org-left">返回第一个对象</td>
</tr>

<tr>
<td class="org-left">last()</td>
<td class="org-left">返回最后一个对象</td>
</tr>

<tr>
<td class="org-left">exit()</td>
<td class="org-left">判断查询集中是否有数据，如果有则返回True</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-py">email = "xdd@xdd.com"
mgr = User.objects
print(mgr.get(pk=4)) #使用主键查询
print(mgr.get(email=email)) #只能返回一个结果
print(mgr.filter(id=1).get())

print(mgr.first()) #使用limit 1查询，返回实例或None
print(mgr.filter(pk=4,email=email).first()) # and条件
</pre>
</div>
</div>
</li>
<li><a id="h:7a82239d-d366-46f1-9b2e-e5eaac64500f"></a>字段查询(Field Lookup)表达式<br>
<div class="outline-text-6" id="text-h:7a82239d-d366-46f1-9b2e-e5eaac64500f">
<ul class="org-ul">
<li>字段查询表达式可以作为filter(),exclude(),get()的参数，实现where子句。</li>
<li>语法：=属性名称__比较运算符=值=</li>
<li>注意：属性名和运算符之间使用*双下划线*</li>
<li>比较运算符如下</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">举例</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>exact</code></td>
<td class="org-left"><code>filter(isdeleted=False)==filter(isdeleted__exact=False)</code></td>
<td class="org-left">严格等于，可省略不写</td>
</tr>

<tr>
<td class="org-left"><code>contains</code></td>
<td class="org-left"><code>exclude(title__contains</code>"天")=</td>
<td class="org-left">是否包含，大小写敏感，等价于=like '%天%'=</td>
</tr>

<tr>
<td class="org-left"><code>statswith==endswith</code></td>
<td class="org-left"><code>filter(title__startswith</code>'天')=</td>
<td class="org-left">以什么开头或结尾，大小写敏感</td>
</tr>

<tr>
<td class="org-left"><code>isnull==isnotnull</code></td>
<td class="org-left"><code>filter(title__isnull=False)</code></td>
<td class="org-left">是否为null</td>
</tr>

<tr>
<td class="org-left"><code>iexact==icontains==istartswith==iendswith</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">i的意思是忽略大小写</td>
</tr>

<tr>
<td class="org-left"><code>in</code></td>
<td class="org-left"><code>filter(pk__in</code>[1,2,3,100])=</td>
<td class="org-left">是否在指定范围数据中</td>
</tr>

<tr>
<td class="org-left"><code>gt</code>,=gte=,=lt=,=lte=</td>
<td class="org-left"><code>filter(id__get=3)==filter(pk__lte=6)==filter(pub_date__get=date(2000,1,1))</code></td>
<td class="org-left">大于，小于等</td>
</tr>

<tr>
<td class="org-left"><code>year、month、day==week_day==hour、minute==second</code></td>
<td class="org-left"><code>filter(pub_date__year=2000)</code></td>
<td class="org-left">对日期类型属性处理</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-py">mgr = User.objects
print(mgr.filter(id__exact=4))
print(mgr.filter(email__contains='xdd'))
print(mgr.filter(email__istartswith='xdda'))
print(mgr.filter(id__in=[1,4]))
print(mgr.filter(id__gt=3))
</pre>
</div>
</div>
</li>
<li><a id="h:3484d442-3614-4cf8-bded-b0e09a9f2867"></a>Q对象<br>
<div class="outline-text-6" id="text-h:3484d442-3614-4cf8-bded-b0e09a9f2867">
<ul class="org-ul">
<li>虽然Django提供传入条件的方式，但是不方便，它还提供了Q对象来解决。</li>
<li>Q对象是django.db.models.Q,可以使用=&amp;、|=操作符来组成逻辑表达式。=~=表示not。</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from django.db.models import Q
mgr = User.objects
print(mgr.filter(Q(pk__lt=6))) #不如直接写filter(pk__lt=6)

print(mgr.filter(pk__lt=6).filter(pk__gt=1)) #与
print(mgr.filter(Q(pk__lt=6) &amp; Q(pk__gt=1))) #与
print(mgr.filter(Q(pk=4) | Q(pk=1))) #或
print(mgr.filter(~Q(pk__lt=6))) #非
</pre>
</div>

<ul class="org-ul">
<li>可使用=&amp;|=和Q对象来构造复杂的逻辑表达式</li>
<li>过滤器函数可以使用一个或多个Q对象</li>
<li>如果混用关键字参数和Q对象，那么Q对象必须位于关键字参数的面前。所有参数都将and和一起</li>
</ul>
</div>
</li>
<li><a id="h:a81faed5-790a-4a1b-8d2a-22cb4a906da8"></a>新增、更新、删除方法<br>
<div class="outline-text-6" id="text-h:a81faed5-790a-4a1b-8d2a-22cb4a906da8">
<ul class="org-ul">
<li>更新数据</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">user = User(email='test3',name='test3') #没有主键
user.save() #会新建一个数据

user = User(id=100,email='test4',name='test4') #有自增主键，如果不存在，则是插入
user.save()
user = User(id=100,email='test4',name='test4') # 有自增主键，如果存在，则是更新
user.save()
</pre>
</div>

<ul class="org-ul">
<li>update在查询集上同时更新数据</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 更新所有查询的结果
User.objects.filter(id__get=4).update(password='xyz') #将pk大于4的查询结果更新，所有用户的密码修改
</pre>
</div>

<ul class="org-ul">
<li>delete删除查询集数据</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">ret = User.objects.filter(id__gt=4).delete()
print(ret)

# 运行结果
# DELETE FROM `user` WHERE `user`.`id` &gt; 4 ; args=(4,)
# (3,{"user.User":3})
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:79d9aeb6-6538-4b1a-80cf-0441d3b155fe" class="outline-4">
<h4 id="h:79d9aeb6-6538-4b1a-80cf-0441d3b155fe">注册接口设计完善</h4>
<div class="outline-text-4" id="text-h:79d9aeb6-6538-4b1a-80cf-0441d3b155fe">
<ul class="org-ul">
<li>*认证*：HTTP协议是无状态协议，为了解决它产生了cookie和session技术。</li>
<li><b>传统的session-cookie机制</b>
<ol class="org-ol">
<li>浏览器发起第一次请求到服务器，服务器发现浏览器没有提供session
id,就认为这是第一次请求，会返回一个新的session
id给浏览器，浏览器只要不关闭，这个session
id就会随着每一次请求重新发给服务端，服务器端查找这个session
id，如果查到，就认为是同一个会话。如果没有查到，就认为是新的请求。</li>
<li>session是会话级的，服务端还可以在这个会话session中创建很多数据session键值对。</li>
<li>这个session
id有过期的机制，一段时间如果没有发起请求，认为用户已经断开，服务端就清除本次会话所有session。浏览器端也会清除相应的cookie信息。</li>
<li>服务端保存着大量session信息，很消耗服务器内存，而且如果多服务器部署，可以考虑session复制集群，也可以考虑session共享的问题，比如redis、memcached等方案。</li>
</ol></li>
<li><b>无ssession方案</b>
<ol class="org-ol">
<li>既然服务端就是需要一个ID来表示身份，那么不使用session也可以创建一个ID返回给客户端。但是，要保证客户端不可篡改该信息。</li>
<li>服务端生成一个标识，并使用某种算法对标识签名。</li>
<li>服务端收到客户端发来的标识，需要检查签名。</li>
<li>这种方案的缺点是，加密、解密需要消耗CPU计算资源，无法让浏览器自己主动检查过期的数据以清除。这种技术称作JWT(json
WEB Token)。</li>
</ol></li>
<li><p>
<b>JWT</b>
</p>
<ol class="org-ol">
<li>JWT(Json WEB
Token)是一种采用Json方式安装传输信息的方式。本次使用PyJWT，它是Python对JWT的实现。
<ul class="org-ul">
<li>包<a href="https://pypi.org/project/PyJWT/1.5.3/">https://pypi.org/project/PyJWT/1.5.3/</a></li>
<li>文档<a href="https://pyjwt.readthedocs.io/en/latest/">https://pyjwt.readthedocs.io/en/latest/</a></li>
</ul></li>
<li>安装=pip install pyjwt=</li>
<li>jwt原理</li>
</ol>

<div class="org-src-container">
<pre class="src src-py">import jwt
import base64

key = "secret"
token = jwt.encode({'payload':'abc123'},key,'HS256')
print(token)
print(jwt.decode(token,key,algorithms=["HS256"]))
# b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJwYXlsb2FkIjoiYWJjMTIzIn0.lZc1PBGdbYDKq9k43tNTt1f0MHy4DjwT8NGTnHEIaVE'
# token分为3部分，用.断开

header,payload,signature = token.split(b'.')
print("- "*30)
print(header,payload,signature,sep='\n')
print("- "*30)

def addeq(b:bytes):
    """ 为base64编码补齐等号"""
    rest = 4 - len(b) % 4
    return b + b'='* rest

print("header=",base64.urlsafe_b64decode(addeq(header)))
print("payload=",base64.urlsafe_b64decode(addeq(payload)))
print("signature=",base64.urlsafe_b64decode(addeq(signature)))
print(" ="*30)

# 根据jwt算法，重新生成签名
# 1 获取算法对象
from jwt import algorithms
alg = algorithms.get_default_algorithms()["HS256"]
newkey = alg.prepare_key(key) # key 为secret

# 2获取前两部分 header.payload
signing_input,_,_ = token.rpartition(b".")
print(signing_input)


# 3使用key签名
signature = alg.sign(signing_input,newkey)
print("--------------")
print(signature)
print(base64.urlsafe_b64encode(signature))
</pre>
</div></li>
</ul>


<ol class="org-ol">
<li>由此，可知jwt生成的token分为三部分
<ol class="org-ol">
<li>header,由数据类型、加密算法构成</li>
<li>payload,负载就是要传输的数据，一般来说放入python对象即可，会被json序列化的</li>
<li>signature,签名部分。是签名2部分数据分别base64编码后使用点号链接后，加密算法使用key计算好一个结果，再被base64编码，得到签名</li>

<li>所有数据都是明文传输的，只是做了base64，如果是敏感信息，请不要使用jwt。</li>
<li>数据签名的目的不是为了隐藏数据，而是保证数据不被篡改。如果数据篡改了，发回到服务器端，服务器使用自己的key再计算一遍，然后进行签名比对，一定对不上签名。</li>
</ol></li>
<li>jwt使用场景
<ul class="org-ul">
<li>认证：这是jwt最常用的场景，一旦用户登录成功，就会得到wt，然后请求中就可以带上这个jwt。服务器中jwt验证通过，就可以被允许访问资源。甚至可以在不同域名中传递，在单点登录(Single
Sign On)中应用广泛。</li>
<li>数据交换：jwt可以防止数据被篡改，它还可以使用公钥、私钥加密，确保请求的发送者是可信的</li>
</ul></li>
</ol>
<ul class="org-ul">
<li><b>密码</b>
<ol class="org-ol">
<li>使用邮箱+密码方式登录。</li>
<li>邮箱要求唯一就行了，但是，密码存储需要加密。早期，都是用明文的密码存储。后来，使用MD5存储，但是，目前也不安全，网上有很多MD5的网站，使用反查方式找到密码。</li>
<li>*加盐*，使用hash(password+salt)的结果存入数据库中，就算拿到数据库的密码反查，也没有用了。如果是固定加盐，还是容易被找到规律，或者从源码中泄露。随机加盐，每一次盐都变，就增加了破解的难度。</li>
<li>*暴力破解*：什么密码都不能保证不被暴力破解，例如穷举。所以要使用慢hash算法，例如bcrypt，就会让每一次计算都很慢，都是秒即的，这样穷举的时间就会很长，为了一个密码破解的时间在当前CPU或者GPU的计算能力下可能需要几十年以上。</li>
</ol></li>
<li><p>
<b>bcrypt</b>
</p>
<ol class="org-ol">
<li>安装=pip install bcrypt=</li>
</ol>

<div class="org-src-container">
<pre class="src src-py">import bcrypt
import datetime

password = b'12345xdd'

# 每次拿到盐都不一样
print(1,bcrypt.gensalt())
print(2,bcrypt.gensalt())

salt = bcrypt.gensalt()
# 拿到的盐不同，计算等到的密文相同
print("===============same salt ===============")
x = bcrypt.hashpw(password,salt)
y = bcrypt.hashpw(password,salt)
print(3,x)
print(4,y)

# 每次拿到的盐不同，计算生成的密文也不一样
print("============different salt===============")
xx = bcrypt.hashpw(password,bcrypt.gensalt())
yy = bcrypt.hashpw(password,bcrypt.gensalt())
print(5,x)
print(6,y)

# 校验
print(bcrypt.checkpw(password,xx),len(xx))
print(bcrypt.checkpw(password+b' ',xx),len(xx))

# 计算时长
start = datetime.datetime.now()
y3 = bcrypt.hashpw(password,bcrypt.gensalt())
delta = (datetime.datetime.now() - start).total_seconds()
print(10,'duration={}'.format(delta))

# 检验时长
start = datetime.datetime.now()
y4 = bcrypt.checkpw(password,xx)
delta = (datetime.datetime.now() - start).total_seconds()
print(y4)
print(11,'duration={}'.format(delta))

start = datetime.datetime.now()
y5 = bcrypt.checkpw(b'1',xx)
delta = (datetime.datetime.now() - start).total_seconds()
print(y5)
print(12,'duration={}'.format(delta))
</pre>
</div></li>
</ul>


<ol class="org-ol">
<li>从耗时看出，bcrypt加密、验证非常耗时，所有如果穷举，非常耗时。而且碰巧攻破一个密码，由于盐不一样，还等穷举另一个。</li>
</ol>

<div class="org-src-container">
<pre class="src src-txt">salt=b'$2b$12$jwBD7mg9stvIPydF2bqoPO'
b'$2b$12$jwBD7mg9stvIPydF2bqoPOodPwWYVvdmZb5uWWuWvlf9iHqNlKSQO'

$是分隔符
$2b$，加密算法
12，表示2^12 key expansion rounds
这是盐b'jwBD7mg9stvIPydF2bqoPO'，22个字符，Base64
这是密文b'odPwWYVvdmZb5uWWuWvlf9iHqNlKSQO'，31个字符，Base64
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d02ec722-cab8-4256-af8b-410127950a20" class="outline-4">
<h4 id="h:d02ec722-cab8-4256-af8b-410127950a20">注册代码 v2</h4>
<div class="outline-text-4" id="text-h:d02ec722-cab8-4256-af8b-410127950a20">
<ol class="org-ol">
<li><p>
全局变量
</p>
<ul class="org-ul">
<li>项目的settings.py文件实际上就是全局变量的配置 文件。</li>
<li>SECRET_KEY一个强KEY</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from django.conf import settings
print(settings.SECRET_KEY)
</pre>
</div></li>

<li>使用jwt和bcrypt,修改注册代码</li>
</ol>

<div class="org-src-container">
<pre class="src src-py">from django.http import HttpResponse,HttpRequest,HttpResponseBadRequest,JsonResponse
import simplejson
from .models import User
import jwt
import datetime
import bcrypt
from django.conf import settings

# 对id签名
def gen_token(user_id):
    # 时间戳用来判断是否过期，以便重发token或重新登录
    return  jwt.encode({
        "user_id":user_id,
        "timestamp":int(datetime.datetime.now().timestamp()) #取整
    },settings.SECRET_KEY).decode()

def reg(request:HttpRequest):

    try:
        payload = simplejson.loads(request.body)
        email = payload['email']
        query = User.objects.filter(email=email)
        print(query)
        print(query.query) #查看sQL语句
        if query.first():
            return JsonResponse({"error":"用户已存在"},status=400);

        name = payload['name']
        password = payload["password"].encode()
        print(email,name,password)

        # 密码加密
        password = bcrypt.hashpw(password,bcrypt.gensalt()).decode()
        print(password)

        user = User()
        user.email = email
        user.name = name
        user.password = password
        user.save()

        return JsonResponse({"token":gen_token(user.id)},status=201) #创建成功返回201
    except Exception as e: #有任何异常，都返回
        print(e)
        # 失败返回错误信息和400，所有其他错误一律用户名密码错误
        return JsonResponse({"error":"用户名或密码错误"},status=400)
</pre>
</div>

<ul class="org-ul">
<li>save方法会自动提交事务</li>
</ul>


<ul class="org-ul">
<li>数据库中内容</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:6329a26b-e608-496a-9981-bf28deb4b20f" class="outline-3">
<h3 id="h:6329a26b-e608-496a-9981-bf28deb4b20f">登录接口设计和实现</h3>
<div class="outline-text-3" id="text-h:6329a26b-e608-496a-9981-bf28deb4b20f">
<p>
[toc]
</p>

<ul class="org-ul">
<li>提供用户注册处理</li>
<li>提供用户登录处理</li>
<li>提供路由配置</li>
</ul>
</div>
<div id="outline-container-h:899060e4-25d5-456f-a443-2106b8113684" class="outline-4">
<h4 id="h:899060e4-25d5-456f-a443-2106b8113684">用户登录接口设计</h4>
<div class="outline-text-4" id="text-h:899060e4-25d5-456f-a443-2106b8113684">
<div class="org-src-container">
<pre class="src src-txt">POST /users/login 用户登录
请求体 application/json
{
    "password":"string",
    "email":"string"
}

响应
200 登录成功
400 用户名密码错误
</pre>
</div>

<ul class="org-ul">
<li>接收用户通过POST方法提交的登录信息，提交的数据是JSON格式数据</li>
</ul>

<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #8b2252;">"password"</span>:<span style="color: #8b2252;">"abc"</span>,
    <span style="color: #8b2252;">"email"</span>:<span style="color: #8b2252;">"xdd@xdd.com"</span>
}
</pre>
</div>

<ul class="org-ul">
<li>从user表中email找出匹配的一条记录，验证密码是否正确</li>
<li>验证通过说明是合法用户登录，显示欢迎页面。</li>
<li>验证失败返回错误状态码，例如4xx</li>
<li>整个过程都采用AJAX异步过程，用户提交JSON数据，服务端获取数据后处理，返回JSON。</li>
</ul>
</div>
</div>
<div id="outline-container-h:56e75baa-0b75-46df-9cdc-c26ec2d8879d" class="outline-4">
<h4 id="h:56e75baa-0b75-46df-9cdc-c26ec2d8879d">路由配置</h4>
<div class="outline-text-4" id="text-h:56e75baa-0b75-46df-9cdc-c26ec2d8879d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;user/urls.py&#25991;&#20214;</span>
<span style="color: #a020f0;">from</span> django.conf.urls <span style="color: #a020f0;">import</span> re_path
<span style="color: #a020f0;">from</span> .views <span style="color: #a020f0;">import</span> reg,login

<span style="color: #a0522d;">urlpatterns</span> = [
    re_path(r<span style="color: #8b2252;">'^$'</span>,reg), <span style="color: #b22222;">#</span><span style="color: #b22222;">/users/</span>
    re_path(r<span style="color: #8b2252;">'^login$'</span>,login),
]
</pre>
</div>

<ul class="org-ul">
<li>在user/views.py文件中实现登录代码</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">user/views.py&#25991;&#20214;&#20013;&#22686;&#21152;&#22914;&#19979;&#20195;&#30721;</span>

<span style="color: #a020f0;">import</span> jwt
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> bcrypt
<span style="color: #a020f0;">from</span> django.conf <span style="color: #a020f0;">import</span> settings

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31579;&#36873;&#25152;&#38656;&#35201;&#30340;&#23383;&#27573;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">jsonify</span>(instance,allow=<span style="color: #008b8b;">None</span>,exclude=[]):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">allow&#20248;&#20808;&#65292;&#22914;&#26524;&#26377;&#65292;&#23601;&#20351;&#29992;allow&#25351;&#23450;&#30340;&#23383;&#27573;&#65292;&#36825;&#26102;&#20505;exclude&#26080;&#25928;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">allow&#22914;&#26524;&#20026;&#31354;&#65292;&#23601;&#20840;&#20307;&#65292;&#20294;&#35201;&#30475;&#30475;&#26377;exclude&#20013;&#30340;&#35201;&#25490;&#38500;</span>
    <span style="color: #a0522d;">modelcls</span> = <span style="color: #483d8b;">type</span>(instance)
    <span style="color: #a020f0;">if</span> allow:
        <span style="color: #a0522d;">fn</span> = (<span style="color: #a020f0;">lambda</span> x:x.name <span style="color: #a020f0;">in</span> allow)
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">fn</span> = (<span style="color: #a020f0;">lambda</span> x:x.name <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> exclude)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">from django.db.models.options import Options</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">m:Options = modelcls._meta</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(m.fields,m.pk)</span>
    <span style="color: #a020f0;">return</span> {k.name:<span style="color: #483d8b;">getattr</span>(instance,k.name) <span style="color: #a020f0;">for</span> k <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">filter</span>(fn,modelcls._meta.fields)}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30331;&#24405;&#25509;&#21475;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">login</span>(request:HttpRequest):
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">payload</span> = simplejson.loads(request.body)
        <span style="color: #483d8b;">print</span>(payload)
        <span style="color: #a0522d;">email</span> = payload[<span style="color: #8b2252;">"email"</span>]
        <span style="color: #a0522d;">password</span> = payload[<span style="color: #8b2252;">"password"</span>]

        <span style="color: #a0522d;">user</span> = User.objects.get(email=email) <span style="color: #b22222;"># </span><span style="color: #b22222;">only one</span>
        <span style="color: #483d8b;">print</span>(user.password)

        <span style="color: #a020f0;">if</span> bcrypt.checkpw(password,user.password.encode()):
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;&#25104;&#21151;</span>
            <span style="color: #a0522d;">token</span> = gen_token(user.<span style="color: #483d8b;">id</span>)

            <span style="color: #a0522d;">res</span> = JsonResponse({
                <span style="color: #8b2252;">"user"</span>:jsonify(user,exclude=[<span style="color: #8b2252;">"password"</span>]),
                <span style="color: #8b2252;">"token"</span>:token
            }) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;200</span>
            res.set_cookie(<span style="color: #8b2252;">"jwt"</span>,token)
            <span style="color: #a020f0;">return</span> res
        <span style="color: #a020f0;">else</span>:
            <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:<span style="color: #8b2252;">"&#29992;&#25143;&#21517;&#25110;&#23494;&#30721;&#38169;&#35823;"</span>},status=400)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(e)
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22833;&#36133;&#36820;&#22238;&#38169;&#35823;&#20449;&#24687;&#21644;400&#65292;&#25152;&#26377;&#20854;&#20182;&#38169;&#35823;&#19968;&#24459;&#29992;&#25143;&#21517;&#23494;&#30721;&#38169;&#35823;</span>
        <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:<span style="color: #8b2252;">"&#29992;&#25143;&#21517;&#25110;&#23494;&#30721;&#38169;&#35823;"</span>},status=400)
</pre>
</div>

<ul class="org-ul">
<li>注册</li>
<li>登录验证</li>
</ul>
</div>
</div>
<div id="outline-container-h:d094d52b-bafd-4b39-a2cc-391bcc4c0022" class="outline-4">
<h4 id="h:d094d52b-bafd-4b39-a2cc-391bcc4c0022">认证接口</h4>
<div class="outline-text-4" id="text-h:d094d52b-bafd-4b39-a2cc-391bcc4c0022">
<ul class="org-ul">
<li>如何获取浏览器提交的token信息？
<ol class="org-ol">
<li>使用Header中的Authorization
<ul class="org-ul">
<li>通过这个header增加token信息。</li>
<li>通过header发送数据，方法可以是Post、Get</li>
</ul></li>
<li>自定义header
<ul class="org-ul">
<li>在Http请求头中使用X-JWT字段来发送token</li>
</ul></li>
</ol></li>
<li>本次选择第二种</li>
</ul>
</div>
<div id="outline-container-h:a7285988-9465-4e51-99a3-3393535c6749" class="outline-5">
<h5 id="h:a7285988-9465-4e51-99a3-3393535c6749">认证流程</h5>
<div class="outline-text-5" id="text-h:a7285988-9465-4e51-99a3-3393535c6749">
<ul class="org-ul">
<li>基本上所有的业务都有需要认证用户的信息。</li>
<li>在这里比较实际戳，如果过期，就直接抛未认证成功401，客户端收到后就改直接跳转到登录页。</li>
<li>如果没有提交user id，就直接重新登录。如果用户查到了，填充user对象。</li>
<li>request-&gt;时间戳比较-&gt;user id比较-&gt;向后执行</li>
</ul>
</div>
</div>
<div id="outline-container-h:fcbe48ab-9ee9-4b74-b304-3c5525d97c4f" class="outline-5">
<h5 id="h:fcbe48ab-9ee9-4b74-b304-3c5525d97c4f">Django的认证</h5>
<div class="outline-text-5" id="text-h:fcbe48ab-9ee9-4b74-b304-3c5525d97c4f">
<ul class="org-ul">
<li>django.contrilb。auth中提供了许多方法，这里主要介绍其中的三个：
<ol class="org-ol">
<li>authenticate(**credentials)
<ul class="org-ul">
<li>提供了用户认证，即验证用户名以及密码是否正确</li>
<li>user = authentica(username='someone',password='somepassword')</li>
</ul></li>
<li>login(HttpRequest,user,backend=None)
<ul class="org-ul">
<li>该函数接受一个HttpRequest对象，以及一个认证了的User对象</li>
<li>此函数使用django的session框架给某个已认证的用户附加上session
id等信息。</li>
</ul></li>
<li>logout(request)
<ul class="org-ul">
<li>注销用户</li>
<li>该函数接受一个HttpRequest对象，无返回值。</li>
<li>当调用该函数时，当前请求的session信息会全部清除</li>
<li>该用户即使没有登录，使用该函数也不会报错</li>
<li>还提供了一个装饰器来判断是否登录django.contrib.auth.decorators.login_required</li>
<li>本项目使用了无session机制，且用户信息自己建表管理，所以，认证需要自己实现。</li>
</ul></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:964b4cb1-25b3-449b-b48e-e638bda86f53" class="outline-5">
<h5 id="h:964b4cb1-25b3-449b-b48e-e638bda86f53">中间件技术Middleware</h5>
<div class="outline-text-5" id="text-h:964b4cb1-25b3-449b-b48e-e638bda86f53">
<ol class="org-ol">
<li>官方定义，在Django的request和response处理过程中，由框架提供的hook钩子</li>
<li>中间技术在1.10后发生了改变，我们当前使用1.11版本，可以使用新的方式定义。</li>
<li>参考<a href="https://docs.djangoproject.com/en/1.11/topics/http/middleware/#writing-your-own-middleware">https://docs.djangoproject.com/en/1.11/topics/http/middleware/#writing-your-own-middleware</a></li>

<li><b>原理</b></li>
</ol>

<div class="org-src-container">
<pre class="src src-py"># 测试代码添加在user/views.py

class SimpleMiddleware1:
    def __init__(self,get_response):
        self.get_response = get_response
        # One-time configuration and initialization.

    def __call__(self,request):
        # Conde to be executed for each request before
        # the view (and later middleware) are called.
        print(1,'- '*30)
        print(isinstance(request,HttpRequest))
        print(request.GET)
        print(request.POST)
        print(request.body)

        # 之前相当于老板本的process_request
        #return HttpResponse(b'',status = 404)

        response = self.get_response(request)

        #Code to be executed for each request/response after
        #the view is called.
        print(101,'- '* 30)
        return  response

    def process_view(self,request,view_func,view_args,view_kwargs):
        print(2,"-" * 30)
        print(view_func.__name__,view_args,view_kwargs)
        # 观察view_func名字，说明在process_request之后,process_view之前已经做好了路径映射
        return  None # 继续执行其他的process_view或view
        # return HttpResponse("111",status=201)

class SimpleMiddleware2:
    def __init__(self,get_response):
        self.get_response = get_response
        # One-time configuration and initialization.

    def __call__(self, request):
        # Conde to be executed for each request before
        # the view (and later middleware) are called.
        print(3,"-" * 30)
        # return HttpResponse(b'',status=404)
        response = self.get_response(request)

        # Code to be executed for each request/response after
        # the view is called.
        print(102,"- "* 30)
        return response

    def process_view(self,request,view_func,view_args,view_kwargs):
        print(4,"- "* 30)
        print(view_func,__name__,view_args,view_kwargs)
        # return None #继续执行其他的process_view或view
        return HttpResponse("2222",status=201)
</pre>
</div>

<ul class="org-ul">
<li>修改=djweb/settings.py=文件，添加消息中间件</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 修改djweb/settings.py文件，添加消息中间件

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    # 'django.middleware.csrf.CsrfViewMiddleware', #注释掉
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'user.views.SimpleMiddleware1',
    'user.views.SimpleMiddleware2',
]
</pre>
</div>

<ul class="org-ul">
<li>运行结果(使用浏览器访问web)</li>
<li>流程图</li>
<li>结论
<ol class="org-ol">
<li>Django中间件使用的洋葱式，但有特殊的地方</li>
<li>新版本中间件现在=__call__=中get_response(request)之前代码(相当于老版本中的process_request)</li>
<li>settings中的顺序先后执行所有中间件的get_response(request)之前代码</li>
<li>全部执行完解析路径映射得到view_func</li>
<li>settings中顺序先后执行process_view部分
<ul class="org-ul">
<li>return None 继续向后执行</li>
<li>return HttpResponse()
就不在执行其他函数的preview函数了，此函数返回值作为浏览器端的响应</li>
</ul></li>
<li>执行view函数，前提是签名的所有中间件process_view都返回None</li>
<li>逆序执行所有中间件的get_response(request)之后代码</li>
<li>特别注意，如果get_response(request)之前代码中return
HttpResponse(),将从当前中间件立即返回给浏览器端，从洋葱中依次反弹</li>
</ol></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:e6a7132e-970a-4642-924b-8d20638b8065"></a>自定义中间件用户验证<br>
<div class="outline-text-6" id="text-h:e6a7132e-970a-4642-924b-8d20638b8065">
<div class="org-src-container">
<pre class="src src-py">class BlogAuthMiddleware(object):
    """自定义中间件"""
    def __init__(self,get_response):
        self.get_response = get_response
        # 初始化执行一次

    def __call__(self,request):
        # 视图函数之前执行
        # 认证
        print(type(request),"++++++++++++++")
        print(request.GET)
        print(request.POST)
        print(request.body) #json数据
        print("- "* 30)
        response = self.get_response(request)
        #视图函数之后执行

        return response

# 要在setting的MIDDLEWARE中注册
</pre>
</div>

<ol class="org-ol">
<li>中间件拦截所有视图函数，但是只有一部分请求需要提供认证，所以考虑其他方法。</li>
<li>如果绝大多数都需要拦截，个别例外，采用中间件比较合适。</li>
<li>中间件有很多用户，适合拦截所有请求和响应。例如浏览器端的IP是否禁用、UserAgent分析、异常响应的统一处理。</li>

<li><b>用户验证装饰器</b>
<ol class="org-ol">
<li>在需要认证的view函数上增强认证功能，写一个装饰器函数。谁需要认证，就在这个view函数上应用这个装饰器。</li>

<li><p>
定义常量，可以在当前模块中，也可以定义在settings.py中。本次在=djweb/setting.py=中添加
</p>

<div class="org-src-container">
<pre class="src src-py"># 在`djweb/setting.py`中添加
#自定义常量
AUTH_EXPIRE = 8* 60 * 60 #8小时过期
AUTH_HEADER = "HTTP_JWT" #浏览器端是jwt，服务器端被改写为全大写并加HTTP_前缀
</pre>
</div></li>

<li><p>
用户验证装饰器代码
</p>

<div class="org-src-container">
<pre class="src src-py"># 本次写在user、views.py
# 登录验证装饰器
def authenticate(viewfunc):
    def wrapper(request:HttpRequest):
        # 认证越早越好
        jwtheader  = request.META.get(settings.AUTH_HEADER,"")
        # print(request.META.keys())
        # print(request.META["HTTP_COOKIE"].get(settings.AUTH_HEADER,""))
        # print(request.META["HTTP_COOKIE"])
        print("-   ------------")
        if not jwtheader:
            return HttpResponse(status=401)
        print(jwtheader)
        # 解码
        try:
            payload = jwt.decode(jwtheader,settings.SECRET_KEY,algorithms=["HS256"])
            # payload = "aa"
            print(payload)
        except Exception as e: #解码有任何异常，都不能通过认证
            print(e)
            return HttpResponse(status=401)

        # 是否过期ToDO
        print("- "*30)
        try:
            user_id = payload.get("user_id",0)
            if user_id == 0:
                return HttpResponse(status=401)
            user = User.objects.get(pk=user_id)
            request.user = user
        except Exception as e:
            print(e)
            return HttpResponse(status=401)
        response = viewfunc(request)
        return response
    return wrapper

@authenticate #在有需要的视图函数上加上此装饰器
def test(request):
    print("- "*30,"test")
    print(request.user)
    return JsonResponse({},status=200)

# 修改原先gen_token(user_id)函数
# 对id签名
def gen_token(user_id):
    # 时间戳用来判断是否过期，以便重发token或重新登录
    return  jwt.encode({
        "user_id":user_id,
        "exp":int(datetime.datetime.now().timestamp()) + settings.AUTH_EXPIRE #取整
    },settings.SECRET_KEY,algorithm="HS256").decode()
</pre>
</div>

<ul class="org-ul">
<li>注册函数</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from django.conf.urls import re_path
from .views import reg,login,test

urlpatterns = [
    re_path(r'^$',reg), #/users/
    re_path(r'^login$',login), #/users/login
    re_path(r"^test$",test), #/users/test
]
</pre>
</div>

<ul class="org-ul">
<li>测试方法(先登录后测试)</li>
</ul></li>
</ol></li>
<li>*JWT过期问题*(pyjwt过期)
<ol class="org-ol">
<li>在decode的时候，默认开启过期验证，如果过期，则抛出异常</li>

<li>需要在payload中增加claim exp，也就是exp的键值对，记录过期的时间点</li>

<li>exp要求是一个整数int的时间戳，或时间</li>

<li>exp键值对存在，才会进行过期校验</li>

<li><p>
测试
</p>

<div class="org-src-container">
<pre class="src src-py">import jwt
import datetime
import threading

event = threading.Event()
key = "xdd"

#在jwt的payload中增加exp claim
exp = int(datetime.datetime.now().timestamp()+10)
data = jwt.encode({"name":'tom',"age":20,'exp':exp},key)
print(jwt.get_unverified_header(data)) #不校验签名提取header

try:
    while not event.wait(1):
        print(jwt.decode(data,key)) #过期校验就会抛出异常
        print(datetime.datetime.now().timestamp())
except jwt.ExpiredSignatureError as e:
    print(e)
</pre>
</div></li>
</ol></li>
</ol>
</div>
</li>
<li><a id="h:95961e71-ed97-4390-8c9a-7b5ee7a6b5fb"></a>view装饰器<br>
<div class="outline-text-6" id="text-h:95961e71-ed97-4390-8c9a-7b5ee7a6b5fb">
<ul class="org-ul">
<li>注册、登录函数都是只支持POST方法，可以在试图函数内部自己判断，也可以使用官方提供的装饰器指定方法。</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from django.views.decorators.http import require_http_methods,require_POST,require_GET
@require_http_methods(["POST"])
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:d7b73a3a-7742-4bad-ba59-597f2e0d9c56" class="outline-4">
<h4 id="h:d7b73a3a-7742-4bad-ba59-597f2e0d9c56">代码参考</h4>
<div class="outline-text-4" id="text-h:d7b73a3a-7742-4bad-ba59-597f2e0d9c56">
<ul class="org-ul">
<li><code>user/views.py</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from django.http import HttpResponse,HttpRequest,HttpResponseBadRequest,JsonResponse
import simplejson
from .models import User
import jwt
import datetime
import bcrypt
from django.conf import settings
from django.views.decorators.http import require_http_methods,require_POST,require_GET

# 对id签名
def gen_token(user_id):
    # 时间戳用来判断是否过期，以便重发token或重新登录
    return  jwt.encode({
        "user_id":user_id,
        "exp":int(datetime.datetime.now().timestamp()) + settings.AUTH_EXPIRE #取整
    },settings.SECRET_KEY,algorithm="HS256").decode()

# 注册接口
@require_http_methods(["POST"])
def reg(request:HttpRequest):

    try:
        payload = simplejson.loads(request.body)
        email = payload['email']
        query = User.objects.filter(email=email)
        print(query)
        print(query.query) #查看sQL语句
        if query.first():
            return JsonResponse({"error":"用户已存在"},status=400)

        name = payload['name']
        password = payload["password"].encode()
        print(email,name,password)

        # 密码加密
        password = bcrypt.hashpw(password,bcrypt.gensalt()).decode()
        print(password)

        user = User()
        user.email = email
        user.name = name
        user.password = password
        user.save()

        return JsonResponse({"token":gen_token(user.id)},status=201) #创建成功返回201
    except Exception as e: #有任何异常，都返回
        print(e)
        # 失败返回错误信息和400，所有其他错误一律用户名密码错误
        return JsonResponse({"error":"用户名或密码错误"},status=400)

# 筛选所需要的字段
def jsonify(instance,allow=None,exclude=[]):
    # allow优先，如果有，就使用allow指定的字段，这时候exclude无效
    # allow如果为空，就全体，但要看看有exclude中的要排除
    modelcls = type(instance)
    if allow:
        fn = (lambda x:x.name in allow)
    else:
        fn = (lambda x:x.name not in exclude)
    # from django.db.models.options import Options
    # m:Options = modelcls._meta
    # print(m.fields,m.pk)
    # print("----------")
    return {k.name:getattr(instance,k.name) for k in filter(fn,modelcls._meta.fields)}

# 登录接口
@require_POST
def login(request:HttpRequest):
    try:
        payload = simplejson.loads(request.body)
        print(payload)
        email = payload["email"]
        password = payload["password"].encode()

        user = User.objects.get(email=email) # only one
        print(user.password)

        if bcrypt.checkpw(password,user.password.encode()):
            # 验证成功
            token = gen_token(user.id)

            res = JsonResponse({
                "user":jsonify(user,exclude=["password"]),
                "token":token
            }) #返回200
            res.set_cookie("jwt",token)
            return res
        else:
            return JsonResponse({"error":"用户名或密码错误"},status=400)
    except Exception as e:
        print(e)
        #失败返回错误信息和400，所有其他错误一律用户名密码错误
        return JsonResponse({"error":"用户名或密码错误"},status=400)

# 登录验证装饰器
def authenticate(viewfunc):
    def wrapper(request:HttpRequest):
        # 认证越早越好
        jwtheader  = request.META.get(settings.AUTH_HEADER,"")
        # print(request.META.keys())
        # print(request.META["HTTP_COOKIE"].get(settings.AUTH_HEADER,""))
        # print(request.META["HTTP_COOKIE"])
        print("-   ------------")
        if not jwtheader:
            return HttpResponse(status=401)
        print(jwtheader)
        # 解码
        try:
            payload = jwt.decode(jwtheader,settings.SECRET_KEY,algorithms=["HS256"])
            # payload = "aa"
            print(payload)
        except Exception as e: #解码有任何异常，都不能通过认证
            print(e)
            return HttpResponse(status=401)

        # 是否过期ToDO
        print("- "*30)
        try:
            user_id = payload.get("user_id",0)
            if user_id == 0:
                return HttpResponse(status=401)
            user = User.objects.get(pk=user_id)
            request.user = user
        except Exception as e:
            print(e)
            return HttpResponse(status=401)
        response = viewfunc(request)
        return response
    return wrapper

@require_POST
@authenticate #在有需要的视图函数上加上此装饰器
def test(request):
    print("- "*30,"test")
    print(request.user)
    return JsonResponse({},status=200)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ecb5af9a-c858-4c89-9011-a08b2b0c923c" class="outline-3">
<h3 id="h:ecb5af9a-c858-4c89-9011-a08b2b0c923c">博文接口实现</h3>
<div class="outline-text-3" id="text-h:ecb5af9a-c858-4c89-9011-a08b2b0c923c">
<p>
[toc]
</p>

<ul class="org-ul">
<li>功能分析</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">POST /posts/ 文章发布，试图类PostView

请求体 application/json
{
    "title":"string",
    "content":"string"
}

响应
201 发布成功
400 请求数据错误
</pre>
</div>

<div class="org-src-container">
<pre class="src src-txt">GET /posts/(\d+) 查看指定文章，试图函数getpost

响应
200 成功返回文章内容
404 文章不存在
</pre>
</div>

<div class="org-src-container">
<pre class="src src-txt">GET /posts/ 文章列表页，视图类PostView

响应
200 成功返回文章列表
</pre>
</div>
</div>
<div id="outline-container-h:1a04237e-d588-442d-bdb4-746f7aa8d905" class="outline-4">
<h4 id="h:1a04237e-d588-442d-bdb4-746f7aa8d905">创建博文应用</h4>
<div class="outline-text-4" id="text-h:1a04237e-d588-442d-bdb4-746f7aa8d905">
<ul class="org-ul">
<li><code>python manage.py startapp post</code></li>

<li><p>
注意：*一定要把应用post加入到settings.py中*，否则不能迁移
</p>

<div class="org-src-container">
<pre class="src src-py"># djweb/settings.py中修改
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'user',
    "post"
]
</pre>
</div></li>

<li><b>添加对应路由</b>

<ol class="org-ol">
<li><p>
修改djweb/urls.py文件
</p>

<div class="org-src-container">
<pre class="src src-py"># 修改djweb/urls.py文件
urlpatterns = [
    path('admin/', admin.site.urls),
    re_path(r'^$',index),
    re_path(r'^index$',index),#不同路径可以指向同一个函数执行
    re_path(r'^users/',include("user.urls")),
    re_path(r'^posts/',include("post.urls"))
]
</pre>
</div></li>

<li><p>
新建post/urls.py文件
</p>

<div class="org-src-container">
<pre class="src src-py"># 新建post/urls.py文件 配置路由信息
from django.conf.urls import re_path
from .views import PostView,getpost

urlpatterns = [
    re_path(r'^$',PostView.as_view()), #/posts/  视图函数PostView
    re_path(r'^(\d+)$',getpost),
]
</pre>
</div></li>

<li><p>
修改post/views.py文件
</p>

<div class="org-src-container">
<pre class="src src-py">from django.http import HttpResponse,HttpRequest,JsonResponse
from django.views.decorators.http import require_GET
from django.views import View

class PostView(View):
    pass

def getpost(request:HttpRequest,id):
    print(id)
    return JsonResponse({},status=201)
</pre>
</div></li>
</ol></li>

<li><p>
<b>构建数据库模型</b>
</p>

<ol class="org-ol">
<li>修改post/models.py文件</li>
</ol>

<div class="org-src-container">
<pre class="src src-py">from django.db import models
from user.models import User

# post表
class Post(models.Model):
    class Meta:
        db_table = "post"
    id = models.AutoField(primary_key=True)
    title = models.CharField(max_length=256,null=False)
    postdate = models.DateTimeField(null=False)
    # 从post查看作者，从post查看内容
    author = models.ForeignKey(User,on_delete=models.PROTECT) #指定外键，migrate会生成author_id字段
    # self.content可以访问Content实例，其内容是self.content.content

    def __repr__(self):
        return '&lt;Post {} {} {} {} &gt;'.format(
            self.id,self.title,self.author_id,self.content
        )

    __str__ = __repr__

# content表
class Content(models.Model):
    class Meta:
        db_table = "content"
    # 没有主键，会自动创建一个自增主键
    post = models.OneToOneField(Post,primary_key=True,on_delete=models.PROTECT) #一对一，这边会有一个外键post_id引用post.id
    content = models.TextField(null=False)

    def __repr__(self):
        return "&lt;Content {} {} &gt;".format(self.post.pk,self.content[:20])

    __str__ = __repr__
</pre>
</div>

<ol class="org-ol">
<li>注意：on_delete在Django2.0开始，on_delete必须提供，参考<a href="https://docs.djangoproject.com/en/1.11/ref/models/fields/#django.db.models.ForeignKey.on_delete">https://docs.djangoproject.com/en/1.11/ref/models/fields/#django.db.models.ForeignKey.on_delete</a>
<ol class="org-ol">
<li>models.CASCADE
级联删除。Django在DELETE级联上模拟SOL约束的行为，并删除包含外键的对象。</li>
<li>models.PROTECT 通过引发ProtectedError
(django.db.IntegrityError的子类)防止删除引用的对象。</li>
<li>models.SET_NULL 设置外键为空;这只有在null为真时才有可能。</li>
<li>models.SET_DEFAULT 将外键设置为其默认值;必须为外键设置默认值。</li>
<li>models.DO_NOTHING
不采取任何行动。如果数据库后端强制执行引用完整性，这将导致IntegrityError，除非手动向数据库字段添加一个SOL
ON DELETE约束。</li>
</ol></li>
</ol></li>

<li><b>视图分类</b>

<ol class="org-ol">
<li>function-based view 视图函数：视图功能有函数实现</li>
<li>class-based view
视图类：视图功能有基于django.views.View类的子类实现</li>
</ol></li>

<li><p>
<b>django.views.View类原理</b>
</p>
<ul class="org-ul">
<li>django.views.View类本质就是一个对请求方法分发到与请求方法同名函数的调度器。</li>
<li>django.views.View类，定义了http的方法的小写名称列表，这些小写名称其实就是处理请求的方法名的小写。as_views()方法就是返回一个内建的=view(request,*args,**kwargs)=函数，本质上其实还是url映射到了函数上，只不过view函数内部会调用=dispatch(request,*args,**kwargs)=分发函数。</li>
<li>dispatch函数中使用request对象的请求方法小写和http_method_names中允许的HTTP方法匹配，匹配说明是正确的HTTP请求方法，然后尝试再View子类中找该方法，调用后返回结果。找不到该名称方法，就执行http_method_not_allowed方法返回405状态码</li>
<li>看到了getattr等反射函数，说明基于反射实现的。</li>
<li>as_view()方法，用在url映射配置中
<ol class="org-ol">
<li>本质上，as_view()方法还是把一个类伪装成了一个视图函数。</li>
<li>这个视图函数，内部使用了一个分发函数，使用请求方法名称吧请求分发给存在的同名函数处理。</li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 修改post/urls.py文件
from django.conf.urls import re_path
from .views import PostView,getpost
from user.views import authenticate #登录验证装饰器

urlpatterns = [
    # 路径/posts/
    # View类调用as_view()之后类等价一个视图函数，可以被装饰
    # 装饰器函数返回新函数
    re_path(r'^$',authenticate(PostView.as_view())), #/posts/  视图函数PostView
    re_path(r'^(\d+)$',getpost),
]
</pre>
</div>

<ul class="org-ul">
<li>但是这种方式适合吧PostView类所有方法都认证，但是实际上就post方法要认证。所以，authenticate还是需要加载到post方法上去。因此，要修改authenticate函数</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 修改user/views.py文件中对应内容
# 登录验证装饰器
def authenticate(viewfunc):
    def wrapper(*args):
        *s,request = args #保证最后一个取到request对象
        print(s)
        print(request)

        # 认证越早越好
        jwtheader  = request.META.get(settings.AUTH_HEADER,"")
        # print(request.META.keys())
        # print(request.META["HTTP_COOKIE"].get(settings.AUTH_HEADER,""))
        # print(request.META["HTTP_COOKIE"])
        print("-   ------------")
        if not jwtheader:
            return HttpResponse(status=401)
        print(jwtheader)
        # 解码
        try:
            payload = jwt.decode(jwtheader,settings.SECRET_KEY,algorithms=["HS256"])
            # payload = "aa"
            print(payload)
        except Exception as e: #解码有任何异常，都不能通过认证
            print(e)
            return HttpResponse(status=401)

        # 是否过期ToDO
        print("- "*30)
        try:
            user_id = payload.get("user_id",0)
            if user_id == 0:
                return HttpResponse(status=401)
            user = User.objects.get(pk=user_id)
            request.user = user
        except Exception as e:
            print(e)
            return HttpResponse(status=401)

        response = viewfunc(*args) #参数解构
        return response
    return wrapper
</pre>
</div>

<ul class="org-ul">
<li>修改post/views.py文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># post/views.py
from django.http import HttpResponse,HttpRequest,JsonResponse
from django.views.decorators.http import require_GET
from django.views import View
from user.views import authenticate

class PostView(View): #不需要装饰器决定请求方法了
    def get(self,request:HttpRequest): #获取全体文章走这里
        print("get ~~~~~~~~~~~~~~~~~~")
        return JsonResponse({},status=200)

    # 注意：由于PostView类中并不是所有方法都需要登录认证，所有将urls路径映射中的登录认证去掉了，在这里加上。
    @authenticate
    def post(self,request:HttpRequest):#提交文章数据走这里
        print("post ++++++++++++++++++")
        return JsonResponse({}, status=200)

@require_GET
def getpost(request:HttpRequest,id):
    print(id)
    return JsonResponse({},status=201)
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:2a36bad0-198d-4d4b-9229-2376d89609ee" class="outline-4">
<h4 id="h:2a36bad0-198d-4d4b-9229-2376d89609ee">发布接口实现</h4>
<div class="outline-text-4" id="text-h:2a36bad0-198d-4d4b-9229-2376d89609ee">
<ul class="org-ul">
<li>用户从浏览器端提交json数据，包含title，content.</li>

<li>提交博文需要认证用户，从请求的header中验证jwt。</li>

<li><code>request:POST 标题、内容-》@authenticate -&gt;视图 post -&gt; json新文章对象</code></li>

<li><p>
新建工具包，调整jsonify函数,放入工具包内
</p>

<div class="org-src-container">
<pre class="src src-py"># utils/__init__.py
# 筛选所需要的字段
def jsonify(instance,allow=None,exclude=[]):
    # allow优先，如果有，就使用allow指定的字段，这时候exclude无效
    # allow如果为空，就全体，但要看看有exclude中的要排除
    modelcls = type(instance)
    if allow:
        fn = (lambda x:x.name in allow)
    else:
        fn = (lambda x:x.name not in exclude)
    # from django.db.models.options import Options
    # m:Options = modelcls._meta
    # print(m.fields,m.pk)
    # print("----------")
    return {k.name:getattr(instance,k.name) for k in filter(fn,modelcls._meta.fields)}
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-h:263ffedb-95b4-46fd-9236-765e92eb2bb4" class="outline-5">
<h5 id="h:263ffedb-95b4-46fd-9236-765e92eb2bb4">显示事务处理</h5>
<div class="outline-text-5" id="text-h:263ffedb-95b4-46fd-9236-765e92eb2bb4">
<ul class="org-ul">
<li>Django中每一次save()调用就会自动提交，那么在第一次事务提交后如果第二次提交前出现异常，则post.save()不会回滚。为了解决，可以使用事务的原子方法：参考<a href="https://docs.djangoproject.com/en/1.11/topics/db/transactions/#django.db.transaction.atomic">https://docs.djangoproject.com/en/1.11/topics/db/transactions/#django.db.transaction.atomic</a></li>

<li>事务的使用方法

<ol class="org-ol">
<li><p>
装饰器用法
</p>

<div class="org-src-container">
<pre class="src src-py">@transaction.atomic #装饰器用法
def viewfunc(request):
    # This code executes inside a transaction
    do_stuff()
</pre>
</div></li>

<li><p>
上下文用法
</p>

<div class="org-src-container">
<pre class="src src-py">def viewfunc(request):
     # This code executes in autocommit mode (Django's default).
    do_stuff()

    with transaction.atomic(): #上下文用法
        # This code executes inside a transaction.
        do_more_stuff()
</pre>
</div></li>
</ol></li>

<li><p>
修改=post/views.py=文件
</p>

<div class="org-src-container">
<pre class="src src-py"># 修改`post/views.py`文件
class PostView(View): #不需要装饰器决定请求方法了
    def get(self,request:HttpRequest): #获取全体文章走这里
        print("get ~~~~~~~~~~~~~~~~~~")
        return JsonResponse({},status=200)

    # 注意：由于PostView类中并不是所有方法都需要登录认证，所有将urls路径映射中的登录认证去掉了，在这里加上。
    @authenticate 
    def post(self,request:HttpRequest):#提交文章数据走这里
        print("post ++++++++++++++")
        post = Post()
        content = Content()

        try:
            payload = simplejson.loads(request.body)
            post.title = payload["title"]
            post.author = User(id=request.user.id)
            # post.author = request.user
            post.postdate = datetime.datetime.now(
                datetime.timezone(datetime.timedelta(hours=8))
            )
            with transaction.atomic(): #原子操作
                post.save()
                content.post = post
                content.content = payload["content"]
                content.save()
            return JsonResponse({
                "post":jsonify(post,allow=["id","title"])
            },status=200)
        except Exception as e:
            print(e)
            return HttpResponse(status=400)
</pre>
</div></li>

<li>启动后测试

<ol class="org-ol">
<li>带jwt访问=<a href="http://127.0.0.1:8000/posts/=%E9%9C%80%E8%A6%81%E5%85%88%E7%99%BB%E5%BD%95">http://127.0.0.1:8000/posts/=%E9%9C%80%E8%A6%81%E5%85%88%E7%99%BB%E5%BD%95</a></li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:6b1b783b-a065-4a4b-aecf-ccb37374424d" class="outline-4">
<h4 id="h:6b1b783b-a065-4a4b-aecf-ccb37374424d">文章接口实现</h4>
<div class="outline-text-4" id="text-h:6b1b783b-a065-4a4b-aecf-ccb37374424d">
<ul class="org-ul">
<li>根据post_id查询博文并返回。</li>
<li>如果博文只能作者看到，就需要认证，本次是公开，即所有人都能看到，所以不需要认证。同样，下面的list接口也是不需要认证的。</li>
<li><code>request: GET post's id-&gt; getpost 视图函数 -&gt; Json post + content</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 修改`post/views.py`文件
@require_GET
def getpost(request:HttpRequest,id):
    try:
        id = int(id)
        post = Post.objects.get(pk=id) #only one
        return JsonResponse({
            "post":{
                "id":post.id,
                "title":post.title,
                "author":post.author.name,
                "author_id":post.author_id, #post.author.id
                "postdate":post.postdate.timestamp(),
                "content":post.content.content
            }
        })
    except Exception as e:
        print(e)
        return HttpResponse(status=404)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5d768b55-fb83-4029-aca7-147e98ce35ef" class="outline-4">
<h4 id="h:5d768b55-fb83-4029-aca7-147e98ce35ef">列表页接口实现</h4>
<div class="outline-text-4" id="text-h:5d768b55-fb83-4029-aca7-147e98ce35ef">
<ul class="org-ul">
<li>发起GET请求，通过查询字符串=<a href="http://url/posts/?page=2=%E6%9F%A5%E8%AF%A2%E7%AC%AC%E4%BA%8C%E9%A1%B5%E6%95%B0%E6%8D%AE">http://url/posts/?page=2=%E6%9F%A5%E8%AF%A2%E7%AC%AC%E4%BA%8C%E9%A1%B5%E6%95%B0%E6%8D%AE</a></li>
<li><code>request: GET ?pate=5&amp;size=20 -&gt;视图 get -&gt; json文章列表</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">GET /posts/?page=3&amp;size=20 文章列表，视图类PostView

响应
200 成功返回文章列表
</pre>
</div>

<ul class="org-ul">
<li>完善分页
<ol class="org-ol">
<li>分页信息，一般有：当前页/总页数、每页条数，记录总数。
<ul class="org-ul">
<li>*当前页*：page</li>
<li>*每页条数*：size ,每页最多多少行</li>
<li>*总页数*：pages = math.ceil(count/size)</li>
<li>*记录总数*：total,从select * from table来</li>
</ul></li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 修改post/views.py文件
from django.http import HttpResponse,HttpRequest,JsonResponse
from django.views.decorators.http import require_GET
from django.views import View
from user.views import authenticate
from post.models import Post,Content
from user.models import User
import simplejson,datetime,math
from django.db import transaction
from utils import jsonify

class PostView(View): #不需要装饰器决定请求方法了
    def get(self,request:HttpRequest): #获取全体文章走这里
        print("get ~~~~~~~~~~~~~~~~~~")
        try: #页码
            page = int(request.GET.get("page",1))
            page = page if page &gt;0 else 1
        except:
            page = 1

        try: #每页条数
            #注意，这个数据不要轻易让浏览器端改变，如果允许改变，一定要控制范围
            size = int(request.GET.get("size",20))
            size = size if size &gt;0 and size &lt;101 else 20
        except:
            size = 20

        try: #每页条目数
            start = (page - 1) * size
            posts = Post.objects.order_by("-pk")
            print(posts.query)
            total = posts.count()
            posts = posts[start:start + size]
            print(posts.query)
            return JsonResponse({
                "posts":[jsonify(post,allow=["id","title"]) for post in posts],
                "pagination":{
                    "page":page,
                    "size":size,
                    "total":total,
                    "pages":math.ceil(total / size)
                }
            })
        except Exception as e:
            print(e)
            return HttpResponse(status=400)
</pre>
</div>

<ul class="org-ul">
<li>也可以使用Django提供的Paginator类来完成。</li>
<li>Paginator文档<a href="https://docs.djangoproject.com/en/1.11/topics/pagination/">https://docs.djangoproject.com/en/1.11/topics/pagination/</a></li>
<li>但是，还是自己更加简单明了些。</li>
</ul>
</div>
<div id="outline-container-h:1838ff94-d958-4944-8bd8-46da421bcf42" class="outline-5">
<h5 id="h:1838ff94-d958-4944-8bd8-46da421bcf42">改写校验函数</h5>
<div class="outline-text-5" id="text-h:1838ff94-d958-4944-8bd8-46da421bcf42">
<ul class="org-ul">
<li>修改post/views.py文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-py"># 修改post/views.py文件
def validate(d:dict,name:str,type_func,default,validate_func):
    try:
        ret = type_func(d.get(name,default))
        ret = validate_func(ret,default)
    except:
        ret = default
    return ret

class PostView(View): #不需要装饰器决定请求方法了
    def get(self,request:HttpRequest): #获取全体文章走这里
        print("get ~~~~~~~~~~~~~~~~~~")
        # 页码
        page = validate(request.GET,"page",int,1,lambda x,y:x if x&gt;0 else y)
        # 每页条数
        #注意，这个数据不要轻易让浏览器端改变，如果允许改变，一定要控制范围
        size = validate(request.GET,"page",int,20,lambda x,y:x if x&gt;0 and x&lt;101 else y)

        try: #每页条目数
            start = (page - 1) * size
            posts = Post.objects.order_by("-pk")
            print(posts.query)
            total = posts.count()

            posts = posts[start:start + size]
            print(posts.query)
            return JsonResponse({
                "posts":[jsonify(post,allow=["id","title"]) for post in posts],
                "pagination":{
                    "page":page,
                    "size":size,
                    "total":total,
                    "pages":math.ceil(total / size)
                }
            })
        except Exception as e:
            print(e)
            return HttpResponse(status=400)
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ab043578-1b85-4bdb-b412-17d7a08c7061" class="outline-3">
<h3 id="h:ab043578-1b85-4bdb-b412-17d7a08c7061">前端开发及登录功能实现</h3>
<div class="outline-text-3" id="text-h:ab043578-1b85-4bdb-b412-17d7a08c7061">
<p>
[toc]
</p>
</div>
<div id="outline-container-h:2a1f7cef-fbfc-4cc8-9bd0-572a1139956a" class="outline-4">
<h4 id="h:2a1f7cef-fbfc-4cc8-9bd0-572a1139956a">开发环境设置</h4>
<div class="outline-text-4" id="text-h:2a1f7cef-fbfc-4cc8-9bd0-572a1139956a">
<ul class="org-ul">
<li>使用react-mobx-starter-master脚手架，解压更名为DjangoNode。</li>

<li>在src中新增component、service、css目录</li>

<li>注意：没有特别说明，js开发都在src目录下</li>

<li>目录结构</li>
</ul>

<div class="org-src-container">
<pre class="src src-js">DjangoNode/
    &#9474;-.babelrc
    &#9474;-.gitignore #git&#30340;&#24573;&#30053;&#25991;&#20214;
    &#9474;-.npmrc    #npm&#30340;&#26381;&#21153;&#22120;&#37197;&#32622;&#65292;&#26412;&#27425;&#20351;&#29992;&#30340;&#26159;&#38463;&#37324;
    &#9474;-index.html #dev server&#20351;&#29992;&#30340;&#39318;&#39029;
    &#9474;-jsconfig.json
    &#9474;-LICENSE
    &#9474;-<span style="color: #a020f0;">package</span>-lock.json
    &#9474;-<span style="color: #a020f0;">package</span>.json  #&#39033;&#30446;&#30340;&#26681;&#30446;&#24405;&#23433;&#35013;&#25991;&#20214;&#65292;&#20351;&#29992;npm install&#21487;&#20197;&#26500;&#24314;&#39033;&#30446;
    &#9474;-README.md
    &#9474;-webpack.config.dev.js #&#24320;&#21457;&#29992;&#30340;&#37197;&#32622;&#25991;&#20214;
    &#9474;-webpack.config.prod.js #&#29983;&#20135;&#29615;&#22659;&#65292;&#25171;&#21253;&#29992;&#30340;&#37197;&#32622;&#25991;&#20214;
    &#9492;&#9472;src/
        &#9474;- componet/ #&#33258;&#24049;&#32452;&#20214;&#25991;&#20214;&#22841;
        &#9474;- service/  #&#26381;&#21153;&#31243;&#24207;
        &#9474;- css/  #&#26679;&#24335;&#34920;
        &#9474;- index.html #&#27169;&#26495;&#39029;&#38754;
        &#9474;- index.js
</pre>
</div>

<ol class="org-ol">
<li><p>
修改项目信息=package.json=文件
</p>

<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"blog"</span>,
    <span style="color: #8b2252;">"description"</span>:<span style="color: #8b2252;">"blog project"</span>,
    <span style="color: #8b2252;">"author"</span>:<span style="color: #8b2252;">"xdd"</span>
}
</pre>
</div></li>

<li><p>
修改=webpack.config.dev.js=
</p>

<div class="org-src-container">
<pre class="src src-js">devServer: {
        compress: <span style="color: #008b8b;">true</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">gzip</span><span style="color: #b22222;"> */</span>
        <span style="color: #b22222;">//</span><span style="color: #b22222;">host:'192.168.61.109', /* &#35774;&#32622;ip */</span>
        port: 3000,
        publicPath: <span style="color: #8b2252;">'/assets/'</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;bundled files&#27983;&#35272;&#22120;&#31471;&#35775;&#38382;&#22320;&#22336;</span><span style="color: #b22222;"> */</span>
        hot: <span style="color: #008b8b;">true</span>,  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24320;&#21551;HMR&#28909;&#27169;&#22359;&#26367;&#25442;</span><span style="color: #b22222;"> */</span>
        inline: <span style="color: #008b8b;">true</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25511;&#21046;&#27983;&#35272;&#22120;&#25511;&#21046;&#21488;&#26159;&#21542;&#26174;&#31034;&#20449;&#24687;</span><span style="color: #b22222;"> */</span>
        historyApiFallback: <span style="color: #008b8b;">true</span>,
        stats: {
            chunks: <span style="color: #008b8b;">false</span>
        },
        proxy: { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20195;&#29702;</span>
            <span style="color: #8b2252;">'/api'</span>: {
                target: <span style="color: #8b2252;">'http://127.0.0.1:8000'</span>,
                changeOrigin: <span style="color: #008b8b;">true</span>
            }
        }
    }
</pre>
</div></li>

<li><p>
安装依赖 <code>npm install</code>
</p>

<ul class="org-ul">
<li>npm会按照package.json中依赖的包。也可以使用新的包管理工具yarn安装模块</li>
<li>使用yarn替换npm安装，速度会更快写，yarn是并行安装，npm是串行安装。</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">yarn安装
$ npm install -g yarn
或者，去https://yarn.bootcss.com/docs/install/

相当于npm install
$ yarn

* 如果想自己构建脚手架，可以使用如下命令
$npm install  #构建脚手架
相当于npm install react-router #添加react-router组件
$ yarn add react-router # 安装路由，即项目前端web路由
$ yarn add react-router-dom #
</pre>
</div></li>

<li><p>
相关命令
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">npm命令</th>
<th scope="col" class="org-left">Yarn命令</th>
<th scope="col" class="org-left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>npm install</code></td>
<td class="org-left"><code>yarn install</code></td>
<td class="org-left">安装</td>
</tr>

<tr>
<td class="org-left"><code>npm install [package] --save</code></td>
<td class="org-left"><code>yarn add [package]</code></td>
<td class="org-left">安装运行时依赖</td>
</tr>

<tr>
<td class="org-left"><code>npm install [package] --save-dev</code></td>
<td class="org-left"><code>yarn add [package] --dev</code></td>
<td class="org-left">安装开发时依赖</td>
</tr>

<tr>
<td class="org-left"><code>npm install [package] --global</code></td>
<td class="org-left"><code>yarn global add [package]</code></td>
<td class="org-left">全局安装</td>
</tr>

<tr>
<td class="org-left"><code>npm uninstall [package]</code></td>
<td class="org-left"><code>yarn remove [package]</code></td>
<td class="org-left">卸载</td>
</tr>
</tbody>
</table></li>
</ol>
</div>
</div>
<div id="outline-container-h:19aac4a1-0284-43cc-a9f5-b4a832f44497" class="outline-4">
<h4 id="h:19aac4a1-0284-43cc-a9f5-b4a832f44497">开发</h4>
<div class="outline-text-4" id="text-h:19aac4a1-0284-43cc-a9f5-b4a832f44497">
</div>
<div id="outline-container-h:29488dbd-a446-4e2c-9e08-0b26154cac48" class="outline-5">
<h5 id="h:29488dbd-a446-4e2c-9e08-0b26154cac48">前端路由</h5>
<div class="outline-text-5" id="text-h:29488dbd-a446-4e2c-9e08-0b26154cac48">
<ul class="org-ul">
<li>前端路由使用react-router组件完成</li>
<li>官方文档<a href="https://reacttraining.com/react-router/web/guides/quick-start">https://reacttraining.com/react-router/web/guides/quick-start</a><br></li>
<li>基本例子<a href="https://reacttraining.com/react-router/web/example/basic">https://reacttraining.com/react-router/web/example/basic</a><br></li>
<li>使用react-route主键，更改src/index.js</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">src/index.js&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;
<span style="color: #a020f0;">import</span> {Route,Link,BrowserRouter as Router,Switch} from <span style="color: #8b2252;">"react-router-dom"</span>;

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">App</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">Router</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">ul</span>&gt;
<span style="color: #000000; background-color: #ffffff;">          </span>&lt;<span style="color: #0000ff;">li</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span>&gt;<span style="color: #000000; background-color: #ffffff;">Home</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;
<span style="color: #000000; background-color: #ffffff;">          </span>&lt;/<span style="color: #0000ff;">li</span>&gt;
<span style="color: #000000; background-color: #ffffff;">          </span>&lt;<span style="color: #0000ff;">li</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/about"</span>&gt;<span style="color: #000000; background-color: #ffffff;">About</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;
<span style="color: #000000; background-color: #ffffff;">          </span>&lt;/<span style="color: #0000ff;">li</span>&gt;
<span style="color: #000000; background-color: #ffffff;">          </span>&lt;<span style="color: #0000ff;">li</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/users"</span>&gt;<span style="color: #000000; background-color: #ffffff;">Users</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;
<span style="color: #000000; background-color: #ffffff;">          </span>&lt;/<span style="color: #0000ff;">li</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">ul</span>&gt;

<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">hr</span> /&gt;

<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">exact</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span> <span style="color: #a0522d;">component</span>={Home} /&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/about"</span> <span style="color: #a0522d;">component</span>={About} /&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/users"</span> <span style="color: #a0522d;">component</span>={Users} /&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">Router</span>&gt;
  );
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">Home</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">Home</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  );
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">About</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">About</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  );
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">Users</span> = () =&gt; {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">Users</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  )
}

ReactDom.render(&lt;<span style="color: #0000ff;">App</span> /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>

<ul class="org-ul">
<li>注意：
<ol class="org-ol">
<li><b>Link组件相当于a标签</b></li>
<li>*Route*组件不可见，用来做Router的路由定义。当网页中的地址栏中地址发生改变，会从Route中匹配对应的路径加载对应的组件。</li>
</ol></li>
<li><p>
*启动项目*=yarn run start=
</p>
<ol class="org-ol">
<li>start是在配置文件=dockerNode/package.json=中已经定义好了，如下：</li>
</ol>

<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #8b2252;">"scripts"</span>: {
        <span style="color: #8b2252;">"test"</span>: <span style="color: #8b2252;">"jest"</span>,
        <span style="color: #8b2252;">"start"</span>: <span style="color: #8b2252;">"webpack-dev-server --config webpack.config.dev.js --hot --inline"</span>,
        <span style="color: #8b2252;">"build"</span>: <span style="color: #8b2252;">"rimraf dist &amp;&amp; webpack -p --config webpack.config.prod.js"</span>
    },
}
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li>在地址栏中输入=<a href="http://127.0.0.1:3000/=%E6%88%96=http://127.0.0.1:3000/about=%E8%83%BD%E5%A4%9F%E7%9C%8B%E5%88%B0%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%8F%98%E5%8C%96">http://127.0.0.1:3000/=%E6%88%96=http://127.0.0.1:3000/about=%E8%83%BD%E5%A4%9F%E7%9C%8B%E5%88%B0%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%8F%98%E5%8C%96</a>。</li>
<li>App中，使用了*Router路由组件，Router是根，且它只能有一个元素，所以添加了Div*
<ol class="org-ol">
<li>访问=<a href="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a>=</li>
<li>访问=<a href="http://127.0.0.1:3000/about">http://127.0.0.1:3000/about</a>=</li>
</ol></li>
<li>前端路由：通过一个url加载一个组件，将原来的组件替换。</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:25a04646-d405-492b-bd42-1c179d644578"></a>Route指令<br>
<div class="outline-text-6" id="text-h:25a04646-d405-492b-bd42-1c179d644578">
<ul class="org-ul">
<li>它负责静态路由，只能和Route指定的path匹配，组件就可以显示。URL变化，将重新匹配路径</li>
<li>component属性设置目标组件</li>
<li>path是匹配路径，如果匹配则显示组件
<ol class="org-ol">
<li><code>exact</code>:布尔值</li>
<li><code>strict</code>:布尔值</li>
</ol></li>
<li>没有path属性，组件将总是显示，例如=&lt;Route component={Always} /&gt;=</li>
<li>path属性还支持路径数组，意思是多个路径都可以匹配</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;src/index.js&#25991;&#20214;</span><span style="color: #b22222;">*/</span>
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">App</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;Router&gt;
      &lt;div&gt;
        &lt;ul&gt;
          &lt;li&gt;
            &lt;Link to=<span style="color: #8b2252;">"/"</span>&gt;Home&lt;/Link&gt;
          &lt;/li&gt;
          &lt;li&gt;
            &lt;Link to=<span style="color: #8b2252;">"/about"</span>&gt;About&lt;/Link&gt;
          &lt;/li&gt;
          &lt;li&gt;
            &lt;Link to=<span style="color: #8b2252;">"/users"</span>&gt;Users&lt;/Link&gt;
          &lt;/li&gt;
        &lt;/ul&gt;

        &lt;hr /&gt;

        &lt;Route exact path={[<span style="color: #8b2252;">"/"</span>,<span style="color: #8b2252;">"/index"</span>]} component={Home} /&gt;
        &lt;Route path=<span style="color: #8b2252;">"/about"</span> component={About} /&gt;
        &lt;Route path=<span style="color: #8b2252;">"/users"</span> component={Users} /&gt;
        &lt;Route component={Always} /&gt;
      &lt;/div&gt;
    &lt;/Router&gt;
  );
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">Always</span>(){
  <span style="color: #a020f0;">return</span>(
    &lt;div id=<span style="color: #8b2252;">"footer"</span>&gt;
      &lt;span&gt;Copyright 2009-2019 xdd.com&lt;/span&gt;
    &lt;/div&gt;
  )
}

ReactDom.render(&lt;App /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>


<ol class="org-ol">
<li><p>
<b>路由配置</b>
</p>
<ul class="org-ul">
<li><b>exact</b> 只能匹配本路径，不包含子路径</li>
<li><b>strict</b> 路径尾部有=/=,则必须匹配这个=/=,也可以匹配子路径|</li>
<li><b>exact strict</b> 一起用，表示严格的等于当前指定路径</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">路径</th>
<th scope="col" class="org-left"><code>/about</code></th>
<th scope="col" class="org-left"><code>/about/</code></th>
<th scope="col" class="org-left"><code>/about/123</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>path</code>"/about"=</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
</tr>

<tr>
<td class="org-left"><code>exact path</code>"/about"=</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>exact path</code>"<i>about</i>"=</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>strict path</code>"/about"=</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
</tr>

<tr>
<td class="org-left"><code>exact strict path</code>"/about"=</td>
<td class="org-left">√</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>strict path</code>"<i>about</i>"=</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">√</td>
<td class="org-left">√</td>
</tr>

<tr>
<td class="org-left"><code>exact strict path</code>"<i>about</i>"=</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">√</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>

<li><p>
<b>Switch指令</b>
</p>
<ul class="org-ul">
<li>也可以将Route组织到一个Switch中，一旦匹配Switch中的一个Route，就不再匹配其他。但是Route是匹配所有，如果匹配就会显示组件，无path的Route始终匹配。</li>
<li>示例：</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;src/index.js&#25991;&#20214;</span><span style="color: #b22222;">*/</span>
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">App</span>() {
<span style="color: #a020f0;">return</span> (
    &lt;Router&gt;
    &lt;div&gt;
        &lt;ul&gt;
        &lt;li&gt;
            &lt;Link to=<span style="color: #8b2252;">"/"</span>&gt;Home&lt;/Link&gt;
        &lt;/li&gt;
        &lt;li&gt;
            &lt;Link to=<span style="color: #8b2252;">"/about"</span>&gt;About&lt;/Link&gt;
        &lt;/li&gt;
        &lt;li&gt;
            &lt;Link to=<span style="color: #8b2252;">"/users"</span>&gt;Users&lt;/Link&gt;
        &lt;/li&gt;
        &lt;/ul&gt;

        &lt;hr /&gt;
        &lt;Switch&gt;
        &lt;Route path=<span style="color: #8b2252;">"/"</span> component={Home} /&gt;
        &lt;Route path=<span style="color: #8b2252;">"/about"</span> component={About} /&gt;
        &lt;Route path=<span style="color: #8b2252;">"/users"</span> component={Users} /&gt;
        &lt;Route component={Always} /&gt;
        &lt;/Switch&gt;
    &lt;/div&gt;
    &lt;/Router&gt;
);
}
</pre>
</div>

<ul class="org-ul">
<li>注意这个时候Always组件，其实是404组件了，因为只有Switch中其上的Route没有匹配，才轮到它。</li>
</ul></li>
</ol>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:42c12639-219d-4d3e-aa80-19bf58fe0b97" class="outline-5">
<h5 id="h:42c12639-219d-4d3e-aa80-19bf58fe0b97">登录组件</h5>
<div class="outline-text-5" id="text-h:42c12639-219d-4d3e-aa80-19bf58fe0b97">
<ul class="org-ul">
<li>在component目录下构建react组件</li>
<li>登录页面模板<a href="https://codepen.io/colorlib/pen/rxddKy?q=login&amp;limit=all&amp;type=type-pens">https://codepen.io/colorlib/pen/rxddKy?q=login&amp;limit=all&amp;type=type-pens</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-py">&lt;div class="login-page"&gt;
&lt;div class="form"&gt;
    &lt;form class="register-form"&gt;
    &lt;input type="text" placeholder="name"/&gt;
    &lt;input type="password" placeholder="password"/&gt;
    &lt;input type="text" placeholder="email address"/&gt;
    &lt;button&gt;create&lt;/button&gt;
    &lt;p class="message"&gt;Already registered? &lt;a href="#"&gt;Sign In&lt;/a&gt;&lt;/p&gt;
    &lt;/form&gt;
    &lt;form class="login-form"&gt;
    &lt;input type="text" placeholder="username"/&gt;
    &lt;input type="password" placeholder="password"/&gt;
    &lt;button&gt;login&lt;/button&gt;
    &lt;p class="message"&gt;Not registered? &lt;a href="#"&gt;Create an account&lt;/a&gt;&lt;/p&gt;
    &lt;/form&gt;
&lt;/div&gt;
&lt;/div&gt;
</pre>
</div>

<ul class="org-ul">
<li>使用这个HTML模板来构建组件</li>
<li><b>特别注意</b>
<ol class="org-ol">
<li>搬到React组件中的时候，要*将class属性改为className*.</li>
<li>所有标签，需要闭合。</li>
</ol></li>

<li><p>
<b>login.js</b>
</p>

<ol class="org-ol">
<li>在component目录下新建login.js的登录组件。</li>
<li>使用上面的模板的HTML中的登录部分，挪到render函数中。
<ul class="org-ul">
<li>修改*class为className*</li>
<li><b>将=&lt;a&gt;=标签替换成=&lt;Link to="?"&gt;=组件</b></li>
<li>注意标签闭合问题</li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26032;&#24314;&#25991;&#20214;src/component/login.js</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">"react-router-dom"</span>;

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Login <span style="color: #a020f0;">extends</span> React.Component {
    render() {
        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"username"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"password"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#36824;&#26410;&#27880;&#20876;&#65311; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/reg"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}
</pre>
</div></li>

<li><p>
<b>在=src/index.js=路由中增加登录组件</b>
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;src/index.js&#25991;&#20214;&#20869;&#23481;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;
<span style="color: #a020f0;">import</span> {Route,Link,BrowserRouter as Router,Switch} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> Login from <span style="color: #8b2252;">"./component/login"</span>;

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">App</span>() {
<span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">Router</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/about"</span> <span style="color: #a0522d;">component</span>={About} /&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/login"</span> <span style="color: #a0522d;">component</span>={Login} /&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">exact</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span> <span style="color: #a0522d;">component</span>={Home} /&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">Router</span>&gt;
);
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">Home</span>() {
<span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">Home</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
);
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">About</span>() {
<span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">About</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
);
}


ReactDom.render(&lt;<span style="color: #0000ff;">App</span> /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>

<ul class="org-ul">
<li>访问=<a href="http://127.0.0.1:3000/login=%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E6%A0%B7%E5%BC%8F">http://127.0.0.1:3000/login=%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E4%BA%86%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E6%A0%B7%E5%BC%8F</a>。</li>
</ul></li>

<li><p>
<b>样式表</b>
</p>

<ul class="org-ul">
<li>在=src/css=中，创建login.css,放入以下内容，然后=src/component/login.js=中导入样式</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">src/component/login.js&#20013;&#23548;&#20837;&#26679;&#24335;&#34920;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-css"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26032;&#24314;src/css/login.css&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
<span style="color: #0000ff;">body</span> {
<span style="color: #a020f0;">background</span>: <span style="color: #ffffff; background-color: #456;">#456</span>;
<span style="color: #a020f0;">font-family</span>: SimSun;
<span style="color: #a020f0;">font-size</span>: 14px;
}

<span style="color: #0000ff;">.login-page</span> {
<span style="color: #a020f0;">width</span>: 360px;
<span style="color: #a020f0;">padding</span>: 8% 0 0;
<span style="color: #a020f0;">margin</span>: auto;
}
<span style="color: #0000ff;">.form</span> {
<span style="color: #a020f0;">font-family</span>: <span style="color: #8b2252;">"Microsoft YaHei"</span>, SimSun;
<span style="color: #a020f0;">position</span>: relative;
<span style="color: #a020f0;">z-index</span>: 1;
<span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #FFFFFF;">#FFFFFF</span>;
<span style="color: #a020f0;">max-width</span>: 360px;
<span style="color: #a020f0;">margin</span>: 0 auto 100px;
<span style="color: #a020f0;">padding</span>: 45px;
<span style="color: #a020f0;">text-align</span>: center;
<span style="color: #a020f0;">box-shadow</span>: 0 0 20px 0 <span style="color: #ffffff; background-color: #000000;">rgba(0, 0, 0, 0.2)</span>, 0 5px 5px 0 <span style="color: #ffffff; background-color: #000000;">rgba(0, 0, 0, 0.24)</span>;
}
<span style="color: #0000ff;">.form input</span> {
<span style="color: #a020f0;">outline</span>: 0;
<span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #f2f2f2;">#f2f2f2</span>;
<span style="color: #a020f0;">width</span>: 100%;
<span style="color: #a020f0;">border</span>: 0;
<span style="color: #a020f0;">margin</span>: 0 0 15px;
<span style="color: #a020f0;">padding</span>: 15px;
<span style="color: #a020f0;">box-sizing</span>: border-box;
<span style="color: #a020f0;">font-size</span>: 14px;
}
<span style="color: #0000ff;">.form button</span> {
<span style="color: #a020f0;">text-transform</span>: uppercase;
<span style="color: #a020f0;">outline</span>: 0;
<span style="color: #a020f0;">background</span>: <span style="color: #000000; background-color: #4CAF50;">#4CAF50</span>;
<span style="color: #a020f0;">width</span>: 100%;
<span style="color: #a020f0;">border</span>: 0;
<span style="color: #a020f0;">padding</span>: 15px;
<span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #FFFFFF;">#FFFFFF</span>;
<span style="color: #a020f0;">font-size</span>: 14px;
<span style="color: #a020f0;">cursor</span>: pointer;
}
<span style="color: #0000ff;">.form button:hover,.form button:active,.form button:focus</span> {
<span style="color: #a020f0;">background</span>: <span style="color: #ffffff; background-color: #43A047;">#43A047</span>;
}
<span style="color: #0000ff;">.form .message</span> {
<span style="color: #a020f0;">margin</span>: 15px 0 0;
<span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #b3b3b3;">#b3b3b3</span>;
<span style="color: #a020f0;">font-size</span>: 12px;
}
<span style="color: #0000ff;">.form .message a</span> {
<span style="color: #a020f0;">color</span>: <span style="color: #000000; background-color: #4CAF50;">#4CAF50</span>;
<span style="color: #a020f0;">text-decoration</span>: none;
}
</pre>
</div>

<ul class="org-ul">
<li>访问=<a href="http://localhost:3000/login=%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2">http://localhost:3000/login=%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2</a></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:0a3a7aa3-8099-4dd9-8a85-8ad470d21dae" class="outline-5">
<h5 id="h:0a3a7aa3-8099-4dd9-8a85-8ad470d21dae">注册组件</h5>
<div class="outline-text-5" id="text-h:0a3a7aa3-8099-4dd9-8a85-8ad470d21dae">
<ul class="org-ul">
<li>与登录组件编写方式差不多，创建=src/component/reg.js=,使用login.css</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/*</span><span style="color: #b22222;">&#26032;&#24314;src/component/reg.js&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Reg <span style="color: #a020f0;">extends</span> React.Component {
    render(){
        <span style="color: #a020f0;">return</span>(
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"register-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"name"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span> /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#30830;&#35748;&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#22914;&#26524;&#24050;&#32463;&#27880;&#20876; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}
</pre>
</div>

<ul class="org-ul">
<li>在=src/index.js=中增加一条静态路由</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">src/index.js&#20013;&#20462;&#25913;</span><span style="color: #b22222;">*/</span>
<span style="color: #a020f0;">import</span> Reg from <span style="color: #8b2252;">"./component/reg"</span>;

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">App</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;Router&gt;
      &lt;div&gt;
          &lt;Route path=<span style="color: #8b2252;">"/about"</span> component={About} /&gt;
          &lt;Route path=<span style="color: #8b2252;">"/login"</span> component={Login} /&gt;
          &lt;Route path=<span style="color: #8b2252;">"/reg"</span> component={Reg} /&gt;
          &lt;Route exact path=<span style="color: #8b2252;">"/"</span> component={Home} /&gt;
      &lt;/div&gt;
    &lt;/Router&gt;
  );
}
</pre>
</div>

<ul class="org-ul">
<li>访问=<a href="http://localhost:3000/reg=%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2">http://localhost:3000/reg=%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:eedefb16-14c9-4816-bf60-1d98b8b80327" class="outline-5">
<h5 id="h:eedefb16-14c9-4816-bf60-1d98b8b80327">导航栏链接</h5>
<div class="outline-text-5" id="text-h:eedefb16-14c9-4816-bf60-1d98b8b80327">
<ul class="org-ul">
<li>在index.js中增加导航栏链接，方便页面切换</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;src/index.js&#25991;&#20214;</span><span style="color: #b22222;">*/</span>
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">App</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;Router&gt;
      &lt;div&gt;
          &lt;div&gt;
            &lt;ul&gt;
              &lt;li&gt;&lt;Link to=<span style="color: #8b2252;">"/"</span>&gt;&#20027;&#39029;&lt;/Link&gt;&lt;/li&gt;
              &lt;li&gt;&lt;Link to=<span style="color: #8b2252;">"/login"</span>&gt;&#30331;&#24405;&lt;/Link&gt;&lt;/li&gt;
              &lt;li&gt;&lt;Link to=<span style="color: #8b2252;">"/reg"</span>&gt;&#27880;&#20876;&lt;/Link&gt;&lt;/li&gt;
              &lt;li&gt;&lt;Link to=<span style="color: #8b2252;">"/about"</span>&gt;&#20851;&#20110;&lt;/Link&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/div&gt;
          &lt;Route path=<span style="color: #8b2252;">"/about"</span> component={About} /&gt;
          &lt;Route path=<span style="color: #8b2252;">"/login"</span> component={Login} /&gt;
          &lt;Route path=<span style="color: #8b2252;">"/reg"</span> component={Reg} /&gt;
          &lt;Route exact path=<span style="color: #8b2252;">"/"</span> component={Home} /&gt;
      &lt;/div&gt;
    &lt;/Router&gt;
  );
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5a32628c-dab9-4154-9733-b2bdc87e9c70" class="outline-5">
<h5 id="h:5a32628c-dab9-4154-9733-b2bdc87e9c70">分层</h5>
<div class="outline-text-5" id="text-h:5a32628c-dab9-4154-9733-b2bdc87e9c70">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">层次</th>
<th scope="col" class="org-left">作用</th>
<th scope="col" class="org-left">路径</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">视图层</td>
<td class="org-left">负责数据呈现，负责用户交互界面</td>
<td class="org-left"><code>src/component/xxx.js</code></td>
</tr>

<tr>
<td class="org-left">服务层</td>
<td class="org-left">负责业务逻辑处理</td>
<td class="org-left"><code>src/service/xxx.js</code></td>
</tr>

<tr>
<td class="org-left">Model层</td>
<td class="org-left">数据持久化</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:6dd995b4-6cf1-42b9-ab10-f735a8aae72a" class="outline-5">
<h5 id="h:6dd995b4-6cf1-42b9-ab10-f735a8aae72a">登录功能实现</h5>
<div class="outline-text-5" id="text-h:6dd995b4-6cf1-42b9-ab10-f735a8aae72a">
<ul class="org-ul">
<li>view层，登录组件和用户交互。相当于button点击触发onclick,调用事件响应函数handleClick,handleClick中调用服务service层login函数。</li>
<li>service层，负责业务逻辑处理。调用Model层数据操作函数</li>
<li>新建=src/service/user.js=处理调用逻辑</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#26032;&#24314;src/service/user.js&#36923;&#36753;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> UserService {
    login (email,password) {
        <span style="color: #b22222;">//</span><span style="color: #b22222;">Tood</span>
    }
}
</pre>
</div>

<ul class="org-ul">
<li>修改=src/component/login.js=文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;`src/component/login.js`&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>;

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Login <span style="color: #a020f0;">extends</span> React.Component {
    handleClick(event){
        console.log(event.target)
    }

    render() {
        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"password"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#36824;&#26410;&#27880;&#20876;&#65311; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"#"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}
</pre>
</div>

<ol class="org-ol">
<li>问题：
<ul class="org-ul">
<li>页面提交
<ol class="org-ol">
<li>这次发现有一些问题，按钮点击会提交，导致页面刷新了。要阻止页面刷新，其实就是阻止提交。使用event.preventDefault()。</li>
</ol></li>
<li>如何拿到邮箱和密码？
<ol class="org-ol">
<li>=event.target.form=返回暗流所在表单，可以看做一个数组。</li>
<li>=fm[0].value=和=fm[1].value=就是文本框的值。</li>
</ol></li>
<li>如何在Login组件中使用UserService实例呢？
<ol class="org-ol">
<li>使用全局变量，虽然可以，但不好。</li>
<li>可以在Login的构造器中通过属性注入。</li>
<li>也可以在外部使用props注入。使用这种方式。</li>
</ol></li>
</ul></li>

<li>修改，保证在login组件中使用UserService，使用属性注入</li>
</ol>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;src/component/login.js&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>;
<span style="color: #a020f0;">import</span> UserService from <span style="color: #8b2252;">"../service/user"</span>;

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">serviec</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">UserService</span>();

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Login <span style="color: #a020f0;">extends</span> React.Component{
    render(){
        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">_Login</span> <span style="color: #a0522d;">service</span>={serviec} /&gt;;
    }
}

<span style="color: #a020f0;">class</span> _Login <span style="color: #a020f0;">extends</span> React.Component {
    handleClick(event){
        event.preventDefault(); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38459;&#27490;from&#34920;&#21333;&#25552;&#20132;</span><span style="color: #b22222;"> */</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">fm</span> = event.target.form;
        <span style="color: #008b8b;">this</span>.props.service.login(fm[0].value,fm[1].value)
    }

    render() {
        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"password"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#36824;&#26410;&#27880;&#20876;&#65311; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"#"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:ac22f960-259b-472e-8eca-566447347475"></a>UserService的login方法实现<br>
<div class="outline-text-6" id="text-h:ac22f960-259b-472e-8eca-566447347475">
<ol class="org-ol">
<li><p>
<b>代理配置</b>
</p>
<ul class="org-ul">
<li>修改webpack.config.dev.jsw文件中proxy部分，保证proxy的target是后台服务的地址和端口，且要开启后台服务。</li>
<li>注意：修改这个配置，需要重启dev server</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;webpack.config.dev.jsw&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
devServer: {
    compress: <span style="color: #008b8b;">true</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">gzip</span><span style="color: #b22222;"> */</span>
    <span style="color: #b22222;">//</span><span style="color: #b22222;">host:'192.168.61.109', /* &#35774;&#32622;ip */</span>
    port: 3000,
    publicPath: <span style="color: #8b2252;">'/assets/'</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;bundled files&#27983;&#35272;&#22120;&#31471;&#35775;&#38382;&#22320;&#22336;</span><span style="color: #b22222;"> */</span>
    hot: <span style="color: #008b8b;">true</span>,  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24320;&#21551;HMR&#28909;&#27169;&#22359;&#26367;&#25442;</span><span style="color: #b22222;"> */</span>
    inline: <span style="color: #008b8b;">true</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25511;&#21046;&#27983;&#35272;&#22120;&#25511;&#21046;&#21488;&#26159;&#21542;&#26174;&#31034;&#20449;&#24687;</span><span style="color: #b22222;"> */</span>
    historyApiFallback: <span style="color: #008b8b;">true</span>,
    stats: {
        chunks: <span style="color: #008b8b;">false</span>
    },
    proxy: { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20195;&#29702;</span>
        <span style="color: #8b2252;">'/api'</span>: {
            target: <span style="color: #8b2252;">'http://127.0.0.1:8000'</span>,
            changeOrigin: <span style="color: #008b8b;">true</span>
        }
    }
}
</pre>
</div></li>

<li><b>axios异步库</b>
<ul class="org-ul">
<li>axios是一个基于Promise的HTTP异步库，可以用在浏览器或nodejs中。</li>
<li>使用axios发起异步调用，完成POST、GET方法的数据提交。可以查照官网的例子。中文说明<a href="https://www.kancloud.cn/yunye/axios/234845">https://www.kancloud.cn/yunye/axios/234845</a></li>

<li><b>安装npm</b> <code>$ npm install axios=或=yarn add axios</code>
<ul class="org-ul">
<li>注意：如果使用yarn安装，就不要再使用npm安装包了，以免出现问题。</li>
</ul></li>
<li><p>
<b>导入</b> <code>import axios from 'axios'</code>;
</p>
<ul class="org-ul">
<li>修改=service/user.js=如下</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">"axios"</span>;

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> UserService {
    login (email,password) {
        console.log(email,password);

        axios.post(<span style="color: #8b2252;">"/api/users/login"</span>,{
            email:email,
            password:password
        }) <span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then( <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#36820;&#22238;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span> (<span style="color: #a0522d;">response</span>){
                console.log(response);
                console.log(response.data)
                console.log(<span style="color: #8b2252;">"response.status: "</span> + response.status);
                console.log(response.statusText);
                console.log(response.headers);
                console.log(response.config);
            }
        ).<span style="color: #a020f0;">catch</span>(<span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20986;&#38169;&#21518;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span>(<span style="color: #a0522d;">error</span>){
                console.log(error);
            }
        )
    }
}
</pre>
</div></li>

<li>问题：
<ol class="org-ol">
<li>404
填入邮箱，密码，点击登录，返回404，查看发现访问的地址是=<a href="http://127.0.0.1:3000/api/users/login=,%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%A4%9A%E4%BA%86=/api">http://127.0.0.1:3000/api/users/login=,%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%A4%9A%E4%BA%86=/api</a>=。</li>

<li>解决：

<ol class="org-ol">
<li>修改blog
server的代码的路由匹配规则(不建议这么做，影响比较大)</li>
<li><b>rewrite</b>,类似httpd,nginx等的rewrite功能。本次测试使用的是dev
server，去官方看看。<a href="https://webpack.js.org/configuration/dev-server/#devserver-proxy">https://webpack.js.org/configuration/dev-server/#devserver-proxy</a>可以看到pathRewrite可以完成路由重写。</li>
</ol></li>

<li><p>
修改=webpack.config.dev.js=文件
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;webpack.config.dev.js&#25991;&#20214;&#20013;&#23545;&#24212;&#20869;&#23481;</span><span style="color: #b22222;">*/</span>
devServer: {
    compress: <span style="color: #008b8b;">true</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">gzip</span><span style="color: #b22222;"> */</span>
    <span style="color: #b22222;">//</span><span style="color: #b22222;">host:'192.168.61.109', /* &#35774;&#32622;ip */</span>
    port: 3000,
    publicPath: <span style="color: #8b2252;">'/assets/'</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#35774;&#32622;bundled files&#27983;&#35272;&#22120;&#31471;&#35775;&#38382;&#22320;&#22336;</span><span style="color: #b22222;"> */</span>
    hot: <span style="color: #008b8b;">true</span>,  <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#24320;&#21551;HMR&#28909;&#27169;&#22359;&#26367;&#25442;</span><span style="color: #b22222;"> */</span>
    inline: <span style="color: #008b8b;">true</span>, <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25511;&#21046;&#27983;&#35272;&#22120;&#25511;&#21046;&#21488;&#26159;&#21542;&#26174;&#31034;&#20449;&#24687;</span><span style="color: #b22222;"> */</span>
    historyApiFallback: <span style="color: #008b8b;">true</span>,
    stats: {
        chunks: <span style="color: #008b8b;">false</span>
    },
    proxy: { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20195;&#29702;</span>
        <span style="color: #8b2252;">'/api'</span>: {
            target: <span style="color: #8b2252;">'http://127.0.0.1:8000'</span>,
            pathRewrite: {<span style="color: #8b2252;">"^/api"</span> : <span style="color: #8b2252;">""</span>}, <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23558;&#25152;&#26377;&#20195;&#29702;&#20146;&#25114;&#20013;&#24050;/api&#24320;&#22836;&#30340;&#35831;&#27714;&#20013;&#23545;&#24212;&#23383;&#31526;&#26367;&#25442;&#25104;&#31354;</span>
            changeOrigin: <span style="color: #008b8b;">true</span>
        }
    }
}
</pre>
</div>

<ul class="org-ul">
<li>重启dev
server.使用正确的邮箱，密码登录，返回了json数据，在response.data中可以看到token、user。</li>
</ul></li>
</ol></li>
</ul></li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:391c0e6b-fd59-44a2-ad47-c9e660db47ff" class="outline-4">
<h4 id="h:391c0e6b-fd59-44a2-ad47-c9e660db47ff">token持久化&#x2013;LocalStorage</h4>
<div class="outline-text-4" id="text-h:391c0e6b-fd59-44a2-ad47-c9e660db47ff">
<ul class="org-ul">
<li>使用LocalStorage来存储token。</li>
<li>LocalStorage是HTML5标准增加的技术，是浏览器端持久化方案之一。</li>
<li>LocalStorage是为了存储浏览器得到的数据，例如JSON。</li>
<li>数据存储时键值对。数据会存储在不同的域名下面。</li>
<li>不同浏览器对单个域名下存储的数据的长度支持不同,有的最多支持2MB。</li>
<li>在Charmo浏览器中查看，如下</li>
<li>SessionStorage和LocalStorage功能差不多，只不过SessionStorage是会话级的，浏览器关闭，会话结束，数据清除。而LocalStorage可以持久保存。</li>
<li>indexedDB
<ol class="org-ol">
<li>一个域一个datatable</li>
<li>key-value检索方式</li>
<li>建立在关系型的数据模型之上，具有索引表、游标、事务等概念</li>
</ol></li>
<li><b>store.js</b>
<ol class="org-ol">
<li>store.js是一个兼容所有浏览器的LocalStorage包装器，不需要借助Cookie或者Flash。</li>
<li>store.js会根据浏览器自动选择使用localStorage、globalStorage或者userData来实现本地存储功能。</li>
</ol></li>
<li>*安装*=npm i store=或=yarn add store=</li>
<li><b>测试代码</b>
<ol class="org-ol">
<li><p>
编写一个test.js,使用node exec插件按F8执行
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">let</span> <span style="color: #a0522d;">store</span> = require(<span style="color: #8b2252;">"store"</span>);

store.set(<span style="color: #8b2252;">"user"</span>,<span style="color: #8b2252;">"xdd"</span>);
console.log(store.get(<span style="color: #8b2252;">"user"</span>));

store.remove(<span style="color: #8b2252;">"user"</span>);
console.log(store.get(<span style="color: #8b2252;">"user"</span>)); <span style="color: #b22222;">// </span><span style="color: #b22222;">undefined</span>
console.log(store.get(<span style="color: #8b2252;">"user"</span>,<span style="color: #8b2252;">"a"</span>)); <span style="color: #b22222;">//</span><span style="color: #b22222;">a</span>

store.set(<span style="color: #8b2252;">"user"</span>,{name:<span style="color: #8b2252;">"xdd"</span>,age:30});
console.log(store.get(<span style="color: #8b2252;">"user"</span>).name);

store.set(<span style="color: #8b2252;">"school"</span>,{name:<span style="color: #8b2252;">"magedu"</span>});

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#36941;&#21382;&#25152;&#26377;&#38190;&#20540;&#23545;</span>
store.each(<span style="color: #a020f0;">function</span>(<span style="color: #a0522d;">value</span>,<span style="color: #a0522d;">key</span>){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27880;&#24847;&#36825;&#37324;key&#65292;value&#26159;&#21453;&#30340;</span>
    console.log(key,<span style="color: #8b2252;">"--&gt;"</span>,value)
})

<span style="color: #b22222;">//</span><span style="color: #b22222;">&#28165;&#38500;&#25152;&#26377;&#38190;&#20540;&#23545;</span>
store.clearAll()

console.log(store.get(<span style="color: #8b2252;">"user"</span>));<span style="color: #b22222;">// </span><span style="color: #b22222;">undefined</span>
</pre>
</div></li>
</ol></li>
</ul>


<ol class="org-ol">
<li><p>
安装store的同时，也安装了expire过期插件，可以在把kv对存储到LS中的时候顺便加入过期时长。
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">let</span> <span style="color: #a0522d;">store</span> = require(<span style="color: #8b2252;">"store"</span>);
<span style="color: #b22222;">//</span><span style="color: #b22222;">&#19968;&#23450;&#35201;&#21152;&#36733;&#25554;&#20214;&#65292;&#21542;&#21017;key&#19981;&#20250;&#36807;&#26399;</span>
store.addPlugin(require(<span style="color: #8b2252;">"store/plugins/expire"</span>));

<span style="color: #a020f0;">let</span> <span style="color: #a0522d;">d</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>();
store.set(<span style="color: #8b2252;">"user"</span>,<span style="color: #8b2252;">"xdd"</span>,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime() + (5 * 1000)); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27880;&#24847;&#26102;&#38388;&#21333;&#20301;</span>

setInterval(() =&gt; console.log(store.get(<span style="color: #8b2252;">"user"</span>,<span style="color: #8b2252;">"abc"</span>)),1000);
</pre>
</div></li>
</ol>


<ol class="org-ol">
<li><p>
下面是准备写在service中的代码
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">"store"</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">"store/plugins/expire"</span>;

store.addPlugin(expire)
<span style="color: #b22222;">//</span><span style="color: #b22222;">&#23384;&#20648;token</span>
store.set(<span style="color: #8b2252;">"token"</span>,res.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime() + (8*3600*1000));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20462;&#25913;&#23545;&#24212;&#30340;src/service/user.js&#25991;&#20214;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">"axios"</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">"store"</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">"store/plugins/expire"</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#36807;&#26399;&#25554;&#20214;</span>
store.addPlugin(expire)

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> UserService {
    login (email,password) {
        console.log(email,password);

        axios.post(<span style="color: #8b2252;">"/api/users/login"</span>,{
            email:email,
            password:password
        }) <span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then( <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#36820;&#22238;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span> (<span style="color: #a0522d;">response</span>){
                console.log(response.data)
                console.log(<span style="color: #8b2252;">"response.status: "</span> + response.status);
                <span style="color: #b22222;">// </span><span style="color: #b22222;">&#23384;&#20648;token,&#27880;&#24847;&#38656;&#35201;&#37325;&#24320;&#19968;&#27425;chrome&#30340;&#35843;&#35797;&#31383;&#21475;&#25165;&#33021;&#30475;&#21040;</span>
                store.set(<span style="color: #8b2252;">"token"</span>,response.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime() + (8*3600*1000));
            }
        ).<span style="color: #a020f0;">catch</span>(<span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20986;&#38169;&#21518;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span>(<span style="color: #a0522d;">error</span>){
                console.log(error);
            }
        )
    }
}
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:a34ba445-8806-4a4e-9d89-336c702220f3" class="outline-4">
<h4 id="h:a34ba445-8806-4a4e-9d89-336c702220f3">Mobx状态管理</h4>
<div class="outline-text-4" id="text-h:a34ba445-8806-4a4e-9d89-336c702220f3">
<ul class="org-ul">
<li><b>Redux和Mobx</b>
<ol class="org-ol">
<li>社区提供的状态管理库，有Redux和Mobx。</li>
<li>Redux代码优秀，使用严格的函数式编程思想，学习曲线陡峭，小项目使用的优劣不明显。</li>
<li>Mobx，非常优秀稳定的库，简单方便，适合中小项目使用。使用面向对象的方式，容易学习和接受。现在在中小项目中使用也非常广泛。Mobx和React也是一对强力组合。
<ul class="org-ul">
<li>Mobx官网<a href="https://mobx.js.org/">https://mobx.js.org/</a></li>
<li>Mobx中文网<a href="https://cn.mobx.js.org/">https://cn.mobx.js.org/</a><br></li>
<li>Mobx是由Mendix、Coinbase、Facebook开源，它实现了观察者模式。</li>
</ul></li>
</ol></li>
<li><b>观察者模式</b>
<ol class="org-ol">
<li>观察者模式，也称为*发布订阅模式*。观察者观察某个目标，目标对象(Obserable)状态发生了变化，会通知自己内部注册了的观察者Observer。</li>
</ol></li>
<li><b>状态管理</b>
<ol class="org-ol">
<li>需求：
<ul class="org-ul">
<li>一个组件的onClick触发事件响应函数，此函数会调用后台服务。但是后台服务比较耗时，等处理完，需要引起组件的渲染操作。</li>
<li>要组件渲染，就需要改变组件的props或state。</li>
</ul></li>
<li><b>同步调用</b>
<ul class="org-ul">
<li>同步调用中，实际上就是等着耗时的函数返回</li>
</ul></li>
<li><b>异步调用</b>
<ul class="org-ul">
<li>思路一,使用setTimeout问题
<ol class="org-ol">
<li>无法向内部的等待执行函数传入参数，比如Root实例。</li>
<li>延时执行的函数的返回值无法取到，所以无法通知Root</li>
</ol></li>
<li><p>
思路二、Promise异步执行
</p>
<ol class="org-ol">
<li>Promise异步执行，如果成功，将调用回调。<br></li>
<li><b>不管render中是否显示state的值，只要state改变，都会触发render执行</b></li>
</ol>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21487;&#20197;&#22312;src/index.js&#20013;&#20462;&#25913;&#27979;&#35797;&#20195;&#30721;&#22914;&#19979;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;

<span style="color: #a020f0;">class</span> Service{
    handle(obj){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">Promise</span>
        <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Promise</span>((resolve,reject) =&gt; {
            <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23450;&#26102;&#22120;5&#31186;&#21518;&#36820;&#22238;ok</span>
            setTimeout(() =&gt; resolve(<span style="color: #8b2252;">"ok"</span>), 5000);
        }).then(value =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#25191;&#34892;</span>
        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20351;&#29992;obj</span>
        obj.setState({ret:(Math.random()*1000)});
        }
        )
    }
}

<span style="color: #a020f0;">class</span> Root <span style="color: #a020f0;">extends</span> React.Component{
    state = {ret:<span style="color: #008b8b;">null</span>}
    handleClick(event){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24322;&#27493;&#19981;&#33021;&#30452;&#25509;&#20351;&#29992;&#36820;&#22238;&#20540;</span>
        <span style="color: #008b8b;">this</span>.props.service.handle(<span style="color: #008b8b;">this</span>);
    }

    render(){
        console.log(<span style="color: #8b2252;">"*****************"</span>)
        <span style="color: #a020f0;">return</span> (
        &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#35302;&#21457;handleClick&#20989;&#25968;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">span</span> <span style="color: #a0522d;">style</span>={{color:<span style="color: #8b2252;">"red"</span>}}&gt;<span style="color: #000000; background-color: #ffffff;"> </span>{<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>().getTime()}<span style="color: #000000; background-color: #ffffff;"> Service&#20013;&#20462;&#25913;state&#30340;&#20540;&#26159;</span>{<span style="color: #008b8b;">this</span>.state.ret}&lt;/<span style="color: #0000ff;">span</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}

ReactDom.render(&lt;<span style="color: #0000ff;">Root</span> <span style="color: #a0522d;">service</span>={<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Service</span>()} /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div></li>
</ul></li>
</ol></li>
</ul>


<ol class="org-ol">
<li><p>
Mobx实现
</p>
<ul class="org-ul">
<li><b>observable装饰器：设置被观察者</b></li>
<li><b>observer装饰器：设置观察者，将React组件转换为响应式组件</b></li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">&#21487;&#20197;&#22312;src/index.js&#20013;&#20462;&#25913;&#27979;&#35797;&#20195;&#30721;&#22914;&#19979;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">'mobx'</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">"mobx-react"</span>

<span style="color: #a020f0;">class</span> Service{
    @observable ret = -100;

    handle(obj){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">Promise</span>
        <span style="color: #a020f0;">new</span> <span style="color: #228b22;">Promise</span>((resolve,reject) =&gt; {
            <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23450;&#26102;&#22120;5&#31186;&#21518;&#36820;&#22238;ok</span>
            setTimeout(() =&gt; resolve(<span style="color: #8b2252;">"ok"</span>), 5000);
        }).then(value =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#25191;&#34892;</span>
            <span style="color: #008b8b;">this</span>.ret = Math.random()*1000;
        }
        )
    }
}

@observer <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23558;react&#32452;&#20214;&#36716;&#25442;&#20026;&#21709;&#24212;&#24335;&#32452;&#20214;</span>
<span style="color: #a020f0;">class</span> Root <span style="color: #a020f0;">extends</span> React.Component{
    <span style="color: #b22222;">// </span><span style="color: #b22222;">state = {ret:null} //&#19981;&#20351;&#29992;state&#20102;</span>
    handleClick(event){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24322;&#27493;&#19981;&#33021;&#30452;&#25509;&#20351;&#29992;&#36820;&#22238;&#20540;</span>
        <span style="color: #008b8b;">this</span>.props.service.handle(<span style="color: #008b8b;">this</span>);
    }

    render(){
        console.log(<span style="color: #8b2252;">"*****************"</span>)
        <span style="color: #a020f0;">return</span> (
        &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#35302;&#21457;handleClick&#20989;&#25968;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">span</span> <span style="color: #a0522d;">style</span>={{color:<span style="color: #8b2252;">"red"</span>}}&gt;<span style="color: #000000; background-color: #ffffff;"> </span>{<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>().getTime()}<span style="color: #000000; background-color: #ffffff;"> Service&#20013;&#20462;&#25913;state&#30340;&#20540;&#26159;</span>{<span style="color: #008b8b;">this</span>.props.service.ret <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#20351;&#29992;&#65292;&#24403;&#20540;&#25913;&#21464;render&#23601;&#19981;&#20250;&#34987;&#35843;&#29992;</span><span style="color: #b22222;"> */</span>}&lt;/<span style="color: #0000ff;">span</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}

ReactDom.render(&lt;<span style="color: #0000ff;">Root</span> <span style="color: #a0522d;">service</span>={<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Service</span>()} /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>

<ul class="org-ul">
<li>Service中被观察者ret变化，导致了观察者调用render函数。</li>
<li>被观察者变化不引起渲染的情况：
<ol class="org-ol">
<li>将root中的rander中={this.props.service.ret}=注释={<i>* this.props.service.ret *</i>}=。可以看到，如果render中不使用这个被观察者，render函数就不会调用。</li>
</ol></li>
<li><b>注意：在观察者render函数中，一定要使用这个被观察对象。</b></li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:60860465-c797-4218-aa59-27a0bd2eb419" class="outline-4">
<h4 id="h:60860465-c797-4218-aa59-27a0bd2eb419">跳转</h4>
<div class="outline-text-4" id="text-h:60860465-c797-4218-aa59-27a0bd2eb419">
<ul class="org-ul">
<li>如果service中ret发生了变化，观察者Login就会被通知到。一般来说，就会跳转到用户界面，需要使用Redirect组件。</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">&#23548;&#20837;Redirect</span>
<span style="color: #a020f0;">import</span> {Link,Redirect} from <span style="color: #8b2252;">'react-router-dom'</span>;

<span style="color: #b22222;">//</span><span style="color: #b22222;">render&#20989;&#25968;&#20013;return</span>
<span style="color: #a020f0;">return</span> &lt;Redirect to=<span style="color: #8b2252;">"/"</span> /&gt;; <span style="color: #b22222;">//</span><span style="color: #b22222;">to&#34920;&#31034;&#36339;&#36716;&#21040;&#21738;&#37324;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a100db74-8fa6-4ff8-b88a-378e282bc6cf" class="outline-4">
<h4 id="h:a100db74-8fa6-4ff8-b88a-378e282bc6cf">Login登录功能代码实现</h4>
<div class="outline-text-4" id="text-h:a100db74-8fa6-4ff8-b88a-378e282bc6cf">
<ol class="org-ol">
<li><p>
=src/service/user.js=文件内容
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/*</span><span style="color: #b22222;">`src/service/user.js`&#25991;&#20214;&#20869;&#23481;</span><span style="color: #b22222;">*/</span>
<span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">"axios"</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">"store"</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">"store/plugins/expire"</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">"mobx"</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#36807;&#26399;&#25554;&#20214;</span>
store.addPlugin(expire)

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> UserService {
    @observable loggedin = <span style="color: #008b8b;">false</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#34987;&#35266;&#23519;&#32773;</span>

    login (email,password) {
        console.log(email,password);

        axios.post(<span style="color: #8b2252;">"/api/users/login"</span>,{
            email:email,
            password:password
        }) <span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then( <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#36820;&#22238;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            (<span style="color: #a020f0;">function</span> (<span style="color: #a0522d;">response</span>){
                console.log(response.data)
                console.log(<span style="color: #8b2252;">"response.status: "</span> + response.status);
                <span style="color: #b22222;">// </span><span style="color: #b22222;">&#23384;&#20648;token,&#27880;&#24847;&#38656;&#35201;&#37325;&#24320;&#19968;&#27425;chrome&#30340;&#35843;&#35797;&#31383;&#21475;&#25165;&#33021;&#30475;&#21040;</span>
                store.set(<span style="color: #8b2252;">"token"</span>,response.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime() + (8*3600*1000));
                <span style="color: #008b8b;">this</span>.loggedin = <span style="color: #008b8b;">true</span>; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#20462;&#25913;&#34987;&#35266;&#23519;&#32773;</span>
            }).bind(<span style="color: #008b8b;">this</span>) <span style="color: #b22222;">/*</span><span style="color: #b22222;">&#27880;&#24847;&#32465;&#23450;this,&#22914;&#26524;&#19981;&#24819;&#21487;&#20197;&#20351;&#29992;&#31661;&#22836;&#20989;&#25968;</span><span style="color: #b22222;">*/</span>
        ).<span style="color: #a020f0;">catch</span>(<span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20986;&#38169;&#21518;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span>(<span style="color: #a0522d;">error</span>){
                console.log(error);
            }
        )
    }
}
</pre>
</div></li>

<li><p>
=src/component/login.js=文件内容
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">/* </span><span style="color: #b22222;">src/component/login.js&#25991;&#20214;&#20869;&#23481;</span><span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link,Redirect} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>;
<span style="color: #a020f0;">import</span> UserService from <span style="color: #8b2252;">"../service/user"</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">"mobx-react"</span>;

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">userService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">UserService</span>();

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Login <span style="color: #a020f0;">extends</span> React.Component{
    render(){
        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">_Login</span> <span style="color: #a0522d;">service</span>={userService} /&gt;;
    }
}

@observer <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23558;react&#32452;&#20214;&#36716;&#25442;&#20026;&#21709;&#24212;&#24335;&#32452;&#20214;</span>
<span style="color: #a020f0;">class</span> _Login <span style="color: #a020f0;">extends</span> React.Component {
    handleClick(event){
        event.preventDefault(); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38459;&#27490;from&#34920;&#21333;&#25552;&#20132;</span><span style="color: #b22222;"> */</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">fm</span> = event.target.form;
        <span style="color: #008b8b;">this</span>.props.service.login(fm[0].value,fm[1].value)
    }

    render() {
        console.log(<span style="color: #008b8b;">this</span>.props.service.loggedin)
        <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">this</span>.props.service.loggedin) {
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Redirect</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span> /&gt;; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24050;&#32463;&#30331;&#24405;&#65292;&#30452;&#25509;&#36339;&#36716;</span>
        }
        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"password"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#36824;&#26410;&#27880;&#20876;&#65311; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"#"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}
</pre>
</div>

<ul class="org-ul">
<li>注意：测试时，开启Django编写的后台服务程序</li>
<li>测试成功，成功登录，写入Localstorage,也实现了跳转</li>
</ul></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-h:355669cf-8ac0-4504-904f-44d75f34b6a0" class="outline-3">
<h3 id="h:355669cf-8ac0-4504-904f-44d75f34b6a0">注册功能代码实现</h3>
<div class="outline-text-3" id="text-h:355669cf-8ac0-4504-904f-44d75f34b6a0">
<p>
[toc]
</p>
</div>
<div id="outline-container-h:362a1e37-f984-4d6c-910f-229ca446b4a6" class="outline-4">
<h4 id="h:362a1e37-f984-4d6c-910f-229ca446b4a6">注册功能实现</h4>
<div class="outline-text-4" id="text-h:362a1e37-f984-4d6c-910f-229ca446b4a6">
<ol class="org-ol">
<li><p>
在service/user.js中增加reg注册函数
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">"axios"</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">"store"</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">"store/plugins/expire"</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">"mobx"</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#36807;&#26399;&#25554;&#20214;</span>
store.addPlugin(expire)

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> UserService {
    @observable loggedin = <span style="color: #008b8b;">false</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#34987;&#35266;&#23519;&#32773;</span>

    <span style="color: #b22222;">// </span><span style="color: #b22222;">&#30331;&#24405;&#20989;&#25968;</span>
    login (email,password) {
        console.log(email,password);

        axios.post(<span style="color: #8b2252;">"/api/users/login"</span>,{
            email:email,
            password:password
        }) <span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then( <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#36820;&#22238;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            (<span style="color: #a020f0;">function</span> (<span style="color: #a0522d;">response</span>){
                console.log(response.data)
                console.log(<span style="color: #8b2252;">"response.status: "</span> + response.status);
                <span style="color: #b22222;">// </span><span style="color: #b22222;">&#23384;&#20648;token,&#27880;&#24847;&#38656;&#35201;&#37325;&#24320;&#19968;&#27425;chrome&#30340;&#35843;&#35797;&#31383;&#21475;&#25165;&#33021;&#30475;&#21040;</span>
                store.set(<span style="color: #8b2252;">"token"</span>,response.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime() + (8*3600*1000));
                <span style="color: #008b8b;">this</span>.loggedin = <span style="color: #008b8b;">true</span>; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#20462;&#25913;&#34987;&#35266;&#23519;&#32773;</span>
            }).bind(<span style="color: #008b8b;">this</span>)
        ).<span style="color: #a020f0;">catch</span>(<span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20986;&#38169;&#21518;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span>(<span style="color: #a0522d;">error</span>){
                console.log(error);
            }
        )
    }

    <span style="color: #b22222;">// </span><span style="color: #b22222;">&#27880;&#20876;&#20989;&#25968;</span>
    reg(name,email,password){
        console.log(name,email,password)

        axios.post(<span style="color: #8b2252;">'/api/users/'</span>,{
            email:email,
            password:password,
            name:name
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {<span style="color: #b22222;">//</span><span style="color: #b22222;">&#27492;&#20989;&#25968;&#35201;&#27880;&#24847;this&#30340;&#38382;&#39064;</span>
                console.log(response.data);
                console.log(response.status);
                <span style="color: #b22222;">// </span><span style="color: #b22222;">* &#23384;&#20648;token&#65292;&#27880;&#24847;&#38656;&#35201;&#37325;&#24320;&#19968;&#27425;chrome&#30340;&#35843;&#35797;&#31383;&#21475;&#25165;&#33021;&#30475;&#21040;</span>
                store.set(<span style="color: #8b2252;">"token"</span>,response.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime()+(8*3600*1000));
                <span style="color: #008b8b;">this</span>.loggedin=<span style="color: #008b8b;">true</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20462;&#25913;&#34987;&#35266;&#23519;&#32773;</span>
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
            }
        )
    }
}
</pre>
</div></li>

<li><p>
修改Reg.js组件
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link, Redirect} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>
<span style="color: #a020f0;">import</span> UserServer from <span style="color: #8b2252;">'../service/user'</span>;
<span style="color: #a020f0;">import</span> { observer } from <span style="color: #8b2252;">'mobx-react'</span>;

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">userserver</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">UserServer</span>;

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Reg <span style="color: #a020f0;">extends</span> React.Component {
    render() {
        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">_Reg</span> <span style="color: #a0522d;">service</span>={userserver} /&gt;
    }
}

@observer
<span style="color: #a020f0;">class</span> _Reg <span style="color: #a020f0;">extends</span> React.Component {
    validate(password,confirmpwd){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#34920;&#21333;&#39564;&#35777;&#20989;&#25968;</span>
        <span style="color: #a020f0;">return</span> password.value === confirmpwd.value
    }

    handleClick(event){
        event.preventDefault();
        <span style="color: #a020f0;">const</span> [<span style="color: #a0522d;">name</span>,<span style="color: #a0522d;">email</span>,<span style="color: #a0522d;">password</span>,<span style="color: #a0522d;">confirmpwd</span>] = event.target.form;
        console.log(<span style="color: #008b8b;">this</span>.validate(password,confirmpwd));<span style="color: #b22222;">// </span><span style="color: #b22222;">+&#35201;&#39564;&#35777;&#34920;&#21333;&#25968;&#25454;&#21518;&#25165;&#21457;&#24448;&#21518;&#21488;</span>
        <span style="color: #008b8b;">this</span>.props.service.reg(name.value,email.value,password.value);
    }

    render(){
        <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">this</span>.props.service.loggedin){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24050;&#32463;&#30331;&#24405;&#30340;&#29992;&#25143;&#19981;&#20801;&#35768;&#27880;&#20876;</span>
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Redirect</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span> /&gt;;
        }
        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"register-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"name"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span> /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#30830;&#35748;&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#22914;&#26524;&#24050;&#32463;&#27880;&#20876; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }
}
</pre>
</div>

<ul class="org-ul">
<li>测试发现，重新登录，登录成功后，点击注册链接，没有跳转到首页，或者先注册，注册成功后，点击登录，还可以再次登录。原因是构造并使用了不同的UserServer实例。</li>
<li>如下，使用同一个UserServer实例(在service/user.js中导出唯一的UserService实例即可)，其他模块直接导入并使用这个实例即可。</li>
</ul></li>

<li><p>
修改service/user.js
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">class</span> UserService {
    <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27492;&#22788;&#30465;&#30053;</span>
}
<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">userService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">UserService</span>();
<span style="color: #a020f0;">export</span> {userService};
<span style="color: #b22222;">// </span><span style="color: #b22222;">&#27880;&#24847;&#65292;&#36824;&#38656;&#35201;&#20462;&#25913;&#23545;&#24212;&#30340;login.js&#20197;&#21450;&#23545;&#24212;&#30340;reg.js&#25991;&#20214;&#20013;&#21516;&#26102;&#21435;&#25481;&#23454;&#20363;&#21270;&#35821;&#21477;&#12290;&#23548;&#20837;&#35821;&#21477;&#20462;&#25913;&#20026;&#65306;</span>
<span style="color: #b22222;">// </span><span style="color: #b22222;">import {userService} from '../service/user';</span>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:187d9f1e-0a28-40ae-b71b-2aa6e7dea296" class="outline-4">
<h4 id="h:187d9f1e-0a28-40ae-b71b-2aa6e7dea296">Ant Design</h4>
<div class="outline-text-4" id="text-h:187d9f1e-0a28-40ae-b71b-2aa6e7dea296">
<ul class="org-ul">
<li>Ant Design蚂蚁金服开源的React UI库。</li>

<li>官网 <a href="https://ant.design/index-cn">https://ant.design/index-cn</a></li>

<li>官方文档 <a href="https://ant.design/docs/react/introduce-cn">https://ant.design/docs/react/introduce-cn</a></li>

<li>安装 <code>npm install antd</code> 或者=yarn add antd=</li>

<li><p>
使用
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> {List} from <span style="color: #8b2252;">'antd'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;antd&#30340;&#32452;&#20214;</span>
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/list/style/css'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;&#32452;&#20214;&#30340;&#26679;&#24335;css</span>

ReactDom.render(&lt;list /&gt;, mountNode);
</pre>
</div>

<p>
每一种组件的详细使用例子，官网都有，需要时查阅官方文档即可
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:1c887c99-a63e-44b3-95cd-0636df68945e" class="outline-4">
<h4 id="h:1c887c99-a63e-44b3-95cd-0636df68945e">信息显示</h4>
<div class="outline-text-4" id="text-h:1c887c99-a63e-44b3-95cd-0636df68945e">
<ul class="org-ul">
<li>网页开发中，不管操作成功与否，有很多提示信息，目前信息都是控制台输出，用户看不到。</li>
<li>使用Antd的message组件显示油耗提示信息。</li>

<li><p>
在service/user.js中增加一个被观察对象
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">"axios"</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">"store"</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">"store/plugins/expire"</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">"mobx"</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#36807;&#26399;&#25554;&#20214;</span>
store.addPlugin(expire)

<span style="color: #a020f0;">class</span> UserService {
    @observable loggedin = <span style="color: #008b8b;">false</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#34987;&#35266;&#23519;&#32773;</span>
    @observable errMsg = <span style="color: #8b2252;">''</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#34987;&#35266;&#23519;&#32773;</span>

    login (email,password) {
        console.log(email,password);

        axios.post(<span style="color: #8b2252;">"/api/users/login"</span>,{
            email:email,
            password:password
        }) <span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then( <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#25104;&#21151;&#21518;&#36820;&#22238;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            (<span style="color: #a020f0;">function</span> (<span style="color: #a0522d;">response</span>){
                console.log(response.data)
                console.log(<span style="color: #8b2252;">"response.status: "</span> + response.status);
                <span style="color: #b22222;">// </span><span style="color: #b22222;">&#23384;&#20648;token,&#27880;&#24847;&#38656;&#35201;&#37325;&#24320;&#19968;&#27425;chrome&#30340;&#35843;&#35797;&#31383;&#21475;&#25165;&#33021;&#30475;&#21040;</span>
                store.set(<span style="color: #8b2252;">"token"</span>,response.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime() + (8*3600*1000));
                <span style="color: #008b8b;">this</span>.loggedin = <span style="color: #008b8b;">true</span>; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#20462;&#25913;&#34987;&#35266;&#23519;&#32773;</span>
            }).bind(<span style="color: #008b8b;">this</span>)
        ).<span style="color: #a020f0;">catch</span>(<span style="color: #b22222;">/* </span><span style="color: #b22222;">&#20986;&#38169;&#21518;&#25191;&#34892;&#20989;&#25968;</span><span style="color: #b22222;"> */</span>
            <span style="color: #a020f0;">function</span>(<span style="color: #a0522d;">error</span>){
                console.log(error);
                <span style="color: #008b8b;">this</span>.errMsg = <span style="color: #8b2252;">'&#30331;&#24405;&#22833;&#36133;'</span>;
            }.bind(<span style="color: #008b8b;">this</span>)
        )
    }

    reg(name,email,password){
        console.log(name,email,password)

        axios.post(<span style="color: #8b2252;">'/api/users/'</span>,{
            email:email,
            password:password,
            name:name
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server&#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {<span style="color: #b22222;">//</span><span style="color: #b22222;">&#27492;&#20989;&#25968;&#35201;&#27880;&#24847;this&#30340;&#38382;&#39064;</span>
                console.log(response.data);
                console.log(response.status);
                <span style="color: #b22222;">// </span><span style="color: #b22222;">* &#23384;&#20648;token&#65292;&#27880;&#24847;&#38656;&#35201;&#37325;&#24320;&#19968;&#27425;chrome&#30340;&#35843;&#35797;&#31383;&#21475;&#25165;&#33021;&#30475;&#21040;</span>
                store.set(<span style="color: #8b2252;">"token"</span>,response.data.token,(<span style="color: #a020f0;">new</span> <span style="color: #228b22;">Date</span>()).getTime()+(8*3600*1000));
                <span style="color: #008b8b;">this</span>.loggedin=<span style="color: #008b8b;">true</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20462;&#25913;&#34987;&#35266;&#23519;&#32773;</span>
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.errMsg = <span style="color: #8b2252;">"&#27880;&#20876;&#22833;&#36133;"</span> <span style="color: #b22222;">//</span><span style="color: #b22222;">+&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">userService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">UserService</span>();
<span style="color: #a020f0;">export</span> {userService};
</pre>
</div></li>

<li><p>
在component/login.js文件中的 _Login组件，增加Antd的message组件
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link,Redirect} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>;
<span style="color: #a020f0;">import</span> {userService} from <span style="color: #8b2252;">"../service/user"</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">"mobx-react"</span>;
<span style="color: #a020f0;">import</span> {message} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20351;&#29992;&#28040;&#24687;&#26694;&#26679;&#24335;&#34920;</span>

<span style="color: #b22222;">// </span><span style="color: #b22222;">const userService = new userService;</span>

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Login <span style="color: #a020f0;">extends</span> React.Component{
    render(){
        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">_Login</span> <span style="color: #a0522d;">service</span>={userService} /&gt;;
    }
}

@observer <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23558;react&#32452;&#20214;&#36716;&#25442;&#20026;&#21709;&#24212;&#24335;&#32452;&#20214;</span>
<span style="color: #a020f0;">class</span> _Login <span style="color: #a020f0;">extends</span> React.Component {
    handleClick(event){
        event.preventDefault(); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38459;&#27490;from&#34920;&#21333;&#25552;&#20132;</span><span style="color: #b22222;"> */</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">fm</span> = event.target.form;
        <span style="color: #008b8b;">this</span>.props.service.login(fm[0].value,fm[1].value)
    }

    render() {
        <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">this</span>.props.service.loggedin) {
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Redirect</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span> /&gt;; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24050;&#32463;&#30331;&#24405;&#65292;&#30452;&#25509;&#36339;&#36716;</span>
        }

        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">em</span> = <span style="color: #008b8b;">this</span>.props.service.errMsg; <span style="color: #b22222;">//</span><span style="color: #b22222;">(&#24517;&#39035;&#20351;&#29992;)&#25165;&#33021;&#35302;&#21457;</span>

        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"password"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#36824;&#26410;&#27880;&#20876;&#65311; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/reg"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.errMsg){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#30331;&#24405;&#22833;&#36133;&#65292;&#21017;&#24377;&#20986;&#28040;&#24687;&#26694;</span>
            message.info(prevProps.service.errMsg,3,setTimeout(() =&gt; prevProps.service.errMsg = <span style="color: #8b2252;">''</span>,1000))
        }
    }
}
</pre>
</div></li>

<li><p>
component/reg.js中_Reg组件同样增加message组件
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link, Redirect} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>
<span style="color: #a020f0;">import</span> {userService} from <span style="color: #8b2252;">'../service/user'</span>;
<span style="color: #a020f0;">import</span> { observer } from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {message} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">const userserver = new UserServer;</span>

<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Reg <span style="color: #a020f0;">extends</span> React.Component {
    render() {
        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">_Reg</span> <span style="color: #a0522d;">service</span>={userService} /&gt;
    }
}

@observer
<span style="color: #a020f0;">class</span> _Reg <span style="color: #a020f0;">extends</span> React.Component {
    validate(password,confirmpwd){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#34920;&#21333;&#39564;&#35777;&#20989;&#25968;</span>
        <span style="color: #a020f0;">return</span> password.value === confirmpwd.value
    }

    handleClick(event){
        event.preventDefault();
        <span style="color: #a020f0;">const</span> [<span style="color: #a0522d;">name</span>,<span style="color: #a0522d;">email</span>,<span style="color: #a0522d;">password</span>,<span style="color: #a0522d;">confirmpwd</span>] = event.target.form;
        console.log(<span style="color: #008b8b;">this</span>.validate(password,confirmpwd));<span style="color: #b22222;">// </span><span style="color: #b22222;">+&#35201;&#39564;&#35777;&#34920;&#21333;&#25968;&#25454;&#21518;&#25165;&#21457;&#24448;&#21518;&#21488;</span>
        <span style="color: #008b8b;">this</span>.props.service.reg(name.value,email.value,password.value);
    }

    render(){
        <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">this</span>.props.service.loggedin){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24050;&#32463;&#30331;&#24405;&#30340;&#29992;&#25143;&#19981;&#20801;&#35768;&#27880;&#20876;</span>
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Redirect</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span> /&gt;;
        }

        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">em</span> = <span style="color: #008b8b;">this</span>.props.service.errMsg;

        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"register-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"name"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span> /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#30830;&#35748;&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#22914;&#26524;&#24050;&#32463;&#27880;&#20876; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.errMsg){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27880;&#20876;&#22833;&#36133;&#65292;&#21017;&#24377;&#20986;&#28040;&#24687;&#26694;</span>
            message.info(prevProps.service.errMsg,3,setTimeout(() =&gt; prevProps.service.errMsg = <span style="color: #8b2252;">''</span>,1000))
        }
    }

}
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:7bd98031-5ec4-443d-a7ad-60ff1c30f4fe" class="outline-4">
<h4 id="h:7bd98031-5ec4-443d-a7ad-60ff1c30f4fe">进阶装饰器</h4>
<div class="outline-text-4" id="text-h:7bd98031-5ec4-443d-a7ad-60ff1c30f4fe">
<ol class="org-ol">
<li><p>
新建src/utils.js放入以下内容
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">inject</span> = obj =&gt; Comp =&gt; props =&gt; &lt;<span style="color: #0000ff;">Comp</span> {...obj} {...props} /&gt;

<span style="color: #a020f0;">export</span> {inject}
</pre>
</div></li>

<li>将登陆、注册组件装饰一下

<ul class="org-ul">
<li><p>
reg.js修改如下：
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link, Redirect} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>
<span style="color: #a020f0;">import</span> {userService as service} from <span style="color: #8b2252;">'../service/user'</span>;
<span style="color: #a020f0;">import</span> { observer } from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {message} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">export default class Reg extends React.Component {</span>
<span style="color: #b22222;">//     </span><span style="color: #b22222;">render() {</span>
<span style="color: #b22222;">//         </span><span style="color: #b22222;">return &lt;_Reg service={userService} /&gt;</span>
<span style="color: #b22222;">//     </span><span style="color: #b22222;">}</span>
<span style="color: #b22222;">// </span><span style="color: #b22222;">}</span>

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#27880;&#24847;&#35013;&#39280;&#22120;&#39034;&#24207;</span>
@inject({service}) <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#35013;&#39280;&#22120;&#27880;&#20837;&#23646;&#24615;</span>
@observer
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> _Reg <span style="color: #a020f0;">extends</span> React.Component {
    validate(password,confirmpwd){
        <span style="color: #b22222;">//</span><span style="color: #b22222;">&#34920;&#21333;&#39564;&#35777;&#20989;&#25968;</span>
        <span style="color: #a020f0;">return</span> password.value === confirmpwd.value
    }

    handleClick(event){
        event.preventDefault();
        <span style="color: #a020f0;">const</span> [<span style="color: #a0522d;">name</span>,<span style="color: #a0522d;">email</span>,<span style="color: #a0522d;">password</span>,<span style="color: #a0522d;">confirmpwd</span>] = event.target.form;
        console.log(<span style="color: #008b8b;">this</span>.validate(password,confirmpwd));<span style="color: #b22222;">// </span><span style="color: #b22222;">+&#35201;&#39564;&#35777;&#34920;&#21333;&#25968;&#25454;&#21518;&#25165;&#21457;&#24448;&#21518;&#21488;</span>
        <span style="color: #008b8b;">this</span>.props.service.reg(name.value,email.value,password.value);
    }

    render(){
        <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">this</span>.props.service.loggedin){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24050;&#32463;&#30331;&#24405;&#30340;&#29992;&#25143;&#19981;&#20801;&#35768;&#27880;&#20876;</span>
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Redirect</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span> /&gt;;
        }

        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">em</span> = <span style="color: #008b8b;">this</span>.props.service.errMsg;

        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"register-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"name"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span> /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#30830;&#35748;&#23494;&#30721;"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#22914;&#26524;&#24050;&#32463;&#27880;&#20876; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.errMsg){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27880;&#20876;&#22833;&#36133;&#65292;&#21017;&#24377;&#20986;&#28040;&#24687;&#26694;</span>
            message.info(prevProps.service.errMsg,3,setTimeout(() =&gt; prevProps.service.errMsg = <span style="color: #8b2252;">''</span>,1000))
        }
    }

}
</pre>
</div></li>

<li><p>
login.js修改如下
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">"react"</span>;
<span style="color: #a020f0;">import</span> {Link,Redirect} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">"../css/login.css"</span>;
<span style="color: #a020f0;">import</span> {userService as service} from <span style="color: #8b2252;">"../service/user"</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">"mobx-react"</span>;
<span style="color: #a020f0;">import</span> {message} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20351;&#29992;&#28040;&#24687;&#26694;&#26679;&#24335;&#34920;</span>
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;

<span style="color: #b22222;">// </span><span style="color: #b22222;">export default class Login extends React.Component{</span>
<span style="color: #b22222;">//     </span><span style="color: #b22222;">render(){</span>
<span style="color: #b22222;">//         </span><span style="color: #b22222;">return &lt;_Login service={service} /&gt;;</span>
<span style="color: #b22222;">//     </span><span style="color: #b22222;">}</span>
<span style="color: #b22222;">// </span><span style="color: #b22222;">}</span>

<span style="color: #b22222;">// </span><span style="color: #b22222;">&#27880;&#24847;&#35013;&#39280;&#22120;&#39034;&#24207;</span>
@inject({service}) <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#35013;&#39280;&#22120;&#27880;&#20837;&#23646;&#24615;</span>
@observer <span style="color: #b22222;">//</span><span style="color: #b22222;">&#23558;react&#32452;&#20214;&#36716;&#25442;&#20026;&#21709;&#24212;&#24335;&#32452;&#20214;</span>
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> _Login <span style="color: #a020f0;">extends</span> React.Component {
    handleClick(event){
        event.preventDefault(); <span style="color: #b22222;">/* </span><span style="color: #b22222;">&#38459;&#27490;from&#34920;&#21333;&#25552;&#20132;</span><span style="color: #b22222;"> */</span>
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">fm</span> = event.target.form;
        <span style="color: #008b8b;">this</span>.props.service.login(fm[0].value,fm[1].value)
    }

    render() {
        <span style="color: #a020f0;">if</span> (<span style="color: #008b8b;">this</span>.props.service.loggedin) {
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Redirect</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span> /&gt;; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#24050;&#32463;&#30331;&#24405;&#65292;&#30452;&#25509;&#36339;&#36716;</span>
        }

        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">em</span> = <span style="color: #008b8b;">this</span>.props.service.errMsg; <span style="color: #b22222;">//</span><span style="color: #b22222;">(&#24517;&#39035;&#20351;&#29992;)&#25165;&#33021;&#35302;&#21457;</span>

        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-page"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"login-form"</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"email"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"password"</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"password"</span>/&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">button</span> <span style="color: #a0522d;">onClick</span>={<span style="color: #008b8b;">this</span>.handleClick.bind(<span style="color: #008b8b;">this</span>)}&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"message"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#36824;&#26410;&#27880;&#20876;&#65311; </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/reg"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#35831;&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">form</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
        )
    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.errMsg){ <span style="color: #b22222;">//</span><span style="color: #b22222;">&#30331;&#24405;&#22833;&#36133;&#65292;&#21017;&#24377;&#20986;&#28040;&#24687;&#26694;</span>
            message.info(prevProps.service.errMsg,3,setTimeout(() =&gt; prevProps.service.errMsg = <span style="color: #8b2252;">''</span>,1000))
        }
    }
}
</pre>
</div></li>
</ul></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-h:9dcd95c6-7beb-444c-a716-5456bae2c5e9" class="outline-3">
<h3 id="h:9dcd95c6-7beb-444c-a716-5456bae2c5e9">博文业务代码实现和Antd组件</h3>
<div class="outline-text-3" id="text-h:9dcd95c6-7beb-444c-a716-5456bae2c5e9">
<p>
[toc]
</p>
</div>
<div id="outline-container-h:b7f03f69-3294-4bfb-a11b-ce2315d98551" class="outline-4">
<h4 id="h:b7f03f69-3294-4bfb-a11b-ce2315d98551">导航菜单</h4>
<div class="outline-text-4" id="text-h:b7f03f69-3294-4bfb-a11b-ce2315d98551">
<ul class="org-ul">
<li>菜单网址，<a href="https://ant.design/components/menu-cn/">https://ant.design/components/menu-cn/</a></li>
<li>Menu 菜单组件
<ol class="org-ol">
<li>mode有水平、垂直、内嵌</li>
</ol></li>
<li>Menu.Item 菜单项
<ol class="org-ol">
<li>key菜单项item的唯一标识</li>
</ol></li>
<li>修改src/index.js导航菜单</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;
<span style="color: #a020f0;">import</span> {Route,Link,BrowserRouter as Router} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> Login from <span style="color: #8b2252;">"./component/login"</span>;
<span style="color: #a020f0;">import</span> Reg from <span style="color: #8b2252;">"./component/reg"</span>;
<span style="color: #a020f0;">import</span> {Menu} from <span style="color: #8b2252;">'antd'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;antd&#30340;&#32452;&#20214;</span>

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/menu/style'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;&#32452;&#20214;&#30340;&#26679;&#24335;css</span>
<span style="color: #a020f0;">import</span> { HomeFilled,LoginOutlined,RotateRightOutlined,AccountBookFilled } from <span style="color: #8b2252;">'@ant-design/icons'</span>;


<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">App</span> = () =&gt;  (
    &lt;<span style="color: #0000ff;">Router</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Menu</span> <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"horizontal"</span> <span style="color: #a0522d;">theme</span>=<span style="color: #8b2252;">"dark"</span>  <span style="color: #a0522d;">style</span>={{ lineHeight: <span style="color: #8b2252;">'64px'</span> }} <span style="color: #a0522d;">defaultSelectedKeys</span>= {[<span style="color: #8b2252;">'home'</span>]} &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"home"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">HomeFilled</span> /&gt;} &gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#20027;&#39029;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"login"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">LoginOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"reg"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">RotateRightOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/reg"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"about"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">AccountBookFilled</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/about"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#20851;&#20110;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Menu</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/about"</span> <span style="color: #a0522d;">component</span>={About} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/login"</span> <span style="color: #a0522d;">component</span>={Login} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/reg"</span> <span style="color: #a0522d;">component</span>={Reg} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">exact</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span> <span style="color: #a0522d;">component</span>={Home} /&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">Router</span>&gt;
);

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">Home</span>() {
    <span style="color: #a020f0;">return</span> (
        &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">Home</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
    );
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">About</span>() {
    <span style="color: #a020f0;">return</span> (
        &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">About</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
    );
}


ReactDom.render(&lt;<span style="color: #0000ff;">App</span> /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>
</div>
</div>
<div id="outline-container-h:021def2b-5cf8-46df-bac4-c2d5612e85c0" class="outline-4">
<h4 id="h:021def2b-5cf8-46df-bac4-c2d5612e85c0">页面布局</h4>
<div class="outline-text-4" id="text-h:021def2b-5cf8-46df-bac4-c2d5612e85c0">
<ul class="org-ul">
<li>采用上中下布局，参考：<a href="https://ant.design/components/layout-cn/">https://ant.design/components/layout-cn/</a></li>

<li>修改src/index.js导航菜单</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;
<span style="color: #a020f0;">import</span> {Route,Link,BrowserRouter as Router} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> {Menu,Layout} from <span style="color: #8b2252;">'antd'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;antd&#30340;&#32452;&#20214;</span>

<span style="color: #a020f0;">import</span> Login from <span style="color: #8b2252;">"./component/login"</span>;
<span style="color: #a020f0;">import</span> Reg from <span style="color: #8b2252;">"./component/reg"</span>;

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/menu/style'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;&#32452;&#20214;&#30340;&#26679;&#24335;css</span>
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/layout/style'</span>;
<span style="color: #a020f0;">import</span> { HomeFilled,LoginOutlined,RotateRightOutlined,AccountBookFilled } from <span style="color: #8b2252;">'@ant-design/icons'</span>;

<span style="color: #a020f0;">const</span> {Header,Content,Footer} = Layout; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#19978;&#20013;&#19979;</span>

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">App</span> = () =&gt;  (
    &lt;<span style="color: #0000ff;">Router</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Layout</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Header</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Menu</span> <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"horizontal"</span> <span style="color: #a0522d;">theme</span>=<span style="color: #8b2252;">"dark"</span>  <span style="color: #a0522d;">style</span>={{ lineHeight: <span style="color: #8b2252;">'64px'</span> }} <span style="color: #a0522d;">defaultSelectedKeys</span>= {[<span style="color: #8b2252;">'home'</span>]} &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"home"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">HomeFilled</span> /&gt;} &gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#20027;&#39029;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"login"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">LoginOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"reg"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">RotateRightOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/reg"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"about"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">AccountBookFilled</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/about"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#20851;&#20110;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Menu</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Header</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Content</span> <span style="color: #a0522d;">style</span>={{ padding: <span style="color: #8b2252;">'8px 50px'</span> }}&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">style</span>={{ background: <span style="color: #8b2252;">'#fff'</span>, padding: 24, minHeight: 280 }}&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/about"</span> <span style="color: #a0522d;">component</span>={About} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/login"</span> <span style="color: #a0522d;">component</span>={Login} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/reg"</span> <span style="color: #a0522d;">component</span>={Reg} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">exact</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span> <span style="color: #a0522d;">component</span>={Home} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Content</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Footer</span> <span style="color: #a0522d;">style</span>={{ textAlign: <span style="color: #8b2252;">'center'</span> }}&gt;<span style="color: #000000; background-color: #ffffff;">xddweb&#169;2019-2020 </span>&lt;/<span style="color: #0000ff;">Footer</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">Layout</span>&gt;
<span style="color: #000000; background-color: #ffffff;">  </span>&lt;/<span style="color: #0000ff;">Router</span>&gt;
);

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">Home</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">Home</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  );
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">About</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">About</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  );
}


ReactDom.render(&lt;<span style="color: #0000ff;">App</span> /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7161fae6-e3e7-4cba-ab6d-da240375c45e" class="outline-4">
<h4 id="h:7161fae6-e3e7-4cba-ab6d-da240375c45e">博文业务</h4>
<div class="outline-text-4" id="text-h:7161fae6-e3e7-4cba-ab6d-da240375c45e">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">url</th>
<th scope="col" class="org-left">method</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>posts</i></td>
<td class="org-left">POST</td>
<td class="org-left">提交博文的title、content,成功返回json,包含post_id,title</td>
</tr>

<tr>
<td class="org-left">/posts/id</td>
<td class="org-left">GET</td>
<td class="org-left">返回博文详情返回json,id,title、author_id、postdate(时间戳)、content</td>
</tr>

<tr>
<td class="org-left"><i>posts</i></td>
<td class="org-left">GET</td>
<td class="org-left">返回博文标题列表，分页</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:597d0cf2-2f4a-4a6f-a33c-4112a6a2daaf" class="outline-4">
<h4 id="h:597d0cf2-2f4a-4a6f-a33c-4112a6a2daaf">业务层</h4>
<div class="outline-text-4" id="text-h:597d0cf2-2f4a-4a6f-a33c-4112a6a2daaf">
<ul class="org-ul">
<li>创建service/post.js文件，新建PostService类。</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">'axios'</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">'mobx'</span>;

<span style="color: #a020f0;">class</span> PostService{
    @observable msg = <span style="color: #8b2252;">''</span>;

    pub(title,content){
        console.log(title);
        axios.post(<span style="color: #8b2252;">'/api/posts/'</span>,{
            title,content
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server &#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {
                console.log(response.data);
                console.log(response.status);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#25104;&#21151;'</span>;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#22833;&#36133;'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">+&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">postService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">PostService</span>();
<span style="color: #a020f0;">export</span> {postService};
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d0f06259-123b-406c-82d2-e890e09700b6" class="outline-4">
<h4 id="h:d0f06259-123b-406c-82d2-e890e09700b6">发布组件</h4>
<div class="outline-text-4" id="text-h:d0f06259-123b-406c-82d2-e890e09700b6">
<ul class="org-ul">
<li>使用Form组件，<a href="https://ant.design/components/form-cn/">https://ant.design/components/form-cn/</a></li>

<li>创建component/pub.js文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">component/pub.js</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {Form,Icon,Input,Button,message} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;
<span style="color: #a020f0;">import</span> {postService as service} from <span style="color: #8b2252;">'../service/post'</span>;

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/form/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/icon/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/input/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/button/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">FormItem</span> = Form.Item;
<span style="color: #a020f0;">const</span> { TextArea } = Input;

@inject({service})
@observer
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Pub <span style="color: #a020f0;">extends</span> React.Component {

    handleSubmit(event){
        event.preventDefault();
        <span style="color: #a020f0;">const</span> [ <span style="color: #a0522d;">title</span>,<span style="color: #a0522d;">content</span> ] = event.target;<span style="color: #b22222;">// </span><span style="color: #b22222;">event.target&#36820;&#22238;form,&#32780;form&#26159;&#34920;&#21333;&#25511;&#20214;&#30340;&#25968;&#32452;</span>
        <span style="color: #008b8b;">this</span>.props.service.pub(title.value,content.value);
    }

    render(){
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">msg</span> = <span style="color: #008b8b;">this</span>.props.service.msg;
        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">Form</span> <span style="color: #a0522d;">layout</span>=<span style="color: #8b2252;">"vertical"</span> <span style="color: #a0522d;">onSubmitCapture</span>={<span style="color: #008b8b;">this</span>.handleSubmit.bind(<span style="color: #008b8b;">this</span>)}&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Form.Item</span> <span style="color: #a0522d;">label</span>=<span style="color: #8b2252;">"&#26631;&#39064;"</span> <span style="color: #a0522d;">labelCol</span>={{span:4}} <span style="color: #a0522d;">wrapperCol</span>={{span:14}} &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Input</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#26631;&#39064;"</span> /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Form.Item</span>&gt;

<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Form.Item</span> <span style="color: #a0522d;">label</span>=<span style="color: #8b2252;">"&#20869;&#23481;"</span> <span style="color: #a0522d;">labelCol</span>={{span:4}} <span style="color: #a0522d;">wrapperCol</span>={{span:14}}  &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">TextArea</span> <span style="color: #a0522d;">rows</span>={10} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Form.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">FormItem</span> <span style="color: #a0522d;">wrapperCol</span>={{span:14,offset:4}}&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Button</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"primary"</span> <span style="color: #a0522d;">htmlType</span>=<span style="color: #8b2252;">"submit"</span> &gt;<span style="color: #000000; background-color: #ffffff;">&#25552;&#20132;</span>&lt;/<span style="color: #0000ff;">Button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">FormItem</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Form</span>&gt;
        )

    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.msg){ 
            message.info(prevProps.service.msg,3,setTimeout(() =&gt; prevProps.service.msg = <span style="color: #8b2252;">''</span>,1000))
        }
    }

}
</pre>
</div>

<ul class="org-ul">
<li>Form
表单组件，layout是垂直，onSubmitCapture提交，注意这个提交的this就是表单自己</li>
<li>FormItem表单项
<ul class="org-ul">
<li>label 设置控件前的标题</li>
<li>labelCol设置label的宽度，wrapperCol是label后占用的宽度，这些单位都是栅格系统的宽度</li>
<li>参考Antd/Form表单/表单布局<a href="https://ant.design/components/form-cn/#components-form-demo-layout">https://ant.design/components/form-cn/#components-form-demo-layout</a></li>
<li>栅格系统：AntD提供了一个类似于Bootstrap的栅格系统，她将页面分成了24等分的列</li>
<li>span代表占几个格子：offset表示左边空出多个格子</li>
</ul></li>
<li>Input输入框，placeholder提示字符</li>
<li>TextArea文本框，rows行数</li>
<li>Button按钮
<ul class="org-ul">
<li>type是按钮的类型，也决定它的颜色</li>
<li>htmlType使用HTML中的Type值，submit是提交按钮会触发提交行为，一定要写，但是handleSubmit中要阻止默认行为。</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:5d7d567a-e2df-4f23-b1d2-0843c758f1f9" class="outline-4">
<h4 id="h:5d7d567a-e2df-4f23-b1d2-0843c758f1f9">富文本编辑器</h4>
<div class="outline-text-4" id="text-h:5d7d567a-e2df-4f23-b1d2-0843c758f1f9">
<ul class="org-ul">
<li><a href="https://github.com/margox/braft-editor">https://github.com/margox/braft-editor</a></li>

<li>安装插件</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&#20351;&#29992;yarn&#23433;&#35013;&#26368;&#26032;&#29256;&#26412;
$ yarn add braft-editor
&#23433;&#35013;&#25351;&#23450;&#29256;&#26412;
$ yarn add braft-editor@2.3.1
&#23433;&#35013;2.x.x&#26368;&#39640;&#29256;&#26412;
$ yarn add braft-editor@^2.3.1
&#20351;&#29992;npm&#23433;&#35013;
$ npm install braft-editor --save

&#32452;&#20214;&#20351;&#29992;
import BraftEditor from <span style="color: #8b2252;">'braft-editor'</span>;
import <span style="color: #8b2252;">'braft-editor/dist/index.css'</span>;
</pre>
</div>

<ul class="org-ul">
<li>参考<a href="https://braft.margox.cn/demos/basic">https://braft.margox.cn/demos/basic</a></li>

<li>修改component/pub.js文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {Form,Icon,Input,Button,message} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;
<span style="color: #a020f0;">import</span> {postService as service} from <span style="color: #8b2252;">'../service/post'</span>;
<span style="color: #a020f0;">import</span> BraftEditor from <span style="color: #8b2252;">'braft-editor'</span>;

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'braft-editor/dist/index.css'</span>
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/form/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/icon/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/input/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/button/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">FormItem</span> = Form.Item;
<span style="color: #a020f0;">const</span> { TextArea } = Input;

@inject({service})
@observer
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Pub <span style="color: #a020f0;">extends</span> React.Component {

    <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;state&#65292;&#20851;&#32852;&#32452;&#20214;&#21644;&#32452;&#20214;&#36755;&#20986;&#30340;HTML&#20869;&#23481;</span>
    state = {
        editorState : BraftEditor.createEditorState(<span style="color: #8b2252;">'&lt;p&gt;&lt;a href=""&gt;xdd&#32593;&#39029;&lt;/a&gt;&lt;/p&gt;'</span>),
        outputHTML : <span style="color: #8b2252;">"&lt;p&gt;&lt;/p&gt;"</span>
    }

    handleSubmit(event){
        event.preventDefault();
        <span style="color: #a020f0;">const</span> [ <span style="color: #a0522d;">title</span>,<span style="color: #a0522d;">content</span> ] = event.target;<span style="color: #b22222;">// </span><span style="color: #b22222;">event.target&#36820;&#22238;form,&#32780;form&#26159;&#34920;&#21333;&#25511;&#20214;&#30340;&#25968;&#32452;</span>
        console.log(title,content);
        <span style="color: #a020f0;">const</span> {outputHTML = <span style="color: #8b2252;">''</span>} = <span style="color: #008b8b;">this</span>.state;
        console.log(outputHTML);
        <span style="color: #b22222;">// </span><span style="color: #b22222;">this.props.service.pub(title.value,content.value);</span>
        <span style="color: #008b8b;">this</span>.props.service.pub(title.value,outputHTML);
    }

    <span style="color: #b22222;">// </span><span style="color: #b22222;">&#32452;&#20214;&#20869;&#23481;&#21464;&#21270;&#26356;&#26032;state,&#24341;&#21457;&#28210;&#26579;</span>
    handleChange = (editorState) =&gt;{
        <span style="color: #008b8b;">this</span>.setState({
            editorState:editorState,
            outputHTML:editorState.toHTML()
        });
    }

    render(){
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">msg</span> = <span style="color: #008b8b;">this</span>.props.service.msg;
        <span style="color: #b22222;">// </span><span style="color: #b22222;">&#25490;&#38500;&#25353;&#38062;</span>
        <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">excludeControls</span> = [
            <span style="color: #8b2252;">'letter-spacing'</span>,
            <span style="color: #8b2252;">'line-height'</span>,
            <span style="color: #8b2252;">'clear'</span>,
            <span style="color: #8b2252;">'headings'</span>,
            <span style="color: #8b2252;">'list-ol'</span>,
            <span style="color: #8b2252;">'list-ul'</span>,
            <span style="color: #8b2252;">'remove-styles'</span>,
            <span style="color: #8b2252;">'subscript'</span>,
            <span style="color: #8b2252;">'hr'</span>,
            <span style="color: #8b2252;">'text-align'</span>
        ];

        <span style="color: #a020f0;">const</span> {editorState,outputHTML} = <span style="color: #008b8b;">this</span>.state;

        <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">Form</span> <span style="color: #a0522d;">layout</span>=<span style="color: #8b2252;">"vertical"</span> <span style="color: #a0522d;">onSubmitCapture</span>={<span style="color: #008b8b;">this</span>.handleSubmit.bind(<span style="color: #008b8b;">this</span>)}&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Form.Item</span> <span style="color: #a0522d;">label</span>=<span style="color: #8b2252;">"&#26631;&#39064;"</span> <span style="color: #a0522d;">labelCol</span>={{span:4}} <span style="color: #a0522d;">wrapperCol</span>={{span:14}} &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Input</span> <span style="color: #a0522d;">placeholder</span>=<span style="color: #8b2252;">"&#26631;&#39064;"</span> /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Form.Item</span>&gt;

<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Form.Item</span> <span style="color: #a0522d;">label</span>=<span style="color: #8b2252;">"&#20869;&#23481;"</span> <span style="color: #a0522d;">labelCol</span>={{span:4}} <span style="color: #a0522d;">wrapperCol</span>={{span:14}}  &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">BraftEditor</span> <span style="color: #a0522d;">value</span>={editorState} <span style="color: #a0522d;">excludeControls</span>={excludeControls}
                     <span style="color: #a0522d;">onChange</span> = {<span style="color: #008b8b;">this</span>.handleChange.bind(<span style="color: #008b8b;">this</span>)} <span style="color: #a0522d;">contentStyle</span>={{height:400}} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Form.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">FormItem</span> <span style="color: #a0522d;">wrapperCol</span>={{span:14,offset:4}}&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Button</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"primary"</span> <span style="color: #a0522d;">htmlType</span>=<span style="color: #8b2252;">"submit"</span> &gt;<span style="color: #000000; background-color: #ffffff;">&#25552;&#20132;</span>&lt;/<span style="color: #0000ff;">Button</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">FormItem</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Form</span>&gt;
        )
    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.msg){ 
            message.info(prevProps.service.msg,3,setTimeout(() =&gt; prevProps.service.msg = <span style="color: #8b2252;">''</span>,1000))
        }
    }

}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e8481067-1cb5-44d0-80e5-86c655c6e628" class="outline-4">
<h4 id="h:e8481067-1cb5-44d0-80e5-86c655c6e628">业务层改进</h4>
<div class="outline-text-4" id="text-h:e8481067-1cb5-44d0-80e5-86c655c6e628">
<ul class="org-ul">
<li>header中的jwt，由于与后台Django
Server通信，身份认证需要jwt,这个要放到request header中。使用axios的API
=axios.post(url[data,config])=可以使用第三个参数config。config是一个对象，字典中设置headers字段，该字段的值依然是对象，都是键值对形式。</li>

<li>修改service/post.js文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">service/post.js</span>
<span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">'axios'</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">'mobx'</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">'store'</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">'store/plugins/expire'</span>;

store.addPlugin(expire)

<span style="color: #a020f0;">class</span> PostService{
    @observable msg = <span style="color: #8b2252;">''</span>;

    constructor(){
        <span style="color: #008b8b;">this</span>.axios = axios.create({
            baseURL: <span style="color: #8b2252;">'/api/posts'</span>
        })
    }

    getJwt(){
        <span style="color: #a020f0;">return</span> store.get(<span style="color: #8b2252;">"token"</span>,<span style="color: #8b2252;">''</span>)
    }

    pub(title,content){
        console.log(title);
        axios.post(<span style="color: #8b2252;">'/api/posts/'</span>,{
            title,content
        },{
            headers:{<span style="color: #8b2252;">'jwt'</span>: <span style="color: #008b8b;">this</span>.getJwt()}
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server &#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {
                console.log(response.data);
                console.log(response.status);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#25104;&#21151;'</span>;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#22833;&#36133;'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">+&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">postService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">PostService</span>();
<span style="color: #a020f0;">export</span> {postService};
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6cd8e77e-c68b-4ca3-be4e-46f8978a3fa3" class="outline-4">
<h4 id="h:6cd8e77e-c68b-4ca3-be4e-46f8978a3fa3">详情页组件</h4>
<div class="outline-text-4" id="text-h:6cd8e77e-c68b-4ca3-be4e-46f8978a3fa3">
<ul class="org-ul">
<li>=index.jsp=中增加如下代码</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> Post from <span style="color: #8b2252;">"./component/post"</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#35814;&#24773;&#39029;</span>

&lt;Route path=<span style="color: #8b2252;">"/post/:id"</span> component={Post} /&gt;
</pre>
</div>

<ul class="org-ul">
<li>新建component/post.js,创建Post组件。使用antd Card布局。</li>
<li>安装日期处理库，=yarn add moment=。</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">component/post.js</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> { observer } from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {message,Card,Empty} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;
<span style="color: #a020f0;">import</span> {postService as service} from <span style="color: #8b2252;">'../service/post'</span>;
<span style="color: #a020f0;">import</span> moment from <span style="color: #8b2252;">'moment'</span>;

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/card/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/empty/style'</span>;

@inject({service})
@observer
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> Post <span style="color: #a020f0;">extends</span> React.Component {
    constructor(props){
        <span style="color: #a020f0;">super</span>(props);
        <span style="color: #a020f0;">let</span> {id = -1} = props.match.params;
        console.log(id);
        <span style="color: #008b8b;">this</span>.props.service.getPost(id);
    }

    render(){
        <span style="color: #a020f0;">let</span> <span style="color: #a0522d;">msg</span> = <span style="color: #008b8b;">this</span>.props.service.msg;
        console.log(<span style="color: #008b8b;">this</span>.props.service.post);
        <span style="color: #a020f0;">const</span> {title = <span style="color: #8b2252;">""</span>, content = <span style="color: #8b2252;">""</span>,author,postdate} = <span style="color: #008b8b;">this</span>.props.service.post;

        <span style="color: #a020f0;">if</span> (title){
            <span style="color: #a020f0;">return</span> (
            &lt;<span style="color: #0000ff;">Card</span> <span style="color: #a0522d;">title</span>={title} <span style="color: #a0522d;">extra</span>={&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"#"</span>&gt;{author}&lt;/<span style="color: #0000ff;">a</span>&gt;} &gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span>&gt;{moment(postdate * 1000).format(<span style="color: #8b2252;">"YYYY-MM-DD hh:mm:ss"</span>)}&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">p</span> <span style="color: #a0522d;">dangerouslySetInnerHTML</span>={{__html:content}}&gt;&lt;/<span style="color: #0000ff;">p</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Card</span>&gt;
            );
        }
        <span style="color: #a020f0;">else</span> {
            <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Empty</span> /&gt;;
        }

    }

    componentDidUpdate(prevProps,prevState){ <span style="color: #b22222;">//</span><span style="color: #b22222;">+ &#28210;&#26579;&#21518;&#26174;&#31034;&#28040;&#24687;&#32452;&#20214;</span>
        <span style="color: #a020f0;">if</span> (prevProps.service.msg){
            message.info(prevProps.service.msg,3,()=&gt; prevProps.service.msg = <span style="color: #8b2252;">''</span>);
        }

    }
}
</pre>
</div>

<ul class="org-ul">
<li>如果使用了富文本编辑器，那么显示的时候，发现不能按照网页标签显示。原因是为了安全，防止xss攻击，React不允许直接按照HTML显示。</li>

<li><p>
使用dangerouslySetInnerHTML属性，这个名字提醒使用者很危险。
</p>

<div class="org-src-container">
<pre class="src src-js">&lt;p&gt;{content}&lt;/p&gt;
&#20462;&#25913;&#20026;
&lt;p dangerouslySetInnerHTML={{__html:content}}&gt; &lt;/p&gt;
</pre>
</div></li>

<li>修改service/post.js代码如下</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">service/post.js</span>

<span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">'axios'</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">'mobx'</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">'store'</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">'store/plugins/expire'</span>;

store.addPlugin(expire)

<span style="color: #a020f0;">class</span> PostService{
    @observable msg = <span style="color: #8b2252;">''</span>;
    @observable post = {}; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#25991;&#31456;</span>

    constructor(){
        <span style="color: #008b8b;">this</span>.axios = axios.create({
            baseURL: <span style="color: #8b2252;">'/api/posts/'</span>
        })
    }

    getJwt(){
        <span style="color: #a020f0;">return</span> store.get(<span style="color: #8b2252;">"token"</span>,<span style="color: #8b2252;">''</span>)
    }

    pub(title,content){
        console.log(title);
        axios.post(<span style="color: #8b2252;">'/api/posts/'</span>,{
            title,content
        },{
            headers:{<span style="color: #8b2252;">'jwt'</span>: <span style="color: #008b8b;">this</span>.getJwt()}
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server &#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {
                console.log(response.data);
                console.log(response.status);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#25104;&#21151;'</span>;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#22833;&#36133;'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">+&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }

    getPost(id){
        <span style="color: #008b8b;">this</span>.axios.get(id).then(
            response =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27492;&#20989;&#25968;&#35201;&#27880;&#24847;this&#30340;&#38382;&#39064;</span>
                <span style="color: #008b8b;">this</span>.post = response.data.post;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.post = {}
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">"&#25991;&#31456;&#21152;&#36733;&#22833;&#36133;"</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">postService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">PostService</span>();
<span style="color: #a020f0;">export</span> {postService};
</pre>
</div>

<ul class="org-ul">
<li>数据详情页，可参考<a href="https://ant.design/components/descriptions-cn/">https://ant.design/components/descriptions-cn/</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:a93bce79-d7d3-41e3-ad48-c71a5dae312a" class="outline-4">
<h4 id="h:a93bce79-d7d3-41e3-ad48-c71a5dae312a">文章列表页组件</h4>
<div class="outline-text-4" id="text-h:a93bce79-d7d3-41e3-ad48-c71a5dae312a">
<ul class="org-ul">
<li>创建component/list.js,创建List组件。在index.js中提交菜单项和路由。</li>
<li>使用L是为了避免和AntD的List冲突。</li>
<li>修改service/index.js文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">service/index.js</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> ReactDom from <span style="color: #8b2252;">'react-dom'</span>;
<span style="color: #a020f0;">import</span> {Route,Link,BrowserRouter as Router} from <span style="color: #8b2252;">"react-router-dom"</span>;
<span style="color: #a020f0;">import</span> {Menu,Layout} from <span style="color: #8b2252;">'antd'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;antd&#30340;&#32452;&#20214;</span>

<span style="color: #a020f0;">import</span> Login from <span style="color: #8b2252;">"./component/login"</span>;
<span style="color: #a020f0;">import</span> Reg from <span style="color: #8b2252;">"./component/reg"</span>;
<span style="color: #a020f0;">import</span> Pub from <span style="color: #8b2252;">"./component/pub"</span>; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#21457;&#24067;&#39029;</span>
<span style="color: #a020f0;">import</span> Post from <span style="color: #8b2252;">"./component/post"</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#35814;&#24773;&#39029;</span>
<span style="color: #a020f0;">import</span> L from <span style="color: #8b2252;">'./component/list'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21015;&#34920;&#39029;</span>

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/menu/style'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21152;&#36733;&#32452;&#20214;&#30340;&#26679;&#24335;css</span>
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/layout/style'</span>;
<span style="color: #a020f0;">import</span> { HomeFilled,LoginOutlined,RotateRightOutlined,AccountBookFilled,BarcodeOutlined,PullRequestOutlined} from <span style="color: #8b2252;">'@ant-design/icons'</span>;

<span style="color: #a020f0;">const</span> {Header,Content,Footer} = Layout; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#19978;&#20013;&#19979;</span>

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">App</span> = () =&gt;  (
    &lt;<span style="color: #0000ff;">Router</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;<span style="color: #0000ff;">Layout</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Header</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">Menu</span> <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"horizontal"</span> <span style="color: #a0522d;">theme</span>=<span style="color: #8b2252;">"dark"</span>  <span style="color: #a0522d;">style</span>={{ lineHeight: <span style="color: #8b2252;">'64px'</span> }} <span style="color: #a0522d;">defaultSelectedKeys</span>= {[<span style="color: #8b2252;">'home'</span>]} &gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"home"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">HomeFilled</span> /&gt;} &gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#20027;&#39029;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"login"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">LoginOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/login"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#30331;&#24405;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"reg"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">RotateRightOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/reg"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#27880;&#20876;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"pub"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">PullRequestOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/pub"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#21457;&#24067;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"bars"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">BarcodeOutlined</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/list"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#25991;&#31456;&#21015;&#34920;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Menu.Item</span> <span style="color: #a0522d;">key</span>=<span style="color: #8b2252;">"about"</span> <span style="color: #a0522d;">icon</span>={&lt;<span style="color: #0000ff;">AccountBookFilled</span> /&gt;}&gt;&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>=<span style="color: #8b2252;">"/about"</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#20851;&#20110;</span>&lt;/<span style="color: #0000ff;">Link</span>&gt;&lt;/<span style="color: #0000ff;">Menu.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">Menu</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Header</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Content</span> <span style="color: #a0522d;">style</span>={{ padding: <span style="color: #8b2252;">'8px 50px'</span> }}&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">style</span>={{ background: <span style="color: #8b2252;">'#fff'</span>, padding: 24, minHeight: 280 }}&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/about"</span> <span style="color: #a0522d;">component</span>={About} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/login"</span> <span style="color: #a0522d;">component</span>={Login} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/reg"</span> <span style="color: #a0522d;">component</span>={Reg} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/pub"</span> <span style="color: #a0522d;">component</span>={Pub} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/list"</span> <span style="color: #a0522d;">component</span>={L} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/posts/:id"</span> <span style="color: #a0522d;">component</span>={Post} /&gt;
<span style="color: #000000; background-color: #ffffff;">                    </span>&lt;<span style="color: #0000ff;">Route</span> <span style="color: #a0522d;">exact</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span> <span style="color: #a0522d;">component</span>={Home} /&gt;
<span style="color: #000000; background-color: #ffffff;">                </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;/<span style="color: #0000ff;">Content</span>&gt;
<span style="color: #000000; background-color: #ffffff;">            </span>&lt;<span style="color: #0000ff;">Footer</span> <span style="color: #a0522d;">style</span>={{ textAlign: <span style="color: #8b2252;">'center'</span> }}&gt;<span style="color: #000000; background-color: #ffffff;">xddweb&#169;2019-2020 </span>&lt;/<span style="color: #0000ff;">Footer</span>&gt;
<span style="color: #000000; background-color: #ffffff;">        </span>&lt;/<span style="color: #0000ff;">Layout</span>&gt;
<span style="color: #000000; background-color: #ffffff;">  </span>&lt;/<span style="color: #0000ff;">Router</span>&gt;
);

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">Home</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">Home</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  );
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">About</span>() {
  <span style="color: #a020f0;">return</span> (
    &lt;<span style="color: #0000ff;">div</span>&gt;
<span style="color: #000000; background-color: #ffffff;">      </span>&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="color: #000000; background-color: #ffffff;">About</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
<span style="color: #000000; background-color: #ffffff;">    </span>&lt;/<span style="color: #0000ff;">div</span>&gt;
  );
}

ReactDom.render(&lt;<span style="color: #0000ff;">App</span> /&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>
</div>
<div id="outline-container-h:a9a795d3-034b-41d6-a5a3-ef0f6ba989f1" class="outline-5">
<h5 id="h:a9a795d3-034b-41d6-a5a3-ef0f6ba989f1">List组件</h5>
<div class="outline-text-5" id="text-h:a9a795d3-034b-41d6-a5a3-ef0f6ba989f1">
<ul class="org-ul">
<li>Ant
design的List,需要使用3.x版本，修改package.json的版本信息="antd":"^3.1.5"<code>。然后=$ npm update</code>,更新成功后，就可以使用List组件了。或者=$yarn upgrade antd@^3.1.5=.</li>
<li>新增component/list.js代码如下</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">component/list.js</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {message,List,Empty} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;
<span style="color: #a020f0;">import</span> {postService as service} from <span style="color: #8b2252;">'../service/post'</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">'react-router-dom'</span>;

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/list/style'</span>;

@inject({service})
@observer
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> L <span style="color: #a020f0;">extends</span> React.Component{
    constructor(props) {
        <span style="color: #a020f0;">super</span>(props);
        props.service.list();
    }

    render() {
        <span style="color: #a020f0;">const</span> {posts:data=[],pagination} = <span style="color: #008b8b;">this</span>.props.service.posts;
        <span style="color: #a020f0;">if</span> (data.length){
            <span style="color: #a020f0;">return</span> (
                &lt;<span style="color: #0000ff;">List</span> 
                    <span style="color: #a0522d;">header</span>={&lt;<span style="color: #0000ff;">div</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#21338;&#25991;&#21015;&#34920;</span>&lt;/<span style="color: #0000ff;">div</span>&gt;} 
                    <span style="color: #a0522d;">footer</span>={&lt;<span style="color: #0000ff;">div</span>&gt;<span style="color: #000000; background-color: #ffffff;">Footer</span>&lt;/<span style="color: #0000ff;">div</span>&gt;} 
                    <span style="color: #a0522d;">bordered</span> 
                    <span style="color: #a0522d;">dataSource</span> = {data}
                    <span style="color: #a0522d;">renderItem</span>={item =&gt; (
                        &lt;<span style="color: #0000ff;">List.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                            </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>={<span style="color: #8b2252;">'/posts/'</span>+item.id}&gt;{item.title}&lt;/<span style="color: #0000ff;">Link</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                        </span>&lt;/<span style="color: #0000ff;">List.Item</span>&gt;
                    )}
                /&gt;
            )
        }

        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Empty</span> /&gt;;
    }
}
</pre>
</div>

<ul class="org-ul">
<li>List列表组件
<ul class="org-ul">
<li>bordered有边线</li>
<li>dataSource给定数据源</li>
<li>renderItem渲染每一行，给定一个一参函数迭代每一行</li>
<li>List.Item每一行的组件</li>
</ul></li>
<li>使用Link组件增加链接</li>
</ul>

<div class="org-src-container">
<pre class="src src-js">&lt;List bordered dataSource = {data} 
    renderItem={item =&gt; (
        &lt;List.Item&gt;
            &lt;Link to={<span style="color: #8b2252;">'/posts/'</span>+item.id}&gt;{item.title}&lt;/Link&gt;
        &lt;/List.Item&gt;
    )}
<span style="color: #8b2252;">/&gt;</span>
</pre>
</div>

<ul class="org-ul">
<li>如果需要根据复杂的效果可以使用List.Item.Meta。</li>
</ul>

<div class="org-src-container">
<pre class="src src-js">&lt;Link to={<span style="color: #8b2252;">'/post/'</span> + item.id}&gt;{item.title} &lt;/Link&gt; &#36825;&#26159;&#35814;&#24773;&#39029;&#30340;&#38142;&#25509;
</pre>
</div>

<ul class="org-ul">
<li>修改service/post.js文件中的postService类，如下：</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">'axios'</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">'mobx'</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">'store'</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">'store/plugins/expire'</span>;

store.addPlugin(expire)

<span style="color: #a020f0;">class</span> PostService{
    @observable msg = <span style="color: #8b2252;">''</span>;
    @observable post = {}; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#25991;&#31456;</span>
    @observable posts = {<span style="color: #8b2252;">'posts'</span>:[],<span style="color: #8b2252;">'pagination'</span>:{page:1,size:20,pages:0,total:0}}; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21015;&#34920;</span>

    constructor(){
        <span style="color: #008b8b;">this</span>.axios = axios.create({
            baseURL: <span style="color: #8b2252;">'/api/posts/'</span>
        })
    }

    getJwt(){
        <span style="color: #a020f0;">return</span> store.get(<span style="color: #8b2252;">"token"</span>,<span style="color: #8b2252;">''</span>)
    }

    pub(title,content){
        console.log(title);
        axios.post(<span style="color: #8b2252;">'/api/posts/'</span>,{
            title,content
        },{
            headers:{<span style="color: #8b2252;">'jwt'</span>: <span style="color: #008b8b;">this</span>.getJwt()}
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server &#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {
                console.log(response.data);
                console.log(response.status);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#25104;&#21151;'</span>;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#22833;&#36133;'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">+&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }

    getPost(id){
        <span style="color: #008b8b;">this</span>.axios.get(id).then(
            response =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27492;&#20989;&#25968;&#35201;&#27880;&#24847;this&#30340;&#38382;&#39064;</span>
                <span style="color: #008b8b;">this</span>.post = response.data.post;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.post = {}
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">"&#25991;&#31456;&#21152;&#36733;&#22833;&#36133;"</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }

    list(){
        <span style="color: #008b8b;">this</span>.axios.get().then(
            response =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27880;&#24847;&#27492;&#20989;&#25968;&#30340;this&#38382;&#39064;</span>
                <span style="color: #008b8b;">this</span>.posts = response.data;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt;{
                console.log(error);
                <span style="color: #008b8b;">this</span>.post = {}
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#25991;&#31456;&#21015;&#34920;&#21152;&#36733;&#22833;&#36133;'</span>;<span style="color: #b22222;">// </span><span style="color: #b22222;">&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">postService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">PostService</span>();
<span style="color: #a020f0;">export</span> {postService};
</pre>
</div>

<ul class="org-ul">
<li>测试<a href="http://localhost:3000/list">http://localhost:3000/list</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:43383cb6-c4a9-467e-b738-1611d61e8faf" class="outline-4">
<h4 id="h:43383cb6-c4a9-467e-b738-1611d61e8faf">分页功能</h4>
<div class="outline-text-4" id="text-h:43383cb6-c4a9-467e-b738-1611d61e8faf">
<ul class="org-ul">
<li>分页使用了Pagination组件，在L组件的render函数的List组件中使用pagination属性，这个属性放入一个pagination对象，有如下属性

<ul class="org-ul">
<li>current，当前页</li>
<li>pageSize, 页面内行数</li>
<li>total,记录总数</li>
<li>onChange,页码切换时调用，回调函数为=(pageNo,pageSize)=&gt;{}=,即切换是获得当前页码和页内行数。</li>
</ul></li>

<li>可参考<a href="https://ant.design/components/list-cn/#components-list-demo-vertical">https://ant.design/components/list-cn/#components-list-demo-vertical</a></li>

<li>修改component/list.js代码如下：</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #b22222;">// </span><span style="color: #b22222;">component/list.js</span>
<span style="color: #a020f0;">import</span> React from <span style="color: #8b2252;">'react'</span>;
<span style="color: #a020f0;">import</span> {observer} from <span style="color: #8b2252;">'mobx-react'</span>;
<span style="color: #a020f0;">import</span> {message,List,Empty} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> {inject} from <span style="color: #8b2252;">'../utils'</span>;
<span style="color: #a020f0;">import</span> {postService as service} from <span style="color: #8b2252;">'../service/post'</span>;
<span style="color: #a020f0;">import</span> {Link} from <span style="color: #8b2252;">'react-router-dom'</span>;

<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/message/style'</span>;
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'antd/lib/list/style'</span>;

@inject({service})
@observer
<span style="color: #a020f0;">export</span> <span style="color: #a020f0;">default</span> <span style="color: #a020f0;">class</span> L <span style="color: #a020f0;">extends</span> React.Component{
    constructor(props) {
        <span style="color: #a020f0;">super</span>(props);
        props.service.list();
    }

    onChange(pageNumber){
        console.log(pageNumber);
        <span style="color: #008b8b;">this</span>.props.service.list(pageNumber);
    }

    render() {
        <span style="color: #a020f0;">const</span> {posts:data=[],pagination} = <span style="color: #008b8b;">this</span>.props.service.posts;
        <span style="color: #a020f0;">if</span> (data.length){
            <span style="color: #a020f0;">const</span> {page:current=1,total ,size:pageSize} = pagination;
            console.log(current,total,pageSize);
            <span style="color: #a020f0;">return</span> (
                &lt;<span style="color: #0000ff;">List</span> 
                    <span style="color: #a0522d;">header</span>={&lt;<span style="color: #0000ff;">div</span>&gt;<span style="color: #000000; background-color: #ffffff;">&#21338;&#25991;&#21015;&#34920;</span>&lt;/<span style="color: #0000ff;">div</span>&gt;} 
                    <span style="color: #a0522d;">bordered</span> 
                    <span style="color: #a0522d;">dataSource</span> = {data}
                    <span style="color: #a0522d;">renderItem</span>={item =&gt; (
                        &lt;<span style="color: #0000ff;">List.Item</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                            </span>&lt;<span style="color: #0000ff;">Link</span> <span style="color: #a0522d;">to</span>={<span style="color: #8b2252;">'/posts/'</span>+item.id}&gt;{item.title}&lt;/<span style="color: #0000ff;">Link</span>&gt;
<span style="color: #000000; background-color: #ffffff;">                        </span>&lt;/<span style="color: #0000ff;">List.Item</span>&gt;
                    )}
                    <span style="color: #a0522d;">pagination</span>={{
                        current,
                        total,
                        pageSize,
                        onChange:<span style="color: #008b8b;">this</span>.onChange.bind(<span style="color: #008b8b;">this</span>)
                    }}
                /&gt;
            )
        }

        <span style="color: #a020f0;">return</span> &lt;<span style="color: #0000ff;">Empty</span> /&gt;;
    }
}
</pre>
</div>

<ul class="org-ul">
<li>修改service/post.js中的list方法</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> axios from <span style="color: #8b2252;">'axios'</span>;
<span style="color: #a020f0;">import</span> {observable} from <span style="color: #8b2252;">'mobx'</span>;
<span style="color: #a020f0;">import</span> store from <span style="color: #8b2252;">'store'</span>;
<span style="color: #a020f0;">import</span> expire from <span style="color: #8b2252;">'store/plugins/expire'</span>;

store.addPlugin(expire)

<span style="color: #a020f0;">class</span> PostService{
    @observable msg = <span style="color: #8b2252;">''</span>;
    @observable post = {}; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#25991;&#31456;</span>
    @observable posts = {<span style="color: #8b2252;">'posts'</span>:[],<span style="color: #8b2252;">'pagination'</span>:{page:1,size:5,pages:0,total:0}}; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21015;&#34920;</span>

    constructor(){
        <span style="color: #008b8b;">this</span>.axios = axios.create({
            baseURL: <span style="color: #8b2252;">'/api/posts/'</span>
        })
    }

    getJwt(){
        <span style="color: #a020f0;">return</span> store.get(<span style="color: #8b2252;">"token"</span>,<span style="color: #8b2252;">''</span>)
    }

    pub(title,content){
        console.log(title);
        axios.post(<span style="color: #8b2252;">'/api/posts/'</span>,{
            title,content
        },{
            headers:{<span style="color: #8b2252;">'jwt'</span>: <span style="color: #008b8b;">this</span>.getJwt()}
        })<span style="color: #b22222;">/* </span><span style="color: #b22222;">dev server &#20250;&#20195;&#29702;</span><span style="color: #b22222;"> */</span>
        .then(
            response =&gt; {
                console.log(response.data);
                console.log(response.status);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#25104;&#21151;'</span>;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#21338;&#25991;&#25552;&#20132;&#22833;&#36133;'</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">+&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }

    getPost(id){
        <span style="color: #008b8b;">this</span>.axios.get(id).then(
            response =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27492;&#20989;&#25968;&#35201;&#27880;&#24847;this&#30340;&#38382;&#39064;</span>
                <span style="color: #008b8b;">this</span>.post = response.data.post;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt; {
                console.log(error);
                <span style="color: #008b8b;">this</span>.post = {}
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">"&#25991;&#31456;&#21152;&#36733;&#22833;&#36133;"</span>; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }

    list(page=1,size=2){
        <span style="color: #008b8b;">this</span>.axios.get(<span style="color: #8b2252;">`?page=${page}&amp;size=${size}`</span>).then(
            response =&gt; { <span style="color: #b22222;">//</span><span style="color: #b22222;">&#27880;&#24847;&#27492;&#20989;&#25968;&#30340;this&#38382;&#39064;</span>
                <span style="color: #008b8b;">this</span>.posts = response.data;
            }
        ).<span style="color: #a020f0;">catch</span>(
            error =&gt;{
                console.log(error);
                <span style="color: #008b8b;">this</span>.post = {}
                <span style="color: #008b8b;">this</span>.msg = <span style="color: #8b2252;">'&#25991;&#31456;&#21015;&#34920;&#21152;&#36733;&#22833;&#36133;'</span>;<span style="color: #b22222;">// </span><span style="color: #b22222;">&#20449;&#24687;&#26174;&#31034;</span>
            }
        )
    }
}

<span style="color: #a020f0;">const</span> <span style="color: #a0522d;">postService</span> = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">PostService</span>();
<span style="color: #a020f0;">export</span> {postService};
</pre>
</div>
</div>
<div id="outline-container-h:84c66087-1fe7-4aaf-aff7-74f3395bd685" class="outline-5">
<h5 id="h:84c66087-1fe7-4aaf-aff7-74f3395bd685">国际化</h5>
<div class="outline-text-5" id="text-h:84c66087-1fe7-4aaf-aff7-74f3395bd685">
<ul class="org-ul">
<li>上面分页中，当鼠标放在左右两端时发现上一页和下一页是英文。修改方法如下</li>
<li>index.js修改如下(部分代码)</li>
</ul>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #a020f0;">import</span> {LocaleProvider} from <span style="color: #8b2252;">'antd'</span>;
<span style="color: #a020f0;">import</span> moment from <span style="color: #8b2252;">'moment'</span>;
<span style="color: #a020f0;">import</span> zh_CN from <span style="color: #8b2252;">'antd/lib/locale-provider/zh_CN'</span>
<span style="color: #a020f0;">import</span> <span style="color: #8b2252;">'moment/locale/zh-cn'</span>

moment.locale(<span style="color: #8b2252;">'zh-cn'</span>)

ReactDom.render(&lt;LocaleProvider locale={zh_CN}&gt;&lt;App /&gt;&lt;/LocaleProvider&gt;, document.getElementById(<span style="color: #8b2252;">'root'</span>));
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d3614d6d-3876-4326-9ace-cd20f9df9d70" class="outline-3">
<h3 id="h:d3614d6d-3876-4326-9ace-cd20f9df9d70">项目部署</h3>
<div class="outline-text-3" id="text-h:d3614d6d-3876-4326-9ace-cd20f9df9d70">
<p>
[toc]
</p>
</div>
<div id="outline-container-h:77405a37-bdc1-4f4b-8d4d-b186fea9a7d0" class="outline-4">
<h4 id="h:77405a37-bdc1-4f4b-8d4d-b186fea9a7d0">Django 打包</h4>
<div class="outline-text-4" id="text-h:77405a37-bdc1-4f4b-8d4d-b186fea9a7d0">
<ul class="org-ul">
<li>生成项目依赖插件版本信息</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">## </span><span style="color: #b22222;">&#24212;&#29992;&#31243;&#24207;&#30340;&#26681;&#30446;&#24405;&#19979;&#29983;&#25104;</span>
$ pip freeze &gt;requirements
</pre>
</div>

<ul class="org-ul">
<li>构建setup.py文件(在应用程序根目录下面)</li>
</ul>

<div class="org-src-container">
<pre class="src src-py">from distutils.core import setup
import glob

setup(name='blog',
      version='1.0',
      description='www.mumuxi.online',
      author='mumuxi',
      author_email="mumuxi@qq.com",
      url='https://www.mumuxi.online',
      packages=["MicroBlog",'post','user','utils','djweb'],
      py_modules=["manage"],
      data_files=glob.glob("templates/*.html") + ["requirements"]
      )
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">## </span><span style="color: #b22222;">&#24212;&#29992;&#31243;&#24207;&#30340;&#36319;&#30446;&#24405;&#19979;&#25171;&#21253;</span>
$ python setup.py sdist --formats=gztar <span style="color: #b22222;">#</span><span style="color: #b22222;">gz</span>
</pre>
</div>

<ul class="org-ul">
<li>在Linux系统中创建一个python虚拟环境目录，使用pyenv</li>
<li>安装pyenv</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">yum install git python-devel mysql-devel </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">yum -y install gcc make patch gdbm-devel openssl-devel sqlite-devel readline-devel zlib-devel bzip2-devel</span>

python&#20381;&#36182;&#65292;mysqlclient&#20381;&#36182;
<span style="color: #b22222;"># </span><span style="color: #b22222;">yum install python-devel mysql-devel</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">useradd python</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">echo python | passwd python --stdin</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">su - python</span>

&#36827;&#20837;python&#29992;&#25143;&#25191;&#34892;&#22914;&#19979;&#25805;&#20316;
$ curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash
$ vim ~/.bashrc
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PATH</span>=<span style="color: #8b2252;">"/home/root/.pyenv/bin:$PATH"</span>
<span style="color: #483d8b;">eval</span> <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">pyenv init -</span><span style="color: #8b2252;">)"</span>
<span style="color: #483d8b;">eval</span> <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">pyenv virtualenv-init -</span><span style="color: #8b2252;">)"</span>

$ pyenv install 3.6.6 -vv

&#20934;&#22791;pip&#37197;&#32622;&#25991;&#20214;
$ mkdir ~/.pip
$ vim ~/.pip/pip.conf
[global]
index-url = https://mirrors.aliyun.com/pypi/simple/

[install]
trusted-host=mirrors.aliyun.com

&#23433;&#35013;&#34394;&#25311;&#29615;&#22659;
$ pyenv virtualenv 3.6.6 blog366
$ mkdir -p projects
$ cd projects 
$ tar xf blog-1.0.tar.gz
$ ln -sv blog-1.0 web
<span style="color: #8b2252;">"web"</span> -&gt; <span style="color: #8b2252;">"blog-1.0"</span>
$ cd web
$ pwd
/home/python/projects/web

$ pyenv local blog366
$ pip list
$ pip install -r requirements  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#20381;&#36182;&#21253;</span>
$ sed -i -e <span style="color: #8b2252;">'s/DEBUG.*/DEBUG = False/'</span> -e <span style="color: #8b2252;">'s/ALLOWED_HOSTS.*/ALLOWED_HOSTS = ["*"]/'</span> djweb/setting.py <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;Django&#37197;&#32622;</span>
$ python manage.py runserver 0.0.0.0:9112 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;</span>
</pre>
</div>

<ul class="org-ul">
<li>使用=<a href="http://www.mumuxi.online:9112/posts/?page=2&amp;size=2">http://www.mumuxi.online:9112/posts/?page=2&amp;size=2</a>=
成功返回数据，说明Django应用成功。</li>
<li>至此，Django应用部署完成。Django带了个开发用Web Server.
生成环境不用，需要借助其他Server。</li>
<li>注意：ALLOWED_HOSTS=[“*”]
这是所有都可以访问，生产环境应指定具体可以访问的IP，而不是所有。</li>
</ul>
</div>
</div>
<div id="outline-container-h:ae32511d-2909-4b0e-bcf9-b001c184edc2" class="outline-4">
<h4 id="h:ae32511d-2909-4b0e-bcf9-b001c184edc2">WSGI</h4>
<div class="outline-text-4" id="text-h:ae32511d-2909-4b0e-bcf9-b001c184edc2">
<ul class="org-ul">
<li>Web Server Gateway Interface,是Python中定义的WSGI
Server与应用程序的接口定义。</li>
<li>应用程序符合WSGI规范的Django框架负责，</li>
</ul>
</div>
</div>
<div id="outline-container-h:e71c9208-5f11-4cdc-8f4d-518b32b89655" class="outline-4">
<h4 id="h:e71c9208-5f11-4cdc-8f4d-518b32b89655">uWSGI</h4>
<div class="outline-text-4" id="text-h:e71c9208-5f11-4cdc-8f4d-518b32b89655">
<ul class="org-ul">
<li>uWSGI是一个c语言的项目，提供一个WEB服务器，它支持WSGI协议，可以和Python的WGSI应用程序通信。</li>
<li>官方文档<a href="https://uwsgi-docs.readthedocs.io/en/latest/">https://uwsgi-docs.readthedocs.io/en/latest/</a><br></li>
<li>uWSGI可以直接启动HTTP服务，接收HTTP请求，并调用Django应用。</li>
<li>安装</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ pip install uwsgi
$ uwsgi --help
</pre>
</div>
</div>
</div>
<div id="outline-container-h:531e8839-c96e-489f-a66b-f53626a25a85" class="outline-4">
<h4 id="h:531e8839-c96e-489f-a66b-f53626a25a85">uWSGI+Django部署</h4>
<div class="outline-text-4" id="text-h:531e8839-c96e-489f-a66b-f53626a25a85">
<ul class="org-ul">
<li>在Django项目根目录下，运行=$ uwsgi &#x2013;http :8000 &#x2013;wsgi-file djweb/wsgi.py &#x2013;stats :8001 &#x2013;stats-http=,使用下面链接测试

<ol class="org-ol">
<li><a href="http://www.mumuxi.online:8000/">http://www.mumuxi.online:8000/</a></li>
<li><a href="http://www.mumuxi.online:8000/posts/?page=2&amp;size=2">http://www.mumuxi.online:8000/posts/?page=2&amp;size=2</a></li>

<li>运行正常。</li>
</ol></li>

<li>=stats=能够显示服务器状态值。
=&#x2013;stats-http=选项可以使用http访问这个值。</li>

<li>安装uwsgitop获取这个stat值。注意使用这个命令不要使用=&#x2013;stats-http=选项。</li>
</ul>

<div class="org-src-container">
<pre class="src src-js">$ pip install uwsgitop
$ uwsgitop --frequency www.mumuxi.online:8001
</pre>
</div>

<ul class="org-ul">
<li>使用uwsgi启动项目(http协议启动)
<code>uwsgi --http 127.0.0.1:8889 --wsgi-file djweb/wsgi.py</code></li>
<li>使用uwsgi启动项目(uwsgi协议启动,二进制通信协议。速度快)
<code>uwsgi --socket 127.0.0.1:8889 --wsgi-file djweb/wsgi.py</code></li>
</ul>
</div>
<div id="outline-container-h:8c3dff55-6664-41da-af14-9757d8a1a874" class="outline-5">
<h5 id="h:8c3dff55-6664-41da-af14-9757d8a1a874">uwsgi配置文件</h5>
<div class="outline-text-5" id="text-h:8c3dff55-6664-41da-af14-9757d8a1a874">
<ul class="org-ul">
<li>本次pyenv的虚拟目录是=/home/python/package/web=,将Django项目所有项目文件和目录放在这个目录下面。uwsgi的配置文件blog.ini也放在这个目录中(blog.ini文件配置后可以快捷启动服务)</li>
</ul>


<ul class="org-ul">
<li>blog.ini配置如下：</li>
</ul>

<div class="org-src-container">
<pre class="src src-ini">[uwsgi]
socket = 127.0.0.1:8889
chdir = /home/python/package/web
wsgi-file = djweb/wsgi.py
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">配置</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">socket=127.0.0.1:8889</td>
<td class="org-left">使用uwsgi协议通信</td>
</tr>

<tr>
<td class="org-left">chdir = /home/python/package/web</td>
<td class="org-left">Django项目的根目录</td>
</tr>

<tr>
<td class="org-left">wsgi-file = djweb/wsgi.py</td>
<td class="org-left">指定App文件，blog下wsgi.py</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>使用配置文件blog.ini启动命令为(项目跟目录下启动)： <code>uwsgi blog.ini</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:9185b89b-14dd-499c-8c9b-daa39778fe37" class="outline-4">
<h4 id="h:9185b89b-14dd-499c-8c9b-daa39778fe37">React项目打包</h4>
<div class="outline-text-4" id="text-h:9185b89b-14dd-499c-8c9b-daa39778fe37">
<ul class="org-ul">
<li>rimraf递归删除文件，rem -rf</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">$ npm install rimraf --save-dev
&#25110;&#32773;
$ yarn add rimraf --dev

&#22312;package.json&#20013;&#26367;&#25442;
<span style="color: #8b2252;">"build"</span>: <span style="color: #8b2252;">"rimraf dist &amp;&amp; webpack -p --config webpack.config.prod.js"</span>

$ npm run build
&#25110;&#32773;
$ yarn run build 
&#32534;&#35793;&#25104;&#21151;&#12290;&#26597;&#30475;&#39033;&#30446;&#30446;&#24405;&#20013;&#30340;dist&#30446;&#24405;&#12290;
</pre>
</div>

<ul class="org-ul">
<li>将编译成功后的静态文件放入对应的web静态文件中即可(即nginx相应的web目录)</li>
</ul>
</div>
</div>
<div id="outline-container-h:c77e494a-c921-4d14-8256-379cd67d7c6a" class="outline-4">
<h4 id="h:c77e494a-c921-4d14-8256-379cd67d7c6a">nginx uwsgi部署</h4>
<div class="outline-text-4" id="text-h:c77e494a-c921-4d14-8256-379cd67d7c6a">
</div>
<div id="outline-container-h:905435b7-6141-4b92-9c21-ebe0293f0362" class="outline-5">
<h5 id="h:905435b7-6141-4b92-9c21-ebe0293f0362">tengine安装</h5>
<div class="outline-text-5" id="text-h:905435b7-6141-4b92-9c21-ebe0293f0362">
<ul class="org-ul">
<li>淘宝提供的nginx</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">yum install gcc openssl-devel pcre-devel -y</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">tar xf tengine-1.2.3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd tengine-1.2.3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">./configure --help | grep wsgi</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">./configure # &#31532;&#19968;&#27493;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">make &amp;&amp; make install # &#31532;&#20108;&#27493;&#12289;&#31532;&#19977;&#27493;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd /usr/local/nginx/ # &#40664;&#35748;&#23433;&#35013;&#20301;&#32622;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b6b1c7f3-daf6-439a-ae14-01dbceaa3ef8" class="outline-5">
<h5 id="h:b6b1c7f3-daf6-439a-ae14-01dbceaa3ef8">http部署</h5>
<div class="outline-text-5" id="text-h:b6b1c7f3-daf6-439a-ae14-01dbceaa3ef8">
<ul class="org-ul">
<li>nginx配置
<ol class="org-ol">
<li>=^~ /api/=左前缀匹配</li>
<li><code>rewrite ^/api(/.*) $1 break;</code> 重写请求的path</li>
</ol></li>
</ul>

<div class="org-src-container">
<pre class="src src-ini">server {
        listen       8888 ;
        listen       [::]:8888 ;
        server_name  0.0.0.0 ;

        location ^~ /api/ {
           rewrite ^/api(/.*) $1 break;
           proxy_pass http://127.0.0.1:8889;
        }

        location / {
           root /data/web;
           index index.html;
        }

        error_page 404 /404.html;
            location = /40x.html {
        }

        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
</pre>
</div>

<ul class="org-ul">
<li>修改后启动nginx。</li>
</ul>
</div>
</div>
<div id="outline-container-h:f2c7c726-1700-46dc-8945-4f0c8a12e84a" class="outline-5">
<h5 id="h:f2c7c726-1700-46dc-8945-4f0c8a12e84a">uwsgi部署</h5>
<div class="outline-text-5" id="text-h:f2c7c726-1700-46dc-8945-4f0c8a12e84a">
<ul class="org-ul">
<li>目前nginx和uwsgi直接使用的是HTTP通信，效率低。改为使用uwsgi通信。</li>
<li>使用uwsgi协议的命令行写法如下
<ol class="org-ol">
<li><code>uwsgi --socket 127.0.0.1:8889 --wsgi-file djweb/wsgi.py</code></li>
</ol></li>
<li>在nginx中配置uwsgi
<a href="http://nginx.org/en/docs/http/ngx_http_uwsgi_module.html">http://nginx.org/en/docs/http/ngx_http_uwsgi_module.html</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-ini">server {
    listen       8888 ;
    listen       [::]:8888 ;
    server_name  0.0.0.0 ;

    location ^~ /api/ {
       rewrite ^/api(/.*) $1 break;
       #proxy_pass http://127.0.0.1:8889;
       include      uwsgi_params;
       uwsgi_pass   127.0.0.1:8889;
    }

    location / {
       root /data/web;
       index index.html;
    }

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}
</pre>
</div>

<ul class="org-ul">
<li>重新加载nginx配置文件，成功运行。至此，前后端分离的开发、动静分离的部署的博客项目大功告成！</li>

<li>参看
<a href="https://uwsgi-docs.readthedocs.io/en/latest/WSGIquickstart.html">https://uwsgi-docs.readthedocs.io/en/latest/WSGIquickstart.html</a></li>

<li>uwsgi协议<a href="https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html">https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:57f85199-6bac-4176-beab-3fd39aebf2a0" class="outline-4">
<h4 id="h:57f85199-6bac-4176-beab-3fd39aebf2a0">部署图</h4>
<div class="outline-text-4" id="text-h:57f85199-6bac-4176-beab-3fd39aebf2a0">
<ol class="org-ol">
<li>浏览器通过互联网HTTP协议访问NGINX</li>
<li>静态内容(图片、JS、CSS、文件)都是Nginx负者提供WEB服务</li>
<li>Nginx配置代理。可以死Http和Socket通信。本次使用uwsgi协议</li>
<li>uWSGI服务程序提供uwsgi协议的支持，将从Nginx发来的请求封装后调用WSGI的Application。这个Application可能很复杂，有可能是基于Django框架编写。这个程序将获得请求信息。</li>
<li>通过Django的路由，将请求交给视图函数(类)处理，可能需要访问数据库数据，也可能使用了模板。最终数据返回给浏览器。</li>
</ol>
</div>
</div>
<div id="outline-container-h:91193b33-eb0b-41b9-858d-409153ca09cc" class="outline-4">
<h4 id="h:91193b33-eb0b-41b9-858d-409153ca09cc">MVC设计模式</h4>
<div class="outline-text-4" id="text-h:91193b33-eb0b-41b9-858d-409153ca09cc">
<ul class="org-ul">
<li>Controller控制器：负者接收用户请求，调用Model完成数据，调用view完成对用户的响应</li>
<li>Model模型：负责业务数据的处理</li>
<li>View视图：负责用户的交互界面</li>
</ul>


<ul class="org-ul">
<li>Model层
<ol class="org-ol">
<li>ORM建立对象关系映射，提供数据库操作</li>
</ol></li>
<li>Template层
<ol class="org-ol">
<li>负责数据的可视化，使用HTML、CSS等构成模板，将数据应用到模板中，并返回给浏览器。</li>
</ol></li>
<li>View层
<ol class="org-ol">
<li>Django完成URL映射后，把请求交给View层的视图函数处理，调用Model层完成数据，如有必要调用Template层响应客户端，如果不需要，直接返回数据。</li>
</ol></li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a41882ae-8e1b-49a9-bc6b-dc1a42cb8a06" class="outline-2">
<h2 id="h:a41882ae-8e1b-49a9-bc6b-dc1a42cb8a06">Session</h2>
<div class="outline-text-2" id="text-h:a41882ae-8e1b-49a9-bc6b-dc1a42cb8a06">
</div>
<div id="outline-container-h:1b51cfd9-d386-40d1-bf4e-d39052400add" class="outline-3">
<h3 id="h:1b51cfd9-d386-40d1-bf4e-d39052400add">Session-Cookie机制</h3>
<div class="outline-text-3" id="text-h:1b51cfd9-d386-40d1-bf4e-d39052400add">
<ul class="org-ul">
<li>网景公司发明了Cookie技术，为了解决浏览器端数据存储问题。
<ol class="org-ol">
<li>每一次request请求时，会把此域名相关的Cookie发往服务器端。服务器端也可以使用response中的set-cookie来
设置cookie值。<br></li>
</ol></li>
<li>动态网页技术，也需要知道用户身份，但是HTTP是无状态协议，无法知道。必须提出一种技术，让客户端提交的信息可以表明身份，而且不能更改。这就是Session技术。</li>
<li>Session开启后，会为浏览器端设置一个Coolie值，即SessionID.</li>
<li>这个放置SessionID的Cookie是会话级的，浏览器不做持久化存储只放在内存中，并且浏览器关闭自动清除。浏览器端发起一个HTTP请求后，这个SessionID会通过Cookie发到服务器端，服务端就可以通过这个ID查到对应的一个字典结构。如果查无此ID,就为此浏览器重新生成一个SessionID,为它建立一个SessionID和空字典的映射关系。</li>
<li>可以在这个ID对应的Session字典中，存入键值对来保持与当前会话相关的信息。
<ol class="org-ol">
<li>Session会定期过期清除</li>
<li>Session占用服务端内存</li>
<li>Session如果没有持久化，如果服务程序崩溃，那么所有Session信息丢失</li>
<li>Session可以持久化到数据库中，如果服务程序崩溃，那么可以从数据库中恢复</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:00125130-88c9-489a-b030-378e2cc122a7" class="outline-3">
<h3 id="h:00125130-88c9-489a-b030-378e2cc122a7">开启session支持</h3>
<div class="outline-text-3" id="text-h:00125130-88c9-489a-b030-378e2cc122a7">
<ul class="org-ul">
<li>Django可以使用Session
<ol class="org-ol">
<li>在settings中，MIDDLEWARE设置中，启用=django.contrib.sessions.middleware.SessionMiddleware=。</li>
<li>在INSTALLED_APPS设置中，启用=django.contrib.sessions=。它是基于数据库存储的Session。</li>
<li>Session不使用，可以关闭上述配置，以减少开销</li>
<li>在数据库的表中的django_session表，记录session信息。但可以使用文件系统或其他cache来存储</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:79bb20b6-9c21-4a66-9791-c44961341cdd" class="outline-3">
<h3 id="h:79bb20b6-9c21-4a66-9791-c44961341cdd">登录登出实现</h3>
<div class="outline-text-3" id="text-h:79bb20b6-9c21-4a66-9791-c44961341cdd">
</div>
<div id="outline-container-h:cf04c31b-5db7-4da6-a563-dc4c394301ae" class="outline-4">
<h4 id="h:cf04c31b-5db7-4da6-a563-dc4c394301ae">登录实现</h4>
<div class="outline-text-4" id="text-h:cf04c31b-5db7-4da6-a563-dc4c394301ae">
<ul class="org-ul">
<li>原来登录成功，会使用jwt的token发往客户端。现在不需要了，只需要在Session中记录登录信息即可。(Django默认请求session会持久化数据库中的django_session表中)</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">jsonify</span>(obj,allow=<span style="color: #008b8b;">None</span>,exclude=<span style="color: #483d8b;">set</span>()):
    <span style="color: #8b2252;">"""# &#31579;&#36873;&#23545;&#35937;&#20013;&#30340;&#23646;&#24615;&#65292;allow&#30333;&#21517;&#21333;&#65292;exclude&#40657;&#21517;&#21333;"""</span>
    <span style="color: #a020f0;">if</span> allow:
        <span style="color: #a0522d;">allow</span> = <span style="color: #483d8b;">set</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: <span style="color: #483d8b;">str</span>.lower(x), allow))
        <span style="color: #a0522d;">fn</span> = <span style="color: #a020f0;">lambda</span> x: x.name.lower() <span style="color: #a020f0;">in</span> allow
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">exclude</span> = <span style="color: #483d8b;">set</span>(<span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x: <span style="color: #483d8b;">str</span>.lower(x), exclude))
        <span style="color: #a0522d;">fn</span> = <span style="color: #a020f0;">lambda</span> x: x.name.lower() <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> exclude
    <span style="color: #a0522d;">names</span> = <span style="color: #483d8b;">type</span>(obj)._meta.fields <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#30340;&#21015;</span>
    <span style="color: #a020f0;">return</span> {i.name:<span style="color: #483d8b;">getattr</span>(obj,i.name) <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">filter</span>(fn,names)}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#25143;&#30331;&#24405;</span>
<span style="color: #228b22;">@require_POST</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">login</span>(request:HttpRequest):
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">palyload</span> = simplejson.loads(request.body)
        <span style="color: #a0522d;">email</span> = palyload[<span style="color: #8b2252;">"email"</span>]
        <span style="color: #a0522d;">password</span> = palyload[<span style="color: #8b2252;">"password"</span>].encode()
        <span style="color: #a0522d;">name</span> = palyload[<span style="color: #8b2252;">"name"</span>]
        <span style="color: #a0522d;">user</span> = User.objects.get(email=email)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;&#23494;&#30721;</span>
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> bcrypt.checkpw(password,user.password.encode()):
            <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>: XddError.USERPW_ERROR},404)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">token = get_token(user.id)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">res = JsonResponse({</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">"user":jsonify(user,exclude={"password"}),</span>
        <span style="color: #b22222;">#     </span><span style="color: #b22222;">"token":token</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">},status=201)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">res.set_cookie(settings.TOKEN,token)</span>

        <span style="color: #a020f0;">from</span> django.contrib.sessions.backends.db <span style="color: #a020f0;">import</span> SessionStore <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25345;&#20037;&#30340;session</span>
        <span style="color: #a0522d;">session</span>:<span style="color: #228b22;">SessionStore</span> = request.session
        <span style="color: #483d8b;">print</span>(session,<span style="color: #483d8b;">type</span>(session))
        <span style="color: #483d8b;">print</span>(session.keys())
        session.set_expiry(300) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;session&#20250;&#35805;&#36807;&#26399;&#26102;&#38388;300&#31186;</span>
        <span style="color: #a0522d;">session</span>[<span style="color: #8b2252;">"user_id"</span>] = user.<span style="color: #483d8b;">id</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">session["user_info"] = "&lt;{} {} {}&gt;".format(user.id,user.name,user.email) #&#20250;&#23384;&#20648;&#22312;&#26381;&#21153;&#31471;&#65292;&#25968;&#25454;&#24211;&#20013;</span>
        <span style="color: #a0522d;">uobj</span> = jsonify(user,exclude=[<span style="color: #8b2252;">"password"</span>])
        <span style="color: #a0522d;">session</span>[<span style="color: #8b2252;">"user_info"</span>] = uobj
        <span style="color: #b22222;"># </span><span style="color: #b22222;">u = session["user_info"]</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(u)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print("-"*30)</span>
        <span style="color: #a0522d;">res</span> = JsonResponse({
            <span style="color: #8b2252;">"user"</span>:uobj
        },status=201)
        <span style="color: #a020f0;">return</span> res
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        logging.info(e)
        <span style="color: #a020f0;">return</span> JsonResponse({
            <span style="color: #8b2252;">"error"</span>: XddError.USERPW_ERROR
        },status=404)  <span style="color: #b22222;"># </span><span style="color: #b22222;">404&#38169;&#35823;</span>
</pre>
</div>

<ul class="org-ul">
<li>登录成功，浏览器端，就能收到一条set-Cookie</li>
</ul>

<div class="org-src-container">
<pre class="src src-js">sessionid=hjg0j01pbvadxdjd5jf9pn91larvv10t; path=<span style="color: #8b2252;">/; domain=localhost; HttpOnly; Expires=Wed, 24 Jul 2019 13:19:01 GMT;</span>
</pre>
</div>

<ul class="org-ul">
<li>session.set_expiry(300)方法。设置session过期时间
<ol class="org-ol">
<li>300秒过期</li>
<li>None表示使用全局session过期策略</li>
<li>0表示会话级session,即浏览器关闭过期</li>
<li>datetime对象表示在指定时间点过期</li>
</ol></li>
<li>建议不要再Session中保存太多数据，也不要保存过于复杂的类型。</li>
</ul>
</div>
</div>
<div id="outline-container-h:6c828a95-b6c7-4435-b4b9-595ef9fcd48e" class="outline-4">
<h4 id="h:6c828a95-b6c7-4435-b4b9-595ef9fcd48e">认证实现</h4>
<div class="outline-text-4" id="text-h:6c828a95-b6c7-4435-b4b9-595ef9fcd48e">
<ul class="org-ul">
<li>取消原有判断HTTP
hander中是否提供了JWT信息，改为判断该SessionID是否能找到一个字典，这个字典中是否有登录成功后设置的user_id键值对信息。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36523;&#20221;&#35748;&#35777;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">authenticate</span>(fn):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_wapper</span>(*args,**kwargs):
        <span style="color: #a020f0;">try</span>:
            *<span style="color: #a0522d;">_</span>,<span style="color: #a0522d;">request</span> = args
            <span style="color: #b22222;"># </span><span style="color: #b22222;"># &#20174;&#35831;&#27714;cooker&#20013;&#33719;&#21462;token</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">token = request.META.get(settings.HTTP_TOKEN)</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">if not token:</span>
            <span style="color: #b22222;">#     </span><span style="color: #b22222;">logging.info("&#36523;&#20221;&#35748;&#35777;&#22833;&#36133;")</span>
            <span style="color: #b22222;">#     </span><span style="color: #b22222;">return HttpResponse(status=401)</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;"># &#39564;&#35777;</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">id = jwt.decode(token,settings.SECRET_KEY,alogorithms=[settings.JWT_ARITHMETIC])["user_id"]</span>
            <span style="color: #a020f0;">from</span> django.contrib.sessions.backends.db <span style="color: #a020f0;">import</span> SessionStore  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25345;&#20037;&#30340;session</span>
            <span style="color: #a0522d;">session</span>:<span style="color: #228b22;">SessionStore</span> = request.session
            <span style="color: #483d8b;">id</span> = session[<span style="color: #8b2252;">"user_id"</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#33719;&#21462;&#22833;&#36133;&#65292;&#35828;&#26126;session&#36807;&#26399;&#65292;&#25110;&#27809;&#26377;</span>
            <span style="color: #a0522d;">user</span> = User.objects.get(<span style="color: #483d8b;">id</span>=<span style="color: #483d8b;">id</span>)
            request.<span style="color: #a0522d;">user</span> = user
            <span style="color: #a0522d;">res</span> = fn(*args, **kwargs)
            <span style="color: #a020f0;">return</span> res
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            logging.info(e)
            <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:XddError.LOGIN_OUT_TIME},status=401)
    <span style="color: #a020f0;">return</span> _wapper
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9eac4773-3e36-40a0-ae19-6f8123e55d40" class="outline-4">
<h4 id="h:9eac4773-3e36-40a0-ae19-6f8123e55d40">登录代码</h4>
<div class="outline-text-4" id="text-h:9eac4773-3e36-40a0-ae19-6f8123e55d40">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #228b22;">@require_POST</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;url&#36335;&#30001;</span>
<span style="color: #228b22;">@authenticate</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26377;&#38656;&#35201;&#30340;&#35270;&#22270;&#20989;&#25968;&#19978;&#21152;&#19978;&#35013;&#39280;&#22120; #&#27809;&#26377;&#30331;&#24405;&#36807;&#65292;&#23601;&#19981;&#29992;&#30331;&#20986;&#20102;&#65292;&#25152;&#20197;&#35201;&#35748;&#35777;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">logout</span>(request:HttpRequest):
    <span style="color: #a0522d;">info</span> = <span style="color: #8b2252;">"{} logout."</span>.<span style="color: #483d8b;">format</span>(request.session[<span style="color: #8b2252;">"user_id"</span>])
    <span style="color: #a020f0;">del</span> request.session[<span style="color: #8b2252;">"user_id"</span>]  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#20250;&#28165;&#38500;&#25968;&#25454;&#24211;&#20013;&#35760;&#24405;</span>
    request.session.flush()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24773;&#20917;&#24403;&#21069;session,&#21024;&#38500;&#34920;&#20013;&#23545;&#24212;&#35760;&#24405;</span>
    <span style="color: #a020f0;">return</span> JsonResponse({},status=200)
</pre>
</div>

<ul class="org-ul">
<li>登出时，需要调用flush方法，清除session,清除数据库记录。</li>

<li>登录成功，为当前session在django_session表中增加一条记录，如果没有登出操作，那么该记录不会消失。Django也没有自动清除记录的功能。但是Django提供了一个命令clearsessions，建议在cron中定期执行。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">django-admin.py clearsessions
manage.py clearsessions
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e8ec8605-2d82-47c2-9032-7103d4dbb9c2" class="outline-4">
<h4 id="h:e8ec8605-2d82-47c2-9032-7103d4dbb9c2">不需要认证的view函数中使用Session</h4>
<div class="outline-text-4" id="text-h:e8ec8605-2d82-47c2-9032-7103d4dbb9c2">
<ul class="org-ul">
<li>在当前会话中，每次request请求中都会得到浏览器端发出的SessionID，因此都可以在服务器端找到该ID对应的Session字典，可以使用request.session访问。</li>
<li>所有请求都可以使用request.session对象，ID找不到可以认为返回个空字典。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test1</span>(request): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35270;&#22270;&#20989;&#25968;&#65292;&#38656;&#35201;&#37197;&#32622;url&#26144;&#23556;</span>
    <span style="color: #a020f0;">if</span> request.session.get(<span style="color: #8b2252;">"user_id"</span>): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;Session&#23383;&#20856;&#20013;&#30340;&#20540;</span>
        <span style="color: #483d8b;">print</span>(request.session.items())
        <span style="color: #a020f0;">return</span> HttpResponse(<span style="color: #8b2252;">"test1 ok"</span>)
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a020f0;">return</span> HttpResponseBadRequest() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#27492;&#20449;&#24687;&#65292;&#35828;&#26126;&#27809;&#26377;&#30331;&#24405;&#25104;&#21151;&#36807;</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:063f8fb3-8941-4194-986f-af4d0345aeae" class="outline-2">
<h2 id="h:063f8fb3-8941-4194-986f-af4d0345aeae">Celery调度+Redis安装</h2>
<div class="outline-text-2" id="text-h:063f8fb3-8941-4194-986f-af4d0345aeae">
<p>
Celery是一个使用Python开发的*分布式任务调度模块*，因此对于大量使用Python构建的系统,使用起来方便。<br>
Celery目前爸爸4.x,仅支持Django 1.8以上版本。 Celery
3.1只可以支持Django1.8一下版本。
</p>

<ul class="org-ul">
<li>Celery官网<a href="http://www.celeryproject.org/">http://www.celeryproject.org/</a><br></li>

<li>Celery帮助文档<a href="http://www.celeryproject.org/docs-and-support/">http://www.celeryproject.org/docs-and-support/</a></li>

<li>优点：

<ol class="org-ol">
<li>简单：调用接口简单易用</li>
<li>高可用：客户端、Worker之间连接自动重试，Broker自身支持HA</li>
<li>快速：单个Celery进程每分钟可用数以百万计的任务</li>
<li>灵活：Celery的每一个部分都能扩展，或直接使用，或用户自己定义。</li>
</ol></li>
</ul>
</div>
<div id="outline-container-h:9f13b1bc-1b9c-4ee5-9f90-9c380a700b01" class="outline-3">
<h3 id="h:9f13b1bc-1b9c-4ee5-9f90-9c380a700b01">常用应用</h3>
<div class="outline-text-3" id="text-h:9f13b1bc-1b9c-4ee5-9f90-9c380a700b01">
<ul class="org-ul">
<li>Celery可用支持实时异步任务处理，也支持任务的定时调度。
<ol class="org-ol">
<li>异步发邮件
<ul class="org-ul">
<li>cleery执行队列</li>
</ul></li>
<li>间隔半小时同步天气信息等
<ul class="org-ul">
<li>celery定时操作</li>
</ul></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-h:f2133bdb-eb52-4366-bee2-456bd8bfaa44" class="outline-3">
<h3 id="h:f2133bdb-eb52-4366-bee2-456bd8bfaa44">角色</h3>
<div class="outline-text-3" id="text-h:f2133bdb-eb52-4366-bee2-456bd8bfaa44">
<ul class="org-ul">
<li>任务Task:对应一个Python函数</li>
<li>队列Queue:待执行任务的队列</li>
<li>工人Worker:一个新的进程，负者执行任务</li>
<li>代理Broker:负者调度，在任务环境中使用RabbitMQ、Redis等</li>

<li>Celery需要依靠RabbitMQ等作为消息代理，同时也支持Redis甚至是Mysql、Mongo等，当然，官方默认推荐的是RabbitMQ,如果使用Redis需要配置。<br></li>
<li>本次采用Redis来作为Broker，也是Redis存储任务结果</li>
</ul>
</div>
</div>
<div id="outline-container-h:e1a64a83-ae9f-4ced-93bf-6f6e106aa689" class="outline-3">
<h3 id="h:e1a64a83-ae9f-4ced-93bf-6f6e106aa689">安装</h3>
<div class="outline-text-3" id="text-h:e1a64a83-ae9f-4ced-93bf-6f6e106aa689">
<div class="org-src-container">
<pre class="src src-shell">$ pip install <span style="color: #a0522d;">celery</span>==4.2.0

&#23433;&#35013;&#23545;redis&#30340;&#25903;&#25345;&#65292;&#24182;&#33258;&#21160;&#21319;&#32423;&#30456;&#20851;&#20381;&#36182;
$ pip install -U <span style="color: #8b2252;">"celery[redis]"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6f37594c-0051-46aa-8746-e5529645b932" class="outline-3">
<h3 id="h:6f37594c-0051-46aa-8746-e5529645b932">测试</h3>
<div class="outline-text-3" id="text-h:6f37594c-0051-46aa-8746-e5529645b932">
<p>
Celery库使用前，必须初始化，所得示例叫做”应用application或app”。应用是线程安全的。不同应用在同一进程中，可以使用不同拍照、不同组件、不同结果
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> celery <span style="color: #a020f0;">import</span> Celery
<span style="color: #a0522d;">app</span> = Celery(<span style="color: #8b2252;">'mytask'</span>)
<span style="color: #483d8b;">print</span>(app)

<span style="color: #228b22;">@app.task</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add</span>(x,y):
    <span style="color: #a020f0;">return</span> x+y

<span style="color: #483d8b;">print</span>(add.name) <span style="color: #b22222;">#</span><span style="color: #b22222;">mytask.add</span>
<span style="color: #483d8b;">print</span>(add)

<span style="color: #483d8b;">print</span>(app.tasks)
<span style="color: #483d8b;">print</span>(app.conf)
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">list</span>(app.conf.items()),sep = <span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
</pre>
</div>

<ul class="org-ul">
<li>默认使用amqp链接到本地amqp://guest:**?? (????)/</li>
<li>本次使用Redis</li>
</ul>
</div>
<div id="outline-container-h:a49a66e6-d683-403f-9227-058ec79afd58" class="outline-4">
<h4 id="h:a49a66e6-d683-403f-9227-058ec79afd58">Redis安装配置</h4>
<div class="outline-text-4" id="text-h:a49a66e6-d683-403f-9227-058ec79afd58">
<ul class="org-ul">
<li>使用Epel源的rpm安装</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">redis&#23433;&#35013;&#65292;&#20351;&#29992;&#25552;&#20379;&#30340;rpm&#23433;&#35013;&#65292;redis&#20381;&#36182;jemalloc

<span style="color: #b22222;"># </span><span style="color: #b22222;">yum install jemalloc-3.6.0-1.el7.x86_64.rpm redis-3.2.12-2.el7.x86_64.rpm</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">rpm -pql redis-3.2.12-2.el7.x86_64.rpm</span>
/etc/logrotate.d/redis
/etc/redis-sentinel.conf
/etc/redis.conf
/usr/bin/redis-cli
/usr/bin/redis-sentinel
/usr/bin/redis-server
/usr/lib/systemd/system/redis-sentinel.service
/usr/lib/systemd/system/redis.service

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#36753;redis&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">vi /ect/redis.conf</span>
port 6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26102;&#30340;&#40664;&#35748;&#31471;&#21475;</span>
<span style="color: #483d8b;">bind</span> 192.168.61.109  <span style="color: #b22222;">#</span><span style="color: #b22222;">redis&#21551;&#21160;&#26102;&#30340;&#20027;&#26426;</span>
protected-mode no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;&#20445;&#25252;&#27169;&#24335;</span>
</pre>
</div>

<ul class="org-ul">
<li>启动、停止redis服务</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">## </span><span style="color: #b22222;">&#21551;&#21160;&#26381;&#21153;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl start redis </span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#20572;&#27490;&#26381;&#21153;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl stop redis</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#28155;&#21152;&#24320;&#26426;&#21551;&#21160;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl enable redis</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c0b21400-af23-4fc4-98f8-18dfea47b6ff" class="outline-4">
<h4 id="h:c0b21400-af23-4fc4-98f8-18dfea47b6ff">broker配置使用</h4>
<div class="outline-text-4" id="text-h:c0b21400-af23-4fc4-98f8-18dfea47b6ff">
<ul class="org-ul">
<li>redis链接字符串格式=redis://password@hostname:port/db_number=</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26381;&#21153;&#22120;&#30340;redis&#31471;&#21475;6379&#65292;&#20351;&#29992;0&#21495;&#24211;</span>
app.conf.broker_url = <span style="color: #8b2252;">'redis://192.168.61.109:6379/0'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:af3524be-95b5-40e9-a562-e542463568a0" class="outline-4">
<h4 id="h:af3524be-95b5-40e9-a562-e542463568a0">Celery使用</h4>
<div class="outline-text-4" id="text-h:af3524be-95b5-40e9-a562-e542463568a0">
<ul class="org-ul">
<li>生成任务</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> celery <span style="color: #a020f0;">import</span> Celery
<span style="color: #a020f0;">import</span> time
<span style="color: #a0522d;">app</span> = Celery(<span style="color: #8b2252;">'mytask'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(app)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(add.name) #mytask.add</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(add)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(app.tasks)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(app.conf)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;redis&#27966;&#21457;&#20219;&#21153;&#65292;&#20219;&#21153;&#23384;&#25918;&#22320;&#22336;</span>
app.conf.<span style="color: #a0522d;">broker_url</span> = <span style="color: #8b2252;">'redis://192.168.61.109:6379/0'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;redis&#20219;&#21153;&#29366;&#24577;&#36820;&#22238;&#20540;&#25968;&#25454;&#24211;</span>
app.conf.<span style="color: #a0522d;">result_backend</span> = <span style="color: #8b2252;">'redis://192.168.61.109:6379/1'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#22797;&#25191;&#34892;&#38382;&#39064;&#35299;&#20915;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#36229;&#36807;visibility_timeout&#65292;Celery&#20250;&#35748;&#20026;&#27492;&#20219;&#21153;&#22833;&#36133;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20250;&#37325;&#20998;&#37197;&#20854;&#20182;worker&#25191;&#34892;&#35813;&#20219;&#21153;&#65292;&#36825;&#26679;&#20250;&#36896;&#25104;&#37325;&#22797;&#25191;&#34892;&#12290;visibility_timeout&#36825;&#20010;&#20540;&#22823;&#19968;&#20123;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#65292;&#22914;&#26524;&#24930;&#20219;&#21153;&#25191;&#34892;&#26102;&#38271;&#36229;&#36807;visibility_timeout&#20381;&#28982;&#20250;&#22810;&#25191;&#34892;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#20219;&#21153;&#36229;&#26102;&#26102;&#38388;12&#23567;&#26102;</span>
app.conf.<span style="color: #a0522d;">broker_transport_options</span> = {<span style="color: #8b2252;">"visibility_timeout"</span>:3600*12} <span style="color: #b22222;">#</span><span style="color: #b22222;">12 hours</span>
app.conf.update(
    enable_utc = <span style="color: #008b8b;">True</span>,
    timezone = <span style="color: #8b2252;">"Asia/Shanghai"</span>
)

<span style="color: #228b22;">@app.task</span>(name=<span style="color: #8b2252;">"my_add"</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add</span>(x,y):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"start run add x={},y={}"</span>.<span style="color: #483d8b;">format</span>(x,y))
    <span style="color: #a0522d;">ret</span> = x+y
    time.sleep(5)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"end run ret = {}"</span>.<span style="color: #483d8b;">format</span>(ret))
    <span style="color: #a020f0;">return</span> ret

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
    add.delay(4,5) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#21457;&#19968;&#20010;&#20219;&#21153;&#21040;broker&#30340;queue</span>
    add.apply_async((10,20),countdown=60) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27966;&#21457;&#19968;&#20010;&#20219;&#21153;&#65292;&#24310;&#36831;60&#31186;&#21518;&#25191;&#34892;</span>
</pre>
</div>

<ul class="org-ul">
<li>注意：上面代码执行，使用add.delay等加入任务到Redis中，在启动celery命令消费Redis的任务，执行并返回结果到Redis中。</li>

<li>添加任务的常用方法

<ol class="org-ol">
<li>T.delay(arg,kwarg=value) #快捷添加任务的方法
<ul class="org-ul">
<li>T：被app.task装饰的函数</li>
<li>args :位置参数</li>
<li>kwargs：关键字参数</li>
</ul></li>
<li>T.apply_async((args,),{'kwarg':value},countdown=?,expires=?)
<ul class="org-ul">
<li>args 位置参数，是个元组</li>
<li>kwargs 关键字参数，是个字典</li>
<li>contdown 延迟多久执行，默认秒</li>
<li>expires 多久后过期，默认秒</li>
</ul></li>
</ol></li>

<li>执行任务：如果在Linux下能出现下面问题，可如下配置</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> celery <span style="color: #a020f0;">import</span> platforms

<span style="color: #b22222;"># </span><span style="color: #b22222;">Linux&#19979;&#65292;&#40664;&#35748;&#19981;&#20801;&#35768;root&#29992;&#25143;&#21551;&#21160;celery&#65292;&#21487;&#20351;&#29992;&#19979;&#38754;&#30340;&#37197;&#32622;</span>
platforms.<span style="color: #a0522d;">C_FORCE_ROOT</span> = <span style="color: #008b8b;">True</span>
</pre>
</div>

<ul class="org-ul">
<li>使用命令执行Redis中的任务(默认在pycharm控制台中使用)</li>
<li><code>$ celery -A test1 worker --loglevel=INFO --concurrency=5 -n worker1@%n</code>
<ol class="org-ol">
<li>-A APP, &#x2013;app App指定app名称，App是模块名</li>
<li>&#x2013;loglevel 指定日志级别</li>
<li>-n 名称，%n指主机名</li>
<li>&#x2013;concurrency 指定并发多进程数，缺省值是CPU数</li>
</ol></li>
<li>windows下可能出现下面问题.</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">[2019-07-25 17:09:29,477: ERROR/MainProcess] Task handler raised error: ValueError('not enough values to unpack (expected 3, got 0)')
Traceback (most recent call last):
  File "d:\mypythonuse\mygitpythonthree\venv\lib\site-packages\billiard\pool.py", line 358, in workloop
    result = (True, prepare_result(fun(*args, **kwargs)))
  File "d:\mypythonuse\mygitpythonthree\venv\lib\site-packages\celery\app\trace.py", line 544, in _fast_trace_task
    tasks, accept, hostname = _loc
ValueError: not enough values to unpack (expected 3, got 0)
[2019-07-25 17:09:30,354: ERROR/MainProcess] Task handler raised error: ValueError('not enough values to unpack (expected 3, got 0)')
Traceback (most recent call last):
  File "d:\mypythonuse\mygitpythonthree\venv\lib\site-packages\billiard\pool.py", line 358, in workloop
    result = (True, prepare_result(fun(*args, **kwargs)))
  File "d:\mypythonuse\mygitpythonthree\venv\lib\site-packages\celery\app\trace.py", line 544, in _fast_trace_task
    tasks, accept, hostname = _loc
ValueError: not enough values to unpack (expected 3, got 0)
</pre>
</div>

<ol class="org-ol">
<li>安装eventlet解决问题</li>
</ol>

<blockquote>
<p>
pip install eventlet
</p>
</blockquote>

<p>
包括win10,建议还是按照eventlet<br>
重新执行任务
</p>

<blockquote>
<p>
celery -A test1 worker -p eventlet &#x2013;loglevel=INFO &#x2013;concurrency=5 -n
worker1@%n
</p>
</blockquote>

<ul class="org-ul">
<li>-P ,&#x2013;pool 指定进程池实现，默认prefork,windows下使用eventlet</li>
<li>运行日志如下</li>
</ul>

<div class="org-src-container">
<pre class="src src-text">(venv) D:\MyPythonUse\MyGitPythonThree&gt;celery -A text worker -P eventlet --loglevel=INFO --concurrency=4 -n worker1%n

 -------------- celery@worker1gdy v4.4.0rc2 (cliffs)
---- **** -----
--- * ***  * -- Windows-10-10.0.17134-SP0 2019-07-25 17:39:37
-- * - **** ---
- ** ---------- [config]
- ** ---------- .&gt; app:         mytask:0x1a93ee6cc18
- ** ---------- .&gt; transport:   redis://192.168.61.109:6379/0
- ** ---------- .&gt; results:     redis://192.168.61.109:6379/1
- *** --- * --- .&gt; concurrency: 4 (eventlet)
-- ******* ---- .&gt; task events: OFF (enable -E to monitor tasks in this worker)
--- ***** -----
 -------------- [queues]
                .&gt; celery           exchange=celery(direct) key=celery


[tasks]
  . my_add

[2019-07-25 17:39:37,834: INFO/MainProcess] Connected to redis://192.168.61.109:6379/0
[2019-07-25 17:39:37,859: INFO/MainProcess] mingle: searching for neighbors
[2019-07-25 17:39:38,909: INFO/MainProcess] mingle: all alone
[2019-07-25 17:39:38,963: INFO/MainProcess] celery@worker1gdy ready.
[2019-07-25 17:39:38,981: INFO/MainProcess] pidbox: Connected to redis://192.168.61.109:6379/0.
[2019-07-25 17:39:39,067: INFO/MainProcess] Received task: my_add[c3e8cfe7-e9d9-49c6-94ff-e6cf5f6a8d83]
[2019-07-25 17:39:39,069: WARNING/MainProcess] start run add x=4,y=5
[2019-07-25 17:39:39,076: INFO/MainProcess] Received task: my_add[ac9bd504-c027-4c9a-9ab2-13c4e5c791f1]  ETA:[2019-07-25 17:39:58.654164+08:00]
[2019-07-25 17:39:44,070: WARNING/MainProcess] end run ret = 9
[2019-07-25 17:39:44,077: INFO/MainProcess] Task my_add[c3e8cfe7-e9d9-49c6-94ff-e6cf5f6a8d83] succeeded in 5.0s: 9
[2019-07-25 17:39:58,663: WARNING/MainProcess] start run add x=10,y=20
[2019-07-25 17:40:03,669: WARNING/MainProcess] end run ret = 30
[2019-07-25 17:40:03,672: INFO/MainProcess] Task my_add[ac9bd504-c027-4c9a-9ab2-13c4e5c791f1] succeeded in 5.0s: 30
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b6590d7a-c511-49fa-8ec3-24b2b705aab4" class="outline-3">
<h3 id="h:b6590d7a-c511-49fa-8ec3-24b2b705aab4">发邮件</h3>
<div class="outline-text-3" id="text-h:b6590d7a-c511-49fa-8ec3-24b2b705aab4">
<ul class="org-ul">
<li>在用户注册完激活时，或修改了用户信息，遇到故障等情况时，都会发送邮件或发送短信息，这些业务场景不需要一直阻塞等待这些发送任务完成，一般都会采用异步执行。也就是说，都会向队列中添加一个任务后，直接返回。<br></li>
<li>发邮件帮助可以参考<a href="https://docs.djangoproject.com/en/2.2/topics/email/">https://docs.djangoproject.com/en/2.2/topics/email/</a></li>
<li>Django中发送邮件需要在settings.py中配置如下</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">SMTP</span>
<span style="color: #a0522d;">EMAIL_BACKEND</span> = <span style="color: #8b2252;">'django.core.mail.backends.smtp.EmailBackend'</span>
<span style="color: #a0522d;">EMAIL_HOST</span> = <span style="color: #8b2252;">"smtp.exmail.qq.com"</span>3
<span style="color: #a0522d;">EMAIL_PORT</span> = 465 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#30465;25&#65292;SSL&#30340;&#24322;&#27493;465</span>
<span style="color: #a0522d;">EMAIL_USE_SSL</span> = <span style="color: #008b8b;">True</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#30465;False</span>
<span style="color: #a0522d;">EMAIL_HOST_USER</span> = <span style="color: #8b2252;">"magetest@magedu.com"</span>
<span style="color: #a0522d;">EMAIL_HOST_PASSWORD</span> = <span style="color: #8b2252;">"Python123"</span>
<span style="color: #a0522d;">EMAIL_USE_TLS</span> = <span style="color: #008b8b;">False</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#30465;&#20540;False</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">## qq&#37038;&#20214;&#37197;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_HOST = "smtp.qq.com"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_PORT = 465 #&#32570;&#30465;25&#65292;SSL&#30340;&#24322;&#27493;465</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_USE_SSL = True #&#32570;&#30465;False</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_USE_TLS = False #&#32570;&#30465;&#20540;False</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_HOST_USER = "1263351411@qq.com"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">EMAIL_HOST_PASSWORD = "*************" #&#38656;&#35201;&#22312;qq&#37038;&#31665;&#35774;&#32622;&#32418;&#24320;&#36890;POP3/SMTP&#26381;&#21153; &#26381;&#21153;</span>
</pre>
</div>

<ul class="org-ul">
<li>注意：不同邮箱服务器配置不太一样。</li>
<li>邮件发送测试代码如下：</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.core.mail <span style="color: #a020f0;">import</span> send_mail
<span style="color: #a020f0;">from</span> blog <span style="color: #a020f0;">import</span> settings

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">email</span>():
    <span style="color: #8b2252;">"""&#21457;&#36865;&#37038;&#20214;"""</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#24320;&#22987;&#21457;&#36865;"</span>)
    send_mail(
        <span style="color: #8b2252;">"active_email"</span>,
        <span style="color: #8b2252;">"Here is the message"</span>,
        settings.EMAIL_HOST_USER, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#30340;&#21457;&#20214;&#31665;</span>
        [<span style="color: #8b2252;">"1263351411@qq.com"</span>],<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#65292;&#25910;&#20214;&#31665;</span>
        fail_silently = <span style="color: #008b8b;">False</span>,
        html_message=<span style="color: #8b2252;">"&#28857;&#20987;&#27492;&#38142;&#25509;&#28608;&#27963;&#37038;&#20214;&lt;a href='{0}'&gt;{0}&lt;/a&gt;"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #8b2252;">"www.baidu.com"</span>)
    )
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#21457;&#36865;&#23436;&#25104;"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#20989;&#25968;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">text</span>(request):
    <span style="color: #a020f0;">try</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"aa-------  --------"</span>)
        email()
        <span style="color: #a020f0;">return</span> HttpResponse(<span style="color: #8b2252;">"&#21457;&#36865;&#25104;&#21151;"</span>,status=201)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        logging.info(e)
        <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:<span style="color: #8b2252;">"&#37038;&#20214;&#21457;&#36865;&#22833;&#36133;"</span>},status=400)
</pre>
</div>
</div>
<div id="outline-container-h:7ccc6bec-6312-45db-82db-6508f564e0be" class="outline-4">
<h4 id="h:7ccc6bec-6312-45db-82db-6508f564e0be">Celery在Django中的集成方法</h4>
<div class="outline-text-4" id="text-h:7ccc6bec-6312-45db-82db-6508f564e0be">
<ul class="org-ul">
<li>新版本Celery集成到Django方式改变了。</li>
<li>目录结构</li>
</ul>

<div class="org-src-container">
<pre class="src src-txt">- proj/
  - manage.py
  - proj/ #Django全局目录
    - __init__.py
    - settings.py
    - celery.py
    - urls.py
  - app1 #应用程序目录
    - __init__.py
    - tasks.py
    - view.py
    - models.py
</pre>
</div>

<ul class="org-ul">
<li>在Django全局目录中(settings.pys所在目录)
<ol class="org-ol">
<li><p>
定义一个celery.py文件
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">author:xdd</span>
<span style="color: #8b2252;">date:2019-07-25 20:21</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">from</span> __future__ <span style="color: #a020f0;">import</span> absolute_import, unicode_literals
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">from</span> celery <span style="color: #a020f0;">import</span> Celery

os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'blog.settings'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#20462;&#25913;&#27169;&#22359;&#21517;</span>
<span style="color: #a0522d;">app</span> = Celery(<span style="color: #8b2252;">"xdd"</span>)
app.config_from_object(<span style="color: #8b2252;">'django.conf:settings'</span>, namespace=<span style="color: #8b2252;">'CELERY'</span>)
app.autodiscover_tasks()
app.conf.update(
    enable_utc=<span style="color: #008b8b;">True</span>,
    timezone=<span style="color: #8b2252;">"Asia/Shanghai"</span>
)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;redis&#27966;&#21457;&#20219;&#21153;&#65292;&#20219;&#21153;&#23384;&#25918;&#22320;&#22336;</span>
app.conf.<span style="color: #a0522d;">broker_url</span> = <span style="color: #8b2252;">'redis://192.168.61.109:6379/0'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;redis&#20219;&#21153;&#29366;&#24577;&#36820;&#22238;&#20540;&#25968;&#25454;&#24211;</span>
app.conf.<span style="color: #a0522d;">result_backend</span> = <span style="color: #8b2252;">'redis://192.168.61.109:6379/1'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#36229;&#36807;visibility_timeout&#65292;Celery&#20250;&#35748;&#20026;&#27492;&#20219;&#21153;&#22833;&#36133;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20250;&#37325;&#20998;&#37197;&#20854;&#20182;worker&#25191;&#34892;&#35813;&#20219;&#21153;&#65292;&#36825;&#26679;&#20250;&#36896;&#25104;&#37325;&#22797;&#25191;&#34892;&#12290;visibility_timeout&#36825;&#20010;&#20540;&#22823;&#19968;&#20123;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#65292;&#22914;&#26524;&#24930;&#20219;&#21153;&#25191;&#34892;&#26102;&#38271;&#36229;&#36807;visibility_timeout&#20381;&#28982;&#20250;&#22810;&#25191;&#34892;</span>
app.conf.<span style="color: #a0522d;">broker_transport_options</span> = {<span style="color: #8b2252;">"visibility_timeout"</span>: 3600 * 12}  <span style="color: #b22222;"># </span><span style="color: #b22222;">12 hours</span>
</pre>
</div></li>

<li><p>
修改=__init__.py=文件
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> __future__ <span style="color: #a020f0;">import</span> absolute_import, unicode_literals
<span style="color: #a020f0;">from</span> .celery <span style="color: #a020f0;">import</span> app <span style="color: #a020f0;">as</span> celery_app

<span style="color: #483d8b;">__all__</span> = (<span style="color: #8b2252;">'celery_app'</span>,)
</pre>
</div></li>
</ol></li>

<li><p>
在user应用下
</p>
<ol class="org-ol">
<li><p>
新建文件=tasks.py=中新建任务
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">author:xdd</span>
<span style="color: #8b2252;">date:2019-07-25 20:32</span>
<span style="color: #8b2252;">"""</span>

<span style="color: #a020f0;">from</span> __future__ <span style="color: #a020f0;">import</span> absolute_import, unicode_literals
<span style="color: #a020f0;">from</span> blog.celery <span style="color: #a020f0;">import</span> app
<span style="color: #a020f0;">from</span> django.core.mail <span style="color: #a020f0;">import</span> send_mail
<span style="color: #a020f0;">from</span> blog <span style="color: #a020f0;">import</span> settings
<span style="color: #a020f0;">import</span> datetime

<span style="color: #228b22;">@app.task</span>(name=<span style="color: #8b2252;">"server_email"</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">email</span>(active_url,email=[]):
    <span style="color: #8b2252;">"""&#21457;&#36865;&#37038;&#20214;"""</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#24320;&#22987;&#21457;&#36865;"</span>)
    send_mail(
        <span style="color: #8b2252;">"&#28608;&#27963;&#37038;&#20214;"</span>,
        <span style="color: #8b2252;">"Here is the message"</span>,
        settings.EMAIL_HOST_USER, <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#30340;&#21457;&#20214;&#31665;</span>
        email,<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#65292;&#25910;&#20214;&#31665;</span>
        fail_silently = <span style="color: #008b8b;">False</span>,
        html_message=<span style="color: #8b2252;">"&#28857;&#20987;&#27492;&#38142;&#25509;&#28608;&#27963;&#37038;&#20214;&lt;a href='{0}'&gt;{0}&lt;/a&gt; &#26102;&#38388;&#65306;{1:%Y-%m-%d %H:%M:%S}"</span>.<span style="color: #483d8b;">format</span>(active_url,datetime.datetime.now())
    )
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#21457;&#36865;&#23436;&#25104;"</span>)
</pre>
</div></li>

<li><p>
views.py视图函数中调用
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> .tasks <span style="color: #a020f0;">import</span> email
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#20989;&#25968;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">text</span>(request):
    <span style="color: #a020f0;">try</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"aa-------  --------"</span>)
        email.delay(<span style="color: #8b2252;">"www.baidu.com"</span>,[<span style="color: #8b2252;">"1263351411@qq.com"</span>])
        <span style="color: #a020f0;">return</span> HttpResponse(<span style="color: #8b2252;">"&#21457;&#36865;&#25104;&#21151;"</span>,status=201)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        logging.info(e)
        <span style="color: #a020f0;">return</span> JsonResponse({<span style="color: #8b2252;">"error"</span>:<span style="color: #8b2252;">"&#37038;&#20214;&#21457;&#36865;&#22833;&#36133;"</span>},status=400)
</pre>
</div></li>

<li>以后放在注册函数中发送邮件。</li>

<li>注意：目前在Python3.7部署时，发邮件可能会报wrap_socket()错。可以使用python3.6版本</li>

<li><p>
urls.py路由视图函数
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">author:xdd</span>
<span style="color: #8b2252;">date:2019-07-17 22:09</span>
<span style="color: #8b2252;">"""</span>

<span style="color: #a020f0;">from</span> django.conf.urls <span style="color: #a020f0;">import</span> url
<span style="color: #a020f0;">from</span> .views <span style="color: #a020f0;">import</span> reg,login,text,logout
<span style="color: #a020f0;">from</span> django.http <span style="color: #a020f0;">import</span> HttpResponse
<span style="color: #a020f0;">from</span> user.models <span style="color: #a020f0;">import</span> User

<span style="color: #a0522d;">urlpatterns</span> = [
    url(r<span style="color: #8b2252;">'^$'</span>,reg), <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#27880;&#20876;</span>
    url(r<span style="color: #8b2252;">'^login$'</span>,login),  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#30331;&#24405;</span>
    url(r<span style="color: #8b2252;">'^logout$'</span>,logout), <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#30331;&#20986;</span>
    url(r<span style="color: #8b2252;">'^text$'</span>,text),
]
</pre>
</div></li>

<li>访问=<a href="http://127.0.0.1:8000/users/text=%E4%BC%9A%E8%B0%83%E7%94%A8text%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%EF%BC%8C%E6%89%A7%E8%A1%8Cemail.delay()%EF%BC%8C%E4%BC%9A%E5%9C%A8redis%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%BB%BB%E5%8A%A1">http://127.0.0.1:8000/users/text=%E4%BC%9A%E8%B0%83%E7%94%A8text%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%EF%BC%8C%E6%89%A7%E8%A1%8Cemail.delay()%EF%BC%8C%E4%BC%9A%E5%9C%A8redis%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%BB%BB%E5%8A%A1</a>。</li>

<li>执行任务，下面命令会从redis中拿任务执行</li>
</ol>

<blockquote>
<p>
celery -A blog -P eventlet worker &#x2013;loglevel=INFO &#x2013;concurrency=4 -n
worker@%n
</p>
</blockquote></li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:0299e760-6eec-4054-bbba-663ccabbf47d" class="outline-2">
<h2 id="h:0299e760-6eec-4054-bbba-663ccabbf47d">Flask框架简单使用</h2>
<div class="outline-text-2" id="text-h:0299e760-6eec-4054-bbba-663ccabbf47d">
<p>
[toc]
</p>

<ul class="org-ul">
<li>安装：=pip install flask=</li>
<li>Flask快速入门：<a href="http://docs.jinkan.org/docs/flask/quickstart.html#quickstart">http://docs.jinkan.org/docs/flask/quickstart.html#quickstart</a></li>
</ul>
</div>
<div id="outline-container-h:8f951cdd-a700-4325-bd3e-b18e86dca438" class="outline-3">
<h3 id="h:8f951cdd-a700-4325-bd3e-b18e86dca438">快速构建</h3>
<div class="outline-text-3" id="text-h:8f951cdd-a700-4325-bd3e-b18e86dca438">
<ol class="org-ol">
<li>在项目根目录下构建：
<ul class="org-ul">
<li>webapp包目录，存放flask代码，包内有=__init__.py=文件</li>
<li>templates目录，存放模板文件</li>
<li>static目录，存放js,css等静态文件。其下建立js目录，放入jquery、echarts的js文件</li>
<li>app.py入口文件</li>
</ul></li>

<li>基本组成
<ol class="org-ol">
<li>目录结构如下：</li>
</ol></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">/webapp/__init__.py&#25991;&#20214;&#20869;&#23481;</span>
<span style="color: #a020f0;">from</span> flask <span style="color: #a020f0;">import</span> Flask,jsonify

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24212;&#29992;</span>
<span style="color: #a0522d;">app</span> = Flask(<span style="color: #8b2252;">"myweb"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#21644;&#35270;&#22270;&#20989;&#25968;</span>
<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">"/"</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>():
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"hello flask"</span>

<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">"/json"</span>,methods=[<span style="color: #8b2252;">"GET"</span>]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#34920;&#20013;&#25351;&#23450;&#22810;&#20010;&#26041;&#27861;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getjson</span>():
    <span style="color: #a0522d;">d</span> = {<span style="color: #8b2252;">"a"</span>:1,<span style="color: #8b2252;">"b"</span>:2,<span style="color: #8b2252;">"c"</span>:3}
    <span style="color: #a020f0;">return</span> jsonify(d) <span style="color: #b22222;">#</span><span style="color: #b22222;">Mime&#26159;application/json</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#21360;&#37325;&#35201;&#23646;&#24615;</span>
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">filter</span>(<span style="color: #a020f0;">lambda</span> x: <span style="color: #a020f0;">not</span> x[0].startswith(<span style="color: #8b2252;">"__"</span>) <span style="color: #a020f0;">and</span> x[1],app.<span style="color: #483d8b;">__dict__</span>.items()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(app.url_map)
<span style="color: #483d8b;">print</span>(app.template_folder)
<span style="color: #483d8b;">print</span>(app.static_folder)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
</pre>
</div>

<ol class="org-ol">
<li>应用：创建出来提供WEB服务的实例，也是wsgi的入口</li>
<li>视图函数：执行内部代码输出响应的内容</li>
<li>路由：通过route装饰器创建path到视图函数的映射关系</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">/main.py&#25991;&#20214;</span>
<span style="color: #a020f0;">from</span> webapp <span style="color: #a020f0;">import</span> app

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
    app.run(<span style="color: #8b2252;">"127.0.0.1"</span>,port=8080,debug=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<ul class="org-ul">
<li>启动main.py文件</li>
</ul>
</div>
</div>
<div id="outline-container-h:0fc0ab65-1a91-4273-a1b9-6ddbed3020b6" class="outline-3">
<h3 id="h:0fc0ab65-1a91-4273-a1b9-6ddbed3020b6">蓝图</h3>
<div class="outline-text-3" id="text-h:0fc0ab65-1a91-4273-a1b9-6ddbed3020b6">
<p>
Flask中，基本上都是route装饰器和视图函数的映射，如果函数很多，代码组织结构会非常乱。<br>
蓝图Blueprint,就是Flask中*模块化*技术
</p>

<ul class="org-ul">
<li>新建=/web/app/books.py=蓝图文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">/webapp/books.py&#25991;&#20214;</span>

<span style="color: #a020f0;">from</span> flask <span style="color: #a020f0;">import</span> Blueprint,jsonify,render_template

<span style="color: #a0522d;">bpbooks</span> = Blueprint(<span style="color: #8b2252;">"booksapp"</span>,<span style="color: #483d8b;">__name__</span>,url_prefix=<span style="color: #8b2252;">"/books"</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">bpbooks = Blueprint("booksapp",__name__)</span>

<span style="color: #228b22;">@bpbooks.route</span>(<span style="color: #8b2252;">"/"</span>,methods=[<span style="color: #8b2252;">"GET"</span>,<span style="color: #8b2252;">"POST"</span>])
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getall</span>():
    <span style="color: #a0522d;">books</span> = [
        (1,<span style="color: #8b2252;">"java"</span>,20),
        (2,<span style="color: #8b2252;">"python"</span>,40),
        (3,<span style="color: #8b2252;">"linux"</span>,50)
    ]
    <span style="color: #a020f0;">return</span> jsonify(books)

<span style="color: #b22222;"># </span><span style="color: #b22222;">print("= "*30)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">for x in bpbooks.__dict__.items():</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">print(x)</span>
</pre>
</div>

<ul class="org-ul">
<li>修改=/webapp/__init__.py=文件如下：在app中注册新建的蓝图文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">/webapp/__init__.py</span>
<span style="color: #a020f0;">from</span> flask <span style="color: #a020f0;">import</span> Flask,jsonify
<span style="color: #a020f0;">from</span> .books <span style="color: #a020f0;">import</span> bpbooks

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24212;&#29992;</span>
<span style="color: #a0522d;">app</span> = Flask(<span style="color: #8b2252;">"myweb"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#21644;&#35270;&#22270;&#20989;&#25968;</span>
<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">"/"</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>():
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"hello flask"</span>

<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">"/json"</span>,methods=[<span style="color: #8b2252;">"GET"</span>]) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#34920;&#20013;&#25351;&#23450;&#22810;&#20010;&#26041;&#27861;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getjson</span>():
    <span style="color: #a0522d;">d</span> = {<span style="color: #8b2252;">"a"</span>:1,<span style="color: #8b2252;">"b"</span>:2,<span style="color: #8b2252;">"c"</span>:3}
    <span style="color: #a020f0;">return</span> jsonify(d) <span style="color: #b22222;">#</span><span style="color: #b22222;">Mime&#26159;application/json</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#20876;&#34013;&#22270;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">app.register_blueprint(bpbooks)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#22312;app&#20013;&#27880;&#20876;&#34013;&#22270;&#26102;&#65292;&#32473;&#23450;&#20102;url_prefix&#65292;&#37027;&#20040;&#34013;&#22270;&#20869;&#33258;&#23450;&#20041;&#30340;url_prefix&#23558;&#22833;&#25928;</span>
app.register_blueprint(bpbooks,url_prefix=<span style="color: #8b2252;">"/bookss"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#21360;&#37325;&#35201;&#23646;&#24615;</span>
<span style="color: #483d8b;">print</span>(*<span style="color: #483d8b;">filter</span>(<span style="color: #a020f0;">lambda</span> x: <span style="color: #a020f0;">not</span> x[0].startswith(<span style="color: #8b2252;">"__"</span>) <span style="color: #a020f0;">and</span> x[1],app.<span style="color: #483d8b;">__dict__</span>.items()),sep=<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
<span style="color: #483d8b;">print</span>(app.url_map)
<span style="color: #483d8b;">print</span>(app.template_folder)
<span style="color: #483d8b;">print</span>(app.static_folder)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"- "</span>*30)
</pre>
</div>

<ul class="org-ul">
<li>注册完成后，启动=/main.py=文件</li>

<li>Blueprint构造参数
<ul class="org-ul">
<li>name,蓝图名称，注册在app的蓝图字典中用的key</li>
<li>import_name,用来计算蓝图模块所在路径，一般写=__name__=</li>
<li>root_path,指定蓝图模块所在路径，如果None，使用import_name计算得到</li>
<li>template_folder</li>
<li>url_prefix,指定本蓝图模块的路径前缀，app.register_blueprint注册蓝图时，也可以对当前蓝图指定url_prefix,将覆盖蓝图中的定义。</li>
</ul></li>

<li>特别注意，输出的root_path路径，说明蓝图有自己一套路径。</li>
<li>最后app.register_blueprint(bpbooks,url_prefix="/bookss"),url_prefix一定要以=/=开始，否则报错，最后路径以注册的url_prefix为准</li>
</ul>
</div>
</div>
<div id="outline-container-h:1fa97270-4557-4b69-8536-d714e5604af0" class="outline-3">
<h3 id="h:1fa97270-4557-4b69-8536-d714e5604af0">模板</h3>
<div class="outline-text-3" id="text-h:1fa97270-4557-4b69-8536-d714e5604af0">
<p>
Flask使用jinja2模板。<br>
对于应用app来说其模板是，根目录下的templates,其下新建index.html
</p>

<ul class="org-ul">
<li><code>/templates/index.html文件内容如下</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">xdd web</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">&#27426;&#36814;&#20351;&#29992;flask&#26694;&#26550;</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
&lt;<span style="color: #0000ff;">hr</span>&gt;
{% for x in userlist  %}
{{x}}
{% endfor %}
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<ul class="org-ul">
<li>修改=/webapp/__init__.py=文件中的index视图函数，使用模板渲染函数。</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> flask <span style="color: #a020f0;">import</span> Flask,jsonify,render_template

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24212;&#29992;</span>
<span style="color: #a0522d;">app</span> = Flask(<span style="color: #8b2252;">"myweb"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#21644;&#35270;&#22270;&#20989;&#25968;</span>
<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">"/index.html"</span>)
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>():
    <span style="color: #a020f0;">return</span> render_template(<span style="color: #8b2252;">"index.html"</span>, userlist=[
        (1, <span style="color: #8b2252;">"tom"</span>, 20),
        (1, <span style="color: #8b2252;">"json"</span>, 30),
    ])
</pre>
</div>

<ul class="org-ul">
<li>jinja2和Django模板语法一致，这里不阐述</li>

<li><p>
在app.jinja_loader属性中，有下面的语句
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #228b22;">@locked_cached_property</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">jinja_loader</span>(<span style="color: #a020f0;">self</span>):
    <span style="color: #8b2252;">"""The Jinja loader for this package bound object.</span>

<span style="color: #8b2252;">    .. versionadded:: 0.5</span>
<span style="color: #8b2252;">    """</span>
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">self</span>.template_folder <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #a020f0;">return</span> FileSystemLoader(os.path.join(<span style="color: #a020f0;">self</span>.root_path, <span style="color: #a020f0;">self</span>.template_folder))
</pre>
</div>

<ol class="org-ol">
<li>说明：不管是app，还是bluepoint，都是使用自己的root_path和模板路径拼接成模板路径。</li>
<li>可以通过app或者bluepoint查看=app.jinja_loader.searchpath=模板搜索路径。</li>
</ol></li>
</ul>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
